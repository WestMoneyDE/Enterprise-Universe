<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HubSpot Sync | GTz Ecosystem</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;500;600;700&family=Space+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #ff7a59;
            --primary-dark: #ff5c35;
            --secondary: #00f0ff;
            --accent: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-dark: #0a0a0f;
            --bg-card: #12121a;
            --bg-card-hover: #1a1a25;
            --text: #ffffff;
            --text-muted: #888;
            --border: #2a2a3a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated Background */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(255, 122, 89, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(0, 240, 255, 0.08) 0%, transparent 50%),
                var(--bg-dark);
        }

        /* Header */
        .header {
            background: rgba(18, 18, 26, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .logo-text {
            font-family: 'Orbitron', sans-serif;
        }

        .logo-text h1 {
            font-size: 1.3rem;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo-text span {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .nav-links {
            display: flex;
            gap: 1rem;
        }

        .nav-links a {
            color: var(--text-muted);
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .nav-links a:hover {
            color: var(--text);
            background: var(--bg-card);
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Connection Card */
        .connection-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .connection-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .connection-header .icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
        }

        .connection-header h2 {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--danger);
        }

        .status-dot.connected {
            background: var(--success);
            box-shadow: 0 0 10px var(--success);
        }

        /* API Token Input */
        .token-input-group {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        .input-wrapper input {
            width: 100%;
            padding: 1rem 1.5rem;
            padding-right: 3rem;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text);
            font-family: 'Space Mono', monospace;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .input-wrapper input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(255, 122, 89, 0.2);
        }

        .input-wrapper input::placeholder {
            color: var(--text-muted);
        }

        .toggle-visibility {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.2rem;
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(255, 122, 89, 0.3);
        }

        .btn-secondary {
            background: var(--bg-card-hover);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--secondary);
            color: var(--secondary);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Instructions */
        .instructions {
            background: rgba(0, 240, 255, 0.05);
            border: 1px solid rgba(0, 240, 255, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .instructions h4 {
            color: var(--secondary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .instructions ol {
            margin-left: 1.5rem;
            color: var(--text-muted);
        }

        .instructions li {
            margin-bottom: 0.5rem;
        }

        .instructions code {
            background: var(--bg-dark);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-family: 'Space Mono', monospace;
            font-size: 0.85rem;
            color: var(--primary);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
        }

        .stat-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        /* Data Tables */
        .data-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .data-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .data-header h3 {
            font-family: 'Orbitron', sans-serif;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .data-actions {
            display: flex;
            gap: 0.75rem;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 1rem 1.5rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .data-table th {
            background: var(--bg-dark);
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
        }

        .data-table tr:hover td {
            background: var(--bg-card-hover);
        }

        .data-table .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .contact-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .contact-name {
            font-weight: 600;
        }

        .contact-email {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .badge-primary {
            background: rgba(255, 122, 89, 0.2);
            color: var(--primary);
        }

        /* Progress Bar */
        .sync-progress {
            display: none;
            margin-top: 1.5rem;
        }

        .sync-progress.active {
            display: block;
        }

        .progress-bar {
            height: 8px;
            background: var(--bg-dark);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s;
        }

        .progress-text {
            color: var(--text-muted);
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
        }

        /* Loading Spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            padding: 4rem 2rem;
            text-align: center;
            color: var(--text-muted);
        }

        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h4 {
            color: var(--text);
            margin-bottom: 0.5rem;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .toast {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }

        .toast.success {
            border-color: var(--success);
        }

        .toast.error {
            border-color: var(--danger);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Consent Actions */
        .consent-actions {
            display: flex;
            gap: 0.5rem;
        }

        .consent-btn {
            padding: 0.25rem 0.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .consent-btn.grant {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .consent-btn.revoke {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .consent-btn:hover {
            transform: scale(1.05);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
            }

            .token-input-group {
                flex-direction: column;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .data-table {
                font-size: 0.85rem;
            }

            .data-table th,
            .data-table td {
                padding: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="bg-animation"></div>

    <!-- Header -->
    <header class="header">
        <div class="logo">
            <div class="logo-icon">ğŸ”—</div>
            <div class="logo-text">
                <h1>HubSpot Sync</h1>
                <span>GTz Ecosystem â€¢ West Money OS</span>
            </div>
        </div>
        <nav class="nav-links">
            <a href="index.html">Dashboard</a>
            <a href="consent-manager.html">Consent Manager</a>
            <a href="settings.html">Einstellungen</a>
        </nav>
    </header>

    <main class="container">
        <!-- Connection Card -->
        <div class="connection-card">
            <div class="connection-header">
                <div class="icon">ğŸ”¶</div>
                <div>
                    <h2>HubSpot API Verbindung</h2>
                    <div class="connection-status">
                        <span class="status-dot" id="statusDot"></span>
                        <span id="statusText">Nicht verbunden</span>
                    </div>
                </div>
            </div>

            <div class="token-input-group">
                <div class="input-wrapper">
                    <input type="password" id="apiToken" placeholder="pat-eu1-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" autocomplete="off">
                    <button class="toggle-visibility" onclick="toggleTokenVisibility()">ğŸ‘ï¸</button>
                </div>
                <button class="btn btn-primary" id="connectBtn" onclick="connectToHubSpot()">
                    <span>ğŸ”Œ</span> Verbinden
                </button>
            </div>

            <div class="sync-progress" id="syncProgress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text">
                    <span id="progressLabel">Synchronisiere...</span>
                    <span id="progressPercent">0%</span>
                </div>
            </div>

            <div class="instructions">
                <h4>ğŸ“‹ So erstellst du einen API Token:</h4>
                <ol>
                    <li>Gehe zu <a href="https://app.hubspot.com" target="_blank" style="color: var(--primary);">app.hubspot.com</a> â†’ âš™ï¸ Einstellungen</li>
                    <li>Links: <strong>Integrationen</strong> â†’ <strong>Private Apps</strong></li>
                    <li>Klicke <strong>"Private App erstellen"</strong></li>
                    <li>Name: <code>West Money OS</code></li>
                    <li>Berechtigungen aktivieren:
                        <code>crm.objects.contacts.read</code>,
                        <code>crm.objects.contacts.write</code>,
                        <code>crm.objects.deals.read</code>,
                        <code>crm.objects.deals.write</code>
                    </li>
                    <li>Kopiere den <strong>Access Token</strong> (beginnt mit <code>pat-</code>)</li>
                </ol>
            </div>
        </div>

        <!-- Stats Grid (hidden until connected) -->
        <div class="stats-grid" id="statsGrid" style="display: none;">
            <div class="stat-card">
                <div class="stat-icon">ğŸ‘¥</div>
                <div class="stat-value" id="statContacts">0</div>
                <div class="stat-label">Kontakte</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ’°</div>
                <div class="stat-value" id="statDeals">0</div>
                <div class="stat-label">Deals</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ¢</div>
                <div class="stat-value" id="statCompanies">0</div>
                <div class="stat-label">Unternehmen</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ’µ</div>
                <div class="stat-value" id="statRevenue">â‚¬0</div>
                <div class="stat-label">Pipeline</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">âœ…</div>
                <div class="stat-value" id="statConsent">0</div>
                <div class="stat-label">WhatsApp Consent</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">â±ï¸</div>
                <div class="stat-value" id="statLastSync">-</div>
                <div class="stat-label">Letzter Sync</div>
            </div>
        </div>

        <!-- Contacts Table -->
        <div class="data-section" id="contactsSection" style="display: none;">
            <div class="data-header">
                <h3>ğŸ“‡ Kontakte</h3>
                <div class="data-actions">
                    <button class="btn btn-secondary btn-small" onclick="exportContacts()">
                        ğŸ“¥ CSV Export
                    </button>
                    <button class="btn btn-primary btn-small" onclick="syncContacts()">
                        ğŸ”„ Aktualisieren
                    </button>
                </div>
            </div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Kontakt</th>
                        <th>Firma</th>
                        <th>Telefon</th>
                        <th>Status</th>
                        <th>WhatsApp Consent</th>
                        <th>Aktionen</th>
                    </tr>
                </thead>
                <tbody id="contactsTableBody">
                </tbody>
            </table>
        </div>

        <!-- Deals Table -->
        <div class="data-section" id="dealsSection" style="display: none;">
            <div class="data-header">
                <h3>ğŸ’¼ Deals / Pipeline</h3>
                <div class="data-actions">
                    <button class="btn btn-secondary btn-small" onclick="exportDeals()">
                        ğŸ“¥ CSV Export
                    </button>
                    <button class="btn btn-primary btn-small" onclick="syncDeals()">
                        ğŸ”„ Aktualisieren
                    </button>
                </div>
            </div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Deal Name</th>
                        <th>Betrag</th>
                        <th>Stage</th>
                        <th>Pipeline</th>
                        <th>Abschlussdatum</th>
                    </tr>
                </thead>
                <tbody id="dealsTableBody">
                </tbody>
            </table>
        </div>

        <!-- Empty State (shown when not connected) -->
        <div class="empty-state" id="emptyState">
            <div class="icon">ğŸ”—</div>
            <h4>Keine Verbindung</h4>
            <p>Gib deinen HubSpot API Token ein, um deine CRM-Daten zu synchronisieren.</p>
        </div>
    </main>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // GTz ECOSYSTEM - HUBSPOT INTEGRATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        const HUBSPOT_BASE_URL = 'https://api.hubapi.com';
        let accessToken = null;
        let syncedData = {
            contacts: [],
            deals: [],
            companies: [],
            stats: {}
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // UI HELPERS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function toggleTokenVisibility() {
            const input = document.getElementById('apiToken');
            const btn = document.querySelector('.toggle-visibility');
            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = 'ğŸ™ˆ';
            } else {
                input.type = 'password';
                btn.textContent = 'ğŸ‘ï¸';
            }
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span>${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸'}</span>
                <span>${message}</span>
            `;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }

        function updateProgress(percent, label) {
            document.getElementById('progressFill').style.width = `${percent}%`;
            document.getElementById('progressPercent').textContent = `${percent}%`;
            if (label) document.getElementById('progressLabel').textContent = label;
        }

        function setConnectionStatus(connected) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            const btn = document.getElementById('connectBtn');

            if (connected) {
                dot.classList.add('connected');
                text.textContent = 'Verbunden';
                btn.innerHTML = '<span>âœ…</span> Verbunden';
                btn.disabled = true;
                document.getElementById('emptyState').style.display = 'none';
                document.getElementById('statsGrid').style.display = 'grid';
                document.getElementById('contactsSection').style.display = 'block';
                document.getElementById('dealsSection').style.display = 'block';
            } else {
                dot.classList.remove('connected');
                text.textContent = 'Nicht verbunden';
                btn.innerHTML = '<span>ğŸ”Œ</span> Verbinden';
                btn.disabled = false;
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // HUBSPOT API CALLS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        async function hubspotRequest(endpoint, options = {}) {
            const url = `${HUBSPOT_BASE_URL}${endpoint}`;
            const config = {
                method: options.method || 'GET',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                }
            };

            if (options.body) {
                config.body = JSON.stringify(options.body);
            }

            const response = await fetch(url, config);

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || `API Error: ${response.status}`);
            }

            return response.json();
        }

        async function connectToHubSpot() {
            const token = document.getElementById('apiToken').value.trim();

            if (!token) {
                showToast('Bitte gib einen API Token ein', 'error');
                return;
            }

            if (!token.startsWith('pat-')) {
                showToast('UngÃ¼ltiges Token-Format. Token muss mit "pat-" beginnen.', 'error');
                return;
            }

            accessToken = token;
            const btn = document.getElementById('connectBtn');
            btn.innerHTML = '<span class="spinner"></span> Verbinde...';
            btn.disabled = true;

            try {
                // Test connection
                await hubspotRequest('/crm/v3/objects/contacts?limit=1');
                showToast('Verbindung erfolgreich!', 'success');
                setConnectionStatus(true);

                // Save token locally (encrypted in production)
                localStorage.setItem('hubspot_token', token);

                // Start full sync
                await fullSync();

            } catch (error) {
                console.error('Connection error:', error);
                showToast(`Verbindungsfehler: ${error.message}`, 'error');
                setConnectionStatus(false);
                accessToken = null;
            }
        }

        async function fullSync() {
            const progress = document.getElementById('syncProgress');
            progress.classList.add('active');

            try {
                // Sync contacts
                updateProgress(10, 'Lade Kontakte...');
                syncedData.contacts = await fetchAllContacts();

                // Sync deals
                updateProgress(40, 'Lade Deals...');
                syncedData.deals = await fetchAllDeals();

                // Sync companies
                updateProgress(70, 'Lade Unternehmen...');
                syncedData.companies = await fetchAllCompanies();

                // Calculate stats
                updateProgress(90, 'Berechne Statistiken...');
                calculateStats();

                // Update UI
                updateProgress(100, 'Fertig!');
                updateStatsDisplay();
                renderContactsTable();
                renderDealsTable();

                showToast(`Sync abgeschlossen: ${syncedData.contacts.length} Kontakte, ${syncedData.deals.length} Deals`, 'success');

                setTimeout(() => {
                    progress.classList.remove('active');
                }, 1000);

            } catch (error) {
                console.error('Sync error:', error);
                showToast(`Sync-Fehler: ${error.message}`, 'error');
                progress.classList.remove('active');
            }
        }

        async function fetchAllContacts() {
            const properties = [
                'firstname', 'lastname', 'email', 'phone', 'company',
                'lifecyclestage', 'hs_lead_status', 'createdate',
                'whatsapp_consent', 'marketing_consent'
            ];

            const contacts = [];
            let after = null;

            do {
                const params = new URLSearchParams({
                    limit: '100',
                    properties: properties.join(',')
                });
                if (after) params.append('after', after);

                const response = await hubspotRequest(`/crm/v3/objects/contacts?${params}`);
                contacts.push(...response.results);
                after = response.paging?.next?.after;
            } while (after);

            return contacts;
        }

        async function fetchAllDeals() {
            const properties = [
                'dealname', 'amount', 'dealstage', 'pipeline',
                'closedate', 'createdate'
            ];

            const deals = [];
            let after = null;

            do {
                const params = new URLSearchParams({
                    limit: '100',
                    properties: properties.join(',')
                });
                if (after) params.append('after', after);

                const response = await hubspotRequest(`/crm/v3/objects/deals?${params}`);
                deals.push(...response.results);
                after = response.paging?.next?.after;
            } while (after);

            return deals;
        }

        async function fetchAllCompanies() {
            const companies = [];
            let after = null;

            do {
                const params = new URLSearchParams({ limit: '100' });
                if (after) params.append('after', after);

                const response = await hubspotRequest(`/crm/v3/objects/companies?${params}`);
                companies.push(...response.results);
                after = response.paging?.next?.after;
            } while (after);

            return companies;
        }

        function calculateStats() {
            syncedData.stats = {
                totalContacts: syncedData.contacts.length,
                totalDeals: syncedData.deals.length,
                totalCompanies: syncedData.companies.length,
                totalRevenue: syncedData.deals.reduce((sum, deal) => {
                    return sum + (parseFloat(deal.properties.amount) || 0);
                }, 0),
                whatsappConsent: syncedData.contacts.filter(c => 
                    c.properties.whatsapp_consent === 'granted' || 
                    c.properties.whatsapp_consent === 'true'
                ).length,
                lastSync: new Date().toLocaleTimeString('de-DE')
            };
        }

        function updateStatsDisplay() {
            document.getElementById('statContacts').textContent = syncedData.stats.totalContacts.toLocaleString('de-DE');
            document.getElementById('statDeals').textContent = syncedData.stats.totalDeals.toLocaleString('de-DE');
            document.getElementById('statCompanies').textContent = syncedData.stats.totalCompanies.toLocaleString('de-DE');
            document.getElementById('statRevenue').textContent = 'â‚¬' + syncedData.stats.totalRevenue.toLocaleString('de-DE');
            document.getElementById('statConsent').textContent = syncedData.stats.whatsappConsent.toLocaleString('de-DE');
            document.getElementById('statLastSync').textContent = syncedData.stats.lastSync;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // TABLE RENDERING
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function renderContactsTable() {
            const tbody = document.getElementById('contactsTableBody');
            tbody.innerHTML = '';

            syncedData.contacts.slice(0, 50).forEach(contact => {
                const props = contact.properties;
                const initials = ((props.firstname?.[0] || '') + (props.lastname?.[0] || '')).toUpperCase() || '?';
                const consentStatus = props.whatsapp_consent === 'granted' || props.whatsapp_consent === 'true' 
                    ? 'granted' 
                    : props.whatsapp_consent === 'revoked' 
                        ? 'revoked' 
                        : 'pending';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="contact-info">
                            <div class="avatar">${initials}</div>
                            <div>
                                <div class="contact-name">${props.firstname || ''} ${props.lastname || ''}</div>
                                <div class="contact-email">${props.email || '-'}</div>
                            </div>
                        </div>
                    </td>
                    <td>${props.company || '-'}</td>
                    <td>${props.phone || '-'}</td>
                    <td><span class="badge badge-primary">${props.lifecyclestage || 'lead'}</span></td>
                    <td><span class="badge badge-${consentStatus === 'granted' ? 'success' : consentStatus === 'revoked' ? 'danger' : 'warning'}">${consentStatus === 'granted' ? 'âœ… Erteilt' : consentStatus === 'revoked' ? 'âŒ Widerrufen' : 'â³ Ausstehend'}</span></td>
                    <td>
                        <div class="consent-actions">
                            <button class="consent-btn grant" onclick="updateConsent('${contact.id}', true)" title="Consent erteilen">âœ…</button>
                            <button class="consent-btn revoke" onclick="updateConsent('${contact.id}', false)" title="Consent widerrufen">âŒ</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });

            if (syncedData.contacts.length > 50) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="6" style="text-align: center; color: var(--text-muted);">... und ${syncedData.contacts.length - 50} weitere Kontakte</td>`;
                tbody.appendChild(row);
            }
        }

        function renderDealsTable() {
            const tbody = document.getElementById('dealsTableBody');
            tbody.innerHTML = '';

            const stageLabels = {
                'appointmentscheduled': 'Termin geplant',
                'qualifiedtobuy': 'Qualifiziert',
                'presentationscheduled': 'PrÃ¤sentation',
                'decisionmakerboughtin': 'Entscheider',
                'contractsent': 'Vertrag gesendet',
                'closedwon': 'Gewonnen',
                'closedlost': 'Verloren'
            };

            syncedData.deals.slice(0, 50).forEach(deal => {
                const props = deal.properties;
                const stage = stageLabels[props.dealstage] || props.dealstage || '-';
                const stageClass = props.dealstage === 'closedwon' ? 'success' : props.dealstage === 'closedlost' ? 'danger' : 'primary';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${props.dealname || '-'}</strong></td>
                    <td>â‚¬${parseFloat(props.amount || 0).toLocaleString('de-DE')}</td>
                    <td><span class="badge badge-${stageClass}">${stage}</span></td>
                    <td>${props.pipeline || 'default'}</td>
                    <td>${props.closedate ? new Date(props.closedate).toLocaleDateString('de-DE') : '-'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CONSENT MANAGEMENT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        async function updateConsent(contactId, granted) {
            try {
                await hubspotRequest(`/crm/v3/objects/contacts/${contactId}`, {
                    method: 'PATCH',
                    body: {
                        properties: {
                            whatsapp_consent: granted ? 'granted' : 'revoked',
                            whatsapp_consent_date: new Date().toISOString()
                        }
                    }
                });

                showToast(`WhatsApp Consent ${granted ? 'erteilt' : 'widerrufen'}`, 'success');

                // Update local data
                const contact = syncedData.contacts.find(c => c.id === contactId);
                if (contact) {
                    contact.properties.whatsapp_consent = granted ? 'granted' : 'revoked';
                }
                renderContactsTable();
                calculateStats();
                updateStatsDisplay();

            } catch (error) {
                showToast(`Fehler: ${error.message}`, 'error');
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // EXPORT FUNCTIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function exportContacts() {
            if (syncedData.contacts.length === 0) {
                showToast('Keine Kontakte zum Exportieren', 'error');
                return;
            }

            const headers = ['ID', 'Vorname', 'Nachname', 'E-Mail', 'Telefon', 'Firma', 'Status', 'WhatsApp Consent'];
            const rows = syncedData.contacts.map(c => [
                c.id,
                c.properties.firstname || '',
                c.properties.lastname || '',
                c.properties.email || '',
                c.properties.phone || '',
                c.properties.company || '',
                c.properties.lifecyclestage || '',
                c.properties.whatsapp_consent || 'pending'
            ]);

            const csv = [headers, ...rows].map(row => row.join(';')).join('\n');
            downloadFile(csv, 'hubspot-contacts.csv', 'text/csv');
            showToast('Kontakte exportiert!', 'success');
        }

        function exportDeals() {
            if (syncedData.deals.length === 0) {
                showToast('Keine Deals zum Exportieren', 'error');
                return;
            }

            const headers = ['ID', 'Deal Name', 'Betrag', 'Stage', 'Pipeline', 'Abschlussdatum'];
            const rows = syncedData.deals.map(d => [
                d.id,
                d.properties.dealname || '',
                d.properties.amount || '0',
                d.properties.dealstage || '',
                d.properties.pipeline || '',
                d.properties.closedate || ''
            ]);

            const csv = [headers, ...rows].map(row => row.join(';')).join('\n');
            downloadFile(csv, 'hubspot-deals.csv', 'text/csv');
            showToast('Deals exportiert!', 'success');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // INITIALIZATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        document.addEventListener('DOMContentLoaded', () => {
            // Check for saved token
            const savedToken = localStorage.getItem('hubspot_token');
            if (savedToken) {
                document.getElementById('apiToken').value = savedToken;
                // Auto-connect with saved token
                connectToHubSpot();
            }
        });

        // Re-sync functions
        function syncContacts() { fullSync(); }
        function syncDeals() { fullSync(); }
    </script>
</body>
</html>
