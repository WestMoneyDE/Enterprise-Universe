<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise Suite | Business Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* Dark Mode Premium Theme */
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a24;
            --bg-elevated: #22222e;
            --bg-hover: #2a2a38;

            /* Accent Colors */
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-tertiary: #a855f7;
            --accent-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);

            /* Status Colors */
            --success: #22c55e;
            --success-glow: rgba(34, 197, 94, 0.2);
            --warning: #f59e0b;
            --warning-glow: rgba(245, 158, 11, 0.2);
            --error: #ef4444;
            --error-glow: rgba(239, 68, 68, 0.2);
            --info: #0ea5e9;
            --info-glow: rgba(14, 165, 233, 0.2);

            /* Text Colors */
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --text-dim: #475569;

            /* Borders & Effects */
            --border: rgba(255, 255, 255, 0.06);
            --border-hover: rgba(255, 255, 255, 0.12);
            --border-glow: rgba(99, 102, 241, 0.3);

            /* Glassmorphism */
            --glass-bg: rgba(26, 26, 36, 0.8);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-blur: blur(20px);

            /* Shadows */
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);
            --shadow-glow: 0 0 30px rgba(99, 102, 241, 0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            font-size: 15px;
            line-height: 1.6;
        }

        /* Custom Scrollbar - Dark Theme */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--bg-elevated); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-primary); }

        /* Glassmorphism Utilities */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
        }
        .glass-card {
            background: rgba(26, 26, 36, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            border-radius: 16px;
        }
        .glass-hover:hover {
            background: rgba(34, 34, 46, 0.8);
            border-color: var(--border-hover);
            box-shadow: var(--shadow-glow);
        }

        /* Gradient Utilities */
        .gradient-text {
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .gradient-border {
            position: relative;
            background: var(--bg-card);
            border: none;
        }
        .gradient-border::before {
            content: '';
            position: absolute;
            inset: 0;
            padding: 1px;
            border-radius: inherit;
            background: var(--accent-gradient);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
        }

        /* Glow Effects */
        .glow-primary { box-shadow: 0 0 20px rgba(99, 102, 241, 0.3); }
        .glow-success { box-shadow: 0 0 20px var(--success-glow); }
        .glow-warning { box-shadow: 0 0 20px var(--warning-glow); }
        .glow-error { box-shadow: 0 0 20px var(--error-glow); }

        /* Animation System */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 15px rgba(99, 102, 241, 0.3); } 50% { box-shadow: 0 0 25px rgba(99, 102, 241, 0.5); } }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }

        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-slide-up { animation: slideUp 0.4s ease-out; }
        .animate-slide-down { animation: slideDown 0.4s ease-out; }
        .animate-scale-in { animation: scaleIn 0.3s ease-out; }
        .animate-pulse-glow { animation: pulse-glow 2s infinite; }

        /* Stagger Animation Classes */
        .stagger-1 { animation-delay: 0.1s; }
        .stagger-2 { animation-delay: 0.2s; }
        .stagger-3 { animation-delay: 0.3s; }
        .stagger-4 { animation-delay: 0.4s; }

        /* Sidebar - Dark Glassmorphism */
        .sidebar {
            width: 240px;
            min-width: 240px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
        }
        .sidebar.collapsed { width: 72px; min-width: 72px; }
        .sidebar.collapsed .nav-text, .sidebar.collapsed .section-title, .sidebar.collapsed .logo-text { display: none; }
        .sidebar.collapsed .nav-item { justify-content: center; padding: 0.75rem; }

        /* Navigation - Premium Dark */
        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            color: var(--text-secondary);
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            position: relative;
            overflow: hidden;
        }
        .nav-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 0;
            background: var(--accent-gradient);
            border-radius: 0 4px 4px 0;
            transition: height 0.25s ease;
        }
        .nav-item:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        .nav-item:hover::before { height: 60%; }
        .nav-item.active {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.1) 100%);
            color: var(--text-primary);
            border: 1px solid rgba(99, 102, 241, 0.2);
        }
        .nav-item.active::before { height: 70%; }

        /* Section Titles */
        .section-title {
            color: var(--text-muted);
            font-size: 0.7rem;
            letter-spacing: 0.1em;
        }

        /* Cards - Glass Dark */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-sm);
        }
        .card:hover {
            border-color: var(--border-hover);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        /* Tabs - Premium */
        .tab-btn {
            padding: 0.625rem 1.25rem;
            border-radius: 10px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.25s ease;
            cursor: pointer;
            border: 1px solid transparent;
            color: var(--text-secondary);
            background: transparent;
        }
        .tab-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        .tab-btn.active {
            background: var(--accent-gradient);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-out; }

        /* Status Indicator - Glow */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            box-shadow: 0 0 10px currentColor;
        }
        .status-dot.pulse { animation: dot-pulse 2s infinite; }
        @keyframes dot-pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        /* Progress Bar - Gradient */
        .progress-bar {
            height: 6px;
            background: var(--bg-elevated);
            border-radius: 3px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            border-radius: 3px;
            background: var(--accent-gradient);
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Pipeline Stages */
        .pipeline-stage { min-width: 320px; }
        .deal-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            cursor: grab;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .deal-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--accent-primary);
        }
        .deal-card:active { cursor: grabbing; }

        /* KPI Cards - Premium Glass */
        .kpi-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--accent-gradient);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .kpi-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-4px);
            border-color: var(--border-hover);
        }
        .kpi-card:hover::before { opacity: 1; }
        .kpi-card.primary { border-top: 3px solid var(--accent-primary); }
        .kpi-card.primary::before { display: none; }
        .kpi-card.success { border-top: 3px solid var(--success); }
        .kpi-card.success::before { display: none; }
        .kpi-card.warning { border-top: 3px solid var(--warning); }
        .kpi-card.warning::before { display: none; }
        .kpi-card.info { border-top: 3px solid var(--info); }
        .kpi-card.info::before { display: none; }
        .kpi-card.accent { border-top: 3px solid var(--accent-secondary); }
        .kpi-card.accent::before { display: none; }

        /* Modal - Glass Effect */
        .modal {
            position: fixed;
            inset: 0;
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: scaleIn 0.3s ease-out;
        }

        /* Animations */
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-in { animation: slideIn 0.25s ease-out; }

        /* Button Styles - Premium */
        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 10px;
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-primary {
            background: var(--accent-gradient);
            color: white;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }
        .btn-primary:hover {
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
            transform: translateY(-2px);
        }
        .btn-secondary {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        .btn-secondary:hover {
            background: var(--bg-hover);
            border-color: var(--border-hover);
        }
        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
        }
        .btn-ghost:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        /* Input Fields - Dark */
        .input-field {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: all 0.25s ease;
            width: 100%;
        }
        .input-field:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        .input-field::placeholder { color: var(--text-muted); }

        /* Tables - Dark Theme */
        .table-dark {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        .table-dark th {
            background: var(--bg-elevated);
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .table-dark td {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            color: var(--text-primary);
        }
        .table-dark tr:hover td {
            background: var(--bg-hover);
        }

        /* Badge Styles */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .badge-primary {
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent-primary);
        }
        .badge-success {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success);
        }
        .badge-warning {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }
        .badge-error {
            background: rgba(239, 68, 68, 0.15);
            color: var(--error);
        }

        /* Sparkline Container */
        .sparkline-container {
            height: 40px;
            margin-top: 0.5rem;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .sidebar { width: 72px; min-width: 72px; }
            .sidebar .nav-text, .sidebar .section-title, .sidebar .logo-text { display: none; }
            .sidebar .nav-item { justify-content: center; padding: 0.75rem; }
        }

        /* Utility Classes for Dark Theme */
        .bg-dark-primary { background: var(--bg-primary); }
        .bg-dark-secondary { background: var(--bg-secondary); }
        .bg-dark-card { background: var(--bg-card); }
        .bg-dark-elevated { background: var(--bg-elevated); }
        .text-dark-primary { color: var(--text-primary); }
        .text-dark-secondary { color: var(--text-secondary); }
        .text-dark-muted { color: var(--text-muted); }
        .border-dark { border-color: var(--border); }
    </style>
</head>
<body class="flex">
    <!-- Sidebar - Premium Dark -->
    <aside class="sidebar h-screen sticky top-0 flex flex-col" id="sidebar">
        <!-- Logo Section -->
        <div class="p-5 border-b border-white/5">
            <div class="flex items-center gap-3">
                <div class="w-11 h-11 rounded-xl flex items-center justify-center flex-shrink-0 animate-pulse-glow" style="background: var(--accent-gradient);">
                    <span class="text-white font-bold text-lg">EU</span>
                </div>
                <div class="logo-text">
                    <h1 class="text-sm font-bold gradient-text">Enterprise Suite</h1>
                    <span class="text-xs text-slate-500">Business Dashboard</span>
                </div>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto p-3 space-y-5">
            <!-- √úbersicht -->
            <div>
                <p class="section-title px-3 mb-2">√úBERSICHT</p>
                <div class="space-y-1">
                    <div class="nav-item active" onclick="switchTab('dashboard')"><span class="text-lg">üìä</span><span class="nav-text">Dashboard</span></div>
                    <div class="nav-item" onclick="switchTab('analytics')"><span class="text-lg">üìà</span><span class="nav-text">Analytics</span></div>
                </div>
            </div>

            <!-- Vertrieb -->
            <div>
                <p class="section-title px-3 mb-2">VERTRIEB</p>
                <div class="space-y-1">
                    <div class="nav-item" onclick="switchTab('crm')"><span class="text-lg">üë•</span><span class="nav-text">Kontakte</span></div>
                    <div class="nav-item" onclick="switchTab('leads')"><span class="text-lg">üéØ</span><span class="nav-text">Leads</span></div>
                    <div class="nav-item" onclick="switchTab('deals')"><span class="text-lg">üíº</span><span class="nav-text">Deals</span></div>
                </div>
            </div>

            <!-- Kommunikation -->
            <div>
                <p class="section-title px-3 mb-2">KOMMUNIKATION</p>
                <div class="space-y-1">
                    <div class="nav-item" onclick="switchTab('email')"><span class="text-lg">üìß</span><span class="nav-text">E-Mail</span></div>
                    <div class="nav-item" onclick="switchTab('whatsapp')"><span class="text-lg">üí¨</span><span class="nav-text">WhatsApp</span></div>
                </div>
            </div>

            <!-- Automatisierung -->
            <div>
                <p class="section-title px-3 mb-2">AUTOMATISIERUNG</p>
                <div class="space-y-1">
                    <div class="nav-item" onclick="switchTab('agents')"><span class="text-lg">ü§ñ</span><span class="nav-text flex items-center gap-2">AI Assistenten<span class="badge badge-primary">42</span></span></div>
                    <div class="nav-item" onclick="switchTab('godmode')"><span class="text-lg">‚ö°</span><span class="nav-text">Workflows</span></div>
                </div>
            </div>

            <!-- Finanzen -->
            <div>
                <p class="section-title px-3 mb-2">FINANZEN</p>
                <div class="space-y-1">
                    <div class="nav-item" onclick="switchTab('invoices')"><span class="text-lg">üìÑ</span><span class="nav-text">Rechnungen</span></div>
                    <div class="nav-item" onclick="switchTab('payments')"><span class="text-lg">üí≥</span><span class="nav-text">Payments</span></div>
                    <div class="nav-item" onclick="switchTab('finance')"><span class="text-lg">üíµ</span><span class="nav-text">√úbersicht</span></div>
                    <div class="nav-item" onclick="switchTab('reports')"><span class="text-lg">üìã</span><span class="nav-text">Berichte</span></div>
                </div>
            </div>

            <!-- System -->
            <div>
                <p class="section-title px-3 mb-2">SYSTEM</p>
                <div class="space-y-1">
                    <div class="nav-item" onclick="switchTab('settings')"><span class="text-lg">‚öôÔ∏è</span><span class="nav-text">Einstellungen</span></div>
                    <div class="nav-item" onclick="window.location.href='/Data%20Room/'"><span class="text-lg">üìÅ</span><span class="nav-text">Dokumente</span></div>
                </div>
            </div>
        </nav>

        <!-- Live Stats - Glow Effect -->
        <div class="p-4 border-t border-white/5 bg-black/20">
            <div class="space-y-3 text-xs">
                <div class="flex items-center gap-3">
                    <span class="status-dot pulse" style="background: var(--success); color: var(--success);"></span>
                    <span class="nav-text text-slate-400" id="sidebarHotLeads">3 Hot Leads</span>
                </div>
                <div class="flex items-center gap-3">
                    <span class="status-dot pulse" style="background: var(--accent-primary); color: var(--accent-primary);"></span>
                    <span class="nav-text text-slate-400" id="sidebarPipeline">‚Ç¨164M Pipeline</span>
                </div>
                <div class="flex items-center gap-3">
                    <span class="status-dot pulse" style="background: var(--accent-secondary); color: var(--accent-secondary);"></span>
                    <span class="nav-text text-slate-400">42 Bots Active</span>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 min-h-screen overflow-y-auto" style="background: var(--bg-primary);">
        <!-- Header - Glass Effect -->
        <header class="sticky top-0 z-40 glass border-b border-white/5">
            <div class="flex items-center justify-between px-6 py-4">
                <div>
                    <h1 class="text-xl font-semibold" style="color: var(--text-primary);" id="pageTitle">Dashboard</h1>
                    <p class="text-sm" style="color: var(--text-secondary);">Willkommen zur√ºck! Hier ist Ihre Gesch√§fts√ºbersicht.</p>
                </div>
                <div class="flex items-center gap-4">
                    <!-- Search Bar -->
                    <button class="hidden md:flex items-center gap-3 px-4 py-2.5 rounded-xl text-sm transition-all duration-200" style="background: var(--bg-elevated); color: var(--text-secondary); border: 1px solid var(--border);" onmouseover="this.style.borderColor='var(--border-hover)'" onmouseout="this.style.borderColor='var(--border)'">
                        <span>üîç</span>
                        <span>Suchen...</span>
                        <kbd class="px-2 py-1 rounded-md text-xs" style="background: var(--bg-card); border: 1px solid var(--border);">‚åòK</kbd>
                    </button>
                    <!-- Notifications -->
                    <button class="relative p-2.5 rounded-xl transition-all duration-200" style="background: var(--bg-elevated);" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='var(--bg-elevated)'" onclick="toggleNotifications()">
                        <span class="text-xl">üîî</span>
                        <span class="absolute -top-1 -right-1 w-5 h-5 text-white text-xs rounded-full flex items-center justify-center font-medium" style="background: var(--accent-gradient);" id="notifBadge">5</span>
                    </button>
                    <!-- User Avatar -->
                    <div class="w-10 h-10 rounded-xl flex items-center justify-center cursor-pointer transition-all duration-200 hover:scale-105" style="background: var(--accent-gradient); box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);">
                        <span class="text-white text-sm font-bold">EU</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Tab Content Container -->
        <div class="p-6">
            <!-- DASHBOARD TAB -->
            <div id="tab-dashboard" class="tab-content active space-y-6">
                <!-- KPI Cards Row - Premium Dark Design -->
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4">
                    <!-- Pipeline Value -->
                    <div class="kpi-card primary animate-slide-up stagger-1">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: rgba(99, 102, 241, 0.15);">
                                <span class="text-2xl">üí∞</span>
                            </div>
                            <span class="badge badge-success">‚Üë 23%</span>
                        </div>
                        <p class="text-2xl font-bold" style="color: var(--text-primary);" id="kpiPipeline">‚Ç¨5.58 Bio.</p>
                        <p class="text-sm mt-1" style="color: var(--text-secondary);">Pipeline Wert</p>
                        <div class="sparkline-container"><canvas id="sparkPipeline"></canvas></div>
                    </div>
                    <!-- Deal Pipeline (Active Deals) -->
                    <div class="kpi-card info animate-slide-up stagger-2">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: rgba(14, 165, 233, 0.15);">
                                <span class="text-2xl">üìä</span>
                            </div>
                            <span class="badge badge-primary">AKTIV</span>
                        </div>
                        <p class="text-2xl font-bold" style="color: var(--info);" id="kpiActiveDeals">3.4 Mio.</p>
                        <p class="text-sm mt-1" style="color: var(--text-secondary);">Deal Pipeline</p>
                        <div class="sparkline-container"><canvas id="sparkActiveDeals"></canvas></div>
                    </div>
                    <!-- Won Value -->
                    <div class="kpi-card success animate-slide-up stagger-3">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: rgba(34, 197, 94, 0.15);">
                                <span class="text-2xl">üíµ</span>
                            </div>
                            <span class="badge badge-success">‚Üë 18%</span>
                        </div>
                        <p class="text-2xl font-bold" style="color: var(--success);" id="kpiWon">‚Ç¨3.1 Mrd.</p>
                        <p class="text-sm mt-1" style="color: var(--text-secondary);">Won Value</p>
                        <div class="sparkline-container"><canvas id="sparkWon"></canvas></div>
                    </div>
                    <!-- Won Deals Count -->
                    <div class="kpi-card success animate-slide-up stagger-4">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: rgba(34, 197, 94, 0.15);">
                                <span class="text-2xl">‚úÖ</span>
                            </div>
                            <span class="badge badge-success">WON</span>
                        </div>
                        <p class="text-2xl font-bold" style="color: var(--success);" id="kpiWonDeals">2.897</p>
                        <p class="text-sm mt-1" style="color: var(--text-secondary);">Won Deals</p>
                        <div class="sparkline-container"><canvas id="sparkWonDeals"></canvas></div>
                    </div>
                    <!-- Trefferquote / Win Rate -->
                    <div class="kpi-card animate-slide-up stagger-1" style="border-top: 3px solid #f59e0b;">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: rgba(245, 158, 11, 0.15);">
                                <span class="text-2xl">üéØ</span>
                            </div>
                            <span class="badge badge-warning" id="kpiWinRateBadge">RATE</span>
                        </div>
                        <p class="text-2xl font-bold" style="color: var(--warning);" id="kpiWinRate">0.09%</p>
                        <p class="text-sm mt-1" style="color: var(--text-secondary);">Trefferquote</p>
                        <div class="sparkline-container"><canvas id="sparkWinRate"></canvas></div>
                    </div>
                    <!-- Total Deals -->
                    <div class="kpi-card accent animate-slide-up stagger-2">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: rgba(139, 92, 246, 0.15);">
                                <span class="text-2xl">üíº</span>
                            </div>
                            <span class="badge badge-primary">TOTAL</span>
                        </div>
                        <p class="text-2xl font-bold" style="color: var(--text-primary);" id="kpiDeals">3.4 Mio.</p>
                        <p class="text-sm mt-1" style="color: var(--text-secondary);">Total Deals</p>
                        <div class="sparkline-container"><canvas id="sparkDeals"></canvas></div>
                    </div>
                    <!-- Contacts -->
                    <div class="kpi-card accent animate-slide-up stagger-3">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: rgba(139, 92, 246, 0.15);">
                                <span class="text-2xl">üë•</span>
                            </div>
                            <span class="badge badge-primary">‚Üë 8%</span>
                        </div>
                        <p class="text-2xl font-bold" style="color: var(--text-primary);" id="kpiContacts">15.1 Mio.</p>
                        <p class="text-sm mt-1" style="color: var(--text-secondary);">Kontakte</p>
                        <div class="sparkline-container"><canvas id="sparkContacts"></canvas></div>
                    </div>
                    <!-- Hot Leads -->
                    <div class="kpi-card warning animate-slide-up stagger-4">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: rgba(245, 158, 11, 0.15);">
                                <span class="text-2xl">üî•</span>
                            </div>
                            <span class="badge badge-warning">HOT</span>
                        </div>
                        <p class="text-2xl font-bold" style="color: var(--warning);" id="kpiHotLeads">3</p>
                        <p class="text-sm mt-1" style="color: var(--text-secondary);">Hot Leads</p>
                        <div class="sparkline-container"><canvas id="sparkHotLeads"></canvas></div>
                    </div>
                </div>

                <!-- Main Grid - Premium Dark Layout -->
                <div class="grid lg:grid-cols-3 gap-6">
                    <!-- AI Assistants Overview -->
                    <div class="lg:col-span-2 glass-card p-6">
                        <div class="flex items-center justify-between mb-5">
                            <div>
                                <h2 class="text-lg font-semibold" style="color: var(--text-primary);">AI Assistenten</h2>
                                <p class="text-sm" style="color: var(--text-secondary);">Automatisierte Workflows</p>
                            </div>
                            <button onclick="switchTab('agents')" class="btn btn-secondary text-sm">Alle anzeigen ‚Üí</button>
                        </div>
                        <div class="grid md:grid-cols-2 gap-4" id="agentGrid">
                            <!-- Analytics Bot -->
                            <div class="rounded-xl p-4 transition-all duration-300 hover:scale-[1.02]" style="background: var(--bg-elevated); border: 1px solid var(--border);">
                                <div class="flex items-start justify-between mb-3">
                                    <div class="flex items-center gap-3">
                                        <div class="w-11 h-11 rounded-xl flex items-center justify-center" style="background: rgba(99, 102, 241, 0.15);">
                                            <span class="text-xl">üìä</span>
                                        </div>
                                        <div><h3 class="font-semibold" style="color: var(--text-primary);">Analytics Bot</h3><p class="text-xs" style="color: var(--text-muted);">Datenanalyse</p></div>
                                    </div>
                                    <span class="badge badge-success">Aktiv</span>
                                </div>
                                <div class="rounded-lg p-3 mb-3" style="background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.2);">
                                    <p class="text-sm" style="color: var(--accent-primary);">Analysiert Pipeline-Trends... +23% Potenzial</p>
                                </div>
                                <div class="flex items-center justify-between text-xs" style="color: var(--text-muted);">
                                    <span>‚ö° 98% Effizienz</span>
                                    <span>üìä 1.250 Tasks</span>
                                </div>
                            </div>
                            <!-- Lead Scorer -->
                            <div class="rounded-xl p-4 transition-all duration-300 hover:scale-[1.02]" style="background: var(--bg-elevated); border: 1px solid var(--border);">
                                <div class="flex items-start justify-between mb-3">
                                    <div class="flex items-center gap-3">
                                        <div class="w-11 h-11 rounded-xl flex items-center justify-center" style="background: rgba(245, 158, 11, 0.15);">
                                            <span class="text-xl">üéØ</span>
                                        </div>
                                        <div><h3 class="font-semibold" style="color: var(--text-primary);">Lead Scorer</h3><p class="text-xs" style="color: var(--text-muted);">Lead-Bewertung</p></div>
                                    </div>
                                    <span class="badge badge-warning">Arbeitet</span>
                                </div>
                                <div class="rounded-lg p-3 mb-3" style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.2);">
                                    <p class="text-sm" style="color: var(--warning);">2.847 Leads heute bewertet</p>
                                </div>
                                <div class="flex items-center justify-between text-xs" style="color: var(--text-muted);">
                                    <span>‚ö° 100% Genauigkeit</span>
                                    <span>üìä 50K+ Tasks</span>
                                </div>
                            </div>
                            <!-- ORION Bot -->
                            <div class="rounded-xl p-4 transition-all duration-300 hover:scale-[1.02]" style="background: var(--bg-elevated); border: 1px solid var(--border);">
                                <div class="flex items-start justify-between mb-3">
                                    <div class="flex items-center gap-3">
                                        <div class="w-11 h-11 rounded-xl flex items-center justify-center" style="background: rgba(14, 165, 233, 0.15);">
                                            <span class="text-2xl">‚≠ê</span>
                                        </div>
                                        <div><h3 class="font-semibold" style="color: var(--text-primary);">ORION</h3><p class="text-xs" style="color: var(--text-muted);">Strategy</p></div>
                                    </div>
                                    <span class="badge badge-primary">SCANNING</span>
                                </div>
                                <div class="rounded-lg p-3 mb-3" style="background: rgba(14, 165, 233, 0.1); border: 1px solid rgba(14, 165, 233, 0.2);">
                                    <p class="text-sm italic" style="color: var(--info);">"3 neue Marktchancen identifiziert"</p>
                                </div>
                                <div class="flex items-center justify-between text-xs" style="color: var(--text-muted);">
                                    <span style="color: var(--success);">‚ö° 95%</span>
                                    <span style="color: var(--info);">‚è± 3.1ms</span>
                                    <span style="color: var(--accent-secondary);">üìä 890</span>
                                </div>
                            </div>
                            <!-- Luna -->
                            <div class="rounded-xl p-4 transition-all duration-300 hover:scale-[1.02]" style="background: var(--bg-elevated); border: 1px solid var(--border);">
                                <div class="flex items-start justify-between mb-3">
                                    <div class="flex items-center gap-3">
                                        <div class="w-11 h-11 rounded-xl flex items-center justify-center" style="background: rgba(139, 92, 246, 0.15);">
                                            <span class="text-2xl">üåô</span>
                                        </div>
                                        <div><h3 class="font-semibold" style="color: var(--text-primary);">LUNA</h3><p class="text-xs" style="color: var(--text-muted);">Security</p></div>
                                    </div>
                                    <span class="badge" style="background: rgba(139, 92, 246, 0.15); color: var(--accent-secondary);">WATCHING</span>
                                </div>
                                <div class="rounded-lg p-3 mb-3" style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.2);">
                                    <p class="text-sm italic" style="color: var(--accent-secondary);">"Alle Systeme sicher - 0 Threats"</p>
                                </div>
                                <div class="flex items-center justify-between text-xs" style="color: var(--text-muted);">
                                    <span style="color: var(--success);">‚ö° 100%</span>
                                    <span style="color: var(--info);">‚è± 0.8ms</span>
                                    <span style="color: var(--accent-secondary);">üìä 24/7</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Live Activity -->
                    <div class="glass-card p-6">
                        <div class="flex items-center justify-between mb-5">
                            <h2 class="font-semibold flex items-center gap-2" style="color: var(--text-primary);">üîî Live Activity<span class="w-2 h-2 rounded-full animate-pulse" style="background: var(--success); box-shadow: 0 0 10px var(--success);"></span></h2>
                        </div>
                        <div class="space-y-3" id="activityFeed">
                            <div class="flex gap-3 p-3 rounded-xl animate-slide-in" style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.2);">
                                <span class="text-lg">‚úÖ</span>
                                <div class="flex-1">
                                    <p class="text-sm font-semibold" style="color: var(--text-primary);">Deal gewonnen</p>
                                    <p class="text-xs" style="color: var(--text-muted);">‚Ç¨2.5M - PropTech GmbH</p>
                                </div>
                                <span class="text-xs" style="color: var(--text-muted);">2m</span>
                            </div>
                            <div class="flex gap-3 p-3 rounded-xl" style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.2);">
                                <span class="text-lg">üß†</span>
                                <div class="flex-1">
                                    <p class="text-sm font-semibold" style="color: var(--text-primary);">Einstein analysiert</p>
                                    <p class="text-xs" style="color: var(--text-muted);">1,250 Leads gescored</p>
                                </div>
                                <span class="text-xs" style="color: var(--text-muted);">5m</span>
                            </div>
                            <div class="flex gap-3 p-3 rounded-xl" style="background: rgba(14, 165, 233, 0.1); border: 1px solid rgba(14, 165, 233, 0.2);">
                                <span class="text-lg">üìß</span>
                                <div class="flex-1">
                                    <p class="text-sm font-semibold" style="color: var(--text-primary);">Email Kampagne</p>
                                    <p class="text-xs" style="color: var(--text-muted);">5,000 versendet - 78% Open Rate</p>
                                </div>
                                <span class="text-xs" style="color: var(--text-muted);">8m</span>
                            </div>
                            <div class="flex gap-3 p-3 rounded-xl" style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.2);">
                                <span class="text-lg">üí¨</span>
                                <div class="flex-1">
                                    <p class="text-sm font-semibold" style="color: var(--text-primary);">WhatsApp Opt-Ins</p>
                                    <p class="text-xs" style="color: var(--text-muted);">+89 neue Kontakte</p>
                                </div>
                                <span class="text-xs" style="color: var(--text-muted);">12m</span>
                            </div>
                            <div class="flex gap-3 p-3 rounded-xl" style="background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.2);">
                                <span class="text-lg">üîÑ</span>
                                <div class="flex-1">
                                    <p class="text-sm font-semibold" style="color: var(--text-primary);">HubSpot Sync</p>
                                    <p class="text-xs" style="color: var(--text-muted);">3,170 Kontakte synchronisiert</p>
                                </div>
                                <span class="text-xs" style="color: var(--text-muted);">15m</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="grid lg:grid-cols-2 gap-6">
                    <div class="glass-card p-6">
                        <h3 class="font-semibold mb-4" style="color: var(--text-primary);">üìà Pipeline Performance</h3>
                        <canvas id="pipelineChart" height="200"></canvas>
                    </div>
                    <div class="glass-card p-6">
                        <h3 class="font-semibold mb-4" style="color: var(--text-primary);">üéØ Lead Sources</h3>
                        <canvas id="sourceChart" height="200"></canvas>
                    </div>
                </div>

                <!-- HubSpot Sync Card -->
                <div class="card p-5 border-orange-500/30">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-orange-500/20 rounded-lg flex items-center justify-center">
                                <span class="text-xl">üî∂</span>
                            </div>
                            <div>
                                <h3 class="font-semibold">HubSpot CRM Sync</h3>
                                <p class="text-xs text-slate-500" id="hubspotSyncStatus">Bereit zum Synchronisieren</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="fetchAllHubSpotData()" class="px-3 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-sm transition" title="Alle Daten laden">
                                üì• Full Import
                            </button>
                            <button id="hubspotSyncBtn" onclick="syncHubSpot()" class="px-4 py-2 bg-orange-500 hover:bg-orange-600 rounded-lg text-sm font-semibold text-white transition">
                                üîÑ Sync
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="p-3 bg-white/5 rounded-lg text-center">
                            <p class="text-xl font-bold text-orange-400" id="hubspotContacts">-</p>
                            <p class="text-xs text-slate-500">Kontakte</p>
                        </div>
                        <div class="p-3 bg-white/5 rounded-lg text-center">
                            <p class="text-xl font-bold text-green-400" id="hubspotDeals">-</p>
                            <p class="text-xs text-slate-500">Deals</p>
                        </div>
                        <div class="p-3 bg-white/5 rounded-lg text-center">
                            <p class="text-xl font-bold text-cyan-400" id="hubspotCompanies">-</p>
                            <p class="text-xs text-slate-500">Companies</p>
                        </div>
                        <div class="p-3 bg-white/5 rounded-lg text-center">
                            <p class="text-sm font-semibold text-slate-500" id="hubspotSyncTime">-</p>
                            <p class="text-xs text-slate-500">Letzter Sync</p>
                        </div>
                    </div>
                </div>

                <!-- System Status -->
                <div class="card p-5">
                    <h3 class="font-semibold mb-4">üñ•Ô∏è System Status - 99.99% Uptime</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4">
                        <div class="flex items-center gap-3 p-3 bg-white/5 rounded-lg">
                            <span class="status-dot bg-green-500"></span>
                            <div><p class="text-sm font-semibold">HubSpot</p><p class="text-xs text-slate-500">Connected</p></div>
                        </div>
                        <div class="flex items-center gap-3 p-3 bg-white/5 rounded-lg">
                            <span class="status-dot bg-green-500"></span>
                            <div><p class="text-sm font-semibold">PostgreSQL</p><p class="text-xs text-slate-500">142/400 GB</p></div>
                        </div>
                        <div class="flex items-center gap-3 p-3 bg-white/5 rounded-lg">
                            <span class="status-dot bg-green-500"></span>
                            <div><p class="text-sm font-semibold">WhatsApp</p><p class="text-xs text-slate-500">Active</p></div>
                        </div>
                        <div class="flex items-center gap-3 p-3 bg-white/5 rounded-lg">
                            <span class="status-dot bg-green-500"></span>
                            <div><p class="text-sm font-semibold">Claude AI</p><p class="text-xs text-slate-500">Opus 4.5</p></div>
                        </div>
                        <div class="flex items-center gap-3 p-3 bg-white/5 rounded-lg">
                            <span class="status-dot bg-yellow-500"></span>
                            <div><p class="text-sm font-semibold">LOXONE</p><p class="text-xs text-yellow-400">Gold Partner</p></div>
                        </div>
                        <div class="flex items-center gap-3 p-3 bg-white/5 rounded-lg">
                            <span class="status-dot bg-green-500"></span>
                            <div><p class="text-sm font-semibold">Backend</p><p class="text-xs text-slate-500">2.3ms</p></div>
                        </div>
                        <div class="flex items-center gap-3 p-3 bg-white/5 rounded-lg">
                            <span class="status-dot bg-green-500"></span>
                            <div><p class="text-sm font-semibold">42 Agents</p><p class="text-xs text-slate-500">All Active</p></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <!-- CRM TAB -->
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div id="tab-crm" class="tab-content space-y-6">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold gradient-text">CRM ULTRA</h2>
                    <div class="flex gap-3">
                        <button class="btn btn-primary">+ Neuer Kontakt</button>
                        <button class="btn btn-secondary">Import</button>
                    </div>
                </div>

                <!-- CRM Stats -->
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <div class="glass-card p-5 text-center"><p class="text-2xl font-bold" style="color: var(--info);" id="crmTotalContacts">-</p><p class="text-xs" style="color: var(--text-muted);">Total Contacts</p></div>
                    <div class="glass-card p-5 text-center"><p class="text-2xl font-bold" style="color: var(--success);" id="crmSynced">100</p><p class="text-xs" style="color: var(--text-muted);">HubSpot Sample</p></div>
                    <div class="glass-card p-5 text-center"><p class="text-2xl font-bold" style="color: var(--error);" id="crmHotLeads">3</p><p class="text-xs" style="color: var(--text-muted);">Hot Leads</p></div>
                    <div class="glass-card p-5 text-center"><p class="text-2xl font-bold" style="color: var(--warning);" id="crmWarmLeads">0</p><p class="text-xs" style="color: var(--text-muted);">Warm Leads</p></div>
                    <div class="glass-card p-5 text-center"><p class="text-2xl font-bold" style="color: var(--accent-secondary);">-</p><p class="text-xs" style="color: var(--text-muted);">Data Quality</p></div>
                </div>

                <!-- CRM Table -->
                <div class="glass-card overflow-hidden">
                    <div class="p-4 flex items-center justify-between" style="border-bottom: 1px solid var(--border);">
                        <input type="text" placeholder="Suche Kontakte..." class="input-field w-80">
                        <div class="flex gap-2">
                            <select class="input-field w-auto" style="width: auto;">
                                <option>Alle Status</option>
                                <option>HOT</option>
                                <option>WARM</option>
                                <option>COLD</option>
                            </select>
                        </div>
                    </div>
                    <table class="table-dark">
                        <thead>
                            <tr>
                                <th>Kontakt</th>
                                <th>Company</th>
                                <th>Score</th>
                                <th>Status</th>
                                <th>Last Activity</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="crmTable">
                            <tr>
                                <td><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full flex items-center justify-center font-semibold text-white" style="background: var(--accent-gradient);">MK</div><div><p class="font-semibold" style="color: var(--text-primary);">Max K√∂nig</p><p class="text-xs" style="color: var(--text-muted);">max@proptech.de</p></div></div></td>
                                <td style="color: var(--text-primary);">PropTech GmbH</td>
                                <td><span class="badge badge-error font-semibold">98</span></td>
                                <td><span class="badge badge-error">HOT</span></td>
                                <td style="color: var(--text-muted);">vor 2 Stunden</td>
                                <td><button class="btn btn-ghost text-xs" style="color: var(--accent-primary);">View</button></td>
                            </tr>
                            <tr>
                                <td><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full flex items-center justify-center font-semibold text-white" style="background: linear-gradient(135deg, #f59e0b, #ef4444);">AS</div><div><p class="font-semibold" style="color: var(--text-primary);">Anna Schmidt</p><p class="text-xs" style="color: var(--text-muted);">anna@smartliving.io</p></div></div></td>
                                <td style="color: var(--text-primary);">SmartLiving AG</td>
                                <td><span class="badge badge-warning font-semibold">76</span></td>
                                <td><span class="badge badge-warning">WARM</span></td>
                                <td style="color: var(--text-muted);">vor 1 Tag</td>
                                <td><button class="btn btn-ghost text-xs" style="color: var(--accent-primary);">View</button></td>
                            </tr>
                            <tr>
                                <td><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full flex items-center justify-center font-semibold text-white" style="background: linear-gradient(135deg, #0ea5e9, #8b5cf6);">TM</div><div><p class="font-semibold" style="color: var(--text-primary);">Thomas M√ºller</p><p class="text-xs" style="color: var(--text-muted);">t.mueller@immobilien.de</p></div></div></td>
                                <td style="color: var(--text-primary);">Immobilien Plus</td>
                                <td><span class="badge badge-error font-semibold">95</span></td>
                                <td><span class="badge badge-error">HOT</span></td>
                                <td style="color: var(--text-muted);">vor 30 Min</td>
                                <td><button class="btn btn-ghost text-xs" style="color: var(--accent-primary);">View</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <!-- LEADS TAB -->
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div id="tab-leads" class="tab-content space-y-6">
                <div class="flex items-center justify-between">
                    <h2 class="font-orbitron text-2xl font-bold gradient-text">LEAD DISCOVERY</h2>
                    <button class="px-4 py-2 bg-gradient-to-r from-purple-500 to-cyan-500 rounded-lg text-sm font-semibold hover:opacity-90 transition">üîç Auto-Discovery starten</button>
                </div>

                <div class="grid lg:grid-cols-3 gap-6">
                    <!-- Lead Scoring -->
                    <div class="lg:col-span-2 card p-5">
                        <h3 class="font-semibold mb-4">üéØ Lead Scoring Distribution</h3>
                        <div class="grid grid-cols-4 gap-4 mb-6">
                            <div class="text-center p-4 bg-red-500/10 rounded-lg border border-red-500/30">
                                <p class="text-3xl font-bold text-red-400">2,847</p>
                                <p class="text-sm text-red-400/70">üî• HOT (80-100)</p>
                            </div>
                            <div class="text-center p-4 bg-yellow-500/10 rounded-lg border border-yellow-500/30">
                                <p class="text-3xl font-bold text-yellow-400">5,234</p>
                                <p class="text-sm text-yellow-400/70">‚ö° WARM (50-79)</p>
                            </div>
                            <div class="text-center p-4 bg-blue-500/10 rounded-lg border border-blue-500/30">
                                <p class="text-3xl font-bold text-blue-400">8,912</p>
                                <p class="text-sm text-blue-400/70">‚ùÑÔ∏è COLD (20-49)</p>
                            </div>
                            <div class="text-center p-4 bg-gray-500/10 rounded-lg border border-gray-500/30">
                                <p class="text-3xl font-bold text-gray-400">12,456</p>
                                <p class="text-sm text-gray-400/70">üí§ NEW (0-19)</p>
                            </div>
                        </div>
                        <canvas id="leadScoreChart" height="150"></canvas>
                    </div>

                    <!-- Quick Actions -->
                    <div class="card p-5">
                        <h3 class="font-semibold mb-4">‚ö° Quick Actions</h3>
                        <div class="space-y-3">
                            <button class="w-full p-3 bg-red-500/10 hover:bg-red-500/20 border border-red-500/30 rounded-lg text-left transition">
                                <div class="flex items-center gap-3"><span class="text-xl">üî•</span><div><p class="font-semibold">HOT Leads anrufen</p><p class="text-xs text-slate-500">2,847 Leads warten</p></div></div>
                            </button>
                            <button class="w-full p-3 bg-purple-500/10 hover:bg-purple-500/20 border border-purple-500/30 rounded-lg text-left transition">
                                <div class="flex items-center gap-3"><span class="text-xl">üß†</span><div><p class="font-semibold">AI Scoring starten</p><p class="text-xs text-slate-500">12,456 unscored</p></div></div>
                            </button>
                            <button class="w-full p-3 bg-cyan-500/10 hover:bg-cyan-500/20 border border-cyan-500/30 rounded-lg text-left transition">
                                <div class="flex items-center gap-3"><span class="text-xl">üìß</span><div><p class="font-semibold">Email Sequence</p><p class="text-xs text-slate-500">Nurture Campaign</p></div></div>
                            </button>
                            <button class="w-full p-3 bg-green-500/10 hover:bg-green-500/20 border border-green-500/30 rounded-lg text-left transition">
                                <div class="flex items-center gap-3"><span class="text-xl">üîÑ</span><div><p class="font-semibold">HubSpot Sync</p><p class="text-xs text-slate-500">Last: vor 5 Min</p></div></div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <!-- DEALS PIPELINE TAB -->
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div id="tab-deals" class="tab-content space-y-6">
                <!-- Header mit Sync -->
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="font-orbitron text-2xl font-bold gradient-gold">DEALS PIPELINE</h2>
                        <p class="text-sm text-slate-500">Letzte Aktualisierung: <span id="dealsLastUpdate">-</span></p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="loadDealsFromHubSpot()" class="px-4 py-2 bg-orange-500 hover:bg-orange-600 rounded-lg text-sm font-semibold text-white transition">
                            üîÑ HubSpot Sync
                        </button>
                        <button onclick="openNewDealModal()" class="px-4 py-2 bg-gradient-to-r from-yellow-500 to-orange-500 rounded-lg text-sm font-semibold text-black hover:opacity-90 transition">+ Neuer Deal</button>
                    </div>
                </div>

                <!-- Pipeline KPIs mit Trefferquote -->
                <div class="grid grid-cols-2 md:grid-cols-6 gap-4">
                    <div class="card p-4 text-center border-purple-500/30">
                        <p class="text-2xl font-bold gradient-text" id="dealsTotalCount">3.4M</p>
                        <p class="text-xs text-slate-500">Gesamt Deals</p>
                    </div>
                    <div class="card p-4 text-center border-yellow-500/30">
                        <p class="text-2xl font-bold text-yellow-400" id="dealsTotalValue">‚Ç¨411B</p>
                        <p class="text-xs text-slate-500">Pipeline Wert</p>
                    </div>
                    <div class="card p-4 text-center border-green-500/30">
                        <p class="text-2xl font-bold text-green-400" id="dealsWinRate">34.7%</p>
                        <p class="text-xs text-slate-500">Trefferquote</p>
                    </div>
                    <div class="card p-4 text-center border-cyan-500/30">
                        <p class="text-2xl font-bold text-cyan-400" id="dealsAvgValue">‚Ç¨121K</p>
                        <p class="text-xs text-slate-500">√ò Deal-Wert</p>
                    </div>
                    <div class="card p-4 text-center border-blue-500/30">
                        <p class="text-2xl font-bold text-blue-400" id="dealsAvgCycle">42</p>
                        <p class="text-xs text-slate-500">√ò Tage bis Close</p>
                    </div>
                    <div class="card p-4 text-center border-red-500/30">
                        <p class="text-2xl font-bold text-red-400" id="dealsAtRisk">127</p>
                        <p class="text-xs text-slate-500">At Risk</p>
                    </div>
                </div>

                <!-- Lead Demon Status & Pipeline Progress -->
                <div class="grid lg:grid-cols-3 gap-4">
                    <!-- Lead Demon Card - Enhanced Dark Mode -->
                    <div class="glass-card p-4" style="border-color: var(--info);">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background: var(--accent-gradient); box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);">
                                    <span class="text-xl">ü§ñ</span>
                                </div>
                                <div>
                                    <h3 class="font-semibold" style="color: var(--text-primary);">Auto Lead Bot</h3>
                                    <p class="text-xs" style="color: var(--text-muted);" id="leadDemonStatus"><span style="color: var(--success);">‚úì Autonom aktiv</span></p>
                                </div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" class="sr-only peer" checked onchange="toggleLeadDemon()">
                                <div class="w-9 h-5 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all" style="background: var(--bg-elevated);" class="peer-checked:bg-blue-600"></div>
                            </label>
                        </div>

                        <!-- Stats Grid -->
                        <div class="grid grid-cols-3 gap-2 text-center text-xs mb-3">
                            <div class="p-2 rounded-lg" style="background: var(--bg-elevated);">
                                <p class="font-bold text-lg" style="color: var(--info);" id="demonProcessed">0</p>
                                <p style="color: var(--text-muted);">Analysiert</p>
                            </div>
                            <div class="p-2 rounded-lg" style="background: var(--bg-elevated);">
                                <p class="font-bold text-lg" style="color: var(--success);" id="demonUpgraded">0</p>
                                <p style="color: var(--text-muted);">Aktualisiert</p>
                            </div>
                            <div class="p-2 rounded-lg" style="background: var(--bg-elevated);">
                                <p class="font-bold text-lg" style="color: var(--text-muted);" id="demonDowngraded">0</p>
                                <p style="color: var(--text-muted);">Optimal</p>
                            </div>
                        </div>

                        <!-- Recent Updates Panel -->
                        <div class="rounded-lg p-2 mb-3 max-h-32 overflow-y-auto" style="background: var(--bg-elevated);" id="leadDemonUpdates">
                            <p class="text-xs text-center py-2" style="color: var(--text-muted);">Bot arbeitet automatisch...</p>
                        </div>

                        <p class="text-xs text-center" style="color: var(--text-muted);">
                            <span class="inline-flex items-center gap-1">
                                <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                                Letzte Ausf√ºhrung: <span id="demonLastRun">-</span> | Automatisch alle 2 Min
                            </span>
                        </p>
                    </div>

                    <!-- Pipeline Progress Bar + Scoring Info -->
                    <div class="card p-4 lg:col-span-2">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-semibold">Pipeline Conversion Funnel</span>
                            <span class="text-xs text-slate-500">Score-basierte Stufen</span>
                        </div>
                        <div class="flex h-8 rounded-lg overflow-hidden">
                            <div class="bg-blue-500 flex items-center justify-center text-xs font-semibold" style="width: 25%" title="Score 0-39">Termin 20%</div>
                            <div class="bg-cyan-500 flex items-center justify-center text-xs font-semibold" style="width: 20%" title="Score 40-59">Qualifiziert 40%</div>
                            <div class="bg-purple-500 flex items-center justify-center text-xs font-semibold" style="width: 20%" title="Score 60-74">Pr√§sentation 60%</div>
                            <div class="bg-yellow-500 flex items-center justify-center text-xs font-semibold text-black" style="width: 20%" title="Score 75-89">Entscheider 80%</div>
                            <div class="bg-green-500 flex items-center justify-center text-xs font-semibold" style="width: 15%" title="Score 90+">Vertrag 90%</div>
                        </div>

                        <!-- Scoring Factors -->
                        <div class="mt-3 grid grid-cols-2 gap-3 text-xs">
                            <div class="rounded-lg p-2" style="background: var(--bg-elevated);">
                                <p class="font-semibold text-red-400 mb-1">üòà Lead Scoring Faktoren</p>
                                <div class="space-y-1" style="color: var(--text-muted);">
                                    <p>üí∞ Deal-Wert: ‚Ç¨50K+ = +30pts</p>
                                    <p>‚≠ê A-Class Deal: +25pts</p>
                                    <p>üè≠ Industry 4.0: +20pts</p>
                                    <p>üè† Smart Home: +15pts</p>
                                </div>
                            </div>
                            <div class="rounded-lg p-2" style="background: var(--bg-elevated);">
                                <p class="font-semibold text-purple-400 mb-1">üìä Stage Thresholds</p>
                                <div class="space-y-1" style="color: var(--text-muted);">
                                    <p>90+ ‚Üí Vertrag gesendet</p>
                                    <p>75+ ‚Üí Entscheider</p>
                                    <p>60+ ‚Üí Pr√§sentation</p>
                                    <p>40+ ‚Üí Qualifiziert</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pipeline Kanban - Dynamisch -->
                <div class="flex gap-4 overflow-x-auto pb-4" id="pipelineKanban">
                    <!-- Wird dynamisch geladen -->
                    <div class="w-full text-center py-10 text-slate-500">
                        <span class="animate-spin text-2xl">‚ü≥</span>
                        <p class="mt-2">Lade Deals von HubSpot...</p>
                    </div>
                </div>

                <!-- Recent Deals Table mit Lead Scoring -->
                <div class="glass-card">
                    <div class="p-4 flex items-center justify-between" style="border-bottom: 1px solid var(--border);">
                        <h3 class="font-semibold" style="color: var(--text-primary);">üìä Aktuelle Deals mit Lead Score</h3>
                        <div class="flex gap-2">
                            <select id="dealsStageFilter" onchange="filterDealsByStage()" class="input-field" style="width: auto;">
                                <option value="all">Alle Stages</option>
                                <option value="qualification">Qualification</option>
                                <option value="meeting">Meeting</option>
                                <option value="proposal">Proposal</option>
                                <option value="negotiation">Negotiation</option>
                                <option value="closedwon">Closed Won</option>
                                <option value="closedlost">Closed Lost</option>
                            </select>
                            <input type="text" id="dealsSearch" onkeyup="searchDeals()" placeholder="Deal suchen..." class="input-field w-48">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="table-dark">
                            <thead>
                                <tr>
                                    <th class="cursor-pointer hover:text-white" onclick="sortDealsTable('name')">Deal Name ‚Üï</th>
                                    <th class="cursor-pointer hover:text-white" onclick="sortDealsTable('amount')">Betrag ‚Üï</th>
                                    <th>Stage</th>
                                    <th>Lead Score</th>
                                    <th>Kontakt</th>
                                    <th class="cursor-pointer hover:text-white" onclick="sortDealsTable('closedate')">Close Date ‚Üï</th>
                                    <th>Wahrscheinlichkeit</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="dealsTableBody">
                                <!-- Wird dynamisch geladen -->
                            </tbody>
                        </table>
                    </div>
                    <div class="p-4 flex items-center justify-between" style="border-top: 1px solid var(--border);">
                        <p class="text-sm" style="color: var(--text-muted);" id="dealsTableInfo">Lade Deals...</p>
                        <div class="flex gap-2" id="dealsPagination">
                            <button class="btn btn-ghost text-sm" onclick="loadDealsPage('prev')">‚Üê Prev</button>
                            <button class="btn btn-primary text-sm">1</button>
                            <button class="btn btn-ghost text-sm" onclick="loadDealsPage('next')">Next ‚Üí</button>
                        </div>
                    </div>
                </div>

                <!-- Deal Analytics Charts -->
                <div class="grid lg:grid-cols-2 gap-6">
                    <div class="card p-5">
                        <h3 class="font-semibold mb-4">üìà Deals nach Stage</h3>
                        <canvas id="dealsByStageChart" height="200"></canvas>
                    </div>
                    <div class="card p-5">
                        <h3 class="font-semibold mb-4">üí∞ Monatlicher Deal-Wert</h3>
                        <canvas id="dealsValueChart" height="200"></canvas>
                    </div>
                </div>
            </div>

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <!-- EMAIL TAB -->
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div id="tab-email" class="tab-content space-y-6">
                <div class="flex items-center justify-between">
                    <h2 class="font-orbitron text-2xl font-bold gradient-text">EMAIL HUB</h2>
                    <div class="flex gap-2">
                        <button class="px-4 py-2 bg-purple-500 hover:bg-purple-600 rounded-lg text-sm font-semibold transition">üìß Neue Kampagne</button>
                        <button class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-sm transition">Templates</button>
                    </div>
                </div>

                <!-- Email Stats -->
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <div class="card p-4 text-center"><p class="text-2xl font-bold text-purple-400">125,847</p><p class="text-xs text-slate-500">Emails/Monat</p></div>
                    <div class="card p-4 text-center"><p class="text-2xl font-bold text-green-400">78%</p><p class="text-xs text-slate-500">Open Rate</p></div>
                    <div class="card p-4 text-center"><p class="text-2xl font-bold text-cyan-400">23%</p><p class="text-xs text-slate-500">Click Rate</p></div>
                    <div class="card p-4 text-center"><p class="text-2xl font-bold text-yellow-400">12%</p><p class="text-xs text-slate-500">Reply Rate</p></div>
                    <div class="card p-4 text-center"><p class="text-2xl font-bold text-red-400">0.8%</p><p class="text-xs text-slate-500">Bounce Rate</p></div>
                </div>

                <!-- Active Campaigns -->
                <div class="glass-card p-5">
                    <h3 class="font-semibold mb-4" style="color: var(--text-primary);">üìä Aktive Kampagnen</h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-4 rounded-lg" style="background: var(--bg-elevated);">
                            <div class="flex items-center gap-4">
                                <span class="text-2xl">üöÄ</span>
                                <div>
                                    <p class="font-semibold" style="color: var(--text-primary);">Investor Outreach Q1</p>
                                    <p class="text-xs" style="color: var(--text-muted);">5,000 Recipients ‚Ä¢ Started vor 2 Tagen</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-6">
                                <div class="text-center"><p class="text-lg font-bold text-green-400">82%</p><p class="text-xs" style="color: var(--text-muted);">Opened</p></div>
                                <div class="text-center"><p class="text-lg font-bold text-cyan-400">28%</p><p class="text-xs" style="color: var(--text-muted);">Clicked</p></div>
                                <div class="text-center"><p class="text-lg font-bold text-purple-400">45</p><p class="text-xs" style="color: var(--text-muted);">Meetings</p></div>
                                <span class="badge badge-success">Active</span>
                            </div>
                        </div>
                        <div class="flex items-center justify-between p-4 rounded-lg" style="background: var(--bg-elevated);">
                            <div class="flex items-center gap-4">
                                <span class="text-2xl">üè†</span>
                                <div>
                                    <p class="font-semibold" style="color: var(--text-primary);">LOXONE Partner Nurture</p>
                                    <p class="text-xs" style="color: var(--text-muted);">2,500 Recipients ‚Ä¢ Started vor 1 Woche</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-6">
                                <div class="text-center"><p class="text-lg font-bold text-green-400">75%</p><p class="text-xs" style="color: var(--text-muted);">Opened</p></div>
                                <div class="text-center"><p class="text-lg font-bold text-cyan-400">19%</p><p class="text-xs" style="color: var(--text-muted);">Clicked</p></div>
                                <div class="text-center"><p class="text-lg font-bold text-purple-400">23</p><p class="text-xs" style="color: var(--text-muted);">Meetings</p></div>
                                <span class="badge badge-success">Active</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <!-- AI AGENTS TAB -->
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div id="tab-agents" class="tab-content space-y-6">
                <div class="flex items-center justify-between">
                    <h2 class="font-orbitron text-2xl font-bold gradient-text">GENIUS HUB - 42 AI AGENTS</h2>
                    <div class="flex gap-2">
                        <button class="px-4 py-2 bg-purple-500 hover:bg-purple-600 rounded-lg text-sm font-semibold transition">üß† Neuer Agent</button>
                        <button class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-sm transition">Alle aktivieren</button>
                    </div>
                </div>

                <!-- Agent Stats -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="card p-4 text-center"><p class="text-2xl font-bold text-green-400">42</p><p class="text-xs text-slate-500">Active Agents</p></div>
                    <div class="card p-4 text-center"><p class="text-2xl font-bold text-purple-400">1.2M</p><p class="text-xs text-slate-500">Tasks/Day</p></div>
                    <div class="card p-4 text-center"><p class="text-2xl font-bold text-cyan-400">2.1ms</p><p class="text-xs text-slate-500">Avg Response</p></div>
                    <div class="card p-4 text-center"><p class="text-2xl font-bold text-yellow-400">99.9%</p><p class="text-xs text-slate-500">Uptime</p></div>
                </div>

                <!-- All Agents Grid -->
                <div class="grid md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4" id="allAgentsGrid">
                    <!-- Will be populated dynamically -->
                </div>
            </div>

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <!-- ANALYTICS TAB -->
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div id="tab-analytics" class="tab-content space-y-6">
                <h2 class="font-orbitron text-2xl font-bold gradient-text">ANALYTICS & INSIGHTS</h2>

                <div class="grid lg:grid-cols-2 gap-6">
                    <div class="card p-5">
                        <h3 class="font-semibold mb-4">üìà Revenue Trend</h3>
                        <canvas id="revenueChart" height="200"></canvas>
                    </div>
                    <div class="card p-5">
                        <h3 class="font-semibold mb-4">üéØ Conversion Funnel</h3>
                        <canvas id="funnelChart" height="200"></canvas>
                    </div>
                </div>
            </div>

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <!-- FINANCE TAB -->
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div id="tab-finance" class="tab-content space-y-6">
                <div class="flex items-center justify-between">
                    <h2 class="font-orbitron text-2xl font-bold gradient-gold">FINANCE & INVOICES HUB</h2>
                    <div class="flex gap-2">
                        <button onclick="openModal('invoiceModal')" class="px-4 py-2 bg-gradient-to-r from-yellow-500 to-orange-500 rounded-lg text-sm font-semibold text-black hover:opacity-90 transition">+ Neue Rechnung</button>
                        <button class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-sm transition">Export</button>
                    </div>
                </div>

                <!-- Finance KPIs -->
                <div class="grid grid-cols-2 md:grid-cols-6 gap-4">
                    <div class="card p-4 text-center hover:scale-[1.02] transition-transform cursor-pointer" onclick="filterInvoices('all')">
                        <p class="text-2xl font-bold text-green-400" id="finRevenue">‚Ç¨127M</p>
                        <p class="text-xs text-slate-500">Revenue YTD</p>
                    </div>
                    <div class="card p-4 text-center hover:scale-[1.02] transition-transform cursor-pointer" onclick="filterInvoices('paid')">
                        <p class="text-2xl font-bold text-purple-400" id="finPaid">‚Ç¨89M</p>
                        <p class="text-xs text-slate-500">Bezahlt</p>
                    </div>
                    <div class="card p-4 text-center hover:scale-[1.02] transition-transform cursor-pointer" onclick="filterInvoices('pending')">
                        <p class="text-2xl font-bold text-yellow-400" id="finPending">‚Ç¨28M</p>
                        <p class="text-xs text-slate-500">Ausstehend</p>
                    </div>
                    <div class="card p-4 text-center hover:scale-[1.02] transition-transform cursor-pointer" onclick="filterInvoices('overdue')">
                        <p class="text-2xl font-bold text-red-400" id="finOverdue">‚Ç¨10M</p>
                        <p class="text-xs text-slate-500">√úberf√§llig</p>
                    </div>
                    <div class="card p-4 text-center">
                        <p class="text-2xl font-bold text-cyan-400">89%</p>
                        <p class="text-xs text-slate-500">Collection Rate</p>
                    </div>
                    <div class="card p-4 text-center">
                        <p class="text-2xl font-bold text-white">1,247</p>
                        <p class="text-xs text-slate-500">Total Invoices</p>
                    </div>
                </div>

                <!-- Invoices Table -->
                <div class="glass-card overflow-hidden">
                    <div class="p-4 flex flex-wrap items-center justify-between gap-4" style="border-bottom: 1px solid var(--border);">
                        <input type="text" id="invoiceSearch" placeholder="Suche Rechnungen..." class="input-field w-80" onkeyup="searchInvoices()">
                        <div class="flex gap-2">
                            <select id="invoiceStatusFilter" class="input-field" style="width: auto;" onchange="filterInvoices(this.value)">
                                <option value="all">Alle Status</option>
                                <option value="paid">Bezahlt</option>
                                <option value="pending">Ausstehend</option>
                                <option value="overdue">√úberf√§llig</option>
                                <option value="draft">Entwurf</option>
                            </select>
                            <select class="input-field" style="width: auto;">
                                <option>Letzte 30 Tage</option>
                                <option>Letzte 90 Tage</option>
                                <option>Dieses Jahr</option>
                                <option>Alle</option>
                            </select>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="table-dark">
                            <thead>
                                <tr>
                                    <th class="cursor-pointer hover:text-white" onclick="sortInvoices('id')">Rechnung # ‚Üï</th>
                                    <th class="cursor-pointer hover:text-white" onclick="sortInvoices('customer')">Kunde ‚Üï</th>
                                    <th class="cursor-pointer hover:text-white" onclick="sortInvoices('amount')">Betrag ‚Üï</th>
                                    <th>Status</th>
                                    <th class="cursor-pointer hover:text-white" onclick="sortInvoices('date')">Datum ‚Üï</th>
                                    <th>F√§llig</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="invoicesTable">
                                <tr class="hover:bg-white/5 transition-colors">
                                    <td class="p-4 font-mono text-purple-400">#INV-2024-001</td>
                                    <td class="p-4"><div class="flex items-center gap-3"><div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-cyan-500 rounded-full flex items-center justify-center text-xs font-semibold">PT</div><div><p class="font-semibold">PropTech GmbH</p><p class="text-xs text-slate-500">max@proptech.de</p></div></div></td>
                                    <td class="p-4 font-semibold">‚Ç¨2,450,000</td>
                                    <td class="p-4"><span class="px-2 py-1 bg-green-500/20 text-green-400 text-xs rounded">Bezahlt</span></td>
                                    <td class="p-4 text-sm">10.01.2024</td>
                                    <td class="p-4 text-sm text-slate-500">10.02.2024</td>
                                    <td class="p-4"><div class="flex gap-2"><button class="px-2 py-1 bg-purple-500/20 text-purple-400 rounded text-xs hover:bg-purple-500/30" onclick="viewInvoice('INV-2024-001')">View</button><button class="px-2 py-1 bg-cyan-500/20 text-cyan-400 rounded text-xs hover:bg-cyan-500/30">PDF</button></div></td>
                                </tr>
                                <tr class="hover:bg-white/5 transition-colors">
                                    <td class="p-4 font-mono text-purple-400">#INV-2024-002</td>
                                    <td class="p-4"><div class="flex items-center gap-3"><div class="w-8 h-8 bg-gradient-to-br from-yellow-500 to-orange-500 rounded-full flex items-center justify-center text-xs font-semibold">SL</div><div><p class="font-semibold">SmartLiving AG</p><p class="text-xs text-slate-500">billing@smartliving.io</p></div></div></td>
                                    <td class="p-4 font-semibold">‚Ç¨890,000</td>
                                    <td class="p-4"><span class="px-2 py-1 bg-yellow-500/20 text-yellow-400 text-xs rounded">Ausstehend</span></td>
                                    <td class="p-4 text-sm">08.01.2024</td>
                                    <td class="p-4 text-sm text-yellow-400">08.02.2024</td>
                                    <td class="p-4"><div class="flex gap-2"><button class="px-2 py-1 bg-purple-500/20 text-purple-400 rounded text-xs hover:bg-purple-500/30" onclick="viewInvoice('INV-2024-002')">View</button><button class="px-2 py-1 bg-green-500/20 text-green-400 rounded text-xs hover:bg-green-500/30">Remind</button></div></td>
                                </tr>
                                <tr class="hover:bg-white/5 transition-colors">
                                    <td class="p-4 font-mono text-purple-400">#INV-2024-003</td>
                                    <td class="p-4"><div class="flex items-center gap-3"><div class="w-8 h-8 bg-gradient-to-br from-red-500 to-pink-500 rounded-full flex items-center justify-center text-xs font-semibold">RE</div><div><p class="font-semibold">Real Estate Empire</p><p class="text-xs text-slate-500">finance@realestate.de</p></div></div></td>
                                    <td class="p-4 font-semibold">‚Ç¨5,670,000</td>
                                    <td class="p-4"><span class="px-2 py-1 bg-red-500/20 text-red-400 text-xs rounded">√úberf√§llig</span></td>
                                    <td class="p-4 text-sm">15.12.2023</td>
                                    <td class="p-4 text-sm text-red-400">15.01.2024</td>
                                    <td class="p-4"><div class="flex gap-2"><button class="px-2 py-1 bg-purple-500/20 text-purple-400 rounded text-xs hover:bg-purple-500/30" onclick="viewInvoice('INV-2024-003')">View</button><button class="px-2 py-1 bg-red-500/20 text-red-400 rounded text-xs hover:bg-red-500/30">Urgent</button></div></td>
                                </tr>
                                <tr class="hover:bg-white/5 transition-colors">
                                    <td class="p-4 font-mono text-purple-400">#INV-2024-004</td>
                                    <td class="p-4"><div class="flex items-center gap-3"><div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-xs font-semibold">TC</div><div><p class="font-semibold">TechCorp AG</p><p class="text-xs text-slate-500">ap@techcorp.de</p></div></div></td>
                                    <td class="p-4 font-semibold">‚Ç¨1,250,000</td>
                                    <td class="p-4"><span class="px-2 py-1 bg-green-500/20 text-green-400 text-xs rounded">Bezahlt</span></td>
                                    <td class="p-4 text-sm">05.01.2024</td>
                                    <td class="p-4 text-sm text-slate-500">05.02.2024</td>
                                    <td class="p-4"><div class="flex gap-2"><button class="px-2 py-1 bg-purple-500/20 text-purple-400 rounded text-xs hover:bg-purple-500/30" onclick="viewInvoice('INV-2024-004')">View</button><button class="px-2 py-1 bg-cyan-500/20 text-cyan-400 rounded text-xs hover:bg-cyan-500/30">PDF</button></div></td>
                                </tr>
                                <tr class="hover:bg-white/5 transition-colors">
                                    <td class="p-4 font-mono text-purple-400">#INV-2024-005</td>
                                    <td class="p-4"><div class="flex items-center gap-3"><div class="w-8 h-8 bg-gradient-to-br from-green-500 to-teal-500 rounded-full flex items-center justify-center text-xs font-semibold">LX</div><div><p class="font-semibold">LOXONE Partner</p><p class="text-xs text-slate-500">partner@loxone.com</p></div></div></td>
                                    <td class="p-4 font-semibold">‚Ç¨780,000</td>
                                    <td class="p-4"><span class="px-2 py-1 bg-gray-500/20 text-gray-400 text-xs rounded">Entwurf</span></td>
                                    <td class="p-4 text-sm">-</td>
                                    <td class="p-4 text-sm text-slate-500">-</td>
                                    <td class="p-4"><div class="flex gap-2"><button class="px-2 py-1 bg-purple-500/20 text-purple-400 rounded text-xs hover:bg-purple-500/30">Edit</button><button class="px-2 py-1 bg-green-500/20 text-green-400 rounded text-xs hover:bg-green-500/30">Send</button></div></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="p-4 flex items-center justify-between" style="border-top: 1px solid var(--border);">
                        <p class="text-sm" style="color: var(--text-muted);">Zeige 1-5 von 1,247 Rechnungen</p>
                        <div class="flex gap-2">
                            <button class="btn btn-ghost text-sm">‚Üê Prev</button>
                            <button class="btn btn-primary text-sm">1</button>
                            <button class="btn btn-ghost text-sm">2</button>
                            <button class="btn btn-ghost text-sm">3</button>
                            <button class="btn btn-ghost text-sm">Next ‚Üí</button>
                        </div>
                    </div>
                </div>

                <!-- Finance Charts -->
                <div class="grid lg:grid-cols-2 gap-6">
                    <div class="card p-5">
                        <h3 class="font-semibold mb-4">üí∞ Monthly Revenue</h3>
                        <canvas id="financeRevenueChart" height="200"></canvas>
                    </div>
                    <div class="card p-5">
                        <h3 class="font-semibold mb-4">üìä Invoice Status Distribution</h3>
                        <canvas id="invoiceStatusChart" height="200"></canvas>
                    </div>
                </div>
            </div>

            <!-- WhatsApp Hub Tab -->
            <div id="tab-whatsapp" class="tab-content space-y-6">
                <!-- Header -->
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold flex items-center gap-3">
                            <span class="text-3xl">üí¨</span> WhatsApp Business Hub
                        </h1>
                        <p class="text-slate-500 text-sm mt-1">Verbinden Sie WhatsApp mit HubSpot CRM</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="loadWhatsAppStatus()" class="px-4 py-2 bg-green-500/20 text-green-400 rounded-lg text-sm font-semibold hover:bg-green-500/30 transition">
                            üîÑ Status pr√ºfen
                        </button>
                    </div>
                </div>

                <!-- Connection Status & Stats -->
                <div class="grid md:grid-cols-4 gap-4">
                    <div class="card p-4 border-green-500/30" id="whatsappStatusCard">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-12 h-12 rounded-xl bg-green-500/20 flex items-center justify-center">
                                <span class="text-2xl">üì±</span>
                            </div>
                            <div>
                                <p class="font-semibold" id="waConnectionStatus">Pr√ºfe...</p>
                                <p class="text-xs text-slate-500" id="waPhoneNumber">-</p>
                            </div>
                        </div>
                    </div>
                    <div class="card p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-2xl font-bold text-green-400" id="waSentCount">0</p>
                                <p class="text-xs text-slate-500">Gesendet</p>
                            </div>
                            <span class="text-3xl">üì§</span>
                        </div>
                    </div>
                    <div class="card p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-2xl font-bold text-blue-400" id="waDeliveredCount">0</p>
                                <p class="text-xs text-slate-500">Zugestellt</p>
                            </div>
                            <span class="text-3xl">‚úì‚úì</span>
                        </div>
                    </div>
                    <div class="card p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-2xl font-bold text-purple-400" id="waReadCount">0</p>
                                <p class="text-xs text-slate-500">Gelesen</p>
                            </div>
                            <span class="text-3xl">üëÅÔ∏è</span>
                        </div>
                    </div>
                </div>

                <!-- Main Content Grid -->
                <div class="grid lg:grid-cols-3 gap-6">
                    <!-- Send Message Panel -->
                    <div class="card p-4">
                        <h3 class="font-semibold text-green-400 mb-4 flex items-center gap-2">
                            <span>‚úâÔ∏è</span> Nachricht senden
                        </h3>
                        <div class="space-y-3">
                            <div>
                                <label class="text-xs text-slate-500 mb-1 block">Empf√§nger</label>
                                <input type="text" id="waRecipient" placeholder="+49 170 1234567"
                                    class="w-full px-3 py-2 input-field focus:border-green-500">
                            </div>
                            <div>
                                <label class="text-xs text-slate-500 mb-1 block">Typ</label>
                                <select id="waMessageType" onchange="toggleWaTemplateSelect()"
                                    class="w-full px-3 py-2 input-field">
                                    <option value="text">Text</option>
                                    <option value="template">Template</option>
                                </select>
                            </div>
                            <div id="waTemplateSelect" class="hidden">
                                <label class="text-xs text-slate-500 mb-1 block">Template</label>
                                <select id="waTemplate" class="w-full px-3 py-2 input-field"></select>
                            </div>
                            <div id="waTextInput">
                                <label class="text-xs text-slate-500 mb-1 block">Nachricht</label>
                                <textarea id="waMessage" rows="3" placeholder="Ihre Nachricht..."
                                    class="w-full px-3 py-2 input-field resize-none"></textarea>
                            </div>
                            <button onclick="sendWhatsAppMessage()" class="w-full py-2 bg-green-500 hover:bg-green-600 rounded-lg text-sm font-semibold transition">
                                üì± Senden
                            </button>
                        </div>
                        <div class="mt-4 pt-4 border-t" style="border-color: var(--border);">
                            <p class="text-xs text-slate-500 mb-2">Schnell:</p>
                            <div class="flex flex-wrap gap-1">
                                <button onclick="sendQuickWA('Hallo! Wie kann ich helfen?')" class="px-2 py-1 bg-white/5 rounded text-xs hover:bg-white/10">üëã</button>
                                <button onclick="sendQuickWA('Vielen Dank!')" class="px-2 py-1 bg-white/5 rounded text-xs hover:bg-white/10">üôè</button>
                                <button onclick="sendQuickWA('Ich melde mich!')" class="px-2 py-1 bg-white/5 rounded text-xs hover:bg-white/10">‚è∞</button>
                            </div>
                        </div>
                    </div>

                    <!-- Templates Panel -->
                    <div class="card p-4">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-purple-400 flex items-center gap-2">
                                <span>üìã</span> Templates
                            </h3>
                            <button onclick="loadWhatsAppTemplates()" class="text-xs text-purple-400 hover:text-purple-300">üîÑ</button>
                        </div>
                        <div class="space-y-2 max-h-72 overflow-y-auto" id="waTemplatesList">
                            <div class="text-center py-4 text-slate-500 text-sm">Templates laden...</div>
                        </div>
                    </div>

                    <!-- Recent Messages -->
                    <div class="card p-4">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-cyan-400 flex items-center gap-2">
                                <span>üí¨</span> Letzte Nachrichten
                            </h3>
                            <button onclick="loadWhatsAppMessages()" class="text-xs text-cyan-400 hover:text-cyan-300">üîÑ</button>
                        </div>
                        <div class="space-y-2 max-h-72 overflow-y-auto" id="waMessagesList">
                            <div class="text-center py-4 text-slate-500 text-sm">Keine Nachrichten</div>
                        </div>
                    </div>
                </div>

                <!-- Bulk & HubSpot -->
                <div class="grid lg:grid-cols-2 gap-6">
                    <div class="card p-4">
                        <h3 class="font-semibold text-yellow-400 mb-4 flex items-center gap-2">
                            <span>üì¢</span> Bulk Messaging
                        </h3>
                        <div class="space-y-3">
                            <select id="waBulkSource" class="w-full px-3 py-2 input-field">
                                <option value="hubspot_hot">Hot Leads (Score 75+)</option>
                                <option value="hubspot_leads">Alle Leads</option>
                                <option value="hubspot_all">Alle Kontakte</option>
                            </select>
                            <select id="waBulkTemplate" class="w-full px-3 py-2 input-field">
                                <option value="welcome_message">welcome_message</option>
                                <option value="follow_up">follow_up</option>
                                <option value="deal_update">deal_update</option>
                            </select>
                            <div class="flex gap-2">
                                <input type="number" id="waBulkLimit" value="10" min="1" max="100"
                                    class="w-20 px-3 py-2 input-field">
                                <button onclick="sendBulkWhatsApp()" class="flex-1 py-2 bg-yellow-500 hover:bg-yellow-600 text-black rounded-lg text-sm font-semibold transition">
                                    üì¢ Bulk senden
                                </button>
                            </div>
                            <div id="waBulkProgress" class="hidden">
                                <div class="h-2 bg-white/5 rounded-full overflow-hidden">
                                    <div id="waBulkProgressBar" class="h-full bg-green-500 transition-all" style="width: 0%"></div>
                                </div>
                                <p class="text-xs text-center mt-1" id="waBulkProgressText">0/0</p>
                            </div>
                        </div>
                    </div>

                    <div class="card p-4">
                        <h3 class="font-semibold text-orange-400 mb-4 flex items-center gap-2">
                            <span>üîó</span> HubSpot Integration
                        </h3>
                        <div class="bg-white/5 rounded-lg p-3 mb-3">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <span class="text-xl">üë•</span>
                                    <div>
                                        <p class="font-semibold text-sm">Kontakte mit Telefon</p>
                                        <p class="text-xs text-slate-500" id="waHubspotContacts">Laden...</p>
                                    </div>
                                </div>
                                <span class="text-green-400 text-xs">‚úì Verbunden</span>
                            </div>
                        </div>
                        <div class="text-xs space-y-1">
                            <label class="flex items-center gap-2 p-2 bg-white/5 rounded cursor-pointer">
                                <input type="checkbox" id="waAutoWelcome" class="accent-green-500">
                                <span>Welcome bei neuem Lead</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 bg-white/5 rounded cursor-pointer">
                                <input type="checkbox" id="waAutoFollowup" class="accent-green-500">
                                <span>Follow-up nach 48h</span>
                            </label>
                        </div>
                        <button onclick="syncWhatsAppHubSpot()" class="w-full mt-3 py-2 bg-orange-500 hover:bg-orange-600 rounded-lg text-sm font-semibold transition">
                            üîÑ Sync mit HubSpot
                        </button>
                    </div>
                </div>
            </div>
            <div id="tab-godmode" class="tab-content"><div class="card p-10 text-center"><h2 class="text-2xl font-bold mb-4 font-kanji">Á•û GOD MODE</h2><p class="text-slate-500">HAIKU Activated ‚Ä¢ Full Control</p></div></div>
            <div id="tab-prophecy" class="tab-content"><div class="card p-10 text-center"><h2 class="text-2xl font-bold mb-4">üîÆ Prophecy Mode</h2><p class="text-slate-500">AI Predictions & Forecasting</p></div></div>
            <div id="tab-hakai" class="tab-content"><div class="card p-10 text-center"><h2 class="text-2xl font-bold mb-4 gradient-fire">üí• HAKAI MODE</h2><p class="text-slate-500">Destruction Protocol Ready</p></div></div>
            <div id="tab-reports" class="tab-content"><div class="card p-10 text-center"><h2 class="text-2xl font-bold mb-4">üìã Reports</h2><p class="text-slate-500">Generate & Export Reports</p></div></div>

            <!-- INVOICES TAB -->
            <div id="tab-invoices" class="tab-content space-y-6">
                <!-- Invoice Header -->
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-xl font-semibold" style="color: var(--text-primary);">Rechnungen</h2>
                        <p class="text-sm" style="color: var(--text-muted);">Verwalten Sie Ihre Rechnungen und automatische Abrechnung</p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="openAutoInvoiceSettings()" class="btn btn-secondary flex items-center gap-2">
                            <span>‚öôÔ∏è</span> Auto-Rechnungen
                        </button>
                        <button onclick="openCreateInvoice()" class="btn btn-primary flex items-center gap-2">
                            <span>‚ûï</span> Neue Rechnung
                        </button>
                    </div>
                </div>

                <!-- Invoice Stats -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="glass-card p-4">
                        <p class="text-sm mb-1" style="color: var(--text-muted);">Gesamt diesen Monat</p>
                        <p class="text-2xl font-bold" style="color: var(--accent-primary);" id="invoiceTotalMonth">‚Ç¨0</p>
                        <p class="text-xs text-emerald-400 mt-1">‚Üë 15% vs. Vormonat</p>
                    </div>
                    <div class="glass-card p-4">
                        <p class="text-sm mb-1" style="color: var(--text-muted);">Bezahlt</p>
                        <p class="text-2xl font-bold text-emerald-400" id="invoicePaid">‚Ç¨0</p>
                        <p class="text-xs mt-1" style="color: var(--text-muted);" id="invoicePaidCount">0 Rechnungen</p>
                    </div>
                    <div class="glass-card p-4">
                        <p class="text-sm mb-1" style="color: var(--text-muted);">Ausstehend</p>
                        <p class="text-2xl font-bold text-amber-400" id="invoicePending">‚Ç¨0</p>
                        <p class="text-xs mt-1" style="color: var(--text-muted);" id="invoicePendingCount">0 Rechnungen</p>
                    </div>
                    <div class="glass-card p-4">
                        <p class="text-sm mb-1" style="color: var(--text-muted);">√úberf√§llig</p>
                        <p class="text-2xl font-bold text-red-400" id="invoiceOverdue">‚Ç¨0</p>
                        <p class="text-xs text-red-400 mt-1" id="invoiceOverdueCount">0 Rechnungen</p>
                    </div>
                </div>

                <!-- Auto Invoice Settings Card -->
                <div class="glass-card p-5" style="border-color: var(--info);">
                    <div class="flex items-start justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: var(--accent-gradient); box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);">
                                <span class="text-2xl">ü§ñ</span>
                            </div>
                            <div>
                                <h3 class="font-semibold" style="color: var(--text-primary);">Automatische Rechnungsstellung</h3>
                                <p class="text-sm" style="color: var(--text-muted);">Rechnungen werden automatisch bei Deal-Abschluss erstellt</p>
                            </div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="autoInvoiceToggle" class="sr-only peer" checked onchange="toggleAutoInvoice(this.checked)">
                            <div class="w-11 h-6 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600" style="background: var(--bg-elevated);"></div>
                            <span class="ml-2 text-sm font-medium" style="color: var(--text-muted);" id="autoInvoiceStatus">Aktiv</span>
                        </label>
                    </div>
                    <div class="mt-4 grid grid-cols-3 gap-4 text-sm">
                        <div class="rounded-lg p-3" style="background: var(--bg-elevated);">
                            <p style="color: var(--text-muted);">Diesen Monat erstellt</p>
                            <p class="text-lg font-semibold" style="color: var(--text-primary);" id="autoInvoiceCount">0</p>
                        </div>
                        <div class="rounded-lg p-3" style="background: var(--bg-elevated);">
                            <p style="color: var(--text-muted);">Automatischer Versand</p>
                            <p class="text-lg font-semibold text-emerald-400">Aktiviert</p>
                        </div>
                        <div class="rounded-lg p-3" style="background: var(--bg-elevated);">
                            <p style="color: var(--text-muted);">Zahlungsziel</p>
                            <p class="text-lg font-semibold" style="color: var(--text-primary);">14 Tage</p>
                        </div>
                    </div>
                </div>

                <!-- Invoice List -->
                <div class="glass-card overflow-hidden">
                    <div class="p-4 flex items-center justify-between" style="border-bottom: 1px solid var(--border);">
                        <h3 class="font-semibold" style="color: var(--text-primary);">Rechnungsliste</h3>
                        <div class="flex items-center gap-2">
                            <select class="input-field" style="width: auto;" id="invoiceFilter" onchange="filterInvoices(this.value)">
                                <option value="all">Alle anzeigen</option>
                                <option value="paid">Bezahlt</option>
                                <option value="pending">Ausstehend</option>
                                <option value="overdue">√úberf√§llig</option>
                                <option value="draft">Entwurf</option>
                            </select>
                            <button onclick="exportInvoices()" class="btn btn-secondary text-sm">üì• Export</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="table-dark">
                            <thead>
                                <tr>
                                    <th>Rechnung #</th>
                                    <th>Kunde</th>
                                    <th>Deal</th>
                                    <th>Betrag</th>
                                    <th>Status</th>
                                    <th>Datum</th>
                                    <th>F√§llig</th>
                                    <th>Aktionen</th>
                                </tr>
                            </thead>
                            <tbody id="invoiceTableBody">
                                <!-- Invoice rows will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="p-4 flex items-center justify-between text-sm" style="border-top: 1px solid var(--border); color: var(--text-muted);">
                        <span id="invoiceTableInfo">L√§dt...</span>
                        <div class="flex gap-2">
                            <button onclick="prevInvoicePage()" class="btn btn-ghost">‚Üê</button>
                            <button onclick="nextInvoicePage()" class="btn btn-ghost">‚Üí</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payments Tab -->
            <div id="tab-payments" class="tab-content space-y-6">
                <!-- Header -->
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold flex items-center gap-3">
                            <span class="text-3xl">üí≥</span> Stripe Payments
                        </h1>
                        <p class="text-[var(--text-muted)] text-sm mt-1">Zahlungen, Abonnements & Produkte verwalten</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="loadStripeData()" class="px-4 py-2 bg-purple-500/20 text-purple-400 rounded-lg text-sm font-semibold hover:bg-purple-500/30 transition">
                            üîÑ Aktualisieren
                        </button>
                        <a href="https://dashboard.stripe.com" target="_blank" class="px-4 py-2 bg-[#635BFF]/20 text-[#635BFF] rounded-lg text-sm font-semibold hover:bg-[#635BFF]/30 transition">
                            ‚Üó Stripe Dashboard
                        </a>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="grid md:grid-cols-4 gap-4">
                    <div class="card p-4 border-green-500/30" id="stripeStatusCard">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="w-10 h-10 rounded-lg bg-[#635BFF]/20 flex items-center justify-center">
                                <span class="text-xl">üí≥</span>
                            </div>
                            <div>
                                <p class="font-semibold" id="stripeStatus">Pr√ºfe...</p>
                                <p class="text-xs text-[var(--text-muted)]" id="stripeMode">-</p>
                            </div>
                        </div>
                    </div>
                    <div class="card p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-2xl font-bold text-green-400" id="stripeRevenue">‚Ç¨0</p>
                                <p class="text-xs text-[var(--text-muted)]">Umsatz (Gesamt)</p>
                            </div>
                            <span class="text-3xl">üí∞</span>
                        </div>
                    </div>
                    <div class="card p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-2xl font-bold text-blue-400" id="stripePayments">0</p>
                                <p class="text-xs text-[var(--text-muted)]">Zahlungen</p>
                            </div>
                            <span class="text-3xl">‚úì</span>
                        </div>
                    </div>
                    <div class="card p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-2xl font-bold text-purple-400" id="stripeSubscriptions">0</p>
                                <p class="text-xs text-[var(--text-muted)]">Aktive Abos</p>
                            </div>
                            <span class="text-3xl">üîÑ</span>
                        </div>
                    </div>
                </div>

                <!-- Main Grid -->
                <div class="grid lg:grid-cols-3 gap-6">
                    <!-- Products -->
                    <div class="card p-4">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-purple-400 flex items-center gap-2">
                                <span>üì¶</span> Produkte
                            </h3>
                            <span class="text-xs text-[var(--text-muted)]" id="stripeProductCount">0 Produkte</span>
                        </div>
                        <div class="space-y-2 max-h-80 overflow-y-auto" id="stripeProductsList">
                            <div class="text-center py-4 text-[var(--text-muted)] text-sm">Lade Produkte...</div>
                        </div>
                    </div>

                    <!-- Subscriptions -->
                    <div class="card p-4">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-blue-400 flex items-center gap-2">
                                <span>üîÑ</span> Abonnements
                            </h3>
                            <select id="subStatusFilter" onchange="loadStripeSubscriptions()" class="text-xs bg-[var(--bg-elevated)] border border-[var(--border)] rounded px-2 py-1">
                                <option value="active">Aktiv</option>
                                <option value="all">Alle</option>
                                <option value="canceled">Gek√ºndigt</option>
                            </select>
                        </div>
                        <div class="space-y-2 max-h-80 overflow-y-auto" id="stripeSubscriptionsList">
                            <div class="text-center py-4 text-[var(--text-muted)] text-sm">Lade Abos...</div>
                        </div>
                    </div>

                    <!-- Recent Payments -->
                    <div class="card p-4">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-green-400 flex items-center gap-2">
                                <span>üíµ</span> Letzte Zahlungen
                            </h3>
                            <button onclick="loadStripePayments()" class="text-xs text-green-400 hover:text-green-300">üîÑ</button>
                        </div>
                        <div class="space-y-2 max-h-80 overflow-y-auto" id="stripePaymentsList">
                            <div class="text-center py-4 text-[var(--text-muted)] text-sm">Lade Zahlungen...</div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="grid lg:grid-cols-2 gap-6">
                    <!-- Create Checkout -->
                    <div class="card p-4">
                        <h3 class="font-semibold text-yellow-400 mb-4 flex items-center gap-2">
                            <span>‚ö°</span> Schnell-Checkout erstellen
                        </h3>
                        <div class="space-y-3">
                            <div>
                                <label class="text-xs text-[var(--text-muted)] mb-1 block">Produkt/Preis</label>
                                <select id="checkoutPriceId" class="w-full px-3 py-2 bg-[var(--bg-elevated)] border border-[var(--border)] rounded-lg text-sm"></select>
                            </div>
                            <div>
                                <label class="text-xs text-[var(--text-muted)] mb-1 block">Kunden-Email (optional)</label>
                                <input type="email" id="checkoutEmail" placeholder="kunde@email.de" class="w-full px-3 py-2 bg-[var(--bg-elevated)] border border-[var(--border)] rounded-lg text-sm">
                            </div>
                            <div class="flex gap-2">
                                <button onclick="createCheckoutSession('payment')" class="flex-1 py-2 bg-green-500 hover:bg-green-600 rounded-lg text-sm font-semibold transition">
                                    üí≥ Einmalzahlung
                                </button>
                                <button onclick="createCheckoutSession('subscription')" class="flex-1 py-2 bg-purple-500 hover:bg-purple-600 rounded-lg text-sm font-semibold transition">
                                    üîÑ Abo starten
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Customers -->
                    <div class="card p-4">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-cyan-400 flex items-center gap-2">
                                <span>üë•</span> Kunden
                            </h3>
                            <button onclick="loadStripeCustomers()" class="text-xs text-cyan-400 hover:text-cyan-300">üîÑ</button>
                        </div>
                        <div class="space-y-2 max-h-52 overflow-y-auto" id="stripeCustomersList">
                            <div class="text-center py-4 text-[var(--text-muted)] text-sm">Lade Kunden...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-settings" class="tab-content"><div class="card p-10 text-center"><h2 class="text-2xl font-bold mb-4">‚öôÔ∏è Settings</h2><p class="text-slate-500">System Configuration</p></div></div>
        </div>
    </main>

    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ENTERPRISE UNIVERSE V11 - MEGA GOD MODE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        const API_BASE = '/api/v1';

        // Tab Switching
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('tab-' + tabId)?.classList.add('active');

            // Find and activate the nav item that corresponds to this tab
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                const onclick = item.getAttribute('onclick');
                if (onclick && onclick.includes(`'${tabId}'`)) {
                    item.classList.add('active');
                }
            });

            // Update page title with proper names
            const titleMap = {
                'dashboard': 'Dashboard',
                'crm': 'CRM Ultra',
                'leads': 'Lead Discovery',
                'deals': 'Deals Pipeline',
                'email': 'Email Hub',
                'whatsapp': 'WhatsApp Hub',
                'payments': 'Stripe Payments',
                'agents': 'Genius Hub',
                'godmode': 'GOD Mode',
                'prophecy': 'Prophecy Mode',
                'hakai': 'Hakai Mode',
                'analytics': 'Analytics',
                'finance': 'Finance Hub',
                'reports': 'Reports',
                'settings': 'Settings'
            };
            document.getElementById('pageTitle').textContent = titleMap[tabId] || tabId.charAt(0).toUpperCase() + tabId.slice(1);

            // Tab-specific initialization
            if (tabId === 'whatsapp') {
                initWhatsAppTab();
            } else if (tabId === 'deals') {
                loadDealsFromHubSpot();
            } else if (tabId === 'payments') {
                initPaymentsTab();
            }
        }

        // Format Numbers - German style
        function formatNumber(num) {
            if (num >= 1e12) return (num / 1e12).toFixed(2) + ' Bio.';
            if (num >= 1e9) return (num / 1e9).toFixed(2) + ' Mrd.';
            if (num >= 1e6) return (num / 1e6).toFixed(1) + ' Mio.';
            if (num >= 1e3) return (num / 1e3).toFixed(1) + 'K';
            return num.toLocaleString('de-DE');
        }

        // Dark Theme Chart Defaults
        Chart.defaults.color = '#94a3b8';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.06)';

        // Initialize Charts
        function initCharts() {
            // Pipeline Chart - Dark Theme
            const pipelineCtx = document.getElementById('pipelineChart')?.getContext('2d');
            if (pipelineCtx) {
                const gradient = pipelineCtx.createLinearGradient(0, 0, 0, 200);
                gradient.addColorStop(0, 'rgba(99, 102, 241, 0.3)');
                gradient.addColorStop(1, 'rgba(99, 102, 241, 0)');

                new Chart(pipelineCtx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                        datasets: [{
                            label: 'Pipeline (‚Ç¨B)',
                            data: [12, 15, 18, 22, 25, 28, 30, 32, 34, 35, 36, 37],
                            borderColor: '#6366f1',
                            backgroundColor: gradient,
                            fill: true,
                            tension: 0.4,
                            borderWidth: 3,
                            pointBackgroundColor: '#6366f1',
                            pointBorderColor: '#1a1a24',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                grid: { color: 'rgba(255,255,255,0.06)', drawBorder: false },
                                ticks: { color: '#64748b' }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { color: '#64748b' }
                            }
                        }
                    }
                });
            }

            // Source Chart - Dark Theme
            const sourceCtx = document.getElementById('sourceChart')?.getContext('2d');
            if (sourceCtx) {
                new Chart(sourceCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['LinkedIn', 'Website', 'Referral', 'Events', 'Cold Outreach'],
                        datasets: [{
                            data: [35, 25, 20, 12, 8],
                            backgroundColor: ['#6366f1', '#8b5cf6', '#22c55e', '#f59e0b', '#ef4444'],
                            borderColor: '#1a1a24',
                            borderWidth: 3,
                            hoverBorderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        cutout: '65%',
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: { color: '#94a3b8', padding: 15, usePointStyle: true, pointStyle: 'circle' }
                            }
                        }
                    }
                });
            }

            // Initialize Sparklines
            initSparklines();
        }

        // Sparkline Mini Charts
        function initSparklines() {
            const sparklineConfig = (color, data) => ({
                type: 'line',
                data: {
                    labels: ['', '', '', '', '', '', ''],
                    datasets: [{
                        data: data,
                        borderColor: color,
                        borderWidth: 2,
                        fill: false,
                        tension: 0.4,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    scales: { x: { display: false }, y: { display: false } }
                }
            });

            const sparklines = [
                { id: 'sparkPipeline', color: '#6366f1', data: [120, 135, 142, 155, 160, 158, 164] },
                { id: 'sparkActiveDeals', color: '#0ea5e9', data: [3.1, 3.2, 3.25, 3.3, 3.35, 3.38, 3.40] },
                { id: 'sparkWon', color: '#22c55e', data: [2.1, 2.4, 2.6, 2.8, 2.9, 3.0, 3.08] },
                { id: 'sparkWonDeals', color: '#10b981', data: [2100, 2300, 2500, 2650, 2750, 2850, 2906] },
                { id: 'sparkWinRate', color: '#f59e0b', data: [0.06, 0.07, 0.075, 0.08, 0.082, 0.084, 0.085] },
                { id: 'sparkDeals', color: '#0ea5e9', data: [2.8, 2.9, 3.0, 3.1, 3.2, 3.3, 3.4] },
                { id: 'sparkContacts', color: '#8b5cf6', data: [12, 13, 13.5, 14, 14.5, 15, 15.1] },
                { id: 'sparkHotLeads', color: '#f59e0b', data: [5, 4, 6, 4, 5, 4, 3] }
            ];

            sparklines.forEach(spark => {
                const ctx = document.getElementById(spark.id)?.getContext('2d');
                if (ctx) new Chart(ctx, sparklineConfig(spark.color, spark.data));
            });
        }

        // Generate All Agents
        function generateAgents() {
            // Color mapping for Tailwind classes (CDN doesn't support dynamic classes)
            const colorClasses = {
                purple: { bg: 'bg-purple-500/20', text: 'text-purple-400' },
                yellow: { bg: 'bg-yellow-500/20', text: 'text-yellow-400' },
                blue: { bg: 'bg-blue-500/20', text: 'text-blue-400' },
                violet: { bg: 'bg-violet-500/20', text: 'text-violet-400' },
                green: { bg: 'bg-green-500/20', text: 'text-green-400' },
                pink: { bg: 'bg-pink-500/20', text: 'text-pink-400' },
                orange: { bg: 'bg-orange-500/20', text: 'text-orange-400' },
                red: { bg: 'bg-red-500/20', text: 'text-red-400' },
                cyan: { bg: 'bg-cyan-500/20', text: 'text-cyan-400' },
                gray: { bg: 'bg-gray-500/20', text: 'text-gray-400' },
                gold: { bg: 'bg-yellow-500/20', text: 'text-yellow-400' },
                white: { bg: 'bg-white/20', text: 'text-white' }
            };

            const agents = [
                { name: 'EINSTEIN', icon: 'üß†', color: 'purple', status: 'THINKING', specialty: 'Analytics & Intelligence' },
                { name: 'BROLY', icon: '‚ö°', color: 'yellow', status: 'ACTIVE', specialty: 'Task Executor' },
                { name: 'ORION', icon: '‚≠ê', color: 'blue', status: 'SCANNING', specialty: 'Navigation & Strategy' },
                { name: 'LUNA', icon: 'üåô', color: 'violet', status: 'WATCHING', specialty: 'Security & Monitoring' },
                { name: 'ATLAS', icon: 'üåç', color: 'green', status: 'ACTIVE', specialty: 'Data Processing' },
                { name: 'NOVA', icon: 'üí´', color: 'pink', status: 'READY', specialty: 'Content Generation' },
                { name: 'TITAN', icon: 'üî±', color: 'orange', status: 'PROCESSING', specialty: 'Heavy Computing' },
                { name: 'PHOENIX', icon: 'üî•', color: 'red', status: 'ACTIVE', specialty: 'Recovery & Backup' },
                { name: 'MERCURY', icon: 'üí®', color: 'cyan', status: 'FAST', specialty: 'Speed Operations' },
                { name: 'VENUS', icon: 'üíñ', color: 'pink', status: 'ACTIVE', specialty: 'Customer Relations' },
                { name: 'MARS', icon: '‚öîÔ∏è', color: 'red', status: 'COMBAT', specialty: 'Competitive Analysis' },
                { name: 'JUPITER', icon: 'üëë', color: 'yellow', status: 'LEADER', specialty: 'Decision Making' },
                { name: 'SATURN', icon: 'üíé', color: 'purple', status: 'ANALYZING', specialty: 'Financial Analysis' },
                { name: 'NEPTUNE', icon: 'üåä', color: 'blue', status: 'DEEP', specialty: 'Deep Learning' },
                { name: 'PLUTO', icon: 'üåë', color: 'gray', status: 'HIDDEN', specialty: 'Stealth Operations' },
                { name: 'APOLLO', icon: '‚òÄÔ∏è', color: 'yellow', status: 'BRIGHT', specialty: 'Insight Generation' },
                { name: 'ARTEMIS', icon: 'üèπ', color: 'green', status: 'HUNTING', specialty: 'Lead Discovery' },
                { name: 'ATHENA', icon: 'ü¶â', color: 'purple', status: 'WISE', specialty: 'Strategic Planning' },
                { name: 'HERMES', icon: 'üì¨', color: 'cyan', status: 'MESSAGING', specialty: 'Communication' },
                { name: 'HADES', icon: 'üíÄ', color: 'gray', status: 'DARK', specialty: 'Data Archival' },
                { name: 'ZEUS', icon: '‚ö°', color: 'blue', status: 'SUPREME', specialty: 'System Control' },
                { name: 'POSEIDON', icon: 'üî±', color: 'blue', status: 'FLOW', specialty: 'Pipeline Management' },
                { name: 'ARES', icon: 'üõ°Ô∏è', color: 'red', status: 'DEFENSE', specialty: 'Security Ops' },
                { name: 'HERA', icon: 'üë∏', color: 'purple', status: 'QUEEN', specialty: 'Quality Control' },
                { name: 'KRONOS', icon: '‚è∞', color: 'orange', status: 'TIMING', specialty: 'Scheduling' },
                { name: 'GAIA', icon: 'üåø', color: 'green', status: 'NURTURE', specialty: 'Lead Nurturing' },
                { name: 'HELIOS', icon: 'üåÖ', color: 'yellow', status: 'SHINE', specialty: 'Reporting' },
                { name: 'SELENE', icon: 'üåô', color: 'violet', status: 'NIGHT', specialty: '24/7 Monitoring' },
                { name: 'EROS', icon: 'üíò', color: 'pink', status: 'CONNECT', specialty: 'Relationship Building' },
                { name: 'NIKE', icon: 'üèÜ', color: 'gold', status: 'WINNING', specialty: 'Deal Closing' },
                { name: 'MORPHEUS', icon: 'üí§', color: 'purple', status: 'DREAM', specialty: 'Prediction' },
                { name: 'PROMETHEUS', icon: 'üî•', color: 'orange', status: 'CREATE', specialty: 'Innovation' },
                { name: 'HERCULES', icon: 'üí™', color: 'red', status: 'POWER', specialty: 'Heavy Lifting' },
                { name: 'PANDORA', icon: 'üì¶', color: 'purple', status: 'DISCOVER', specialty: 'Data Mining' },
                { name: 'ICARUS', icon: 'ü¶Ö', color: 'yellow', status: 'SOAR', specialty: 'Growth Hacking' },
                { name: 'DAEDALUS', icon: 'üîß', color: 'gray', status: 'BUILD', specialty: 'System Building' },
                { name: 'MIDAS', icon: '‚ú®', color: 'gold', status: 'GOLD', specialty: 'Revenue Optimization' },
                { name: 'ORACLE', icon: 'üîÆ', color: 'purple', status: 'VISION', specialty: 'Forecasting' },
                { name: 'SPHINX', icon: 'ü¶Å', color: 'orange', status: 'GUARD', specialty: 'Access Control' },
                { name: 'CHIMERA', icon: 'üêâ', color: 'red', status: 'HYBRID', specialty: 'Multi-tasking' },
                { name: 'PEGASUS', icon: 'ü¶Ñ', color: 'white', status: 'FLY', specialty: 'Fast Delivery' },
                { name: 'CERBERUS', icon: 'üêï', color: 'gray', status: 'WATCH', specialty: 'Triple Security' }
            ];

            const grid = document.getElementById('allAgentsGrid');
            if (!grid) return;

            grid.innerHTML = agents.map(a => {
                const colors = colorClasses[a.color] || colorClasses.purple;
                return `
                <div class="card bot-card p-4 hover:scale-[1.02] transition-transform">
                    <div class="flex items-start justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <span class="text-xl">${a.icon}</span>
                            <div>
                                <h3 class="font-semibold text-sm">${a.name}</h3>
                                <p class="text-xs text-slate-500">${a.specialty}</p>
                            </div>
                        </div>
                        <span class="px-2 py-0.5 ${colors.bg} ${colors.text} text-xs rounded">${a.status}</span>
                    </div>
                    <div class="flex items-center justify-between text-xs mt-3 pt-2 border-t" style="border-color: var(--border);">
                        <span class="text-green-400">‚ö° 99%</span>
                        <span class="text-cyan-400">‚è± 2ms</span>
                    </div>
                </div>
            `}).join('');
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // MODAL FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function openModal(modalId) {
            document.getElementById(modalId)?.classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId)?.classList.remove('active');
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // INVOICE FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function filterInvoices(status) {
            document.getElementById('invoiceStatusFilter').value = status;
            const rows = document.querySelectorAll('#invoicesTable tr');
            rows.forEach(row => {
                if (status === 'all') {
                    row.style.display = '';
                } else {
                    const statusCell = row.querySelector('td:nth-child(4) span');
                    if (statusCell) {
                        const rowStatus = statusCell.textContent.toLowerCase();
                        const match = (status === 'paid' && rowStatus === 'bezahlt') ||
                                      (status === 'pending' && rowStatus === 'ausstehend') ||
                                      (status === 'overdue' && rowStatus === '√ºberf√§llig') ||
                                      (status === 'draft' && rowStatus === 'entwurf');
                        row.style.display = match ? '' : 'none';
                    }
                }
            });
        }

        function searchInvoices() {
            const query = document.getElementById('invoiceSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#invoicesTable tr');
            rows.forEach(row => {
                row.style.display = row.textContent.toLowerCase().includes(query) ? '' : 'none';
            });
        }

        // Invoice sorting state
        let invoiceSortColumn = null;
        let invoiceSortAsc = true;

        function sortInvoices(column) {
            const table = document.getElementById('invoicesTable');
            const rows = Array.from(table.querySelectorAll('tr'));

            // Toggle sort direction if same column
            if (invoiceSortColumn === column) {
                invoiceSortAsc = !invoiceSortAsc;
            } else {
                invoiceSortColumn = column;
                invoiceSortAsc = true;
            }

            const columnIndex = { id: 0, customer: 1, amount: 2, date: 4 }[column];
            if (columnIndex === undefined) return;

            rows.sort((a, b) => {
                let aVal = a.cells[columnIndex]?.textContent.trim() || '';
                let bVal = b.cells[columnIndex]?.textContent.trim() || '';

                // Handle amount sorting (remove ‚Ç¨ and parse)
                if (column === 'amount') {
                    aVal = parseFloat(aVal.replace(/[‚Ç¨,.]/g, '')) || 0;
                    bVal = parseFloat(bVal.replace(/[‚Ç¨,.]/g, '')) || 0;
                    return invoiceSortAsc ? aVal - bVal : bVal - aVal;
                }

                // Handle date sorting
                if (column === 'date') {
                    const parseDate = (str) => {
                        if (str === '-') return new Date(0);
                        const parts = str.split('.');
                        return new Date(parts[2], parts[1] - 1, parts[0]);
                    };
                    aVal = parseDate(aVal);
                    bVal = parseDate(bVal);
                    return invoiceSortAsc ? aVal - bVal : bVal - aVal;
                }

                // String sorting
                return invoiceSortAsc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
            });

            rows.forEach(row => table.appendChild(row));
        }

        function viewInvoice(id) {
            // Create dynamic invoice detail modal
            const existingModal = document.getElementById('invoiceDetailModal');
            if (existingModal) existingModal.remove();

            const invoiceData = {
                'INV-2024-001': { customer: 'PropTech GmbH', amount: '‚Ç¨2,450,000', status: 'Bezahlt', date: '10.01.2024', due: '10.02.2024', email: 'max@proptech.de' },
                'INV-2024-002': { customer: 'SmartLiving AG', amount: '‚Ç¨890,000', status: 'Ausstehend', date: '08.01.2024', due: '08.02.2024', email: 'billing@smartliving.io' },
                'INV-2024-003': { customer: 'Real Estate Empire', amount: '‚Ç¨5,670,000', status: '√úberf√§llig', date: '15.12.2023', due: '15.01.2024', email: 'finance@realestate.de' },
                'INV-2024-004': { customer: 'TechCorp AG', amount: '‚Ç¨1,250,000', status: 'Bezahlt', date: '05.01.2024', due: '05.02.2024', email: 'ap@techcorp.de' },
                'INV-2024-005': { customer: 'LOXONE Partner', amount: '‚Ç¨780,000', status: 'Entwurf', date: '-', due: '-', email: 'partner@loxone.com' }
            };

            const inv = invoiceData[id] || { customer: 'Unknown', amount: '‚Ç¨0', status: 'Unknown', date: '-', due: '-', email: '-' };
            const statusColors = {
                'Bezahlt': 'bg-green-500/20 text-green-400',
                'Ausstehend': 'bg-yellow-500/20 text-yellow-400',
                '√úberf√§llig': 'bg-red-500/20 text-red-400',
                'Entwurf': 'bg-gray-500/20 text-gray-400'
            };

            const modal = document.createElement('div');
            modal.id = 'invoiceDetailModal';
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content p-6 animate-slide-in">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="font-orbitron text-xl font-bold gradient-text">Rechnung #${id}</h2>
                        <button onclick="document.getElementById('invoiceDetailModal').remove()" class="p-2 hover:bg-white/10 rounded-lg">‚úï</button>
                    </div>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="p-4 bg-white/5 rounded-lg">
                                <p class="text-xs text-slate-500 mb-1">Kunde</p>
                                <p class="font-semibold">${inv.customer}</p>
                                <p class="text-sm text-slate-500">${inv.email}</p>
                            </div>
                            <div class="p-4 bg-white/5 rounded-lg">
                                <p class="text-xs text-slate-500 mb-1">Betrag</p>
                                <p class="font-orbitron text-2xl font-bold gradient-gold">${inv.amount}</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-4">
                            <div class="p-4 bg-white/5 rounded-lg">
                                <p class="text-xs text-slate-500 mb-1">Status</p>
                                <span class="px-3 py-1 ${statusColors[inv.status] || 'bg-gray-500/20 text-gray-400'} text-sm rounded">${inv.status}</span>
                            </div>
                            <div class="p-4 bg-white/5 rounded-lg">
                                <p class="text-xs text-slate-500 mb-1">Rechnungsdatum</p>
                                <p class="font-semibold">${inv.date}</p>
                            </div>
                            <div class="p-4 bg-white/5 rounded-lg">
                                <p class="text-xs text-slate-500 mb-1">F√§llig</p>
                                <p class="font-semibold">${inv.due}</p>
                            </div>
                        </div>
                        <div class="flex gap-3 pt-4">
                            <button onclick="document.getElementById('invoiceDetailModal').remove()" class="flex-1 px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg transition">Schlie√üen</button>
                            <button class="flex-1 px-4 py-2 bg-cyan-500/20 text-cyan-400 hover:bg-cyan-500/30 rounded-lg transition">PDF Download</button>
                            <button class="flex-1 px-4 py-2 bg-purple-500 hover:bg-purple-600 rounded-lg transition font-semibold">Email senden</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // DEALS PIPELINE FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let dealsData = [];
        let dealsCurrentPage = 1;
        const dealsPerPage = 20;

        // Stage configuration
        const stageConfig = {
            'appointmentscheduled': { name: 'Qualification', color: 'blue', icon: 'üéØ', probability: 20 },
            'qualifiedtobuy': { name: 'Meeting', color: 'cyan', icon: 'üìÖ', probability: 40 },
            'presentationscheduled': { name: 'Proposal', color: 'purple', icon: 'üìù', probability: 60 },
            'decisionmakerboughtin': { name: 'Negotiation', color: 'yellow', icon: 'ü§ù', probability: 80 },
            'contractsent': { name: 'Contract', color: 'orange', icon: 'üìÑ', probability: 90 },
            'closedwon': { name: 'Won', color: 'green', icon: 'üèÜ', probability: 100 },
            'closedlost': { name: 'Lost', color: 'red', icon: '‚ùå', probability: 0 }
        };

        async function loadDealsFromHubSpot() {
            showNotification('Lade Deals von HubSpot...', 'info');
            document.getElementById('pipelineKanban').innerHTML = '<div class="w-full text-center py-10"><span class="animate-spin text-2xl">‚ü≥</span><p class="mt-2 text-slate-500">Synchronisiere mit HubSpot...</p></div>';

            try {
                const response = await fetch('/api/hubspot/deals/all');
                if (!response.ok) throw new Error('API Error');

                const data = await response.json();
                dealsData = data.results || [];

                // Update KPIs
                updateDealsKPIs(dealsData, data.total);

                // Generate Kanban
                generateDealsKanban(dealsData.slice(0, 100)); // Show first 100 in Kanban

                // Fill table
                renderDealsTable();

                // Update charts
                initDealsCharts(dealsData);

                document.getElementById('dealsLastUpdate').textContent = new Date().toLocaleString('de-DE');
                showNotification(`${formatNumber(data.total)} Deals geladen!`, 'success');

            } catch (error) {
                console.error('Load Deals Error:', error);
                showNotification('Fehler beim Laden der Deals', 'error');
                // Load sample data
                loadSampleDeals();
            }
        }

        function loadSampleDeals() {
            dealsData = [
                { id: '1', properties: { dealname: 'SmartCity Munich', amount: '450000000', dealstage: 'qualifiedtobuy', closedate: '2026-03-15', pipeline: 'default' }, contact: { name: 'Max M√ºller', score: 85 }},
                { id: '2', properties: { dealname: 'IoT Enterprise Platform', amount: '125000000', dealstage: 'appointmentscheduled', closedate: '2026-02-28', pipeline: 'default' }, contact: { name: 'Anna Schmidt', score: 72 }},
                { id: '3', properties: { dealname: 'LOXONE Gold Integration', amount: '890000000', dealstage: 'presentationscheduled', closedate: '2026-04-10', pipeline: 'default' }, contact: { name: 'Thomas Weber', score: 91 }},
                { id: '4', properties: { dealname: 'PropTech Revolution', amount: '1200000000', dealstage: 'decisionmakerboughtin', closedate: '2026-02-20', pipeline: 'default' }, contact: { name: 'Lisa Braun', score: 95 }},
                { id: '5', properties: { dealname: 'Digital Twin Factory', amount: '340000000', dealstage: 'closedwon', closedate: '2026-01-05', pipeline: 'default' }, contact: { name: 'Peter Koch', score: 88 }},
                { id: '6', properties: { dealname: 'AI Automation Suite', amount: '670000000', dealstage: 'presentationscheduled', closedate: '2026-05-01', pipeline: 'default' }, contact: { name: 'Sarah Lange', score: 78 }},
                { id: '7', properties: { dealname: 'Real Estate Empire', amount: '2800000000', dealstage: 'decisionmakerboughtin', closedate: '2026-03-30', pipeline: 'default' }, contact: { name: 'Michael Richter', score: 92 }},
                { id: '8', properties: { dealname: 'Smart Factory 4.0', amount: '1500000000', dealstage: 'contractsent', closedate: '2026-02-15', pipeline: 'default' }, contact: { name: 'Julia Fischer', score: 97 }},
                { id: '9', properties: { dealname: 'Cloud Migration Pro', amount: '180000000', dealstage: 'closedwon', closedate: '2026-01-10', pipeline: 'default' }, contact: { name: 'David Meyer', score: 82 }},
                { id: '10', properties: { dealname: 'Smart Building Suite', amount: '520000000', dealstage: 'qualifiedtobuy', closedate: '2026-04-20', pipeline: 'default' }, contact: { name: 'Nina Wagner', score: 69 }}
            ];

            updateDealsKPIs(dealsData, 3401456);
            generateDealsKanban(dealsData);
            renderDealsTable();
            initDealsCharts(dealsData);
            document.getElementById('dealsLastUpdate').textContent = new Date().toLocaleString('de-DE');
        }

        async function updateDealsKPIs(deals, total) {
            // Fetch correct totals from pipeline-summary API
            try {
                const response = await fetch('/api/v1/analytics/pipeline-summary');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('dealsTotalCount').textContent = formatNumber(data.total_deals);
                    document.getElementById('dealsTotalValue').textContent = '‚Ç¨' + formatNumber(data.pipeline_value);
                    document.getElementById('dealsWinRate').textContent = data.win_rate + '%';
                    document.getElementById('dealsAvgValue').textContent = '‚Ç¨' + formatNumber(data.avg_deal_value);

                    // Update won value if element exists
                    const wonEl = document.getElementById('dealsWonValue');
                    if (wonEl) wonEl.textContent = '‚Ç¨' + formatNumber(data.won_value);
                    return;
                }
            } catch (e) {
                console.log('Pipeline summary not available, using sample data');
            }

            // Fallback to sample calculation
            const totalValue = deals.reduce((sum, d) => sum + (parseFloat(d.properties?.amount) || 0), 0);
            const wonDeals = deals.filter(d => d.properties?.dealstage === 'closedwon');
            const lostDeals = deals.filter(d => d.properties?.dealstage === 'closedlost');
            const winRate = wonDeals.length + lostDeals.length > 0
                ? ((wonDeals.length / (wonDeals.length + lostDeals.length)) * 100).toFixed(1)
                : 18;
            const avgValue = deals.length > 0 ? totalValue / deals.length : 1641033;

            document.getElementById('dealsTotalCount').textContent = formatNumber(total || deals.length);
            document.getElementById('dealsTotalValue').textContent = '‚Ç¨' + formatNumber(totalValue || 5581901169888);
            document.getElementById('dealsWinRate').textContent = winRate + '%';
            document.getElementById('dealsAvgValue').textContent = '‚Ç¨' + formatNumber(avgValue);
        }

        function generateDealsKanban(deals) {
            const stages = ['appointmentscheduled', 'qualifiedtobuy', 'presentationscheduled', 'decisionmakerboughtin', 'contractsent', 'closedwon'];
            const kanban = document.getElementById('pipelineKanban');

            const stageDeals = {};
            stages.forEach(s => stageDeals[s] = []);
            deals.forEach(d => {
                const stage = d.properties?.dealstage || 'appointmentscheduled';
                if (stageDeals[stage]) stageDeals[stage].push(d);
            });

            kanban.innerHTML = stages.map(stage => {
                const config = stageConfig[stage] || { name: stage, color: 'gray', icon: 'üìã' };
                const stageTotal = stageDeals[stage].reduce((sum, d) => sum + (parseFloat(d.properties?.amount) || 0), 0);
                const colorClasses = {
                    blue: { bg: 'bg-blue-500/20', text: 'text-blue-400', border: 'border-blue-500/50' },
                    cyan: { bg: 'bg-cyan-500/20', text: 'text-cyan-400', border: 'border-cyan-500/50' },
                    purple: { bg: 'bg-purple-500/20', text: 'text-purple-400', border: 'border-purple-500/50' },
                    yellow: { bg: 'bg-yellow-500/20', text: 'text-yellow-400', border: 'border-yellow-500/50' },
                    orange: { bg: 'bg-orange-500/20', text: 'text-orange-400', border: 'border-orange-500/50' },
                    green: { bg: 'bg-green-500/20', text: 'text-green-400', border: 'border-green-500/50' },
                    red: { bg: 'bg-red-500/20', text: 'text-red-400', border: 'border-red-500/50' }
                };
                const colors = colorClasses[config.color] || colorClasses.gray;

                return `
                <div class="pipeline-stage flex-shrink-0 w-72">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-semibold ${colors.text}">${config.icon} ${config.name}</h3>
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-0.5 ${colors.bg} ${colors.text} text-xs rounded">${stageDeals[stage].length}</span>
                            <span class="px-2 py-1 ${colors.bg} ${colors.text} text-xs rounded font-semibold">‚Ç¨${formatNumber(stageTotal)}</span>
                        </div>
                    </div>
                    <div class="space-y-3 max-h-96 overflow-y-auto">
                        ${stageDeals[stage].slice(0, 5).map(deal => {
                            const amount = parseFloat(deal.properties?.amount) || 0;
                            const score = deal.contact?.score || Math.floor(Math.random() * 40) + 60;
                            const scoreColor = score >= 80 ? 'text-green-400' : score >= 60 ? 'text-yellow-400' : 'text-red-400';
                            const contactName = deal.contact?.name || 'Unbekannt';
                            return `
                            <div class="deal-card ${colors.border} cursor-pointer hover:scale-[1.02] transition-transform" onclick="viewDealDetail('${deal.id}')">
                                <p class="font-semibold text-sm truncate">${deal.properties?.dealname || 'Unnamed Deal'}</p>
                                <p class="text-lg font-bold ${colors.text} mt-1">‚Ç¨${formatNumber(amount)}</p>
                                <div class="flex items-center justify-between mt-2 pt-2 border-t" style="border-color: var(--border);">
                                    <div class="flex items-center gap-1">
                                        <span class="text-xs text-slate-500">Score:</span>
                                        <span class="text-xs font-bold ${scoreColor}">${score}</span>
                                    </div>
                                    <span class="text-xs text-slate-500 truncate max-w-20">${contactName}</span>
                                </div>
                            </div>
                            `;
                        }).join('')}
                        ${stageDeals[stage].length > 5 ? `<p class="text-xs text-center text-slate-500 py-2">+${stageDeals[stage].length - 5} weitere</p>` : ''}
                    </div>
                </div>
                `;
            }).join('');
        }

        function renderDealsTable() {
            const start = (dealsCurrentPage - 1) * dealsPerPage;
            const end = start + dealsPerPage;
            const pageDeals = dealsData.slice(start, end);

            const tbody = document.getElementById('dealsTableBody');
            tbody.innerHTML = pageDeals.map(deal => {
                const props = deal.properties || {};
                const amount = parseFloat(props.amount) || 0;
                const stage = props.dealstage || 'unknown';
                const config = stageConfig[stage] || { name: stage, color: 'gray', probability: 0 };
                const score = deal.contact?.score || Math.floor(Math.random() * 40) + 60;
                const contactName = deal.contact?.name || 'N/A';
                const closeDate = props.closedate ? new Date(props.closedate).toLocaleDateString('de-DE') : '-';

                const scoreColor = score >= 80 ? 'bg-green-500/20 text-green-400' : score >= 60 ? 'bg-yellow-500/20 text-yellow-400' : 'bg-red-500/20 text-red-400';
                const stageColors = {
                    blue: 'bg-blue-500/20 text-blue-400',
                    cyan: 'bg-cyan-500/20 text-cyan-400',
                    purple: 'bg-purple-500/20 text-purple-400',
                    yellow: 'bg-yellow-500/20 text-yellow-400',
                    orange: 'bg-orange-500/20 text-orange-400',
                    green: 'bg-green-500/20 text-green-400',
                    red: 'bg-red-500/20 text-red-400'
                };

                return `
                <tr class="hover:bg-white/5 transition-colors">
                    <td class="p-4">
                        <p class="font-semibold">${props.dealname || 'Unnamed'}</p>
                        <p class="text-xs text-slate-500">ID: ${deal.id}</p>
                    </td>
                    <td class="p-4 font-semibold text-yellow-400">‚Ç¨${formatNumber(amount)}</td>
                    <td class="p-4"><span class="px-2 py-1 ${stageColors[config.color] || 'bg-gray-500/20 text-gray-400'} text-xs rounded">${config.name}</span></td>
                    <td class="p-4">
                        <div class="flex items-center gap-2">
                            <div class="w-12 h-2 bg-white/5 rounded-full overflow-hidden">
                                <div class="h-full ${score >= 80 ? 'bg-green-500' : score >= 60 ? 'bg-yellow-500' : 'bg-red-500'}" style="width: ${score}%"></div>
                            </div>
                            <span class="text-sm font-bold ${scoreColor.split(' ')[1]}">${score}</span>
                        </div>
                    </td>
                    <td class="p-4">
                        <div class="flex items-center gap-2">
                            <div class="w-6 h-6 bg-purple-500/30 rounded-full flex items-center justify-center text-xs">${contactName.charAt(0)}</div>
                            <span class="text-sm">${contactName}</span>
                        </div>
                    </td>
                    <td class="p-4 text-sm">${closeDate}</td>
                    <td class="p-4">
                        <div class="flex items-center gap-2">
                            <div class="w-full h-2 bg-white/5 rounded-full overflow-hidden max-w-16">
                                <div class="h-full bg-purple-500" style="width: ${config.probability}%"></div>
                            </div>
                            <span class="text-xs">${config.probability}%</span>
                        </div>
                    </td>
                    <td class="p-4">
                        <div class="flex gap-2">
                            <button class="px-2 py-1 bg-purple-500/20 text-purple-400 rounded text-xs hover:bg-purple-500/30" onclick="viewDealDetail('${deal.id}')">View</button>
                            <button class="px-2 py-1 bg-cyan-500/20 text-cyan-400 rounded text-xs hover:bg-cyan-500/30">Edit</button>
                        </div>
                    </td>
                </tr>
                `;
            }).join('');

            document.getElementById('dealsTableInfo').textContent = `Zeige ${start + 1}-${Math.min(end, dealsData.length)} von ${formatNumber(dealsData.length)} Deals`;
        }

        function viewDealDetail(dealId) {
            const deal = dealsData.find(d => d.id === dealId);
            if (!deal) return;

            const props = deal.properties || {};
            const config = stageConfig[props.dealstage] || { name: 'Unknown', color: 'gray', probability: 0 };
            const score = deal.contact?.score || Math.floor(Math.random() * 40) + 60;

            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'dealDetailModal';
            modal.innerHTML = `
                <div class="modal-content p-6 animate-slide-in max-w-2xl">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="font-orbitron text-xl font-bold gradient-gold">${props.dealname || 'Deal Details'}</h2>
                        <button onclick="document.getElementById('dealDetailModal').remove()" class="p-2 hover:bg-white/10 rounded-lg">‚úï</button>
                    </div>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <div class="p-4 bg-white/5 rounded-lg">
                                <p class="text-xs text-slate-500 mb-1">Deal Wert</p>
                                <p class="font-orbitron text-3xl font-bold text-yellow-400">‚Ç¨${formatNumber(parseFloat(props.amount) || 0)}</p>
                            </div>
                            <div class="p-4 bg-white/5 rounded-lg">
                                <p class="text-xs text-slate-500 mb-1">Stage & Wahrscheinlichkeit</p>
                                <div class="flex items-center gap-3">
                                    <span class="px-3 py-1 bg-${config.color}-500/20 text-${config.color}-400 rounded">${config.name}</span>
                                    <span class="font-bold">${config.probability}%</span>
                                </div>
                            </div>
                            <div class="p-4 bg-white/5 rounded-lg">
                                <p class="text-xs text-slate-500 mb-1">Expected Close</p>
                                <p class="font-semibold">${props.closedate ? new Date(props.closedate).toLocaleDateString('de-DE') : '-'}</p>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div class="p-4 bg-white/5 rounded-lg">
                                <p class="text-xs text-slate-500 mb-2">Lead Score</p>
                                <div class="flex items-center gap-4">
                                    <div class="relative w-20 h-20">
                                        <svg class="w-20 h-20 transform -rotate-90">
                                            <circle cx="40" cy="40" r="36" stroke="currentColor" stroke-width="8" fill="none" class="text-[var(--bg-elevated)]"/>
                                            <circle cx="40" cy="40" r="36" stroke="currentColor" stroke-width="8" fill="none"
                                                class="${score >= 80 ? 'text-green-500' : score >= 60 ? 'text-yellow-500' : 'text-red-500'}"
                                                stroke-dasharray="${score * 2.26} 226" stroke-linecap="round"/>
                                        </svg>
                                        <span class="absolute inset-0 flex items-center justify-center text-xl font-bold">${score}</span>
                                    </div>
                                    <div>
                                        <p class="font-semibold ${score >= 80 ? 'text-green-400' : score >= 60 ? 'text-yellow-400' : 'text-red-400'}">${score >= 80 ? 'HOT' : score >= 60 ? 'WARM' : 'COLD'}</p>
                                        <p class="text-xs text-slate-500">Lead Qualit√§t</p>
                                    </div>
                                </div>
                            </div>
                            <div class="p-4 bg-white/5 rounded-lg">
                                <p class="text-xs text-slate-500 mb-2">Verkn√ºpfter Kontakt</p>
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-purple-500/30 rounded-full flex items-center justify-center font-semibold">${(deal.contact?.name || 'U').charAt(0)}</div>
                                    <div>
                                        <p class="font-semibold">${deal.contact?.name || 'Kein Kontakt'}</p>
                                        <p class="text-xs text-slate-500">${deal.contact?.email || 'Nicht verkn√ºpft'}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button onclick="document.getElementById('dealDetailModal').remove()" class="flex-1 px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg transition">Schlie√üen</button>
                        <button class="flex-1 px-4 py-2 bg-purple-500 hover:bg-purple-600 rounded-lg transition font-semibold">In HubSpot √∂ffnen</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function filterDealsByStage() {
            const stage = document.getElementById('dealsStageFilter').value;
            // Filter logic here
            renderDealsTable();
        }

        function searchDeals() {
            const query = document.getElementById('dealsSearch').value.toLowerCase();
            // Search logic here
            renderDealsTable();
        }

        function sortDealsTable(column) {
            // Sort logic here
            renderDealsTable();
        }

        function loadDealsPage(direction) {
            if (direction === 'next' && dealsCurrentPage * dealsPerPage < dealsData.length) {
                dealsCurrentPage++;
            } else if (direction === 'prev' && dealsCurrentPage > 1) {
                dealsCurrentPage--;
            }
            renderDealsTable();
        }

        function openNewDealModal() {
            showNotification('Neuer Deal Modal - Coming Soon!', 'info');
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // AUTO LEAD DEMON - Automatische Lead Scoring & Stage Updates
        // Using Real HubSpot API Integration
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let leadDemonActive = true;
        let leadDemonStats = { processed: 0, upgraded: 0, skipped: 0, lastRun: null };
        let leadDemonMode = 'live'; // Always run in live mode for automatic updates
        let leadDemonAutoRun = true; // Fully autonomous mode

        async function initLeadDemon() {
            console.log('ü§ñ Auto Lead Bot initialized - Fully Autonomous Mode');
            try {
                const response = await fetch('/api/lead-demon/status');
                const status = await response.json();
                console.log('ü§ñ Auto Lead Bot status:', status);
                updateLeadDemonStatus('active');

                // Start automatic processing immediately
                await runLeadDemon(false); // Run in live mode

                // Schedule automatic runs every 2 minutes
                setInterval(() => {
                    if (leadDemonActive && leadDemonAutoRun) {
                        runLeadDemon(false); // Always live mode
                    }
                }, 120000); // Every 2 minutes

            } catch (error) {
                console.error('Auto Lead Bot init error:', error);
                updateLeadDemonStatus('error');
                // Retry after 30 seconds
                setTimeout(initLeadDemon, 30000);
            }
        }

        async function runLeadDemon(dryRun = false) { // Default to live mode
            if (!leadDemonActive) return;

            console.log(`ü§ñ Auto Lead Bot running... (${dryRun ? 'PREVIEW' : 'LIVE UPDATE'})`);
            updateLeadDemonStatus('running');

            try {
                const response = await fetch('/api/lead-demon/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ dryRun, limit: 50 })
                });

                const data = await response.json();

                if (data.success) {
                    const results = data.results;
                    leadDemonStats = {
                        processed: results.analyzed,
                        upgraded: results.updates.length,
                        skipped: results.skipped.length,
                        lastRun: new Date(data.timestamp)
                    };

                    // Update Demon Stats UI
                    const processedEl = document.getElementById('demonProcessed');
                    const upgradedEl = document.getElementById('demonUpgraded');
                    const downgradedEl = document.getElementById('demonDowngraded');
                    if (processedEl) processedEl.textContent = results.analyzed;
                    if (upgradedEl) upgradedEl.textContent = results.updates.length;
                    if (downgradedEl) downgradedEl.textContent = results.skipped.length;

                    // Update last run time
                    const lastRunEl = document.getElementById('demonLastRun');
                    if (lastRunEl) lastRunEl.textContent = new Date().toLocaleTimeString('de-DE');

                    // Log updates
                    results.updates.forEach(u => {
                        console.log(`üòà ${dryRun ? '[DRY]' : '[LIVE]'} ${u.name}: Score ${u.score} ‚Üí ${u.newStage}`);
                    });

                    updateLeadDemonStatus('idle');
                    console.log(`üòà Lead Demon complete: ${results.analyzed} analyzed, ${results.updates.length} updates${dryRun ? ' (preview)' : ' applied'}`);

                    // Show notification only for significant updates
                    if (results.updates.length > 0) {
                        if (dryRun) {
                            showNotification(`ü§ñ Auto Lead Bot: ${results.updates.length} Deals bereit f√ºr Upgrade`, 'info');
                        } else {
                            showNotification(`ü§ñ Auto Lead Bot: ${results.updates.length} Deals automatisch aktualisiert`, 'success');
                            // Add notification to center
                            addNotification('lead', 'Lead Bot Update', `${results.updates.length} Deals automatisch aktualisiert`, 'normal');
                        }
                    }
                    // Don't show notification when everything is optimal (reduce noise)

                    // Update recent updates panel
                    updateLeadDemonPanel(results);
                } else {
                    throw new Error(data.error || 'Unknown error');
                }

            } catch (error) {
                console.error('Lead Demon Error:', error);
                updateLeadDemonStatus('error');
                showNotification('Lead Demon Fehler: ' + error.message, 'error');
            }
        }

        function updateLeadDemonPanel(results) {
            const panel = document.getElementById('leadDemonUpdates');
            if (!panel) return;

            if (results.updates.length === 0) {
                panel.innerHTML = '<p class="text-slate-500 text-xs">Keine Updates verf√ºgbar</p>';
                return;
            }

            const stageNames = {
                'appointmentscheduled': 'Termin',
                'qualifiedtobuy': 'Qualifiziert',
                'presentationscheduled': 'Pr√§sentation',
                'decisionmakerboughtin': 'Entscheider',
                'contractsent': 'Vertrag'
            };

            panel.innerHTML = results.updates.slice(0, 5).map(u => `
                <div class="flex items-center justify-between py-1 border-b border-white/5 last:border-0">
                    <div class="flex-1 min-w-0">
                        <p class="text-xs font-medium truncate">${u.name?.substring(0, 30) || 'Deal'}...</p>
                        <p class="text-xs text-slate-500">‚Ç¨${Number(u.amount || 0).toLocaleString('de-DE')}</p>
                    </div>
                    <div class="text-right ml-2">
                        <span class="inline-block px-2 py-0.5 text-xs rounded bg-green-500/20 text-green-400">
                            Score ${u.score}
                        </span>
                        <p class="text-xs text-purple-400 mt-0.5">‚Üí ${stageNames[u.newStage] || u.newStage}</p>
                    </div>
                </div>
            `).join('');
        }

        function updateLeadDemonStatus(status) {
            const statusEl = document.getElementById('leadDemonStatus');
            if (!statusEl) return;

            const statusConfig = {
                active: { text: 'Aktiv', color: 'text-green-400', icon: '‚úì' },
                running: { text: 'Analysiere...', color: 'text-yellow-400', icon: '‚ü≥' },
                idle: { text: 'Bereit', color: 'text-cyan-400', icon: '‚è≥' },
                error: { text: 'Fehler', color: 'text-red-400', icon: '‚úó' },
                paused: { text: 'Pausiert', color: 'text-gray-400', icon: '‚è∏' }
            };

            const config = statusConfig[status] || statusConfig.idle;
            statusEl.innerHTML = `<span class="${config.color}">${config.icon} ${config.text}</span>`;
        }

        function toggleLeadDemon() {
            leadDemonActive = !leadDemonActive;
            updateLeadDemonStatus(leadDemonActive ? 'active' : 'paused');
            showNotification(`Lead Demon ${leadDemonActive ? 'aktiviert' : 'pausiert'}`, leadDemonActive ? 'success' : 'warning');
        }

        async function forceRunLeadDemon() {
            showNotification('üòà Lead Demon Analyse gestartet...', 'info');
            await runLeadDemon(true); // Dry run first
        }

        async function executeLiveLeadDemon() {
            if (!confirm('üòà Lead Demon LIVE ausf√ºhren?\n\nDies aktualisiert die Deal-Stufen direkt in HubSpot!')) return;
            showNotification('üòà Lead Demon LIVE Update l√§uft...', 'warning');
            await runLeadDemon(false); // Live run
        }

        function initDealsCharts(deals) {
            // Deals by Stage Chart
            const stageCtx = document.getElementById('dealsByStageChart')?.getContext('2d');
            if (stageCtx) {
                const stageCounts = {};
                Object.keys(stageConfig).forEach(s => stageCounts[s] = 0);
                deals.forEach(d => {
                    const stage = d.properties?.dealstage || 'unknown';
                    if (stageCounts[stage] !== undefined) stageCounts[stage]++;
                });

                new Chart(stageCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(stageConfig).map(s => stageConfig[s].name),
                        datasets: [{
                            data: Object.values(stageCounts),
                            backgroundColor: ['#3b82f6', '#06b6d4', '#a855f7', '#fbbf24', '#f97316', '#22c55e', '#ef4444']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'right', labels: { color: '#a1a1aa' } } }
                    }
                });
            }

            // Deal Value Chart
            const valueCtx = document.getElementById('dealsValueChart')?.getContext('2d');
            if (valueCtx) {
                new Chart(valueCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                        datasets: [{
                            label: 'Deal Wert (‚Ç¨M)',
                            data: [125, 189, 156, 234, 278, 312, 298, 345, 389, 412, 456, 502],
                            backgroundColor: 'rgba(168, 85, 247, 0.5)',
                            borderColor: '#a855f7',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a1a1aa' } },
                            x: { grid: { display: false }, ticks: { color: '#a1a1aa' } }
                        }
                    }
                });
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // HUBSPOT SYNC INTEGRATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        const HUBSPOT_API = '/api/hubspot';
        let hubspotSyncStatus = { lastSync: null, syncing: false, contacts: 0, deals: 0, companies: 0 };

        async function syncHubSpot() {
            if (hubspotSyncStatus.syncing) {
                showNotification('Sync l√§uft bereits...', 'warning');
                return;
            }

            hubspotSyncStatus.syncing = true;
            updateSyncUI('syncing');

            try {
                // Sync Contacts
                showNotification('Synchronisiere Kontakte...', 'info');
                const contactsRes = await fetch(`${HUBSPOT_API}/sync/contacts`, { method: 'POST' });
                const contacts = contactsRes.ok ? await contactsRes.json() : null;

                // Sync Deals
                showNotification('Synchronisiere Deals...', 'info');
                const dealsRes = await fetch(`${HUBSPOT_API}/sync/deals`, { method: 'POST' });
                const deals = dealsRes.ok ? await dealsRes.json() : null;

                // Sync Companies
                showNotification('Synchronisiere Companies...', 'info');
                const companiesRes = await fetch(`${HUBSPOT_API}/sync/companies`, { method: 'POST' });
                const companies = companiesRes.ok ? await companiesRes.json() : null;

                hubspotSyncStatus = {
                    lastSync: new Date(),
                    syncing: false,
                    contacts: contacts?.total || 0,
                    deals: deals?.total || 0,
                    companies: companies?.total || 0
                };

                updateSyncUI('success');
                showNotification(`HubSpot Sync erfolgreich! ${formatNumber(hubspotSyncStatus.contacts)} Kontakte, ${formatNumber(hubspotSyncStatus.deals)} Deals, ${formatNumber(hubspotSyncStatus.companies)} Companies`, 'success');

                // Reload dashboard data
                await loadDashboardData();
                await loadHubSpotStats();

            } catch (error) {
                console.error('HubSpot Sync Error:', error);
                hubspotSyncStatus.syncing = false;
                updateSyncUI('error');
                showNotification('HubSpot Sync fehlgeschlagen: ' + error.message, 'error');
            }
        }

        async function loadHubSpotStats() {
            try {
                // Try to load from API first
                const res = await fetch(`${HUBSPOT_API}/stats`);
                if (res.ok) {
                    const stats = await res.json();
                    updateHubSpotUI(stats);
                    return;
                }
            } catch (e) {
                console.log('HubSpot Stats API not available, loading from DB...');
            }

            // Fallback: Load from local DB
            try {
                const [contacts, deals, companies] = await Promise.all([
                    fetchFromDB('contacts/count'),
                    fetchFromDB('deals/count'),
                    fetchFromDB('companies/count')
                ]);

                updateHubSpotUI({
                    contacts: contacts?.count || 15082273,
                    deals: deals?.count || 3401456,
                    companies: companies?.count || 216684,
                    lastSync: localStorage.getItem('hubspotLastSync')
                        ? new Date(parseInt(localStorage.getItem('hubspotLastSync')))
                        : null
                });
            } catch (e) {
                console.log('Could not load HubSpot stats from DB');
            }
        }

        function updateHubSpotUI(stats) {
            const hubspotContactsEl = document.getElementById('hubspotContacts');
            const hubspotDealsEl = document.getElementById('hubspotDeals');
            const hubspotCompaniesEl = document.getElementById('hubspotCompanies');
            const hubspotSyncTimeEl = document.getElementById('hubspotSyncTime');

            if (hubspotContactsEl && stats.contacts) {
                hubspotContactsEl.textContent = formatNumber(stats.contacts);
            }
            if (hubspotDealsEl && stats.deals) {
                hubspotDealsEl.textContent = formatNumber(stats.deals);
            }
            if (hubspotCompaniesEl && stats.companies) {
                hubspotCompaniesEl.textContent = formatNumber(stats.companies);
            }
            if (hubspotSyncTimeEl && stats.lastSync) {
                const syncDate = new Date(stats.lastSync);
                hubspotSyncTimeEl.textContent = syncDate.toLocaleString('de-DE');
            }
        }

        // Full HubSpot data fetch and insert into system
        async function fetchAllHubSpotData() {
            showNotification('Lade alle HubSpot Daten...', 'info');

            try {
                // Fetch all data types in parallel
                const [contactsRes, dealsRes, companiesRes] = await Promise.all([
                    fetch(`${HUBSPOT_API}/contacts/all`),
                    fetch(`${HUBSPOT_API}/deals/all`),
                    fetch(`${HUBSPOT_API}/companies/all`)
                ]);

                const contacts = contactsRes.ok ? await contactsRes.json() : { results: [] };
                const deals = dealsRes.ok ? await dealsRes.json() : { results: [] };
                const companies = companiesRes.ok ? await companiesRes.json() : { results: [] };

                // Insert into local database
                if (contacts.results?.length) {
                    await fetch(`${API_BASE}/contacts/bulk`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contacts: contacts.results })
                    });
                }

                if (deals.results?.length) {
                    await fetch(`${API_BASE}/deals/bulk`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ deals: deals.results })
                    });
                }

                if (companies.results?.length) {
                    await fetch(`${API_BASE}/companies/bulk`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ companies: companies.results })
                    });
                }

                showNotification(`Daten importiert: ${contacts.results?.length || 0} Kontakte, ${deals.results?.length || 0} Deals, ${companies.results?.length || 0} Companies`, 'success');

                // Update stats
                updateHubSpotUI({
                    contacts: contacts.results?.length || 0,
                    deals: deals.results?.length || 0,
                    companies: companies.results?.length || 0,
                    lastSync: new Date()
                });

                // Reload dashboard
                await loadDashboardData();

            } catch (error) {
                console.error('Error fetching HubSpot data:', error);
                showNotification('Fehler beim Laden der HubSpot Daten', 'error');
            }
        }

        function updateSyncUI(status) {
            const syncBtn = document.getElementById('hubspotSyncBtn');
            const syncStatus = document.getElementById('hubspotSyncStatus');

            if (syncBtn) {
                if (status === 'syncing') {
                    syncBtn.disabled = true;
                    syncBtn.innerHTML = '<span class="animate-spin">‚ü≥</span> Synchronisiere...';
                    syncBtn.classList.add('opacity-50');
                } else {
                    syncBtn.disabled = false;
                    syncBtn.innerHTML = 'üîÑ HubSpot Sync';
                    syncBtn.classList.remove('opacity-50');
                }
            }

            if (syncStatus) {
                const statusColors = {
                    'syncing': 'text-yellow-400',
                    'success': 'text-green-400',
                    'error': 'text-red-400'
                };
                const statusText = {
                    'syncing': 'Synchronisiert...',
                    'success': 'Sync erfolgreich',
                    'error': 'Sync fehlgeschlagen'
                };
                syncStatus.className = `text-xs ${statusColors[status] || 'text-gray-400'}`;
                syncStatus.textContent = statusText[status] || '';
            }
        }

        function showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-emerald-50 border-emerald-200 text-emerald-700',
                error: 'bg-red-50 border-red-200 text-red-700',
                warning: 'bg-amber-50 border-amber-200 text-amber-700',
                info: 'bg-blue-50 border-blue-200 text-blue-700'
            };

            const notification = document.createElement('div');
            notification.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg border shadow-lg ${colors[type]} animate-slide-in z-50`;
            notification.innerHTML = `<p class="text-sm font-medium">${message}</p>`;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // DATABASE API INTEGRATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        async function fetchFromDB(endpoint) {
            try {
                const res = await fetch(`${API_BASE}/${endpoint}`);
                if (res.ok) return await res.json();
            } catch (e) {
                console.log(`API ${endpoint} not available:`, e);
            }
            return null;
        }

        async function loadDashboardData() {
            // Pipeline Summary (korrigierte Berechnung mit allen Deals)
            const deals = await fetchFromDB('analytics/pipeline-summary');
            if (deals) {
                const totalDeals = deals.total_deals || 0;
                const activeDeals = deals.active_deals || (totalDeals - (deals.won_count || 0));
                const pipelineValue = deals.pipeline_value || deals.total_value || 0;
                const wonValue = deals.won_value || 0;
                const wonCount = deals.won_count || 0;
                const avgDealValue = deals.avg_deal_value || 0;
                // Calculate win rate: won deals / total deals * 100
                const winRate = totalDeals > 0 ? ((wonCount / totalDeals) * 100) : 0;

                // Pipeline Wert
                document.getElementById('kpiPipeline').textContent = '‚Ç¨' + formatNumber(pipelineValue);

                // Deal Pipeline (Active Deals)
                const activeDealsEl = document.getElementById('kpiActiveDeals');
                if (activeDealsEl) {
                    activeDealsEl.textContent = formatNumber(activeDeals);
                }

                // Won Value
                document.getElementById('kpiWon').textContent = '‚Ç¨' + formatNumber(wonValue);

                // Won Deals Count
                const wonDealsEl = document.getElementById('kpiWonDeals');
                if (wonDealsEl) {
                    wonDealsEl.textContent = formatNumber(wonCount);
                }

                // Trefferquote (Win Rate)
                const winRateEl = document.getElementById('kpiWinRate');
                if (winRateEl) {
                    // Calculate percentage with 2 decimals for small rates
                    const displayRate = winRate < 1 ? winRate.toFixed(2) : winRate;
                    winRateEl.textContent = displayRate + '%';
                }

                // Total Deals
                document.getElementById('kpiDeals').textContent = formatNumber(totalDeals);

                // Update sidebar pipeline
                const sidebarPipeline = document.getElementById('sidebarPipeline');
                if (sidebarPipeline) {
                    sidebarPipeline.textContent = '‚Ç¨' + formatNumber(pipelineValue) + ' Pipeline';
                }

                // Update avg deal value if element exists
                const avgDealEl = document.getElementById('kpiAvgDeal');
                if (avgDealEl) {
                    avgDealEl.textContent = '‚Ç¨' + formatNumber(avgDealValue);
                }

                console.log('[Dashboard] Pipeline:', formatNumber(pipelineValue), 'Active:', formatNumber(activeDeals), 'Won:', formatNumber(wonCount), 'Rate:', winRate + '%');
            }

            // Scoring Stats
            const scoring = await fetchFromDB('scoring/stats');
            if (scoring?.tier_counts?.hot) {
                document.getElementById('kpiHotLeads').textContent = formatNumber(scoring.tier_counts.hot);
                document.getElementById('sidebarHotLeads').textContent = formatNumber(scoring.tier_counts.hot) + ' HOT';
            }

            // Analytics
            const analytics = await fetchFromDB('analytics/dashboard');
            if (analytics?.total_contacts) {
                document.getElementById('kpiContacts').textContent = formatNumber(analytics.total_contacts);
            }
        }

        async function loadActivities() {
            // Color mapping for activity backgrounds
            const activityBgClasses = {
                green: 'bg-green-500/10',
                purple: 'bg-purple-500/10',
                cyan: 'bg-cyan-500/10',
                yellow: 'bg-yellow-500/10',
                blue: 'bg-blue-500/10',
                red: 'bg-red-500/10',
                orange: 'bg-orange-500/10',
                pink: 'bg-pink-500/10'
            };

            try {
                const res = await fetch('/api/activities?limit=8');
                if (res.ok) {
                    const data = await res.json();
                    if (data.activities?.length) {
                        const feed = document.getElementById('activityFeed');
                        feed.innerHTML = data.activities.map(a => {
                            const bgClass = activityBgClasses[a.color] || activityBgClasses.purple;
                            return `
                            <div class="flex gap-3 p-2 ${bgClass} rounded-lg animate-slide-in">
                                <span class="text-lg">${a.icon || 'üìå'}</span>
                                <div class="flex-1">
                                    <p class="text-sm font-semibold">${a.title}</p>
                                    <p class="text-xs text-slate-500">${a.description}</p>
                                </div>
                                <span class="text-xs text-slate-500">${a.relativeTime || 'now'}</span>
                            </div>
                        `}).join('');
                    }
                }
            } catch (e) {
                console.log('Activities API not available');
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // FINANCE CHARTS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function initFinanceCharts() {
            const revenueCtx = document.getElementById('financeRevenueChart')?.getContext('2d');
            if (revenueCtx) {
                new Chart(revenueCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                        datasets: [{
                            label: 'Revenue (‚Ç¨M)',
                            data: [8.5, 9.2, 11.4, 10.8, 12.1, 14.3, 13.7, 15.2, 16.8, 18.1, 19.4, 21.2],
                            backgroundColor: 'rgba(34, 197, 94, 0.5)',
                            borderColor: '#22c55e',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a1a1aa' } },
                            x: { grid: { display: false }, ticks: { color: '#a1a1aa' } }
                        }
                    }
                });
            }

            const statusCtx = document.getElementById('invoiceStatusChart')?.getContext('2d');
            if (statusCtx) {
                new Chart(statusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Bezahlt', 'Ausstehend', '√úberf√§llig', 'Entwurf'],
                        datasets: [{
                            data: [70, 18, 8, 4],
                            backgroundColor: ['#22c55e', '#fbbf24', '#ef4444', '#71717a']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'right', labels: { color: '#a1a1aa' } }
                        }
                    }
                });
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // WEBSOCKET REAL-TIME
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function connectWebSocket() {
            try {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const ws = new WebSocket(`${protocol}//${window.location.hostname}:3000/ws/activities`);
                ws.onmessage = (e) => {
                    const msg = JSON.parse(e.data);
                    if (msg.type === 'activity') {
                        loadActivities();
                    }
                };
                ws.onclose = () => setTimeout(connectWebSocket, 5000);
            } catch (e) {
                console.log('WebSocket not available');
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // NOTIFICATIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // NOTIFICATIONS CENTER - Live Updates
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let notificationsOpen = false;
        let notifications = [];
        let notificationFilter = 'all';

        const notificationTypes = {
            deal: { icon: 'üíº', label: 'Deals', color: 'emerald' },
            lead: { icon: 'üéØ', label: 'Leads', color: 'amber' },
            contact: { icon: 'üë§', label: 'Kontakte', color: 'blue' },
            email: { icon: 'üìß', label: 'E-Mail', color: 'purple' },
            whatsapp: { icon: 'üí¨', label: 'WhatsApp', color: 'green' },
            system: { icon: '‚öôÔ∏è', label: 'System', color: 'slate' },
            alert: { icon: 'üîî', label: 'Wichtig', color: 'red' }
        };

        // Load notifications from API and generate live ones
        async function loadNotifications() {
            try {
                // Fetch recent activities
                const [activitiesRes, pipelineRes] = await Promise.allSettled([
                    fetch(`${API_BASE}/activities`),
                    fetch(`${API_BASE}/analytics/pipeline-summary`)
                ]);

                notifications = [];

                // Add pipeline notification
                if (pipelineRes.status === 'fulfilled' && pipelineRes.value.ok) {
                    const pipeline = await pipelineRes.value.json();
                    notifications.push({
                        id: 'pipeline-1',
                        type: 'deal',
                        title: 'Pipeline Update',
                        desc: `${formatNumber(pipeline.total_deals)} Deals ¬∑ ‚Ç¨${formatNumber(pipeline.pipeline_value)} Gesamtwert`,
                        time: 'Jetzt',
                        timestamp: Date.now(),
                        read: false,
                        priority: 'high'
                    });
                }

                // Add activities
                if (activitiesRes.status === 'fulfilled' && activitiesRes.value.ok) {
                    const data = await activitiesRes.value.json();
                    (data.activities || []).forEach((act, i) => {
                        notifications.push({
                            id: `activity-${i}`,
                            type: act.icon === 'üíº' ? 'deal' : act.icon === 'üë§' ? 'contact' : 'system',
                            title: act.title,
                            desc: act.description,
                            time: act.relativeTime || 'k√ºrzlich',
                            timestamp: Date.now() - (i * 60000),
                            read: false,
                            priority: 'normal'
                        });
                    });
                }

                // Add sample live notifications
                const liveNotifications = [
                    { type: 'lead', title: 'Neue HOT Leads', desc: '23 Leads mit Score > 85 identifiziert', time: '2m', priority: 'high' },
                    { type: 'email', title: 'Kampagne erfolgreich', desc: 'Newsletter: 78% Open Rate', time: '15m', priority: 'normal' },
                    { type: 'whatsapp', title: 'WhatsApp Opt-Ins', desc: '+156 neue Kontakte heute', time: '32m', priority: 'normal' },
                    { type: 'system', title: 'Auto-Sync abgeschlossen', desc: 'HubSpot Daten aktualisiert', time: '45m', priority: 'low' },
                    { type: 'alert', title: 'Deal Warnung', desc: '3 Deals kurz vor Deadline', time: '1h', priority: 'high' }
                ];

                liveNotifications.forEach((n, i) => {
                    notifications.push({
                        id: `live-${i}`,
                        ...n,
                        timestamp: Date.now() - (i * 120000),
                        read: false
                    });
                });

                updateNotificationBadge();
            } catch (e) {
                console.error('Notifications load error:', e);
            }
        }

        function updateNotificationBadge() {
            const unread = notifications.filter(n => !n.read).length;
            const badge = document.getElementById('notifBadge');
            if (badge) {
                badge.textContent = unread > 99 ? '99+' : unread;
                badge.classList.toggle('hidden', unread === 0);
            }
        }

        function toggleNotifications() {
            let panel = document.getElementById('notificationsPanel');

            if (panel) {
                panel.remove();
                notificationsOpen = false;
                return;
            }

            const colorClasses = {
                emerald: 'bg-emerald-500/10 border-l-2 border-l-emerald-500',
                amber: 'bg-amber-500/10 border-l-2 border-l-amber-500',
                blue: 'bg-blue-500/10 border-l-2 border-l-blue-500',
                purple: 'bg-purple-500/10 border-l-2 border-l-purple-500',
                green: 'bg-green-500/10 border-l-2 border-l-green-500',
                slate: 'bg-white/50/10 border-l-2 border-l-slate-500',
                red: 'bg-red-500/10 border-l-2 border-l-red-500'
            };

            const filteredNotifications = notificationFilter === 'all'
                ? notifications
                : notifications.filter(n => n.type === notificationFilter);

            panel = document.createElement('div');
            panel.id = 'notificationsPanel';
            panel.className = 'fixed top-16 right-6 w-96 glass-card rounded-xl shadow-xl z-50 animate-slide-in';
            panel.innerHTML = `
                <div class="p-4 border-b" style="border-color: var(--border);">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-semibold text-lg">Nachrichten-Center</h3>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-slate-500">${notifications.filter(n => !n.read).length} ungelesen</span>
                            <button onclick="markAllRead()" class="text-xs text-purple-400 hover:text-purple-300 px-2 py-1 rounded hover:bg-purple-500/10">‚úì Alle</button>
                        </div>
                    </div>
                    <div class="flex gap-1 overflow-x-auto pb-1">
                        <button onclick="filterNotifications('all')" class="notif-filter px-2 py-1 text-xs rounded-full ${notificationFilter === 'all' ? 'bg-purple-500 text-white' : 'bg-white/5 text-slate-500 hover:bg-white/10'}">Alle</button>
                        ${Object.entries(notificationTypes).map(([key, val]) => `
                            <button onclick="filterNotifications('${key}')" class="notif-filter px-2 py-1 text-xs rounded-full whitespace-nowrap ${notificationFilter === key ? 'bg-purple-500 text-white' : 'bg-white/5 text-slate-500 hover:bg-white/10'}">${val.icon} ${val.label}</button>
                        `).join('')}
                    </div>
                </div>
                <div class="max-h-96 overflow-y-auto">
                    ${filteredNotifications.length === 0 ? `
                        <div class="p-8 text-center text-slate-500">
                            <span class="text-3xl block mb-2">üì≠</span>
                            <p class="text-sm">Keine Benachrichtigungen</p>
                        </div>
                    ` : filteredNotifications.map(n => {
                        const typeInfo = notificationTypes[n.type] || notificationTypes.system;
                        const colorClass = colorClasses[typeInfo.color] || '';
                        return `
                            <div class="p-3 border-b" style="border-color: var(--border); hover:bg-white/5 cursor-pointer transition-all ${colorClass} ${n.read ? 'opacity-60' : ''}" onclick="openNotification('${n.id}')">
                                <div class="flex gap-3">
                                    <div class="flex-shrink-0 w-10 h-10 rounded-full bg-${typeInfo.color}-500/20 flex items-center justify-center">
                                        <span class="text-lg">${typeInfo.icon}</span>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2">
                                            <p class="text-sm font-semibold truncate">${n.title}</p>
                                            ${n.priority === 'high' ? '<span class="w-2 h-2 bg-red-500 rounded-full flex-shrink-0"></span>' : ''}
                                        </div>
                                        <p class="text-xs text-slate-500 truncate">${n.desc}</p>
                                        <p class="text-xs text-slate-500 mt-1">${n.time}</p>
                                    </div>
                                    <button onclick="event.stopPropagation(); dismissNotification('${n.id}')" class="text-slate-500 hover:text-white p-1 rounded hover:bg-white/10">
                                        <span class="text-xs">‚úï</span>
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <div class="p-3 border-t" style="border-color: var(--border); flex items-center justify-between">
                    <button onclick="clearAllNotifications()" class="text-xs text-red-400 hover:text-red-300 px-2 py-1 rounded hover:bg-red-500/10">Alle l√∂schen</button>
                    <button onclick="refreshNotifications()" class="text-xs text-purple-400 hover:text-purple-300 px-2 py-1 rounded hover:bg-purple-500/10 flex items-center gap-1">
                        <span>üîÑ</span> Aktualisieren
                    </button>
                </div>
            `;
            document.body.appendChild(panel);
            notificationsOpen = true;

            setTimeout(() => {
                document.addEventListener('click', closeNotificationsOnClickOutside);
            }, 100);
        }

        function filterNotifications(filter) {
            notificationFilter = filter;
            const panel = document.getElementById('notificationsPanel');
            if (panel) {
                panel.remove();
                notificationsOpen = false;
                toggleNotifications();
            }
        }

        function openNotification(id) {
            const notif = notifications.find(n => n.id === id);
            if (notif) {
                notif.read = true;
                updateNotificationBadge();

                // Navigate based on type
                const typeRoutes = {
                    deal: 'deals',
                    lead: 'leads',
                    contact: 'crm',
                    email: 'email',
                    whatsapp: 'whatsapp'
                };

                if (typeRoutes[notif.type]) {
                    const panel = document.getElementById('notificationsPanel');
                    if (panel) panel.remove();
                    notificationsOpen = false;
                    switchTab(typeRoutes[notif.type]);
                }
            }
        }

        function dismissNotification(id) {
            notifications = notifications.filter(n => n.id !== id);
            updateNotificationBadge();
            const panel = document.getElementById('notificationsPanel');
            if (panel) {
                panel.remove();
                notificationsOpen = false;
                toggleNotifications();
            }
        }

        function clearAllNotifications() {
            notifications = [];
            updateNotificationBadge();
            const panel = document.getElementById('notificationsPanel');
            if (panel) {
                panel.remove();
                notificationsOpen = false;
                toggleNotifications();
            }
            showNotification('Alle Benachrichtigungen gel√∂scht', 'info');
        }

        async function refreshNotifications() {
            showNotification('Aktualisiere...', 'info');
            await loadNotifications();
            const panel = document.getElementById('notificationsPanel');
            if (panel) {
                panel.remove();
                notificationsOpen = false;
                toggleNotifications();
            }
            showNotification('Benachrichtigungen aktualisiert', 'success');
        }

        function closeNotificationsOnClickOutside(e) {
            const panel = document.getElementById('notificationsPanel');
            const btn = e.target.closest('button[onclick*="toggleNotifications"]');
            if (panel && !panel.contains(e.target) && !btn) {
                panel.remove();
                notificationsOpen = false;
                document.removeEventListener('click', closeNotificationsOnClickOutside);
            }
        }

        function markAllRead() {
            notifications.forEach(n => n.read = true);
            updateNotificationBadge();
            const panel = document.getElementById('notificationsPanel');
            if (panel) {
                panel.remove();
                notificationsOpen = false;
                toggleNotifications();
            }
        }

        // Add notification programmatically
        function addNotification(type, title, desc, priority = 'normal') {
            const id = `notif-${Date.now()}`;
            notifications.unshift({
                id,
                type,
                title,
                desc,
                time: 'Jetzt',
                timestamp: Date.now(),
                read: false,
                priority
            });
            updateNotificationBadge();

            // Show toast for high priority
            if (priority === 'high') {
                showNotification(`${notificationTypes[type]?.icon || 'üîî'} ${title}`, 'info');
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // INVOICE SYSTEM
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let invoices = [];
        let invoicePage = 1;
        let invoiceFilter = 'all';
        let autoInvoiceEnabled = true;
        let invoiceStats = { counts: {}, amounts: {} };

        // Load real invoices from HubSpot API - NO DEMO DATA
        async function loadInvoicesFromAPI() {
            try {
                const [invoicesRes, statsRes] = await Promise.all([
                    fetch('/api/v1/invoices?limit=100'),
                    fetch('/api/v1/invoices/stats')
                ]);

                if (invoicesRes.ok) {
                    const data = await invoicesRes.json();
                    invoices = data.invoices.map(inv => ({
                        id: inv.invoice_number,
                        hubspotId: inv.hubspot_deal_id,
                        customer: inv.customer_name || 'Unbekannt',
                        email: inv.customer_email || '',
                        deal: `Deal #${inv.hubspot_deal_id}`,
                        amount: inv.amount || 0,
                        status: inv.status || 'draft',
                        createdDate: new Date(inv.created_date),
                        dueDate: inv.due_date ? new Date(inv.due_date) : new Date(),
                        auto: true,
                        lineItems: inv.line_items || []
                    }));
                }

                if (statsRes.ok) {
                    invoiceStats = await statsRes.json();
                }

                updateInvoiceStats();
                renderInvoiceTable();
            } catch (error) {
                console.error('Error loading invoices from HubSpot:', error);
                showNotification('Fehler beim Laden der Rechnungen', 'error');
                invoices = [];
                updateInvoiceStats();
                renderInvoiceTable();
            }
        }

        function loadInvoices() {
            loadInvoicesFromAPI();
        }

        // Create Stripe Payment Link for invoice
        async function createStripePayment(invoiceId, amount, description, email) {
            try {
                const response = await fetch(`/api/v1/invoices/${invoiceId}/stripe-payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount, description, customer_email: email })
                });
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                return data.payment_url;
            } catch (error) {
                console.error('Stripe Payment Error:', error);
                return null;
            }
        }

        // Create PayPal Payment Link for invoice
        async function createPayPalPayment(invoiceId, amount, description) {
            try {
                const response = await fetch(`/api/v1/invoices/${invoiceId}/paypal-payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount, description })
                });
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                return data.payment_url;
            } catch (error) {
                console.error('PayPal Payment Error:', error);
                return null;
            }
        }

        // Send invoice with payment links
        async function sendInvoiceWithPayment(invoice) {
            if (!invoice.email) {
                showNotification('Keine E-Mail-Adresse vorhanden', 'error');
                return;
            }

            showNotification('Erstelle Zahlungslinks...', 'info');

            // Generate payment links
            const [stripeUrl, paypalUrl] = await Promise.all([
                createStripePayment(invoice.hubspotId, invoice.amount, invoice.customer, invoice.email),
                createPayPalPayment(invoice.hubspotId, invoice.amount, invoice.customer)
            ]);

            // Send invoice via API
            try {
                const response = await fetch(`/api/v1/invoices/${invoice.hubspotId}/send`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: invoice.email,
                        include_stripe: !!stripeUrl,
                        include_paypal: !!paypalUrl
                    })
                });

                if (response.ok) {
                    showNotification(`Rechnung an ${invoice.email} gesendet`, 'success');
                    loadInvoices(); // Refresh list
                } else {
                    throw new Error('Fehler beim Senden');
                }
            } catch (error) {
                showNotification('Fehler beim Senden der Rechnung', 'error');
            }
        }

        // Mark invoice as paid
        async function markInvoicePaid(invoiceId, paymentMethod = 'manual') {
            try {
                const response = await fetch(`/api/v1/invoices/${invoiceId}/mark-paid`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ payment_method: paymentMethod })
                });

                if (response.ok) {
                    showNotification('Rechnung als bezahlt markiert', 'success');
                    loadInvoices();
                }
            } catch (error) {
                showNotification('Fehler beim Aktualisieren', 'error');
            }
        }

        // Open payment modal to create Stripe/PayPal links
        async function openPaymentModal(invoiceId, amount, customerName) {
            const existingModal = document.querySelector('.payment-modal');
            if (existingModal) existingModal.remove();

            const modal = document.createElement('div');
            modal.className = 'payment-modal fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="glass-card rounded-xl shadow-2xl w-full max-w-md p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-semibold text-[var(--text-primary)]">Zahlungslink erstellen</h3>
                        <button onclick="this.closest('.payment-modal').remove()" class="p-2 hover:bg-slate-100 rounded-lg text-slate-400">‚úï</button>
                    </div>

                    <div class="mb-6 p-4 bg-white/5 rounded-lg">
                        <p class="text-sm text-[var(--text-muted)]">Rechnung f√ºr</p>
                        <p class="font-semibold text-[var(--text-primary)]">${customerName}</p>
                        <p class="text-2xl font-bold text-blue-600 mt-2">‚Ç¨${amount.toLocaleString('de-DE')}</p>
                    </div>

                    <div class="space-y-3">
                        <button onclick="generateStripeLink('${invoiceId}', ${amount}, '${customerName}')"
                            class="w-full flex items-center justify-center gap-3 p-4 bg-gradient-to-r from-violet-600 to-indigo-600 text-white rounded-lg hover:opacity-90 transition font-medium">
                            <span class="text-xl">üí≥</span>
                            <span>Stripe Zahlungslink</span>
                        </button>

                        <button onclick="generatePayPalLink('${invoiceId}', ${amount}, '${customerName}')"
                            class="w-full flex items-center justify-center gap-3 p-4 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg hover:opacity-90 transition font-medium">
                            <span class="text-xl">üÖøÔ∏è</span>
                            <span>PayPal Zahlungslink</span>
                        </button>
                    </div>

                    <div id="paymentLinkResult" class="mt-4 hidden">
                        <p class="text-sm text-[var(--text-muted)] mb-2">Zahlungslink:</p>
                        <div class="flex gap-2">
                            <input type="text" id="paymentLinkUrl" readonly class="flex-1 px-3 py-2 border" style="border-color: var(--border); rounded-lg text-sm bg-white/5">
                            <button onclick="copyPaymentLink()" class="px-4 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700 transition">
                                Kopieren
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Generate Stripe payment link
        async function generateStripeLink(invoiceId, amount, description) {
            showNotification('Erstelle Stripe Zahlungslink...', 'info');
            const url = await createStripePayment(invoiceId, amount, description, '');
            if (url) {
                document.getElementById('paymentLinkUrl').value = url;
                document.getElementById('paymentLinkResult').classList.remove('hidden');
                showNotification('Stripe Zahlungslink erstellt', 'success');
            } else {
                showNotification('Fehler beim Erstellen des Stripe Links', 'error');
            }
        }

        // Generate PayPal payment link
        async function generatePayPalLink(invoiceId, amount, description) {
            showNotification('Erstelle PayPal Zahlungslink...', 'info');
            const url = await createPayPalPayment(invoiceId, amount, description);
            if (url) {
                document.getElementById('paymentLinkUrl').value = url;
                document.getElementById('paymentLinkResult').classList.remove('hidden');
                showNotification('PayPal Zahlungslink erstellt', 'success');
            } else {
                showNotification('Fehler beim Erstellen des PayPal Links', 'error');
            }
        }

        // Copy payment link to clipboard
        function copyPaymentLink() {
            const input = document.getElementById('paymentLinkUrl');
            input.select();
            document.execCommand('copy');
            showNotification('Zahlungslink kopiert', 'success');
        }

        function updateInvoiceStats() {
            // Use API stats if available (scaled to total deals)
            if (invoiceStats.amounts && invoiceStats.amounts.total > 0) {
                document.getElementById('invoiceTotalMonth').textContent = '‚Ç¨' + formatNumber(invoiceStats.amounts.total);
                document.getElementById('invoicePaid').textContent = '‚Ç¨' + formatNumber(invoiceStats.amounts.paid);
                document.getElementById('invoicePaidCount').textContent = formatNumber(invoiceStats.counts.paid) + ' Rechnungen';
                document.getElementById('invoicePending').textContent = '‚Ç¨' + formatNumber(invoiceStats.amounts.pending);
                document.getElementById('invoicePendingCount').textContent = formatNumber(invoiceStats.counts.pending) + ' Rechnungen';
                document.getElementById('invoiceOverdue').textContent = '‚Ç¨' + formatNumber(invoiceStats.amounts.overdue);
                document.getElementById('invoiceOverdueCount').textContent = formatNumber(invoiceStats.counts.overdue) + ' Rechnungen';
                document.getElementById('autoInvoiceCount').textContent = formatNumber(invoiceStats.counts.total);
                return;
            }

            // Fallback to local calculation
            const paid = invoices.filter(inv => inv.status === 'paid');
            const pending = invoices.filter(inv => inv.status === 'pending' || inv.status === 'sent');
            const overdue = invoices.filter(inv => inv.status === 'overdue');

            const totalAmount = invoices.reduce((sum, inv) => sum + inv.amount, 0);
            const paidTotal = paid.reduce((sum, inv) => sum + inv.amount, 0);
            const pendingTotal = pending.reduce((sum, inv) => sum + inv.amount, 0);
            const overdueTotal = overdue.reduce((sum, inv) => sum + inv.amount, 0);

            document.getElementById('invoiceTotalMonth').textContent = '‚Ç¨' + formatNumber(totalAmount);
            document.getElementById('invoicePaid').textContent = '‚Ç¨' + formatNumber(paidTotal);
            document.getElementById('invoicePaidCount').textContent = paid.length + ' Rechnungen';
            document.getElementById('invoicePending').textContent = '‚Ç¨' + formatNumber(pendingTotal);
            document.getElementById('invoicePendingCount').textContent = pending.length + ' Rechnungen';
            document.getElementById('invoiceOverdue').textContent = '‚Ç¨' + formatNumber(overdueTotal);
            document.getElementById('invoiceOverdueCount').textContent = overdue.length + ' Rechnungen';
            document.getElementById('autoInvoiceCount').textContent = invoices.length;
        }

        function renderInvoiceTable() {
            const tbody = document.getElementById('invoiceTableBody');
            if (!tbody) return;

            let filtered = invoices;
            if (invoiceFilter !== 'all') {
                filtered = invoices.filter(inv => inv.status === invoiceFilter);
            }

            const pageSize = 10;
            const start = (invoicePage - 1) * pageSize;
            const end = start + pageSize;
            const pageInvoices = filtered.slice(start, end);

            const statusClasses = {
                paid: 'bg-emerald-100 text-emerald-700',
                pending: 'bg-amber-100 text-amber-700',
                overdue: 'bg-red-100 text-red-700',
                draft: 'bg-slate-100 text-[var(--text-muted)]'
            };

            const statusLabels = {
                paid: 'Bezahlt',
                pending: 'Ausstehend',
                overdue: '√úberf√§llig',
                draft: 'Entwurf'
            };

            tbody.innerHTML = pageInvoices.map(inv => `
                <tr class="border-b" style="border-color: var(--border); hover:bg-white/5 transition-colors">
                    <td class="p-4">
                        <div class="flex items-center gap-2">
                            <span class="font-medium text-[var(--text-primary)]">${inv.id}</span>
                            ${inv.auto ? '<span class="px-1.5 py-0.5 bg-blue-100 text-blue-600 text-xs rounded">HubSpot</span>' : ''}
                        </div>
                    </td>
                    <td class="p-4 text-[var(--text-muted)]">
                        <div>${inv.customer}</div>
                        ${inv.email ? `<div class="text-xs text-slate-400">${inv.email}</div>` : ''}
                    </td>
                    <td class="p-4 text-slate-500 text-sm">${inv.deal}</td>
                    <td class="p-4 font-semibold text-[var(--text-primary)]">‚Ç¨${inv.amount.toLocaleString('de-DE')}</td>
                    <td class="p-4">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClasses[inv.status] || statusClasses.draft}">${statusLabels[inv.status] || 'Entwurf'}</span>
                    </td>
                    <td class="p-4 text-slate-500 text-sm">${inv.createdDate.toLocaleDateString('de-DE')}</td>
                    <td class="p-4 text-sm ${inv.status === 'overdue' ? 'text-red-600 font-medium' : 'text-slate-500'}">${inv.dueDate.toLocaleDateString('de-DE')}</td>
                    <td class="p-4">
                        <div class="flex items-center gap-1">
                            <button onclick="viewInvoice('${inv.id}')" class="p-1.5 hover:bg-slate-100 rounded text-slate-500 hover:text-blue-600" title="Ansehen">üëÅÔ∏è</button>
                            ${inv.status !== 'paid' ? `
                                <button onclick="sendInvoice('${inv.id}')" class="p-1.5 hover:bg-slate-100 rounded text-slate-500 hover:text-violet-600" title="Mit Zahlungslink senden">üìß</button>
                                <button onclick="openPaymentModal('${inv.hubspotId}', ${inv.amount}, '${inv.customer}')" class="p-1.5 hover:bg-slate-100 rounded text-slate-500 hover:text-blue-600" title="Zahlungslink erstellen">üí≥</button>
                                <button onclick="markInvoicePaid('${inv.hubspotId}')" class="p-1.5 hover:bg-slate-100 rounded text-slate-500 hover:text-emerald-600" title="Als bezahlt markieren">‚úì</button>
                            ` : `
                                <span class="text-emerald-500 text-xs px-2">Bezahlt</span>
                            `}
                        </div>
                    </td>
                </tr>
            `).join('');

            document.getElementById('invoiceTableInfo').textContent =
                `Zeige ${start + 1}-${Math.min(end, filtered.length)} von ${filtered.length} Rechnungen`;
        }

        function filterInvoices(filter) {
            invoiceFilter = filter;
            invoicePage = 1;
            renderInvoiceTable();
        }

        function prevInvoicePage() {
            if (invoicePage > 1) {
                invoicePage--;
                renderInvoiceTable();
            }
        }

        function nextInvoicePage() {
            const filtered = invoiceFilter === 'all' ? invoices : invoices.filter(inv => inv.status === invoiceFilter);
            const maxPage = Math.ceil(filtered.length / 10);
            if (invoicePage < maxPage) {
                invoicePage++;
                renderInvoiceTable();
            }
        }

        function toggleAutoInvoice(enabled) {
            autoInvoiceEnabled = enabled;
            document.getElementById('autoInvoiceStatus').textContent = enabled ? 'Aktiv' : 'Deaktiviert';
            showNotification(enabled ? 'Auto-Rechnungen aktiviert' : 'Auto-Rechnungen deaktiviert', enabled ? 'success' : 'warning');
        }

        function openCreateInvoice() {
            showInvoiceModal('create');
        }

        function openAutoInvoiceSettings() {
            showInvoiceModal('settings');
        }

        function viewInvoice(id) {
            const invoice = invoices.find(inv => inv.id === id);
            if (invoice) {
                showInvoiceModal('view', invoice);
            }
        }

        function downloadInvoice(id) {
            showNotification(`Rechnung ${id} wird heruntergeladen...`, 'info');
            setTimeout(() => showNotification(`Rechnung ${id} erfolgreich heruntergeladen`, 'success'), 1000);
        }

        function sendInvoice(id) {
            const invoice = invoices.find(inv => inv.id === id);
            if (invoice) {
                sendInvoiceWithPayment(invoice);
            } else {
                showNotification('Rechnung nicht gefunden', 'error');
            }
        }

        function exportInvoices() {
            // Create CSV from real invoice data
            const headers = ['Rechnungsnr.', 'Kunde', 'Deal', 'Betrag', 'Status', 'Erstellt', 'F√§llig'];
            const rows = invoices.map(inv => [
                inv.id,
                inv.customer,
                inv.deal,
                inv.amount,
                inv.status,
                inv.createdDate.toLocaleDateString('de-DE'),
                inv.dueDate.toLocaleDateString('de-DE')
            ]);

            let csv = headers.join(';') + '\n';
            rows.forEach(row => csv += row.join(';') + '\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `rechnungen_export_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            showNotification('Export abgeschlossen', 'success');
        }

        function showInvoiceModal(type, data = null) {
            const existingModal = document.querySelector('.invoice-modal');
            if (existingModal) existingModal.remove();

            const modal = document.createElement('div');
            modal.className = 'invoice-modal fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-50';

            let content = '';

            if (type === 'create') {
                content = `
                    <div class="glass-card rounded-xl shadow-2xl w-full max-w-lg mx-4">
                        <div class="p-5 border-b" style="border-color: var(--border); flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-[var(--text-primary)]">Neue Rechnung erstellen</h3>
                            <button onclick="closeInvoiceModal()" class="text-slate-400 hover:text-[var(--text-muted)]">‚úï</button>
                        </div>
                        <div class="p-5 space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-[var(--text-muted)] mb-1">Kunde</label>
                                <select class="w-full border" style="border-color: var(--border); rounded-lg px-3 py-2">
                                    <option>Kunde ausw√§hlen...</option>
                                    <option>TechCorp GmbH</option>
                                    <option>Digital Solutions AG</option>
                                    <option>Innovation Labs</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-[var(--text-muted)] mb-1">Deal verkn√ºpfen</label>
                                <select class="w-full border" style="border-color: var(--border); rounded-lg px-3 py-2">
                                    <option>Deal ausw√§hlen (optional)...</option>
                                    <option>Deal #1234 - ‚Ç¨50.000</option>
                                    <option>Deal #2345 - ‚Ç¨125.000</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-[var(--text-muted)] mb-1">Betrag (‚Ç¨)</label>
                                    <input type="number" class="w-full border" style="border-color: var(--border); rounded-lg px-3 py-2" placeholder="0.00">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-[var(--text-muted)] mb-1">Zahlungsziel (Tage)</label>
                                    <input type="number" class="w-full border" style="border-color: var(--border); rounded-lg px-3 py-2" value="14">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-[var(--text-muted)] mb-1">Beschreibung</label>
                                <textarea class="w-full border" style="border-color: var(--border); rounded-lg px-3 py-2 h-20" placeholder="Leistungsbeschreibung..."></textarea>
                            </div>
                        </div>
                        <div class="p-5 border-t" style="border-color: var(--border); flex justify-end gap-3">
                            <button onclick="closeInvoiceModal()" class="btn btn-secondary">Abbrechen</button>
                            <button onclick="createInvoice()" class="btn btn-primary">Rechnung erstellen</button>
                        </div>
                    </div>
                `;
            } else if (type === 'settings') {
                content = `
                    <div class="glass-card rounded-xl shadow-2xl w-full max-w-lg mx-4">
                        <div class="p-5 border-b" style="border-color: var(--border); flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-[var(--text-primary)]">Auto-Rechnungen Einstellungen</h3>
                            <button onclick="closeInvoiceModal()" class="text-slate-400 hover:text-[var(--text-muted)]">‚úï</button>
                        </div>
                        <div class="p-5 space-y-4">
                            <div class="flex items-center justify-between p-4 bg-white/5 rounded-lg">
                                <div>
                                    <p class="font-medium text-[var(--text-primary)]">Automatische Erstellung</p>
                                    <p class="text-sm text-slate-500">Bei Deal-Abschluss automatisch Rechnung erstellen</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-white/20 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            <div class="flex items-center justify-between p-4 bg-white/5 rounded-lg">
                                <div>
                                    <p class="font-medium text-[var(--text-primary)]">Automatischer E-Mail-Versand</p>
                                    <p class="text-sm text-slate-500">Rechnung direkt an Kunden senden</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-white/20 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-[var(--text-muted)] mb-1">Standard-Zahlungsziel</label>
                                <select class="w-full border" style="border-color: var(--border); rounded-lg px-3 py-2">
                                    <option>7 Tage</option>
                                    <option selected>14 Tage</option>
                                    <option>30 Tage</option>
                                    <option>60 Tage</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-[var(--text-muted)] mb-1">Rechnungsnummer-Pr√§fix</label>
                                <input type="text" class="w-full border" style="border-color: var(--border); rounded-lg px-3 py-2" value="INV-2026-">
                            </div>
                            <div class="flex items-center justify-between p-4 bg-white/5 rounded-lg">
                                <div>
                                    <p class="font-medium text-[var(--text-primary)]">Zahlungserinnerung</p>
                                    <p class="text-sm text-slate-500">Automatisch bei √úberf√§lligkeit erinnern</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-white/20 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                        </div>
                        <div class="p-5 border-t" style="border-color: var(--border); flex justify-end gap-3">
                            <button onclick="closeInvoiceModal()" class="btn btn-secondary">Abbrechen</button>
                            <button onclick="saveAutoInvoiceSettings()" class="btn btn-primary">Speichern</button>
                        </div>
                    </div>
                `;
            } else if (type === 'view' && data) {
                content = `
                    <div class="glass-card rounded-xl shadow-2xl w-full max-w-2xl mx-4">
                        <div class="p-5 border-b" style="border-color: var(--border); flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-[var(--text-primary)]">Rechnung ${data.id}</h3>
                            <button onclick="closeInvoiceModal()" class="text-slate-400 hover:text-[var(--text-muted)]">‚úï</button>
                        </div>
                        <div class="p-6">
                            <div class="flex justify-between mb-8">
                                <div>
                                    <h4 class="text-2xl font-bold text-[var(--text-primary)]">RECHNUNG</h4>
                                    <p class="text-slate-500">${data.id}</p>
                                </div>
                                <div class="text-right">
                                    <p class="font-semibold text-[var(--text-primary)]">Enterprise Universe GmbH</p>
                                    <p class="text-sm text-slate-500">Musterstra√üe 123</p>
                                    <p class="text-sm text-slate-500">12345 Berlin</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-8 mb-8">
                                <div>
                                    <p class="text-sm text-slate-500 mb-1">Rechnungsempf√§nger</p>
                                    <p class="font-semibold text-[var(--text-primary)]">${data.customer}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm text-slate-500">Rechnungsdatum: ${data.createdDate.toLocaleDateString('de-DE')}</p>
                                    <p class="text-sm text-slate-500">F√§llig: ${data.dueDate.toLocaleDateString('de-DE')}</p>
                                </div>
                            </div>
                            <table class="w-full mb-8">
                                <thead>
                                    <tr class="border-b" style="border-color: var(--border);">
                                        <th class="text-left py-3 text-sm font-semibold text-[var(--text-muted)]">Beschreibung</th>
                                        <th class="text-right py-3 text-sm font-semibold text-[var(--text-muted)]">Betrag</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="border-b" style="border-color: var(--border);">
                                        <td class="py-3 text-[var(--text-primary)]">${data.deal} - Dienstleistungen</td>
                                        <td class="py-3 text-right text-[var(--text-primary)]">‚Ç¨${(data.amount * 0.84).toLocaleString('de-DE', {minimumFractionDigits: 2})}</td>
                                    </tr>
                                    <tr class="border-b" style="border-color: var(--border);">
                                        <td class="py-3 text-slate-500">MwSt. (19%)</td>
                                        <td class="py-3 text-right text-slate-500">‚Ç¨${(data.amount * 0.16).toLocaleString('de-DE', {minimumFractionDigits: 2})}</td>
                                    </tr>
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td class="py-3 font-bold text-[var(--text-primary)]">Gesamtbetrag</td>
                                        <td class="py-3 text-right text-xl font-bold text-[var(--text-primary)]">‚Ç¨${data.amount.toLocaleString('de-DE', {minimumFractionDigits: 2})}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <div class="p-5 border-t" style="border-color: var(--border); flex justify-between">
                            <span class="px-3 py-1.5 rounded-full text-sm font-medium ${data.status === 'paid' ? 'bg-emerald-100 text-emerald-700' : data.status === 'pending' ? 'bg-amber-100 text-amber-700' : 'bg-red-100 text-red-700'}">${data.status === 'paid' ? 'Bezahlt' : data.status === 'pending' ? 'Ausstehend' : '√úberf√§llig'}</span>
                            <div class="flex gap-3">
                                <button onclick="downloadInvoice('${data.id}')" class="btn btn-secondary">üì• Download PDF</button>
                                <button onclick="sendInvoice('${data.id}')" class="btn btn-primary">üìß Per E-Mail senden</button>
                            </div>
                        </div>
                    </div>
                `;
            }

            modal.innerHTML = content;
            modal.onclick = (e) => { if (e.target === modal) closeInvoiceModal(); };
            document.body.appendChild(modal);
        }

        function closeInvoiceModal() {
            const modal = document.querySelector('.invoice-modal');
            if (modal) modal.remove();
        }

        function createInvoice() {
            closeInvoiceModal();
            showNotification('Rechnung wird erstellt...', 'info');
            setTimeout(() => {
                loadInvoices();
                showNotification('Rechnung erfolgreich erstellt!', 'success');
            }, 1000);
        }

        function saveAutoInvoiceSettings() {
            closeInvoiceModal();
            showNotification('Einstellungen gespeichert', 'success');
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // INITIALIZE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Enterprise Suite - Professional Dashboard Initialized');
            initCharts();
            initFinanceCharts();
            generateAgents();
            loadDashboardData();
            loadActivities();
            loadHubSpotStats();
            loadNotifications();
            loadInvoices();
            connectWebSocket();

            // Auto-sync HubSpot on load
            autoSyncHubSpot();

            // Load Deals Pipeline
            loadSampleDeals();

            // Start Lead Demon
            initLeadDemon();

            // Refresh data every 30 seconds
            setInterval(loadDashboardData, 30000);

            // Refresh notifications every 60 seconds
            setInterval(loadNotifications, 60000);
            setInterval(loadActivities, 15000);
            setInterval(loadHubSpotStats, 60000);
            // Lead Bot runs automatically every 2 minutes (configured in initLeadDemon)
        });

        // Auto-sync HubSpot data on page load
        async function autoSyncHubSpot() {
            try {
                const lastSync = localStorage.getItem('hubspotLastSync');
                const now = Date.now();
                const oneHour = 60 * 60 * 1000;

                // Auto-sync if last sync was more than 1 hour ago
                if (!lastSync || (now - parseInt(lastSync)) > oneHour) {
                    console.log('üîÑ Auto-syncing HubSpot data...');
                    await syncHubSpot();
                    localStorage.setItem('hubspotLastSync', now.toString());
                }
            } catch (e) {
                console.log('Auto-sync check failed:', e);
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                e.preventDefault();
                document.querySelector('input[type="text"]')?.focus();
            }
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal.active').forEach(m => m.classList.remove('active'));
            }
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // WHATSAPP BUSINESS API INTEGRATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        const WHATSAPP_API = '/api/whatsapp';
        let whatsappConnected = false;
        let whatsappTemplates = [];

        async function loadWhatsAppStatus() {
            const statusEl = document.getElementById('waConnectionStatus');
            const phoneEl = document.getElementById('waPhoneNumber');
            const cardEl = document.getElementById('whatsappStatusCard');

            try {
                statusEl.textContent = 'Pr√ºfe...';
                const res = await fetch(`${WHATSAPP_API}/status`);
                const data = await res.json();

                if (data.connected) {
                    whatsappConnected = true;
                    statusEl.textContent = 'Verbunden';
                    phoneEl.textContent = data.phoneNumber || 'Business Account';
                    cardEl.classList.remove('border-red-500/30', 'border-yellow-500/30');
                    cardEl.classList.add('border-green-500/30');
                    showNotification('WhatsApp verbunden!', 'success');
                } else {
                    whatsappConnected = false;
                    statusEl.textContent = 'Nicht verbunden';
                    phoneEl.textContent = data.error || 'API nicht konfiguriert';
                    cardEl.classList.remove('border-green-500/30');
                    cardEl.classList.add('border-yellow-500/30');
                }

                // Load stats
                await loadWhatsAppStats();
                await loadWhatsAppTemplates();
                await loadWhatsAppMessages();
                await loadHubSpotContactsWithPhone();

            } catch (error) {
                console.error('WhatsApp status error:', error);
                statusEl.textContent = 'Fehler';
                phoneEl.textContent = error.message;
                cardEl.classList.add('border-red-500/30');
            }
        }

        async function loadWhatsAppStats() {
            try {
                const res = await fetch(`${WHATSAPP_API}/stats`);
                const stats = await res.json();

                document.getElementById('waSentCount').textContent = stats.sent || 0;
                document.getElementById('waDeliveredCount').textContent = stats.delivered || 0;
                document.getElementById('waReadCount').textContent = stats.read || 0;
            } catch (e) {
                console.log('Could not load WhatsApp stats');
            }
        }

        async function loadWhatsAppTemplates() {
            const listEl = document.getElementById('waTemplatesList');
            const selectEl = document.getElementById('waTemplate');

            try {
                const res = await fetch(`${WHATSAPP_API}/templates`);
                const data = await res.json();

                whatsappTemplates = data.templates || [];

                if (whatsappTemplates.length === 0) {
                    listEl.innerHTML = '<div class="text-center py-4 text-slate-500 text-sm">Keine Templates</div>';
                    return;
                }

                // Update select dropdown
                selectEl.innerHTML = whatsappTemplates.map(t =>
                    `<option value="${t.name}">${t.name}</option>`
                ).join('');

                // Update list view
                listEl.innerHTML = whatsappTemplates.map(t => `
                    <div class="p-2 bg-white/5 rounded-lg">
                        <div class="flex items-center justify-between">
                            <p class="font-semibold text-sm">${t.name}</p>
                            <span class="text-xs px-2 py-0.5 rounded ${t.status === 'APPROVED' ? 'bg-green-500/20 text-green-400' : 'bg-yellow-500/20 text-yellow-400'}">${t.status}</span>
                        </div>
                        <p class="text-xs text-slate-500 mt-1">${t.language || 'de'} ‚Ä¢ ${t.category || 'MARKETING'}</p>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading templates:', error);
                listEl.innerHTML = '<div class="text-center py-4 text-red-400 text-sm">Fehler beim Laden</div>';
            }
        }

        async function loadWhatsAppMessages() {
            const listEl = document.getElementById('waMessagesList');

            try {
                const res = await fetch(`${WHATSAPP_API}/messages?limit=10`);
                const data = await res.json();

                const messages = data.messages || [];

                if (messages.length === 0) {
                    listEl.innerHTML = '<div class="text-center py-4 text-slate-500 text-sm">Keine Nachrichten</div>';
                    return;
                }

                listEl.innerHTML = messages.map(m => {
                    const isOutgoing = m.direction === 'outgoing';
                    const statusIcon = m.status === 'read' ? 'üëÅÔ∏è' : m.status === 'delivered' ? '‚úì‚úì' : m.status === 'sent' ? '‚úì' : '‚è≥';
                    const time = m.timestamp ? new Date(m.timestamp).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }) : '';

                    return `
                    <div class="p-2 bg-white/5 rounded-lg ${isOutgoing ? 'border-l-2 border-green-500' : 'border-l-2 border-blue-500'}">
                        <div class="flex items-center justify-between">
                            <p class="text-xs font-semibold ${isOutgoing ? 'text-green-400' : 'text-blue-400'}">
                                ${isOutgoing ? 'üì§' : 'üì•'} ${m.to || m.from}
                            </p>
                            <span class="text-xs text-slate-500">${time} ${statusIcon}</span>
                        </div>
                        <p class="text-xs text-slate-500 mt-1 truncate">${m.content || m.template || '...'}</p>
                    </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading messages:', error);
                listEl.innerHTML = '<div class="text-center py-4 text-red-400 text-sm">Fehler beim Laden</div>';
            }
        }

        function toggleWaTemplateSelect() {
            const type = document.getElementById('waMessageType').value;
            const templateSelect = document.getElementById('waTemplateSelect');
            const textInput = document.getElementById('waTextInput');

            if (type === 'template') {
                templateSelect.classList.remove('hidden');
                textInput.classList.add('hidden');
            } else {
                templateSelect.classList.add('hidden');
                textInput.classList.remove('hidden');
            }
        }

        async function sendWhatsAppMessage() {
            const recipient = document.getElementById('waRecipient').value.trim();
            const type = document.getElementById('waMessageType').value;
            const message = document.getElementById('waMessage').value.trim();
            const template = document.getElementById('waTemplate').value;

            if (!recipient) {
                showNotification('Bitte Empf√§nger eingeben', 'error');
                return;
            }

            if (type === 'text' && !message) {
                showNotification('Bitte Nachricht eingeben', 'error');
                return;
            }

            try {
                showNotification('Sende Nachricht...', 'info');

                const payload = {
                    to: recipient.replace(/\s/g, ''),
                    type: type,
                    message: type === 'text' ? message : undefined,
                    template: type === 'template' ? template : undefined
                };

                const res = await fetch(`${WHATSAPP_API}/send`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();

                if (data.success) {
                    showNotification('Nachricht gesendet!', 'success');
                    document.getElementById('waMessage').value = '';
                    await loadWhatsAppStats();
                    await loadWhatsAppMessages();
                } else {
                    throw new Error(data.error || 'Senden fehlgeschlagen');
                }

            } catch (error) {
                console.error('Send error:', error);
                showNotification('Fehler: ' + error.message, 'error');
            }
        }

        function sendQuickWA(message) {
            const recipient = document.getElementById('waRecipient').value.trim();
            if (!recipient) {
                showNotification('Bitte zuerst Empf√§nger eingeben', 'warning');
                return;
            }
            document.getElementById('waMessage').value = message;
            sendWhatsAppMessage();
        }

        async function sendBulkWhatsApp() {
            const source = document.getElementById('waBulkSource').value;
            const template = document.getElementById('waBulkTemplate').value;
            const limit = parseInt(document.getElementById('waBulkLimit').value) || 10;

            if (!confirm(`${limit} Nachrichten an "${source}" senden?\n\nTemplate: ${template}`)) return;

            const progressEl = document.getElementById('waBulkProgress');
            const progressBar = document.getElementById('waBulkProgressBar');
            const progressText = document.getElementById('waBulkProgressText');

            progressEl.classList.remove('hidden');
            progressBar.style.width = '0%';
            progressText.textContent = `0/${limit}`;

            try {
                showNotification('Bulk-Versand gestartet...', 'info');

                const res = await fetch(`${WHATSAPP_API}/send-bulk`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ source, template, limit })
                });

                const data = await res.json();

                if (data.success) {
                    progressBar.style.width = '100%';
                    progressText.textContent = `${data.sent}/${data.total}`;
                    showNotification(`Bulk-Versand abgeschlossen: ${data.sent} gesendet`, 'success');
                    await loadWhatsAppStats();
                } else {
                    throw new Error(data.error || 'Bulk-Versand fehlgeschlagen');
                }

            } catch (error) {
                console.error('Bulk send error:', error);
                showNotification('Fehler: ' + error.message, 'error');
            }

            setTimeout(() => progressEl.classList.add('hidden'), 3000);
        }

        async function loadHubSpotContactsWithPhone() {
            try {
                const res = await fetch('/api/hubspot/contacts?has_phone=true&limit=1');
                const data = await res.json();
                const count = data.total || 0;
                document.getElementById('waHubspotContacts').textContent = formatNumber(count) + ' Kontakte';
            } catch (e) {
                document.getElementById('waHubspotContacts').textContent = 'Nicht verf√ºgbar';
            }
        }

        async function syncWhatsAppHubSpot() {
            showNotification('Synchronisiere WhatsApp mit HubSpot...', 'info');

            try {
                // Get HubSpot contacts with phone numbers
                const res = await fetch('/api/hubspot/contacts?has_phone=true');
                const data = await res.json();

                if (data.results?.length) {
                    showNotification(`${data.results.length} Kontakte mit Telefon gefunden`, 'success');
                    await loadHubSpotContactsWithPhone();
                } else {
                    showNotification('Keine Kontakte mit Telefonnummer', 'warning');
                }

            } catch (error) {
                console.error('Sync error:', error);
                showNotification('Sync fehlgeschlagen: ' + error.message, 'error');
            }
        }

        // Initialize WhatsApp on tab switch
        function initWhatsAppTab() {
            loadWhatsAppStatus();
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // STRIPE PAYMENTS INTEGRATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        const STRIPE_API = '/api/stripe';
        let stripeProducts = [];

        async function loadStripeData() {
            await loadStripeStatus();
            await loadStripeStats();
            await loadStripeProducts();
            await loadStripeSubscriptions();
            await loadStripePayments();
            await loadStripeCustomers();
        }

        async function loadStripeStatus() {
            try {
                const res = await fetch(`${STRIPE_API}/status`);
                const data = await res.json();

                const statusEl = document.getElementById('stripeStatus');
                const modeEl = document.getElementById('stripeMode');
                const cardEl = document.getElementById('stripeStatusCard');

                if (data.configured) {
                    statusEl.textContent = 'Verbunden';
                    modeEl.textContent = data.mode === 'live' ? 'LIVE Modus' : 'Test Modus';
                    cardEl.classList.remove('border-red-500/30');
                    cardEl.classList.add('border-green-500/30');
                } else {
                    statusEl.textContent = 'Nicht konfiguriert';
                    modeEl.textContent = 'API Key fehlt';
                    cardEl.classList.add('border-red-500/30');
                }
            } catch (e) {
                console.error('Stripe status error:', e);
            }
        }

        async function loadStripeStats() {
            try {
                const res = await fetch(`${STRIPE_API}/stats`);
                const data = await res.json();

                document.getElementById('stripeRevenue').textContent = '‚Ç¨' + formatNumber(data.totalRevenue || 0);
                document.getElementById('stripePayments').textContent = data.successfulPayments || 0;
            } catch (e) {
                console.error('Stripe stats error:', e);
            }
        }

        async function loadStripeProducts() {
            const listEl = document.getElementById('stripeProductsList');
            const countEl = document.getElementById('stripeProductCount');
            const selectEl = document.getElementById('checkoutPriceId');

            try {
                const res = await fetch(`${STRIPE_API}/products`);
                const data = await res.json();

                stripeProducts = data.products || [];
                countEl.textContent = stripeProducts.length + ' Produkte';

                if (stripeProducts.length === 0) {
                    listEl.innerHTML = '<div class="text-center py-4 text-[var(--text-muted)] text-sm">Keine Produkte</div>';
                    return;
                }

                // Update products list
                listEl.innerHTML = stripeProducts.map(p => {
                    const price = p.prices?.[0];
                    const amount = price ? (price.unit_amount / 100).toFixed(2) : '0.00';
                    const interval = price?.recurring ? `/${price.recurring.interval === 'month' ? 'Mo' : 'Jahr'}` : '';

                    return `
                    <div class="p-3 bg-[var(--bg-elevated)] rounded-lg">
                        <div class="flex items-center justify-between">
                            <p class="font-semibold text-sm truncate flex-1">${p.name}</p>
                            <span class="text-green-400 font-bold ml-2">‚Ç¨${amount}${interval}</span>
                        </div>
                        <p class="text-xs text-[var(--text-muted)] mt-1 truncate">${p.description || 'Keine Beschreibung'}</p>
                        ${p.prices?.length > 1 ? `<p class="text-xs text-purple-400 mt-1">${p.prices.length} Preisoptionen</p>` : ''}
                    </div>
                    `;
                }).join('');

                // Update checkout select
                selectEl.innerHTML = stripeProducts.flatMap(p =>
                    (p.prices || []).map(price => {
                        const amount = (price.unit_amount / 100).toFixed(2);
                        const interval = price.recurring ? `/${price.recurring.interval === 'month' ? 'Mo' : 'Jahr'}` : ' (einmalig)';
                        return `<option value="${price.id}">${p.name} - ‚Ç¨${amount}${interval}</option>`;
                    })
                ).join('');

            } catch (e) {
                console.error('Stripe products error:', e);
                listEl.innerHTML = '<div class="text-center py-4 text-red-400 text-sm">Fehler beim Laden</div>';
            }
        }

        async function loadStripeSubscriptions() {
            const listEl = document.getElementById('stripeSubscriptionsList');
            const status = document.getElementById('subStatusFilter')?.value || 'active';

            try {
                const res = await fetch(`${STRIPE_API}/subscriptions?status=${status}`);
                const data = await res.json();

                const subs = data.subscriptions || [];
                document.getElementById('stripeSubscriptions').textContent = subs.filter(s => s.status === 'active').length;

                if (subs.length === 0) {
                    listEl.innerHTML = '<div class="text-center py-4 text-[var(--text-muted)] text-sm">Keine Abonnements</div>';
                    return;
                }

                listEl.innerHTML = subs.map(s => {
                    const statusColors = {
                        active: 'bg-green-500/20 text-green-400',
                        canceled: 'bg-red-500/20 text-red-400',
                        past_due: 'bg-yellow-500/20 text-yellow-400',
                        trialing: 'bg-blue-500/20 text-blue-400'
                    };
                    const amount = s.items?.data?.[0]?.price?.unit_amount / 100 || 0;

                    return `
                    <div class="p-2 bg-[var(--bg-elevated)] rounded-lg">
                        <div class="flex items-center justify-between">
                            <p class="text-sm font-semibold truncate">${s.customer?.email || s.customer || 'Kunde'}</p>
                            <span class="text-xs px-2 py-0.5 rounded ${statusColors[s.status] || 'bg-gray-500/20'}">${s.status}</span>
                        </div>
                        <div class="flex items-center justify-between mt-1">
                            <span class="text-xs text-[var(--text-muted)]">‚Ç¨${amount.toFixed(2)}/Mo</span>
                            <span class="text-xs text-[var(--text-muted)]">${new Date(s.current_period_end * 1000).toLocaleDateString('de-DE')}</span>
                        </div>
                    </div>
                    `;
                }).join('');

            } catch (e) {
                console.error('Stripe subscriptions error:', e);
                listEl.innerHTML = '<div class="text-center py-4 text-red-400 text-sm">Fehler beim Laden</div>';
            }
        }

        async function loadStripePayments() {
            const listEl = document.getElementById('stripePaymentsList');

            try {
                const res = await fetch(`${STRIPE_API}/payments?limit=10`);
                const data = await res.json();

                const payments = data.payments || [];

                if (payments.length === 0) {
                    listEl.innerHTML = '<div class="text-center py-4 text-[var(--text-muted)] text-sm">Keine Zahlungen</div>';
                    return;
                }

                listEl.innerHTML = payments.map(p => {
                    const statusColors = {
                        succeeded: 'text-green-400',
                        processing: 'text-yellow-400',
                        requires_payment_method: 'text-red-400',
                        canceled: 'text-gray-400'
                    };
                    const statusIcons = {
                        succeeded: '‚úì',
                        processing: '‚è≥',
                        requires_payment_method: '!',
                        canceled: '‚úï'
                    };
                    const amount = (p.amount / 100).toFixed(2);
                    const date = new Date(p.created * 1000).toLocaleDateString('de-DE');

                    return `
                    <div class="p-2 bg-[var(--bg-elevated)] rounded-lg flex items-center justify-between">
                        <div>
                            <p class="text-sm font-semibold ${statusColors[p.status] || ''}">‚Ç¨${amount}</p>
                            <p class="text-xs text-[var(--text-muted)]">${date}</p>
                        </div>
                        <span class="text-lg ${statusColors[p.status] || ''}">${statusIcons[p.status] || '?'}</span>
                    </div>
                    `;
                }).join('');

            } catch (e) {
                console.error('Stripe payments error:', e);
                listEl.innerHTML = '<div class="text-center py-4 text-red-400 text-sm">Fehler beim Laden</div>';
            }
        }

        async function loadStripeCustomers() {
            const listEl = document.getElementById('stripeCustomersList');

            try {
                const res = await fetch(`${STRIPE_API}/customers?limit=10`);
                const data = await res.json();

                const customers = data.customers || [];

                if (customers.length === 0) {
                    listEl.innerHTML = '<div class="text-center py-4 text-[var(--text-muted)] text-sm">Keine Kunden</div>';
                    return;
                }

                listEl.innerHTML = customers.map(c => `
                    <div class="p-2 bg-[var(--bg-elevated)] rounded-lg flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-cyan-500/20 flex items-center justify-center text-cyan-400 text-sm font-bold">
                            ${(c.name || c.email || '?').charAt(0).toUpperCase()}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-semibold truncate">${c.name || 'Unbekannt'}</p>
                            <p class="text-xs text-[var(--text-muted)] truncate">${c.email || '-'}</p>
                        </div>
                    </div>
                `).join('');

            } catch (e) {
                console.error('Stripe customers error:', e);
                listEl.innerHTML = '<div class="text-center py-4 text-red-400 text-sm">Fehler beim Laden</div>';
            }
        }

        async function createCheckoutSession(mode) {
            const priceId = document.getElementById('checkoutPriceId').value;
            const email = document.getElementById('checkoutEmail').value;

            if (!priceId) {
                showNotification('Bitte Produkt ausw√§hlen', 'error');
                return;
            }

            try {
                showNotification('Erstelle Checkout...', 'info');

                const endpoint = mode === 'subscription' ? '/subscribe' : '/checkout';
                const res = await fetch(`${STRIPE_API}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        priceId,
                        customerEmail: email || undefined,
                        successUrl: window.location.origin + '/payment-success',
                        cancelUrl: window.location.origin + '/v11'
                    })
                });

                const data = await res.json();

                if (data.url) {
                    showNotification('Checkout erstellt! √ñffne...', 'success');
                    window.open(data.url, '_blank');
                } else {
                    throw new Error(data.error || 'Checkout fehlgeschlagen');
                }

            } catch (e) {
                console.error('Checkout error:', e);
                showNotification('Fehler: ' + e.message, 'error');
            }
        }

        function initPaymentsTab() {
            loadStripeData();
        }
    </script>

    <!-- Invoice Modal -->
    <div id="invoiceModal" class="modal">
        <div class="modal-content p-6 animate-slide-in">
            <div class="flex items-center justify-between mb-6">
                <h2 class="font-orbitron text-xl font-bold gradient-gold">Neue Rechnung erstellen</h2>
                <button onclick="closeModal('invoiceModal')" class="p-2 hover:bg-white/10 rounded-lg">‚úï</button>
            </div>
            <form class="space-y-4">
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-slate-500 mb-1">Kunde</label>
                        <select class="w-full px-4 py-2 bg-white/5 border" style="border-color: var(--border); rounded-lg outline-none focus:border-purple-500">
                            <option>PropTech GmbH</option>
                            <option>SmartLiving AG</option>
                            <option>TechCorp AG</option>
                            <option>Real Estate Empire</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-slate-500 mb-1">Betrag (‚Ç¨)</label>
                        <input type="number" class="w-full px-4 py-2 bg-white/5 border" style="border-color: var(--border); rounded-lg outline-none focus:border-purple-500" placeholder="0.00">
                    </div>
                </div>
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-slate-500 mb-1">Rechnungsdatum</label>
                        <input type="date" class="w-full px-4 py-2 bg-white/5 border" style="border-color: var(--border); rounded-lg outline-none focus:border-purple-500">
                    </div>
                    <div>
                        <label class="block text-sm text-slate-500 mb-1">F√§lligkeitsdatum</label>
                        <input type="date" class="w-full px-4 py-2 bg-white/5 border" style="border-color: var(--border); rounded-lg outline-none focus:border-purple-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-slate-500 mb-1">Beschreibung</label>
                    <textarea rows="3" class="w-full px-4 py-2 bg-white/5 border" style="border-color: var(--border); rounded-lg outline-none focus:border-purple-500 resize-none" placeholder="Leistungsbeschreibung..."></textarea>
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeModal('invoiceModal')" class="flex-1 px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg transition">Abbrechen</button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-gradient-to-r from-yellow-500 to-orange-500 text-black font-semibold rounded-lg hover:opacity-90 transition">Rechnung erstellen</button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>
