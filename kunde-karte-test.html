<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kundenkarte | West Money Bau CRM</title>
    <!-- AUTH DISABLED FOR TEST -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            color: #e2e8f0;
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 16px;
        }

        .tab-btn {
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            background: transparent;
            color: #94a3b8;
        }

        .tab-btn:hover {
            background: rgba(59, 130, 246, 0.1);
            color: #e2e8f0;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .upload-zone {
            border: 2px dashed rgba(148, 163, 184, 0.3);
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .upload-zone:hover, .upload-zone.dragover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.05);
        }

        .file-item {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.2s;
        }

        .file-item:hover {
            border-color: rgba(59, 130, 246, 0.5);
            background: rgba(59, 130, 246, 0.05);
        }

        .wish-item {
            background: rgba(15, 23, 42, 0.4);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 12px;
            padding: 16px;
            transition: all 0.2s;
        }

        .wish-item.completed {
            border-color: rgba(34, 197, 94, 0.3);
            background: rgba(34, 197, 94, 0.05);
        }

        .config-module {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 16px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .config-module:hover {
            border-color: rgba(139, 92, 246, 0.5);
        }

        .config-module.selected {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
        }

        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-blue { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .badge-green { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .badge-amber { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
        .badge-purple { background: rgba(139, 92, 246, 0.2); color: #a78bfa; }

        .input-field {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 10px;
            padding: 12px 16px;
            color: #e2e8f0;
            width: 100%;
            transition: all 0.2s;
        }

        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3);
        }

        .btn-secondary {
            background: rgba(148, 163, 184, 0.1);
            color: #e2e8f0;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 500;
            border: 1px solid rgba(148, 163, 184, 0.2);
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: rgba(148, 163, 184, 0.2);
        }

        .timeline-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #3b82f6;
        }

        .timeline-line {
            width: 2px;
            background: rgba(59, 130, 246, 0.3);
            margin-left: 5px;
        }

        .sketch-preview {
            border-radius: 12px;
            overflow: hidden;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.1);
            aspect-ratio: 16/10;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sketch-preview:hover {
            border-color: #3b82f6;
            transform: scale(1.02);
        }

        .note-bubble {
            background: rgba(251, 191, 36, 0.1);
            border-left: 3px solid #fbbf24;
            border-radius: 0 12px 12px 0;
            padding: 16px;
        }

        /* Canvas for drawing */
        .drawing-canvas {
            background: white;
            border-radius: 12px;
            cursor: crosshair;
        }

        .tool-btn {
            padding: 10px;
            border-radius: 10px;
            border: none;
            background: rgba(148, 163, 184, 0.1);
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tool-btn:hover, .tool-btn.active {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }
    </style>
</head>
<body>
    <div class="min-h-screen p-6">
        <!-- Header -->
        <header class="glass-card p-6 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-6">
                    <a href="/dashboard" class="text-slate-400 hover:text-white transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                        </svg>
                    </a>
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center text-2xl font-bold">
                            MK
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold">Max Kunde</h1>
                            <p class="text-slate-400">Projekt: Smart Home Villa Musterstadt</p>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <span class="badge badge-blue">Premium Kunde</span>
                    <span class="badge badge-green">Projekt Aktiv</span>
                    <button class="btn-secondary">
                        <span class="mr-2">&#128279;</span> Teilen
                    </button>
                    <button class="btn-primary">
                        <span class="mr-2">&#128190;</span> Speichern
                    </button>
                </div>
            </div>
        </header>

        <div class="flex gap-6">
            <!-- Sidebar - Quick Info -->
            <aside class="w-80 space-y-6">
                <!-- Contact Info -->
                <div class="glass-card p-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <span>&#128100;</span> Kontaktdaten
                    </h3>
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between">
                            <span class="text-slate-400">Telefon</span>
                            <a href="tel:+491234567890" class="text-blue-400 hover:underline">+49 123 456 7890</a>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-400">E-Mail</span>
                            <a href="mailto:max@kunde.de" class="text-blue-400 hover:underline">max@kunde.de</a>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-400">Adresse</span>
                            <span class="text-right">Musterstr. 123<br>12345 Musterstadt</span>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-slate-700 flex gap-2">
                        <button class="flex-1 btn-secondary text-sm py-2">
                            <span class="mr-1">&#128222;</span> Anrufen
                        </button>
                        <button class="flex-1 btn-secondary text-sm py-2">
                            <span class="mr-1">&#128172;</span> WhatsApp
                        </button>
                    </div>
                </div>

                <!-- Project Stats -->
                <div class="glass-card p-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <span>&#128200;</span> Projektstatus
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-slate-400">Fortschritt</span>
                                <span class="font-semibold text-blue-400">75%</span>
                            </div>
                            <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
                                <div class="h-full bg-gradient-to-r from-blue-500 to-purple-500 rounded-full" style="width: 75%"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 text-center">
                            <div class="p-3 bg-slate-800/50 rounded-xl">
                                <p class="text-2xl font-bold text-green-400">8</p>
                                <p class="text-xs text-slate-400">Erledigt</p>
                            </div>
                            <div class="p-3 bg-slate-800/50 rounded-xl">
                                <p class="text-2xl font-bold text-amber-400">3</p>
                                <p class="text-xs text-slate-400">Offen</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="glass-card p-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <span>&#9889;</span> Schnellaktionen
                    </h3>
                    <div class="space-y-2">
                        <button class="w-full text-left p-3 rounded-xl bg-slate-800/50 hover:bg-slate-700/50 transition flex items-center gap-3">
                            <span class="text-xl">&#128197;</span>
                            <span>Termin planen</span>
                        </button>
                        <button class="w-full text-left p-3 rounded-xl bg-slate-800/50 hover:bg-slate-700/50 transition flex items-center gap-3">
                            <span class="text-xl">&#128230;</span>
                            <span>Angebot erstellen</span>
                        </button>
                        <button class="w-full text-left p-3 rounded-xl bg-slate-800/50 hover:bg-slate-700/50 transition flex items-center gap-3">
                            <span class="text-xl">&#128176;</span>
                            <span>Rechnung erstellen</span>
                        </button>
                        <button class="w-full text-left p-3 rounded-xl bg-slate-800/50 hover:bg-slate-700/50 transition flex items-center gap-3">
                            <span class="text-xl">&#128231;</span>
                            <span>E-Mail senden</span>
                        </button>
                    </div>
                </div>

                <!-- Internal Notes -->
                <div class="glass-card p-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <span>&#128221;</span> Interne Notizen
                    </h3>
                    <div class="space-y-3">
                        <div class="note-bubble text-sm">
                            <p class="text-amber-200">Kunde bevorzugt Termine nachmittags.</p>
                            <p class="text-xs text-slate-500 mt-1">- Team, 10.12.2024</p>
                        </div>
                        <textarea class="input-field text-sm" rows="2" placeholder="Neue Notiz hinzufugen..."></textarea>
                        <button class="w-full btn-secondary text-sm py-2">+ Notiz hinzufugen</button>
                    </div>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1">
                <!-- Tabs -->
                <div class="glass-card p-2 mb-6">
                    <div class="flex gap-2 flex-wrap">
                        <button class="tab-btn active" data-tab="overview">
                            <span class="mr-2">&#127968;</span> Ubersicht
                        </button>
                        <button class="tab-btn" data-tab="sketches">
                            <span class="mr-2">&#128393;</span> Skizzen & Plane
                        </button>
                        <button class="tab-btn" data-tab="documents">
                            <span class="mr-2">&#128196;</span> Dokumente
                        </button>
                        <button class="tab-btn" data-tab="wishes">
                            <span class="mr-2">&#10024;</span> Kundenwunsche
                        </button>
                        <button class="tab-btn" data-tab="system">
                            <span class="mr-2">&#9881;</span> Systemkonfig
                        </button>
                        <button class="tab-btn" data-tab="timeline">
                            <span class="mr-2">&#128197;</span> Verlauf
                        </button>
                        <button class="tab-btn" data-tab="aiplan">
                            <span class="mr-2">&#129302;</span> AI-Plan
                        </button>
                    </div>
                </div>

                <!-- Tab: Overview -->
                <div class="tab-content active" id="tab-overview">
                    <div class="grid grid-cols-2 gap-6">
                        <!-- Project Summary -->
                        <div class="glass-card p-6">
                            <h3 class="text-lg font-semibold mb-4">Projektubersicht</h3>
                            <div class="space-y-4">
                                <div class="flex justify-between py-2 border-b border-slate-700">
                                    <span class="text-slate-400">Projekt-Nr.</span>
                                    <span class="font-mono">#2024-0042</span>
                                </div>
                                <div class="flex justify-between py-2 border-b border-slate-700">
                                    <span class="text-slate-400">Projekttyp</span>
                                    <span>LOXONE Vollinstallation</span>
                                </div>
                                <div class="flex justify-between py-2 border-b border-slate-700">
                                    <span class="text-slate-400">Gebaude</span>
                                    <span>Einfamilienhaus, 280m<sup>2</sup></span>
                                </div>
                                <div class="flex justify-between py-2 border-b border-slate-700">
                                    <span class="text-slate-400">Startdatum</span>
                                    <span>15.11.2024</span>
                                </div>
                                <div class="flex justify-between py-2 border-b border-slate-700">
                                    <span class="text-slate-400">Geplantes Ende</span>
                                    <span>15.01.2025</span>
                                </div>
                                <div class="flex justify-between py-2">
                                    <span class="text-slate-400">Budgetrahmen</span>
                                    <span class="text-green-400 font-semibold">EUR 45.000</span>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Activity -->
                        <div class="glass-card p-6">
                            <h3 class="text-lg font-semibold mb-4">Letzte Aktivitaten</h3>
                            <div class="space-y-4">
                                <div class="flex gap-3">
                                    <div class="flex flex-col items-center">
                                        <div class="timeline-dot"></div>
                                        <div class="timeline-line flex-1"></div>
                                    </div>
                                    <div class="pb-4">
                                        <p class="font-medium">Elektroplan hochgeladen</p>
                                        <p class="text-sm text-slate-400">Heute, 14:30</p>
                                    </div>
                                </div>
                                <div class="flex gap-3">
                                    <div class="flex flex-col items-center">
                                        <div class="timeline-dot" style="background: #22c55e;"></div>
                                        <div class="timeline-line flex-1"></div>
                                    </div>
                                    <div class="pb-4">
                                        <p class="font-medium">Verkabelung Phase 2 abgeschlossen</p>
                                        <p class="text-sm text-slate-400">Gestern, 16:00</p>
                                    </div>
                                </div>
                                <div class="flex gap-3">
                                    <div class="flex flex-col items-center">
                                        <div class="timeline-dot" style="background: #f59e0b;"></div>
                                        <div class="timeline-line flex-1"></div>
                                    </div>
                                    <div class="pb-4">
                                        <p class="font-medium">Kundenwunsch: Jalousiensteuerung hinzugefugt</p>
                                        <p class="text-sm text-slate-400">20.12.2024</p>
                                    </div>
                                </div>
                                <div class="flex gap-3">
                                    <div class="flex flex-col items-center">
                                        <div class="timeline-dot" style="background: #8b5cf6;"></div>
                                    </div>
                                    <div>
                                        <p class="font-medium">Termin: Installation Lichtsteuerung</p>
                                        <p class="text-sm text-slate-400">28.12.2024, 10:00</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- System Preview -->
                        <div class="glass-card p-6 col-span-2">
                            <h3 class="text-lg font-semibold mb-4">Geplantes System</h3>
                            <div class="grid grid-cols-5 gap-4">
                                <div class="text-center p-4 bg-blue-500/10 rounded-xl border border-blue-500/30">
                                    <span class="text-3xl mb-2 block">&#128161;</span>
                                    <p class="font-medium">Licht</p>
                                    <p class="text-sm text-slate-400">42 Raume</p>
                                </div>
                                <div class="text-center p-4 bg-green-500/10 rounded-xl border border-green-500/30">
                                    <span class="text-3xl mb-2 block">&#127777;</span>
                                    <p class="font-medium">Klima</p>
                                    <p class="text-sm text-slate-400">8 Zonen</p>
                                </div>
                                <div class="text-center p-4 bg-amber-500/10 rounded-xl border border-amber-500/30">
                                    <span class="text-3xl mb-2 block">&#127774;</span>
                                    <p class="font-medium">Jalousien</p>
                                    <p class="text-sm text-slate-400">24 Fenster</p>
                                </div>
                                <div class="text-center p-4 bg-purple-500/10 rounded-xl border border-purple-500/30">
                                    <span class="text-3xl mb-2 block">&#128274;</span>
                                    <p class="font-medium">Sicherheit</p>
                                    <p class="text-sm text-slate-400">12 Sensoren</p>
                                </div>
                                <div class="text-center p-4 bg-cyan-500/10 rounded-xl border border-cyan-500/30">
                                    <span class="text-3xl mb-2 block">&#127925;</span>
                                    <p class="font-medium">Multiroom</p>
                                    <p class="text-sm text-slate-400">6 Zonen</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab: Sketches -->
                <div class="tab-content" id="tab-sketches">
                    <div class="grid grid-cols-3 gap-6">
                        <!-- Upload Zone -->
                        <div class="col-span-3">
                            <div class="upload-zone" id="sketchUploadZone">
                                <input type="file" id="sketchInput" class="hidden" accept="image/*,.pdf,.dwg" multiple>
                                <div class="text-6xl mb-4">&#128393;</div>
                                <p class="text-lg font-medium mb-2">Skizzen & Plane hochladen</p>
                                <p class="text-slate-400 text-sm mb-4">Ziehen Sie Dateien hierher oder klicken Sie zum Auswahlen</p>
                                <p class="text-xs text-slate-500">Unterstutzt: JPG, PNG, PDF, DWG (max. 50MB)</p>
                            </div>
                        </div>

                        <!-- Drawing Tools -->
                        <div class="col-span-3 glass-card p-4">
                            <div class="flex items-center justify-between">
                                <div class="flex gap-2">
                                    <button class="tool-btn active" title="Stift">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                                        </svg>
                                    </button>
                                    <button class="tool-btn" title="Rechteck">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                                        </svg>
                                    </button>
                                    <button class="tool-btn" title="Text">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                        </svg>
                                    </button>
                                    <button class="tool-btn" title="Markierung">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                        </svg>
                                    </button>
                                    <div class="w-px h-8 bg-slate-600 mx-2"></div>
                                    <input type="color" value="#3b82f6" class="w-8 h-8 rounded cursor-pointer">
                                    <select class="input-field py-1 px-2 w-20 text-sm">
                                        <option>2px</option>
                                        <option>4px</option>
                                        <option>6px</option>
                                    </select>
                                </div>
                                <div class="flex gap-2">
                                    <button class="btn-secondary text-sm py-2">Ruckgangig</button>
                                    <button class="btn-primary text-sm py-2">Speichern</button>
                                </div>
                            </div>
                        </div>

                        <!-- Sketch Grid -->
                        <div class="sketch-preview">
                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 250'%3E%3Crect fill='%231e293b' width='400' height='250'/%3E%3Ctext x='200' y='125' text-anchor='middle' fill='%2394a3b8' font-family='sans-serif' font-size='14'%3EGrundriss EG%3C/text%3E%3C/svg%3E" alt="Grundriss EG" class="w-full h-full object-cover">
                        </div>
                        <div class="sketch-preview">
                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 250'%3E%3Crect fill='%231e293b' width='400' height='250'/%3E%3Ctext x='200' y='125' text-anchor='middle' fill='%2394a3b8' font-family='sans-serif' font-size='14'%3EGrundriss OG%3C/text%3E%3C/svg%3E" alt="Grundriss OG" class="w-full h-full object-cover">
                        </div>
                        <div class="sketch-preview">
                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 250'%3E%3Crect fill='%231e293b' width='400' height='250'/%3E%3Ctext x='200' y='125' text-anchor='middle' fill='%2394a3b8' font-family='sans-serif' font-size='14'%3EElektroplan%3C/text%3E%3C/svg%3E" alt="Elektroplan" class="w-full h-full object-cover">
                        </div>

                        <!-- Annotations Legend -->
                        <div class="col-span-3 glass-card p-4">
                            <h4 class="font-semibold mb-3">Legende der Markierungen</h4>
                            <div class="flex gap-6 text-sm">
                                <span class="flex items-center gap-2">
                                    <span class="w-4 h-4 rounded-full bg-blue-500"></span> Lichtauslass
                                </span>
                                <span class="flex items-center gap-2">
                                    <span class="w-4 h-4 rounded-full bg-green-500"></span> Steckdose
                                </span>
                                <span class="flex items-center gap-2">
                                    <span class="w-4 h-4 rounded-full bg-amber-500"></span> Schalter
                                </span>
                                <span class="flex items-center gap-2">
                                    <span class="w-4 h-4 rounded-full bg-purple-500"></span> Sensor
                                </span>
                                <span class="flex items-center gap-2">
                                    <span class="w-4 h-4 rounded-full bg-red-500"></span> Achtung
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab: Documents -->
                <div class="tab-content" id="tab-documents">
                    <div class="space-y-6">
                        <!-- Upload Zone -->
                        <div class="upload-zone" id="docUploadZone">
                            <input type="file" id="docInput" class="hidden" accept=".pdf,.doc,.docx,.xls,.xlsx" multiple>
                            <div class="text-6xl mb-4">&#128196;</div>
                            <p class="text-lg font-medium mb-2">Dokumente hochladen</p>
                            <p class="text-slate-400 text-sm">Angebote, Vertrage, Plane, etc.</p>
                        </div>

                        <!-- Document Categories -->
                        <div class="grid grid-cols-4 gap-4">
                            <button class="glass-card p-4 text-center hover:border-blue-500/50 transition">
                                <span class="text-2xl mb-2 block">&#128203;</span>
                                <span class="text-sm">Angebote</span>
                                <span class="badge badge-blue ml-2">2</span>
                            </button>
                            <button class="glass-card p-4 text-center hover:border-blue-500/50 transition">
                                <span class="text-2xl mb-2 block">&#128220;</span>
                                <span class="text-sm">Vertrage</span>
                                <span class="badge badge-green ml-2">1</span>
                            </button>
                            <button class="glass-card p-4 text-center hover:border-blue-500/50 transition">
                                <span class="text-2xl mb-2 block">&#128208;</span>
                                <span class="text-sm">Plane</span>
                                <span class="badge badge-purple ml-2">4</span>
                            </button>
                            <button class="glass-card p-4 text-center hover:border-blue-500/50 transition">
                                <span class="text-2xl mb-2 block">&#128176;</span>
                                <span class="text-sm">Rechnungen</span>
                                <span class="badge badge-amber ml-2">1</span>
                            </button>
                        </div>

                        <!-- Document List -->
                        <div class="glass-card p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold">Alle Dokumente</h3>
                                <input type="search" class="input-field w-64" placeholder="Dokumente suchen...">
                            </div>
                            <div class="space-y-3">
                                <div class="file-item">
                                    <div class="w-12 h-12 bg-red-500/20 rounded-xl flex items-center justify-center text-xl">&#128213;</div>
                                    <div class="flex-1">
                                        <p class="font-medium">Angebot_2024-0042.pdf</p>
                                        <p class="text-sm text-slate-400">Angebot - 2.4 MB - 15.11.2024</p>
                                    </div>
                                    <span class="badge badge-green">Fur Kunde sichtbar</span>
                                    <div class="flex gap-2">
                                        <button class="tool-btn" title="Vorschau">&#128065;</button>
                                        <button class="tool-btn" title="Download">&#128229;</button>
                                        <button class="tool-btn" title="Teilen">&#128279;</button>
                                    </div>
                                </div>
                                <div class="file-item">
                                    <div class="w-12 h-12 bg-blue-500/20 rounded-xl flex items-center justify-center text-xl">&#128208;</div>
                                    <div class="flex-1">
                                        <p class="font-medium">Elektroplanung_v3.pdf</p>
                                        <p class="text-sm text-slate-400">Plan - 8.1 MB - 20.11.2024</p>
                                    </div>
                                    <span class="badge badge-green">Fur Kunde sichtbar</span>
                                    <div class="flex gap-2">
                                        <button class="tool-btn" title="Vorschau">&#128065;</button>
                                        <button class="tool-btn" title="Download">&#128229;</button>
                                        <button class="tool-btn" title="Teilen">&#128279;</button>
                                    </div>
                                </div>
                                <div class="file-item">
                                    <div class="w-12 h-12 bg-green-500/20 rounded-xl flex items-center justify-center text-xl">&#128209;</div>
                                    <div class="flex-1">
                                        <p class="font-medium">LOXONE_Config.loxcc</p>
                                        <p class="text-sm text-slate-400">Konfiguration - 1.2 MB - 10.12.2024</p>
                                    </div>
                                    <span class="badge badge-amber">Nur intern</span>
                                    <div class="flex gap-2">
                                        <button class="tool-btn" title="Vorschau">&#128065;</button>
                                        <button class="tool-btn" title="Download">&#128229;</button>
                                        <button class="tool-btn" title="Teilen">&#128279;</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab: Customer Wishes -->
                <div class="tab-content" id="tab-wishes">
                    <div class="space-y-6">
                        <!-- Add New Wish -->
                        <div class="glass-card p-6">
                            <h3 class="text-lg font-semibold mb-4">Neuen Kundenwunsch erfassen</h3>
                            <div class="grid grid-cols-3 gap-4">
                                <input type="text" class="input-field col-span-2" placeholder="Beschreibung des Wunsches...">
                                <select class="input-field">
                                    <option>Prioritat wahlen</option>
                                    <option value="high">Hoch - Muss umgesetzt werden</option>
                                    <option value="medium">Mittel - Wunschenswert</option>
                                    <option value="low">Niedrig - Nice-to-have</option>
                                </select>
                            </div>
                            <div class="mt-4 flex gap-4">
                                <select class="input-field flex-1">
                                    <option>Kategorie</option>
                                    <option>Licht</option>
                                    <option>Klima</option>
                                    <option>Sicherheit</option>
                                    <option>Multimedia</option>
                                    <option>Sonstiges</option>
                                </select>
                                <input type="text" class="input-field flex-1" placeholder="Geschatzte Kosten (optional)">
                                <button class="btn-primary">+ Hinzufugen</button>
                            </div>
                        </div>

                        <!-- Wish List -->
                        <div class="glass-card p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold">Kundenwunsche (11)</h3>
                                <div class="flex gap-2">
                                    <button class="btn-secondary text-sm">Alle</button>
                                    <button class="btn-secondary text-sm">Offen</button>
                                    <button class="btn-secondary text-sm">Erledigt</button>
                                </div>
                            </div>

                            <div class="space-y-3">
                                <!-- Completed wish -->
                                <div class="wish-item completed">
                                    <div class="flex items-start gap-4">
                                        <input type="checkbox" checked class="mt-1 w-5 h-5 rounded accent-green-500">
                                        <div class="flex-1">
                                            <p class="font-medium line-through text-slate-400">Dimmbares Licht in allen Wohnraumen</p>
                                            <div class="flex gap-2 mt-2">
                                                <span class="badge badge-blue">Licht</span>
                                                <span class="badge badge-green">Erledigt</span>
                                            </div>
                                        </div>
                                        <span class="text-sm text-slate-500">EUR 1.200</span>
                                    </div>
                                </div>

                                <!-- Open wish - High priority -->
                                <div class="wish-item">
                                    <div class="flex items-start gap-4">
                                        <input type="checkbox" class="mt-1 w-5 h-5 rounded">
                                        <div class="flex-1">
                                            <p class="font-medium">Automatische Jalousiensteuerung nach Sonnenstand</p>
                                            <p class="text-sm text-slate-400 mt-1">Kunde mochte, dass Jalousien automatisch auf Sonneneinstrahlung reagieren</p>
                                            <div class="flex gap-2 mt-2">
                                                <span class="badge badge-amber">Jalousien</span>
                                                <span class="badge" style="background: rgba(239, 68, 68, 0.2); color: #f87171;">Hohe Prioritat</span>
                                            </div>
                                        </div>
                                        <span class="text-sm text-green-400">EUR 800</span>
                                    </div>
                                </div>

                                <!-- Open wish -->
                                <div class="wish-item">
                                    <div class="flex items-start gap-4">
                                        <input type="checkbox" class="mt-1 w-5 h-5 rounded">
                                        <div class="flex-1">
                                            <p class="font-medium">Multiroom-Audio mit Sonos Integration</p>
                                            <div class="flex gap-2 mt-2">
                                                <span class="badge badge-purple">Multimedia</span>
                                                <span class="badge badge-amber">Mittlere Prioritat</span>
                                            </div>
                                        </div>
                                        <span class="text-sm text-green-400">EUR 2.400</span>
                                    </div>
                                </div>

                                <!-- Open wish -->
                                <div class="wish-item">
                                    <div class="flex items-start gap-4">
                                        <input type="checkbox" class="mt-1 w-5 h-5 rounded">
                                        <div class="flex-1">
                                            <p class="font-medium">Prasenzmelder fur Flure und Treppenhause</p>
                                            <div class="flex gap-2 mt-2">
                                                <span class="badge badge-blue">Licht</span>
                                                <span class="badge badge-blue">Niedrige Prioritat</span>
                                            </div>
                                        </div>
                                        <span class="text-sm text-green-400">EUR 450</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Cost Summary -->
                        <div class="glass-card p-6">
                            <h3 class="text-lg font-semibold mb-4">Kostenubersicht Wunsche</h3>
                            <div class="grid grid-cols-3 gap-6">
                                <div class="text-center p-4 bg-green-500/10 rounded-xl">
                                    <p class="text-2xl font-bold text-green-400">EUR 8.200</p>
                                    <p class="text-sm text-slate-400">Bereits umgesetzt</p>
                                </div>
                                <div class="text-center p-4 bg-amber-500/10 rounded-xl">
                                    <p class="text-2xl font-bold text-amber-400">EUR 3.650</p>
                                    <p class="text-sm text-slate-400">Offen geplant</p>
                                </div>
                                <div class="text-center p-4 bg-blue-500/10 rounded-xl">
                                    <p class="text-2xl font-bold text-blue-400">EUR 11.850</p>
                                    <p class="text-sm text-slate-400">Gesamt</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab: System Config -->
                <div class="tab-content" id="tab-system">
                    <div class="space-y-6">
                        <div class="glass-card p-6">
                            <h3 class="text-lg font-semibold mb-4">Masgeschneiderte Systemkonfiguration</h3>
                            <p class="text-slate-400 mb-6">Wahlen Sie die Module fur das Smart Home System des Kunden.</p>

                            <div class="grid grid-cols-3 gap-4">
                                <!-- Module Cards -->
                                <div class="config-module selected">
                                    <div class="flex justify-between items-start mb-3">
                                        <span class="text-3xl">&#128161;</span>
                                        <input type="checkbox" checked class="w-5 h-5 rounded accent-purple-500">
                                    </div>
                                    <h4 class="font-semibold mb-1">Lichtsteuerung</h4>
                                    <p class="text-sm text-slate-400 mb-3">Dimmbar, Szenen, Zeitsteuerung</p>
                                    <div class="flex justify-between text-sm">
                                        <span class="text-slate-400">42 Raume</span>
                                        <span class="text-green-400">EUR 4.200</span>
                                    </div>
                                </div>

                                <div class="config-module selected">
                                    <div class="flex justify-between items-start mb-3">
                                        <span class="text-3xl">&#127777;</span>
                                        <input type="checkbox" checked class="w-5 h-5 rounded accent-purple-500">
                                    </div>
                                    <h4 class="font-semibold mb-1">Klimasteuerung</h4>
                                    <p class="text-sm text-slate-400 mb-3">Heizung, Kuhlung, Luftung</p>
                                    <div class="flex justify-between text-sm">
                                        <span class="text-slate-400">8 Zonen</span>
                                        <span class="text-green-400">EUR 3.800</span>
                                    </div>
                                </div>

                                <div class="config-module selected">
                                    <div class="flex justify-between items-start mb-3">
                                        <span class="text-3xl">&#127774;</span>
                                        <input type="checkbox" checked class="w-5 h-5 rounded accent-purple-500">
                                    </div>
                                    <h4 class="font-semibold mb-1">Jalousiensteuerung</h4>
                                    <p class="text-sm text-slate-400 mb-3">Automatik, Sonnenstand, Szenen</p>
                                    <div class="flex justify-between text-sm">
                                        <span class="text-slate-400">24 Fenster</span>
                                        <span class="text-green-400">EUR 2.400</span>
                                    </div>
                                </div>

                                <div class="config-module selected">
                                    <div class="flex justify-between items-start mb-3">
                                        <span class="text-3xl">&#128274;</span>
                                        <input type="checkbox" checked class="w-5 h-5 rounded accent-purple-500">
                                    </div>
                                    <h4 class="font-semibold mb-1">Sicherheitssystem</h4>
                                    <p class="text-sm text-slate-400 mb-3">Alarm, Kameras, Zutrittskontrolle</p>
                                    <div class="flex justify-between text-sm">
                                        <span class="text-slate-400">12 Sensoren</span>
                                        <span class="text-green-400">EUR 3.200</span>
                                    </div>
                                </div>

                                <div class="config-module selected">
                                    <div class="flex justify-between items-start mb-3">
                                        <span class="text-3xl">&#127925;</span>
                                        <input type="checkbox" checked class="w-5 h-5 rounded accent-purple-500">
                                    </div>
                                    <h4 class="font-semibold mb-1">Multiroom Audio</h4>
                                    <p class="text-sm text-slate-400 mb-3">Sonos, Streaming, Intercom</p>
                                    <div class="flex justify-between text-sm">
                                        <span class="text-slate-400">6 Zonen</span>
                                        <span class="text-green-400">EUR 2.400</span>
                                    </div>
                                </div>

                                <div class="config-module">
                                    <div class="flex justify-between items-start mb-3">
                                        <span class="text-3xl">&#127793;</span>
                                        <input type="checkbox" class="w-5 h-5 rounded">
                                    </div>
                                    <h4 class="font-semibold mb-1">Gartenbewasserung</h4>
                                    <p class="text-sm text-slate-400 mb-3">Automatik, Wetter, Zonen</p>
                                    <div class="flex justify-between text-sm">
                                        <span class="text-slate-400">Optional</span>
                                        <span class="text-slate-400">EUR 1.800</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- System Total -->
                        <div class="glass-card p-6">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h3 class="text-lg font-semibold">Systemkonfiguration Gesamt</h3>
                                    <p class="text-slate-400">5 Module ausgewahlt</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-3xl font-bold text-green-400">EUR 16.000</p>
                                    <p class="text-sm text-slate-400">zzgl. Installation</p>
                                </div>
                            </div>
                            <div class="mt-6 flex gap-4">
                                <button class="btn-secondary flex-1">PDF exportieren</button>
                                <button class="btn-secondary flex-1">An Kunde senden</button>
                                <button class="btn-primary flex-1">Angebot erstellen</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab: Timeline -->
                <div class="tab-content" id="tab-timeline">
                    <div class="glass-card p-6">
                        <h3 class="text-lg font-semibold mb-6">Projektverlauf</h3>
                        <div class="space-y-6">
                            <div class="flex gap-4">
                                <div class="flex flex-col items-center">
                                    <div class="w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center text-green-400">&#10003;</div>
                                    <div class="w-0.5 flex-1 bg-slate-700 my-2"></div>
                                </div>
                                <div class="flex-1 pb-6">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="font-semibold">Projekt angelegt</p>
                                            <p class="text-sm text-slate-400">Erstkontakt und Anforderungsaufnahme</p>
                                        </div>
                                        <span class="text-sm text-slate-500">15.11.2024</span>
                                    </div>
                                </div>
                            </div>

                            <div class="flex gap-4">
                                <div class="flex flex-col items-center">
                                    <div class="w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center text-green-400">&#10003;</div>
                                    <div class="w-0.5 flex-1 bg-slate-700 my-2"></div>
                                </div>
                                <div class="flex-1 pb-6">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="font-semibold">Angebot erstellt & angenommen</p>
                                            <p class="text-sm text-slate-400">Angebot uber EUR 45.000 akzeptiert</p>
                                        </div>
                                        <span class="text-sm text-slate-500">20.11.2024</span>
                                    </div>
                                </div>
                            </div>

                            <div class="flex gap-4">
                                <div class="flex flex-col items-center">
                                    <div class="w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center text-green-400">&#10003;</div>
                                    <div class="w-0.5 flex-1 bg-slate-700 my-2"></div>
                                </div>
                                <div class="flex-1 pb-6">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="font-semibold">Planungsphase abgeschlossen</p>
                                            <p class="text-sm text-slate-400">Alle Plane und Konfigurationen finalisiert</p>
                                        </div>
                                        <span class="text-sm text-slate-500">01.12.2024</span>
                                    </div>
                                </div>
                            </div>

                            <div class="flex gap-4">
                                <div class="flex flex-col items-center">
                                    <div class="w-10 h-10 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-400">&#9881;</div>
                                    <div class="w-0.5 flex-1 bg-slate-700 my-2"></div>
                                </div>
                                <div class="flex-1 pb-6">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="font-semibold">Installation laufend</p>
                                            <p class="text-sm text-slate-400">Verkabelung 100% - Gerate 60%</p>
                                        </div>
                                        <span class="text-sm text-blue-400">Aktuell</span>
                                    </div>
                                </div>
                            </div>

                            <div class="flex gap-4">
                                <div class="flex flex-col items-center">
                                    <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-slate-400">&#9711;</div>
                                    <div class="w-0.5 flex-1 bg-slate-700 my-2"></div>
                                </div>
                                <div class="flex-1 pb-6">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="font-semibold text-slate-400">Programmierung</p>
                                            <p class="text-sm text-slate-500">LOXONE Config und Szenen</p>
                                        </div>
                                        <span class="text-sm text-slate-500">Geplant: 05.01.2025</span>
                                    </div>
                                </div>
                            </div>

                            <div class="flex gap-4">
                                <div class="flex flex-col items-center">
                                    <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-slate-400">&#9711;</div>
                                </div>
                                <div class="flex-1">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="font-semibold text-slate-400">Abnahme & Einweisung</p>
                                            <p class="text-sm text-slate-500">Ubergabe an Kunde</p>
                                        </div>
                                        <span class="text-sm text-slate-500">Geplant: 15.01.2025</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab: AI Plan -->
                <div class="tab-content" id="tab-aiplan">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- AI Analysis -->
                        <div class="glass-card p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold flex items-center gap-2">
                                    <span>&#129302;</span> AI-Analyse
                                </h3>
                                <span id="ai-status" class="px-3 py-1 rounded-full text-xs font-medium bg-slate-700 text-slate-400">
                                    Warte auf Daten
                                </span>
                            </div>
                            <div id="ai-analysis-content" class="space-y-4">
                                <div class="bg-slate-800/50 rounded-lg p-4 text-center text-slate-400">
                                    <p>Klicken Sie auf "Analyse starten" um die AI-Analyse zu beginnen</p>
                                </div>
                            </div>
                            <div class="mt-4 flex gap-2">
                                <button onclick="runAIAnalysis()" class="flex-1 bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white font-medium py-2 px-4 rounded-lg transition-all">
                                    &#9658; Analyse starten
                                </button>
                                <button onclick="runExtendedPipeline()" class="flex-1 bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-600 hover:to-teal-600 text-white font-medium py-2 px-4 rounded-lg transition-all">
                                    &#9889; Vollstandiger Plan + Subunternehmer
                                </button>
                            </div>
                        </div>

                        <!-- Project Plan -->
                        <div class="glass-card p-6">
                            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                <span>&#128203;</span> Projektplan
                            </h3>
                            <div id="ai-projectplan-content" class="space-y-4">
                                <div class="bg-slate-800/50 rounded-lg p-4 text-center text-slate-400">
                                    <p>Noch kein Projektplan generiert</p>
                                </div>
                            </div>
                        </div>

                        <!-- Cost Estimate -->
                        <div class="glass-card p-6">
                            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                <span>&#128176;</span> Kostenvoranschlag
                            </h3>
                            <div id="ai-costestimate-content" class="space-y-4">
                                <div class="bg-slate-800/50 rounded-lg p-4 text-center text-slate-400">
                                    <p>Noch keine Kostenschatzung verfugbar</p>
                                </div>
                            </div>
                        </div>

                        <!-- System Recommendation -->
                        <div class="glass-card p-6">
                            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                <span>&#9881;</span> Systemempfehlung
                            </h3>
                            <div id="ai-systemconfig-content" class="space-y-4">
                                <div class="bg-slate-800/50 rounded-lg p-4 text-center text-slate-400">
                                    <p>Noch keine Konfigurationsempfehlung</p>
                                </div>
                            </div>
                        </div>

                        <!-- Subcontractor Coordination -->
                        <div class="glass-card p-6">
                            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                <span>&#128119;</span> Subunternehmer-Koordination
                            </h3>
                            <div id="ai-subcontractor-content" class="space-y-4">
                                <div class="bg-slate-800/50 rounded-lg p-4 text-center text-slate-400">
                                    <p>Noch keine Subunternehmer geplant</p>
                                </div>
                            </div>
                        </div>

                        <!-- Communication Schedule -->
                        <div class="glass-card p-6">
                            <h3 class="text-lg font-semibold mb-4 flex items-center justify-between">
                                <span class="flex items-center gap-2">
                                    <span>&#128222;</span> Kommunikationsplan
                                </span>
                                <span id="notifications-badge" class="hidden px-2 py-1 bg-blue-500/20 text-blue-400 rounded-full text-xs font-medium">
                                    <span id="notifications-count">0</span> Benachrichtigungen geplant
                                </span>
                            </h3>
                            <div id="ai-communication-content" class="space-y-4">
                                <div class="bg-slate-800/50 rounded-lg p-4 text-center text-slate-400">
                                    <p>Noch kein Kommunikationsplan erstellt</p>
                                </div>
                            </div>
                        </div>

                        <!-- Scheduled Notifications -->
                        <div class="glass-card p-6">
                            <h3 class="text-lg font-semibold mb-4 flex items-center justify-between">
                                <span class="flex items-center gap-2">
                                    <span>&#128276;</span> Geplante Benachrichtigungen
                                </span>
                                <button onclick="loadNotifications()" class="text-xs px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors">
                                    &#8635; Aktualisieren
                                </button>
                            </h3>
                            <div id="notifications-list" class="space-y-3">
                                <div class="bg-slate-800/50 rounded-lg p-4 text-center text-slate-400">
                                    <p>Lade Benachrichtigungen...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Remove active from all tabs
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                // Add active to clicked tab
                btn.classList.add('active');
                const tabId = 'tab-' + btn.dataset.tab;
                document.getElementById(tabId).classList.add('active');
            });
        });

        // File upload zones
        ['sketchUploadZone', 'docUploadZone'].forEach(zoneId => {
            const zone = document.getElementById(zoneId);
            if (!zone) return;

            const input = zone.querySelector('input[type="file"]');

            zone.addEventListener('click', () => input.click());

            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('dragover');
            });

            zone.addEventListener('dragleave', () => {
                zone.classList.remove('dragover');
            });

            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                handleFiles(files, zoneId);
            });

            input.addEventListener('change', (e) => {
                handleFiles(e.target.files, zoneId);
            });
        });

        function handleFiles(files, zoneType) {
            console.log('Uploading files:', files, 'to', zoneType);
            // TODO: Implement actual file upload via API
            alert(`${files.length} Datei(en) werden hochgeladen...`);
        }

        // Config module selection
        document.querySelectorAll('.config-module').forEach(module => {
            module.addEventListener('click', () => {
                const checkbox = module.querySelector('input[type="checkbox"]');
                checkbox.checked = !checkbox.checked;
                module.classList.toggle('selected', checkbox.checked);
            });
        });

        // 
        // AI PLANNING FUNCTIONS
        // 

        // Get customer ID from URL
        function getCustomerId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('customerId') || params.get('id') || 'demo-customer';
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        // Update AI status badge
        function updateAIStatus(status, color) {
            const statusEl = document.getElementById('ai-status');
            const colors = {
                'slate': 'bg-slate-700 text-slate-400',
                'blue': 'bg-blue-500/20 text-blue-400',
                'green': 'bg-green-500/20 text-green-400',
                'yellow': 'bg-yellow-500/20 text-yellow-400',
                'red': 'bg-red-500/20 text-red-400'
            };
            statusEl.className = 'px-3 py-1 rounded-full text-xs font-medium ' + (colors[color] || colors.slate);
            statusEl.textContent = status;
        }

        // Run AI Analysis
        async function runAIAnalysis() {
            const customerId = getCustomerId();
            updateAIStatus('Analysiere...', 'blue');

            try {
                const response = await fetch('/api/customer/' + customerId + '/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success && data.analysis) {
                    updateAIStatus('Analysiert', 'green');
                    renderAnalysis(data.analysis);
                } else {
                    throw new Error(data.error || 'Analyse fehlgeschlagen');
                }
            } catch (error) {
                updateAIStatus('Fehler', 'red');
                console.error('AI Analysis error:', error);
                alert('Fehler bei der AI-Analyse: ' + error.message);
            }
        }

        // Run Full Pipeline
        async function runFullPipeline() {
            const customerId = getCustomerId();
            updateAIStatus('Pipeline lauft...', 'yellow');

            try {
                const response = await fetch('/api/customer/' + customerId + '/full-pipeline', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success) {
                    updateAIStatus('Vollstandig', 'green');
                    if (data.analysis) renderAnalysis(data.analysis);
                    if (data.projectPlan) renderProjectPlan(data.projectPlan);
                    if (data.costEstimate) renderCostEstimate(data.costEstimate);
                    if (data.suggestedConfig) renderSystemConfig(data.suggestedConfig);
                } else {
                    throw new Error(data.error || 'Pipeline fehlgeschlagen');
                }
            } catch (error) {
                updateAIStatus('Fehler', 'red');
                console.error('Full pipeline error:', error);
                alert('Fehler bei der Pipeline: ' + error.message);
            }
        }

        // Run Extended Pipeline (includes subcontractors and communication)
        async function runExtendedPipeline() {
            const customerId = getCustomerId();
            updateAIStatus('Erweiterte Pipeline...', 'yellow');

            try {
                const response = await fetch('/api/customer/' + customerId + '/extended-pipeline', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success) {
                    updateAIStatus('Vollstandig', 'green');
                    if (data.analysis) renderAnalysis(data.analysis);
                    if (data.projectPlan) renderProjectPlan(data.projectPlan);
                    if (data.costEstimate) renderCostEstimate(data.costEstimate);
                    if (data.suggestedConfig) renderSystemConfig(data.suggestedConfig);
                    if (data.subcontractorPlan) renderSubcontractorPlan(data.subcontractorPlan);
                    if (data.communicationSchedule) renderCommunicationSchedule(data.communicationSchedule);

                    // Show notifications badge if notifications were scheduled
                    if (data.notificationsScheduled > 0) {
                        const badge = document.getElementById('notifications-badge');
                        const count = document.getElementById('notifications-count');
                        if (badge && count) {
                            count.textContent = data.notificationsScheduled;
                            badge.classList.remove('hidden');
                        }
                    }
                } else {
                    throw new Error(data.error || 'Extended pipeline fehlgeschlagen');
                }
            } catch (error) {
                updateAIStatus('Fehler', 'red');
                console.error('Extended pipeline error:', error);
                alert('Fehler bei der erweiterten Pipeline: ' + error.message);
            }
        }

        // Render AI Analysis using safe DOM methods
        function renderAnalysis(analysis) {
            const container = document.getElementById('ai-analysis-content');
            container.textContent = '';

            const feasibilityColors = { high: 'text-green-400', medium: 'text-yellow-400', low: 'text-red-400' };
            const feasibilityText = { high: 'Hoch', medium: 'Mittel', low: 'Niedrig' };

            // Summary box
            const summaryBox = document.createElement('div');
            summaryBox.className = 'bg-slate-800/50 rounded-lg p-4';
            const summaryTitle = document.createElement('h4');
            summaryTitle.className = 'font-medium mb-2';
            summaryTitle.textContent = 'Zusammenfassung';
            const summaryText = document.createElement('p');
            summaryText.className = 'text-slate-300 text-sm';
            summaryText.textContent = analysis.summary || 'Keine Zusammenfassung';
            summaryBox.appendChild(summaryTitle);
            summaryBox.appendChild(summaryText);
            container.appendChild(summaryBox);

            // Stats row
            const statsRow = document.createElement('div');
            statsRow.className = 'flex gap-4';

            const feasibilityBox = document.createElement('div');
            feasibilityBox.className = 'flex-1 bg-slate-800/50 rounded-lg p-3 text-center';
            const feasLabel = document.createElement('p');
            feasLabel.className = 'text-xs text-slate-400 mb-1';
            feasLabel.textContent = 'Machbarkeit';
            const feasValue = document.createElement('p');
            feasValue.className = 'font-semibold ' + (feasibilityColors[analysis.feasibility] || 'text-slate-400');
            feasValue.textContent = feasibilityText[analysis.feasibility] || 'Unbekannt';
            feasibilityBox.appendChild(feasLabel);
            feasibilityBox.appendChild(feasValue);

            const challengesBox = document.createElement('div');
            challengesBox.className = 'flex-1 bg-slate-800/50 rounded-lg p-3 text-center';
            const chalLabel = document.createElement('p');
            chalLabel.className = 'text-xs text-slate-400 mb-1';
            chalLabel.textContent = 'Herausforderungen';
            const chalValue = document.createElement('p');
            chalValue.className = 'font-semibold';
            chalValue.textContent = (analysis.challenges || []).length.toString();
            challengesBox.appendChild(chalLabel);
            challengesBox.appendChild(chalValue);

            statsRow.appendChild(feasibilityBox);
            statsRow.appendChild(challengesBox);
            container.appendChild(statsRow);

            // Recommendations
            if (analysis.recommendations && analysis.recommendations.length > 0) {
                const recBox = document.createElement('div');
                recBox.className = 'bg-slate-800/50 rounded-lg p-4';
                const recTitle = document.createElement('h4');
                recTitle.className = 'font-medium mb-2';
                recTitle.textContent = 'Empfehlungen';
                recBox.appendChild(recTitle);
                const recList = document.createElement('ul');
                recList.className = 'text-sm text-slate-300 space-y-1';
                analysis.recommendations.forEach(function(r) {
                    const li = document.createElement('li');
                    li.textContent = '\u2022 ' + r;
                    recList.appendChild(li);
                });
                recBox.appendChild(recList);
                container.appendChild(recBox);
            }
        }

        // Render Project Plan using safe DOM methods
        function renderProjectPlan(plan) {
            const container = document.getElementById('ai-projectplan-content');
            container.textContent = '';

            const headerBox = document.createElement('div');
            headerBox.className = 'bg-slate-800/50 rounded-lg p-4';
            const title = document.createElement('h4');
            title.className = 'font-medium mb-2';
            title.textContent = plan.name || 'Projektplan';
            headerBox.appendChild(title);
            if (plan.description) {
                const desc = document.createElement('p');
                desc.className = 'text-slate-300 text-sm mb-4';
                desc.textContent = plan.description;
                headerBox.appendChild(desc);
            }
            container.appendChild(headerBox);

            if (plan.milestones && plan.milestones.length > 0) {
                const milestonesDiv = document.createElement('div');
                milestonesDiv.className = 'space-y-3';
                plan.milestones.forEach(function(m, i) {
                    const mBox = document.createElement('div');
                    mBox.className = 'bg-slate-800/50 rounded-lg p-3';
                    const mHeader = document.createElement('div');
                    mHeader.className = 'flex justify-between items-center mb-2';
                    const mTitle = document.createElement('span');
                    mTitle.className = 'font-medium text-sm';
                    mTitle.textContent = (i + 1) + '. ' + m.phase;
                    mHeader.appendChild(mTitle);
                    mBox.appendChild(mHeader);

                    if (m.tasks && m.tasks.length > 0) {
                        const taskList = document.createElement('ul');
                        taskList.className = 'text-xs text-slate-400 space-y-1';
                        m.tasks.slice(0, 3).forEach(function(t) {
                            const li = document.createElement('li');
                            li.textContent = '\u2713 ' + t;
                            taskList.appendChild(li);
                        });
                        mBox.appendChild(taskList);
                    }
                    milestonesDiv.appendChild(mBox);
                });
                container.appendChild(milestonesDiv);
            }

            if (plan.keyDeliverables && plan.keyDeliverables.length > 0) {
                const delBox = document.createElement('div');
                delBox.className = 'bg-emerald-500/10 border border-emerald-500/20 rounded-lg p-3';
                const delLabel = document.createElement('p');
                delLabel.className = 'text-xs text-emerald-400 font-medium mb-1';
                delLabel.textContent = 'Hauptergebnisse';
                const delText = document.createElement('p');
                delText.className = 'text-sm';
                delText.textContent = plan.keyDeliverables.join(', ');
                delBox.appendChild(delLabel);
                delBox.appendChild(delText);
                container.appendChild(delBox);
            }
        }

        // Render Cost Estimate using safe DOM methods
        function renderCostEstimate(estimate) {
            const container = document.getElementById('ai-costestimate-content');
            container.textContent = '';

            const formatCurrency = function(val) {
                return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(val || 0);
            };

            if (estimate.components && estimate.components.length > 0) {
                const tableBox = document.createElement('div');
                tableBox.className = 'bg-slate-800/50 rounded-lg p-4 max-h-48 overflow-y-auto';
                const table = document.createElement('table');
                table.className = 'w-full text-sm';

                const thead = document.createElement('thead');
                thead.className = 'text-slate-400 text-xs';
                const headerRow = document.createElement('tr');
                ['Komponente', 'Anzahl', 'Gesamt'].forEach(function(text, idx) {
                    const th = document.createElement('th');
                    th.className = idx === 0 ? 'text-left pb-2' : 'text-right pb-2';
                    th.textContent = text;
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);
                table.appendChild(thead);

                const tbody = document.createElement('tbody');
                tbody.className = 'text-slate-300';
                estimate.components.slice(0, 8).forEach(function(c) {
                    const row = document.createElement('tr');
                    row.className = 'border-t border-slate-700';

                    const tdName = document.createElement('td');
                    tdName.className = 'py-2';
                    tdName.textContent = c.name;
                    row.appendChild(tdName);

                    const tdQty = document.createElement('td');
                    tdQty.className = 'text-right';
                    tdQty.textContent = c.quantity + 'x';
                    row.appendChild(tdQty);

                    const tdTotal = document.createElement('td');
                    tdTotal.className = 'text-right';
                    tdTotal.textContent = formatCurrency(c.total);
                    row.appendChild(tdTotal);

                    tbody.appendChild(row);
                });
                table.appendChild(tbody);
                tableBox.appendChild(table);
                container.appendChild(tableBox);
            }

            const statsGrid = document.createElement('div');
            statsGrid.className = 'grid grid-cols-2 gap-3';

            const laborBox = document.createElement('div');
            laborBox.className = 'bg-slate-800/50 rounded-lg p-3 text-center';
            const laborLabel = document.createElement('p');
            laborLabel.className = 'text-xs text-slate-400';
            laborLabel.textContent = 'Arbeitskosten';
            const laborValue = document.createElement('p');
            laborValue.className = 'font-semibold text-blue-400';
            laborValue.textContent = formatCurrency(estimate.laborCost);
            laborBox.appendChild(laborLabel);
            laborBox.appendChild(laborValue);

            const totalBox = document.createElement('div');
            totalBox.className = 'bg-gradient-to-r from-emerald-500/20 to-teal-500/20 rounded-lg p-3 text-center border border-emerald-500/20';
            const totalLabel = document.createElement('p');
            totalLabel.className = 'text-xs text-emerald-400';
            totalLabel.textContent = 'Gesamtschatzung';
            const totalValue = document.createElement('p');
            totalValue.className = 'font-bold text-lg text-emerald-400';
            totalValue.textContent = formatCurrency(estimate.totalEstimate);
            totalBox.appendChild(totalLabel);
            totalBox.appendChild(totalValue);

            statsGrid.appendChild(laborBox);
            statsGrid.appendChild(totalBox);
            container.appendChild(statsGrid);

            if (estimate.notes) {
                const notesBox = document.createElement('div');
                notesBox.className = 'bg-slate-800/50 rounded-lg p-3';
                const notesLabel = document.createElement('p');
                notesLabel.className = 'text-xs text-slate-400 mb-1';
                notesLabel.textContent = 'Hinweise';
                const notesText = document.createElement('p');
                notesText.className = 'text-sm text-slate-300';
                notesText.textContent = estimate.notes;
                notesBox.appendChild(notesLabel);
                notesBox.appendChild(notesText);
                container.appendChild(notesBox);
            }
        }

        // Render System Configuration using safe DOM methods
        function renderSystemConfig(config) {
            const container = document.getElementById('ai-systemconfig-content');
            container.textContent = '';

            const systemColors = {
                'LOXONE': 'from-green-500 to-emerald-500',
                'KNX': 'from-red-500 to-orange-500',
                'HYBRID': 'from-blue-500 to-purple-500',
                'INDUSTRIE': 'from-yellow-500 to-amber-500'
            };

            const headerBox = document.createElement('div');
            headerBox.className = 'bg-gradient-to-r ' + (systemColors[config.recommendedSystem] || 'from-slate-500 to-slate-600') + ' rounded-lg p-4 text-center';
            const headerLabel = document.createElement('p');
            headerLabel.className = 'text-xs text-white/70 mb-1';
            headerLabel.textContent = 'Empfohlenes System';
            const headerValue = document.createElement('p');
            headerValue.className = 'text-xl font-bold text-white';
            headerValue.textContent = config.recommendedSystem || 'HYBRID';
            headerBox.appendChild(headerLabel);
            headerBox.appendChild(headerValue);
            container.appendChild(headerBox);

            if (config.modules && config.modules.length > 0) {
                const modulesBox = document.createElement('div');
                modulesBox.className = 'bg-slate-800/50 rounded-lg p-3';
                const modLabel = document.createElement('p');
                modLabel.className = 'text-xs text-slate-400 mb-2';
                modLabel.textContent = 'Module';
                modulesBox.appendChild(modLabel);
                const modTags = document.createElement('div');
                modTags.className = 'flex flex-wrap gap-2';
                config.modules.forEach(function(m) {
                    const tag = document.createElement('span');
                    tag.className = 'px-2 py-1 bg-blue-500/20 text-blue-400 rounded text-xs';
                    tag.textContent = m;
                    modTags.appendChild(tag);
                });
                modulesBox.appendChild(modTags);
                container.appendChild(modulesBox);
            }

            if (config.integrations && config.integrations.length > 0) {
                const intBox = document.createElement('div');
                intBox.className = 'bg-slate-800/50 rounded-lg p-3';
                const intLabel = document.createElement('p');
                intLabel.className = 'text-xs text-slate-400 mb-2';
                intLabel.textContent = 'Integrationen';
                intBox.appendChild(intLabel);
                const intTags = document.createElement('div');
                intTags.className = 'flex flex-wrap gap-2';
                config.integrations.forEach(function(i) {
                    const tag = document.createElement('span');
                    tag.className = 'px-2 py-1 bg-purple-500/20 text-purple-400 rounded text-xs';
                    tag.textContent = i;
                    intTags.appendChild(tag);
                });
                intBox.appendChild(intTags);
                container.appendChild(intBox);
            }

            if (config.reasoning) {
                const reasonBox = document.createElement('div');
                reasonBox.className = 'bg-slate-800/50 rounded-lg p-3';
                const reasonLabel = document.createElement('p');
                reasonLabel.className = 'text-xs text-slate-400 mb-1';
                reasonLabel.textContent = 'Begrundung';
                const reasonText = document.createElement('p');
                reasonText.className = 'text-sm text-slate-300';
                reasonText.textContent = config.reasoning;
                reasonBox.appendChild(reasonLabel);
                reasonBox.appendChild(reasonText);
                container.appendChild(reasonBox);
            }
        }

        // Render Subcontractor Plan using safe DOM methods
        function renderSubcontractorPlan(plan) {
            const container = document.getElementById('ai-subcontractor-content');
            container.textContent = '';

            if (!plan || !plan.requiredTrades || plan.requiredTrades.length === 0) {
                const emptyBox = document.createElement('div');
                emptyBox.className = 'bg-slate-800/50 rounded-lg p-4 text-center text-slate-400';
                emptyBox.textContent = 'Keine Subunternehmer-Anforderungen identifiziert';
                container.appendChild(emptyBox);
                return;
            }

            // Header with count
            const headerBox = document.createElement('div');
            headerBox.className = 'bg-gradient-to-r from-orange-500/20 to-amber-500/20 rounded-lg p-4 border border-orange-500/20';
            const headerLabel = document.createElement('p');
            headerLabel.className = 'text-xs text-orange-400 mb-1';
            headerLabel.textContent = 'Erforderliche Gewerke';
            const headerValue = document.createElement('p');
            headerValue.className = 'text-xl font-bold text-orange-300';
            headerValue.textContent = plan.requiredTrades.length + ' Gewerke identifiziert';
            headerBox.appendChild(headerLabel);
            headerBox.appendChild(headerValue);
            container.appendChild(headerBox);

            // Required trades with recommendations
            plan.requiredTrades.forEach(function(trade) {
                const tradeBox = document.createElement('div');
                tradeBox.className = 'bg-slate-800/50 rounded-lg p-4';

                const tradeHeader = document.createElement('div');
                tradeHeader.className = 'flex justify-between items-start mb-3';
                const tradeName = document.createElement('h4');
                tradeName.className = 'font-medium text-white';
                tradeName.textContent = trade.type || trade.trade;
                tradeHeader.appendChild(tradeName);

                if (trade.priority) {
                    const priorityBadge = document.createElement('span');
                    const priorityColors = { high: 'bg-red-500/20 text-red-400', medium: 'bg-yellow-500/20 text-yellow-400', low: 'bg-green-500/20 text-green-400' };
                    priorityBadge.className = 'px-2 py-1 rounded text-xs ' + (priorityColors[trade.priority] || 'bg-slate-600 text-slate-300');
                    priorityBadge.textContent = trade.priority === 'high' ? 'Hoch' : trade.priority === 'medium' ? 'Mittel' : 'Niedrig';
                    tradeHeader.appendChild(priorityBadge);
                }
                tradeBox.appendChild(tradeHeader);

                // Tasks
                if (trade.tasks && trade.tasks.length > 0) {
                    const taskList = document.createElement('ul');
                    taskList.className = 'text-sm text-slate-400 mb-3 space-y-1';
                    trade.tasks.forEach(function(t) {
                        const li = document.createElement('li');
                        li.textContent = '\u2022 ' + t;
                        taskList.appendChild(li);
                    });
                    tradeBox.appendChild(taskList);
                }

                // Recommended subcontractor
                if (trade.recommended) {
                    const recBox = document.createElement('div');
                    recBox.className = 'bg-emerald-500/10 border border-emerald-500/20 rounded p-3';
                    const recLabel = document.createElement('p');
                    recLabel.className = 'text-xs text-emerald-400 mb-1';
                    recLabel.textContent = 'Empfohlener Partner';
                    const recName = document.createElement('p');
                    recName.className = 'font-medium text-white';
                    recName.textContent = trade.recommended.name;
                    recBox.appendChild(recLabel);
                    recBox.appendChild(recName);

                    if (trade.recommended.contact) {
                        const contactInfo = document.createElement('p');
                        contactInfo.className = 'text-xs text-slate-400 mt-1';
                        contactInfo.textContent = trade.recommended.contact.name + ' - ' + trade.recommended.contact.phone;
                        recBox.appendChild(contactInfo);
                    }

                    if (trade.recommended.rating) {
                        const ratingBadge = document.createElement('span');
                        ratingBadge.className = 'inline-block mt-2 px-2 py-0.5 bg-yellow-500/20 text-yellow-400 rounded text-xs';
                        ratingBadge.textContent = '\u2605 ' + trade.recommended.rating + ' (' + trade.recommended.completedProjects + ' Projekte)';
                        recBox.appendChild(ratingBadge);
                    }
                    tradeBox.appendChild(recBox);
                }

                container.appendChild(tradeBox);
            });

            // Estimated coordination cost
            if (plan.estimatedCoordinationCost) {
                const costBox = document.createElement('div');
                costBox.className = 'bg-slate-800/50 rounded-lg p-3 text-center';
                const costLabel = document.createElement('p');
                costLabel.className = 'text-xs text-slate-400';
                costLabel.textContent = 'Geschatzte Koordinationskosten';
                const costValue = document.createElement('p');
                costValue.className = 'font-semibold text-blue-400';
                costValue.textContent = new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(plan.estimatedCoordinationCost);
                costBox.appendChild(costLabel);
                costBox.appendChild(costValue);
                container.appendChild(costBox);
            }
        }

        // Render Communication Schedule using safe DOM methods
        function renderCommunicationSchedule(schedule) {
            const container = document.getElementById('ai-communication-content');
            container.textContent = '';

            // Check for data in either format (phases or customerContacts)
            const hasPhases = schedule && schedule.phases && schedule.phases.length > 0;
            const hasCustomerContacts = schedule && schedule.customerContacts && schedule.customerContacts.length > 0;

            if (!hasPhases && !hasCustomerContacts) {
                const emptyBox = document.createElement('div');
                emptyBox.className = 'bg-slate-800/50 rounded-lg p-4 text-center text-slate-400';
                emptyBox.textContent = 'Noch kein Kommunikationsplan erstellt';
                container.appendChild(emptyBox);
                return;
            }

            // Summary header
            const headerBox = document.createElement('div');
            headerBox.className = 'bg-gradient-to-r from-purple-500/20 to-pink-500/20 rounded-lg p-4 border border-purple-500/20';
            const headerLabel = document.createElement('p');
            headerLabel.className = 'text-xs text-purple-400 mb-1';
            headerLabel.textContent = 'Kommunikationsplan';
            const headerValue = document.createElement('p');
            headerValue.className = 'text-xl font-bold text-purple-300';
            const contactCount = (schedule.customerContacts || []).length + (schedule.subcontractorContacts || []).length;
            headerValue.textContent = contactCount + ' Kontaktpunkte geplant';
            headerBox.appendChild(headerLabel);
            headerBox.appendChild(headerValue);
            container.appendChild(headerBox);

            // Customer Contacts Section
            if (schedule.customerContacts && schedule.customerContacts.length > 0) {
                const customerSection = document.createElement('div');
                customerSection.className = 'bg-slate-800/50 rounded-lg p-4';
                const customerTitle = document.createElement('h4');
                customerTitle.className = 'font-medium text-white mb-3 flex items-center gap-2';
                customerTitle.textContent = '\uD83D\uDC64 Kundenkommunikation';
                customerSection.appendChild(customerTitle);

                schedule.customerContacts.forEach(function(contact, index) {
                    const contactBox = document.createElement('div');
                    contactBox.className = 'flex items-start gap-3 mb-3 last:mb-0';

                    const number = document.createElement('span');
                    number.className = 'w-6 h-6 rounded-full bg-blue-500/20 text-blue-400 flex items-center justify-center text-xs font-bold flex-shrink-0';
                    number.textContent = (index + 1).toString();
                    contactBox.appendChild(number);

                    const content = document.createElement('div');
                    content.className = 'flex-1';

                    const header = document.createElement('div');
                    header.className = 'flex justify-between items-start';
                    const title = document.createElement('p');
                    title.className = 'font-medium text-sm';
                    title.textContent = contact.type + ' - ' + contact.purpose;
                    header.appendChild(title);
                    const timing = document.createElement('span');
                    timing.className = 'text-xs text-slate-400';
                    timing.textContent = contact.timing;
                    header.appendChild(timing);
                    content.appendChild(header);

                    const method = document.createElement('p');
                    method.className = 'text-xs text-slate-400';
                    method.textContent = contact.method;
                    content.appendChild(method);

                    if (contact.agenda && contact.agenda.length > 0) {
                        const agendaList = document.createElement('ul');
                        agendaList.className = 'text-xs text-slate-500 mt-1';
                        contact.agenda.slice(0, 3).forEach(function(item) {
                            const li = document.createElement('li');
                            li.textContent = '\u2022 ' + item;
                            agendaList.appendChild(li);
                        });
                        content.appendChild(agendaList);
                    }

                    contactBox.appendChild(content);
                    customerSection.appendChild(contactBox);
                });

                container.appendChild(customerSection);
            }

            // Subcontractor Contacts Section
            if (schedule.subcontractorContacts && schedule.subcontractorContacts.length > 0) {
                const subSection = document.createElement('div');
                subSection.className = 'bg-slate-800/50 rounded-lg p-4';
                const subTitle = document.createElement('h4');
                subTitle.className = 'font-medium text-white mb-3 flex items-center gap-2';
                subTitle.textContent = '\uD83D\uDC77 Subunternehmer-Kontakte';
                subSection.appendChild(subTitle);

                const subGrid = document.createElement('div');
                subGrid.className = 'grid grid-cols-1 gap-2';

                schedule.subcontractorContacts.forEach(function(contact) {
                    const subBox = document.createElement('div');
                    subBox.className = 'flex justify-between items-center p-2 bg-slate-700/30 rounded';

                    const left = document.createElement('div');
                    const tradeName = document.createElement('p');
                    tradeName.className = 'text-sm font-medium';
                    tradeName.textContent = contact.trade;
                    left.appendChild(tradeName);
                    const contactType = document.createElement('p');
                    contactType.className = 'text-xs text-slate-400';
                    contactType.textContent = contact.type + ' via ' + contact.method;
                    left.appendChild(contactType);
                    subBox.appendChild(left);

                    const timing = document.createElement('span');
                    timing.className = 'text-xs text-orange-400';
                    timing.textContent = contact.timing;
                    subBox.appendChild(timing);

                    subGrid.appendChild(subBox);
                });

                subSection.appendChild(subGrid);
                container.appendChild(subSection);
            }

            // Status updates info
            if (schedule.statusUpdates) {
                const statusBox = document.createElement('div');
                statusBox.className = 'bg-emerald-500/10 border border-emerald-500/20 rounded-lg p-3';
                const statusLabel = document.createElement('p');
                statusLabel.className = 'text-xs text-emerald-400 mb-1';
                statusLabel.textContent = 'Regelmassige Updates';
                const statusValue = document.createElement('p');
                statusValue.className = 'text-sm text-white';
                statusValue.textContent = schedule.statusUpdates;
                statusBox.appendChild(statusLabel);
                statusBox.appendChild(statusValue);
                container.appendChild(statusBox);
            }

            // Escalation path
            if (schedule.escalationPath && schedule.escalationPath.length > 0) {
                const escBox = document.createElement('div');
                escBox.className = 'bg-slate-800/50 rounded-lg p-3';
                const escLabel = document.createElement('p');
                escLabel.className = 'text-xs text-slate-400 mb-2';
                escLabel.textContent = 'Eskalationspfad';
                escBox.appendChild(escLabel);

                const escTags = document.createElement('div');
                escTags.className = 'flex flex-wrap gap-2';
                schedule.escalationPath.forEach(function(s) {
                    const tag = document.createElement('span');
                    tag.className = 'px-2 py-1 bg-red-500/20 text-red-400 rounded text-xs';
                    tag.textContent = s;
                    escTags.appendChild(tag);
                });
                escBox.appendChild(escTags);
                container.appendChild(escBox);
            }
        }

        // Load existing AI plan data on page load
        async function loadAIPlanData() {
            const customerId = getCustomerId();
            try {
                const response = await fetch('/api/customer/' + customerId + '/plan-data');
                const data = await response.json();

                if (data.success && data.exists) {
                    if (data.status === 'planned' || data.status === 'analyzed') {
                        updateAIStatus(data.status === 'planned' ? 'Geplant' : 'Analysiert', 'green');
                    } else if (data.status === 'processing') {
                        updateAIStatus('Verarbeitung...', 'yellow');
                    }

                    if (data.aiAnalysis) renderAnalysis(data.aiAnalysis);
                    if (data.projectPlan) renderProjectPlan(data.projectPlan);
                    if (data.costEstimate) renderCostEstimate(data.costEstimate);
                    if (data.suggestedConfig) renderSystemConfig(data.suggestedConfig);
                    if (data.subcontractorPlan) renderSubcontractorPlan(data.subcontractorPlan);
                    if (data.communicationSchedule) renderCommunicationSchedule(data.communicationSchedule);
                }
            } catch (error) {
                console.log('No existing AI plan data');
            }
        }

        // Load and render scheduled notifications
        async function loadNotifications() {
            const customerId = getCustomerId();
            const container = document.getElementById('notifications-list');

            try {
                const response = await fetch('/api/customer/' + customerId + '/notifications');
                const data = await response.json();

                // Also fetch sent history
                const historyResponse = await fetch('/api/notifications/history?customerId=' + customerId);
                const historyData = await historyResponse.json();

                renderNotifications(data.notifications || [], historyData.history || []);

                // Update badge
                const badge = document.getElementById('notifications-badge');
                const count = document.getElementById('notifications-count');
                if (badge && count && data.notifications) {
                    count.textContent = data.notifications.length;
                    if (data.notifications.length > 0) {
                        badge.classList.remove('hidden');
                    }
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
                container.textContent = '';
                const errorBox = document.createElement('div');
                errorBox.className = 'bg-slate-800/50 rounded-lg p-4 text-center text-slate-400';
                errorBox.textContent = 'Fehler beim Laden der Benachrichtigungen';
                container.appendChild(errorBox);
            }
        }

        // Render notifications list using safe DOM methods
        function renderNotifications(scheduled, sent) {
            const container = document.getElementById('notifications-list');
            container.textContent = '';

            const allNotifications = [
                ...scheduled.map(function(n) { return Object.assign({}, n, { isSent: false }); }),
                ...sent.map(function(n) { return Object.assign({}, n, { isSent: true }); })
            ];

            if (allNotifications.length === 0) {
                const emptyBox = document.createElement('div');
                emptyBox.className = 'bg-slate-800/50 rounded-lg p-4 text-center text-slate-400';
                emptyBox.textContent = 'Keine Benachrichtigungen geplant';
                container.appendChild(emptyBox);
                return;
            }

            // Sort by date (scheduled first, then sent)
            allNotifications.sort(function(a, b) {
                if (a.isSent !== b.isSent) return a.isSent ? 1 : -1;
                return new Date(a.scheduledFor) - new Date(b.scheduledFor);
            });

            // Type icons and colors
            var typeConfig = {
                customer: { icon: '\uD83D\uDC64', color: 'blue', label: 'Kunde' },
                subcontractor: { icon: '\uD83D\uDC77', color: 'orange', label: 'Subunternehmer' },
                internal: { icon: '\uD83D\uDCE2', color: 'gray', label: 'Intern' }
            };

            var statusConfig = {
                scheduled: { icon: '\uD83D\uDCC5', color: 'yellow', label: 'Geplant' },
                sent: { icon: '\u2705', color: 'green', label: 'Gesendet' },
                failed: { icon: '\u274C', color: 'red', label: 'Fehlgeschlagen' },
                cancelled: { icon: '\u26D4', color: 'gray', label: 'Abgebrochen' }
            };

            // Group by status
            var scheduledItems = allNotifications.filter(function(n) { return !n.isSent; });
            var sentItems = allNotifications.filter(function(n) { return n.isSent; });

            // Render scheduled notifications
            if (scheduledItems.length > 0) {
                var scheduledHeader = document.createElement('div');
                scheduledHeader.className = 'flex items-center gap-2 text-sm font-medium text-slate-400 mb-2';
                scheduledHeader.textContent = '\uD83D\uDCC5 Ausstehend (' + scheduledItems.length + ')';
                container.appendChild(scheduledHeader);

                scheduledItems.forEach(function(notif) {
                    container.appendChild(createNotificationCard(notif, typeConfig, statusConfig));
                });
            }

            // Render sent notifications
            if (sentItems.length > 0) {
                var sentHeader = document.createElement('div');
                sentHeader.className = 'flex items-center gap-2 text-sm font-medium text-slate-400 mb-2 mt-4';
                sentHeader.textContent = '\u2705 Gesendet (' + sentItems.length + ')';
                container.appendChild(sentHeader);

                sentItems.slice(0, 5).forEach(function(notif) {
                    container.appendChild(createNotificationCard(notif, typeConfig, statusConfig));
                });

                if (sentItems.length > 5) {
                    var moreBox = document.createElement('div');
                    moreBox.className = 'text-center text-xs text-slate-500 py-2';
                    moreBox.textContent = '+ ' + (sentItems.length - 5) + ' weitere';
                    container.appendChild(moreBox);
                }
            }
        }

        // Create notification card element
        function createNotificationCard(notif, typeConfig, statusConfig) {
            var card = document.createElement('div');
            var isSent = notif.isSent || notif.status === 'sent';
            card.className = 'bg-slate-800/50 rounded-lg p-3 ' + (isSent ? 'opacity-70' : '');

            // Header row
            var header = document.createElement('div');
            header.className = 'flex items-start justify-between mb-2';

            var leftSide = document.createElement('div');
            leftSide.className = 'flex items-center gap-2';

            // Type badge
            var typeInfo = typeConfig[notif.type] || typeConfig.customer;
            var typeBadge = document.createElement('span');
            typeBadge.className = 'text-lg';
            typeBadge.textContent = typeInfo.icon;
            leftSide.appendChild(typeBadge);

            var titleWrap = document.createElement('div');
            var title = document.createElement('p');
            title.className = 'font-medium text-sm';
            title.textContent = notif.contactType || notif.type;
            titleWrap.appendChild(title);

            var subtitle = document.createElement('p');
            subtitle.className = 'text-xs text-slate-400';
            subtitle.textContent = notif.trade || notif.projectName || '';
            titleWrap.appendChild(subtitle);
            leftSide.appendChild(titleWrap);
            header.appendChild(leftSide);

            // Status badge
            var statusInfo = statusConfig[notif.status] || statusConfig.scheduled;
            var statusBadge = document.createElement('span');
            var statusColors = {
                yellow: 'bg-yellow-500/20 text-yellow-400',
                green: 'bg-green-500/20 text-green-400',
                red: 'bg-red-500/20 text-red-400',
                gray: 'bg-slate-500/20 text-slate-400'
            };
            statusBadge.className = 'px-2 py-0.5 rounded text-xs ' + (statusColors[statusInfo.color] || statusColors.gray);
            statusBadge.textContent = statusInfo.label;
            header.appendChild(statusBadge);

            card.appendChild(header);

            // Details row
            var details = document.createElement('div');
            details.className = 'flex items-center gap-4 text-xs text-slate-400';

            // Date
            var dateSpan = document.createElement('span');
            dateSpan.className = 'flex items-center gap-1';
            var dateIcon = document.createElement('span');
            dateIcon.textContent = '\uD83D\uDCC6';
            dateSpan.appendChild(dateIcon);
            var dateText = document.createElement('span');
            var dateValue = isSent ? notif.sentAt : notif.scheduledFor;
            dateText.textContent = dateValue ? formatNotificationDate(dateValue) : 'TBD';
            dateSpan.appendChild(dateText);
            details.appendChild(dateSpan);

            // Recipient
            if (notif.recipient) {
                var recipientSpan = document.createElement('span');
                recipientSpan.className = 'flex items-center gap-1';
                var emailIcon = document.createElement('span');
                emailIcon.textContent = '\u2709';
                recipientSpan.appendChild(emailIcon);
                var emailText = document.createElement('span');
                emailText.textContent = notif.recipient.length > 25 ? notif.recipient.substring(0, 22) + '...' : notif.recipient;
                recipientSpan.appendChild(emailText);
                details.appendChild(recipientSpan);
            } else if (!isSent) {
                var noEmailSpan = document.createElement('span');
                noEmailSpan.className = 'text-orange-400';
                noEmailSpan.textContent = '\u26A0 Keine E-Mail';
                details.appendChild(noEmailSpan);
            }

            // Method
            if (notif.method) {
                var methodSpan = document.createElement('span');
                methodSpan.textContent = notif.method;
                details.appendChild(methodSpan);
            }

            card.appendChild(details);

            return card;
        }

        // Format date for notifications
        function formatNotificationDate(dateString) {
            if (!dateString) return 'TBD';
            var date = new Date(dateString);
            var now = new Date();
            var diffDays = Math.ceil((date - now) / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Heute';
            if (diffDays === 1) return 'Morgen';
            if (diffDays === -1) return 'Gestern';
            if (diffDays < 0) return date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
            if (diffDays <= 7) return 'In ' + diffDays + ' Tagen';

            return date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: '2-digit' });
        }

        // Load AI data and notifications when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadAIPlanData();
            loadNotifications();
        });
    </script>
</body>
</html>
