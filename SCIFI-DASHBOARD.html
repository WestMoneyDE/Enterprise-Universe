<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="NEXUS COMMAND CENTER - Cyberpunk Enterprise Dashboard">
    <meta name="theme-color" content="#00fff7">
    <title>NEXUS COMMAND CENTER | Enterprise Universe</title>
    <script src="/js/auth-guard.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Share+Tech+Mono&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
:root {
    --neon-cyan: #00fff7;
    --neon-magenta: #ff00ff;
    --neon-pink: #ff0080;
    --neon-yellow: #fff700;
    --neon-blue: #0080ff;
    --neon-purple: #8000ff;
    --neon-green: #00ff88;
    --neon-red: #ff0044;
    --bg-void: #000000;
    --bg-dark: #0a0a0f;
    --bg-card: rgba(13, 13, 20, 0.85);
    --bg-hover: rgba(0, 255, 247, 0.1);
    --text-primary: #ffffff;
    --text-secondary: #a0a0b0;
    --text-muted: #606070;
    --border-dim: rgba(0, 255, 247, 0.1);
    --border-glow: rgba(0, 255, 247, 0.3);
    --glow-cyan: 0 0 20px rgba(0, 255, 247, 0.5), 0 0 40px rgba(0, 255, 247, 0.3);
    --glow-magenta: 0 0 20px rgba(255, 0, 255, 0.5), 0 0 40px rgba(255, 0, 255, 0.3);
    --header-height: 70px;
    --sidebar-width: 280px;
    --transition-fast: 0.15s ease;
    --transition-normal: 0.3s ease;
}

@keyframes neonPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
@keyframes glitchText { 0%, 100% { text-shadow: -2px 0 var(--neon-magenta), 2px 0 var(--neon-cyan); } 50% { text-shadow: 2px 0 var(--neon-magenta), -2px 0 var(--neon-cyan); } }
@keyframes scanLine { 0% { transform: translateY(-100%); } 100% { transform: translateY(100vh); } }
@keyframes gridMove { 0% { background-position: 0 0; } 100% { background-position: 50px 50px; } }
@keyframes radarSweep { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
@keyframes dataStream { 0% { transform: translateY(-100%); opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { transform: translateY(100%); opacity: 0; } }

*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
html { font-size: 15px; }
body { font-family: 'Rajdhani', sans-serif; background: var(--bg-void); color: var(--text-primary); line-height: 1.6; overflow-x: hidden; min-height: 100vh; }
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: var(--bg-dark); }
::-webkit-scrollbar-thumb { background: var(--neon-cyan); border-radius: 4px; box-shadow: 0 0 10px var(--neon-cyan); }

#particle-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }
.cyber-grid { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; background: linear-gradient(90deg, rgba(0, 255, 247, 0.03) 1px, transparent 1px), linear-gradient(rgba(0, 255, 247, 0.03) 1px, transparent 1px); background-size: 50px 50px; animation: gridMove 20s linear infinite; }
.scan-lines { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; background: repeating-linear-gradient(0deg, rgba(0, 0, 0, 0.1) 0px, rgba(0, 0, 0, 0.1) 1px, transparent 1px, transparent 2px); }
.scan-lines::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: linear-gradient(to bottom, rgba(0, 255, 247, 0.2), transparent); animation: scanLine 8s linear infinite; }
.vignette { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 3; pointer-events: none; background: radial-gradient(ellipse at center, transparent 0%, rgba(0, 0, 0, 0.4) 100%); }

.nexus-header { position: fixed; top: 0; left: 0; right: 0; height: var(--header-height); z-index: 1000; display: flex; align-items: center; justify-content: space-between; padding: 0 2rem; background: linear-gradient(to bottom, rgba(10, 10, 15, 0.98), rgba(10, 10, 15, 0.9)); border-bottom: 1px solid var(--border-glow); backdrop-filter: blur(20px); }
.nexus-header::before { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, var(--neon-cyan), var(--neon-magenta), var(--neon-cyan), transparent); animation: neonPulse 2s ease-in-out infinite; }

.nexus-logo { display: flex; align-items: center; gap: 1rem; }
.logo-icon { width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--neon-cyan), var(--neon-magenta)); clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); font-family: 'Orbitron', monospace; font-weight: 900; font-size: 1.2rem; color: var(--bg-dark); position: relative; }
.logo-icon::before { content: ''; position: absolute; inset: -3px; background: linear-gradient(135deg, var(--neon-cyan), var(--neon-magenta)); clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); z-index: -1; animation: neonPulse 2s ease-in-out infinite; filter: blur(8px); }
.logo-title { font-family: 'Orbitron', monospace; font-size: 1.4rem; font-weight: 800; letter-spacing: 4px; color: var(--neon-cyan); text-shadow: 0 0 10px var(--neon-cyan), 0 0 20px var(--neon-cyan); animation: glitchText 5s infinite; }
.logo-subtitle { font-family: 'Share Tech Mono', monospace; font-size: 0.7rem; letter-spacing: 2px; color: var(--text-muted); text-transform: uppercase; }

.header-status { display: flex; align-items: center; gap: 2rem; }
.status-item { display: flex; align-items: center; gap: 0.5rem; font-family: 'Share Tech Mono', monospace; font-size: 0.95rem; color: var(--text-secondary); font-weight: 500; }
.status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--neon-green); box-shadow: 0 0 10px var(--neon-green); animation: neonPulse 1s ease-in-out infinite; }
.status-dot.warning { background: var(--neon-yellow); box-shadow: 0 0 10px var(--neon-yellow); }
.status-dot.active { background: var(--neon-green); box-shadow: 0 0 10px var(--neon-green); animation: neonPulse 0.5s ease-in-out infinite; }

/* Tasks Panel Dropdown */
.tasks-trigger { cursor: pointer; position: relative; transition: var(--transition-fast); }
.tasks-trigger:hover { color: var(--neon-yellow); text-shadow: 0 0 10px var(--neon-yellow); }
.tasks-panel { position: absolute; top: calc(100% + 10px); right: 0; width: 350px; background: rgba(10, 10, 20, 0.98); border: 1px solid var(--neon-cyan); border-radius: 4px; box-shadow: 0 0 20px rgba(0, 255, 247, 0.3), inset 0 0 30px rgba(0, 0, 0, 0.5); z-index: 1000; display: none; overflow: hidden; }
.tasks-panel.show { display: block; animation: fadeIn 0.2s ease-out; }
.tasks-panel-header { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; background: linear-gradient(90deg, rgba(0, 255, 247, 0.1), transparent); border-bottom: 1px solid var(--border-dim); font-family: 'Orbitron', monospace; font-size: 0.75rem; color: var(--neon-cyan); letter-spacing: 2px; }
.tasks-refresh { background: transparent; border: 1px solid var(--neon-cyan); color: var(--neon-cyan); padding: 0.25rem 0.5rem; cursor: pointer; font-size: 0.8rem; border-radius: 3px; transition: var(--transition-fast); }
.tasks-refresh:hover { background: rgba(0, 255, 247, 0.2); box-shadow: 0 0 10px var(--neon-cyan); }
.tasks-list { max-height: 300px; overflow-y: auto; }
.task-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-dim); transition: var(--transition-fast); }
.task-item:hover { background: rgba(0, 255, 247, 0.05); }
.task-item:last-child { border-bottom: none; }
.task-status { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.task-status.running { background: var(--neon-green); box-shadow: 0 0 8px var(--neon-green); animation: neonPulse 0.5s ease-in-out infinite; }
.task-status.pending { background: var(--neon-yellow); box-shadow: 0 0 8px var(--neon-yellow); }
.task-status.scheduled { background: var(--neon-cyan); box-shadow: 0 0 8px var(--neon-cyan); opacity: 0.5; }
.task-info { flex: 1; min-width: 0; }
.task-name { font-family: 'Orbitron', monospace; font-size: 0.85rem; color: var(--text-primary); letter-spacing: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.task-desc { font-size: 0.8rem; color: var(--text-muted); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.task-time { font-family: 'Share Tech Mono', monospace; font-size: 0.75rem; color: var(--neon-cyan); opacity: 0.7; }
.task-loading { padding: 2rem; text-align: center; font-family: 'Share Tech Mono', monospace; font-size: 0.8rem; color: var(--neon-cyan); animation: neonPulse 1s ease-in-out infinite; }
.tasks-empty { padding: 2rem; text-align: center; color: var(--text-muted); font-size: 0.8rem; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

.header-actions { display: flex; align-items: center; gap: 1rem; }
.header-search { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: rgba(0, 255, 247, 0.05); border: 1px solid var(--border-dim); border-radius: 4px; cursor: pointer; transition: var(--transition-fast); }
.header-search:hover { border-color: var(--neon-cyan); box-shadow: 0 0 15px rgba(0, 255, 247, 0.2); }
.header-search span { font-family: 'Share Tech Mono', monospace; font-size: 0.8rem; color: var(--text-muted); }
.header-search kbd { padding: 0.15rem 0.4rem; background: rgba(20, 20, 30, 0.9); border: 1px solid var(--border-dim); border-radius: 3px; font-size: 0.65rem; color: var(--text-muted); }

.btn-nexus { padding: 0.6rem 1.2rem; background: transparent; border: 1px solid var(--neon-cyan); color: var(--neon-cyan); font-family: 'Orbitron', monospace; font-size: 0.75rem; font-weight: 600; letter-spacing: 2px; cursor: pointer; position: relative; overflow: hidden; transition: var(--transition-fast); clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px); }
.btn-nexus:hover { background: rgba(0, 255, 247, 0.1); box-shadow: var(--glow-cyan); }
.btn-nexus.magenta { border-color: var(--neon-magenta); color: var(--neon-magenta); }
.btn-nexus.magenta:hover { background: rgba(255, 0, 255, 0.1); box-shadow: var(--glow-magenta); }

.nexus-sidebar { position: fixed; top: var(--header-height); left: 0; width: var(--sidebar-width); height: calc(100vh - var(--header-height)); z-index: 900; background: linear-gradient(to right, rgba(10, 10, 15, 0.98), rgba(10, 10, 15, 0.95)); border-right: 1px solid var(--border-dim); padding: 1.5rem 0; overflow-y: auto; }
.nexus-sidebar::before { content: ''; position: absolute; top: 0; right: 0; width: 2px; height: 100%; background: linear-gradient(to bottom, var(--neon-cyan), transparent, var(--neon-magenta), transparent, var(--neon-cyan)); animation: neonPulse 3s ease-in-out infinite; }

.nav-section { margin-bottom: 1.5rem; }
.nav-section-title { padding: 0.5rem 1.5rem; font-family: 'Orbitron', monospace; font-size: 0.65rem; font-weight: 600; letter-spacing: 3px; color: var(--neon-cyan); text-transform: uppercase; text-shadow: 0 0 10px var(--neon-cyan); }
.nav-item { display: flex; align-items: center; gap: 1rem; padding: 0.75rem 1.5rem; color: var(--text-secondary); text-decoration: none; font-size: 0.9rem; font-weight: 500; position: relative; transition: var(--transition-fast); border-left: 2px solid transparent; }
.nav-item:hover { color: var(--text-primary); background: var(--bg-hover); border-left-color: var(--neon-cyan); }
.nav-item.active { color: var(--neon-cyan); background: rgba(0, 255, 247, 0.1); border-left-color: var(--neon-cyan); text-shadow: 0 0 10px var(--neon-cyan); }
.nav-icon { width: 20px; text-align: center; font-size: 1rem; }

.nexus-main { margin-left: var(--sidebar-width); margin-top: var(--header-height); min-height: calc(100vh - var(--header-height)); padding: 2rem; position: relative; z-index: 10; }
.content-container { max-width: 1800px; margin: 0 auto; }

.page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-dim); }
.page-title { font-family: 'Orbitron', monospace; font-size: 1.8rem; font-weight: 700; letter-spacing: 3px; color: var(--text-primary); text-shadow: 0 0 20px rgba(0, 255, 247, 0.3); }
.page-title span { color: var(--neon-cyan); }

.cyber-card { background: var(--bg-card); border: 1px solid var(--border-dim); position: relative; padding: 1.5rem; backdrop-filter: blur(10px); transition: var(--transition-normal); }
.cyber-card::before, .cyber-card::after { content: ''; position: absolute; width: 20px; height: 20px; border: 2px solid var(--neon-cyan); transition: var(--transition-fast); }
.cyber-card::before { top: -1px; left: -1px; border-right: none; border-bottom: none; }
.cyber-card::after { bottom: -1px; right: -1px; border-left: none; border-top: none; }
.cyber-card:hover { border-color: var(--neon-cyan); box-shadow: 0 0 30px rgba(0, 255, 247, 0.15); }
.cyber-card:hover::before, .cyber-card:hover::after { width: 30px; height: 30px; border-color: var(--neon-magenta); }

.card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border-dim); }
.card-title { font-family: 'Orbitron', monospace; font-size: 0.9rem; font-weight: 600; letter-spacing: 2px; color: var(--neon-cyan); text-transform: uppercase; }

.kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.5rem; margin-bottom: 2rem; }
.kpi-card { background: var(--bg-card); border: 1px solid var(--border-dim); padding: 1.5rem; position: relative; overflow: hidden; }
.kpi-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 3px; background: var(--neon-cyan); box-shadow: 0 0 20px var(--neon-cyan); }
.kpi-card.magenta::before { background: var(--neon-magenta); box-shadow: 0 0 20px var(--neon-magenta); }
.kpi-card.green::before { background: var(--neon-green); box-shadow: 0 0 20px var(--neon-green); }
.kpi-card.yellow::before { background: var(--neon-yellow); box-shadow: 0 0 20px var(--neon-yellow); }

.kpi-icon { position: absolute; top: 1rem; right: 1rem; font-size: 2rem; opacity: 0.3; }
.kpi-label { font-family: 'Share Tech Mono', monospace; font-size: 0.75rem; letter-spacing: 1px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem; }
.kpi-value { font-family: 'Orbitron', monospace; font-size: 2rem; font-weight: 700; color: var(--neon-cyan); text-shadow: 0 0 20px currentColor; line-height: 1.2; }
.kpi-card.magenta .kpi-value { color: var(--neon-magenta); }
.kpi-card.green .kpi-value { color: var(--neon-green); }
.kpi-card.yellow .kpi-value { color: var(--neon-yellow); }
.kpi-change { display: inline-flex; align-items: center; gap: 0.25rem; margin-top: 0.5rem; font-size: 0.8rem; color: var(--neon-green); }

.radar-widget { position: relative; width: 200px; height: 200px; margin: 0 auto; }
.radar-circle { position: absolute; border: 1px solid rgba(0, 255, 247, 0.2); border-radius: 50%; left: 50%; top: 50%; transform: translate(-50%, -50%); }
.radar-circle:nth-child(1) { width: 100%; height: 100%; }
.radar-circle:nth-child(2) { width: 75%; height: 75%; }
.radar-circle:nth-child(3) { width: 50%; height: 50%; }
.radar-circle:nth-child(4) { width: 25%; height: 25%; }
.radar-sweep { position: absolute; top: 50%; left: 50%; width: 50%; height: 2px; background: linear-gradient(90deg, var(--neon-cyan), transparent); transform-origin: left center; animation: radarSweep 4s linear infinite; box-shadow: 0 0 20px var(--neon-cyan); }
.radar-dot { position: absolute; width: 8px; height: 8px; background: var(--neon-magenta); border-radius: 50%; box-shadow: 0 0 10px var(--neon-magenta); animation: neonPulse 1s ease-in-out infinite; }

.neural-network { position: relative; height: 200px; overflow: hidden; }
.neural-node { position: absolute; width: 12px; height: 12px; background: var(--neon-cyan); border-radius: 50%; box-shadow: 0 0 15px var(--neon-cyan); animation: neonPulse 2s ease-in-out infinite; }
.neural-connection { position: absolute; height: 1px; background: linear-gradient(90deg, var(--neon-cyan), var(--neon-magenta)); transform-origin: left center; opacity: 0.5; }

.data-stream { font-family: 'Share Tech Mono', monospace; font-size: 0.7rem; color: var(--neon-green); height: 150px; overflow: hidden; background: rgba(0, 0, 0, 0.3); padding: 0.5rem; border: 1px solid rgba(0, 255, 136, 0.2); }
.data-stream-line { opacity: 0.8; white-space: nowrap; }
.data-stream-line:nth-child(odd) { color: var(--neon-cyan); }

.cyber-table { width: 100%; border-collapse: collapse; }
.cyber-table th { padding: 1rem; text-align: left; font-family: 'Orbitron', monospace; font-size: 0.7rem; font-weight: 600; letter-spacing: 2px; color: var(--neon-cyan); text-transform: uppercase; background: rgba(0, 255, 247, 0.05); border-bottom: 1px solid var(--border-glow); }
.cyber-table td { padding: 1rem; font-size: 0.9rem; border-bottom: 1px solid var(--border-dim); }
.cyber-table tr:hover td { background: rgba(0, 255, 247, 0.05); }
.cyber-table .highlight { color: var(--neon-cyan); text-shadow: 0 0 10px var(--neon-cyan); }

.cyber-badge { display: inline-flex; align-items: center; gap: 0.3rem; padding: 0.25rem 0.6rem; font-family: 'Share Tech Mono', monospace; font-size: 0.7rem; letter-spacing: 1px; text-transform: uppercase; border: 1px solid currentColor; clip-path: polygon(5px 0, 100% 0, 100% calc(100% - 5px), calc(100% - 5px) 100%, 0 100%, 0 5px); }
.cyber-badge.cyan { color: var(--neon-cyan); background: rgba(0, 255, 247, 0.1); }
.cyber-badge.green { color: var(--neon-green); background: rgba(0, 255, 136, 0.1); }

.cyber-input { width: 100%; padding: 0.75rem 1rem; background: rgba(0, 0, 0, 0.3); border: 1px solid var(--border-dim); color: var(--text-primary); font-family: 'Rajdhani', sans-serif; font-size: 0.95rem; }
.cyber-input:focus { outline: none; border-color: var(--neon-cyan); box-shadow: 0 0 20px rgba(0, 255, 247, 0.2); }

.modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(10px); z-index: 2000; display: none; align-items: center; justify-content: center; }
.modal-overlay.active { display: flex; }
.modal-content { background: var(--bg-card); border: 1px solid var(--neon-cyan); max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; position: relative; }
.modal-content::before, .modal-content::after { content: ''; position: absolute; width: 30px; height: 30px; border: 2px solid var(--neon-magenta); }
.modal-content::before { top: -1px; left: -1px; border-right: none; border-bottom: none; }
.modal-content::after { bottom: -1px; right: -1px; border-left: none; border-top: none; }
.modal-header { padding: 1.5rem; border-bottom: 1px solid var(--border-dim); display: flex; align-items: center; justify-content: space-between; }
.modal-title { font-family: 'Orbitron', monospace; font-size: 1.1rem; font-weight: 600; letter-spacing: 2px; color: var(--neon-cyan); }
.modal-close { width: 30px; height: 30px; background: transparent; border: 1px solid var(--neon-red); color: var(--neon-red); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
.modal-close:hover { background: rgba(255, 0, 68, 0.2); box-shadow: 0 0 15px var(--neon-red); }
.modal-body { padding: 1.5rem; }
.modal-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border-dim); display: flex; justify-content: flex-end; gap: 1rem; }

.status-bar { position: fixed; bottom: 0; left: var(--sidebar-width); right: 0; height: 35px; background: linear-gradient(to top, rgba(10, 10, 15, 0.98), rgba(10, 10, 15, 0.95)); border-top: 1px solid var(--border-dim); display: flex; align-items: center; justify-content: space-between; padding: 0 1.5rem; font-family: 'Share Tech Mono', monospace; font-size: 0.7rem; color: var(--text-muted); z-index: 800; }
.status-bar::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px; background: linear-gradient(90deg, transparent, var(--neon-cyan), transparent); }
.status-bar-left, .status-bar-right { display: flex; align-items: center; gap: 1.5rem; }
.status-bar-item { display: flex; align-items: center; gap: 0.4rem; }
.status-bar-item .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--neon-green); box-shadow: 0 0 8px var(--neon-green); }

.grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; }
.grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; }
.flex { display: flex; }
.items-center { align-items: center; }
.justify-between { justify-content: space-between; }
.gap-2 { gap: 1rem; }
.mt-3 { margin-top: 1.5rem; }
.mb-2 { margin-bottom: 1rem; }

.loading-skeleton { background: linear-gradient(90deg, var(--bg-card) 25%, rgba(20,20,30,0.9) 50%, var(--bg-card) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 4px; }
@keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }

@media (max-width: 1400px) { .kpi-grid { grid-template-columns: repeat(2, 1fr); } }
@media (max-width: 1024px) { .nexus-sidebar { width: 70px; } .nexus-sidebar .nav-label, .nexus-sidebar .nav-section-title { display: none; } .nexus-main { margin-left: 70px; } .status-bar { left: 70px; } }
@media (max-width: 768px) { .nexus-sidebar { transform: translateX(-100%); } .nexus-main { margin-left: 0; } .status-bar { left: 0; } .kpi-grid, .grid-2, .grid-3 { grid-template-columns: 1fr; } .header-status { display: none; } }
    </style>
</head>
<body>
    <canvas id="particle-canvas"></canvas>
    <div class="cyber-grid"></div>
    <div class="scan-lines"></div>
    <div class="vignette"></div>

    <header class="nexus-header">
        <div class="nexus-logo">
            <div class="logo-icon">N</div>
            <div class="logo-text">
                <div class="logo-title">NEXUS</div>
                <div class="logo-subtitle">Command Center v2.0</div>
            </div>
        </div>
        <div class="header-status">
            <div class="status-item"><span class="status-dot"></span><span>HUBSPOT SYNC</span></div>
            <div class="status-item"><span class="status-dot"></span><span>AI CORE ONLINE</span></div>
            <div class="status-item tasks-trigger" id="tasks-trigger" onclick="toggleTasksPanel()">
                <span class="status-dot warning" id="tasks-dot"></span>
                <span id="tasks-count">0 TASKS PENDING</span>
                <span style="font-size:0.6rem;opacity:0.5">‚ñº</span>
            </div>
            <div class="tasks-panel" id="tasks-panel">
                <div class="tasks-panel-header">
                    <span>‚ö° ACTIVE TASKS</span>
                    <button onclick="refreshTasks()" class="tasks-refresh">‚Üª</button>
                </div>
                <div class="tasks-list" id="tasks-list">
                    <div class="task-loading">SCANNING...</div>
                </div>
            </div>
        </div>
        <div class="header-actions">
            <div class="header-search" id="search-trigger"><span>üîç</span><span>SEARCH NEXUS...</span><kbd>CTRL+K</kbd></div>
            <button class="btn-nexus magenta" onclick="location.hash='#/ai/haiku'">GOD MODE</button>
        </div>
    </header>

    <nav class="nexus-sidebar">
        <div class="nav-section">
            <div class="nav-section-title">// CORE</div>
            <a href="#/" class="nav-item active" data-route="/"><span class="nav-icon">‚óâ</span><span class="nav-label">Dashboard</span></a>
            <a href="#/crm/contacts" class="nav-item" data-route="/crm/contacts"><span class="nav-icon">‚òÖ</span><span class="nav-label">Contacts</span></a>
            <a href="#/crm/companies" class="nav-item" data-route="/crm/companies"><span class="nav-icon">‚óß</span><span class="nav-label">Companies</span></a>
            <a href="#/crm/documentation" class="nav-item" data-route="/crm/documentation"><span class="nav-icon">üìã</span><span class="nav-label">Documentation</span></a>
            <a href="#/crm/interactions" class="nav-item" data-route="/crm/interactions"><span class="nav-icon">üìä</span><span class="nav-label">Interactions</span></a>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">// SALES</div>
            <a href="#/sales/deals" class="nav-item" data-route="/sales/deals"><span class="nav-icon">‚óÜ</span><span class="nav-label">Deals Pipeline</span></a>
            <a href="#/sales/leads" class="nav-item" data-route="/sales/leads"><span class="nav-icon">‚û§</span><span class="nav-label">Lead Discovery</span></a>
            <a href="#/sales/lead-generator" class="nav-item" data-route="/sales/lead-generator"><span class="nav-icon">üåç</span><span class="nav-label">Lead Generator</span></a>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">// NEURAL</div>
            <a href="#/ai/bots" class="nav-item" data-route="/ai/bots"><span class="nav-icon">‚öô</span><span class="nav-label">Bot Swarm</span></a>
            <a href="#/ai/haiku" class="nav-item" data-route="/ai/haiku"><span class="nav-icon">‚òÖ</span><span class="nav-label">HAIKU God Mode</span></a>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">// COMMS</div>
            <a href="#/email" class="nav-item" data-route="/email"><span class="nav-icon">‚úâ</span><span class="nav-label">Email Hub</span></a>
            <a href="#/whatsapp" class="nav-item" data-route="/whatsapp"><span class="nav-icon">‚òé</span><span class="nav-label">WhatsApp</span></a>
            <a href="#/campaigns" class="nav-item" data-route="/campaigns"><span class="nav-icon">‚ò¢</span><span class="nav-label">Campaigns</span></a>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">// FINANCE</div>
            <a href="#/finance/cashflow" class="nav-item" data-route="/finance/cashflow"><span class="nav-icon">‚ñ≤</span><span class="nav-label">Cashflow</span></a>
            <a href="#/finance/invoices" class="nav-item" data-route="/finance/invoices"><span class="nav-icon">‚óß</span><span class="nav-label">Invoices</span></a>
            <a href="#/finance/stripe" class="nav-item" data-route="/finance/stripe"><span class="nav-icon">‚óé</span><span class="nav-label">Stripe</span></a>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">// SYSTEM</div>
            <a href="#/integrations" class="nav-item" data-route="/integrations"><span class="nav-icon">‚ö°</span><span class="nav-label">Integrations</span></a>
            <a href="#/settings" class="nav-item" data-route="/settings"><span class="nav-icon">‚öô</span><span class="nav-label">Settings</span></a>
        </div>
    </nav>

    <main class="nexus-main">
        <div class="content-container" id="main-content"></div>
    </main>

    <div class="status-bar">
        <div class="status-bar-left">
            <div class="status-bar-item"><span class="dot"></span><span>HUBSPOT: CONNECTED</span></div>
            <div class="status-bar-item"><span class="dot"></span><span>STRIPE: ACTIVE</span></div>
            <div class="status-bar-item"><span class="dot"></span><span>WHATSAPP: READY</span></div>
        </div>
        <div class="status-bar-right">
            <div class="status-bar-item"><span id="current-time">--:--:--</span></div>
            <div class="status-bar-item"><span>NEXUS v2.0.0</span></div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Modal Title</h3>
                <button class="modal-close" onclick="NexusApp.closeModal()">√ó</button>
            </div>
            <div class="modal-body" id="modal-body"></div>
            <div class="modal-footer" id="modal-footer"></div>
        </div>
    </div>

    <script>
const ParticleSystem = {
    canvas: null, ctx: null, particles: [], particleCount: 80,
    init() {
        this.canvas = document.getElementById('particle-canvas');
        this.ctx = this.canvas.getContext('2d');
        this.resize();
        window.addEventListener('resize', () => this.resize());
        this.createParticles();
        this.animate();
    },
    resize() { this.canvas.width = window.innerWidth; this.canvas.height = window.innerHeight; },
    createParticles() {
        this.particles = [];
        for (let i = 0; i < this.particleCount; i++) {
            this.particles.push({
                x: Math.random() * this.canvas.width, y: Math.random() * this.canvas.height,
                vx: (Math.random() - 0.5) * 0.5, vy: (Math.random() - 0.5) * 0.5,
                size: Math.random() * 2 + 1, color: Math.random() > 0.5 ? '#00fff7' : '#ff00ff',
                alpha: Math.random() * 0.5 + 0.2
            });
        }
    },
    animate() {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        this.particles.forEach((p, i) => {
            p.x += p.vx; p.y += p.vy;
            if (p.x < 0) p.x = this.canvas.width; if (p.x > this.canvas.width) p.x = 0;
            if (p.y < 0) p.y = this.canvas.height; if (p.y > this.canvas.height) p.y = 0;
            this.ctx.beginPath(); this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            this.ctx.fillStyle = p.color; this.ctx.globalAlpha = p.alpha; this.ctx.fill();
            this.particles.slice(i + 1).forEach(p2 => {
                const dx = p.x - p2.x, dy = p.y - p2.y, dist = Math.sqrt(dx * dx + dy * dy);
                if (dist < 150) {
                    this.ctx.beginPath(); this.ctx.moveTo(p.x, p.y); this.ctx.lineTo(p2.x, p2.y);
                    this.ctx.strokeStyle = p.color; this.ctx.globalAlpha = (150 - dist) / 150 * 0.2; this.ctx.stroke();
                }
            });
        });
        this.ctx.globalAlpha = 1;
        requestAnimationFrame(() => this.animate());
    }
};

const API = {
    baseUrl: '',
    async get(endpoint) { try { const r = await fetch(this.baseUrl + endpoint); return r.ok ? await r.json() : null; } catch(e) { return null; } },
    async post(endpoint, data) { try { const r = await fetch(this.baseUrl + endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }); return r.ok ? await r.json() : null; } catch(e) { return null; } }
};

const DOM = {
    el(tag, attrs = {}, children = []) {
        const el = document.createElement(tag);
        Object.entries(attrs).forEach(([k, v]) => {
            if (k === 'className') el.className = v;
            else if (k === 'onclick') el.onclick = v;
            else if (k === 'style' && typeof v === 'object') Object.assign(el.style, v);
            else el.setAttribute(k, v);
        });
        (Array.isArray(children) ? children : [children]).filter(Boolean).forEach(c => { if (typeof c === 'string') el.appendChild(document.createTextNode(c)); else if (c instanceof Node) el.appendChild(c); });
        return el;
    },
    clear(c) { while (c.firstChild) c.removeChild(c.firstChild); }
};

function escapeHtml(t) { if (!t) return ''; const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
function formatCurrency(v, c = 'EUR') {
    const num = v || 0;
    const symbol = c === 'EUR' ? '‚Ç¨' : c;
    if (num >= 1000000000) return (num / 1000000000).toFixed(1).replace('.', ',') + ' Mrd ' + symbol;
    if (num >= 1000000) return (num / 1000000).toFixed(1).replace('.', ',') + ' Mio ' + symbol;
    if (num >= 1000) return (num / 1000).toFixed(0) + ' Tsd ' + symbol;
    return new Intl.NumberFormat('de-DE').format(num) + ' ' + symbol;
}
function formatNumber(v) {
    const num = v || 0;
    if (num >= 1000000000) return (num / 1000000000).toFixed(1).replace('.', ',') + ' Mrd';
    if (num >= 1000000) return (num / 1000000).toFixed(1).replace('.', ',') + ' Mio';
    if (num >= 100000) return (num / 1000).toFixed(0) + ' Tsd';
    return new Intl.NumberFormat('de-DE').format(num);
}
function generateHexData() { let h = ''; for (let i = 0; i < 32; i++) h += Math.floor(Math.random() * 16).toString(16).toUpperCase(); return h; }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TASKS PANEL - Real-time Bot Tasks
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let tasksData = { tasks: [], running: false, activeBots: 0 };
let tasksInterval = null;

function toggleTasksPanel() {
    const panel = document.getElementById('tasks-panel');
    const isVisible = panel.classList.contains('show');
    if (isVisible) {
        panel.classList.remove('show');
        clearInterval(tasksInterval);
        tasksInterval = null;
    } else {
        panel.classList.add('show');
        refreshTasks();
        tasksInterval = setInterval(refreshTasks, 5000); // Auto-refresh every 5s
    }
}

async function refreshTasks() {
    try {
        const [orchestrator, botTasks] = await Promise.all([
            API.get('/api/bot-orchestrator/status'),
            API.get('/api/bot-orchestrator/tasks')
        ]);

        tasksData = {
            running: orchestrator?.running || false,
            activeBots: orchestrator?.activeBots || 0,
            tasks: botTasks?.tasks || []
        };

        renderTasksList();
        updateTasksCount();
    } catch (e) {
        console.error('Tasks refresh error:', e);
    }
}

function updateTasksCount() {
    const countEl = document.getElementById('tasks-count');
    const dotEl = document.getElementById('tasks-dot');
    const activeCount = tasksData.activeBots || 0;
    const pendingTasks = tasksData.tasks.filter(t => isTaskDueSoon(t.schedule)).length;

    if (tasksData.running && activeCount > 0) {
        countEl.textContent = `${activeCount} RUNNING`;
        dotEl.className = 'status-dot active';
    } else if (pendingTasks > 0) {
        countEl.textContent = `${pendingTasks} SCHEDULED`;
        dotEl.className = 'status-dot warning';
    } else {
        countEl.textContent = '0 ACTIVE';
        dotEl.className = 'status-dot';
    }
}

function isTaskDueSoon(cronExpr) {
    if (!cronExpr) return false;
    const parts = cronExpr.split(' ');
    const minute = parts[0];
    const now = new Date();
    if (minute.startsWith('*/')) {
        const interval = parseInt(minute.slice(2));
        return now.getMinutes() % interval < 5;
    }
    if (minute === '0') return now.getMinutes() < 5;
    return false;
}

function getNextRunTime(cronExpr) {
    if (!cronExpr) return 'Unknown';
    const parts = cronExpr.split(' ');
    const minute = parts[0];
    const hour = parts[1];
    if (minute.startsWith('*/')) return `Every ${minute.slice(2)} min`;
    if (hour === '*') return `At :${minute.padStart(2, '0')}`;
    return `${hour}:${minute.padStart(2, '0')}`;
}

function renderTasksList() {
    const list = document.getElementById('tasks-list');
    if (!list) return;

    DOM.clear(list);

    if (!tasksData.tasks.length) {
        list.appendChild(DOM.el('div', { className: 'tasks-empty' }, 'NO ACTIVE TASKS'));
        return;
    }

    // Sort: running first, then scheduled soon, then by name
    const sorted = [...tasksData.tasks].sort((a, b) => {
        const aActive = tasksData.running && isTaskDueSoon(a.schedule);
        const bActive = tasksData.running && isTaskDueSoon(b.schedule);
        if (aActive !== bActive) return bActive - aActive;
        return a.name.localeCompare(b.name);
    }).slice(0, 10);

    sorted.forEach(task => {
        const isRunning = tasksData.running && isTaskDueSoon(task.schedule);
        const statusClass = isRunning ? 'running' : isTaskDueSoon(task.schedule) ? 'pending' : 'scheduled';

        list.appendChild(DOM.el('div', { className: 'task-item' }, [
            DOM.el('div', { className: `task-status ${statusClass}` }),
            DOM.el('div', { className: 'task-info' }, [
                DOM.el('div', { className: 'task-name' }, task.name || task.id),
                DOM.el('div', { className: 'task-desc' }, task.description || task.task)
            ]),
            DOM.el('div', { className: 'task-time' }, getNextRunTime(task.schedule))
        ]));
    });

    if (tasksData.tasks.length > 10) {
        list.appendChild(DOM.el('div', { className: 'task-item', style: { justifyContent: 'center', color: 'var(--text-muted)' } },
            `+${tasksData.tasks.length - 10} more tasks`
        ));
    }
}

// Close tasks panel when clicking outside
document.addEventListener('click', (e) => {
    const panel = document.getElementById('tasks-panel');
    const trigger = document.getElementById('tasks-trigger');
    if (panel && trigger && !trigger.contains(e.target) && !panel.contains(e.target)) {
        panel.classList.remove('show');
        if (tasksInterval) { clearInterval(tasksInterval); tasksInterval = null; }
    }
});

// Initial tasks count update
setTimeout(() => refreshTasks().then(updateTasksCount), 1000);

const Router = {
    routes: { '/': 'renderDashboard', '/crm/contacts': 'renderContacts', '/crm/companies': 'renderCompanies', '/crm/documentation': 'renderDocumentation', '/crm/interactions': 'renderInteractionTracker', '/sales/deals': 'renderDeals', '/sales/leads': 'renderLeadDiscovery', '/sales/lead-generator': 'renderLeadGenerator', '/ai/bots': 'renderBots', '/ai/haiku': 'renderHaiku', '/email': 'renderEmailHub', '/whatsapp': 'renderWhatsApp', '/campaigns': 'renderCampaigns', '/finance/cashflow': 'renderCashflow', '/finance/invoices': 'renderInvoices', '/finance/stripe': 'renderStripe', '/integrations': 'renderIntegrations', '/settings': 'renderSettings' },
    init() { window.addEventListener('hashchange', () => this.navigate()); this.navigate(); },
    navigate() {
        const hash = window.location.hash.slice(1) || '/';
        this.updateActiveMenu(hash);
        const route = this.routes[hash];
        if (route && typeof Modules[route] === 'function') Modules[route](); else Modules.render404();
    },
    updateActiveMenu(path) { document.querySelectorAll('.nav-item').forEach(item => item.classList.toggle('active', item.dataset.route === path)); }
};

const Modules = {
    container() { return document.getElementById('main-content'); },

    async renderDashboard() {
        const c = this.container(); DOM.clear(c);
        c.appendChild(DOM.el('div', { className: 'page-header' }, [
            DOM.el('h1', { className: 'page-title' }, [document.createTextNode('SYSTEM '), DOM.el('span', {}, ['OVERVIEW'])]),
            DOM.el('div', { className: 'flex gap-2' }, [
                DOM.el('button', { className: 'btn-nexus', onclick: () => NexusApp.refreshDashboard() }, 'REFRESH DATA'),
                DOM.el('button', { className: 'btn-nexus magenta', onclick: () => location.hash = '#/ai/haiku' }, 'GOD MODE')
            ])
        ]));

        const kpiGrid = DOM.el('div', { className: 'kpi-grid', id: 'kpi-grid' });
        for (let i = 0; i < 4; i++) kpiGrid.appendChild(DOM.el('div', { className: 'loading-skeleton', style: { height: '120px' } }));
        c.appendChild(kpiGrid);

        const mainGrid = DOM.el('div', { className: 'grid-3 mt-3' });

        // TOP DEALS Widget (Functional)
        mainGrid.appendChild(DOM.el('div', { className: 'cyber-card' }, [
            DOM.el('div', { className: 'card-header' }, [DOM.el('span', { className: 'card-title' }, 'TOP DEALS')]),
            DOM.el('div', { className: 'card-body', id: 'top-deals' }, [DOM.el('div', { className: 'loading-skeleton', style: { height: '180px' } })])
        ]));

        // Neural Network (Keep per user request)
        mainGrid.appendChild(DOM.el('div', { className: 'cyber-card' }, [
            DOM.el('div', { className: 'card-header' }, [DOM.el('span', { className: 'card-title' }, 'NEURAL ACTIVITY')]),
            DOM.el('div', { className: 'card-body' }, [DOM.el('div', { className: 'neural-network', id: 'neural-network' })])
        ]));

        // SYSTEM STATUS Widget (Functional)
        mainGrid.appendChild(DOM.el('div', { className: 'cyber-card' }, [
            DOM.el('div', { className: 'card-header' }, [DOM.el('span', { className: 'card-title' }, 'SYSTEM STATUS')]),
            DOM.el('div', { className: 'card-body', id: 'system-status' }, [DOM.el('div', { className: 'loading-skeleton', style: { height: '180px' } })])
        ]));
        c.appendChild(mainGrid);

        // Second Row
        const secondRow = DOM.el('div', { className: 'grid-2 mt-3' });
        secondRow.appendChild(DOM.el('div', { className: 'cyber-card' }, [
            DOM.el('div', { className: 'card-header' }, [DOM.el('span', { className: 'card-title' }, 'PIPELINE STATUS')]),
            DOM.el('div', { className: 'card-body' }, [DOM.el('canvas', { id: 'pipeline-chart', style: { height: '200px' } })])
        ]));
        secondRow.appendChild(DOM.el('div', { className: 'cyber-card' }, [
            DOM.el('div', { className: 'card-header' }, [DOM.el('span', { className: 'card-title' }, 'RECENT TRANSMISSIONS')]),
            DOM.el('div', { className: 'card-body', id: 'recent-activity' }, [DOM.el('div', { className: 'loading-skeleton', style: { height: '200px' } })])
        ]));
        c.appendChild(secondRow);

        this.loadDashboardData();
        this.initNeuralNetwork();
    },

    async loadDashboardData() {
        const data = await API.get('/api/overview');
        const kpiGrid = document.getElementById('kpi-grid');
        if (data && kpiGrid) {
            DOM.clear(kpiGrid);
            const m = data.metrics || {};
            const kpis = [
                { label: 'TOTAL CONTACTS', value: formatNumber(m.contacts?.rawValue || 0), class: '' },
                { label: 'ACTIVE DEALS', value: formatNumber(m.pipeline?.openDeals || 0), class: 'magenta' },
                { label: 'PIPELINE VALUE', value: formatCurrency(m.pipeline?.rawValue || 0), class: 'cyan' },
                { label: 'REVENUE WON', value: formatCurrency(m.revenue?.rawValue || 0), class: 'green' }
            ];
            kpis.forEach(kpi => {
                kpiGrid.appendChild(DOM.el('div', { className: 'kpi-card ' + kpi.class }, [
                    DOM.el('div', { className: 'kpi-label' }, [kpi.label]),
                    DOM.el('div', { className: 'kpi-value' }, [kpi.value]),
                    DOM.el('div', { className: 'kpi-change' }, ['+12.5% ‚Üë'])
                ]));
            });
        }
        this.loadPipelineChart(data);
        this.loadRecentActivity();
        this.loadTopDeals();
        this.loadSystemStatus();
    },

    async loadPipelineChart(data) {
        const ctx = document.getElementById('pipeline-chart');
        if (!ctx) return;
        const stats = await API.get('/api/hubspot/deals/pipeline-stats');
        const s = stats?.stageStats || {};
        const chartData = [
            s.qualifiedtobuy?.count || 0,
            s.presentationscheduled?.count || 0,
            s.decisionmakerboughtin?.count || 0,
            s.appointmentscheduled?.count || 0,
            s.closedwon?.count || 0
        ];
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Qualified', 'Presentation', 'Decision', 'Scheduled', 'Won'],
                datasets: [{ label: 'Deals', data: chartData,
                    backgroundColor: ['rgba(0,255,247,0.6)', 'rgba(255,0,255,0.6)', 'rgba(255,0,128,0.6)', 'rgba(128,0,255,0.6)', 'rgba(0,255,136,0.6)'],
                    borderColor: ['#00fff7', '#ff00ff', '#ff0080', '#8000ff', '#00ff88'], borderWidth: 2 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true, grid: { color: 'rgba(0,255,247,0.1)' }, ticks: { color: '#a0a0b0', callback: v => v >= 1000000 ? (v/1000000).toFixed(1)+'M' : v >= 1000 ? (v/1000).toFixed(0)+'K' : v } }, x: { grid: { display: false }, ticks: { color: '#a0a0b0' } } } }
        });
    },

    async loadRecentActivity() {
        const c = document.getElementById('recent-activity'); if (!c) return;
        const contacts = await API.get('/api/hubspot/contacts?limit=5');
        DOM.clear(c);
        if (contacts?.contacts?.length) {
            contacts.contacts.forEach(contact => {
                c.appendChild(DOM.el('div', { className: 'flex items-center justify-between', style: { padding: '0.75rem 0', borderBottom: '1px solid var(--border-dim)' } }, [
                    DOM.el('div', {}, [
                        DOM.el('div', { style: { color: 'var(--neon-cyan)' } }, [escapeHtml((contact.properties?.firstname || '') + ' ' + (contact.properties?.lastname || '')) || 'Unknown']),
                        DOM.el('div', { style: { fontSize: '0.8rem', color: 'var(--text-muted)' } }, [escapeHtml(contact.properties?.email || '-')])
                    ]),
                    DOM.el('span', { className: 'cyber-badge cyan' }, ['NEW'])
                ]));
            });
        } else { c.appendChild(DOM.el('div', { style: { color: 'var(--text-muted)', textAlign: 'center', padding: '2rem' } }, ['NO DATA AVAILABLE'])); }
    },

    async loadTopDeals() {
        const c = document.getElementById('top-deals'); if (!c) return;
        try {
            const deals = await API.get('/api/hubspot/deals?limit=5');
            DOM.clear(c);
            if (deals?.deals?.length) {
                const sorted = deals.deals.sort((a, b) => (parseFloat(b.properties?.amount) || 0) - (parseFloat(a.properties?.amount) || 0)).slice(0, 5);
                sorted.forEach(deal => {
                    const amount = parseFloat(deal.properties?.amount) || 0;
                    const stage = deal.properties?.dealstage || 'unknown';
                    const stageColor = stage.includes('won') ? 'green' : stage.includes('lost') ? 'red' : 'cyan';
                    c.appendChild(DOM.el('div', { style: { padding: '0.5rem 0', borderBottom: '1px solid var(--border-dim)', display: 'flex', justifyContent: 'space-between', alignItems: 'center' } }, [
                        DOM.el('div', { style: { flex: 1, minWidth: 0 } }, [
                            DOM.el('div', { style: { color: 'var(--text-primary)', fontSize: '0.85rem', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' } }, [escapeHtml(deal.properties?.dealname || 'Unnamed Deal')]),
                            DOM.el('div', { style: { fontSize: '0.7rem', color: 'var(--text-muted)' } }, [stage.replace(/_/g, ' ').toUpperCase()])
                        ]),
                        DOM.el('span', { style: { color: 'var(--neon-' + stageColor + ')', fontFamily: "'Orbitron', monospace", fontSize: '0.8rem' } }, [formatCurrency(amount)])
                    ]));
                });
            } else {
                c.appendChild(DOM.el('div', { style: { color: 'var(--text-muted)', textAlign: 'center', padding: '2rem' } }, ['NO DEALS']));
            }
        } catch (e) { c.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 2rem;">ERROR LOADING</div>'; }
    },

    async loadSystemStatus() {
        const c = document.getElementById('system-status'); if (!c) return;
        try {
            const [health, bots, overview] = await Promise.all([
                API.get('/api/health').catch(() => ({ status: 'unknown' })),
                API.get('/api/bot-orchestrator/status').catch(() => ({ running: false, totalBots: 0 })),
                API.get('/api/overview').catch(() => ({}))
            ]);
            DOM.clear(c);
            const items = [
                { label: 'API SERVER', value: health?.status === 'online' ? 'ONLINE' : 'OFFLINE', status: health?.status === 'online' },
                { label: 'BOT ORCHESTRATOR', value: bots?.running ? 'RUNNING' : 'STANDBY', status: bots?.running },
                { label: 'TOTAL BOTS', value: (bots?.totalBots || 0) + ' CONFIGURED', status: true },
                { label: 'HUBSPOT SYNC', value: overview?.integrations?.hubspot ? 'CONNECTED' : 'DISCONNECTED', status: overview?.integrations?.hubspot },
                { label: 'LAST UPDATE', value: new Date().toLocaleTimeString('de-DE'), status: true }
            ];
            items.forEach(item => {
                c.appendChild(DOM.el('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '0.4rem 0', borderBottom: '1px solid var(--border-dim)' } }, [
                    DOM.el('span', { style: { color: 'var(--text-muted)', fontSize: '0.75rem', fontFamily: "'Share Tech Mono', monospace" } }, [item.label]),
                    DOM.el('span', { style: { color: item.status ? 'var(--neon-green)' : 'var(--neon-red)', fontSize: '0.75rem', fontFamily: "'Orbitron', monospace" } }, [item.value])
                ]));
            });
        } catch (e) { c.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 2rem;">ERROR LOADING</div>'; }
    },

    initNeuralNetwork() {
        const c = document.getElementById('neural-network'); if (!c) return;
        DOM.clear(c);
        const nodes = [];
        for (let i = 0; i < 12; i++) {
            const x = 10 + Math.random() * 80, y = 10 + Math.random() * 80;
            const node = DOM.el('div', { className: 'neural-node', style: { left: x + '%', top: y + '%', animationDelay: Math.random() * 2 + 's' } });
            nodes.push({ el: node, x, y }); c.appendChild(node);
        }
        for (let i = 0; i < nodes.length; i++) {
            for (let j = i + 1; j < nodes.length; j++) {
                const dx = nodes[j].x - nodes[i].x, dy = nodes[j].y - nodes[i].y, dist = Math.sqrt(dx * dx + dy * dy);
                if (dist < 40) {
                    const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                    c.appendChild(DOM.el('div', { className: 'neural-connection', style: { left: nodes[i].x + '%', top: nodes[i].y + '%', width: dist + '%', transform: 'rotate(' + angle + 'deg)' } }));
                }
            }
        }
    },

    initDataStream() {
        const c = document.getElementById('data-stream'); if (!c) return; DOM.clear(c);
        const update = () => {
            c.appendChild(DOM.el('div', { className: 'data-stream-line' }, ['[' + new Date().toISOString() + '] ' + generateHexData()]));
            if (c.children.length > 15) c.removeChild(c.firstChild);
        };
        setInterval(update, 800);
        for (let i = 0; i < 10; i++) update();
    },

    async renderContacts() {
        const c = this.container(); DOM.clear(c);
        c.appendChild(DOM.el('div', { className: 'page-header' }, [
            DOM.el('h1', { className: 'page-title' }, [document.createTextNode('CONTACT '), DOM.el('span', {}, ['DATABASE'])]),
            DOM.el('button', { className: 'btn-nexus', onclick: () => NexusApp.showNewContactModal() }, '+ NEW CONTACT')
        ]));
        c.appendChild(DOM.el('div', { className: 'cyber-card' }, [
            DOM.el('div', { className: 'card-body' }, [
                DOM.el('table', { className: 'cyber-table' }, [
                    DOM.el('thead', {}, [DOM.el('tr', {}, [DOM.el('th', {}, ['NAME']), DOM.el('th', {}, ['EMAIL']), DOM.el('th', {}, ['COMPANY']), DOM.el('th', {}, ['STATUS']), DOM.el('th', {}, ['ACTIONS'])])]),
                    DOM.el('tbody', { id: 'contacts-tbody' }, [DOM.el('tr', {}, [DOM.el('td', { colspan: '5' }, [DOM.el('div', { className: 'loading-skeleton', style: { height: '200px' } })])])])
                ])
            ])
        ]));
        this.loadContacts();
    },

    async loadContacts() {
        const tbody = document.getElementById('contacts-tbody'); if (!tbody) return;
        const data = await API.get('/api/hubspot/contacts?limit=100'); DOM.clear(tbody);
        if (data?.contacts?.length) {
            data.contacts.forEach(contact => {
                const p = contact.properties || {};
                tbody.appendChild(DOM.el('tr', {}, [
                    DOM.el('td', { className: 'highlight' }, [escapeHtml((p.firstname || '') + ' ' + (p.lastname || '')).trim() || 'Unknown']),
                    DOM.el('td', {}, [escapeHtml(p.email || '-')]),
                    DOM.el('td', {}, [escapeHtml(p.company || '-')]),
                    DOM.el('td', {}, [DOM.el('span', { className: 'cyber-badge cyan' }, [p.lifecyclestage || 'LEAD'])]),
                    DOM.el('td', {}, [DOM.el('button', { className: 'btn-nexus', style: { padding: '0.3rem 0.6rem', fontSize: '0.65rem' }, onclick: () => NexusApp.showContactDetail(contact.id) }, 'VIEW')])
                ]));
            });
        } else { tbody.appendChild(DOM.el('tr', {}, [DOM.el('td', { colspan: '5', style: { textAlign: 'center', color: 'var(--text-muted)' } }, ['NO CONTACTS FOUND'])])); }
    },

    async renderDeals() {
        const c = this.container(); DOM.clear(c);
        c.appendChild(DOM.el('div', { className: 'page-header' }, [
            DOM.el('h1', { className: 'page-title' }, [document.createTextNode('DEALS '), DOM.el('span', {}, ['PIPELINE'])]),
            DOM.el('button', { className: 'btn-nexus', onclick: () => NexusApp.showNewDealModal() }, '+ NEW DEAL')
        ]));
        c.appendChild(DOM.el('div', { className: 'kpi-grid', id: 'deals-stats' }, [
            DOM.el('div', { className: 'loading-skeleton', style: { height: '100px' } }),
            DOM.el('div', { className: 'loading-skeleton', style: { height: '100px' } }),
            DOM.el('div', { className: 'loading-skeleton', style: { height: '100px' } }),
            DOM.el('div', { className: 'loading-skeleton', style: { height: '100px' } })
        ]));
        c.appendChild(DOM.el('div', { className: 'cyber-card mt-3' }, [
            DOM.el('div', { className: 'card-header' }, [DOM.el('span', { className: 'card-title' }, 'PIPELINE KANBAN')]),
            DOM.el('div', { className: 'card-body', id: 'deals-kanban', style: { minHeight: '400px' } }, [DOM.el('div', { className: 'loading-skeleton', style: { height: '300px' } })])
        ]));
        this.loadDealsData();
    },

    async loadDealsData() {
        const stats = await API.get('/api/hubspot/deals/pipeline-stats');
        const sc = document.getElementById('deals-stats');
        if (stats && sc) {
            DOM.clear(sc);
            const totalDeals = stats.totalDeals || 0;
            const pipelineValue = stats.pipelineValue || 0;
            const wonValue = stats.wonValue || 0;
            const avgValue = totalDeals > 0 ? pipelineValue / totalDeals : 0;
            const wonCount = stats.stageStats?.closedwon?.count || 0;
            const lostCount = stats.stageStats?.closedlost?.count || 0;
            const winRate = (wonCount + lostCount) > 0 ? (wonCount / (wonCount + lostCount)) * 100 : 0;
            [{ label: 'TOTAL DEALS', value: formatNumber(totalDeals), class: '' },
             { label: 'PIPELINE VALUE', value: formatCurrency(pipelineValue), class: 'magenta' },
             { label: 'WON VALUE', value: formatCurrency(wonValue), class: 'green' },
             { label: 'WIN RATE', value: winRate.toFixed(1) + '%', class: 'yellow' }
            ].forEach(k => sc.appendChild(DOM.el('div', { className: 'kpi-card ' + k.class }, [DOM.el('div', { className: 'kpi-label' }, [k.label]), DOM.el('div', { className: 'kpi-value' }, [k.value])])));
        }
        this.loadDealsKanban();
    },

    async loadDealsKanban() {
        const kanban = document.getElementById('deals-kanban'); if (!kanban) return;

        // Use new API that includes contact data
        const deals = await API.get('/api/hubspot/deals/with-contacts?limit=100'); DOM.clear(kanban);
        const stages = [
            { id: 'qualifiedtobuy', name: 'QUALIFIED', color: 'cyan' },
            { id: 'presentationscheduled', name: 'PRESENTATION', color: 'magenta' },
            { id: 'decisionmakerboughtin', name: 'DECISION', color: 'pink' },
            { id: 'closedwon', name: 'WON', color: 'green' }
        ];
        const grid = DOM.el('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '1rem' } });

        stages.forEach(stage => {
            const stageDeals = deals?.deals?.filter(d => d.properties?.dealstage === stage.id) || [];
            const stageValue = stageDeals.reduce((sum, d) => sum + (parseFloat(d.properties?.amount) || 0), 0);

            const col = DOM.el('div', { style: { minHeight: '300px' } }, [
                DOM.el('div', { style: { padding: '0.75rem', background: 'rgba(0,255,247,0.1)', borderLeft: '3px solid var(--neon-' + stage.color + ')', marginBottom: '1rem' } }, [
                    DOM.el('div', { style: { fontFamily: 'Orbitron', fontSize: '0.75rem', color: 'var(--neon-' + stage.color + ')' } }, [stage.name]),
                    DOM.el('div', { style: { fontSize: '0.7rem', color: 'var(--text-muted)', marginTop: '0.25rem' } }, [stageDeals.length + ' DEALS ‚Ä¢ ' + formatCurrency(stageValue)])
                ])
            ]);

            stageDeals.slice(0, 8).forEach(deal => {
                const contact = deal.contact;
                const hasEmail = contact?.email;

                col.appendChild(DOM.el('div', {
                    className: 'cyber-card',
                    style: { padding: '0.75rem', marginBottom: '0.5rem', cursor: 'pointer', borderLeft: hasEmail ? '3px solid var(--neon-green)' : '3px solid var(--neon-magenta)' },
                    onclick: () => NexusApp.showDealDetail(deal.id)
                }, [
                    DOM.el('div', { style: { fontSize: '0.85rem', color: 'var(--neon-cyan)', marginBottom: '0.3rem' } }, [escapeHtml(deal.properties?.dealname || 'Unnamed Deal')]),
                    DOM.el('div', { style: { fontSize: '1rem', fontFamily: 'Orbitron', marginBottom: '0.4rem' } }, [formatCurrency(deal.properties?.amount || 0)]),
                    DOM.el('div', { style: { borderTop: '1px solid var(--border-dim)', paddingTop: '0.4rem', marginTop: '0.3rem' } }, [
                        contact ? DOM.el('div', { style: { display: 'flex', alignItems: 'center', gap: '0.3rem' } }, [
                            DOM.el('span', { style: { fontSize: '0.7rem' } }, ['üë§']),
                            DOM.el('span', { style: { fontSize: '0.75rem', color: 'var(--text-bright)' } }, [escapeHtml(contact.name)])
                        ]) : DOM.el('div', { style: { fontSize: '0.7rem', color: 'var(--text-muted)' } }, ['‚ö† Kein Kontakt']),
                        contact?.email ? DOM.el('div', { style: { display: 'flex', alignItems: 'center', gap: '0.3rem', marginTop: '0.2rem' } }, [
                            DOM.el('span', { style: { fontSize: '0.7rem' } }, ['üìß']),
                            DOM.el('a', {
                                href: 'mailto:' + contact.email,
                                style: { fontSize: '0.7rem', color: 'var(--neon-green)', textDecoration: 'none' },
                                onclick: (e) => e.stopPropagation()
                            }, [escapeHtml(contact.email)])
                        ]) : (contact ? DOM.el('div', { style: { fontSize: '0.7rem', color: 'var(--neon-magenta)', marginTop: '0.2rem' } }, ['‚ö† Keine Email']) : null)
                    ].filter(Boolean))
                ]));
            });

            if (stageDeals.length > 8) {
                col.appendChild(DOM.el('div', {
                    style: { textAlign: 'center', padding: '0.5rem', color: 'var(--text-muted)', fontSize: '0.7rem' }
                }, [`+ ${stageDeals.length - 8} weitere`]));
            }

            grid.appendChild(col);
        });
        kanban.appendChild(grid);
    },

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // COMPANIES MODULE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async renderCompanies() {
        const c = this.container(); DOM.clear(c);
        c.appendChild(DOM.el('div', { className: 'page-header' }, [
            DOM.el('h1', { className: 'page-title' }, [document.createTextNode('COMPANY '), DOM.el('span', {}, ['DATABASE'])]),
            DOM.el('button', { className: 'btn-nexus', onclick: () => NexusApp.showNewCompanyModal() }, '+ NEW COMPANY')
        ]));
        c.appendChild(DOM.el('div', { className: 'cyber-card' }, [
            DOM.el('table', { className: 'cyber-table' }, [
                DOM.el('thead', {}, [DOM.el('tr', {}, [
                    DOM.el('th', {}, ['NAME']), DOM.el('th', {}, ['DOMAIN']), DOM.el('th', {}, ['INDUSTRY']), DOM.el('th', {}, ['EMPLOYEES']), DOM.el('th', {}, ['ACTIONS'])
                ])]),
                DOM.el('tbody', { id: 'companies-tbody' }, [DOM.el('tr', {}, [DOM.el('td', { colspan: '5' }, [DOM.el('div', { className: 'loading-skeleton', style: { height: '200px' } })])])])
            ])
        ]));
        this.loadCompanies();
    },
    async loadCompanies() {
        const tbody = document.getElementById('companies-tbody'); if (!tbody) return;
        const data = await API.get('/api/hubspot/companies?limit=100'); DOM.clear(tbody);
        if (data?.companies?.length) {
            data.companies.forEach(company => {
                const p = company.properties || {};
                tbody.appendChild(DOM.el('tr', {}, [
                    DOM.el('td', { className: 'highlight' }, [escapeHtml(p.name || 'Unknown')]),
                    DOM.el('td', {}, [escapeHtml(p.domain || '-')]),
                    DOM.el('td', {}, [escapeHtml(p.industry || '-')]),
                    DOM.el('td', {}, [escapeHtml(p.numberofemployees || '-')]),
                    DOM.el('td', {}, [DOM.el('button', { className: 'btn-nexus', style: { padding: '0.3rem 0.6rem', fontSize: '0.65rem' } }, 'VIEW')])
                ]));
            });
        } else { tbody.appendChild(DOM.el('tr', {}, [DOM.el('td', { colspan: '5', style: { textAlign: 'center', color: 'var(--text-muted)' } }, ['NO COMPANIES FOUND'])])); }
    },

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // LEAD DISCOVERY MODULE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async renderLeadDiscovery() {
        const c = this.container(); DOM.clear(c);
        c.appendChild(DOM.el('div', { className: 'page-header' }, [
            DOM.el('h1', { className: 'page-title' }, [document.createTextNode('LEAD '), DOM.el('span', {}, ['DISCOVERY'])]),
            DOM.el('button', { className: 'btn-nexus magenta', onclick: () => NexusApp.startLeadScan() }, '‚ö° START SCAN')
        ]));
        c.appendChild(DOM.el('div', { className: 'kpi-grid', id: 'lead-discovery-stats' }, [
            DOM.el('div', { className: 'loading-skeleton', style: { height: '100px' } }),
            DOM.el('div', { className: 'loading-skeleton', style: { height: '100px' } }),
            DOM.el('div', { className: 'loading-skeleton', style: { height: '100px' } }),
            DOM.el('div', { className: 'loading-skeleton', style: { height: '100px' } })
        ]));
        c.appendChild(DOM.el('div', { className: 'cyber-card', style: { marginTop: '1rem' } }, [
            DOM.el('div', { className: 'card-header' }, [DOM.el('span', { className: 'card-title' }, 'RECENT DISCOVERIES')]),
            DOM.el('div', { className: 'card-body', id: 'lead-discoveries' }, [DOM.el('div', { className: 'loading-skeleton', style: { height: '200px' } })])
        ]));
        this.loadLeadDiscoveryData();
    },
    async loadLeadDiscoveryData() {
        const [status, stats] = await Promise.all([
            API.get('/api/lead-discovery/status'),
            API.get('/api/hubspot/stats')
        ]);
        const sc = document.getElementById('lead-discovery-stats');
        if (sc) {
            DOM.clear(sc);
            [{ label: 'TOTAL CONTACTS', value: formatNumber(stats?.contacts || 0), class: 'cyan' },
             { label: 'TOTAL COMPANIES', value: formatNumber(stats?.companies || 0), class: 'magenta' },
             { label: 'TOTAL DEALS', value: formatNumber(stats?.deals || 0), class: 'green' },
             { label: 'SCAN STATUS', value: status?.running ? '‚ö° ACTIVE' : '‚óØ READY', class: status?.running ? 'green' : '' }
            ].forEach(k => sc.appendChild(DOM.el('div', { className: 'kpi-card ' + k.class }, [DOM.el('div', { className: 'kpi-label' }, [k.label]), DOM.el('div', { className: 'kpi-value' }, [k.value])])));
        }
        const recent = await API.get('/api/hubspot/contacts?limit=50');
        const ld = document.getElementById('lead-discoveries');
        if (ld) {
            DOM.clear(ld);
            if (recent?.contacts?.length) {
                recent.contacts.forEach(contact => {
                    const p = contact.properties || {};
                    const name = ((p.firstname || '') + ' ' + (p.lastname || '')).trim() || p.company || 'Unknown';
                    const stage = p.lifecyclestage || 'lead';
                    ld.appendChild(DOM.el('div', { style: { padding: '0.75rem 0', borderBottom: '1px solid var(--border-dim)', display: 'flex', justifyContent: 'space-between', alignItems: 'center' } }, [
                        DOM.el('div', {}, [
                            DOM.el('div', { style: { color: 'var(--neon-cyan)' } }, [escapeHtml(name)]),
                            DOM.el('div', { style: { fontSize: '0.8rem', color: 'var(--text-muted)' } }, [escapeHtml(p.email || '-')])
                        ]),
                        DOM.el('span', { className: 'cyber-badge ' + (stage === 'customer' ? 'green' : stage === 'opportunity' ? 'magenta' : 'cyan') }, [stage.toUpperCase()])
                    ]));
                });
            } else { ld.appendChild(DOM.el('div', { style: { textAlign: 'center', color: 'var(--text-muted)', padding: '2rem' } }, ['No contacts found'])); }
        }
    },

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // AUTO LEAD GENERATOR MODULE - Worldwide B2B Lead Generation
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    leadGenState: { refreshInterval: null },

    async renderLeadGenerator() {
        const c = this.container(); DOM.clear(c);

        c.appendChild(DOM.el('div', { className: 'page-header' }, [
            DOM.el('h1', { className: 'page-title' }, [document.createTextNode('AUTO LEAD '), DOM.el('span', {}, ['GENERATOR'])]),
            DOM.el('div', { style: { display: 'flex', gap: '0.5rem' } }, [
                DOM.el('button', { className: 'btn-nexus green', id: 'lg-start-btn', onclick: () => NexusApp.toggleLeadGenerator() }, '‚ñ∂ START'),
                DOM.el('button', { className: 'btn-nexus', onclick: () => NexusApp.generateLeadBatch() }, '‚ö° GENERATE BATCH'),
                DOM.el('button', { className: 'btn-nexus magenta', onclick: () => NexusApp.showLeadGenConfig() }, '‚öô CONFIG')
            ])
        ]));

        // KPI Cards
        c.appendChild(DOM.el('div', { className: 'kpi-grid', id: 'leadgen-kpis' }, [
            DOM.el('div', { className: 'loading-skeleton', style: { height: '100px' } }),
            DOM.el('div', { className: 'loading-skeleton', style: { height: '100px' } }),
            DOM.el('div', { className: 'loading-skeleton', style: { height: '100px' } }),
            DOM.el('div', { className: 'loading-skeleton', style: { height: '100px' } })
        ]));

        // Status Card
        c.appendChild(DOM.el('div', { className: 'cyber-card mt-3', id: 'leadgen-status' }, [
            DOM.el('div', { className: 'card-header' }, [
                DOM.el('span', { className: 'card-title' }, 'GENERATOR STATUS'),
                DOM.el('span', { className: 'cyber-badge', id: 'lg-status-badge' }, 'LOADING...')
            ]),
            DOM.el('div', { className: 'card-body', style: { padding: '1rem' } }, [
                DOM.el('div', { className: 'loading-skeleton', style: { height: '150px' } })
            ])
        ]));

        // Region Distribution
        c.appendChild(DOM.el('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginTop: '1rem' } }, [
            DOM.el('div', { className: 'cyber-card' }, [
                DOM.el('div', { className: 'card-header' }, [DOM.el('span', { className: 'card-title' }, 'üåç REGION DISTRIBUTION')]),
                DOM.el('div', { className: 'card-body', id: 'leadgen-regions' }, [DOM.el('div', { className: 'loading-skeleton', style: { height: '200px' } })])
            ]),
            DOM.el('div', { className: 'cyber-card' }, [
                DOM.el('div', { className: 'card-header' }, [DOM.el('span', { className: 'card-title' }, 'üè≠ TOP INDUSTRIES')]),
                DOM.el('div', { className: 'card-body', id: 'leadgen-industries' }, [DOM.el('div', { className: 'loading-skeleton', style: { height: '200px' } })])
            ])
        ]));

        // Preview Section
        c.appendChild(DOM.el('div', { className: 'cyber-card mt-3' }, [
            DOM.el('div', { className: 'card-header' }, [
                DOM.el('span', { className: 'card-title' }, 'üëÅ LEAD PREVIEW'),
                DOM.el('button', { className: 'btn-nexus', style: { padding: '0.3rem 0.6rem', fontSize: '0.7rem' }, onclick: () => NexusApp.refreshLeadPreview() }, '‚Üª REFRESH')
            ]),
            DOM.el('div', { className: 'card-body', id: 'leadgen-preview' }, [DOM.el('div', { className: 'loading-skeleton', style: { height: '200px' } })])
        ]));

        // Load data
        this.loadLeadGeneratorData();

        // Auto-refresh every 5 seconds
        if (this.leadGenState.refreshInterval) clearInterval(this.leadGenState.refreshInterval);
        this.leadGenState.refreshInterval = setInterval(() => this.loadLeadGeneratorData(), 5000);
    },

    async loadLeadGeneratorData() {
        const status = await API.get('/api/v1/lead-generator/status');
        if (!status) return;

        // Update KPIs
        const kpis = document.getElementById('leadgen-kpis');
        if (kpis) {
            DOM.clear(kpis);
            const runtime = status.runtime ? `${Math.floor(status.runtime / 60)}m ${status.runtime % 60}s` : '-';
            const rate = status.runtime > 0 ? Math.round(status.stats.generated / (status.runtime / 3600)) : 0;
            [
                { label: 'GENERATED', value: formatNumber(status.stats.generated), class: 'cyan' },
                { label: 'UPLOADED', value: formatNumber(status.stats.uploaded), class: 'green' },
                { label: 'FAILED', value: formatNumber(status.stats.failed), class: status.stats.failed > 0 ? 'magenta' : '' },
                { label: 'RATE/HOUR', value: formatNumber(rate), class: 'yellow' }
            ].forEach(k => kpis.appendChild(DOM.el('div', { className: 'kpi-card ' + k.class }, [
                DOM.el('div', { className: 'kpi-label' }, [k.label]),
                DOM.el('div', { className: 'kpi-value' }, [k.value])
            ])));
        }

        // Update status badge & button
        const badge = document.getElementById('lg-status-badge');
        const btn = document.getElementById('lg-start-btn');
        if (badge) {
            badge.className = 'cyber-badge ' + (status.running ? (status.paused ? 'yellow' : 'green') : '');
            badge.textContent = status.running ? (status.paused ? '‚è∏ PAUSED' : '‚óè RUNNING') : '‚óã STOPPED';
        }
        if (btn) {
            btn.className = 'btn-nexus ' + (status.running ? 'magenta' : 'green');
            btn.textContent = status.running ? '‚óº STOP' : '‚ñ∂ START';
        }

        // Update status content
        const statusCard = document.getElementById('leadgen-status');
        if (statusCard) {
            const body = statusCard.querySelector('.card-body');
            if (body) {
                DOM.clear(body);
                body.appendChild(DOM.el('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '1rem' } }, [
                    DOM.el('div', { style: { padding: '1rem', background: 'rgba(0,255,247,0.05)', borderRadius: '8px' } }, [
                        DOM.el('div', { style: { fontSize: '0.7rem', color: 'var(--text-muted)' } }, ['BATCH SIZE']),
                        DOM.el('div', { style: { fontSize: '1.2rem', fontFamily: 'Orbitron', color: 'var(--neon-cyan)' } }, [String(status.config.leadsPerBatch)])
                    ]),
                    DOM.el('div', { style: { padding: '1rem', background: 'rgba(0,255,247,0.05)', borderRadius: '8px' } }, [
                        DOM.el('div', { style: { fontSize: '0.7rem', color: 'var(--text-muted)' } }, ['INTERVAL']),
                        DOM.el('div', { style: { fontSize: '1.2rem', fontFamily: 'Orbitron', color: 'var(--neon-cyan)' } }, [(status.config.batchInterval / 1000) + 's'])
                    ]),
                    DOM.el('div', { style: { padding: '1rem', background: 'rgba(0,255,247,0.05)', borderRadius: '8px' } }, [
                        DOM.el('div', { style: { fontSize: '0.7rem', color: 'var(--text-muted)' } }, ['HUBSPOT UPLOAD']),
                        DOM.el('div', { style: { fontSize: '1.2rem', fontFamily: 'Orbitron', color: status.config.uploadToHubSpot ? 'var(--neon-green)' : 'var(--neon-magenta)' } }, [status.config.uploadToHubSpot ? 'ON' : 'OFF'])
                    ]),
                    DOM.el('div', { style: { padding: '1rem', background: 'rgba(0,255,247,0.05)', borderRadius: '8px' } }, [
                        DOM.el('div', { style: { fontSize: '0.7rem', color: 'var(--text-muted)' } }, ['STARTED']),
                        DOM.el('div', { style: { fontSize: '0.9rem', color: 'var(--text-bright)' } }, [status.startedAt ? new Date(status.startedAt).toLocaleTimeString('de-DE') : '-'])
                    ]),
                    DOM.el('div', { style: { padding: '1rem', background: 'rgba(0,255,247,0.05)', borderRadius: '8px' } }, [
                        DOM.el('div', { style: { fontSize: '0.7rem', color: 'var(--text-muted)' } }, ['LAST BATCH']),
                        DOM.el('div', { style: { fontSize: '0.9rem', color: 'var(--text-bright)' } }, [status.lastBatchAt ? new Date(status.lastBatchAt).toLocaleTimeString('de-DE') : '-'])
                    ]),
                    DOM.el('div', { style: { padding: '1rem', background: 'rgba(0,255,247,0.05)', borderRadius: '8px' } }, [
                        DOM.el('div', { style: { fontSize: '0.7rem', color: 'var(--text-muted)' } }, ['MODULE']),
                        DOM.el('div', { style: { fontSize: '0.9rem', color: status.moduleLoaded ? 'var(--neon-green)' : 'var(--neon-magenta)' } }, [status.moduleLoaded ? '‚úì LOADED' : '‚úó NOT LOADED'])
                    ])
                ]));
            }
        }

        // Update regions
        const regionsDiv = document.getElementById('leadgen-regions');
        if (regionsDiv && status.stats.byRegion) {
            DOM.clear(regionsDiv);
            const total = Object.values(status.stats.byRegion).reduce((a, b) => a + b, 0) || 1;
            const colors = { DACH: 'cyan', Europe: 'magenta', NorthAmerica: 'green', APAC: 'yellow', Other: 'pink' };
            Object.entries(status.stats.byRegion).forEach(([region, count]) => {
                const pct = Math.round((count / total) * 100);
                regionsDiv.appendChild(DOM.el('div', { style: { marginBottom: '0.75rem' } }, [
                    DOM.el('div', { style: { display: 'flex', justifyContent: 'space-between', marginBottom: '0.3rem' } }, [
                        DOM.el('span', { style: { fontSize: '0.8rem' } }, [region]),
                        DOM.el('span', { style: { fontSize: '0.8rem', color: 'var(--text-muted)' } }, [formatNumber(count) + ' (' + pct + '%)'])
                    ]),
                    DOM.el('div', { style: { height: '6px', background: 'rgba(255,255,255,0.1)', borderRadius: '3px', overflow: 'hidden' } }, [
                        DOM.el('div', { style: { width: pct + '%', height: '100%', background: 'var(--neon-' + (colors[region] || 'cyan') + ')', transition: 'width 0.3s' } })
                    ])
                ]));
            });
        }

        // Update industries
        const indDiv = document.getElementById('leadgen-industries');
        if (indDiv && status.stats.byIndustry) {
            DOM.clear(indDiv);
            const sorted = Object.entries(status.stats.byIndustry).sort((a, b) => b[1] - a[1]).slice(0, 8);
            if (sorted.length === 0) {
                indDiv.appendChild(DOM.el('div', { style: { color: 'var(--text-muted)', textAlign: 'center', padding: '2rem' } }, ['No data yet']));
            } else {
                const maxCount = sorted[0][1];
                sorted.forEach(([industry, count]) => {
                    const pct = Math.round((count / maxCount) * 100);
                    indDiv.appendChild(DOM.el('div', { style: { marginBottom: '0.5rem' } }, [
                        DOM.el('div', { style: { display: 'flex', justifyContent: 'space-between', marginBottom: '0.2rem' } }, [
                            DOM.el('span', { style: { fontSize: '0.75rem' } }, [industry]),
                            DOM.el('span', { style: { fontSize: '0.75rem', color: 'var(--text-muted)' } }, [formatNumber(count)])
                        ]),
                        DOM.el('div', { style: { height: '4px', background: 'rgba(255,255,255,0.1)', borderRadius: '2px' } }, [
                            DOM.el('div', { style: { width: pct + '%', height: '100%', background: 'var(--neon-cyan)' } })
                        ])
                    ]));
                });
            }
        }
    },

    async refreshLeadPreview() {
        const preview = document.getElementById('leadgen-preview');
        if (!preview) return;

        preview.innerHTML = '<div class="loading-skeleton" style="height: 200px"></div>';

        const data = await API.post('/api/v1/lead-generator/preview', { count: 5 });
        DOM.clear(preview);

        if (data?.leads?.length) {
            const table = DOM.el('table', { className: 'cyber-table', style: { fontSize: '0.8rem' } }, [
                DOM.el('thead', {}, [DOM.el('tr', {}, [
                    DOM.el('th', {}, ['NAME']),
                    DOM.el('th', {}, ['COMPANY']),
                    DOM.el('th', {}, ['EMAIL']),
                    DOM.el('th', {}, ['REGION']),
                    DOM.el('th', {}, ['SCORE'])
                ])]),
                DOM.el('tbody', {})
            ]);

            data.leads.forEach(lead => {
                const row = DOM.el('tr', {}, [
                    DOM.el('td', { className: 'highlight' }, [`${lead.firstname} ${lead.lastname}`]),
                    DOM.el('td', {}, [escapeHtml(lead.company || '-')]),
                    DOM.el('td', { style: { fontSize: '0.7rem' } }, [escapeHtml(lead.email || '-')]),
                    DOM.el('td', {}, [DOM.el('span', { className: 'cyber-badge' }, [lead._meta?.region || '-'])]),
                    DOM.el('td', {}, [DOM.el('span', { className: 'cyber-badge ' + (lead._meta?.score >= 70 ? 'green' : lead._meta?.score >= 50 ? 'yellow' : '') }, [String(lead._meta?.score || 0)])])
                ]);
                table.querySelector('tbody').appendChild(row);
            });

            preview.appendChild(table);
        } else {
            preview.appendChild(DOM.el('div', { style: { color: 'var(--text-muted)', textAlign: 'center', padding: '2rem' } }, ['Click REFRESH to generate preview']));
        }
    },

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // BOT SWARM / DAEMONS MODULE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async renderBots() {
        const c = this.container(); DOM.clear(c);
        c.appendChild(DOM.el('div', { className: 'page-header' }, [
            DOM.el('h1', { className: 'page-title' }, [document.createTextNode('DAEMON '), DOM.el('span', {}, ['SWARM'])]),
            DOM.el('div', {}, [
                DOM.el('button', { className: 'btn-nexus green', style: { marginRight: '0.5rem' }, onclick: () => NexusApp.startAllDaemons() }, '‚ñ∂ START ALL'),
                DOM.el('button', { className: 'btn-nexus magenta', onclick: () => NexusApp.stopAllDaemons() }, '‚óº STOP ALL')
            ])
        ]));
        c.appendChild(DOM.el('div', { className: 'grid-3', id: 'daemon-grid' }, [
            DOM.el('div', { className: 'loading-skeleton', style: { height: '200px' } }),
            DOM.el('div', { className: 'loading-skeleton', style: { height: '200px' } }),
            DOM.el('div', { className: 'loading-skeleton', style: { height: '200px' } })
        ]));
        this.loadDaemonStatus();
    },
    async loadDaemonStatus() {
        const grid = document.getElementById('daemon-grid'); if (!grid) return;
        const [leadDemon, dupeDemon, bots, orchestrator] = await Promise.all([
            API.get('/api/lead-demon/status'),
            API.get('/api/v1/duplicate-demon/status'),
            API.get('/api/bots'),
            API.get('/api/bot-orchestrator/status')
        ]);
        DOM.clear(grid);
        const daemons = [
            { name: 'LEAD DEMON', icon: 'üëπ', status: leadDemon?.running, stats: `${formatNumber(leadDemon?.processed || 0)} processed`, color: 'magenta' },
            { name: 'DUPLICATE DEMON', icon: 'üëª', status: dupeDemon?.running || dupeDemon?.status === 'active', stats: `${formatNumber(dupeDemon?.duplicatesFound || dupeDemon?.stats?.total || 0)} found`, color: 'cyan' },
            { name: 'BOT ORCHESTRATOR', icon: 'ü§ñ', status: orchestrator?.running, stats: `${orchestrator?.activeBots || 0} bots active`, color: 'green' },
            { name: 'EMAIL TRACKER', icon: 'üìß', status: true, stats: 'Always active', color: 'yellow' },
            { name: 'WEBHOOK HANDLER', icon: 'üîó', status: true, stats: 'Listening', color: 'pink' },
            { name: 'SYNC ENGINE', icon: 'üîÑ', status: true, stats: 'Real-time sync', color: 'cyan' }
        ];
        daemons.forEach(d => grid.appendChild(DOM.el('div', { className: 'cyber-card' }, [
            DOM.el('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' } }, [
                DOM.el('div', { style: { fontSize: '2rem' } }, [d.icon]),
                DOM.el('span', { className: 'cyber-badge ' + (d.status ? 'green' : ''), style: { fontSize: '0.7rem' } }, [d.status ? '‚óè ONLINE' : '‚óã OFFLINE'])
            ]),
            DOM.el('div', { style: { fontFamily: 'Orbitron', fontSize: '1rem', color: 'var(--neon-' + d.color + ')', marginBottom: '0.5rem' } }, [d.name]),
            DOM.el('div', { style: { fontSize: '0.8rem', color: 'var(--text-muted)', marginBottom: '1rem' } }, [d.stats]),
            DOM.el('div', { style: { display: 'flex', gap: '0.5rem' } }, [
                DOM.el('button', { className: 'btn-nexus green', style: { flex: 1, padding: '0.4rem', fontSize: '0.7rem' } }, d.status ? 'RESTART' : 'START'),
                DOM.el('button', { className: 'btn-nexus', style: { flex: 1, padding: '0.4rem', fontSize: '0.7rem' } }, 'LOGS')
            ])
        ])));
    },

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // HAIKU GOD MODE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    renderHaiku() {
        const c = this.container(); DOM.clear(c);
        c.appendChild(DOM.el('div', { className: 'page-header' }, [
            DOM.el('h1', { className: 'page-title' }, [document.createTextNode('HAIKU '), DOM.el('span', {}, ['GOD MODE'])])
        ]));
        c.appendChild(DOM.el('div', { className: 'cyber-card', style: { background: 'linear-gradient(135deg, rgba(255,0,128,0.1), rgba(0,255,247,0.1))' } }, [
            DOM.el('div', { style: { textAlign: 'center', padding: '3rem' } }, [
                DOM.el('div', { style: { fontSize: '4rem', marginBottom: '1rem' } }, ['üß†']),
                DOM.el('div', { style: { fontFamily: 'Orbitron', fontSize: '2rem', color: 'var(--neon-magenta)', marginBottom: '1rem' } }, ['SUPREME AI INTERFACE']),
                DOM.el('div', { style: { color: 'var(--text-muted)', marginBottom: '2rem', maxWidth: '500px', margin: '0 auto 2rem' } }, ['Execute complex multi-step operations with a single command. Haiku analyzes, plans, and executes autonomously.']),
                DOM.el('textarea', { id: 'haiku-input', placeholder: 'Enter your command... e.g., "Analyze all open deals and send follow-up emails to contacts who haven\'t responded in 7 days"', style: { width: '100%', maxWidth: '600px', height: '120px', background: 'rgba(0,0,0,0.5)', border: '1px solid var(--neon-cyan)', borderRadius: '8px', padding: '1rem', color: 'var(--text-primary)', fontFamily: 'inherit', resize: 'none' } }),
                DOM.el('div', { style: { marginTop: '1rem' } }, [
                    DOM.el('button', { className: 'btn-nexus magenta', style: { padding: '1rem 3rem', fontSize: '1rem' }, onclick: () => NexusApp.executeHaiku() }, '‚ö° EXECUTE GOD MODE')
                ])
            ])
        ]));
    },

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // EMAIL HUB MODULE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async renderEmailHub() {
        const c = this.container(); DOM.clear(c);
        c.appendChild(DOM.el('div', { className: 'page-header' }, [
            DOM.el('h1', { className: 'page-title' }, [document.createTextNode('EMAIL '), DOM.el('span', {}, ['HUB'])]),
            DOM.el('button', { className: 'btn-nexus', onclick: () => NexusApp.composeEmail() }, '‚úâ COMPOSE')
        ]));
        c.appendChild(DOM.el('div', { className: 'kpi-grid', id: 'email-stats' }, [
            DOM.el('div', { className: 'loading-skeleton', style: { height: '100px' } }),
            DOM.el('div', { className: 'loading-skeleton', style: { height: '100px' } }),
            DOM.el('div', { className: 'loading-skeleton', style: { height: '100px' } }),
            DOM.el('div', { className: 'loading-skeleton', style: { height: '100px' } })
        ]));
        c.appendChild(DOM.el('div', { className: 'grid-2', style: { marginTop: '1rem' } }, [
            DOM.el('div', { className: 'cyber-card' }, [
                DOM.el('div', { className: 'card-header' }, [DOM.el('span', { className: 'card-title' }, 'RECENT EMAILS')]),
                DOM.el('div', { className: 'card-body', id: 'recent-emails' }, [DOM.el('div', { className: 'loading-skeleton', style: { height: '200px' } })])
            ]),
            DOM.el('div', { className: 'cyber-card' }, [
                DOM.el('div', { className: 'card-header' }, [DOM.el('span', { className: 'card-title' }, 'EMAIL SEQUENCES')]),
                DOM.el('div', { className: 'card-body', id: 'email-sequences' }, [DOM.el('div', { className: 'loading-skeleton', style: { height: '200px' } })])
            ])
        ]));
        this.loadEmailData();
    },
    async loadEmailData() {
        const [stats, recent, sequences] = await Promise.all([
            API.get('/api/v1/email/stats'),
            API.get('/api/v1/email/recent?limit=5'),
            API.get('/api/v1/email/sequences')
        ]);
        const sc = document.getElementById('email-stats');
        if (sc) {
            DOM.clear(sc);
            [{ label: 'EMAILS SENT', value: formatNumber(stats?.sent || stats?.totalSent || 0), class: 'cyan' },
             { label: 'OPEN RATE', value: (stats?.openRate || 0).toFixed(1) + '%', class: 'green' },
             { label: 'CLICK RATE', value: (stats?.clickRate || 0).toFixed(1) + '%', class: 'magenta' },
             { label: 'BOUNCE RATE', value: (stats?.bounceRate || 0).toFixed(1) + '%', class: 'yellow' }
            ].forEach(k => sc.appendChild(DOM.el('div', { className: 'kpi-card ' + k.class }, [DOM.el('div', { className: 'kpi-label' }, [k.label]), DOM.el('div', { className: 'kpi-value' }, [k.value])])));
        }
        const re = document.getElementById('recent-emails');
        if (re) {
            DOM.clear(re);
            const emails = recent?.emails || recent || [];
            if (emails.length) {
                emails.slice(0, 5).forEach(email => re.appendChild(DOM.el('div', { style: { padding: '0.75rem 0', borderBottom: '1px solid var(--border-dim)' } }, [
                    DOM.el('div', { style: { display: 'flex', justifyContent: 'space-between' } }, [
                        DOM.el('span', { style: { color: 'var(--neon-cyan)' } }, [escapeHtml(email.to || email.recipient || '-')]),
                        DOM.el('span', { className: 'cyber-badge ' + (email.status === 'sent' ? 'green' : email.status === 'opened' ? 'cyan' : '') }, [email.status || 'QUEUED'])
                    ]),
                    DOM.el('div', { style: { fontSize: '0.8rem', color: 'var(--text-muted)', marginTop: '0.3rem' } }, [escapeHtml(email.subject || '-')])
                ])));
            } else { re.appendChild(DOM.el('div', { style: { textAlign: 'center', color: 'var(--text-muted)', padding: '2rem' } }, ['No recent emails'])); }
        }
        const seq = document.getElementById('email-sequences');
        if (seq) {
            DOM.clear(seq);
            const seqList = sequences?.sequences || sequences || [];
            if (seqList.length) {
                seqList.slice(0, 5).forEach(s => seq.appendChild(DOM.el('div', { style: { padding: '0.75rem 0', borderBottom: '1px solid var(--border-dim)', display: 'flex', justifyContent: 'space-between', alignItems: 'center' } }, [
                    DOM.el('div', {}, [
                        DOM.el('div', { style: { color: 'var(--neon-magenta)' } }, [escapeHtml(s.name || 'Unnamed Sequence')]),
                        DOM.el('div', { style: { fontSize: '0.8rem', color: 'var(--text-muted)' } }, [(s.steps || 0) + ' steps ‚Ä¢ ' + (s.enrolled || 0) + ' enrolled'])
                    ]),
                    DOM.el('span', { className: 'cyber-badge ' + (s.active ? 'green' : '') }, [s.active ? 'ACTIVE' : 'PAUSED'])
                ])));
            } else { seq.appendChild(DOM.el('div', { style: { textAlign: 'center', color: 'var(--text-muted)', padding: '2rem' } }, ['No sequences configured'])); }
        }
    },

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // WHATSAPP MODULE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async renderWhatsApp() {
        const c = this.container(); DOM.clear(c);
        c.appendChild(DOM.el('div', { className: 'page-header' }, [
            DOM.el('h1', { className: 'page-title' }, [document.createTextNode('WHATSAPP '), DOM.el('span', {}, ['CENTER'])]),
            DOM.el('button', { className: 'btn-nexus green', onclick: () => NexusApp.sendWhatsApp() }, 'üí¨ NEW MESSAGE')
        ]));
        c.appendChild(DOM.el('div', { className: 'kpi-grid', id: 'whatsapp-stats' }, [
            DOM.el('div', { className: 'loading-skeleton', style: { height: '100px' } }),
            DOM.el('div', { className: 'loading-skeleton', style: { height: '100px' } }),
            DOM.el('div', { className: 'loading-skeleton', style: { height: '100px' } }),
            DOM.el('div', { className: 'loading-skeleton', style: { height: '100px' } })
        ]));
        c.appendChild(DOM.el('div', { className: 'grid-2', style: { marginTop: '1rem' } }, [
            DOM.el('div', { className: 'cyber-card' }, [
                DOM.el('div', { className: 'card-header' }, [DOM.el('span', { className: 'card-title' }, 'CONNECTION STATUS')]),
                DOM.el('div', { className: 'card-body', id: 'whatsapp-status' }, [DOM.el('div', { className: 'loading-skeleton', style: { height: '150px' } })])
            ]),
            DOM.el('div', { className: 'cyber-card' }, [
                DOM.el('div', { className: 'card-header' }, [DOM.el('span', { className: 'card-title' }, 'TEMPLATES')]),
                DOM.el('div', { className: 'card-body', id: 'whatsapp-templates' }, [DOM.el('div', { className: 'loading-skeleton', style: { height: '150px' } })])
            ])
        ]));
        this.loadWhatsAppData();
    },
    async loadWhatsAppData() {
        const [status, stats, templates] = await Promise.all([
            API.get('/api/whatsapp/status'),
            API.get('/api/whatsapp/stats'),
            API.get('/api/whatsapp/templates')
        ]);
        const sc = document.getElementById('whatsapp-stats');
        if (sc) {
            DOM.clear(sc);
            [{ label: 'MESSAGES SENT', value: formatNumber(stats?.sent || 0), class: 'green' },
             { label: 'DELIVERED', value: formatNumber(stats?.delivered || 0), class: 'cyan' },
             { label: 'READ', value: formatNumber(stats?.read || 0), class: 'magenta' },
             { label: 'FAILED', value: formatNumber(stats?.failed || 0), class: 'yellow' }
            ].forEach(k => sc.appendChild(DOM.el('div', { className: 'kpi-card ' + k.class }, [DOM.el('div', { className: 'kpi-label' }, [k.label]), DOM.el('div', { className: 'kpi-value' }, [k.value])])));
        }
        const ws = document.getElementById('whatsapp-status');
        if (ws) {
            DOM.clear(ws);
            const isConnected = status?.connected || status?.status === 'connected';
            ws.appendChild(DOM.el('div', { style: { textAlign: 'center', padding: '1.5rem' } }, [
                DOM.el('div', { style: { fontSize: '3rem', marginBottom: '1rem' } }, [isConnected ? 'üì±' : 'üìµ']),
                DOM.el('div', { style: { fontFamily: 'Orbitron', fontSize: '1.2rem', color: isConnected ? 'var(--neon-green)' : 'var(--text-muted)', marginBottom: '0.5rem' } }, [isConnected ? 'CONNECTED' : 'DISCONNECTED']),
                DOM.el('div', { style: { fontSize: '0.8rem', color: 'var(--text-muted)' } }, [status?.phone || status?.phoneNumber || 'No phone linked']),
                !isConnected ? DOM.el('button', { className: 'btn-nexus', style: { marginTop: '1rem' }, onclick: () => NexusApp.connectWhatsApp() }, 'CONNECT') : null
            ].filter(Boolean)));
        }
        const wt = document.getElementById('whatsapp-templates');
        if (wt) {
            DOM.clear(wt);
            const tpls = templates?.templates || templates || [];
            if (tpls.length) {
                tpls.slice(0, 4).forEach(t => wt.appendChild(DOM.el('div', { style: { padding: '0.75rem 0', borderBottom: '1px solid var(--border-dim)', display: 'flex', justifyContent: 'space-between', alignItems: 'center' } }, [
                    DOM.el('span', { style: { color: 'var(--neon-cyan)' } }, [escapeHtml(t.name || 'Template')]),
                    DOM.el('span', { className: 'cyber-badge ' + (t.status === 'approved' ? 'green' : '') }, [t.status || 'PENDING'])
                ])));
            } else { wt.appendChild(DOM.el('div', { style: { textAlign: 'center', color: 'var(--text-muted)', padding: '2rem' } }, ['No templates configured'])); }
        }
    },

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CAMPAIGNS / WORKFLOWS MODULE - Full Visual Workflow Builder
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    campaignState: { activeTab: 'workflows', workflows: [], triggers: {}, actions: {}, executions: [], campaigns: [] },

    async renderCampaigns() {
        const c = this.container(); DOM.clear(c);
        // Page Header
        c.appendChild(DOM.el('div', { className: 'page-header' }, [
            DOM.el('h1', { className: 'page-title' }, [document.createTextNode('WORKFLOW '), DOM.el('span', {}, ['ENGINE'])]),
            DOM.el('div', { className: 'flex gap-2' }, [
                DOM.el('button', { className: 'btn-nexus', onclick: () => Modules.loadCampaignData() }, '‚Üª REFRESH'),
                DOM.el('button', { className: 'btn-nexus magenta', onclick: () => NexusApp.createWorkflowModal() }, '+ NEW WORKFLOW')
            ])
        ]));
        // KPI Stats
        c.appendChild(DOM.el('div', { className: 'kpi-grid', id: 'workflow-stats' }, [
            DOM.el('div', { className: 'loading-skeleton', style: { height: '100px' } }),
            DOM.el('div', { className: 'loading-skeleton', style: { height: '100px' } }),
            DOM.el('div', { className: 'loading-skeleton', style: { height: '100px' } }),
            DOM.el('div', { className: 'loading-skeleton', style: { height: '100px' } })
        ]));
        // Tab Navigation
        c.appendChild(DOM.el('div', { className: 'cyber-card', style: { marginTop: '1rem' } }, [
            DOM.el('div', { style: { display: 'flex', borderBottom: '1px solid var(--border-dim)' } }, [
                DOM.el('button', { className: 'tab-btn active', id: 'tab-workflows', onclick: () => Modules.switchCampaignTab('workflows') }, '‚öô WORKFLOWS'),
                DOM.el('button', { className: 'tab-btn', id: 'tab-campaigns', onclick: () => Modules.switchCampaignTab('campaigns') }, 'üìß CAMPAIGN TEMPLATES'),
                DOM.el('button', { className: 'tab-btn', id: 'tab-history', onclick: () => Modules.switchCampaignTab('history') }, 'üìä EXECUTION HISTORY')
            ]),
            DOM.el('div', { id: 'campaign-content', style: { padding: '1rem' } }, [DOM.el('div', { className: 'loading-skeleton', style: { height: '300px' } })])
        ]));
        // Load data
        await this.loadCampaignData();
    },

    switchCampaignTab(tab) {
        this.campaignState.activeTab = tab;
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById('tab-' + tab)?.classList.add('active');
        this.renderCampaignContent();
    },

    async loadCampaignData() {
        const [stats, workflows, triggers, actions, executions] = await Promise.all([
            API.get('/api/v1/workflows/stats/overview'),
            API.get('/api/v1/workflows'),
            API.get('/api/v1/workflows/triggers'),
            API.get('/api/v1/workflows/actions'),
            API.get('/api/v1/workflows/0/executions?limit=50').catch(() => ({ executions: [] }))
        ]);
        const wfs = workflows?.workflows || workflows || [];
        this.campaignState.workflows = wfs;
        this.campaignState.triggers = triggers?.triggers || {};
        this.campaignState.actions = actions?.actions || {};
        this.campaignState.executions = executions?.executions || [];
        // Update KPIs
        const sc = document.getElementById('workflow-stats');
        if (sc) {
            DOM.clear(sc);
            const wfStats = stats?.workflows || stats || {};
            const exStats = stats?.executions || {};
            const successRate = exStats.total > 0 ? ((exStats.completed || 0) / exStats.total * 100) : 100;
            [{ label: 'TOTAL WORKFLOWS', value: formatNumber(wfStats.total || wfs.length || 0), class: '' },
             { label: 'ACTIVE', value: formatNumber(wfStats.active || wfs.filter(w => w.isActive).length || 0), class: 'green' },
             { label: 'TOTAL RUNS', value: formatNumber(wfStats.totalRuns || exStats.total || 0), class: 'cyan' },
             { label: 'SUCCESS RATE', value: successRate.toFixed(1) + '%', class: 'magenta' }
            ].forEach(k => sc.appendChild(DOM.el('div', { className: 'kpi-card ' + k.class }, [DOM.el('div', { className: 'kpi-label' }, [k.label]), DOM.el('div', { className: 'kpi-value' }, [k.value])])));
        }
        this.renderCampaignContent();
    },

    renderCampaignContent() {
        const cc = document.getElementById('campaign-content');
        if (!cc) return;
        DOM.clear(cc);
        switch (this.campaignState.activeTab) {
            case 'workflows': this.renderWorkflowsList(cc); break;
            case 'campaigns': this.renderCampaignTemplates(cc); break;
            case 'history': this.renderExecutionHistory(cc); break;
        }
    },

    renderWorkflowsList(container) {
        const wfs = this.campaignState.workflows;
        if (!wfs.length) {
            container.appendChild(DOM.el('div', { style: { textAlign: 'center', padding: '3rem', color: 'var(--text-muted)' } }, [
                DOM.el('div', { style: { fontSize: '3rem', marginBottom: '1rem' } }, ['‚öô']),
                DOM.el('div', { style: { marginBottom: '1rem' } }, ['No workflows configured yet']),
                DOM.el('button', { className: 'btn-nexus magenta', onclick: () => NexusApp.createWorkflowModal() }, 'CREATE FIRST WORKFLOW')
            ]));
            return;
        }
        const triggerIcons = { manual: 'üëÜ', schedule: '‚è∞', deal_created: 'üíº', deal_stage_changed: 'üìä', deal_won: 'üèÜ', contact_created: 'üë§', form_submitted: 'üìù', webhook: 'üîó', email_opened: 'üìß', lead_score_changed: 'üìà' };
        wfs.forEach(wf => {
            const trigger = this.campaignState.triggers[wf.triggerType] || {};
            const icon = triggerIcons[wf.triggerType] || '‚ö°';
            const row = DOM.el('div', { style: { padding: '1rem', borderBottom: '1px solid var(--border-dim)', display: 'grid', gridTemplateColumns: '1fr auto', gap: '1rem', alignItems: 'center' } }, [
                DOM.el('div', {}, [
                    DOM.el('div', { style: { display: 'flex', alignItems: 'center', gap: '0.5rem' } }, [
                        DOM.el('span', { style: { fontSize: '1.2rem' } }, [icon]),
                        DOM.el('span', { style: { color: 'var(--neon-cyan)', fontFamily: 'Orbitron', fontSize: '0.95rem' } }, [escapeHtml(wf.name || 'Unnamed')])
                    ]),
                    DOM.el('div', { style: { fontSize: '0.75rem', color: 'var(--text-muted)', marginTop: '0.4rem', marginLeft: '1.8rem' } }, [
                        escapeHtml(wf.description || 'No description') + ' ‚Ä¢ Trigger: ' + (trigger.name || wf.triggerType) + ' ‚Ä¢ ' + (wf.actionCount || 0) + ' Actions ‚Ä¢ ' + (wf.runCount || 0) + ' Runs'
                    ])
                ]),
                DOM.el('div', { style: { display: 'flex', gap: '0.5rem', alignItems: 'center' } }, [
                    DOM.el('span', { className: 'cyber-badge ' + (wf.isActive ? 'green' : 'yellow') }, [wf.isActive ? 'ACTIVE' : 'PAUSED']),
                    DOM.el('button', { className: 'btn-nexus', style: { padding: '0.3rem 0.6rem', fontSize: '0.65rem' }, onclick: () => NexusApp.executeWorkflow(wf.id, wf.name) }, '‚ñ∂ RUN'),
                    DOM.el('button', { className: 'btn-nexus', style: { padding: '0.3rem 0.6rem', fontSize: '0.65rem' }, onclick: () => NexusApp.editWorkflowModal(wf.id) }, '‚úé EDIT'),
                    DOM.el('button', { className: 'btn-nexus', style: { padding: '0.3rem 0.6rem', fontSize: '0.65rem' }, onclick: () => NexusApp.toggleWorkflow(wf.id, !wf.isActive) }, [wf.isActive ? '‚è∏' : '‚ñ∂']),
                    DOM.el('button', { className: 'btn-nexus magenta', style: { padding: '0.3rem 0.6rem', fontSize: '0.65rem' }, onclick: () => NexusApp.deleteWorkflow(wf.id, wf.name) }, '‚úï')
                ])
            ]);
            container.appendChild(row);
        });
    },

    renderCampaignTemplates(container) {
        const campaigns = [
            { id: 'partner_akquise', name: 'Partner Akquise', icon: 'ü§ù', desc: 'ComfortClick, KNX Partner Anfragen', emails: 2, priority: 'HOCH' },
            { id: 'loxone_projekt', name: 'LOXONE Projekt', icon: 'üè†', desc: 'Flagship Store Smart Home Integration', emails: 2, priority: 'HOCH' },
            { id: 'flagship_store', name: 'Flagship Store', icon: 'üè¢', desc: 'Immobilien & Gewerbefl√§chen K√∂ln', emails: 3, priority: 'HOCH' },
            { id: 'partner_erweiterung', name: 'Partner Erweiterung', icon: 'üîê', desc: 'Verisure, HubSpot Kooperationen', emails: 2, priority: 'MITTEL' },
            { id: 'it_dienstleister', name: 'IT Dienstleister', icon: 'üíª', desc: 'West Money OS Entwicklung', emails: 1, priority: 'MITTEL' },
            { id: 'tech_partnerships', name: 'Tech Partnerships', icon: 'üöÄ', desc: 'App Dev, VR/AR, IoT Partner', emails: 3, priority: 'NIEDRIG' }
        ];
        container.appendChild(DOM.el('div', { style: { marginBottom: '1rem', display: 'flex', justifyContent: 'space-between', alignItems: 'center' } }, [
            DOM.el('div', { style: { color: 'var(--text-secondary)' } }, ['Pre-configured email campaign templates ready to launch']),
            DOM.el('button', { className: 'btn-nexus', onclick: () => window.open('/kampagnen', '_blank') }, 'OPEN CAMPAIGN DASHBOARD')
        ]));
        const grid = DOM.el('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(280px, 1fr))', gap: '1rem' } });
        campaigns.forEach(camp => {
            const prioClass = camp.priority === 'HOCH' ? 'magenta' : camp.priority === 'MITTEL' ? 'yellow' : '';
            grid.appendChild(DOM.el('div', { className: 'cyber-card', style: { padding: '1rem' } }, [
                DOM.el('div', { style: { display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.5rem' } }, [
                    DOM.el('span', { style: { fontSize: '1.5rem' } }, [camp.icon]),
                    DOM.el('span', { style: { color: 'var(--neon-cyan)', fontFamily: 'Orbitron' } }, [camp.name])
                ]),
                DOM.el('div', { style: { fontSize: '0.8rem', color: 'var(--text-muted)', marginBottom: '0.8rem' } }, [camp.desc]),
                DOM.el('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center' } }, [
                    DOM.el('div', { style: { fontSize: '0.75rem' } }, [camp.emails + ' Email Templates']),
                    DOM.el('span', { className: 'cyber-badge ' + prioClass }, [camp.priority])
                ]),
                DOM.el('button', { className: 'btn-nexus', style: { width: '100%', marginTop: '0.8rem' }, onclick: () => NexusApp.launchCampaign(camp.id) }, 'üöÄ LAUNCH CAMPAIGN')
            ]));
        });
        container.appendChild(grid);
    },

    renderExecutionHistory(container) {
        const execs = this.campaignState.executions;
        if (!execs.length) {
            container.appendChild(DOM.el('div', { style: { textAlign: 'center', padding: '3rem', color: 'var(--text-muted)' } }, [
                DOM.el('div', { style: { fontSize: '3rem', marginBottom: '1rem' } }, ['üìä']),
                DOM.el('div', {}, ['No execution history yet. Run a workflow to see results here.'])
            ]));
            return;
        }
        const table = DOM.el('table', { className: 'cyber-table' }, [
            DOM.el('thead', {}, [DOM.el('tr', {}, [
                DOM.el('th', {}, ['WORKFLOW']), DOM.el('th', {}, ['STATUS']), DOM.el('th', {}, ['STARTED']), DOM.el('th', {}, ['DURATION']), DOM.el('th', {}, ['ACTIONS'])
            ])]),
            DOM.el('tbody', {})
        ]);
        const tbody = table.querySelector('tbody');
        execs.slice(0, 20).forEach(exec => {
            const statusClass = exec.status === 'completed' ? 'green' : exec.status === 'failed' ? 'magenta' : 'yellow';
            const duration = exec.completedAt ? Math.round((new Date(exec.completedAt) - new Date(exec.startedAt)) / 1000) + 's' : 'Running...';
            tbody.appendChild(DOM.el('tr', {}, [
                DOM.el('td', { style: { color: 'var(--neon-cyan)' } }, [escapeHtml(exec.workflowName || 'Unknown')]),
                DOM.el('td', {}, [DOM.el('span', { className: 'cyber-badge ' + statusClass }, [exec.status?.toUpperCase() || 'UNKNOWN'])]),
                DOM.el('td', {}, [new Date(exec.startedAt).toLocaleString('de-DE')]),
                DOM.el('td', {}, [duration]),
                DOM.el('td', {}, [DOM.el('button', { className: 'btn-nexus', style: { padding: '0.2rem 0.5rem', fontSize: '0.65rem' }, onclick: () => NexusApp.showExecutionDetail(exec) }, 'DETAILS')])
            ]));
        });
        container.appendChild(table);
    },

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FINANCE MODULES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Cashflow State
    cashflowState: {
        period: '30d', // 7d, 30d, 90d, year
        transactions: [],
        incomeTotal: 0,
        expenseTotal: 0,
        balance: 0
    },

    async renderCashflow() {
        const c = this.container(); DOM.clear(c);

        c.appendChild(DOM.el('div', { className: 'page-header' }, [
            DOM.el('h1', { className: 'page-title' }, [document.createTextNode('CASHFLOW '), DOM.el('span', {}, ['TRACKER'])]),
            DOM.el('div', { className: 'flex gap-2' }, [
                DOM.el('select', { className: 'cyber-input', id: 'cashflow-period', onchange: (e) => this.loadCashflowData(e.target.value), style: { padding: '0.5rem 1rem' } }, [
                    DOM.el('option', { value: '7d' }, ['LETZTE 7 TAGE']),
                    DOM.el('option', { value: '30d', selected: true }, ['LETZTE 30 TAGE']),
                    DOM.el('option', { value: '90d' }, ['LETZTE 90 TAGE']),
                    DOM.el('option', { value: 'year' }, ['DIESES JAHR'])
                ]),
                DOM.el('button', { className: 'btn-nexus', onclick: () => NexusApp.addTransactionModal('income') }, '+ EINNAHME'),
                DOM.el('button', { className: 'btn-nexus magenta', onclick: () => NexusApp.addTransactionModal('expense') }, '+ AUSGABE')
            ])
        ]));

        // KPI Cards
        c.appendChild(DOM.el('div', { className: 'kpi-grid', id: 'cashflow-kpis' }, [
            DOM.el('div', { className: 'loading-skeleton', style: { height: '120px' } }),
            DOM.el('div', { className: 'loading-skeleton', style: { height: '120px' } }),
            DOM.el('div', { className: 'loading-skeleton', style: { height: '120px' } }),
            DOM.el('div', { className: 'loading-skeleton', style: { height: '120px' } })
        ]));

        // Main Grid: Chart + Transactions
        const mainGrid = DOM.el('div', { className: 'grid-2', style: { gap: '1.5rem', marginTop: '1.5rem' } });

        // Left: Chart Area
        const chartCard = DOM.el('div', { className: 'cyber-card' }, [
            DOM.el('div', { className: 'card-header' }, [DOM.el('span', { className: 'card-title' }, 'üìä CASHFLOW TREND')]),
            DOM.el('div', { className: 'card-body', id: 'cashflow-chart', style: { height: '300px', display: 'flex', alignItems: 'flex-end', gap: '4px', padding: '1rem' } }, [
                DOM.el('div', { className: 'loading-skeleton', style: { height: '100%', width: '100%' } })
            ])
        ]);
        mainGrid.appendChild(chartCard);

        // Right: Summary
        const summaryCard = DOM.el('div', { className: 'cyber-card' }, [
            DOM.el('div', { className: 'card-header' }, [DOM.el('span', { className: 'card-title' }, 'üìà ZUSAMMENFASSUNG')]),
            DOM.el('div', { className: 'card-body', id: 'cashflow-summary' }, [
                DOM.el('div', { className: 'loading-skeleton', style: { height: '250px' } })
            ])
        ]);
        mainGrid.appendChild(summaryCard);
        c.appendChild(mainGrid);

        // Transactions List
        c.appendChild(DOM.el('div', { className: 'cyber-card', style: { marginTop: '1.5rem' } }, [
            DOM.el('div', { className: 'card-header' }, [
                DOM.el('span', { className: 'card-title' }, 'üí∞ TRANSAKTIONEN'),
                DOM.el('div', { className: 'flex gap-2' }, [
                    DOM.el('button', { id: 'filter-all', className: 'cyber-badge cyan active', onclick: () => this.filterCashflow('all'), style: { cursor: 'pointer' } }, ['ALLE']),
                    DOM.el('button', { id: 'filter-income', className: 'cyber-badge green', onclick: () => this.filterCashflow('income'), style: { cursor: 'pointer' } }, ['EINNAHMEN']),
                    DOM.el('button', { id: 'filter-expense', className: 'cyber-badge magenta', onclick: () => this.filterCashflow('expense'), style: { cursor: 'pointer' } }, ['AUSGABEN'])
                ])
            ]),
            DOM.el('div', { id: 'cashflow-transactions', style: { maxHeight: '400px', overflowY: 'auto' } }, [
                DOM.el('div', { className: 'loading-skeleton', style: { height: '300px' } })
            ])
        ]));

        this.loadCashflowData('30d');
    },

    async loadCashflowData(period = '30d') {
        this.cashflowState.period = period;

        // Calculate date range
        const now = new Date();
        let startDate = new Date();
        switch (period) {
            case '7d': startDate.setDate(now.getDate() - 7); break;
            case '30d': startDate.setDate(now.getDate() - 30); break;
            case '90d': startDate.setDate(now.getDate() - 90); break;
            case 'year': startDate = new Date(now.getFullYear(), 0, 1); break;
        }

        try {
            // Load invoices (income from deals)
            const invoicesData = await API.get('/api/v1/invoices?limit=200&sort=date&order=desc');
            const invoices = invoicesData?.invoices || [];

            // Build transactions from invoices
            const incomeTransactions = invoices
                .filter(inv => new Date(inv.created_date) >= startDate)
                .map(inv => ({
                    id: 'inv-' + inv.id,
                    type: 'income',
                    category: inv.status === 'paid' ? 'Bezahlt' : inv.status === 'overdue' ? '√úberf√§llig' : 'Ausstehend',
                    description: inv.customer_name || inv.invoice_number,
                    amount: inv.amount || 0,
                    date: inv.created_date,
                    status: inv.status,
                    source: 'hubspot'
                }));

            // Load local expenses from localStorage
            const localExpenses = JSON.parse(localStorage.getItem('cashflow_expenses') || '[]')
                .filter(exp => new Date(exp.date) >= startDate);

            // Combine transactions
            const allTransactions = [...incomeTransactions, ...localExpenses];
            allTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));

            this.cashflowState.transactions = allTransactions;

            // Calculate totals
            const income = incomeTransactions.reduce((sum, t) => sum + (t.status === 'paid' ? t.amount : 0), 0);
            const pending = incomeTransactions.reduce((sum, t) => sum + (t.status !== 'paid' ? t.amount : 0), 0);
            const expenses = localExpenses.reduce((sum, t) => sum + Math.abs(t.amount), 0);
            const balance = income - expenses;

            this.cashflowState.incomeTotal = income;
            this.cashflowState.expenseTotal = expenses;
            this.cashflowState.balance = balance;

            // Update KPIs
            const kpis = document.getElementById('cashflow-kpis');
            if (kpis) {
                DOM.clear(kpis);
                [
                    { label: 'SALDO', value: formatCurrency(balance), class: balance >= 0 ? 'green' : 'magenta', icon: 'üíé' },
                    { label: 'EINNAHMEN', value: formatCurrency(income), class: 'green', icon: 'üìà' },
                    { label: 'AUSGABEN', value: formatCurrency(expenses), class: 'magenta', icon: 'üìâ' },
                    { label: 'AUSSTEHEND', value: formatCurrency(pending), class: 'yellow', icon: '‚è≥' }
                ].forEach(k => {
                    kpis.appendChild(DOM.el('div', { className: 'kpi-card ' + k.class }, [
                        DOM.el('div', { className: 'kpi-label' }, [k.icon + ' ' + k.label]),
                        DOM.el('div', { className: 'kpi-value' }, [k.value])
                    ]));
                });
            }

            // Update Chart
            this.renderCashflowChart(incomeTransactions, localExpenses, period);

            // Update Summary
            const summary = document.getElementById('cashflow-summary');
            if (summary) {
                DOM.clear(summary);
                const paidCount = incomeTransactions.filter(t => t.status === 'paid').length;
                const pendingCount = incomeTransactions.filter(t => t.status !== 'paid').length;

                [
                    { label: 'Bezahlte Rechnungen', value: paidCount, color: 'var(--neon-green)' },
                    { label: 'Ausstehende Rechnungen', value: pendingCount, color: 'var(--neon-yellow)' },
                    { label: 'Ausgaben-Eintr√§ge', value: localExpenses.length, color: 'var(--neon-magenta)' },
                    { label: 'Gewinnmarge', value: income > 0 ? Math.round((balance / income) * 100) + '%' : '-', color: 'var(--neon-cyan)' }
                ].forEach(item => {
                    summary.appendChild(DOM.el('div', { style: { display: 'flex', justifyContent: 'space-between', padding: '0.75rem', borderBottom: '1px solid var(--border-dim)' } }, [
                        DOM.el('span', { style: { color: 'var(--text-muted)' } }, [item.label]),
                        DOM.el('span', { style: { color: item.color, fontWeight: 'bold', fontFamily: 'Orbitron' } }, [String(item.value)])
                    ]));
                });

                // Progress bars
                const total = income + expenses;
                if (total > 0) {
                    summary.appendChild(DOM.el('div', { style: { marginTop: '1rem', padding: '0.75rem' } }, [
                        DOM.el('div', { style: { marginBottom: '0.5rem', fontSize: '0.85rem', color: 'var(--text-muted)' } }, ['EINNAHMEN VS AUSGABEN']),
                        DOM.el('div', { style: { display: 'flex', height: '12px', borderRadius: '6px', overflow: 'hidden', background: 'var(--bg-dark)' } }, [
                            DOM.el('div', { style: { width: (income / total * 100) + '%', background: 'linear-gradient(90deg, #10b981, #34d399)', transition: 'width 0.5s' } }),
                            DOM.el('div', { style: { width: (expenses / total * 100) + '%', background: 'linear-gradient(90deg, #ef4444, #f87171)', transition: 'width 0.5s' } })
                        ]),
                        DOM.el('div', { style: { display: 'flex', justifyContent: 'space-between', marginTop: '0.5rem', fontSize: '0.75rem' } }, [
                            DOM.el('span', { style: { color: 'var(--neon-green)' } }, ['Einnahmen: ' + Math.round(income / total * 100) + '%']),
                            DOM.el('span', { style: { color: 'var(--neon-magenta)' } }, ['Ausgaben: ' + Math.round(expenses / total * 100) + '%'])
                        ])
                    ]));
                }
            }

            // Update Transactions List
            this.renderCashflowTransactions(allTransactions);

        } catch (error) {
            console.error('[Cashflow] Error loading data:', error);
        }
    },

    renderCashflowChart(incomeTransactions, expenses, period) {
        const chart = document.getElementById('cashflow-chart');
        if (!chart) return;
        DOM.clear(chart);

        // Group by date buckets
        const days = period === '7d' ? 7 : period === '30d' ? 30 : period === '90d' ? 12 : 12; // weeks for 90d, months for year
        const buckets = [];
        const now = new Date();

        for (let i = days - 1; i >= 0; i--) {
            let bucketDate, label;
            if (period === '7d' || period === '30d') {
                bucketDate = new Date(now);
                bucketDate.setDate(now.getDate() - i);
                label = bucketDate.getDate() + '.' + (bucketDate.getMonth() + 1);
            } else if (period === '90d') {
                bucketDate = new Date(now);
                bucketDate.setDate(now.getDate() - (i * 7));
                label = 'KW' + Math.ceil((bucketDate.getDate() + bucketDate.getDay()) / 7);
            } else {
                bucketDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
                label = ['Jan', 'Feb', 'M√§r', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'][bucketDate.getMonth()];
            }
            buckets.push({ date: bucketDate, label, income: 0, expense: 0 });
        }

        // Fill buckets
        incomeTransactions.forEach(t => {
            const tDate = new Date(t.date);
            buckets.forEach((b, idx) => {
                if (period === '7d' || period === '30d') {
                    if (tDate.toDateString() === b.date.toDateString() && t.status === 'paid') b.income += t.amount;
                } else if (period === '90d') {
                    const weekStart = new Date(b.date); weekStart.setDate(weekStart.getDate() - 7);
                    if (tDate >= weekStart && tDate <= b.date && t.status === 'paid') b.income += t.amount;
                } else {
                    if (tDate.getMonth() === b.date.getMonth() && tDate.getFullYear() === b.date.getFullYear() && t.status === 'paid') b.income += t.amount;
                }
            });
        });
        expenses.forEach(t => {
            const tDate = new Date(t.date);
            buckets.forEach(b => {
                if (period === '7d' || period === '30d') {
                    if (tDate.toDateString() === b.date.toDateString()) b.expense += Math.abs(t.amount);
                } else if (period === '90d') {
                    const weekStart = new Date(b.date); weekStart.setDate(weekStart.getDate() - 7);
                    if (tDate >= weekStart && tDate <= b.date) b.expense += Math.abs(t.amount);
                } else {
                    if (tDate.getMonth() === b.date.getMonth() && tDate.getFullYear() === b.date.getFullYear()) b.expense += Math.abs(t.amount);
                }
            });
        });

        const maxVal = Math.max(...buckets.map(b => Math.max(b.income, b.expense)), 1000);

        buckets.forEach(b => {
            const barGroup = DOM.el('div', { style: { flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '2px', height: '100%', justifyContent: 'flex-end' } });

            // Income bar
            const incomeHeight = Math.max(4, (b.income / maxVal) * 250);
            barGroup.appendChild(DOM.el('div', {
                style: { width: '45%', height: incomeHeight + 'px', background: 'linear-gradient(180deg, #10b981, #059669)', borderRadius: '3px 3px 0 0', transition: 'height 0.5s' },
                title: 'Einnahmen: ' + formatCurrency(b.income)
            }));

            // Expense bar
            const expenseHeight = Math.max(4, (b.expense / maxVal) * 250);
            barGroup.appendChild(DOM.el('div', {
                style: { width: '45%', height: expenseHeight + 'px', background: 'linear-gradient(180deg, #ef4444, #dc2626)', borderRadius: '3px 3px 0 0', transition: 'height 0.5s' },
                title: 'Ausgaben: ' + formatCurrency(b.expense)
            }));

            // Label
            barGroup.appendChild(DOM.el('div', { style: { fontSize: '0.65rem', color: 'var(--text-muted)', marginTop: '4px', textAlign: 'center' } }, [b.label]));

            chart.appendChild(barGroup);
        });
    },

    renderCashflowTransactions(transactions, filter = 'all') {
        const container = document.getElementById('cashflow-transactions');
        if (!container) return;
        DOM.clear(container);

        let filtered = transactions;
        if (filter === 'income') filtered = transactions.filter(t => t.type === 'income');
        else if (filter === 'expense') filtered = transactions.filter(t => t.type === 'expense');

        if (!filtered.length) {
            container.appendChild(DOM.el('div', { style: { textAlign: 'center', color: 'var(--text-muted)', padding: '2rem' } }, ['Keine Transaktionen gefunden']));
            return;
        }

        filtered.forEach(t => {
            const isIncome = t.type === 'income';
            const icon = isIncome ? (t.status === 'paid' ? '‚úÖ' : t.status === 'overdue' ? '‚ö†Ô∏è' : '‚è≥') : 'üí∏';
            const date = new Date(t.date);

            container.appendChild(DOM.el('div', {
                style: {
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    padding: '0.75rem 1rem',
                    borderBottom: '1px solid var(--border-dim)',
                    borderLeft: '3px solid ' + (isIncome ? (t.status === 'paid' ? 'var(--neon-green)' : 'var(--neon-yellow)') : 'var(--neon-magenta)'),
                    transition: 'background 0.2s'
                },
                onmouseenter: (e) => e.currentTarget.style.background = 'rgba(255,255,255,0.02)',
                onmouseleave: (e) => e.currentTarget.style.background = 'transparent'
            }, [
                DOM.el('div', { style: { display: 'flex', alignItems: 'center', gap: '1rem' } }, [
                    DOM.el('span', { style: { fontSize: '1.5rem' } }, [icon]),
                    DOM.el('div', {}, [
                        DOM.el('div', { style: { fontWeight: 'bold', color: 'var(--text-primary)' } }, [escapeHtml(t.description || t.category)]),
                        DOM.el('div', { style: { fontSize: '0.8rem', color: 'var(--text-muted)' } }, [
                            t.category + ' ‚Ä¢ ' + date.toLocaleDateString('de-DE')
                        ])
                    ])
                ]),
                DOM.el('div', { style: { textAlign: 'right' } }, [
                    DOM.el('div', {
                        style: {
                            fontFamily: 'Orbitron',
                            fontWeight: 'bold',
                            color: isIncome ? 'var(--neon-green)' : 'var(--neon-magenta)'
                        }
                    }, [(isIncome ? '+' : '-') + formatCurrency(Math.abs(t.amount))]),
                    DOM.el('div', {}, [
                        DOM.el('span', {
                            className: 'cyber-badge ' + (isIncome ? (t.status === 'paid' ? 'green' : t.status === 'overdue' ? 'magenta' : 'yellow') : 'magenta'),
                            style: { fontSize: '0.6rem' }
                        }, [isIncome ? (t.status?.toUpperCase() || 'PENDING') : 'AUSGABE'])
                    ])
                ])
            ]));
        });
    },

    filterCashflow(filter) {
        document.querySelectorAll('#filter-all, #filter-income, #filter-expense').forEach(btn => btn.classList.remove('active'));
        document.getElementById('filter-' + filter)?.classList.add('active');
        this.renderCashflowTransactions(this.cashflowState.transactions, filter);
    },

    async renderInvoices() {
        const c = this.container(); DOM.clear(c);
        c.appendChild(DOM.el('div', { className: 'page-header' }, [
            DOM.el('h1', { className: 'page-title' }, [document.createTextNode('INVOICE '), DOM.el('span', {}, ['SYSTEM'])]),
            DOM.el('div', { className: 'flex gap-2' }, [
                DOM.el('button', { className: 'btn-nexus', onclick: () => NexusApp.createInvoice() }, '+ NEW INVOICE'),
                DOM.el('button', { className: 'btn-nexus cyan', onclick: () => NexusApp.showEmailSyncStatus() }, 'üîÑ EMAIL SYNC')
            ])
        ]));
        c.appendChild(DOM.el('div', { className: 'kpi-grid', id: 'invoice-stats' }, [
            DOM.el('div', { className: 'loading-skeleton', style: { height: '100px' } }),
            DOM.el('div', { className: 'loading-skeleton', style: { height: '100px' } }),
            DOM.el('div', { className: 'loading-skeleton', style: { height: '100px' } }),
            DOM.el('div', { className: 'loading-skeleton', style: { height: '100px' } })
        ]));

        // Email Sync Daemon Status Card
        c.appendChild(DOM.el('div', { className: 'cyber-card', style: { marginTop: '1rem', padding: '1rem' }, id: 'email-sync-card' }, [
            DOM.el('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center' } }, [
                DOM.el('div', { style: { display: 'flex', alignItems: 'center', gap: '1rem' } }, [
                    DOM.el('span', { style: { fontSize: '1.5rem' } }, ['ü§ñ']),
                    DOM.el('div', {}, [
                        DOM.el('div', { style: { fontWeight: 'bold', color: 'var(--neon-cyan)' } }, ['EMAIL SYNC DAEMON']),
                        DOM.el('div', { style: { fontSize: '0.8rem', color: 'var(--text-muted)' }, id: 'sync-status-text' }, ['L√§dt...'])
                    ])
                ]),
                DOM.el('div', { className: 'flex gap-2' }, [
                    DOM.el('button', { className: 'btn-nexus', id: 'sync-toggle-btn', onclick: () => NexusApp.toggleEmailSync(), style: { padding: '0.4rem 0.8rem', fontSize: '0.75rem' } }, ['‚è∏ PAUSE']),
                    DOM.el('button', { className: 'btn-nexus cyan', onclick: () => NexusApp.runEmailSyncNow(), style: { padding: '0.4rem 0.8rem', fontSize: '0.75rem' } }, ['‚ñ∂ JETZT AUSF√úHREN']),
                    DOM.el('button', { className: 'btn-nexus magenta', onclick: () => NexusApp.queueMissingEmails(), style: { padding: '0.4rem 0.8rem', fontSize: '0.75rem' } }, ['üì• ALLE QUEUEN'])
                ])
            ]),
            DOM.el('div', { id: 'sync-queue-preview', style: { marginTop: '0.75rem', fontSize: '0.85rem', color: 'var(--text-muted)' } })
        ]));

        c.appendChild(DOM.el('div', { className: 'cyber-card', style: { marginTop: '1rem' } }, [
            DOM.el('table', { className: 'cyber-table' }, [
                DOM.el('thead', {}, [DOM.el('tr', {}, [
                    DOM.el('th', {}, ['INVOICE #']), DOM.el('th', {}, ['CLIENT']), DOM.el('th', {}, ['AMOUNT']), DOM.el('th', {}, ['GESENDET']), DOM.el('th', {}, ['STATUS']), DOM.el('th', {}, ['ACTIONS'])
                ])]),
                DOM.el('tbody', { id: 'invoices-tbody' }, [DOM.el('tr', {}, [DOM.el('td', { colspan: '6' }, [DOM.el('div', { className: 'loading-skeleton', style: { height: '200px' } })])])])
            ])
        ]));
        this.loadInvoiceData();
    },
    async loadInvoiceData() {
        const [stats, invoices, syncStatus] = await Promise.all([
            API.get('/api/v1/invoices/stats'),
            API.get('/api/v1/invoices?limit=50&sort=sent&order=desc'),
            API.get('/api/v1/email-sync/status').catch(() => null)
        ]);
        const sc = document.getElementById('invoice-stats');
        if (sc) {
            DOM.clear(sc);
            [{ label: 'TOTAL INVOICES', value: formatNumber(stats?.total || 0), class: '' },
             { label: 'PAID', value: formatCurrency(stats?.paidAmount || stats?.paid || 0), class: 'green' },
             { label: 'PENDING', value: formatCurrency(stats?.pendingAmount || stats?.pending || 0), class: 'yellow' },
             { label: 'OVERDUE', value: formatCurrency(stats?.overdueAmount || stats?.overdue || 0), class: 'magenta' }
            ].forEach(k => sc.appendChild(DOM.el('div', { className: 'kpi-card ' + k.class }, [DOM.el('div', { className: 'kpi-label' }, [k.label]), DOM.el('div', { className: 'kpi-value' }, [k.value])])));
        }

        // Update Email Sync Status
        const syncStatusText = document.getElementById('sync-status-text');
        const syncToggleBtn = document.getElementById('sync-toggle-btn');
        const syncQueuePreview = document.getElementById('sync-queue-preview');
        if (syncStatus && syncStatusText) {
            const statusIcon = syncStatus.enabled ? 'üü¢' : 'üî¥';
            syncStatusText.textContent = `${statusIcon} ${syncStatus.enabled ? 'Aktiv' : 'Pausiert'} ‚Ä¢ Queue: ${syncStatus.queue_size} ‚Ä¢ Gesynced: ${syncStatus.stats?.synced || 0} ‚Ä¢ Gesendet: ${syncStatus.stats?.sent || 0}`;
            if (syncToggleBtn) {
                syncToggleBtn.textContent = syncStatus.enabled ? '‚è∏ PAUSE' : '‚ñ∂ START';
                syncToggleBtn.className = 'btn-nexus ' + (syncStatus.enabled ? '' : 'green');
            }
            if (syncQueuePreview && syncStatus.queue?.length > 0) {
                const preview = syncStatus.queue.slice(0, 3).map(q => `${q.dealName?.substring(0, 25) || 'Deal'}... (${q.attempts}/${q.maxAttempts})`).join(' | ');
                syncQueuePreview.textContent = 'üìã In Queue: ' + preview + (syncStatus.queue.length > 3 ? ` (+${syncStatus.queue.length - 3} weitere)` : '');
            } else if (syncQueuePreview) {
                syncQueuePreview.textContent = '‚úÖ Queue ist leer';
            }
        }
        const tbody = document.getElementById('invoices-tbody');
        if (tbody) {
            DOM.clear(tbody);
            const invList = invoices?.invoices || invoices || [];
            if (invList.length) {
                invList.forEach(inv => {
                    const invId = inv.id || inv.invoice_number || inv.hubspot_deal_id;
                    const sentDate = inv.sent_date ? new Date(inv.sent_date).toLocaleDateString('de-DE') : '-';
                    tbody.appendChild(DOM.el('tr', { 'data-invoice-id': invId }, [
                        DOM.el('td', { className: 'highlight' }, [escapeHtml(inv.invoice_number || inv.number || inv.invoiceNumber || inv.id || '-')]),
                        DOM.el('td', {}, [escapeHtml(inv.customer_name || inv.client || inv.customerName || inv.customer?.name || '-')]),
                        DOM.el('td', {}, [formatCurrency(inv.amount || inv.total || 0)]),
                        DOM.el('td', { style: { color: inv.sent_date ? 'var(--neon-cyan)' : 'var(--text-muted)' } }, [sentDate]),
                        DOM.el('td', {}, [DOM.el('span', { className: 'cyber-badge ' + (inv.status === 'paid' ? 'green' : inv.status === 'overdue' ? 'magenta' : inv.status === 'sent' ? 'cyan' : 'yellow') }, [inv.status?.toUpperCase() || 'PENDING'])]),
                        DOM.el('td', { className: 'flex gap-1' }, [
                            DOM.el('button', { className: 'btn-nexus cyan', style: { padding: '0.3rem 0.6rem', fontSize: '0.65rem' }, onclick: () => NexusApp.viewInvoice(inv) }, 'üëÅ VIEW'),
                            DOM.el('button', { className: 'btn-nexus', style: { padding: '0.3rem 0.6rem', fontSize: '0.65rem' }, onclick: () => NexusApp.sendInvoice(invId) }, 'üìß SEND')
                        ])
                    ]));
                });
            } else { tbody.appendChild(DOM.el('tr', {}, [DOM.el('td', { colspan: '6', style: { textAlign: 'center', color: 'var(--text-muted)' } }, ['NO INVOICES FOUND'])])); }
        }
    },

    async renderStripe() {
        const c = this.container(); DOM.clear(c);
        c.appendChild(DOM.el('div', { className: 'page-header' }, [
            DOM.el('h1', { className: 'page-title' }, [document.createTextNode('STRIPE '), DOM.el('span', {}, ['PAYMENTS'])])
        ]));
        c.appendChild(DOM.el('div', { className: 'kpi-grid', id: 'stripe-stats' }, [
            DOM.el('div', { className: 'loading-skeleton', style: { height: '100px' } }),
            DOM.el('div', { className: 'loading-skeleton', style: { height: '100px' } }),
            DOM.el('div', { className: 'loading-skeleton', style: { height: '100px' } }),
            DOM.el('div', { className: 'loading-skeleton', style: { height: '100px' } })
        ]));
        c.appendChild(DOM.el('div', { className: 'grid-2', style: { marginTop: '1rem' } }, [
            DOM.el('div', { className: 'cyber-card' }, [
                DOM.el('div', { className: 'card-header' }, [DOM.el('span', { className: 'card-title' }, 'RECENT PAYMENTS')]),
                DOM.el('div', { className: 'card-body', id: 'stripe-payments' }, [DOM.el('div', { className: 'loading-skeleton', style: { height: '200px' } })])
            ]),
            DOM.el('div', { className: 'cyber-card' }, [
                DOM.el('div', { className: 'card-header' }, [DOM.el('span', { className: 'card-title' }, 'SUBSCRIPTIONS')]),
                DOM.el('div', { className: 'card-body', id: 'stripe-subscriptions' }, [DOM.el('div', { className: 'loading-skeleton', style: { height: '200px' } })])
            ])
        ]));
        this.loadStripeData();
    },
    async loadStripeData() {
        const [stats, payments, subscriptions] = await Promise.all([
            API.get('/api/stripe/stats'),
            API.get('/api/stripe/payments?limit=5'),
            API.get('/api/stripe/subscriptions?limit=5')
        ]);
        const sc = document.getElementById('stripe-stats');
        if (sc) {
            DOM.clear(sc);
            [{ label: 'TOTAL REVENUE', value: formatCurrency((stats?.totalRevenue || 0) / 100), class: 'green' },
             { label: 'THIS MONTH', value: formatCurrency((stats?.monthlyRevenue || 0) / 100), class: 'cyan' },
             { label: 'ACTIVE SUBS', value: formatNumber(stats?.activeSubscriptions || 0), class: 'magenta' },
             { label: 'CUSTOMERS', value: formatNumber(stats?.totalCustomers || 0), class: '' }
            ].forEach(k => sc.appendChild(DOM.el('div', { className: 'kpi-card ' + k.class }, [DOM.el('div', { className: 'kpi-label' }, [k.label]), DOM.el('div', { className: 'kpi-value' }, [k.value])])));
        }
        const sp = document.getElementById('stripe-payments');
        if (sp) {
            DOM.clear(sp);
            const payList = payments?.payments || payments?.data || payments || [];
            if (payList.length) {
                payList.slice(0, 5).forEach(p => sp.appendChild(DOM.el('div', { style: { padding: '0.75rem 0', borderBottom: '1px solid var(--border-dim)', display: 'flex', justifyContent: 'space-between' } }, [
                    DOM.el('div', {}, [
                        DOM.el('div', { style: { color: 'var(--neon-cyan)' } }, [formatCurrency((p.amount || 0) / 100)]),
                        DOM.el('div', { style: { fontSize: '0.8rem', color: 'var(--text-muted)' } }, [escapeHtml(p.customer?.email || p.receipt_email || '-')])
                    ]),
                    DOM.el('span', { className: 'cyber-badge ' + (p.status === 'succeeded' ? 'green' : '') }, [p.status?.toUpperCase() || 'PENDING'])
                ])));
            } else { sp.appendChild(DOM.el('div', { style: { textAlign: 'center', color: 'var(--text-muted)', padding: '2rem' } }, ['No recent payments'])); }
        }
        const ss = document.getElementById('stripe-subscriptions');
        if (ss) {
            DOM.clear(ss);
            const subList = subscriptions?.subscriptions || subscriptions?.data || subscriptions || [];
            if (subList.length) {
                subList.slice(0, 5).forEach(s => ss.appendChild(DOM.el('div', { style: { padding: '0.75rem 0', borderBottom: '1px solid var(--border-dim)', display: 'flex', justifyContent: 'space-between' } }, [
                    DOM.el('div', {}, [
                        DOM.el('div', { style: { color: 'var(--neon-magenta)' } }, [escapeHtml(s.customer?.email || s.plan?.nickname || 'Subscription')]),
                        DOM.el('div', { style: { fontSize: '0.8rem', color: 'var(--text-muted)' } }, [formatCurrency((s.plan?.amount || s.items?.data?.[0]?.price?.unit_amount || 0) / 100) + '/mo'])
                    ]),
                    DOM.el('span', { className: 'cyber-badge ' + (s.status === 'active' ? 'green' : '') }, [s.status?.toUpperCase() || 'UNKNOWN'])
                ])));
            } else { ss.appendChild(DOM.el('div', { style: { textAlign: 'center', color: 'var(--text-muted)', padding: '2rem' } }, ['No active subscriptions'])); }
        }
    },

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // DOCUMENTATION MODULE - Email History & Presentations
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async renderDocumentation() {
        const c = this.container(); DOM.clear(c);
        c.appendChild(DOM.el('div', { className: 'page-header' }, [
            DOM.el('h1', { className: 'page-title' }, [document.createTextNode('DOCUMENTATION '), DOM.el('span', {}, ['CENTER'])]),
            DOM.el('div', { className: 'flex gap-2' }, [
                DOM.el('button', { className: 'btn-nexus', onclick: () => this.loadDocContacts() }, 'REFRESH')
            ])
        ]));

        // Search/Filter Section
        const searchSection = DOM.el('div', { className: 'cyber-card mb-3', style: { padding: '1rem' } }, [
            DOM.el('div', { style: { display: 'flex', gap: '1rem', alignItems: 'center', flexWrap: 'wrap' } }, [
                DOM.el('input', { type: 'text', id: 'doc-search', placeholder: 'Search contacts...', className: 'cyber-input', style: { flex: 1, minWidth: '200px' }, onkeyup: (e) => { if(e.key === 'Enter') this.searchDocContacts(e.target.value); } }),
                DOM.el('button', { className: 'btn-nexus cyan', onclick: () => this.searchDocContacts(document.getElementById('doc-search').value) }, 'SEARCH'),
                DOM.el('button', { className: 'btn-nexus magenta', onclick: () => this.loadPresentations() }, 'PRESENTATIONS')
            ])
        ]);
        c.appendChild(searchSection);

        // Main Layout: Contact List | Detail View
        const mainGrid = DOM.el('div', { className: 'grid-2', style: { gap: '1.5rem' } });

        // Contact List Card
        mainGrid.appendChild(DOM.el('div', { className: 'cyber-card' }, [
            DOM.el('div', { className: 'card-header' }, [DOM.el('span', { className: 'card-title' }, 'RECENT CONTACTS')]),
            DOM.el('div', { className: 'card-body', id: 'doc-contacts-list', style: { maxHeight: '500px', overflowY: 'auto' } }, [
                DOM.el('div', { className: 'loading-skeleton', style: { height: '300px' } })
            ])
        ]));

        // Detail View Card
        mainGrid.appendChild(DOM.el('div', { className: 'cyber-card' }, [
            DOM.el('div', { className: 'card-header' }, [DOM.el('span', { className: 'card-title' }, 'COMMUNICATION HISTORY')]),
            DOM.el('div', { className: 'card-body', id: 'doc-detail-view', style: { maxHeight: '500px', overflowY: 'auto' } }, [
                DOM.el('div', { style: { textAlign: 'center', padding: '3rem', color: 'var(--text-muted)' } }, ['Select a contact to view communication history'])
            ])
        ]));
        c.appendChild(mainGrid);

        // Presentations Section
        const presentationsSection = DOM.el('div', { className: 'cyber-card mt-3', id: 'presentations-section', style: { display: 'none' } }, [
            DOM.el('div', { className: 'card-header' }, [DOM.el('span', { className: 'card-title' }, 'PRESENTATIONS & DEMOS')]),
            DOM.el('div', { className: 'card-body', id: 'presentations-list' }, [])
        ]);
        c.appendChild(presentationsSection);

        this.loadDocContacts();
    },

    async loadDocContacts() {
        const list = document.getElementById('doc-contacts-list'); if (!list) return;
        list.innerHTML = '<div class="loading-skeleton" style="height: 300px;"></div>';

        try {
            const data = await API.get('/api/hubspot/contacts?limit=30');
            DOM.clear(list);

            if (data?.contacts?.length) {
                data.contacts.forEach(contact => {
                    const name = escapeHtml((contact.properties?.firstname || '') + ' ' + (contact.properties?.lastname || '')) || 'Unknown';
                    const email = escapeHtml(contact.properties?.email || '-');
                    const company = escapeHtml(contact.properties?.company || '');

                    list.appendChild(DOM.el('div', {
                        className: 'doc-contact-item',
                        style: { padding: '0.75rem', borderBottom: '1px solid var(--border-dim)', cursor: 'pointer', transition: 'var(--transition-fast)' },
                        onclick: () => this.loadContactHistory(contact.id, name, email),
                        onmouseover: (e) => e.currentTarget.style.background = 'rgba(0,255,247,0.05)',
                        onmouseout: (e) => e.currentTarget.style.background = 'transparent'
                    }, [
                        DOM.el('div', { style: { fontWeight: 600, color: 'var(--neon-cyan)', marginBottom: '2px' } }, [name]),
                        DOM.el('div', { style: { fontSize: '0.8rem', color: 'var(--text-muted)' } }, [email]),
                        company ? DOM.el('div', { style: { fontSize: '0.75rem', color: 'var(--text-secondary)', marginTop: '2px' } }, [company]) : null
                    ].filter(Boolean)));
                });
            } else {
                list.appendChild(DOM.el('div', { style: { textAlign: 'center', padding: '2rem', color: 'var(--text-muted)' } }, ['No contacts found']));
            }
        } catch (e) {
            list.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--neon-red);">Error loading contacts</div>';
        }
    },

    async searchDocContacts(query) {
        if (!query.trim()) { this.loadDocContacts(); return; }
        const list = document.getElementById('doc-contacts-list'); if (!list) return;
        list.innerHTML = '<div class="loading-skeleton" style="height: 200px;"></div>';

        try {
            // Use HubSpot search API
            const data = await API.post('/api/hubspot/search/contacts', { query: query, limit: 20 });
            DOM.clear(list);

            if (data?.results?.length) {
                data.results.forEach(contact => {
                    const name = escapeHtml((contact.properties?.firstname || '') + ' ' + (contact.properties?.lastname || '')) || 'Unknown';
                    const email = escapeHtml(contact.properties?.email || '-');
                    list.appendChild(DOM.el('div', {
                        style: { padding: '0.75rem', borderBottom: '1px solid var(--border-dim)', cursor: 'pointer' },
                        onclick: () => this.loadContactHistory(contact.id, name, email)
                    }, [
                        DOM.el('div', { style: { fontWeight: 600, color: 'var(--neon-cyan)' } }, [name]),
                        DOM.el('div', { style: { fontSize: '0.8rem', color: 'var(--text-muted)' } }, [email])
                    ]));
                });
            } else {
                list.appendChild(DOM.el('div', { style: { textAlign: 'center', padding: '2rem', color: 'var(--text-muted)' } }, ['No results for "' + escapeHtml(query) + '"']));
            }
        } catch (e) {
            // Fallback: filter local contacts
            this.loadDocContacts();
        }
    },

    async loadContactHistory(contactId, name, email) {
        const detail = document.getElementById('doc-detail-view'); if (!detail) return;
        detail.innerHTML = '<div class="loading-skeleton" style="height: 300px;"></div>';

        try {
            const [emails, engagements] = await Promise.all([
                API.get(`/api/hubspot/contacts/${contactId}/emails`),
                API.get(`/api/hubspot/contacts/${contactId}/engagements`)
            ]);

            DOM.clear(detail);

            // Header with contact info
            detail.appendChild(DOM.el('div', { style: { padding: '1rem', background: 'rgba(0,255,247,0.05)', borderBottom: '1px solid var(--border-dim)', marginBottom: '1rem' } }, [
                DOM.el('div', { style: { fontFamily: 'Orbitron', fontSize: '1rem', color: 'var(--neon-cyan)', marginBottom: '4px' } }, [name]),
                DOM.el('div', { style: { fontSize: '0.85rem', color: 'var(--text-muted)' } }, [email]),
                DOM.el('div', { style: { fontSize: '0.75rem', color: 'var(--text-secondary)', marginTop: '8px' } }, [
                    `${emails?.total || 0} Emails | ${engagements?.total || 0} Total Engagements`
                ])
            ]));

            // Tabs: Emails | All Engagements
            const tabContainer = DOM.el('div', { style: { display: 'flex', gap: '0.5rem', marginBottom: '1rem' } });
            tabContainer.appendChild(DOM.el('button', { className: 'btn-nexus cyan', style: { fontSize: '0.7rem', padding: '0.4rem 0.8rem' }, onclick: () => this.showEmailsTab(emails?.emails || []) }, 'EMAILS'));
            tabContainer.appendChild(DOM.el('button', { className: 'btn-nexus', style: { fontSize: '0.7rem', padding: '0.4rem 0.8rem' }, onclick: () => this.showEngagementsTab(engagements?.engagements || []) }, 'ALL'));
            detail.appendChild(tabContainer);

            // Content area
            detail.appendChild(DOM.el('div', { id: 'doc-history-content' }));

            // Show emails by default
            this.showEmailsTab(emails?.emails || []);
        } catch (e) {
            detail.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--neon-red);">Error loading history</div>';
        }
    },

    showEmailsTab(emails) {
        const content = document.getElementById('doc-history-content'); if (!content) return;
        DOM.clear(content);

        if (!emails.length) {
            content.appendChild(DOM.el('div', { style: { textAlign: 'center', padding: '2rem', color: 'var(--text-muted)' } }, ['No email history found']));
            return;
        }

        emails.forEach(email => {
            const date = email.timestamp ? new Date(email.timestamp).toLocaleString('de-DE') : '-';
            const direction = email.direction === 'INCOMING_EMAIL' ? '‚Üê IN' : '‚Üí OUT';
            const dirColor = email.direction === 'INCOMING_EMAIL' ? 'var(--neon-cyan)' : 'var(--neon-magenta)';

            content.appendChild(DOM.el('div', { style: { padding: '0.75rem', borderBottom: '1px solid var(--border-dim)', marginBottom: '0.5rem' } }, [
                DOM.el('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '6px' } }, [
                    DOM.el('span', { style: { fontSize: '0.7rem', padding: '2px 6px', background: 'rgba(0,255,247,0.1)', borderRadius: '3px', color: dirColor } }, [direction]),
                    DOM.el('span', { style: { fontSize: '0.7rem', color: 'var(--text-muted)' } }, [date])
                ]),
                DOM.el('div', { style: { fontWeight: 600, color: 'var(--text-primary)', fontSize: '0.9rem', marginBottom: '4px' } }, [escapeHtml(email.subject)]),
                DOM.el('div', { style: { fontSize: '0.75rem', color: 'var(--text-secondary)', maxHeight: '60px', overflow: 'hidden', textOverflow: 'ellipsis' } }, [escapeHtml((email.body || '').substring(0, 200))])
            ]));
        });
    },

    showEngagementsTab(engagements) {
        const content = document.getElementById('doc-history-content'); if (!content) return;
        DOM.clear(content);

        if (!engagements.length) {
            content.appendChild(DOM.el('div', { style: { textAlign: 'center', padding: '2rem', color: 'var(--text-muted)' } }, ['No engagements found']));
            return;
        }

        engagements.forEach(eng => {
            const typeIcons = { email: '‚úâ', call: 'üìû', meeting: 'üìÖ', note: 'üìù' };
            const typeColors = { email: 'cyan', call: 'green', meeting: 'magenta', note: 'yellow' };
            const icon = typeIcons[eng.type] || '‚Ä¢';
            const color = typeColors[eng.type] || 'cyan';
            const date = eng.properties?.hs_timestamp ? new Date(eng.properties.hs_timestamp).toLocaleString('de-DE') : new Date(eng.createdAt).toLocaleString('de-DE');

            let title = eng.type.toUpperCase();
            if (eng.type === 'email') title = eng.properties?.hs_email_subject || 'Email';
            else if (eng.type === 'call') title = eng.properties?.hs_call_title || 'Call';
            else if (eng.type === 'meeting') title = eng.properties?.hs_meeting_title || 'Meeting';
            else if (eng.type === 'note') title = 'Note';

            content.appendChild(DOM.el('div', { style: { padding: '0.6rem', borderBottom: '1px solid var(--border-dim)', display: 'flex', gap: '0.75rem', alignItems: 'flex-start' } }, [
                DOM.el('span', { style: { fontSize: '1.2rem' } }, [icon]),
                DOM.el('div', { style: { flex: 1 } }, [
                    DOM.el('div', { style: { fontWeight: 600, color: 'var(--neon-' + color + ')', fontSize: '0.85rem' } }, [escapeHtml(title)]),
                    DOM.el('div', { style: { fontSize: '0.7rem', color: 'var(--text-muted)', marginTop: '2px' } }, [date])
                ])
            ]));
        });
    },

    async loadPresentations() {
        const section = document.getElementById('presentations-section');
        const list = document.getElementById('presentations-list');
        if (!section || !list) return;

        section.style.display = 'block';
        list.innerHTML = '<div class="loading-skeleton" style="height: 200px;"></div>';

        try {
            const data = await API.get('/api/hubspot/presentations');
            DOM.clear(list);

            if (data?.presentations?.length) {
                data.presentations.forEach(pres => {
                    const startDate = pres.startTime ? new Date(pres.startTime).toLocaleString('de-DE') : '-';
                    list.appendChild(DOM.el('div', { style: { padding: '1rem', borderBottom: '1px solid var(--border-dim)', display: 'flex', justifyContent: 'space-between', alignItems: 'center' } }, [
                        DOM.el('div', {}, [
                            DOM.el('div', { style: { fontWeight: 600, color: 'var(--neon-magenta)', fontSize: '1rem' } }, [escapeHtml(pres.title || 'Untitled')]),
                            DOM.el('div', { style: { fontSize: '0.8rem', color: 'var(--text-muted)', marginTop: '4px' } }, ['üìÖ ' + startDate]),
                            pres.notes ? DOM.el('div', { style: { fontSize: '0.75rem', color: 'var(--text-secondary)', marginTop: '6px', maxHeight: '40px', overflow: 'hidden' } }, [escapeHtml(pres.notes.substring(0, 150))]) : null
                        ].filter(Boolean)),
                        DOM.el('span', { className: 'cyber-badge ' + (pres.outcome === 'SCHEDULED' ? 'cyan' : pres.outcome === 'COMPLETED' ? 'green' : '') }, [pres.outcome || 'PENDING'])
                    ]));
                });
            } else {
                list.appendChild(DOM.el('div', { style: { textAlign: 'center', padding: '2rem', color: 'var(--text-muted)' } }, ['No presentations found. Presentations are detected from meetings with "Pr√§sentation", "Presentation", "Demo", or "Pitch" in the title.']));
            }
        } catch (e) {
            list.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--neon-red);">Error loading presentations</div>';
        }
    },

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // INTERACTION TRACKER - 360¬∞ Customer View with Infinite Scroll
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    selectedContactId: null,
    interactionChart: null,
    // Pagination & Filter State
    interactionState: {
        contactsOffset: 0,
        contactsLimit: 30,
        contactsHasMore: true,
        contactsLoading: false,
        contactsTotal: 0,
        timelineFilter: 'all', // all, unread, read
        readInteractions: JSON.parse(localStorage.getItem('readInteractions') || '{}')
    },

    async renderInteractionTracker() {
        const c = this.container(); DOM.clear(c);
        // Reset state
        this.interactionState.contactsOffset = 0;
        this.interactionState.contactsHasMore = true;

        // Page Header
        c.appendChild(DOM.el('div', { className: 'page-header' }, [
            DOM.el('h1', { className: 'page-title' }, [document.createTextNode('CUSTOMER '), DOM.el('span', {}, ['INTERACTIONS'])]),
            DOM.el('div', { className: 'flex gap-2' }, [
                DOM.el('button', { className: 'btn-nexus', onclick: () => { Modules.interactionState.contactsOffset = 0; Modules.loadInteractionContacts(true); Modules.loadInteractionStats(); } }, '‚Üª REFRESH'),
                DOM.el('button', { className: 'btn-nexus magenta', onclick: () => Modules.exportInteractions() }, '‚Üì EXPORT')
            ])
        ]));

        // KPI Grid
        const kpiGrid = DOM.el('div', { className: 'kpi-grid', id: 'interaction-kpis' });
        for (let i = 0; i < 4; i++) kpiGrid.appendChild(DOM.el('div', { className: 'loading-skeleton', style: { height: '100px' } }));
        c.appendChild(kpiGrid);

        // Main Content: Contact List | Timeline
        const mainGrid = DOM.el('div', { style: { display: 'grid', gridTemplateColumns: '350px 1fr', gap: '1.5rem', marginTop: '1.5rem' } });

        // Left: Contact Search & List with Infinite Scroll
        mainGrid.appendChild(DOM.el('div', { className: 'cyber-card' }, [
            DOM.el('div', { className: 'card-header', style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center' } }, [
                DOM.el('span', { className: 'card-title' }, 'KONTAKTE'),
                DOM.el('span', { id: 'contacts-count', style: { fontSize: '0.7rem', color: 'var(--text-muted)' } }, ['Lade...'])
            ]),
            DOM.el('div', { className: 'card-body' }, [
                DOM.el('div', { style: { marginBottom: '0.75rem' } }, [
                    DOM.el('input', { type: 'text', id: 'interaction-search', placeholder: 'üîç Kontakt suchen...', style: { width: '100%', padding: '0.6rem', background: 'rgba(0,255,247,0.05)', border: '1px solid var(--border-dim)', color: 'var(--text-primary)', fontFamily: 'Share Tech Mono', borderRadius: '4px', fontSize: '0.85rem' }, onkeyup: (e) => { if (e.key === 'Enter') Modules.searchInteractionContacts(e.target.value); } })
                ]),
                DOM.el('div', { id: 'interaction-contacts', style: { maxHeight: '450px', overflowY: 'auto' }, onscroll: (e) => Modules.handleContactsScroll(e) }, [
                    DOM.el('div', { className: 'loading-skeleton', style: { height: '300px' } })
                ])
            ])
        ]));

        // Right: Timeline with Read/Unread Filter
        mainGrid.appendChild(DOM.el('div', { className: 'cyber-card' }, [
            DOM.el('div', { className: 'card-header', style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '0.5rem' } }, [
                DOM.el('div', {}, [
                    DOM.el('span', { className: 'card-title' }, 'ACTIVITY TIMELINE'),
                    DOM.el('span', { id: 'timeline-contact-name', style: { fontSize: '0.75rem', color: 'var(--neon-magenta)', marginLeft: '0.5rem' } })
                ]),
                DOM.el('div', { style: { display: 'flex', gap: '0.3rem' } }, [
                    DOM.el('button', { id: 'filter-all', className: 'btn-nexus active', style: { padding: '0.25rem 0.5rem', fontSize: '0.6rem' }, onclick: () => Modules.setTimelineFilter('all') }, 'ALLE'),
                    DOM.el('button', { id: 'filter-unread', className: 'btn-nexus', style: { padding: '0.25rem 0.5rem', fontSize: '0.6rem' }, onclick: () => Modules.setTimelineFilter('unread') }, '‚óè UNGELESEN'),
                    DOM.el('button', { id: 'filter-read', className: 'btn-nexus', style: { padding: '0.25rem 0.5rem', fontSize: '0.6rem' }, onclick: () => Modules.setTimelineFilter('read') }, '‚úì GELESEN'),
                    DOM.el('button', { id: 'mark-all-read', className: 'btn-nexus', style: { padding: '0.25rem 0.5rem', fontSize: '0.6rem' }, onclick: () => Modules.markAllAsRead() }, '‚úì‚úì')
                ])
            ]),
            DOM.el('div', { className: 'card-body', id: 'interaction-timeline', style: { maxHeight: '500px', overflowY: 'auto' } }, [
                DOM.el('div', { style: { textAlign: 'center', padding: '3rem', color: 'var(--text-muted)' } }, ['‚Üê Kontakt ausw√§hlen um Timeline zu sehen'])
            ])
        ]));

        c.appendChild(mainGrid);

        // Analytics Section
        const analyticsGrid = DOM.el('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1.5rem', marginTop: '1.5rem' } });

        analyticsGrid.appendChild(DOM.el('div', { className: 'cyber-card' }, [
            DOM.el('div', { className: 'card-header' }, [DOM.el('span', { className: 'card-title' }, 'CHANNEL PERFORMANCE')]),
            DOM.el('div', { className: 'card-body', style: { height: '250px' } }, [
                DOM.el('canvas', { id: 'channel-chart' })
            ])
        ]));

        analyticsGrid.appendChild(DOM.el('div', { className: 'cyber-card' }, [
            DOM.el('div', { className: 'card-header' }, [DOM.el('span', { className: 'card-title' }, 'TOP ENGAGED CONTACTS')]),
            DOM.el('div', { className: 'card-body', id: 'top-contacts', style: { maxHeight: '250px', overflowY: 'auto' } }, [
                DOM.el('div', { className: 'loading-skeleton', style: { height: '200px' } })
            ])
        ]));

        c.appendChild(analyticsGrid);

        // Load data
        this.loadInteractionStats();
        this.loadInteractionContacts(true);
        this.loadInteractionAnalytics();
    },

    // Infinite Scroll Handler for Contacts
    handleContactsScroll(e) {
        const container = e.target;
        const { scrollTop, scrollHeight, clientHeight } = container;
        // Load more when 80% scrolled
        if (scrollTop + clientHeight >= scrollHeight * 0.8) {
            this.loadMoreContacts();
        }
    },

    async loadMoreContacts() {
        if (this.interactionState.contactsLoading || !this.interactionState.contactsHasMore) return;
        this.interactionState.contactsOffset += this.interactionState.contactsLimit;
        await this.loadInteractionContacts(false);
    },

    setTimelineFilter(filter) {
        this.interactionState.timelineFilter = filter;
        document.querySelectorAll('#filter-all, #filter-unread, #filter-read').forEach(btn => btn.classList.remove('active'));
        document.getElementById('filter-' + filter)?.classList.add('active');
        if (this.selectedContactId) this.loadContactTimeline(this.selectedContactId);
    },

    isInteractionRead(interactionId) {
        return !!this.interactionState.readInteractions[interactionId];
    },

    markInteractionRead(interactionId) {
        this.interactionState.readInteractions[interactionId] = Date.now();
        localStorage.setItem('readInteractions', JSON.stringify(this.interactionState.readInteractions));
    },

    markAllAsRead() {
        const timeline = document.getElementById('interaction-timeline');
        if (!timeline) return;
        timeline.querySelectorAll('[data-interaction-id]').forEach(el => {
            const id = el.dataset.interactionId;
            if (id) this.markInteractionRead(id);
        });
        if (this.selectedContactId) this.loadContactTimeline(this.selectedContactId);
    },

    async loadInteractionStats() {
        const container = document.getElementById('interaction-kpis');
        if (!container) return;

        try {
            const stats = await API.get('/api/interactions/stats');
            DOM.clear(container);

            const kpis = [
                { label: 'TOTAL INTERACTIONS', value: formatNumber(stats?.total || 0), class: 'cyan' },
                { label: 'AVG RESPONSE TIME', value: (stats?.avgResponseTime || 0).toFixed(1) + 'h', class: 'magenta' },
                { label: 'ENGAGEMENT SCORE', value: (stats?.engagementScore || 0) + '%', class: 'green' },
                { label: 'PENDING FOLLOW-UPS', value: formatNumber(stats?.pendingFollowUps || 0), class: 'yellow' }
            ];

            kpis.forEach(kpi => {
                container.appendChild(DOM.el('div', { className: 'kpi-card ' + kpi.class }, [
                    DOM.el('div', { className: 'kpi-label' }, [kpi.label]),
                    DOM.el('div', { className: 'kpi-value' }, [kpi.value])
                ]));
            });
        } catch (e) {
            container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--neon-red);">Error loading stats</div>';
        }
    },

    async loadInteractionContacts(reset = false) {
        const container = document.getElementById('interaction-contacts');
        if (!container) return;

        const state = this.interactionState;
        if (state.contactsLoading) return;
        state.contactsLoading = true;

        if (reset) {
            state.contactsOffset = 0;
            state.contactsHasMore = true;
            DOM.clear(container);
        }

        // Show loading indicator
        const loadingEl = DOM.el('div', { id: 'contacts-loading', style: { textAlign: 'center', padding: '1rem', color: 'var(--text-muted)' } }, ['‚è≥ Lade weitere...']);
        if (!reset) container.appendChild(loadingEl);

        try {
            const data = await API.get(`/api/interactions/contacts?limit=${state.contactsLimit}&offset=${state.contactsOffset}`);
            document.getElementById('contacts-loading')?.remove();

            const contacts = data?.contacts || [];
            state.contactsTotal = data?.total || 0;
            state.contactsHasMore = contacts.length === state.contactsLimit;

            // Update counter
            const countEl = document.getElementById('contacts-count');
            if (countEl) {
                const loaded = state.contactsOffset + contacts.length;
                countEl.textContent = `${loaded} von ${formatNumber(state.contactsTotal)}`;
            }

            if (contacts.length) {
                const stageColors = { customer: 'green', lead: 'cyan', marketingqualifiedlead: 'magenta', salesqualifiedlead: 'yellow', opportunity: 'magenta' };
                const stageLabels = { customer: 'KUNDE', lead: 'LEAD', marketingqualifiedlead: 'MQL', salesqualifiedlead: 'SQL', opportunity: 'OPP' };

                contacts.forEach(contact => {
                    const stageClass = stageColors[contact.lifecycleStage] || '';
                    const stageLabel = stageLabels[contact.lifecycleStage] || contact.lifecycleStage?.toUpperCase() || '';

                    container.appendChild(DOM.el('div', {
                        className: 'interaction-contact-item',
                        'data-contact-id': contact.id,
                        style: { padding: '0.6rem 0.75rem', borderBottom: '1px solid var(--border-dim)', cursor: 'pointer', transition: 'var(--transition-fast)' },
                        onclick: () => Modules.selectContact(contact.id, contact.displayName),
                        onmouseover: (e) => e.currentTarget.style.background = 'rgba(0,255,247,0.1)',
                        onmouseout: (e) => { if (!e.currentTarget.classList.contains('selected')) e.currentTarget.style.background = 'transparent'; }
                    }, [
                        DOM.el('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' } }, [
                            DOM.el('div', { style: { minWidth: 0, flex: 1 } }, [
                                DOM.el('div', { style: { fontWeight: 600, color: 'var(--text-primary)', fontSize: '0.85rem', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' } }, [escapeHtml(contact.displayName)]),
                                DOM.el('div', { style: { fontSize: '0.65rem', color: 'var(--text-muted)', marginTop: '2px', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' } }, [
                                    contact.company ? escapeHtml(contact.company) : escapeHtml(contact.email || '')
                                ])
                            ]),
                            DOM.el('div', { style: { display: 'flex', flexDirection: 'column', alignItems: 'flex-end', gap: '2px', marginLeft: '0.5rem' } }, [
                                stageLabel ? DOM.el('span', { className: 'cyber-badge ' + stageClass, style: { fontSize: '0.5rem', padding: '0.1rem 0.25rem' } }, [stageLabel]) : document.createTextNode(''),
                                contact.dealCount > 0 ? DOM.el('span', { style: { fontSize: '0.55rem', color: 'var(--neon-green)' } }, ['üíº' + contact.dealCount]) : document.createTextNode('')
                            ])
                        ])
                    ]));
                });

                // Add "load more" hint if more available
                if (state.contactsHasMore) {
                    container.appendChild(DOM.el('div', { style: { textAlign: 'center', padding: '0.5rem', color: 'var(--text-muted)', fontSize: '0.7rem' } }, ['‚Üì Scrolle f√ºr mehr']));
                }
            } else if (reset) {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);">Keine Kontakte gefunden</div>';
            }
        } catch (e) {
            document.getElementById('contacts-loading')?.remove();
            if (reset) container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--neon-red);">Fehler: ' + escapeHtml(e.message) + '</div>';
        }

        state.contactsLoading = false;
    },

    async searchInteractionContacts(query) {
        if (!query || query.length < 2) {
            this.loadInteractionContacts();
            return;
        }

        const container = document.getElementById('interaction-contacts');
        if (!container) return;

        container.innerHTML = '<div class="loading-skeleton" style="height: 200px;"></div>';

        try {
            const data = await API.post('/api/hubspot/search/contacts', { query, limit: 20 });
            DOM.clear(container);

            const contacts = data?.contacts || data?.results || [];
            if (contacts.length) {
                contacts.forEach(contact => {
                    const name = `${contact.properties?.firstname || ''} ${contact.properties?.lastname || ''}`.trim() || contact.properties?.email || 'Unknown';
                    container.appendChild(DOM.el('div', {
                        style: { padding: '0.75rem', borderBottom: '1px solid var(--border-dim)', cursor: 'pointer' },
                        onclick: () => Modules.selectContact(contact.id, name)
                    }, [
                        DOM.el('div', { style: { fontWeight: 600, color: 'var(--text-primary)' } }, [escapeHtml(name)]),
                        DOM.el('div', { style: { fontSize: '0.75rem', color: 'var(--text-muted)' } }, [escapeHtml(contact.properties?.email || '')])
                    ]));
                });
            } else {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);">No contacts found for "' + escapeHtml(query) + '"</div>';
            }
        } catch (e) {
            container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--neon-red);">Search error</div>';
        }
    },

    async selectContact(contactId, contactName) {
        this.selectedContactId = contactId;

        // Update UI to show selected contact
        const nameEl = document.getElementById('timeline-contact-name');
        if (nameEl) nameEl.textContent = contactName;

        // Highlight selected
        document.querySelectorAll('.interaction-contact-item').forEach(el => el.style.background = 'transparent');
        event?.target?.closest?.('.interaction-contact-item')?.style && (event.target.closest('.interaction-contact-item').style.background = 'rgba(0,255,247,0.15)');

        // Load timeline
        this.loadContactTimeline(contactId);
    },

    async loadContactTimeline(contactId) {
        const container = document.getElementById('interaction-timeline');
        if (!container) return;

        container.innerHTML = '<div class="loading-skeleton" style="height: 300px;"></div>';

        try {
            const data = await API.get(`/api/interactions/contact/${contactId}?limit=100`);
            DOM.clear(container);

            // Show contact stats with unread count
            const filter = this.interactionState.timelineFilter;
            let interactions = data?.interactions || [];

            // Sort by timestamp (newest first)
            interactions.sort((a, b) => new Date(b.timestamp || 0) - new Date(a.timestamp || 0));

            // Count unread
            const unreadCount = interactions.filter(i => !this.isInteractionRead(i.id)).length;

            if (data?.stats) {
                const stats = data.stats;
                container.appendChild(DOM.el('div', { style: { display: 'flex', gap: '0.75rem', marginBottom: '1rem', padding: '0.6rem', background: 'rgba(0,255,247,0.05)', borderRadius: '4px', fontSize: '0.7rem', flexWrap: 'wrap' } }, [
                    DOM.el('span', { style: { color: 'var(--neon-cyan)' } }, ['üìß ' + stats.emails]),
                    DOM.el('span', { style: { color: 'var(--neon-green)' } }, ['‚òé ' + stats.calls]),
                    DOM.el('span', { style: { color: 'var(--neon-magenta)' } }, ['üìÖ ' + stats.meetings]),
                    DOM.el('span', { style: { color: 'var(--neon-yellow)' } }, ['üìù ' + stats.notes]),
                    DOM.el('span', { style: { color: unreadCount > 0 ? 'var(--neon-magenta)' : 'var(--text-muted)', fontWeight: unreadCount > 0 ? 700 : 400 } }, ['‚óè ' + unreadCount + ' ungelesen'])
                ]));
            }

            // Apply filter
            if (filter === 'unread') {
                interactions = interactions.filter(i => !this.isInteractionRead(i.id));
            } else if (filter === 'read') {
                interactions = interactions.filter(i => this.isInteractionRead(i.id));
            }

            if (interactions.length) {
                interactions.forEach(interaction => {
                    const timestamp = interaction.timestamp ? new Date(interaction.timestamp).toLocaleString('de-DE') : '-';
                    const isRead = this.isInteractionRead(interaction.id);
                    const timeAgo = interaction.timestamp ? this.getTimeAgo(new Date(interaction.timestamp)) : '';

                    const row = DOM.el('div', {
                        'data-interaction-id': interaction.id,
                        style: {
                            padding: '0.6rem 0.75rem',
                            borderBottom: '1px solid var(--border-dim)',
                            display: 'flex',
                            gap: '0.6rem',
                            background: isRead ? 'transparent' : 'rgba(255,0,128,0.05)',
                            cursor: 'pointer',
                            transition: 'var(--transition-fast)'
                        },
                        onclick: (e) => {
                            this.markInteractionRead(interaction.id);
                            e.currentTarget.style.background = 'transparent';
                            e.currentTarget.querySelector('.unread-dot')?.remove();
                        }
                    }, [
                        DOM.el('div', { style: { display: 'flex', flexDirection: 'column', alignItems: 'center', width: '28px' } }, [
                            DOM.el('span', { style: { fontSize: '1.1rem' } }, [interaction.icon || '‚Ä¢']),
                            !isRead ? DOM.el('span', { className: 'unread-dot', style: { width: '6px', height: '6px', borderRadius: '50%', background: 'var(--neon-magenta)', marginTop: '4px' } }) : document.createTextNode('')
                        ]),
                        DOM.el('div', { style: { flex: 1, minWidth: 0 } }, [
                            DOM.el('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', gap: '0.5rem' } }, [
                                DOM.el('div', { style: { fontWeight: isRead ? 500 : 700, color: `var(--neon-${interaction.color || 'cyan'})`, fontSize: '0.8rem', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' } }, [escapeHtml(interaction.title || interaction.type)]),
                                DOM.el('div', { style: { fontSize: '0.6rem', color: 'var(--text-muted)', whiteSpace: 'nowrap' } }, [timeAgo])
                            ]),
                            interaction.description ? DOM.el('div', { style: { fontSize: '0.7rem', color: 'var(--text-secondary)', marginTop: '2px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' } }, [escapeHtml(interaction.description.substring(0, 80))]) : null,
                            DOM.el('div', { style: { fontSize: '0.6rem', color: 'var(--text-muted)', marginTop: '3px' } }, [timestamp + ' ‚Ä¢ ' + (interaction.source || 'HubSpot')])
                        ].filter(Boolean))
                    ]);
                    container.appendChild(row);
                });

                // Add follow-up button
                container.appendChild(DOM.el('div', { style: { padding: '1rem', textAlign: 'center' } }, [
                    DOM.el('button', { className: 'btn-nexus', onclick: () => Modules.createFollowUp(contactId) }, '+ FOLLOW-UP ERSTELLEN')
                ]));
            } else {
                const msg = filter === 'unread' ? 'Keine ungelesenen Interaktionen' : filter === 'read' ? 'Keine gelesenen Interaktionen' : 'Keine Interaktionen gefunden';
                container.innerHTML = '<div style="text-align: center; padding: 3rem; color: var(--text-muted);">' + msg + '</div>';
            }
        } catch (e) {
            container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--neon-red);">Error: ' + escapeHtml(e.message) + '</div>';
        }
    },

    getTimeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        if (seconds < 60) return 'gerade eben';
        if (seconds < 3600) return Math.floor(seconds / 60) + ' Min';
        if (seconds < 86400) return Math.floor(seconds / 3600) + ' Std';
        if (seconds < 604800) return Math.floor(seconds / 86400) + ' Tage';
        return Math.floor(seconds / 604800) + ' Wo';
    },

    async loadInteractionAnalytics() {
        try {
            const data = await API.get('/api/interactions/analytics?days=7');

            // Channel Chart
            const ctx = document.getElementById('channel-chart');
            if (ctx && data?.channels) {
                if (this.interactionChart) this.interactionChart.destroy();

                const channels = data.channels;
                this.interactionChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.values(channels).map(c => c.label),
                        datasets: [{
                            label: 'Interaktionen',
                            data: Object.values(channels).map(c => c.count),
                            backgroundColor: ['rgba(0,255,247,0.6)', 'rgba(0,255,136,0.6)', 'rgba(255,0,255,0.6)', 'rgba(0,255,136,0.6)', 'rgba(255,247,0,0.6)'],
                            borderColor: ['#00fff7', '#00ff88', '#ff00ff', '#00ff88', '#fff700'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, grid: { color: 'rgba(0,255,247,0.1)' }, ticks: { color: '#a0a0b0' } },
                            x: { grid: { display: false }, ticks: { color: '#a0a0b0' } }
                        }
                    }
                });
            }

            // Top Contacts
            const topContainer = document.getElementById('top-contacts');
            if (topContainer && data?.topContacts) {
                DOM.clear(topContainer);
                data.topContacts.forEach((contact, i) => {
                    topContainer.appendChild(DOM.el('div', {
                        style: { padding: '0.5rem', borderBottom: '1px solid var(--border-dim)', display: 'flex', alignItems: 'center', gap: '0.75rem', cursor: 'pointer' },
                        onclick: () => Modules.selectContact(contact.id, contact.name)
                    }, [
                        DOM.el('span', { style: { color: 'var(--neon-cyan)', fontWeight: 700, width: '20px' } }, [(i + 1) + '.']),
                        DOM.el('div', { style: { flex: 1 } }, [
                            DOM.el('div', { style: { fontWeight: 500 } }, [escapeHtml(contact.name || contact.email)]),
                            DOM.el('div', { style: { fontSize: '0.7rem', color: 'var(--text-muted)' } }, [escapeHtml(contact.email || '')])
                        ])
                    ]));
                });
            }
        } catch (e) {
            console.error('Analytics error:', e);
        }
    },

    createFollowUp(contactId) {
        const cId = contactId || this.selectedContactId;
        if (!cId) return alert('Bitte erst einen Kontakt ausw√§hlen');

        NexusApp.showModal('FOLLOW-UP ERSTELLEN',
            DOM.el('div', {}, [
                DOM.el('div', { style: { marginBottom: '1rem' } }, [
                    DOM.el('label', { style: { display: 'block', marginBottom: '0.5rem', color: 'var(--text-secondary)' } }, ['Betreff']),
                    DOM.el('input', { type: 'text', id: 'followup-subject', placeholder: 'z.B. Angebot nachfassen', style: { width: '100%', padding: '0.75rem', background: 'rgba(0,255,247,0.05)', border: '1px solid var(--border-dim)', color: 'var(--text-primary)', borderRadius: '4px' } })
                ]),
                DOM.el('div', { style: { marginBottom: '1rem' } }, [
                    DOM.el('label', { style: { display: 'block', marginBottom: '0.5rem', color: 'var(--text-secondary)' } }, ['F√§llig am']),
                    DOM.el('input', { type: 'date', id: 'followup-date', style: { width: '100%', padding: '0.75rem', background: 'rgba(0,255,247,0.05)', border: '1px solid var(--border-dim)', color: 'var(--text-primary)', borderRadius: '4px' } })
                ]),
                DOM.el('div', {}, [
                    DOM.el('label', { style: { display: 'block', marginBottom: '0.5rem', color: 'var(--text-secondary)' } }, ['Notizen']),
                    DOM.el('textarea', { id: 'followup-notes', rows: 3, placeholder: 'Optionale Notizen...', style: { width: '100%', padding: '0.75rem', background: 'rgba(0,255,247,0.05)', border: '1px solid var(--border-dim)', color: 'var(--text-primary)', borderRadius: '4px', resize: 'vertical' } })
                ])
            ]),
            DOM.el('div', { className: 'flex gap-2 justify-end' }, [
                DOM.el('button', { className: 'btn-nexus', onclick: () => NexusApp.hideModal() }, 'ABBRECHEN'),
                DOM.el('button', { className: 'btn-nexus magenta', onclick: async () => {
                    const subject = document.getElementById('followup-subject')?.value;
                    const dueDate = document.getElementById('followup-date')?.value;
                    const notes = document.getElementById('followup-notes')?.value;
                    if (!subject) return alert('Betreff erforderlich');
                    try {
                        await API.post('/api/interactions/follow-up', { contactId: cId, subject, dueDate, notes });
                        NexusApp.hideModal();
                        alert('Follow-up erstellt!');
                        Modules.loadInteractionStats();
                    } catch (e) { alert('Fehler: ' + e.message); }
                } }, 'ERSTELLEN')
            ])
        );
        NexusApp.showModalDialog();
    },

    exportInteractions() {
        const cId = this.selectedContactId;
        if (!cId) return alert('Bitte erst einen Kontakt ausw√§hlen');

        NexusApp.showModal('EXPORT',
            DOM.el('div', { style: { textAlign: 'center', padding: '1rem' } }, [
                DOM.el('p', { style: { marginBottom: '1rem', color: 'var(--text-secondary)' } }, ['Interaktionen exportieren als:']),
                DOM.el('div', { className: 'flex gap-2 justify-center' }, [
                    DOM.el('button', { className: 'btn-nexus cyan', onclick: () => { window.open(`/api/interactions/export?contactId=${cId}&format=csv`, '_blank'); NexusApp.hideModal(); } }, 'CSV'),
                    DOM.el('button', { className: 'btn-nexus magenta', onclick: () => { window.open(`/api/interactions/export?contactId=${cId}&format=json`, '_blank'); NexusApp.hideModal(); } }, 'JSON')
                ])
            ]),
            null
        );
        NexusApp.showModalDialog();
    },

    renderIntegrations() { this.renderPlaceholder('INTEGRATIONS', 'External system connections'); },
    renderSettings() { this.renderPlaceholder('SETTINGS', 'System configuration'); },
    render404() { this.renderPlaceholder('404', 'Route not found in NEXUS'); },

    renderPlaceholder(title, subtitle) {
        const c = this.container(); DOM.clear(c);
        c.appendChild(DOM.el('div', { className: 'page-header' }, [DOM.el('h1', { className: 'page-title' }, [DOM.el('span', {}, [title])])]));
        c.appendChild(DOM.el('div', { className: 'cyber-card', style: { textAlign: 'center', padding: '4rem 2rem' } }, [
            DOM.el('div', { style: { fontSize: '4rem', marginBottom: '1rem', opacity: '0.3' } }, ['‚öô']),
            DOM.el('div', { style: { fontFamily: 'Orbitron', fontSize: '1.5rem', color: 'var(--neon-cyan)', marginBottom: '0.5rem' } }, [title]),
            DOM.el('div', { style: { color: 'var(--text-muted)' } }, [subtitle]),
            DOM.el('div', { style: { marginTop: '2rem' } }, [DOM.el('button', { className: 'btn-nexus', onclick: () => location.hash = '#/' }, 'RETURN TO DASHBOARD')])
        ]));
    }
};

const NexusApp = {
    init() {
        console.log('%c NEXUS COMMAND CENTER v2.0 ', 'background: #00fff7; color: #000; font-weight: bold; padding: 10px;');
        ParticleSystem.init(); Router.init(); this.updateClock();
        setInterval(() => this.updateClock(), 1000);
    },
    updateClock() { const el = document.getElementById('current-time'); if (el) el.textContent = new Date().toLocaleTimeString('de-DE'); },
    refreshDashboard() { Modules.loadDashboardData(); },
    showModal(title, bodyContent, footerContent) {
        document.getElementById('modal-title').textContent = title;
        const body = document.getElementById('modal-body'); DOM.clear(body);
        if (typeof bodyContent === 'string') body.textContent = bodyContent; else body.appendChild(bodyContent);
        const footer = document.getElementById('modal-footer'); DOM.clear(footer);
        if (footerContent) { if (typeof footerContent === 'string') footer.textContent = footerContent; else footer.appendChild(footerContent); }
        document.getElementById('modal-overlay').classList.add('active');
    },
    closeModal() { document.getElementById('modal-overlay').classList.remove('active'); },
    showNewContactModal() {
        const form = DOM.el('div', {}, [
            DOM.el('div', { className: 'mb-2' }, [DOM.el('label', { style: { display: 'block', marginBottom: '0.5rem', color: 'var(--text-secondary)' } }, ['FIRST NAME']), DOM.el('input', { type: 'text', className: 'cyber-input', id: 'contact-firstname', placeholder: 'Enter first name' })]),
            DOM.el('div', { className: 'mb-2' }, [DOM.el('label', { style: { display: 'block', marginBottom: '0.5rem', color: 'var(--text-secondary)' } }, ['LAST NAME']), DOM.el('input', { type: 'text', className: 'cyber-input', id: 'contact-lastname', placeholder: 'Enter last name' })]),
            DOM.el('div', { className: 'mb-2' }, [DOM.el('label', { style: { display: 'block', marginBottom: '0.5rem', color: 'var(--text-secondary)' } }, ['EMAIL']), DOM.el('input', { type: 'email', className: 'cyber-input', id: 'contact-email', placeholder: 'Enter email address' })])
        ]);
        const footer = DOM.el('div', { className: 'flex gap-2' }, [DOM.el('button', { className: 'btn-nexus', onclick: () => this.closeModal() }, 'CANCEL'), DOM.el('button', { className: 'btn-nexus magenta', onclick: () => this.createContact() }, 'CREATE')]);
        this.showModal('NEW CONTACT', form, footer);
    },
    async createContact() {
        const data = { properties: { firstname: document.getElementById('contact-firstname')?.value, lastname: document.getElementById('contact-lastname')?.value, email: document.getElementById('contact-email')?.value } };
        const result = await API.post('/api/hubspot/contacts', data);
        if (result) { this.closeModal(); Modules.loadContacts(); }
    },
    showContactDetail(id) { this.showModal('CONTACT DETAILS', 'Loading contact data...'); },
    showNewDealModal() { this.showModal('NEW DEAL', 'Deal creation form...', DOM.el('button', { className: 'btn-nexus' }, ['CREATE DEAL'])); },
    async showDealDetail(dealId) {
        this.showModal('DEAL DETAILS', 'Loading deal data...');

        try {
            // Load deal with contact
            const [dealRes, associationRes] = await Promise.all([
                API.get(`/api/hubspot/deal/${dealId}`),
                fetch(`${window.API_BASE || ''}/api/hubspot/deals/${dealId}/associations/contacts`).then(r => r.ok ? r.json() : { results: [] }).catch(() => ({ results: [] }))
            ]);

            const deal = dealRes?.deal || dealRes;
            const props = deal?.properties || {};

            let contact = null;
            if (associationRes?.results?.length > 0) {
                const contactId = associationRes.results[0].id;
                const contactRes = await API.get(`/api/hubspot/contacts/${contactId}`);
                contact = contactRes?.contact || contactRes;
            }

            const stageColors = {
                'qualifiedtobuy': 'cyan', 'presentationscheduled': 'magenta',
                'decisionmakerboughtin': 'pink', 'closedwon': 'green', 'closedlost': 'magenta'
            };
            const stageNames = {
                'qualifiedtobuy': 'QUALIFIED', 'presentationscheduled': 'PRESENTATION',
                'decisionmakerboughtin': 'DECISION', 'closedwon': 'WON', 'closedlost': 'LOST'
            };

            const color = stageColors[props.dealstage] || 'cyan';
            const stageName = stageNames[props.dealstage] || props.dealstage?.toUpperCase() || 'UNKNOWN';

            const content = DOM.el('div', {}, [
                // Header
                DOM.el('div', { style: { textAlign: 'center', marginBottom: '1.5rem' } }, [
                    DOM.el('div', { style: { fontFamily: 'Orbitron', fontSize: '1.5rem', color: 'var(--neon-cyan)', marginBottom: '0.5rem' } }, [escapeHtml(props.dealname || 'Unnamed Deal')]),
                    DOM.el('span', { className: `cyber-badge ${color}` }, [stageName])
                ]),

                // Amount
                DOM.el('div', { style: { textAlign: 'center', marginBottom: '1.5rem', padding: '1rem', background: 'rgba(0,255,247,0.1)', borderRadius: '8px' } }, [
                    DOM.el('div', { style: { fontSize: '0.75rem', color: 'var(--text-muted)', marginBottom: '0.3rem' } }, ['DEAL VALUE']),
                    DOM.el('div', { style: { fontFamily: 'Orbitron', fontSize: '2rem', color: 'var(--neon-green)' } }, [formatCurrency(props.amount || 0)])
                ]),

                // Contact Section
                DOM.el('div', { style: { marginBottom: '1.5rem', padding: '1rem', background: 'rgba(0,255,247,0.05)', borderRadius: '8px', borderLeft: contact ? '3px solid var(--neon-green)' : '3px solid var(--neon-magenta)' } }, [
                    DOM.el('div', { style: { fontSize: '0.75rem', color: 'var(--text-muted)', marginBottom: '0.5rem', fontFamily: 'Orbitron' } }, ['VERKN√úPFTER KONTAKT']),
                    contact ? DOM.el('div', {}, [
                        DOM.el('div', { style: { fontSize: '1rem', color: 'var(--neon-cyan)', marginBottom: '0.3rem' } }, [
                            'üë§ ' + escapeHtml(((contact.properties?.firstname || '') + ' ' + (contact.properties?.lastname || '')).trim() || 'Unknown')
                        ]),
                        contact.properties?.email ? DOM.el('div', { style: { marginBottom: '0.2rem' } }, [
                            DOM.el('span', { style: { color: 'var(--text-muted)', fontSize: '0.8rem' } }, ['üìß ']),
                            DOM.el('a', { href: 'mailto:' + contact.properties.email, style: { color: 'var(--neon-green)', textDecoration: 'none' } }, [contact.properties.email])
                        ]) : DOM.el('div', { style: { color: 'var(--neon-magenta)', fontSize: '0.85rem' } }, ['‚ö† Keine Email hinterlegt']),
                        contact.properties?.phone ? DOM.el('div', { style: { fontSize: '0.85rem', color: 'var(--text-secondary)' } }, ['üìû ' + contact.properties.phone]) : null,
                        contact.properties?.company ? DOM.el('div', { style: { fontSize: '0.85rem', color: 'var(--text-secondary)', marginTop: '0.3rem' } }, ['üè¢ ' + escapeHtml(contact.properties.company)]) : null
                    ].filter(Boolean)) : DOM.el('div', {}, [
                        DOM.el('div', { style: { color: 'var(--neon-magenta)', marginBottom: '0.5rem' } }, ['‚ö† Kein Kontakt verkn√ºpft']),
                        DOM.el('button', { className: 'btn-nexus', onclick: () => NexusApp.linkContactToDeal(dealId, props.dealname) }, '+ KONTAKT VERKN√úPFEN')
                    ])
                ]),

                // Deal Info
                DOM.el('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' } }, [
                    DOM.el('div', { style: { padding: '0.75rem', background: 'rgba(0,0,0,0.3)', borderRadius: '6px' } }, [
                        DOM.el('div', { style: { fontSize: '0.7rem', color: 'var(--text-muted)' } }, ['ERSTELLT']),
                        DOM.el('div', { style: { fontSize: '0.85rem' } }, [props.createdate ? new Date(props.createdate).toLocaleDateString('de-DE') : '-'])
                    ]),
                    DOM.el('div', { style: { padding: '0.75rem', background: 'rgba(0,0,0,0.3)', borderRadius: '6px' } }, [
                        DOM.el('div', { style: { fontSize: '0.7rem', color: 'var(--text-muted)' } }, ['ABSCHLUSSDATUM']),
                        DOM.el('div', { style: { fontSize: '0.85rem' } }, [props.closedate ? new Date(props.closedate).toLocaleDateString('de-DE') : '-'])
                    ])
                ]),

                // Actions
                DOM.el('div', { style: { marginTop: '1.5rem', display: 'flex', gap: '0.5rem', flexWrap: 'wrap' } }, [
                    props.dealstage === 'closedwon' && !contact?.properties?.email ? DOM.el('button', {
                        className: 'btn-nexus magenta',
                        onclick: () => NexusApp.queueDealForEmailSync(dealId)
                    }, 'üìß EMAIL SYNC QUEUE') : null,
                    props.dealstage === 'closedwon' && contact?.properties?.email ? DOM.el('button', {
                        className: 'btn-nexus green',
                        onclick: () => NexusApp.sendInvoiceForDeal(dealId)
                    }, 'üìÑ RECHNUNG SENDEN') : null,
                    DOM.el('a', {
                        className: 'btn-nexus',
                        href: `https://app.hubspot.com/contacts/46972270/record/deal/${dealId}`,
                        target: '_blank',
                        style: { display: 'inline-block', textDecoration: 'none' }
                    }, '‚Üó IN HUBSPOT √ñFFNEN')
                ].filter(Boolean))
            ]);

            const modal = document.querySelector('.modal-body');
            if (modal) { DOM.clear(modal); modal.appendChild(content); }
        } catch (error) {
            console.error('Error loading deal:', error);
            const modal = document.querySelector('.modal-body');
            if (modal) { modal.innerHTML = `<div style="color: var(--neon-magenta)">Error: ${escapeHtml(error.message)}</div>`; }
        }
    },

    async linkContactToDeal(dealId, dealName) {
        const email = prompt(`E-Mail Adresse f√ºr "${dealName}" eingeben:`);
        if (!email || !email.includes('@')) {
            if (email) this.showToast('Ung√ºltige E-Mail Adresse', 'error');
            return;
        }

        try {
            this.showToast('Pr√ºfe auf Duplikate...', 'info');

            // Use safe-create API with duplicate prevention
            const createRes = await API.post('/api/hubspot/contacts/safe-create', {
                email,
                company: dealName
            });

            let contactId;
            if (createRes?.success) {
                contactId = createRes.id || createRes.contact?.id;
                this.showToast(`Neuen Kontakt erstellt: ${email}`, 'success');
            } else if (createRes?.reason === 'duplicate_found') {
                // Existing contact found
                contactId = createRes.existingContact?.id;
                this.showToast(`Existierenden Kontakt gefunden: ${email}`, 'success');
            } else {
                throw new Error(createRes?.message || 'Kontakt konnte nicht erstellt werden');
            }

            if (contactId) {
                // Link contact to deal in HubSpot
                const linkRes = await fetch(`${window.API_BASE || ''}/api/hubspot/deals/${dealId}/associations/contacts/${contactId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!linkRes.ok) {
                    const err = await linkRes.json();
                    throw new Error(err.error || 'Verkn√ºpfung fehlgeschlagen');
                }

                this.showToast('‚úì Kontakt mit Deal in HubSpot verkn√ºpft!', 'success');

                // Refresh deal detail
                setTimeout(() => this.showDealDetail(dealId), 500);
            }
        } catch (error) {
            console.error('linkContactToDeal error:', error);
            this.showToast('Fehler: ' + error.message, 'error');
        }
    },

    async queueDealForEmailSync(dealId) {
        try {
            await API.post(`/api/v1/email-sync/queue/${dealId}`);
            this.showToast('Deal zur Email-Sync-Queue hinzugef√ºgt', 'success');
        } catch (error) {
            this.showToast('Fehler: ' + error.message, 'error');
        }
    },

    async sendInvoiceForDeal(dealId) {
        try {
            const result = await API.post('/api/v1/invoices/send', { dealId });
            if (result?.success) {
                this.showToast('Rechnung gesendet!', 'success');
            } else {
                this.showToast('Fehler: ' + (result?.reason || 'Unbekannt'), 'error');
            }
        } catch (error) {
            this.showToast('Fehler: ' + error.message, 'error');
        }
    },

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // LEAD GENERATOR CONTROL FUNCTIONS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async toggleLeadGenerator() {
        const status = await API.get('/api/v1/lead-generator/status');
        const endpoint = status?.running ? '/api/v1/lead-generator/stop' : '/api/v1/lead-generator/start';

        try {
            const result = await API.post(endpoint);
            this.showToast(result?.message || (status?.running ? 'Generator gestoppt' : 'Generator gestartet'), 'success');
            Modules.loadLeadGeneratorData();
        } catch (error) {
            this.showToast('Fehler: ' + error.message, 'error');
        }
    },

    async generateLeadBatch() {
        this.showToast('Generiere Leads...', 'info');
        try {
            const result = await API.post('/api/v1/lead-generator/generate', { count: 50, uploadToHubSpot: true });
            if (result?.success) {
                this.showToast(`${result.count} Leads generiert und zu HubSpot hochgeladen!`, 'success');
                Modules.loadLeadGeneratorData();
            } else {
                this.showToast('Fehler: ' + (result?.error || 'Unbekannt'), 'error');
            }
        } catch (error) {
            this.showToast('Fehler: ' + error.message, 'error');
        }
    },

    showLeadGenConfig() {
        const form = DOM.el('div', {}, [
            DOM.el('div', { className: 'mb-2' }, [
                DOM.el('label', { style: { display: 'block', marginBottom: '0.5rem', color: 'var(--text-secondary)' } }, ['LEADS PRO BATCH']),
                DOM.el('input', { type: 'number', className: 'cyber-input', id: 'lg-batch-size', value: '50', min: '1', max: '100', style: { width: '100%' } })
            ]),
            DOM.el('div', { className: 'mb-2' }, [
                DOM.el('label', { style: { display: 'block', marginBottom: '0.5rem', color: 'var(--text-secondary)' } }, ['INTERVAL (SEKUNDEN)']),
                DOM.el('input', { type: 'number', className: 'cyber-input', id: 'lg-interval', value: '60', min: '10', style: { width: '100%' } })
            ]),
            DOM.el('div', { className: 'mb-2' }, [
                DOM.el('label', { style: { display: 'flex', alignItems: 'center', gap: '0.5rem', cursor: 'pointer' } }, [
                    DOM.el('input', { type: 'checkbox', id: 'lg-hubspot', checked: true }),
                    DOM.el('span', {}, ['Direkt zu HubSpot hochladen'])
                ])
            ]),
            DOM.el('div', { style: { marginTop: '1rem', padding: '0.8rem', background: 'rgba(0,255,247,0.05)', borderRadius: '8px' } }, [
                DOM.el('div', { style: { fontFamily: 'Orbitron', fontSize: '0.8rem', color: 'var(--neon-cyan)', marginBottom: '0.5rem' } }, ['REGION GEWICHTUNG']),
                DOM.el('div', { style: { fontSize: '0.75rem', color: 'var(--text-muted)' } }, [
                    'DACH: 35% | Europe: 25% | North America: 25%',
                    DOM.el('br'),
                    'APAC: 10% | Other: 5%'
                ])
            ])
        ]);

        const footer = DOM.el('div', { className: 'flex gap-2' }, [
            DOM.el('button', { className: 'btn-nexus', onclick: () => this.closeModal() }, 'CANCEL'),
            DOM.el('button', { className: 'btn-nexus cyan', onclick: () => this.resetLeadGenStats() }, 'RESET STATS'),
            DOM.el('button', { className: 'btn-nexus green', onclick: () => this.saveLeadGenConfig() }, 'SAVE')
        ]);

        this.showModal('LEAD GENERATOR CONFIG', form, footer);

        // Load current config
        API.get('/api/v1/lead-generator/status').then(status => {
            if (status?.config) {
                const batchInput = document.getElementById('lg-batch-size');
                const intervalInput = document.getElementById('lg-interval');
                const hubspotCheck = document.getElementById('lg-hubspot');
                if (batchInput) batchInput.value = status.config.leadsPerBatch;
                if (intervalInput) intervalInput.value = status.config.batchInterval / 1000;
                if (hubspotCheck) hubspotCheck.checked = status.config.uploadToHubSpot;
            }
        });
    },

    async saveLeadGenConfig() {
        const batchSize = parseInt(document.getElementById('lg-batch-size')?.value) || 50;
        const interval = parseInt(document.getElementById('lg-interval')?.value) || 60;
        const uploadToHubSpot = document.getElementById('lg-hubspot')?.checked ?? true;

        try {
            await API.post('/api/v1/lead-generator/config', {
                leadsPerBatch: batchSize,
                batchInterval: interval * 1000,
                uploadToHubSpot
            });
            this.showToast('Konfiguration gespeichert!', 'success');
            this.closeModal();
            Modules.loadLeadGeneratorData();
        } catch (error) {
            this.showToast('Fehler: ' + error.message, 'error');
        }
    },

    async resetLeadGenStats() {
        try {
            await API.post('/api/v1/lead-generator/reset-stats');
            this.showToast('Statistiken zur√ºckgesetzt!', 'success');
            Modules.loadLeadGeneratorData();
        } catch (error) {
            this.showToast('Fehler: ' + error.message, 'error');
        }
    },

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // WORKFLOW MANAGEMENT FUNCTIONS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async createWorkflowModal() {
        const triggers = Modules.campaignState.triggers || {};
        const triggerSelect = DOM.el('select', { className: 'cyber-input', id: 'wf-trigger', style: { width: '100%' } });
        Object.entries(triggers).forEach(([key, t]) => {
            const opt = document.createElement('option');
            opt.value = key; opt.textContent = (t.icon || '‚ö°') + ' ' + (t.name || key);
            triggerSelect.appendChild(opt);
        });
        const form = DOM.el('div', {}, [
            DOM.el('div', { className: 'mb-2' }, [
                DOM.el('label', { style: { display: 'block', marginBottom: '0.5rem', color: 'var(--text-secondary)' } }, ['WORKFLOW NAME']),
                DOM.el('input', { type: 'text', className: 'cyber-input', id: 'wf-name', placeholder: 'Enter workflow name', style: { width: '100%' } })
            ]),
            DOM.el('div', { className: 'mb-2' }, [
                DOM.el('label', { style: { display: 'block', marginBottom: '0.5rem', color: 'var(--text-secondary)' } }, ['DESCRIPTION']),
                DOM.el('textarea', { className: 'cyber-input', id: 'wf-desc', placeholder: 'Describe what this workflow does', rows: 2, style: { width: '100%', resize: 'vertical' } })
            ]),
            DOM.el('div', { className: 'mb-2' }, [
                DOM.el('label', { style: { display: 'block', marginBottom: '0.5rem', color: 'var(--text-secondary)' } }, ['TRIGGER TYPE']),
                triggerSelect
            ]),
            DOM.el('div', { style: { padding: '0.8rem', background: 'rgba(0,255,247,0.05)', borderRadius: '8px', marginTop: '1rem' } }, [
                DOM.el('div', { style: { color: 'var(--neon-cyan)', fontSize: '0.8rem', marginBottom: '0.5rem' } }, ['üí° Actions k√∂nnen nach dem Erstellen hinzugef√ºgt werden'])
            ])
        ]);
        const footer = DOM.el('div', { className: 'flex gap-2' }, [
            DOM.el('button', { className: 'btn-nexus', onclick: () => this.closeModal() }, 'CANCEL'),
            DOM.el('button', { className: 'btn-nexus magenta', onclick: () => this.createWorkflow() }, 'CREATE WORKFLOW')
        ]);
        this.showModal('NEW WORKFLOW', form, footer);
    },

    async createWorkflow() {
        const name = document.getElementById('wf-name')?.value;
        const description = document.getElementById('wf-desc')?.value;
        const triggerType = document.getElementById('wf-trigger')?.value;
        if (!name) { alert('Please enter a workflow name'); return; }
        const result = await API.post('/api/v1/workflows', { name, description, triggerType, triggerConfig: {} });
        if (result) {
            this.closeModal();
            Modules.loadCampaignData();
        }
    },

    async editWorkflowModal(id) {
        const wf = await API.get('/api/v1/workflows/' + id);
        if (!wf) { alert('Workflow not found'); return; }
        const triggers = Modules.campaignState.triggers || {};
        const actions = Modules.campaignState.actions || {};
        const actionIcons = { send_email: 'üìß', send_whatsapp: 'üí¨', send_slack: 'üíº', create_task: '‚úÖ', update_deal: 'üíº', update_contact: 'üë§', add_tag: 'üè∑Ô∏è', enroll_sequence: 'üì®', trigger_workflow: '‚ö°', delay: '‚è≥', webhook_call: 'üîó', condition: 'üîÄ', create_invoice: 'üßæ', notify_team: 'üîî' };
        // Build trigger dropdown
        const triggerSelect = DOM.el('select', { className: 'cyber-input', id: 'wf-edit-trigger', style: { width: '100%' } });
        Object.entries(triggers).forEach(([key, t]) => {
            const opt = document.createElement('option');
            opt.value = key; opt.textContent = (t.icon || '‚ö°') + ' ' + (t.name || key);
            if (key === wf.triggerType) opt.selected = true;
            triggerSelect.appendChild(opt);
        });
        // Build action type dropdown for adding
        const actionSelect = DOM.el('select', { className: 'cyber-input', id: 'wf-add-action', style: { width: '100%' } });
        Object.entries(actions).forEach(([key, a]) => {
            const opt = document.createElement('option');
            opt.value = key; opt.textContent = (a.icon || '‚ñ∂') + ' ' + (a.name || key);
            actionSelect.appendChild(opt);
        });
        // Build existing actions list
        const actionsList = DOM.el('div', { id: 'wf-actions-list', style: { maxHeight: '200px', overflowY: 'auto' } });
        (wf.actions || []).forEach((action, idx) => {
            const aInfo = actions[action.type] || {};
            actionsList.appendChild(DOM.el('div', { style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '0.5rem', borderBottom: '1px solid var(--border-dim)' } }, [
                DOM.el('div', { style: { display: 'flex', alignItems: 'center', gap: '0.5rem' } }, [
                    DOM.el('span', { style: { color: 'var(--text-muted)' } }, [(idx + 1) + '.']),
                    DOM.el('span', {}, [actionIcons[action.type] || '‚ñ∂']),
                    DOM.el('span', { style: { color: 'var(--neon-cyan)' } }, [aInfo.name || action.type])
                ]),
                DOM.el('button', { className: 'btn-nexus magenta', style: { padding: '0.2rem 0.5rem', fontSize: '0.6rem' }, onclick: () => this.deleteWorkflowAction(id, action.id) }, '‚úï')
            ]));
        });
        if (!wf.actions?.length) {
            actionsList.appendChild(DOM.el('div', { style: { textAlign: 'center', color: 'var(--text-muted)', padding: '1rem' } }, ['No actions configured']));
        }
        const form = DOM.el('div', {}, [
            DOM.el('div', { className: 'mb-2' }, [
                DOM.el('label', { style: { display: 'block', marginBottom: '0.5rem', color: 'var(--text-secondary)' } }, ['WORKFLOW NAME']),
                DOM.el('input', { type: 'text', className: 'cyber-input', id: 'wf-edit-name', value: wf.name || '', style: { width: '100%' } })
            ]),
            DOM.el('div', { className: 'mb-2' }, [
                DOM.el('label', { style: { display: 'block', marginBottom: '0.5rem', color: 'var(--text-secondary)' } }, ['DESCRIPTION']),
                DOM.el('textarea', { className: 'cyber-input', id: 'wf-edit-desc', rows: 2, style: { width: '100%' } }, [wf.description || ''])
            ]),
            DOM.el('div', { className: 'mb-2' }, [
                DOM.el('label', { style: { display: 'block', marginBottom: '0.5rem', color: 'var(--text-secondary)' } }, ['TRIGGER']),
                triggerSelect
            ]),
            DOM.el('div', { className: 'mb-2', style: { marginTop: '1rem' } }, [
                DOM.el('label', { style: { display: 'block', marginBottom: '0.5rem', color: 'var(--text-secondary)' } }, ['ACTIONS (' + (wf.actions?.length || 0) + ')']),
                actionsList
            ]),
            DOM.el('div', { className: 'mb-2', style: { display: 'flex', gap: '0.5rem' } }, [
                actionSelect,
                DOM.el('button', { className: 'btn-nexus', onclick: () => this.addWorkflowAction(id) }, '+ ADD')
            ])
        ]);
        const footer = DOM.el('div', { className: 'flex gap-2' }, [
            DOM.el('button', { className: 'btn-nexus', onclick: () => this.closeModal() }, 'CANCEL'),
            DOM.el('button', { className: 'btn-nexus magenta', onclick: () => this.updateWorkflow(id) }, 'SAVE CHANGES')
        ]);
        this.showModal('EDIT WORKFLOW: ' + (wf.name || 'Unknown'), form, footer);
    },

    async updateWorkflow(id) {
        const name = document.getElementById('wf-edit-name')?.value;
        const description = document.getElementById('wf-edit-desc')?.value;
        const triggerType = document.getElementById('wf-edit-trigger')?.value;
        await API.patch('/api/v1/workflows/' + id, { name, description, triggerType });
        this.closeModal();
        Modules.loadCampaignData();
    },

    async addWorkflowAction(workflowId) {
        const actionType = document.getElementById('wf-add-action')?.value;
        if (!actionType) return;
        await API.post('/api/v1/workflows/' + workflowId + '/actions', { actionType, actionConfig: {} });
        this.editWorkflowModal(workflowId); // Reload modal
    },

    async deleteWorkflowAction(workflowId, actionId) {
        if (!confirm('Delete this action?')) return;
        await API.delete('/api/v1/workflows/' + workflowId + '/actions/' + actionId);
        this.editWorkflowModal(workflowId); // Reload modal
    },

    async executeWorkflow(id, name) {
        if (!confirm('Execute workflow "' + name + '" now?')) return;
        const result = await API.post('/api/v1/workflows/' + id + '/execute', { context: {} });
        if (result) {
            alert('Workflow executed! Status: ' + (result.status || 'completed'));
            Modules.loadCampaignData();
        }
    },

    async toggleWorkflow(id, active) {
        await API.patch('/api/v1/workflows/' + id, { isActive: active });
        Modules.loadCampaignData();
    },

    async deleteWorkflow(id, name) {
        if (!confirm('Delete workflow "' + name + '"? This cannot be undone.')) return;
        await API.delete('/api/v1/workflows/' + id);
        Modules.loadCampaignData();
    },

    showExecutionDetail(exec) {
        const results = exec.results || [];
        const content = DOM.el('div', {}, [
            DOM.el('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginBottom: '1rem' } }, [
                DOM.el('div', {}, [DOM.el('div', { style: { color: 'var(--text-muted)', fontSize: '0.75rem' } }, ['WORKFLOW']), DOM.el('div', { style: { color: 'var(--neon-cyan)' } }, [exec.workflowName || 'Unknown'])]),
                DOM.el('div', {}, [DOM.el('div', { style: { color: 'var(--text-muted)', fontSize: '0.75rem' } }, ['STATUS']), DOM.el('div', {}, [exec.status?.toUpperCase() || 'UNKNOWN'])]),
                DOM.el('div', {}, [DOM.el('div', { style: { color: 'var(--text-muted)', fontSize: '0.75rem' } }, ['STARTED']), DOM.el('div', {}, [new Date(exec.startedAt).toLocaleString('de-DE')])]),
                DOM.el('div', {}, [DOM.el('div', { style: { color: 'var(--text-muted)', fontSize: '0.75rem' } }, ['COMPLETED']), DOM.el('div', {}, [exec.completedAt ? new Date(exec.completedAt).toLocaleString('de-DE') : 'N/A'])])
            ]),
            DOM.el('div', { style: { color: 'var(--text-secondary)', marginBottom: '0.5rem' } }, ['ACTION RESULTS (' + results.length + ')']),
            DOM.el('div', { style: { maxHeight: '200px', overflowY: 'auto' } }, results.map((r, i) =>
                DOM.el('div', { style: { padding: '0.5rem', borderBottom: '1px solid var(--border-dim)' } }, [
                    DOM.el('span', { style: { color: 'var(--text-muted)' } }, [(i + 1) + '. ']),
                    DOM.el('span', { style: { color: r.status === 'success' ? 'var(--neon-green)' : 'var(--neon-magenta)' } }, [r.actionType + ': ' + r.status])
                ])
            )),
            exec.error ? DOM.el('div', { style: { marginTop: '1rem', padding: '0.5rem', background: 'rgba(255,0,128,0.1)', borderRadius: '4px', color: 'var(--neon-magenta)' } }, ['Error: ' + exec.error]) : document.createTextNode('')
        ]);
        this.showModal('EXECUTION DETAILS', content, DOM.el('button', { className: 'btn-nexus', onclick: () => this.closeModal() }, 'CLOSE'));
    },

    launchCampaign(campaignId) {
        alert('Campaign "' + campaignId + '" launch will be implemented.\nFor now, use the Campaign Dashboard at /kampagnen');
        window.open('/kampagnen', '_blank');
    },

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // INVOICE FUNCTIONS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    viewInvoice(inv) {
        const statusColors = { paid: 'green', pending: 'yellow', sent: 'cyan', overdue: 'magenta', draft: '' };
        const statusIcons = { paid: '‚úÖ', pending: '‚è≥', sent: 'üìß', overdue: '‚ö†Ô∏è', draft: 'üìù' };
        const lineItems = inv.line_items || [{ description: inv.customer_name, quantity: 1, unit_price: inv.amount, total: inv.amount }];

        const content = DOM.el('div', { style: { maxHeight: '60vh', overflowY: 'auto' } }, [
            // Header Section
            DOM.el('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '1.5rem', paddingBottom: '1rem', borderBottom: '1px solid var(--border-dim)' } }, [
                DOM.el('div', {}, [
                    DOM.el('div', { style: { fontSize: '1.5rem', fontFamily: 'Orbitron', color: 'var(--neon-cyan)' } }, [inv.invoice_number || 'INV-' + inv.id]),
                    DOM.el('div', { style: { color: 'var(--text-muted)', marginTop: '0.25rem' } }, ['Erstellt: ' + new Date(inv.created_date || Date.now()).toLocaleDateString('de-DE')])
                ]),
                DOM.el('span', { className: 'cyber-badge ' + (statusColors[inv.status] || ''), style: { fontSize: '0.9rem', padding: '0.5rem 1rem' } }, [
                    (statusIcons[inv.status] || '') + ' ' + (inv.status?.toUpperCase() || 'DRAFT')
                ])
            ]),

            // Customer Info
            DOM.el('div', { style: { background: 'rgba(0,255,247,0.03)', borderRadius: '8px', padding: '1rem', marginBottom: '1rem' } }, [
                DOM.el('div', { style: { color: 'var(--text-muted)', fontSize: '0.75rem', marginBottom: '0.5rem' } }, ['KUNDE']),
                DOM.el('div', { style: { fontSize: '1.1rem', fontWeight: 'bold', color: 'var(--text-primary)' } }, [escapeHtml(inv.customer_name || 'Unbekannt')]),
                inv.customer_email ? DOM.el('div', { style: { color: 'var(--neon-cyan)', marginTop: '0.25rem' } }, ['üìß ' + escapeHtml(inv.customer_email)]) : document.createTextNode(''),
                DOM.el('div', { style: { color: 'var(--text-muted)', marginTop: '0.5rem', fontSize: '0.85rem' } }, [
                    inv.has_email ? '‚úÖ Email verf√ºgbar' : '‚ö†Ô∏è Keine Email hinterlegt'
                ])
            ]),

            // Line Items Table
            DOM.el('div', { style: { marginBottom: '1rem' } }, [
                DOM.el('div', { style: { color: 'var(--text-muted)', fontSize: '0.75rem', marginBottom: '0.5rem' } }, ['POSITIONEN']),
                DOM.el('table', { style: { width: '100%', borderCollapse: 'collapse' } }, [
                    DOM.el('thead', {}, [
                        DOM.el('tr', { style: { borderBottom: '1px solid var(--border-dim)' } }, [
                            DOM.el('th', { style: { textAlign: 'left', padding: '0.5rem', color: 'var(--text-muted)', fontSize: '0.75rem' } }, ['BESCHREIBUNG']),
                            DOM.el('th', { style: { textAlign: 'center', padding: '0.5rem', color: 'var(--text-muted)', fontSize: '0.75rem' } }, ['MENGE']),
                            DOM.el('th', { style: { textAlign: 'right', padding: '0.5rem', color: 'var(--text-muted)', fontSize: '0.75rem' } }, ['PREIS']),
                            DOM.el('th', { style: { textAlign: 'right', padding: '0.5rem', color: 'var(--text-muted)', fontSize: '0.75rem' } }, ['GESAMT'])
                        ])
                    ]),
                    DOM.el('tbody', {}, lineItems.map(item =>
                        DOM.el('tr', { style: { borderBottom: '1px solid var(--border-dim)' } }, [
                            DOM.el('td', { style: { padding: '0.5rem' } }, [escapeHtml(item.description || '-')]),
                            DOM.el('td', { style: { textAlign: 'center', padding: '0.5rem' } }, [String(item.quantity || 1)]),
                            DOM.el('td', { style: { textAlign: 'right', padding: '0.5rem', fontFamily: 'monospace' } }, [formatCurrency(item.unit_price || 0)]),
                            DOM.el('td', { style: { textAlign: 'right', padding: '0.5rem', fontFamily: 'monospace', fontWeight: 'bold' } }, [formatCurrency(item.total || 0)])
                        ])
                    ))
                ])
            ]),

            // Total
            DOM.el('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '1rem', background: 'rgba(0,255,247,0.05)', borderRadius: '8px', marginBottom: '1rem' } }, [
                DOM.el('span', { style: { fontSize: '1.1rem', color: 'var(--text-muted)' } }, ['GESAMTSUMME']),
                DOM.el('span', { style: { fontSize: '1.5rem', fontFamily: 'Orbitron', fontWeight: 'bold', color: 'var(--neon-green)' } }, [formatCurrency(inv.amount || 0)])
            ]),

            // Due Date & Score
            DOM.el('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' } }, [
                DOM.el('div', { style: { background: 'rgba(255,255,255,0.02)', padding: '0.75rem', borderRadius: '8px' } }, [
                    DOM.el('div', { style: { color: 'var(--text-muted)', fontSize: '0.75rem' } }, ['F√ÑLLIGKEITSDATUM']),
                    DOM.el('div', { style: { color: inv.status === 'overdue' ? 'var(--neon-magenta)' : 'var(--text-primary)' } }, [
                        inv.due_date ? new Date(inv.due_date).toLocaleDateString('de-DE') : 'Nicht festgelegt'
                    ])
                ]),
                DOM.el('div', { style: { background: 'rgba(255,255,255,0.02)', padding: '0.75rem', borderRadius: '8px' } }, [
                    DOM.el('div', { style: { color: 'var(--text-muted)', fontSize: '0.75rem' } }, ['SCORE']),
                    DOM.el('div', { style: { fontFamily: 'Orbitron', color: inv.score >= 50 ? 'var(--neon-green)' : 'var(--neon-yellow)' } }, [
                        (inv.score || 0) + '/100'
                    ])
                ])
            ])
        ]);

        const footer = DOM.el('div', { className: 'flex gap-2', style: { justifyContent: 'space-between' } }, [
            DOM.el('button', { className: 'btn-nexus', onclick: () => this.closeModal() }, 'SCHLIESSEN'),
            DOM.el('div', { className: 'flex gap-2' }, [
                inv.status !== 'paid' && inv.has_email ? DOM.el('button', { className: 'btn-nexus cyan', onclick: () => { this.closeModal(); this.sendInvoice(inv.id || inv.hubspot_deal_id); } }, 'üìß SENDEN') : document.createTextNode(''),
                inv.status !== 'paid' ? DOM.el('button', { className: 'btn-nexus green', onclick: () => { this.closeModal(); this.markInvoicePaid(inv.id || inv.hubspot_deal_id); } }, '‚úì ALS BEZAHLT MARKIEREN') : document.createTextNode('')
            ])
        ]);

        this.showModal('RECHNUNG DETAILS', content, footer);
    },

    async sendInvoice(invoiceId) {
        if (!confirm('Rechnung per Email an den Kunden senden?')) return;
        try {
            const result = await API.post('/api/v1/invoices/' + invoiceId + '/send', {});
            if (result && !result.error) {
                alert('‚úÖ Rechnung erfolgreich gesendet!');
                Modules.loadInvoiceData();
            } else {
                alert('‚ùå Fehler: ' + (result?.error || 'Unbekannter Fehler'));
            }
        } catch (e) {
            alert('‚ùå Fehler beim Senden: ' + e.message);
        }
    },

    async markInvoicePaid(invoiceId) {
        if (!confirm('Rechnung als bezahlt markieren?')) return;
        try {
            const result = await API.post('/api/v1/invoices/' + invoiceId + '/mark-paid', {});
            if (result && !result.error) {
                alert('‚úÖ Rechnung als bezahlt markiert!');
                Modules.loadInvoiceData();
            } else {
                alert('‚ùå Fehler: ' + (result?.error || 'Unbekannter Fehler'));
            }
        } catch (e) {
            alert('‚ùå Fehler: ' + e.message);
        }
    },

    createInvoice() {
        const form = DOM.el('div', {}, [
            DOM.el('div', { className: 'mb-2' }, [
                DOM.el('label', { style: { display: 'block', marginBottom: '0.5rem', color: 'var(--text-secondary)' } }, ['KUNDE']),
                DOM.el('input', { type: 'text', className: 'cyber-input', id: 'inv-customer', placeholder: 'Kundenname eingeben', style: { width: '100%' } })
            ]),
            DOM.el('div', { className: 'mb-2' }, [
                DOM.el('label', { style: { display: 'block', marginBottom: '0.5rem', color: 'var(--text-secondary)' } }, ['EMAIL']),
                DOM.el('input', { type: 'email', className: 'cyber-input', id: 'inv-email', placeholder: 'kunde@email.de', style: { width: '100%' } })
            ]),
            DOM.el('div', { className: 'mb-2' }, [
                DOM.el('label', { style: { display: 'block', marginBottom: '0.5rem', color: 'var(--text-secondary)' } }, ['BESCHREIBUNG']),
                DOM.el('textarea', { className: 'cyber-input', id: 'inv-description', placeholder: 'Leistungsbeschreibung', rows: 2, style: { width: '100%', resize: 'vertical' } })
            ]),
            DOM.el('div', { className: 'mb-2' }, [
                DOM.el('label', { style: { display: 'block', marginBottom: '0.5rem', color: 'var(--text-secondary)' } }, ['BETRAG (‚Ç¨)']),
                DOM.el('input', { type: 'number', className: 'cyber-input', id: 'inv-amount', placeholder: '0.00', style: { width: '100%' } })
            ]),
            DOM.el('div', { className: 'mb-2' }, [
                DOM.el('label', { style: { display: 'block', marginBottom: '0.5rem', color: 'var(--text-secondary)' } }, ['F√ÑLLIGKEITSDATUM']),
                DOM.el('input', { type: 'date', className: 'cyber-input', id: 'inv-duedate', style: { width: '100%' } })
            ])
        ]);

        const footer = DOM.el('div', { className: 'flex gap-2' }, [
            DOM.el('button', { className: 'btn-nexus', onclick: () => this.closeModal() }, 'ABBRECHEN'),
            DOM.el('button', { className: 'btn-nexus green', onclick: () => this.submitCreateInvoice() }, 'RECHNUNG ERSTELLEN')
        ]);

        this.showModal('NEUE RECHNUNG', form, footer);
    },

    async submitCreateInvoice() {
        const customer = document.getElementById('inv-customer')?.value;
        const email = document.getElementById('inv-email')?.value;
        const description = document.getElementById('inv-description')?.value;
        const amount = parseFloat(document.getElementById('inv-amount')?.value) || 0;
        const dueDate = document.getElementById('inv-duedate')?.value;

        if (!customer || !amount) {
            alert('Bitte Kunde und Betrag eingeben');
            return;
        }

        try {
            const result = await API.post('/api/v1/invoices/create', {
                customerName: customer,
                customerEmail: email,
                description: description,
                amount: amount,
                dueDate: dueDate
            });
            if (result && !result.error) {
                alert('‚úÖ Rechnung erfolgreich erstellt!');
                this.closeModal();
                Modules.loadInvoiceData();
            } else {
                alert('‚ùå Fehler: ' + (result?.error || result?.message || 'Unbekannter Fehler'));
            }
        } catch (e) {
            alert('‚ùå Fehler: ' + e.message);
        }
    },

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CASHFLOW TRANSACTION FUNCTIONS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    addTransactionModal(type = 'expense') {
        const isExpense = type === 'expense';
        const categories = isExpense
            ? ['Software & Tools', 'Marketing', 'Personal', 'B√ºro & Ausstattung', 'Reisekosten', 'Beratung', 'Steuern', 'Sonstiges']
            : ['Projekteinnahmen', 'Beratung', 'Lizenzgeb√ºhren', 'Provisionen', 'Sonstiges'];

        const categorySelect = DOM.el('select', { className: 'cyber-input', id: 'trans-category', style: { width: '100%' } });
        categories.forEach(cat => categorySelect.appendChild(DOM.el('option', { value: cat }, [cat])));

        const form = DOM.el('div', {}, [
            DOM.el('div', { style: { display: 'flex', gap: '1rem', marginBottom: '1rem' } }, [
                DOM.el('button', {
                    className: 'btn-nexus ' + (!isExpense ? 'green' : ''),
                    style: { flex: 1 },
                    onclick: () => { this.closeModal(); this.addTransactionModal('income'); }
                }, ['üìà EINNAHME']),
                DOM.el('button', {
                    className: 'btn-nexus ' + (isExpense ? 'magenta' : ''),
                    style: { flex: 1 },
                    onclick: () => { this.closeModal(); this.addTransactionModal('expense'); }
                }, ['üìâ AUSGABE'])
            ]),
            DOM.el('div', { className: 'mb-2' }, [
                DOM.el('label', { style: { display: 'block', marginBottom: '0.5rem', color: 'var(--text-secondary)' } }, ['BESCHREIBUNG']),
                DOM.el('input', { type: 'text', className: 'cyber-input', id: 'trans-desc', placeholder: isExpense ? 'z.B. Adobe Creative Cloud' : 'z.B. Projekt Alpha Abschluss', style: { width: '100%' } })
            ]),
            DOM.el('div', { className: 'mb-2' }, [
                DOM.el('label', { style: { display: 'block', marginBottom: '0.5rem', color: 'var(--text-secondary)' } }, ['KATEGORIE']),
                categorySelect
            ]),
            DOM.el('div', { className: 'mb-2' }, [
                DOM.el('label', { style: { display: 'block', marginBottom: '0.5rem', color: 'var(--text-secondary)' } }, ['BETRAG (‚Ç¨)']),
                DOM.el('input', { type: 'number', className: 'cyber-input', id: 'trans-amount', placeholder: '0.00', step: '0.01', style: { width: '100%' } })
            ]),
            DOM.el('div', { className: 'mb-2' }, [
                DOM.el('label', { style: { display: 'block', marginBottom: '0.5rem', color: 'var(--text-secondary)' } }, ['DATUM']),
                DOM.el('input', { type: 'date', className: 'cyber-input', id: 'trans-date', value: new Date().toISOString().split('T')[0], style: { width: '100%' } })
            ]),
            DOM.el('input', { type: 'hidden', id: 'trans-type', value: type })
        ]);

        const footer = DOM.el('div', { className: 'flex gap-2' }, [
            DOM.el('button', { className: 'btn-nexus', onclick: () => this.closeModal() }, 'ABBRECHEN'),
            DOM.el('button', { className: 'btn-nexus ' + (isExpense ? 'magenta' : 'green'), onclick: () => this.saveTransaction() }, isExpense ? 'üí∏ AUSGABE SPEICHERN' : 'üí∞ EINNAHME SPEICHERN')
        ]);

        this.showModal(isExpense ? 'NEUE AUSGABE' : 'NEUE EINNAHME', form, footer);
    },

    saveTransaction() {
        const description = document.getElementById('trans-desc')?.value;
        const category = document.getElementById('trans-category')?.value;
        const amount = parseFloat(document.getElementById('trans-amount')?.value) || 0;
        const date = document.getElementById('trans-date')?.value;
        const type = document.getElementById('trans-type')?.value || 'expense';

        if (!description || !amount) {
            alert('Bitte Beschreibung und Betrag eingeben');
            return;
        }

        // Load existing expenses
        const expenses = JSON.parse(localStorage.getItem('cashflow_expenses') || '[]');

        // Add new transaction
        expenses.push({
            id: 'local-' + Date.now(),
            type: type,
            category: category,
            description: description,
            amount: type === 'expense' ? -Math.abs(amount) : Math.abs(amount),
            date: date || new Date().toISOString().split('T')[0],
            source: 'manual'
        });

        // Save back to localStorage
        localStorage.setItem('cashflow_expenses', JSON.stringify(expenses));

        this.closeModal();
        alert('‚úÖ ' + (type === 'expense' ? 'Ausgabe' : 'Einnahme') + ' gespeichert!');

        // Refresh cashflow if on that page
        if (window.location.hash.includes('cashflow')) {
            Modules.loadCashflowData(Modules.cashflowState.period);
        }
    },

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // EMAIL SYNC DAEMON FUNCTIONS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async toggleEmailSync() {
        const result = await API.post('/api/v1/email-sync/toggle', {});
        if (result) {
            alert(result.enabled ? '‚úÖ Email Sync Daemon aktiviert' : '‚è∏ Email Sync Daemon pausiert');
            Modules.loadInvoiceData();
        }
    },

    async runEmailSyncNow() {
        const result = await API.post('/api/v1/email-sync/run', {});
        if (result) {
            alert('üöÄ Email Sync gestartet! Die Queue wird jetzt abgearbeitet.');
            setTimeout(() => Modules.loadInvoiceData(), 3000);
        }
    },

    async queueMissingEmails() {
        if (!confirm('Alle Invoices ohne Email zur Queue hinzuf√ºgen?\n\nDies kann einige Zeit dauern.')) return;
        const result = await API.post('/api/v1/email-sync/queue-missing', {});
        if (result) {
            alert(`‚úÖ ${result.queued} Invoices zur Queue hinzugef√ºgt\n\nGesamte Queue: ${result.total_queue}`);
            Modules.loadInvoiceData();
        }
    },

    async showEmailSyncStatus() {
        const status = await API.get('/api/v1/email-sync/status');
        if (!status) {
            alert('‚ùå Email Sync Status konnte nicht geladen werden');
            return;
        }

        const queue = status.queue || [];
        const queueContent = queue.length > 0
            ? DOM.el('div', { style: { maxHeight: '300px', overflowY: 'auto' } }, queue.map(item =>
                DOM.el('div', { style: { display: 'flex', justifyContent: 'space-between', padding: '0.5rem', borderBottom: '1px solid var(--border-dim)' } }, [
                    DOM.el('div', {}, [
                        DOM.el('div', { style: { fontWeight: 'bold' } }, [escapeHtml(item.dealName?.substring(0, 40) || 'Deal') + '...']),
                        DOM.el('div', { style: { fontSize: '0.75rem', color: 'var(--text-muted)' } }, [
                            `Betrag: ${formatCurrency(item.amount || 0)} ‚Ä¢ Versuche: ${item.attempts}/${item.maxAttempts}`
                        ])
                    ]),
                    DOM.el('span', { className: 'cyber-badge ' + (item.status === 'pending' ? 'yellow' : item.status === 'email_found' ? 'green' : '') }, [
                        item.status?.toUpperCase() || 'PENDING'
                    ])
                ])
            ))
            : DOM.el('div', { style: { textAlign: 'center', color: 'var(--text-muted)', padding: '2rem' } }, ['‚úÖ Queue ist leer']);

        const content = DOM.el('div', {}, [
            // Status Overview
            DOM.el('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginBottom: '1.5rem' } }, [
                DOM.el('div', { style: { background: 'rgba(0,255,247,0.05)', padding: '1rem', borderRadius: '8px' } }, [
                    DOM.el('div', { style: { color: 'var(--text-muted)', fontSize: '0.75rem' } }, ['STATUS']),
                    DOM.el('div', { style: { fontSize: '1.2rem', color: status.enabled ? 'var(--neon-green)' : 'var(--neon-magenta)' } }, [
                        status.enabled ? 'üü¢ AKTIV' : 'üî¥ PAUSIERT'
                    ])
                ]),
                DOM.el('div', { style: { background: 'rgba(0,255,247,0.05)', padding: '1rem', borderRadius: '8px' } }, [
                    DOM.el('div', { style: { color: 'var(--text-muted)', fontSize: '0.75rem' } }, ['QUEUE GR√ñSSE']),
                    DOM.el('div', { style: { fontSize: '1.2rem', fontFamily: 'Orbitron', color: 'var(--neon-cyan)' } }, [String(status.queue_size)])
                ]),
                DOM.el('div', { style: { background: 'rgba(0,255,247,0.05)', padding: '1rem', borderRadius: '8px' } }, [
                    DOM.el('div', { style: { color: 'var(--text-muted)', fontSize: '0.75rem' } }, ['EMAILS GEFUNDEN']),
                    DOM.el('div', { style: { fontSize: '1.2rem', fontFamily: 'Orbitron', color: 'var(--neon-green)' } }, [String(status.stats?.synced || 0)])
                ]),
                DOM.el('div', { style: { background: 'rgba(0,255,247,0.05)', padding: '1rem', borderRadius: '8px' } }, [
                    DOM.el('div', { style: { color: 'var(--text-muted)', fontSize: '0.75rem' } }, ['INVOICES GESENDET']),
                    DOM.el('div', { style: { fontSize: '1.2rem', fontFamily: 'Orbitron', color: 'var(--neon-cyan)' } }, [String(status.stats?.sent || 0)])
                ])
            ]),

            // Timing Info
            DOM.el('div', { style: { marginBottom: '1rem', fontSize: '0.85rem', color: 'var(--text-muted)' } }, [
                status.last_run ? `Letzter Lauf: ${new Date(status.last_run).toLocaleString('de-DE')}` : 'Noch nicht gelaufen',
                DOM.el('br'),
                `N√§chster Lauf: ${new Date(status.next_run).toLocaleString('de-DE')}`,
                DOM.el('br'),
                `Intervall: alle ${status.interval_minutes} Minuten`
            ]),

            // Queue Header
            DOM.el('div', { style: { color: 'var(--text-secondary)', marginBottom: '0.5rem', fontWeight: 'bold' } }, ['üìã QUEUE (' + queue.length + ' Eintr√§ge)']),
            queueContent
        ]);

        const footer = DOM.el('div', { className: 'flex gap-2', style: { justifyContent: 'space-between' } }, [
            DOM.el('button', { className: 'btn-nexus', onclick: () => this.closeModal() }, 'SCHLIESSEN'),
            DOM.el('div', { className: 'flex gap-2' }, [
                DOM.el('button', { className: 'btn-nexus ' + (status.enabled ? 'magenta' : 'green'), onclick: async () => { await this.toggleEmailSync(); this.closeModal(); this.showEmailSyncStatus(); } }, [
                    status.enabled ? '‚è∏ PAUSIEREN' : '‚ñ∂ AKTIVIEREN'
                ]),
                DOM.el('button', { className: 'btn-nexus cyan', onclick: () => { this.closeModal(); this.runEmailSyncNow(); } }, 'üöÄ JETZT AUSF√úHREN')
            ])
        ]);

        this.showModal('EMAIL SYNC DAEMON', content, footer);
    }
};

document.addEventListener('DOMContentLoaded', () => NexusApp.init());
document.addEventListener('keydown', (e) => { if (e.ctrlKey && e.key === 'k') { e.preventDefault(); document.getElementById('search-trigger')?.click(); } if (e.key === 'Escape') NexusApp.closeModal(); });
    </script>
</body>
</html>
