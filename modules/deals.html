<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deals Pipeline | Enterprise Universe 5.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --god-gold: #FFD700;
            --bg-void: #030308;
            --success-green: #22c55e;
            --warning-amber: #f59e0b;
            --hot-red: #ef4444;
            --ui-blue: #7B9FFF;
            --ui-purple: #9B7BFF;
            --ui-silver: #C0C0E0;
            --auto-cyan: #00F5FF;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Rajdhani', sans-serif; background: var(--bg-void); color: #fff; min-height: 100vh; }

        .header {
            background: linear-gradient(135deg, rgba(0, 245, 255, 0.1), rgba(155, 123, 255, 0.1));
            border-bottom: 2px solid var(--auto-cyan);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { font-family: 'Orbitron', sans-serif; font-size: 1.5rem; color: var(--auto-cyan); }
        .back-btn {
            padding: 0.5rem 1rem;
            background: rgba(0, 245, 255, 0.1);
            border: 1px solid var(--auto-cyan);
            border-radius: 8px;
            color: var(--auto-cyan);
            text-decoration: none;
        }
        .auto-badge {
            background: linear-gradient(135deg, var(--auto-cyan), var(--ui-purple));
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: bold;
            color: #000;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .main { max-width: 1800px; margin: 0 auto; padding: 1.5rem; }

        .auto-status {
            background: linear-gradient(135deg, rgba(0, 245, 255, 0.1), rgba(155, 123, 255, 0.05));
            border: 1px solid var(--auto-cyan);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .auto-status-left { display: flex; align-items: center; gap: 1rem; }
        .auto-icon { font-size: 2rem; }
        .auto-info h3 { color: var(--auto-cyan); font-size: 1rem; }
        .auto-info p { color: var(--ui-silver); font-size: 0.8rem; }
        .auto-actions { display: flex; gap: 0.5rem; }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .stat-box {
            background: rgba(10, 10, 26, 0.9);
            border: 1px solid rgba(0, 245, 255, 0.2);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
        }
        .stat-value { font-family: 'Orbitron', sans-serif; font-size: 1.5rem; font-weight: bold; color: var(--auto-cyan); }
        .stat-label { font-size: 0.75rem; color: var(--ui-silver); }

        .actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        .action-btn {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, var(--auto-cyan), var(--ui-blue));
            border: none;
            border-radius: 8px;
            color: #000;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .action-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 245, 255, 0.3); }
        .action-btn.secondary { background: linear-gradient(135deg, var(--ui-purple), var(--ui-blue)); color: #fff; }
        .action-btn.success { background: linear-gradient(135deg, var(--success-green), #16a34a); color: #fff; }

        .pipeline {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 1rem;
            min-height: 500px;
        }
        .stage {
            background: rgba(10, 10, 26, 0.9);
            border: 1px solid rgba(0, 245, 255, 0.2);
            border-radius: 12px;
            padding: 1rem;
            min-height: 400px;
        }
        .stage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid rgba(0, 245, 255, 0.3);
        }
        .stage-title { font-family: 'Orbitron', sans-serif; font-size: 0.8rem; color: var(--auto-cyan); }
        .stage-count {
            background: rgba(0, 245, 255, 0.2);
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.7rem;
        }
        .stage-value { font-size: 0.7rem; color: var(--success-green); margin-top: 0.25rem; }

        .deals-list { display: flex; flex-direction: column; gap: 0.5rem; }

        .deal-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 0.75rem;
            transition: all 0.3s;
        }
        .deal-card:hover {
            border-color: var(--auto-cyan);
            transform: translateY(-2px);
        }
        .deal-card.auto-moving {
            border-color: var(--auto-cyan);
            animation: autoMove 1.5s ease-in-out infinite;
        }
        @keyframes autoMove {
            0%, 100% { box-shadow: 0 0 5px rgba(0, 245, 255, 0.3); }
            50% { box-shadow: 0 0 15px rgba(0, 245, 255, 0.6); }
        }

        .deal-name { font-weight: bold; font-size: 0.85rem; margin-bottom: 0.25rem; }
        .deal-company { font-size: 0.75rem; color: var(--ui-silver); }
        .deal-amount { font-family: 'Orbitron', sans-serif; font-size: 0.9rem; color: var(--success-green); margin-top: 0.5rem; }
        .deal-meta { display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem; }
        .deal-days { font-size: 0.65rem; color: var(--warning-amber); }
        .deal-auto-badge {
            font-size: 0.6rem;
            background: rgba(0, 245, 255, 0.2);
            padding: 0.1rem 0.4rem;
            border-radius: 8px;
            color: var(--auto-cyan);
        }

        .pending-moves {
            background: rgba(10, 10, 26, 0.9);
            border: 1px solid rgba(0, 245, 255, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }
        .pending-moves h3 { font-family: 'Orbitron', sans-serif; color: var(--auto-cyan); margin-bottom: 1rem; }
        .pending-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 0.75rem; }
        .pending-item {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 245, 255, 0.1);
            border-radius: 8px;
            padding: 0.75rem;
        }
        .pending-item-header { display: flex; justify-content: space-between; align-items: center; }
        .pending-item-name { font-weight: bold; font-size: 0.8rem; }
        .pending-item-countdown {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.7rem;
            color: var(--warning-amber);
        }
        .pending-item-info { font-size: 0.7rem; color: var(--ui-silver); margin-top: 0.25rem; }

        .toast { position: fixed; bottom: 20px; right: 20px; background: var(--auto-cyan); color: #000; padding: 1rem 1.5rem; border-radius: 8px; display: none; z-index: 1001; font-weight: bold; }

        @media (max-width: 1200px) { .pipeline { grid-template-columns: repeat(3, 1fr); } .stats-row { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 768px) { .pipeline { grid-template-columns: 1fr; } .stats-row { grid-template-columns: repeat(2, 1fr); } }
    </style>
</head>
<body>
    <header class="header">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <h1>ü§ñ DEALS PIPELINE - AUTO MODE</h1>
            <span class="auto-badge">‚ö° AUTOMATISCH</span>
        </div>
        <a href="/v5" class="back-btn">‚Üê Back to Dashboard</a>
    </header>

    <main class="main">
        <div class="auto-status">
            <div class="auto-status-left">
                <span class="auto-icon">ü§ñ</span>
                <div class="auto-info">
                    <h3>Auto Lead Mover AKTIV</h3>
                    <p>Deals werden automatisch durch die Pipeline bewegt ‚Ä¢ N√§chster Run: <span id="nextRun">--</span></p>
                </div>
            </div>
            <div class="auto-actions">
                <button class="action-btn" onclick="runAutoMove(false)">‚ñ∂Ô∏è Jetzt ausf√ºhren</button>
                <button class="action-btn secondary" onclick="runAutoMove(true)">üëÅÔ∏è Simulation</button>
            </div>
        </div>

        <div class="stats-row">
            <div class="stat-box">
                <div class="stat-value" id="totalDeals">0</div>
                <div class="stat-label">TOTAL DEALS</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="totalValue">‚Ç¨0</div>
                <div class="stat-label">PIPELINE VALUE</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="pendingMoves">0</div>
                <div class="stat-label">PENDING MOVES</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="movedToday">0</div>
                <div class="stat-label">MOVED TODAY</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="wonValue">‚Ç¨0</div>
                <div class="stat-label">WON DEALS</div>
            </div>
        </div>

        <div class="actions">
            <button class="action-btn success" onclick="syncFromHubSpot()">üì• Sync from HubSpot</button>
            <button class="action-btn secondary" onclick="refreshAll()">üîÑ Refresh</button>
            <button class="action-btn secondary" onclick="openCreateModal()">‚ûï Neuer Deal</button>
        </div>

        <div class="pipeline" id="pipeline">
            <div class="stage" data-stage="lead">
                <div class="stage-header">
                    <div>
                        <div class="stage-title">üì• LEAD</div>
                        <div class="stage-value" id="leadValue">‚Ç¨0</div>
                    </div>
                    <span class="stage-count" id="leadCount">0</span>
                </div>
                <div class="deals-list" id="lead-deals"></div>
            </div>
            <div class="stage" data-stage="qualified">
                <div class="stage-header">
                    <div>
                        <div class="stage-title">‚úÖ QUALIFIED</div>
                        <div class="stage-value" id="qualifiedValue">‚Ç¨0</div>
                    </div>
                    <span class="stage-count" id="qualifiedCount">0</span>
                </div>
                <div class="deals-list" id="qualified-deals"></div>
            </div>
            <div class="stage" data-stage="proposal">
                <div class="stage-header">
                    <div>
                        <div class="stage-title">üìÑ PROPOSAL</div>
                        <div class="stage-value" id="proposalValue">‚Ç¨0</div>
                    </div>
                    <span class="stage-count" id="proposalCount">0</span>
                </div>
                <div class="deals-list" id="proposal-deals"></div>
            </div>
            <div class="stage" data-stage="negotiation">
                <div class="stage-header">
                    <div>
                        <div class="stage-title">ü§ù NEGOTIATION</div>
                        <div class="stage-value" id="negotiationValue">‚Ç¨0</div>
                    </div>
                    <span class="stage-count" id="negotiationCount">0</span>
                </div>
                <div class="deals-list" id="negotiation-deals"></div>
            </div>
            <div class="stage" data-stage="won">
                <div class="stage-header">
                    <div>
                        <div class="stage-title">üèÜ WON</div>
                        <div class="stage-value" id="wonStageValue">‚Ç¨0</div>
                    </div>
                    <span class="stage-count" id="wonCount">0</span>
                </div>
                <div class="deals-list" id="won-deals"></div>
            </div>
            <div class="stage" data-stage="lost">
                <div class="stage-header">
                    <div>
                        <div class="stage-title">‚ùå LOST</div>
                        <div class="stage-value" id="lostValue">‚Ç¨0</div>
                    </div>
                    <span class="stage-count" id="lostCount">0</span>
                </div>
                <div class="deals-list" id="lost-deals"></div>
            </div>
        </div>

        <div class="pending-moves">
            <h3>‚è≥ Anstehende Auto-Moves</h3>
            <div class="pending-list" id="pendingList"></div>
        </div>
    </main>

    <div class="toast" id="toast"></div>

    <script>
        const API_BASE = '/api/v1';
        let allDeals = [];
        let autoMoveStatus = null;

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 3000);
        }

        function formatCurrency(num) {
            if (num >= 1000000) return '‚Ç¨' + (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return '‚Ç¨' + (num / 1000).toFixed(0) + 'K';
            return '‚Ç¨' + num.toLocaleString();
        }

        async function fetchDeals() {
            try {
                const res = await fetch(`${API_BASE}/deals?per_page=500`);
                if (res.ok) {
                    const data = await res.json();
                    allDeals = data.deals || [];
                    renderPipeline();
                }
            } catch (e) { console.error('Failed to fetch deals'); }
        }

        async function fetchSummary() {
            try {
                const res = await fetch(`${API_BASE}/deals/summary`);
                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('totalDeals').textContent = data.total_deals || 0;
                    document.getElementById('totalValue').textContent = formatCurrency(data.total_value || 0);
                    document.getElementById('wonValue').textContent = formatCurrency(data.won_value || 0);

                    (data.by_stage || []).forEach(s => {
                        const el = document.getElementById(`${s.stage}Value`);
                        if (el) el.textContent = formatCurrency(s.total_value || 0);
                        const countEl = document.getElementById(`${s.stage}Count`);
                        if (countEl) countEl.textContent = s.count || 0;
                    });
                }
            } catch (e) { console.error('Failed to fetch summary'); }
        }

        async function fetchAutoMoveStatus() {
            try {
                const res = await fetch(`${API_BASE}/deals/auto-move/status`);
                if (res.ok) {
                    autoMoveStatus = await res.json();
                    document.getElementById('pendingMoves').textContent = autoMoveStatus.total_pending || 0;
                    renderPendingMoves();
                }
            } catch (e) { console.error('Failed to fetch auto-move status'); }
        }

        function renderPipeline() {
            const stages = ['lead', 'qualified', 'proposal', 'negotiation', 'won', 'lost'];
            const thresholds = { lead: 2, qualified: 3, proposal: 5 };

            stages.forEach(stage => {
                const container = document.getElementById(`${stage}-deals`);
                const stageDeals = allDeals.filter(d => d.stage === stage);

                container.innerHTML = stageDeals.map(deal => {
                    const daysInStage = deal.created_at ? Math.floor((Date.now() - new Date(deal.created_at)) / 86400000) : 0;
                    const threshold = thresholds[stage] || 999;
                    const isAutoMoving = daysInStage >= threshold && stage !== 'won' && stage !== 'lost' && stage !== 'negotiation';

                    return `
                        <div class="deal-card ${isAutoMoving ? 'auto-moving' : ''}" data-id="${deal.id}">
                            <div class="deal-name">${deal.name}</div>
                            <div class="deal-company">${deal.company_name || 'Keine Firma'}</div>
                            <div class="deal-amount">${formatCurrency(deal.amount || 0)}</div>
                            <div class="deal-meta">
                                <span class="deal-days">${daysInStage}d in Stage</span>
                                ${isAutoMoving ? '<span class="deal-auto-badge">‚ö° AUTO</span>' : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            });
        }

        function renderPendingMoves() {
            if (!autoMoveStatus || !autoMoveStatus.pending_moves) return;

            const container = document.getElementById('pendingList');
            const moves = autoMoveStatus.pending_moves.filter(m => m.days_until_auto_move <= 3);

            container.innerHTML = moves.slice(0, 12).map(move => `
                <div class="pending-item">
                    <div class="pending-item-header">
                        <span class="pending-item-name">${move.name}</span>
                        <span class="pending-item-countdown">${move.days_until_auto_move === 0 ? 'üî• JETZT' : move.days_until_auto_move + 'd'}</span>
                    </div>
                    <div class="pending-item-info">
                        ${move.current_stage} ‚Üí ${move.current_stage === 'lead' ? 'qualified' : move.current_stage === 'qualified' ? 'proposal' : 'negotiation'}
                        ‚Ä¢ ${formatCurrency(move.amount || 0)}
                    </div>
                </div>
            `).join('') || '<p style="color: var(--ui-silver); font-size: 0.8rem;">Keine anstehenden Auto-Moves in den n√§chsten 3 Tagen</p>';
        }

        async function runAutoMove(dryRun = false) {
            showToast(dryRun ? 'üëÅÔ∏è Simulation l√§uft...' : 'ü§ñ Auto-Move wird ausgef√ºhrt...');

            try {
                const res = await fetch(`${API_BASE}/deals/auto-move?dry_run=${dryRun}`, { method: 'POST' });
                if (res.ok) {
                    const data = await res.json();
                    if (data.moved_count > 0) {
                        showToast(`‚úÖ ${data.moved_count} Deals ${dryRun ? 'w√ºrden' : 'wurden'} verschoben!`);
                        document.getElementById('movedToday').textContent = data.moved_count;
                    } else {
                        showToast('‚ÑπÔ∏è Keine Deals zum Verschieben');
                    }

                    if (!dryRun) {
                        await refreshAll();
                    }

                    // Log moves
                    console.log('Auto-Move Result:', data);
                }
            } catch (e) {
                showToast('‚ùå Auto-Move fehlgeschlagen');
                console.error(e);
            }
        }

        async function syncFromHubSpot() {
            showToast('üì• Syncing from HubSpot...');
            try {
                const res = await fetch(`${API_BASE}/deals/sync/from-hubspot`, { method: 'POST' });
                if (res.ok) {
                    const data = await res.json();
                    showToast(`‚úÖ ${data.synced_count || 0} Deals synchronisiert!`);
                    await refreshAll();
                }
            } catch (e) { showToast('‚ùå Sync fehlgeschlagen'); }
        }

        async function refreshAll() {
            await Promise.all([fetchDeals(), fetchSummary(), fetchAutoMoveStatus()]);
            showToast('üîÑ Aktualisiert!');
        }

        function openCreateModal() {
            // Simplified - redirect to full create page or show modal
            alert('Deal-Erstellung: Deals werden prim√§r √ºber HubSpot-Sync importiert.\n\nF√ºr manuelle Erstellung: /deals');
        }

        function updateNextRun() {
            const now = new Date();
            const nextRun = new Date(now);
            nextRun.setHours(nextRun.getHours() + 1);
            nextRun.setMinutes(0);
            nextRun.setSeconds(0);

            const diff = nextRun - now;
            const mins = Math.floor(diff / 60000);
            document.getElementById('nextRun').textContent = `${mins} Min`;
        }

        // Init
        fetchDeals();
        fetchSummary();
        fetchAutoMoveStatus();
        updateNextRun();

        // Auto-refresh every 60 seconds
        setInterval(() => {
            fetchDeals();
            fetchSummary();
            fetchAutoMoveStatus();
            updateNextRun();
        }, 60000);
    </script>
</body>
</html>
