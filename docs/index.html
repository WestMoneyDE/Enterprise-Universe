<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>West Money OS v4.2 | Ultimate Business Platform</title>
    <meta name="description" content="All-in-One Business Platform mit Explorium, Stripe & Handelsregister">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ö°</text></svg>">
    <link rel="manifest" href="data:application/json,{&quot;name&quot;:&quot;West Money OS&quot;,&quot;short_name&quot;:&quot;WMOS&quot;,&quot;start_url&quot;:&quot;.&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;theme_color&quot;:&quot;%236366f1&quot;,&quot;background_color&quot;:&quot;%2309090b&quot;}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--bg-0:#09090b;--bg-1:#0c0c0f;--bg-2:#131316;--bg-3:#1a1a1f;--bg-4:#222228;--bg-5:#2a2a32;--text-0:#fafafa;--text-1:#d4d4d8;--text-2:#a1a1aa;--text-3:#71717a;--primary:#6366f1;--primary-hover:#818cf8;--primary-glow:rgba(99,102,241,0.15);--emerald:#10b981;--amber:#f59e0b;--rose:#f43f5e;--cyan:#06b6d4;--violet:#8b5cf6;--orange:#f97316;--border:rgba(255,255,255,0.06);--border-hover:rgba(255,255,255,0.12);--whatsapp:#25d366;--stripe:#635bff;--explorium:#00d4aa;--handelsregister:#1e3a8a;--radius:8px;--radius-lg:12px;--radius-xl:16px;--shadow:0 4px 24px rgba(0,0,0,0.4)}
        [data-theme="light"]{--bg-0:#f8fafc;--bg-1:#f1f5f9;--bg-2:#e2e8f0;--bg-3:#cbd5e1;--bg-4:#94a3b8;--text-0:#0f172a;--text-1:#1e293b;--text-2:#475569;--text-3:#64748b;--border:rgba(0,0,0,0.1)}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;background:var(--bg-0);color:var(--text-0);font-size:14px;line-height:1.5;min-height:100vh}
        ::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:var(--bg-2)}::-webkit-scrollbar-thumb{background:var(--bg-4);border-radius:3px}
        .login-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--bg-0) 0%,#0f0f1a 50%,#1a0a2e 100%)}
        .login-container{width:100%;max-width:420px;padding:20px}
        .login-logo{text-align:center;margin-bottom:32px}
        .login-logo-icon{width:80px;height:80px;background:linear-gradient(135deg,var(--primary),var(--violet));border-radius:20px;display:inline-flex;align-items:center;justify-content:center;font-size:36px;margin-bottom:16px;box-shadow:0 8px 32px rgba(99,102,241,0.4)}
        .login-logo h1{font-size:32px;font-weight:700;background:linear-gradient(135deg,var(--text-0),var(--primary-hover));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .login-logo p{color:var(--text-3)}
        .login-logo .version{display:inline-block;background:linear-gradient(135deg,var(--explorium),var(--cyan));color:white;padding:4px 12px;border-radius:20px;font-size:11px;font-weight:600;margin-top:8px}
        .login-box{background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius-xl);padding:32px}
        .login-box h2{font-size:20px;margin-bottom:24px;text-align:center}
        .form-group{margin-bottom:20px}
        .form-group label{display:block;font-size:13px;font-weight:500;margin-bottom:8px}
        .form-input,.form-control{width:100%;padding:12px 14px;background:var(--bg-3);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-0);font-size:14px;transition:all 0.2s}
        .form-input:focus,.form-control:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-glow)}
        select.form-control{cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2371717a' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center}
        textarea.form-control{resize:vertical;min-height:100px;font-family:inherit}
        .login-btn{width:100%;padding:14px;background:linear-gradient(135deg,var(--primary),var(--violet));color:white;border:none;border-radius:var(--radius);font-size:14px;font-weight:600;cursor:pointer;transition:all 0.2s}
        .login-btn:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(99,102,241,0.4)}
        .login-error{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:#ef4444;padding:12px;border-radius:var(--radius);margin-bottom:20px;text-align:center;display:none}
        .login-error.show{display:block}
        .login-footer{text-align:center;margin-top:24px;color:var(--text-3);font-size:12px}
        .app{display:none;min-height:100vh}
        .app.active{display:flex}
        .sidebar{width:260px;background:var(--bg-1);border-right:1px solid var(--border);position:fixed;height:100vh;display:flex;flex-direction:column;z-index:100;transition:transform 0.3s}
        .sidebar-header{padding:16px;border-bottom:1px solid var(--border)}
        .logo{display:flex;align-items:center;gap:10px}
        .logo-icon{width:40px;height:40px;background:linear-gradient(135deg,var(--primary),var(--violet));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px}
        .logo h1{font-size:16px;font-weight:600}
        .logo span{font-size:10px;color:var(--text-3);display:block}
        .logo .v-badge{background:linear-gradient(135deg,var(--explorium),var(--cyan));color:white;font-size:9px;padding:2px 6px;border-radius:4px}
        .sidebar-nav{flex:1;padding:8px;overflow-y:auto}
        .nav-group{margin-bottom:8px}
        .nav-label{font-size:10px;font-weight:600;color:var(--text-3);text-transform:uppercase;letter-spacing:0.5px;padding:12px 12px 6px}
        .nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:var(--radius);cursor:pointer;color:var(--text-2);font-size:13px;transition:all 0.15s;margin-bottom:2px}
        .nav-item:hover{background:var(--bg-3);color:var(--text-0)}
        .nav-item.active{background:var(--primary-glow);color:var(--primary-hover);border:1px solid rgba(99,102,241,0.3)}
        .nav-item .icon{width:20px;text-align:center}
        .nav-item .label{flex:1}
        .nav-item .badge{background:var(--primary);color:white;font-size:10px;padding:2px 6px;border-radius:4px;font-weight:600}
        .nav-item .badge.new{background:var(--emerald)}
        .nav-item .badge.api{background:var(--explorium)}
        .nav-item .badge.stripe{background:var(--stripe)}
        .nav-item .badge.hr{background:var(--handelsregister)}
        .sidebar-footer{padding:12px;border-top:1px solid var(--border)}
        .user-box{display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg-2);border-radius:var(--radius);cursor:pointer}
        .user-avatar{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--emerald),var(--cyan));display:flex;align-items:center;justify-content:center;font-weight:700;position:relative}
        .user-avatar .online{position:absolute;bottom:-2px;right:-2px;width:12px;height:12px;background:var(--emerald);border:2px solid var(--bg-1);border-radius:50%}
        .user-info{flex:1}
        .user-info div{font-size:13px;font-weight:500}
        .user-info span{color:var(--text-3);font-size:11px}
        .logout-btn{background:none;border:none;color:var(--text-3);cursor:pointer;padding:8px;font-size:16px}
        .logout-btn:hover{color:var(--rose)}
        .main{flex:1;margin-left:260px;display:flex;flex-direction:column;min-height:100vh}
        .topbar{height:60px;background:var(--bg-1);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 24px;position:sticky;top:0;z-index:50}
        .topbar-left{display:flex;align-items:center;gap:16px}
        .menu-toggle{display:none;background:none;border:none;color:var(--text-0);font-size:20px;cursor:pointer}
        .breadcrumb{font-size:13px;color:var(--text-2)}
        .breadcrumb strong{color:var(--text-0)}
        .topbar-center{flex:1;max-width:500px;margin:0 24px}
        .global-search{display:flex;align-items:center;gap:10px;background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius);padding:8px 16px}
        .global-search:focus-within{border-color:var(--primary)}
        .global-search input{background:none;border:none;outline:none;color:var(--text-0);font-size:13px;width:100%}
        .global-search kbd{background:var(--bg-4);padding:2px 6px;border-radius:4px;font-size:10px;color:var(--text-3)}
        .topbar-right{display:flex;align-items:center;gap:10px}
        .topbar-btn{width:40px;height:40px;background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius);display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative}
        .topbar-btn:hover{border-color:var(--primary)}
        .topbar-btn .count{position:absolute;top:4px;right:4px;background:var(--rose);color:white;font-size:9px;padding:1px 5px;border-radius:10px}
        .theme-toggle{background:var(--bg-3);border:1px solid var(--border);border-radius:20px;padding:4px;display:flex}
        .theme-toggle button{width:28px;height:28px;border:none;border-radius:50%;background:transparent;cursor:pointer;font-size:14px}
        .theme-toggle button.active{background:var(--primary)}
        .api-status{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:20px;font-size:11px;font-weight:600;background:rgba(0,212,170,0.15);color:var(--explorium)}
        .api-status .dot{width:8px;height:8px;border-radius:50%;background:var(--explorium);animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
        .content{padding:24px;flex:1}
        .page{display:none}
        .page.active{display:block;animation:fadeIn 0.3s}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        .page-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px;flex-wrap:wrap;gap:16px}
        .page-header h1{font-size:26px;font-weight:700;display:flex;align-items:center;gap:12px}
        .page-header p{color:var(--text-2);font-size:13px}
        .page-actions{display:flex;gap:10px;flex-wrap:wrap}
        .btn{display:inline-flex;align-items:center;gap:6px;padding:10px 16px;border-radius:var(--radius);font-size:13px;font-weight:500;cursor:pointer;border:none;transition:all 0.15s}
        .btn:disabled{opacity:0.5;cursor:not-allowed}
        .btn-primary{background:var(--primary);color:white}
        .btn-primary:hover:not(:disabled){background:var(--primary-hover)}
        .btn-secondary{background:var(--bg-3);color:var(--text-0);border:1px solid var(--border)}
        .btn-secondary:hover:not(:disabled){background:var(--bg-4)}
        .btn-danger{background:var(--rose);color:white}
        .btn-success{background:var(--emerald);color:white}
        .btn-warning{background:var(--amber);color:white}
        .btn-gradient{background:linear-gradient(135deg,var(--primary),var(--violet));color:white}
        .btn-explorium{background:linear-gradient(135deg,var(--explorium),var(--cyan));color:white}
        .btn-stripe{background:var(--stripe);color:white}
        .btn-hr{background:var(--handelsregister);color:white}
        .btn-sm{padding:6px 12px;font-size:12px}
        .btn-lg{padding:14px 24px;font-size:15px}
        .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
        .stat-card{background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius-lg);padding:20px;transition:all 0.2s}
        .stat-card:hover{border-color:var(--border-hover);transform:translateY(-2px)}
        .stat-card.success{border-left:3px solid var(--emerald)}
        .stat-card.warning{border-left:3px solid var(--amber)}
        .stat-card.danger{border-left:3px solid var(--rose)}
        .stat-card.explorium{border-left:3px solid var(--explorium)}
        .stat-card.stripe{border-left:3px solid var(--stripe)}
        .stat-card.hr{border-left:3px solid var(--handelsregister)}
        .stat-card.highlight{background:linear-gradient(135deg,rgba(99,102,241,0.1),rgba(139,92,246,0.1));border-color:rgba(99,102,241,0.3)}
        .stat-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
        .stat-icon{width:48px;height:48px;border-radius:var(--radius-lg);display:flex;align-items:center;justify-content:center;font-size:22px}
        .stat-icon.primary{background:var(--primary-glow);color:var(--primary)}
        .stat-icon.emerald{background:rgba(16,185,129,0.15);color:var(--emerald)}
        .stat-icon.amber{background:rgba(245,158,11,0.15);color:var(--amber)}
        .stat-icon.rose{background:rgba(244,63,94,0.15);color:var(--rose)}
        .stat-icon.explorium{background:rgba(0,212,170,0.15);color:var(--explorium)}
        .stat-icon.stripe{background:rgba(99,91,255,0.15);color:var(--stripe)}
        .stat-icon.hr{background:rgba(30,58,138,0.15);color:var(--handelsregister)}
        .stat-trend{font-size:11px;padding:4px 10px;border-radius:20px;font-weight:600}
        .stat-trend.up{background:rgba(16,185,129,0.15);color:var(--emerald)}
        .stat-trend.down{background:rgba(244,63,94,0.15);color:var(--rose)}
        .stat-value{font-size:32px;font-weight:700;line-height:1.2}
        .stat-label{font-size:13px;color:var(--text-2)}
        .card{background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius-lg);overflow:hidden;margin-bottom:16px}
        .card-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .card-header h3{font-size:15px;font-weight:600}
        .card-body{padding:20px}
        .card-body.no-padding{padding:0}
        .card-footer{padding:12px 20px;border-top:1px solid var(--border);background:var(--bg-3)}
        .grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
        .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
        .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
        .table-wrapper{overflow-x:auto}
        .data-table{width:100%;border-collapse:collapse;min-width:600px}
        .data-table th{text-align:left;padding:12px 16px;font-size:11px;font-weight:600;color:var(--text-3);text-transform:uppercase;background:var(--bg-3)}
        .data-table td{padding:14px 16px;font-size:13px;border-bottom:1px solid var(--border)}
        .data-table tbody tr:hover{background:var(--bg-3)}
        .status{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600}
        .status.active,.status.paid,.status.won,.status.running,.status.completed,.status.hot,.status.succeeded,.status.verified{background:rgba(16,185,129,0.15);color:var(--emerald)}
        .status.pending,.status.new,.status.warm,.status.scheduled,.status.draft{background:rgba(245,158,11,0.15);color:var(--amber)}
        .status.overdue,.status.inactive,.status.cold,.status.failed,.status.paused,.status.cancelled,.status.geloescht{background:rgba(244,63,94,0.15);color:var(--rose)}
        .status.qualified{background:rgba(6,182,212,0.15);color:var(--cyan)}
        .status.proposal{background:rgba(139,92,246,0.15);color:var(--violet)}
        .progress-bar{height:6px;background:var(--bg-4);border-radius:3px;overflow:hidden}
        .progress-bar.lg{height:10px;border-radius:5px}
        .progress-bar-fill{height:100%;border-radius:3px;transition:width 0.5s}
        .progress-bar-fill.emerald{background:var(--emerald)}
        .progress-bar-fill.primary{background:var(--primary)}
        .progress-bar-fill.gradient{background:linear-gradient(90deg,var(--primary),var(--violet))}
        .progress-bar-fill.explorium{background:linear-gradient(90deg,var(--explorium),var(--cyan))}
        .tabs{display:flex;gap:4px;background:var(--bg-3);padding:4px;border-radius:var(--radius);margin-bottom:20px;flex-wrap:wrap}
        .tab{padding:10px 20px;border-radius:6px;font-size:13px;font-weight:500;cursor:pointer;color:var(--text-2);transition:all 0.15s}
        .tab:hover{color:var(--text-0)}
        .tab.active{background:var(--bg-1);color:var(--text-0)}
        .tab .count{background:var(--bg-4);padding:2px 8px;border-radius:10px;font-size:11px;margin-left:6px}
        .tab.active .count{background:var(--primary);color:white}
        .tag{display:inline-flex;align-items:center;padding:4px 10px;background:var(--bg-4);border-radius:20px;font-size:11px}
        .tag.primary{background:var(--primary-glow);color:var(--primary)}
        .tag.success{background:rgba(16,185,129,0.15);color:var(--emerald)}
        .tag.warning{background:rgba(245,158,11,0.15);color:var(--amber)}
        .tag.explorium{background:rgba(0,212,170,0.15);color:var(--explorium)}
        .tag.stripe{background:rgba(99,91,255,0.15);color:var(--stripe)}
        .tag.hr{background:rgba(30,58,138,0.15);color:var(--handelsregister)}
        .empty-state{text-align:center;padding:60px 20px;color:var(--text-3)}
        .empty-state-icon{font-size:64px;margin-bottom:16px;opacity:0.5}
        .empty-state h3{font-size:18px;color:var(--text-0);margin-bottom:8px}
        .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:1000;padding:20px;backdrop-filter:blur(4px)}
        .modal-overlay.active{display:flex}
        .modal{background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius-xl);width:100%;max-width:500px;max-height:90vh;overflow:hidden;display:none}
        .modal.active{display:block;animation:slideUp 0.3s}
        .modal.lg{max-width:700px}
        .modal.xl{max-width:900px}
        .modal.xxl{max-width:1100px}
        @keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        .modal-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .modal-header h2{font-size:18px;font-weight:600}
        .modal-close{background:none;border:none;color:var(--text-3);cursor:pointer;font-size:24px}
        .modal-close:hover{color:var(--text-0)}
        .modal-body{padding:24px;overflow-y:auto;max-height:60vh}
        .modal-footer{padding:16px 24px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:10px;background:var(--bg-3)}
        .toast-container{position:fixed;bottom:24px;right:24px;z-index:2000;display:flex;flex-direction:column;gap:10px}
        .toast{background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius-lg);padding:16px 20px;display:flex;align-items:flex-start;gap:12px;min-width:320px;max-width:420px;animation:slideIn 0.3s}
        @keyframes slideIn{from{opacity:0;transform:translateX(100%)}to{opacity:1;transform:translateX(0)}}
        .toast.success{border-left:4px solid var(--emerald)}
        .toast.error{border-left:4px solid var(--rose)}
        .toast.info{border-left:4px solid var(--primary)}
        .toast.explorium{border-left:4px solid var(--explorium)}
        .toast.stripe{border-left:4px solid var(--stripe)}
        .toast.hr{border-left:4px solid var(--handelsregister)}
        .toast-icon{font-size:20px}
        .toast-content{flex:1}
        .toast-title{font-size:14px;font-weight:600}
        .toast-message{font-size:13px;color:var(--text-2)}
        .toast-close{background:none;border:none;color:var(--text-3);cursor:pointer;font-size:18px}
        .form-row{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-bottom:16px}
        .form-row.cols-3{grid-template-columns:repeat(3,1fr)}
        .form-row.cols-4{grid-template-columns:repeat(4,1fr)}
        .switch{position:relative;width:44px;height:24px;background:var(--bg-4);border-radius:12px;cursor:pointer}
        .switch.active{background:var(--primary)}
        .switch::after{content:'';position:absolute;width:20px;height:20px;background:white;border-radius:50%;top:2px;left:2px;transition:all 0.2s}
        .switch.active::after{left:22px}
        .chart-container{position:relative;height:300px}
        .wizard-steps{display:flex;margin-bottom:24px;background:var(--bg-3);border-radius:var(--radius-lg);padding:8px}
        .wizard-step{flex:1;text-align:center;padding:16px;cursor:pointer;border-radius:var(--radius)}
        .wizard-step.active{background:var(--bg-1)}
        .wizard-step.completed{color:var(--emerald)}
        .wizard-step-number{width:32px;height:32px;border-radius:50%;background:var(--bg-4);display:inline-flex;align-items:center;justify-content:center;font-weight:600;margin-bottom:8px}
        .wizard-step.active .wizard-step-number{background:var(--primary);color:white}
        .wizard-step.completed .wizard-step-number{background:var(--emerald);color:white}
        .wizard-step-label{font-size:12px;color:var(--text-3)}
        .wizard-step.active .wizard-step-label{color:var(--text-0);font-weight:500}
        .campaign-card{background:var(--bg-3);border:2px solid var(--border);border-radius:var(--radius-lg);padding:20px;margin-bottom:12px;cursor:pointer;transition:all 0.2s}
        .campaign-card:hover{border-color:var(--primary);transform:translateX(4px)}
        .campaign-metrics{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-top:16px}
        .campaign-metric{text-align:center;padding:12px 8px;background:var(--bg-2);border-radius:var(--radius)}
        .campaign-metric .value{font-size:18px;font-weight:700}
        .campaign-metric .label{font-size:9px;color:var(--text-3);text-transform:uppercase}
        .template-card{background:var(--bg-3);border:2px solid var(--border);border-radius:var(--radius-lg);padding:16px;cursor:pointer;transition:all 0.2s}
        .template-card:hover{border-color:var(--primary)}
        .template-card.selected{border-color:var(--primary);background:var(--primary-glow)}
        .sequence-step{display:flex;align-items:center;gap:16px;padding:16px;background:var(--bg-3);border-radius:var(--radius);margin-bottom:8px;border-left:3px solid var(--primary)}
        .sequence-step-number{width:32px;height:32px;background:var(--primary);color:white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600}
        .subscription-plan{background:var(--bg-3);border:2px solid var(--border);border-radius:var(--radius-lg);padding:24px;text-align:center;transition:all 0.2s}
        .subscription-plan:hover{border-color:var(--stripe);transform:translateY(-4px)}
        .subscription-plan.popular{border-color:var(--stripe);position:relative}
        .subscription-plan.popular::before{content:'BELIEBT';position:absolute;top:-12px;left:50%;transform:translateX(-50%);background:var(--stripe);color:white;padding:4px 12px;border-radius:12px;font-size:10px;font-weight:600}
        .subscription-price{font-size:36px;font-weight:700;margin:16px 0}
        .subscription-price span{font-size:14px;color:var(--text-3);font-weight:400}
        .hr-result{background:var(--bg-3);border:1px solid var(--border);border-radius:var(--radius-lg);padding:16px;margin-bottom:12px;transition:all 0.2s}
        .hr-result:hover{border-color:var(--handelsregister)}
        .hr-result-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}
        .hr-result-title{font-weight:600;font-size:15px}
        .hr-result-meta{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;font-size:12px;color:var(--text-2)}
        .hr-result-meta div{display:flex;flex-direction:column;gap:2px}
        .hr-result-meta strong{color:var(--text-0)}
        .hr-badge{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;background:rgba(30,58,138,0.15);border-radius:4px;font-size:10px;color:var(--handelsregister);font-weight:600}
        .hr-badge.hra{background:rgba(16,185,129,0.15);color:var(--emerald)}
        .hr-badge.hrb{background:rgba(99,102,241,0.15);color:var(--primary)}
        .hr-badge.gnr{background:rgba(245,158,11,0.15);color:var(--amber)}
        .keyboard-hint{position:fixed;bottom:24px;left:24px;background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius);padding:12px 16px;font-size:12px;color:var(--text-3);display:none}
        .keyboard-hint.show{display:block}
        .keyboard-hint kbd{background:var(--bg-4);padding:2px 6px;border-radius:4px;margin:0 2px}
        @media (max-width:1400px){.stats-grid{grid-template-columns:repeat(2,1fr)}.grid-4{grid-template-columns:repeat(2,1fr)}.campaign-metrics{grid-template-columns:repeat(3,1fr)}}
        @media (max-width:992px){.sidebar{transform:translateX(-260px)}.sidebar.open{transform:translateX(0)}.main{margin-left:0}.menu-toggle{display:block}}
        @media (max-width:768px){.stats-grid,.grid-2,.grid-3,.form-row{grid-template-columns:1fr}.topbar-center{display:none}.campaign-metrics{grid-template-columns:repeat(2,1fr)}.hr-result-meta{grid-template-columns:1fr}}
    </style>
</head>
<body>
<div class="login-screen" id="loginScreen">
    <div class="login-container">
        <div class="login-logo">
            <div class="login-logo-icon">‚ö°</div>
            <h1>West Money OS</h1>
            <p>Ultimate Business Platform</p>
            <span class="version">v4.2 + Handelsregister</span>
        </div>
        <div class="login-box">
            <h2>üîê Anmelden</h2>
            <div class="login-error" id="loginError">Ung√ºltige Anmeldedaten</div>
            <form id="loginForm">
                <div class="form-group"><label>Benutzername</label><input type="text" id="username" class="form-input" placeholder="admin" required></div>
                <div class="form-group"><label>Passwort</label><input type="password" id="password" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required></div>
                <button type="submit" class="login-btn" style="margin-top:20px">Anmelden ‚Üí</button>
            </form>
        </div>
        <div class="login-footer">¬© 2025 West Money OS ¬∑ Enterprise Universe GmbH</div>
    </div>
</div>
<div class="app" id="app">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header"><div class="logo"><div class="logo-icon">‚ö°</div><div><h1>West Money OS <span class="v-badge">4.2</span></h1><span>+ Handelsregister</span></div></div></div>
        <nav class="sidebar-nav" id="sidebarNav"></nav>
        <div class="sidebar-footer"><div class="user-box" onclick="showPage('profile')"><div class="user-avatar" id="userAvatar">√ñC<span class="online"></span></div><div class="user-info"><div id="userName">√ñmer Co≈ükun</div><span id="userRole">Admin</span></div><button class="logout-btn" onclick="event.stopPropagation();logout()">üö™</button></div></div>
    </aside>
    <main class="main">
        <header class="topbar">
            <div class="topbar-left"><button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button><div class="breadcrumb">West Money OS / <strong id="currentPageTitle">Dashboard</strong></div></div>
            <div class="topbar-center"><div class="global-search" id="globalSearch"><span>üîç</span><input type="text" placeholder="Suchen... (‚åòK f√ºr Handelsregister)" id="searchInput"><kbd>‚åòK</kbd></div></div>
            <div class="topbar-right">
                <div class="api-status"><span class="dot"></span><span>4 APIs</span></div>
                <div class="theme-toggle"><button onclick="setTheme('dark')" class="active" id="themeDark">üåô</button><button onclick="setTheme('light')" id="themeLight">‚òÄÔ∏è</button></div>
                <div class="topbar-btn" onclick="showPage('inbox')">üí¨<span class="count" id="inboxCount">0</span></div>
            </div>
        </header>
        <div class="content" id="pageContent"></div>
    </main>
</div>
<div class="modal-overlay" id="modalOverlay"></div>
<div class="toast-container" id="toastContainer"></div>
<div class="keyboard-hint" id="keyboardHint"><kbd>‚åò</kbd>+<kbd>K</kbd> Handelsregister ¬∑ <kbd>‚åò</kbd>+<kbd>N</kbd> Neu ¬∑ <kbd>Esc</kbd> Schlie√üen</div>
<script>
// ============================================================
// WEST MONEY OS v4.2 - EXPLORIUM + STRIPE + HANDELSREGISTER
// ============================================================

const EXPLORIUM_API_KEY = '1121ab737ecf41edaea2570899a8f90b';
const STRIPE_API_KEY = 'sk_test_51ShUrH2KgRKMdiU0JECuJJ4drdNS2AZrWdML8t2WIq96JU1IGPNlaavbdz3xFD2Gas0ZlG5SB8m4xk92Uo8igNiW00PiKFSehD';
const HANDELSREGISTER_URL = 'https://www.handelsregister.de/rp_web/erweitertesuche.xhtml';

// Navigation mit Handelsregister
const navigationConfig = [
    { group: '√úbersicht', items: [{ id: 'dashboard', icon: 'üìä', label: 'Dashboard' },{ id: 'analytics', icon: 'üìà', label: 'Analytics' }]},
    { group: 'Data APIs', items: [{ id: 'explorium', icon: 'ü§ñ', label: 'Explorium Hub', badge: 'API', badgeClass: 'api' },{ id: 'handelsregister', icon: 'üèõÔ∏è', label: 'Handelsregister', badge: 'NEU', badgeClass: 'hr' },{ id: 'leadgen', icon: 'üîç', label: 'AI Lead Gen' },{ id: 'enrichment', icon: '‚ú®', label: 'Enrichment' }]},
    { group: 'CRM', items: [{ id: 'contacts', icon: 'üë•', label: 'Kontakte', countKey: 'contacts' },{ id: 'leads', icon: 'üéØ', label: 'Leads', countKey: 'leads' },{ id: 'pipeline', icon: 'üìà', label: 'Pipeline' }]},
    { group: 'Marketing', items: [{ id: 'campaigns', icon: 'üìß', label: 'Kampagnen' },{ id: 'templates', icon: 'üìù', label: 'Vorlagen' },{ id: 'sequences', icon: '‚ö°', label: 'Sequenzen' }]},
    { group: 'Kommunikation', items: [{ id: 'inbox', icon: 'üì•', label: 'Inbox', countKey: 'unread' }]},
    { group: 'Finanzen', items: [{ id: 'invoices', icon: 'üìÑ', label: 'Rechnungen' },{ id: 'payments', icon: 'üí≥', label: 'Stripe', badge: 'üí≥', badgeClass: 'stripe' },{ id: 'subscriptions', icon: 'üîÑ', label: 'Abos' }]},
    { group: 'Projekte', items: [{ id: 'projects', icon: 'üìÅ', label: 'Projekte' },{ id: 'tasks', icon: '‚úÖ', label: 'Aufgaben', countKey: 'tasks' }]},
    { group: 'Platform', items: [{ id: 'integrations', icon: 'üîå', label: 'Integrationen' },{ id: 'settings', icon: '‚öôÔ∏è', label: 'Einstellungen' }]}
];

// Sample Handelsregister Data
const sampleHRData = [
    { id: 1, name: 'West Money Bau GmbH', registerArt: 'HRB', registerNummer: '12345', gericht: 'K√∂ln', sitz: 'K√∂ln', rechtsform: 'GmbH', status: 'aktiv', kapital: '25.000 EUR', gruendung: '2023-01-15', geschaeftsfuehrer: '√ñmer H√ºseyin Co≈ükun' },
    { id: 2, name: 'Enterprise Universe GmbH', registerArt: 'HRB', registerNummer: '67890', gericht: 'K√∂ln', sitz: 'K√∂ln', rechtsform: 'GmbH', status: 'aktiv', kapital: '25.000 EUR', gruendung: '2024-03-20', geschaeftsfuehrer: '√ñmer H√ºseyin Co≈ükun' },
    { id: 3, name: 'Z Automation UG', registerArt: 'HRB', registerNummer: '11223', gericht: 'K√∂ln', sitz: 'K√∂ln', rechtsform: 'UG', status: 'aktiv', kapital: '1.000 EUR', gruendung: '2024-06-01', geschaeftsfuehrer: '√ñmer H√ºseyin Co≈ükun' },
    { id: 4, name: 'Deutsche Bahn AG', registerArt: 'HRB', registerNummer: '50000', gericht: 'Berlin', sitz: 'Berlin', rechtsform: 'AG', status: 'aktiv', kapital: '2.150.000.000 EUR', gruendung: '1994-01-01', geschaeftsfuehrer: 'Richard Lutz' },
    { id: 5, name: 'Siemens AG', registerArt: 'HRB', registerNummer: '6684', gericht: 'M√ºnchen', sitz: 'M√ºnchen', rechtsform: 'AG', status: 'aktiv', kapital: '2.550.000.000 EUR', gruendung: '1966-08-08', geschaeftsfuehrer: 'Roland Busch' }
];

const defaultData = {
    contacts: [
        { id: 1, firstName: 'Max', lastName: 'M√ºller', email: 'max@mueller.de', phone: '+49 221 1234567', company: 'M√ºller Bau GmbH', position: 'Gesch√§ftsf√ºhrer', status: 'active', score: 85, source: 'Explorium', enriched: true, hrVerified: true },
        { id: 2, firstName: 'Anna', lastName: 'Schmidt', email: 'anna@schmidt.de', phone: '+49 221 7654321', company: 'Schmidt Immobilien', position: 'CEO', status: 'active', score: 72, source: 'Website', enriched: true, hrVerified: false },
        { id: 3, firstName: 'Thomas', lastName: 'Weber', email: 'thomas@weber.de', phone: '+49 221 9876543', company: 'Weber Haus', position: 'Inhaber', status: 'pending', score: 68, source: 'Explorium', enriched: false, hrVerified: false },
        { id: 4, firstName: 'Lisa', lastName: 'Fischer', email: 'lisa@fischer.de', phone: '+49 221 5432167', company: 'Fischer GmbH', position: 'Projektleiterin', status: 'active', score: 91, source: 'Handelsregister', enriched: true, hrVerified: true },
        { id: 5, firstName: 'Michael', lastName: 'Bauer', email: 'michael@bauer.de', phone: '+49 221 6789012', company: 'Bauer Gruppe', position: 'Vorstand', status: 'active', score: 95, source: 'Explorium', enriched: true, hrVerified: true }
    ],
    leads: [
        { id: 1, name: 'Smart Home Projekt K√∂ln', company: 'M√ºller GmbH', value: 85000, status: 'qualified', source: 'Explorium', probability: 75 },
        { id: 2, name: 'Barrierefreies Bauen', company: 'Weber Bau', value: 45000, status: 'new', source: 'AI Lead Gen', probability: 40 },
        { id: 3, name: 'Komplettsanierung EFH', company: 'Schmidt Haus', value: 125000, status: 'won', source: 'Empfehlung', probability: 100 },
        { id: 4, name: 'LOXONE Installation', company: 'Fischer Immo', value: 32000, status: 'proposal', source: 'Website', probability: 60 },
        { id: 5, name: 'Neubau Villa', company: 'Becker Familie', value: 280000, status: 'new', source: 'Handelsregister', probability: 35 },
        { id: 6, name: 'B√ºro Automation', company: 'TechCorp GmbH', value: 156000, status: 'qualified', source: 'AI Lead Gen', probability: 55 }
    ],
    campaigns: [
        { id: 1, name: 'Smart Home Q1 2026', type: 'email', status: 'running', audience: 'B2B Baugewerbe', audienceSize: 450, sent: 245, delivered: 238, opened: 98, clicked: 34, replied: 12, revenue: 45000 },
        { id: 2, name: 'B2B Baugewerbe NRW', type: 'email', status: 'completed', audience: 'Explorium NRW', audienceSize: 200, sent: 189, delivered: 182, opened: 74, clicked: 28, replied: 9, revenue: 28000 },
        { id: 3, name: 'WhatsApp Follow-up', type: 'whatsapp', status: 'running', audience: 'Hot Leads', audienceSize: 60, sent: 56, delivered: 56, opened: 56, clicked: 0, replied: 23, revenue: 62000 }
    ],
    templates: [
        { id: 1, name: 'Smart Home Intro', key: 'smart-home-intro', type: 'email', category: 'Sales', subject: 'Revolutionieren Sie Ihr Zuhause', body: 'Sehr geehrte/r {firstName}...', usageCount: 156, openRate: 42 },
        { id: 2, name: 'Follow-up', key: 'followup', type: 'email', category: 'Follow-up', subject: 'Kurze Nachfrage', body: 'Hallo {firstName}...', usageCount: 234, openRate: 52 },
        { id: 3, name: 'WhatsApp Termin', key: 'wa-termin', type: 'whatsapp', category: 'WhatsApp', subject: '', body: 'Hallo {firstName}...', usageCount: 67 }
    ],
    sequences: [
        { id: 1, name: 'Neuer Lead Welcome', trigger: 'new_lead', triggerLabel: 'Bei neuem Lead', status: 'active', enrolled: 45, completed: 32, inProgress: 13, steps: [{ type: 'email', template: 'smart-home-intro' },{ type: 'wait', days: 3 },{ type: 'email', template: 'followup' }] },
        { id: 2, name: 'Cold Reaktivierung', trigger: 'no_response', triggerLabel: 'Keine Antwort', status: 'active', enrolled: 78, completed: 34, inProgress: 44, steps: [{ type: 'email', template: 'followup' },{ type: 'wait', days: 7 }] }
    ],
    invoices: [
        { id: 'RE-2025-001', customer: 'M√ºller GmbH', amount: 45000, status: 'paid', date: '2025-12-01', stripeId: 'pi_example1' },
        { id: 'RE-2025-002', customer: 'Weber Bau', amount: 28000, status: 'pending', date: '2025-12-10' },
        { id: 'RE-2025-003', customer: 'Schmidt Haus', amount: 62000, status: 'paid', date: '2025-11-25', stripeId: 'pi_example2' },
        { id: 'RE-2025-004', customer: 'Fischer GmbH', amount: 18000, status: 'overdue', date: '2025-11-01' }
    ],
    subscriptions: [
        { id: 'sub_1', customer: 'M√ºller GmbH', plan: 'Pro', amount: 99, status: 'active', nextBilling: '2026-01-01' },
        { id: 'sub_2', customer: 'Fischer GmbH', plan: 'Enterprise', amount: 299, status: 'active', nextBilling: '2026-01-15' }
    ],
    payments: [
        { id: 'pay_1', customer: 'M√ºller GmbH', amount: 45000, status: 'succeeded', type: 'invoice', date: '2025-12-10', method: 'card', last4: '4242' },
        { id: 'pay_2', customer: 'Schmidt Haus', amount: 62000, status: 'succeeded', type: 'invoice', date: '2025-12-05', method: 'sepa' }
    ],
    tasks: [
        { id: 1, title: 'Angebot f√ºr M√ºller GmbH', status: 'in-progress', priority: 'high', dueDate: '2025-12-24' },
        { id: 2, title: 'Follow-up Weber Bau', status: 'pending', priority: 'medium', dueDate: '2025-12-26' },
        { id: 3, title: 'HR-Verifizierung neue Leads', status: 'pending', priority: 'high', dueDate: '2025-12-23' },
        { id: 4, title: 'Kampagne auswerten', status: 'pending', priority: 'low', dueDate: '2025-12-31' }
    ],
    projects: [
        { id: 1, name: 'Smart Home Villa K√∂ln', customer: 'M√ºller GmbH', status: 'active', progress: 65, budget: 85000 },
        { id: 2, name: 'Sanierung Schmidt', customer: 'Schmidt Haus', status: 'active', progress: 35, budget: 125000 }
    ],
    conversations: [
        { id: 1, contact: 'Max M√ºller', type: 'whatsapp', unread: true, messages: [{text:'K√∂nnen wir morgen telefonieren?',time:'11:00',outgoing:false}] },
        { id: 2, contact: 'Anna Schmidt', type: 'email', unread: false, messages: [{text:'Termin best√§tigt.',time:'09:15',outgoing:true}] },
        { id: 3, contact: 'Lisa Fischer', type: 'whatsapp', unread: true, messages: [{text:'Interesse an LOXONE',time:'08:15',outgoing:false}] }
    ],
    b2bDatabase: [
        { id: 1, company: 'Bauhaus K√∂ln GmbH', industry: 'Baugewerbe', employees: '50-100', city: 'K√∂ln', email: 'info@bauhaus-koeln.de', score: 87, status: 'hot', decisionMaker: 'Thomas Bauer', enriched: true, source: 'Explorium', hrVerified: true },
        { id: 2, company: 'Rhein Immobilien AG', industry: 'Immobilien', employees: '100-250', city: 'D√ºsseldorf', email: 'kontakt@rhein-immo.de', score: 92, status: 'hot', decisionMaker: 'Maria Weber', enriched: true, source: 'Handelsregister', hrVerified: true },
        { id: 3, company: 'NRW Elektrotechnik', industry: 'Elektro', employees: '25-50', city: 'Essen', email: 'info@nrw-elektro.de', score: 74, status: 'warm', decisionMaker: 'Klaus Fischer', enriched: false, source: 'Handelsregister', hrVerified: true },
        { id: 4, company: 'Smart Home Solutions', industry: 'Technologie', employees: '10-25', city: 'Bonn', email: 'hello@smarthome-sol.de', score: 81, status: 'warm', decisionMaker: 'Sarah Klein', enriched: true, source: 'Explorium', hrVerified: false },
        { id: 5, company: 'K√∂lner Wohnbau GmbH', industry: 'Baugewerbe', employees: '50-100', city: 'K√∂ln', email: 'kontakt@koelner-wohnbau.de', score: 95, status: 'hot', decisionMaker: 'Peter Schmidt', enriched: true, source: 'Explorium', hrVerified: true }
    ],
    hrSearchHistory: [
        { id: 1, query: 'West Money', results: 3, date: '2025-12-23' },
        { id: 2, query: 'Baugewerbe K√∂ln', results: 156, date: '2025-12-22' },
        { id: 3, query: 'GmbH D√ºsseldorf', results: 2341, date: '2025-12-20' }
    ],
    integrations: [
        { id: 'explorium', name: 'Explorium AI', category: 'Data', status: 'connected', icon: 'ü§ñ', credits: 4873 },
        { id: 'handelsregister', name: 'Handelsregister', category: 'Data', status: 'connected', icon: 'üèõÔ∏è', searches: 45 },
        { id: 'stripe', name: 'Stripe Payments', category: 'Payments', status: 'connected', icon: 'üí≥' },
        { id: 'hubspot', name: 'HubSpot CRM', category: 'CRM', status: 'connected', icon: 'üß°' },
        { id: 'whatsapp', name: 'WhatsApp Business', category: 'Messaging', status: 'connected', icon: 'üí¨' },
        { id: 'gmail', name: 'Gmail SMTP', category: 'Email', status: 'connected', icon: 'üìß' },
        { id: 'zapier', name: 'Zapier', category: 'Automation', status: 'connected', icon: '‚ö°' }
    ],
    explorium: { credits: 4873, used: 127, searches: 45, enrichments: 82 },
    stripe: { balance: 135000, pending: 28000, payouts: 107000, fees: 3892 },
    handelsregister: { searches: 45, verified: 23, lastSearch: '2025-12-23' },
    activities: [
        { id: 1, icon: 'üèõÔ∏è', text: 'HR: 3 Firmen verifiziert', time: '2 Min.' },
        { id: 2, icon: 'ü§ñ', text: 'Explorium: 15 neue Leads', time: '5 Min.' },
        { id: 3, icon: 'üí≥', text: 'Stripe: Zahlung ‚Ç¨45,000', time: '1 Std.' },
        { id: 4, icon: 'üìß', text: 'Kampagne: 245 E-Mails gesendet', time: '2 Std.' }
    ],
    settings: { company: { name: 'West Money Bau GmbH', email: 'info@west-money-bau.de', iban: 'DE42 1001 0178 9758 7887 93' } }
};

let data = JSON.parse(localStorage.getItem('wmos_data_v42')) || JSON.parse(JSON.stringify(defaultData));
let currentUser = JSON.parse(localStorage.getItem('wmos_user'));
let currentPage = localStorage.getItem('wmos_page') || 'dashboard';
let currentTheme = localStorage.getItem('wmos_theme') || 'dark';
let hrSearchResults = [];

function saveData() { localStorage.setItem('wmos_data_v42', JSON.stringify(data)); }
function generateId() { return Date.now() + Math.random().toString(36).substr(2, 9); }
function formatCurrency(n) { return '‚Ç¨' + (n || 0).toLocaleString('de-DE'); }
function formatDate(d) { return d ? new Date(d).toLocaleDateString('de-DE') : '-'; }
function getInitials(name) { return name ? name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) : '??'; }
function statusLabel(s) { const labels = {new:'Neu',qualified:'Qualifiziert',proposal:'Angebot',won:'Gewonnen',active:'Aktiv',aktiv:'Aktiv',pending:'Ausstehend',paid:'Bezahlt',overdue:'√úberf√§llig',hot:'üî• Hot',warm:'‚òÄÔ∏è Warm',running:'Aktiv',scheduled:'Geplant',draft:'Entwurf',completed:'Fertig',paused:'Pausiert',succeeded:'Erfolgreich',verified:'‚úì Verifiziert',geloescht:'Gel√∂scht'}; return labels[s] || s; }

function showToast(type, title, message, duration = 4000) {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    const icons = {success: '‚úÖ', error: '‚ùå', info: '‚ÑπÔ∏è', explorium: 'ü§ñ', stripe: 'üí≥', hr: 'üèõÔ∏è'};
    toast.innerHTML = `<span class="toast-icon">${icons[type] || '‚ÑπÔ∏è'}</span><div class="toast-content"><div class="toast-title">${title}</div><div class="toast-message">${message}</div></div><button class="toast-close" onclick="this.parentElement.remove()">√ó</button>`;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), duration);
}

function setTheme(theme) {
    currentTheme = theme;
    localStorage.setItem('wmos_theme', theme);
    document.body.setAttribute('data-theme', theme);
    document.getElementById('themeDark').classList.toggle('active', theme === 'dark');
    document.getElementById('themeLight').classList.toggle('active', theme === 'light');
}

function handleLogin(e) {
    e.preventDefault();
    const u = document.getElementById('username').value, p = document.getElementById('password').value;
    if ((u === 'admin' && p === '663724') || (u === 'admin' && p === 'admin') || (u === 'demo' && p === 'demo')) {
        currentUser = { id: 1, name: u === 'admin' && p === '663724' ? '√ñmer Co≈ükun' : 'Demo User', role: p === '663724' ? 'admin' : 'user', email: 'oemer@west-money-bau.de' };
        localStorage.setItem('wmos_user', JSON.stringify(currentUser));
        showApp();
    } else {
        document.getElementById('loginError').classList.add('show');
        setTimeout(() => document.getElementById('loginError').classList.remove('show'), 3000);
    }
}

function logout() { localStorage.removeItem('wmos_user'); location.reload(); }

function showApp() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('app').classList.add('active');
    document.getElementById('userName').textContent = currentUser.name;
    document.getElementById('userAvatar').innerHTML = getInitials(currentUser.name) + '<span class="online"></span>';
    setTheme(currentTheme);
    renderNavigation();
    showPage(currentPage);
    updateAllCounts();
    showToast('success', 'Willkommen!', currentUser.name);
}

function renderNavigation() {
    document.getElementById('sidebarNav').innerHTML = navigationConfig.map(g => `<div class="nav-group"><div class="nav-label">${g.group}</div>${g.items.map(i => `<div class="nav-item ${currentPage === i.id ? 'active' : ''}" onclick="showPage('${i.id}')"><span class="icon">${i.icon}</span><span class="label">${i.label}</span>${i.badge ? `<span class="badge ${i.badgeClass || ''}">${i.badge}</span>` : ''}${i.countKey ? `<span class="badge" id="nav_${i.countKey}">0</span>` : ''}</div>`).join('')}</div>`).join('');
}

function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }

function showPage(pageId) {
    currentPage = pageId;
    localStorage.setItem('wmos_page', pageId);
    document.getElementById('currentPageTitle').textContent = pageId.charAt(0).toUpperCase() + pageId.slice(1);
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.querySelector(`.nav-item[onclick="showPage('${pageId}')"]`)?.classList.add('active');
    renderPage(pageId);
    updateAllCounts();
    document.getElementById('sidebar').classList.remove('open');
}

function updateAllCounts() {
    const counts = { contacts: data.contacts.length, leads: data.leads.length, unread: data.conversations.filter(c => c.unread).length, tasks: data.tasks.filter(t => t.status !== 'completed').length };
    Object.entries(counts).forEach(([k, v]) => { const el = document.getElementById(`nav_${k}`); if (el) el.textContent = v; });
    document.getElementById('inboxCount').textContent = counts.unread;
}

function renderPage(pageId) {
    const content = document.getElementById('pageContent');
    const renderers = { dashboard: renderDashboard, analytics: renderAnalytics, explorium: renderExplorium, handelsregister: renderHandelsregister, leadgen: renderLeadGen, enrichment: renderEnrichment, contacts: renderContacts, leads: renderLeads, pipeline: renderPipeline, campaigns: renderCampaigns, templates: renderTemplates, sequences: renderSequences, inbox: renderInbox, invoices: renderInvoices, payments: renderPayments, subscriptions: renderSubscriptions, projects: renderProjects, tasks: renderTasks, integrations: renderIntegrations, settings: renderSettings, profile: renderProfile };
    content.innerHTML = (renderers[pageId] || renderNotFound)();
    if (pageId === 'dashboard') initDashboardCharts();
    if (pageId === 'analytics') initAnalyticsCharts();
    if (pageId === 'inbox') initInbox();
}

function renderNotFound() { return `<div class="page active"><div class="empty-state"><div class="empty-state-icon">üîç</div><h3>Seite nicht gefunden</h3></div></div>`; }

// DASHBOARD
function renderDashboard() {
    const revenue = data.invoices.filter(i => i.status === 'paid').reduce((s, i) => s + i.amount, 0);
    const pipeline = data.leads.reduce((s, l) => s + l.value, 0);
    const hrVerified = data.contacts.filter(c => c.hrVerified).length;
    return `<div class="page active">
        <div class="page-header"><div><h1>üìä Dashboard</h1><p>Willkommen, ${currentUser.name}!</p></div><div class="page-actions"><button class="btn btn-hr" onclick="showPage('handelsregister')">üèõÔ∏è HR-Suche</button><button class="btn btn-explorium" onclick="showPage('explorium')">ü§ñ Explorium</button><button class="btn btn-stripe" onclick="showPage('payments')">üí≥ Stripe</button></div></div>
        <div class="stats-grid">
            <div class="stat-card success"><div class="stat-top"><div class="stat-icon emerald">üí∞</div><span class="stat-trend up">‚Üë 23.5%</span></div><div class="stat-value">${formatCurrency(revenue)}</div><div class="stat-label">Umsatz 2025</div></div>
            <div class="stat-card"><div class="stat-top"><div class="stat-icon primary">üìà</div></div><div class="stat-value">${formatCurrency(pipeline)}</div><div class="stat-label">Pipeline</div></div>
            <div class="stat-card hr"><div class="stat-top"><div class="stat-icon hr">üèõÔ∏è</div><span class="tag hr">NEU</span></div><div class="stat-value">${hrVerified}</div><div class="stat-label">HR-Verifiziert</div></div>
            <div class="stat-card explorium"><div class="stat-top"><div class="stat-icon explorium">ü§ñ</div></div><div class="stat-value">${data.explorium.credits}</div><div class="stat-label">Explorium Credits</div></div>
        </div>
        <div class="grid-2">
            <div class="card"><div class="card-header"><h3>üìà Umsatz</h3></div><div class="card-body"><div class="chart-container"><canvas id="revenueChart"></canvas></div></div></div>
            <div class="card"><div class="card-header"><h3>üìä Aktivit√§ten</h3></div><div class="card-body" style="padding:0">${data.activities.map(a=>`<div style="padding:12px 20px;border-bottom:1px solid var(--border);display:flex;gap:12px"><div style="width:36px;height:36px;background:var(--primary-glow);border-radius:8px;display:flex;align-items:center;justify-content:center">${a.icon}</div><div><div>${a.text}</div><div style="font-size:11px;color:var(--text-3)">${a.time}</div></div></div>`).join('')}</div></div>
        </div>
        <div class="grid-3" style="margin-top:16px">
            <div class="card"><div class="card-header"><h3>üèõÔ∏è Letzte HR-Suchen</h3><button class="btn btn-sm btn-hr" onclick="showPage('handelsregister')">Alle ‚Üí</button></div><div class="card-body" style="padding:0">${data.hrSearchHistory.slice(0,3).map(h=>`<div style="padding:12px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between"><div><div style="font-weight:500">"${h.query}"</div><div style="font-size:11px;color:var(--text-3)">${formatDate(h.date)}</div></div><span class="tag hr">${h.results} Treffer</span></div>`).join('')}</div></div>
            <div class="card"><div class="card-header"><h3>üìß Kampagnen</h3><button class="btn btn-sm btn-secondary" onclick="showPage('campaigns')">Alle ‚Üí</button></div><div class="card-body" style="padding:0">${data.campaigns.filter(c=>c.status==='running').slice(0,3).map(c=>`<div style="padding:12px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center"><div><div style="font-weight:500">${c.name}</div><div style="font-size:11px;color:var(--text-3)">${c.sent} gesendet</div></div><span class="status running">Aktiv</span></div>`).join('')||'<div class="empty-state"><p>Keine aktiven Kampagnen</p></div>'}</div></div>
            <div class="card"><div class="card-header"><h3>üî• Hot Leads</h3><button class="btn btn-sm btn-explorium" onclick="showPage('leadgen')">Alle ‚Üí</button></div><div class="card-body" style="padding:0">${data.b2bDatabase.filter(l=>l.status==='hot').slice(0,3).map(l=>`<div style="padding:12px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between"><div><div style="font-weight:500">${l.company}</div><div style="font-size:11px;color:var(--text-3)">${l.city} ${l.hrVerified?'<span class="hr-badge">‚úì HR</span>':''}</div></div><span class="status hot">${l.score}%</span></div>`).join('')}</div></div>
        </div>
    </div>`;
}

function initDashboardCharts() {
    const ctx = document.getElementById('revenueChart');
    if (!ctx) return;
    new Chart(ctx, { type: 'line', data: { labels: ['Jan','Feb','M√§r','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'], datasets: [{ label: 'Umsatz', data: [45,62,58,71,68,85,92,78,95,110,125,135].map(x=>x*1000), borderColor: '#6366f1', backgroundColor: 'rgba(99,102,241,0.1)', fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#71717a' } }, y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#71717a', callback: v => '‚Ç¨' + (v/1000) + 'K' } } } } });
}

// ANALYTICS
function renderAnalytics() {
    return `<div class="page active">
        <div class="page-header"><div><h1>üìà Analytics</h1><p>Detaillierte Auswertungen</p></div></div>
        <div class="stats-grid">
            <div class="stat-card"><div class="stat-value">‚Ç¨847K</div><div class="stat-label">Gesamtumsatz</div><span class="stat-trend up">‚Üë 23.5%</span></div>
            <div class="stat-card"><div class="stat-value">29%</div><div class="stat-label">Conversion Rate</div></div>
            <div class="stat-card"><div class="stat-value">‚Ç¨68K</div><div class="stat-label">√ò Deal-Gr√∂√üe</div></div>
            <div class="stat-card"><div class="stat-value">18</div><div class="stat-label">√ò Sales Cycle (Tage)</div></div>
        </div>
        <div class="grid-2">
            <div class="card"><div class="card-header"><h3>üìä Lead Sources</h3></div><div class="card-body"><div class="chart-container"><canvas id="sourceChart"></canvas></div></div></div>
            <div class="card"><div class="card-header"><h3>üéØ Pipeline nach Status</h3></div><div class="card-body"><div class="chart-container"><canvas id="pipeChart"></canvas></div></div></div>
        </div>
        <div class="card" style="margin-top:16px"><div class="card-header"><h3>üèõÔ∏è Handelsregister Statistiken</h3></div><div class="card-body"><div class="grid-4"><div style="text-align:center"><div style="font-size:32px;font-weight:700;color:var(--handelsregister)">${data.handelsregister.searches}</div><div style="font-size:12px;color:var(--text-3)">HR-Suchen</div></div><div style="text-align:center"><div style="font-size:32px;font-weight:700;color:var(--emerald)">${data.handelsregister.verified}</div><div style="font-size:12px;color:var(--text-3)">Verifiziert</div></div><div style="text-align:center"><div style="font-size:32px;font-weight:700;color:var(--primary)">${data.contacts.filter(c=>c.hrVerified).length}</div><div style="font-size:12px;color:var(--text-3)">HR-Kontakte</div></div><div style="text-align:center"><div style="font-size:32px;font-weight:700;color:var(--amber)">${data.b2bDatabase.filter(b=>b.hrVerified).length}</div><div style="font-size:12px;color:var(--text-3)">HR-Leads</div></div></div></div></div>
    </div>`;
}

function initAnalyticsCharts() {
    const srcCtx = document.getElementById('sourceChart');
    const pipeCtx = document.getElementById('pipeChart');
    if (srcCtx) new Chart(srcCtx, { type: 'doughnut', data: { labels: ['Explorium', 'Handelsregister', 'Website', 'Empfehlung', 'Sonstige'], datasets: [{ data: [35, 25, 20, 15, 5], backgroundColor: ['#00d4aa', '#1e3a8a', '#6366f1', '#f59e0b', '#71717a'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#a1a1aa' } } } } });
    if (pipeCtx) new Chart(pipeCtx, { type: 'bar', data: { labels: ['Neu', 'Qualifiziert', 'Angebot', 'Gewonnen'], datasets: [{ label: 'Wert', data: [280000, 241000, 32000, 125000], backgroundColor: ['#f59e0b', '#06b6d4', '#8b5cf6', '#10b981'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false }, ticks: { color: '#71717a' } }, y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#71717a', callback: v => '‚Ç¨' + (v/1000) + 'K' } } } } });
}

// =============================================
// HANDELSREGISTER - HAUPTFEATURE
// =============================================
function renderHandelsregister() {
    return `<div class="page active">
        <div class="page-header">
            <div><h1>üèõÔ∏è Handelsregister</h1><p>Deutsches Unternehmensregister durchsuchen</p></div>
            <div class="page-actions">
                <div class="api-status"><span class="dot" style="background:var(--handelsregister)"></span>Verbunden</div>
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card hr"><div class="stat-top"><div class="stat-icon hr">üîç</div></div><div class="stat-value">${data.handelsregister.searches}</div><div class="stat-label">Suchen heute</div></div>
            <div class="stat-card success"><div class="stat-value">${data.handelsregister.verified}</div><div class="stat-label">Verifiziert</div></div>
            <div class="stat-card"><div class="stat-value">${data.hrSearchHistory.length}</div><div class="stat-label">Suchverlauf</div></div>
            <div class="stat-card warning"><div class="stat-value">60/Std</div><div class="stat-label">Limit (¬ß9 HGB)</div></div>
        </div>

        <div class="card">
            <div class="card-header"><h3>üîç Erweiterte Suche</h3></div>
            <div class="card-body">
                <div class="form-row cols-3">
                    <div class="form-group"><label>Schlagw√∂rter / Firmenname</label><input type="text" class="form-control" id="hrKeywords" placeholder="z.B. Deutsche Bahn, West Money..."></div>
                    <div class="form-group"><label>Niederlassung / Sitz</label><input type="text" class="form-control" id="hrCity" placeholder="z.B. K√∂ln, Berlin..."></div>
                    <div class="form-group"><label>Registerart</label><select class="form-control" id="hrRegisterArt"><option value="alle">Alle</option><option value="HRA">HRA (Einzelkaufleute, OHG, KG)</option><option value="HRB">HRB (GmbH, AG, UG)</option><option value="GnR">GnR (Genossenschaften)</option><option value="PR">PR (Partnerschaftsregister)</option><option value="VR">VR (Vereinsregister)</option></select></div>
                </div>
                <div class="form-row cols-4">
                    <div class="form-group"><label>Rechtsform</label><select class="form-control" id="hrRechtsform"><option value="">Alle</option><option value="8">GmbH</option><option value="1">AG</option><option value="55">Einzelkaufmann</option><option value="10">KG</option><option value="12">OHG</option><option value="6">SE (Europ√§ische AG)</option><option value="2">eG (Genossenschaft)</option></select></div>
                    <div class="form-group"><label>Bundesland</label><select class="form-control" id="hrBundesland"><option value="">Alle</option><option value="NW">Nordrhein-Westfalen</option><option value="BY">Bayern</option><option value="BW">Baden-W√ºrttemberg</option><option value="BE">Berlin</option><option value="HH">Hamburg</option><option value="HE">Hessen</option><option value="NI">Niedersachsen</option><option value="SN">Sachsen</option></select></div>
                    <div class="form-group"><label>Registernummer</label><input type="text" class="form-control" id="hrRegNr" placeholder="z.B. 12345"></div>
                    <div class="form-group"><label>Registergericht</label><input type="text" class="form-control" id="hrGericht" placeholder="z.B. K√∂ln"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="hrGeloescht"> Auch gel√∂schte Firmen anzeigen</label></div>
                    <div class="form-group"><label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="hrAehnlich"> √Ñhnlich lautende Schlagw√∂rter (Phonetische Suche)</label></div>
                </div>
                <div style="display:flex;gap:12px">
                    <button class="btn btn-hr btn-lg" onclick="searchHandelsregister()">üîç Suchen</button>
                    <button class="btn btn-secondary" onclick="clearHRSearch()">üóëÔ∏è Zur√ºcksetzen</button>
                </div>
            </div>
        </div>

        <div class="card" id="hrResultsCard" style="display:none">
            <div class="card-header"><h3>üìã Suchergebnisse</h3><span id="hrResultCount" class="tag hr">0 Treffer</span></div>
            <div class="card-body" id="hrResults"></div>
        </div>

        <div class="card">
            <div class="card-header"><h3>üìú Suchverlauf</h3></div>
            <div class="card-body no-padding">
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead><tr><th>Suche</th><th>Treffer</th><th>Datum</th><th></th></tr></thead>
                        <tbody>${data.hrSearchHistory.map(h=>`<tr><td><strong>"${h.query}"</strong></td><td><span class="tag hr">${h.results}</span></td><td>${formatDate(h.date)}</td><td><button class="btn btn-sm btn-secondary" onclick="repeatHRSearch('${h.query}')">üîÑ</button></td></tr>`).join('')}</tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card" style="margin-top:16px">
            <div class="card-header"><h3>‚ÑπÔ∏è Hinweise zur Nutzung</h3></div>
            <div class="card-body">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;font-size:13px">
                    <div>
                        <h4 style="color:var(--emerald);margin-bottom:8px">‚úÖ Erlaubt</h4>
                        <ul style="list-style:none;color:var(--text-2)">
                            <li>‚Ä¢ Einsichtnahme zu Informationszwecken (¬ß9 Abs.1 HGB)</li>
                            <li>‚Ä¢ Recherche nach einzelnen Firmen</li>
                            <li>‚Ä¢ Einsicht in Unternehmenstr√§gerdaten</li>
                            <li>‚Ä¢ Nutzung der Handelsregisterbekanntmachungen</li>
                        </ul>
                    </div>
                    <div>
                        <h4 style="color:var(--rose);margin-bottom:8px">‚ö†Ô∏è Limits</h4>
                        <ul style="list-style:none;color:var(--text-2)">
                            <li>‚Ä¢ Max. 60 Abrufe pro Stunde (Nutzungsordnung)</li>
                            <li>‚Ä¢ Keine automatisierten Massenabfragen</li>
                            <li>‚Ä¢ Verst√∂√üe k√∂nnen ¬ß¬ß303a,b StGB erf√ºllen</li>
                            <li>‚Ä¢ Platzhalter: * (beliebig viele), ? (ein Zeichen)</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>`;
}

function searchHandelsregister() {
    const keywords = document.getElementById('hrKeywords').value.trim();
    const city = document.getElementById('hrCity').value.trim();
    
    if (!keywords && !city) {
        showToast('error', 'Fehler', 'Bitte Suchbegriff oder Stadt eingeben');
        return;
    }

    showToast('hr', 'Handelsregister', 'Suche l√§uft...');
    
    // Simulate search with sample data
    setTimeout(() => {
        const query = keywords || city;
        let results = sampleHRData.filter(r => {
            const searchLower = query.toLowerCase();
            return r.name.toLowerCase().includes(searchLower) || 
                   r.sitz.toLowerCase().includes(searchLower) ||
                   r.geschaeftsfuehrer.toLowerCase().includes(searchLower);
        });
        
        // If no exact matches, show all sample data for demo
        if (results.length === 0) {
            results = sampleHRData;
        }
        
        hrSearchResults = results;
        
        // Save to history
        data.hrSearchHistory.unshift({ id: generateId(), query, results: results.length, date: new Date().toISOString().split('T')[0] });
        data.handelsregister.searches++;
        saveData();
        
        // Display results
        displayHRResults(results);
        showToast('success', 'Suche abgeschlossen', `${results.length} Treffer gefunden`);
    }, 1000);
}

function displayHRResults(results) {
    const card = document.getElementById('hrResultsCard');
    const container = document.getElementById('hrResults');
    const count = document.getElementById('hrResultCount');
    
    card.style.display = 'block';
    count.textContent = results.length + ' Treffer';
    
    container.innerHTML = results.map(r => `
        <div class="hr-result">
            <div class="hr-result-header">
                <div>
                    <div class="hr-result-title">${r.name}</div>
                    <div style="font-size:12px;color:var(--text-3);margin-top:4px">${r.sitz} ¬∑ ${r.rechtsform}</div>
                </div>
                <div style="display:flex;gap:8px">
                    <span class="hr-badge ${r.registerArt.toLowerCase()}">${r.registerArt} ${r.registerNummer}</span>
                    <span class="status ${r.status}">${statusLabel(r.status)}</span>
                </div>
            </div>
            <div class="hr-result-meta">
                <div><span>Registergericht</span><strong>AG ${r.gericht}</strong></div>
                <div><span>Stammkapital</span><strong>${r.kapital}</strong></div>
                <div><span>Gr√ºndung</span><strong>${formatDate(r.gruendung)}</strong></div>
            </div>
            <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
                <div style="font-size:12px"><strong>Gesch√§ftsf√ºhrung:</strong> ${r.geschaeftsfuehrer}</div>
                <div style="display:flex;gap:8px">
                    <button class="btn btn-sm btn-secondary" onclick="viewHRDetails(${r.id})">üìÑ Details</button>
                    <button class="btn btn-sm btn-primary" onclick="importHRToContacts(${r.id})">‚ûï Importieren</button>
                </div>
            </div>
        </div>
    `).join('') || '<div class="empty-state"><div class="empty-state-icon">üîç</div><h3>Keine Ergebnisse</h3><p>Versuchen Sie andere Suchbegriffe</p></div>';
}

function viewHRDetails(id) {
    const r = sampleHRData.find(x => x.id === id);
    if (!r) return;
    
    openModalWithContent(`
        <div class="modal active lg">
            <div class="modal-header"><h2>üèõÔ∏è ${r.name}</h2><button class="modal-close" onclick="closeModal()">√ó</button></div>
            <div class="modal-body">
                <div class="grid-2" style="margin-bottom:20px">
                    <div class="card"><div class="card-body">
                        <h4 style="margin-bottom:12px">üìã Registerdaten</h4>
                        <div style="display:grid;gap:8px;font-size:13px">
                            <div style="display:flex;justify-content:space-between"><span style="color:var(--text-3)">Registerart</span><span class="hr-badge ${r.registerArt.toLowerCase()}">${r.registerArt}</span></div>
                            <div style="display:flex;justify-content:space-between"><span style="color:var(--text-3)">Registernummer</span><strong>${r.registerNummer}</strong></div>
                            <div style="display:flex;justify-content:space-between"><span style="color:var(--text-3)">Registergericht</span><strong>AG ${r.gericht}</strong></div>
                            <div style="display:flex;justify-content:space-between"><span style="color:var(--text-3)">Status</span><span class="status ${r.status}">${statusLabel(r.status)}</span></div>
                        </div>
                    </div></div>
                    <div class="card"><div class="card-body">
                        <h4 style="margin-bottom:12px">üè¢ Unternehmensdaten</h4>
                        <div style="display:grid;gap:8px;font-size:13px">
                            <div style="display:flex;justify-content:space-between"><span style="color:var(--text-3)">Rechtsform</span><strong>${r.rechtsform}</strong></div>
                            <div style="display:flex;justify-content:space-between"><span style="color:var(--text-3)">Sitz</span><strong>${r.sitz}</strong></div>
                            <div style="display:flex;justify-content:space-between"><span style="color:var(--text-3)">Stammkapital</span><strong>${r.kapital}</strong></div>
                            <div style="display:flex;justify-content:space-between"><span style="color:var(--text-3)">Gr√ºndung</span><strong>${formatDate(r.gruendung)}</strong></div>
                        </div>
                    </div></div>
                </div>
                <div class="card"><div class="card-body">
                    <h4 style="margin-bottom:12px">üë§ Vertretungsberechtigte</h4>
                    <div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg-3);border-radius:8px">
                        <div style="width:48px;height:48px;background:var(--primary-glow);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600">${getInitials(r.geschaeftsfuehrer)}</div>
                        <div><div style="font-weight:600">${r.geschaeftsfuehrer}</div><div style="font-size:12px;color:var(--text-3)">Gesch√§ftsf√ºhrer</div></div>
                    </div>
                </div></div>
            </div>
            <div class="modal-footer">
                <a href="https://www.handelsregister.de" target="_blank" class="btn btn-secondary">üîó Im Original √∂ffnen</a>
                <button class="btn btn-hr" onclick="importHRToContacts(${r.id});closeModal()">‚ûï Als Lead importieren</button>
            </div>
        </div>
    `);
}

function importHRToContacts(id) {
    const r = sampleHRData.find(x => x.id === id);
    if (!r) return;
    
    // Add to B2B Database
    data.b2bDatabase.unshift({
        id: generateId(),
        company: r.name,
        industry: 'Handelsregister',
        employees: '-',
        city: r.sitz,
        email: '',
        score: 70,
        status: 'warm',
        decisionMaker: r.geschaeftsfuehrer,
        enriched: false,
        source: 'Handelsregister',
        hrVerified: true,
        hrData: { registerArt: r.registerArt, registerNummer: r.registerNummer, gericht: r.gericht, kapital: r.kapital }
    });
    
    // Add as Lead
    data.leads.unshift({
        id: generateId(),
        name: 'HR-Import: ' + r.name,
        company: r.name,
        value: 25000,
        status: 'new',
        source: 'Handelsregister',
        probability: 30
    });
    
    data.handelsregister.verified++;
    saveData();
    updateAllCounts();
    showToast('success', 'Importiert', r.name + ' wurde als Lead hinzugef√ºgt');
}

function clearHRSearch() {
    document.getElementById('hrKeywords').value = '';
    document.getElementById('hrCity').value = '';
    document.getElementById('hrRegNr').value = '';
    document.getElementById('hrGericht').value = '';
    document.getElementById('hrRegisterArt').value = 'alle';
    document.getElementById('hrRechtsform').value = '';
    document.getElementById('hrBundesland').value = '';
    document.getElementById('hrResultsCard').style.display = 'none';
}

function repeatHRSearch(query) {
    document.getElementById('hrKeywords').value = query;
    searchHandelsregister();
}

// EXPLORIUM
function renderExplorium() {
    return `<div class="page active">
        <div class="page-header"><div><h1>ü§ñ Explorium AI Hub</h1><p>B2B Intelligence API</p></div><div class="page-actions"><div class="api-status"><span class="dot"></span>Verbunden</div></div></div>
        <div class="stats-grid">
            <div class="stat-card explorium"><div class="stat-value">${data.explorium.credits}</div><div class="stat-label">Credits verf√ºgbar</div></div>
            <div class="stat-card"><div class="stat-value">${data.explorium.searches}</div><div class="stat-label">Suchen</div></div>
            <div class="stat-card"><div class="stat-value">${data.explorium.enrichments}</div><div class="stat-label">Anreicherungen</div></div>
            <div class="stat-card"><div class="stat-value">${data.b2bDatabase.filter(b=>b.source==='Explorium').length}</div><div class="stat-label">Explorium Leads</div></div>
        </div>
        <div class="grid-3">
            <div class="card" onclick="showPage('leadgen')" style="cursor:pointer"><div class="card-body" style="text-align:center;padding:40px"><div style="font-size:48px">üîç</div><h3 style="margin:16px 0 8px">AI Lead Generator</h3><p style="color:var(--text-3)">B2B Leads finden</p></div></div>
            <div class="card" onclick="showPage('enrichment')" style="cursor:pointer"><div class="card-body" style="text-align:center;padding:40px"><div style="font-size:48px">‚ú®</div><h3 style="margin:16px 0 8px">Data Enrichment</h3><p style="color:var(--text-3)">Kontakte anreichern</p></div></div>
            <div class="card" onclick="showPage('handelsregister')" style="cursor:pointer"><div class="card-body" style="text-align:center;padding:40px"><div style="font-size:48px">üèõÔ∏è</div><h3 style="margin:16px 0 8px">Handelsregister</h3><p style="color:var(--text-3)">Firmen verifizieren</p></div></div>
        </div>
        <div class="card"><div class="card-header"><h3>üîë API Key</h3></div><div class="card-body"><div style="display:flex;gap:12px"><input type="password" class="form-control" value="${EXPLORIUM_API_KEY}" id="expKey" style="flex:1;font-family:monospace"><button class="btn btn-secondary" onclick="document.getElementById('expKey').type=document.getElementById('expKey').type==='password'?'text':'password'">üëÅÔ∏è</button><button class="btn btn-explorium" onclick="showToast('explorium','API Test','Verbindung erfolgreich!')">üîó Testen</button></div></div></div>
    </div>`;
}

// LEAD GENERATOR
function renderLeadGen() {
    return `<div class="page active">
        <div class="page-header"><div><h1>üîç AI Lead Generator</h1><p>Powered by Explorium + Handelsregister</p></div></div>
        <div class="card"><div class="card-header"><h3>üéØ Suchkriterien</h3></div><div class="card-body">
            <div class="form-row cols-4">
                <div class="form-group"><label>Branche</label><select class="form-control"><option>Alle</option><option>Baugewerbe</option><option>Immobilien</option><option>Technologie</option></select></div>
                <div class="form-group"><label>Region</label><select class="form-control"><option>Alle</option><option>K√∂ln</option><option>D√ºsseldorf</option><option>NRW</option></select></div>
                <div class="form-group"><label>Mitarbeiter</label><select class="form-control"><option>Alle</option><option>10-50</option><option>50-100</option><option>100+</option></select></div>
                <div class="form-group"><label>Quelle</label><select class="form-control"><option>Alle</option><option>Explorium</option><option>Handelsregister</option></select></div>
            </div>
            <div style="display:flex;gap:12px"><button class="btn btn-explorium" onclick="showToast('explorium','Suche','${data.b2bDatabase.length} Unternehmen gefunden')">ü§ñ Explorium suchen</button><button class="btn btn-hr" onclick="showPage('handelsregister')">üèõÔ∏è Handelsregister</button></div>
        </div></div>
        <div class="stats-grid"><div class="stat-card explorium"><div class="stat-value">${data.b2bDatabase.filter(l=>l.status==='hot').length}</div><div class="stat-label">Hot üî•</div></div><div class="stat-card hr"><div class="stat-value">${data.b2bDatabase.filter(l=>l.hrVerified).length}</div><div class="stat-label">HR-Verifiziert</div></div><div class="stat-card"><div class="stat-value">${data.b2bDatabase.filter(l=>l.enriched).length}</div><div class="stat-label">Angereichert</div></div><div class="stat-card"><div class="stat-value">${data.b2bDatabase.length}</div><div class="stat-label">Gesamt</div></div></div>
        <div class="card"><div class="card-header"><h3>üìã Ergebnisse</h3></div><div class="card-body no-padding"><div class="table-wrapper"><table class="data-table"><thead><tr><th>Firma</th><th>Branche</th><th>Stadt</th><th>Score</th><th>Quelle</th><th>HR</th><th></th></tr></thead><tbody>${data.b2bDatabase.map(l=>`<tr><td><strong>${l.company}</strong><br><span style="font-size:11px;color:var(--text-3)">${l.decisionMaker}</span></td><td>${l.industry}</td><td>${l.city}</td><td><span class="status ${l.status}">${l.score}%</span></td><td><span class="tag ${l.source==='Explorium'?'explorium':l.source==='Handelsregister'?'hr':''}">${l.source}</span></td><td>${l.hrVerified?'<span class="hr-badge">‚úì</span>':'-'}</td><td><button class="btn btn-sm btn-primary" onclick="convertB2BToLead(${l.id})">‚ûï</button></td></tr>`).join('')}</tbody></table></div></div></div>
    </div>`;
}

function convertB2BToLead(id) {
    const l = data.b2bDatabase.find(x => x.id === id);
    if (!l) return;
    data.leads.unshift({ id: generateId(), name: 'B2B - ' + l.company, company: l.company, value: 25000, status: 'new', source: l.source, probability: 40 });
    data.contacts.unshift({ id: generateId(), firstName: l.decisionMaker.split(' ')[0], lastName: l.decisionMaker.split(' ').slice(1).join(' '), email: l.email, company: l.company, status: 'active', source: l.source, hrVerified: l.hrVerified });
    saveData(); updateAllCounts();
    showToast('success', 'Lead erstellt', l.company);
}

// ENRICHMENT
function renderEnrichment() {
    return `<div class="page active">
        <div class="page-header"><div><h1>‚ú® Data Enrichment</h1><p>Kontakte mit Explorium & HR anreichern</p></div></div>
        <div class="stats-grid"><div class="stat-card explorium"><div class="stat-value">${data.contacts.filter(c=>c.enriched).length}</div><div class="stat-label">Angereichert</div></div><div class="stat-card hr"><div class="stat-value">${data.contacts.filter(c=>c.hrVerified).length}</div><div class="stat-label">HR-Verifiziert</div></div><div class="stat-card"><div class="stat-value">${data.contacts.filter(c=>!c.enriched).length}</div><div class="stat-label">Ausstehend</div></div><div class="stat-card"><div class="stat-value">${data.explorium.credits}</div><div class="stat-label">Credits</div></div></div>
        <div class="card"><div class="card-header"><h3>üë• Kontakte</h3><div><button class="btn btn-sm btn-hr" onclick="verifyAllHR()" style="margin-right:8px">üèõÔ∏è Alle HR-pr√ºfen</button><button class="btn btn-sm btn-explorium" onclick="enrichAll()">‚ú® Alle anreichern</button></div></div><div class="card-body no-padding"><div class="table-wrapper"><table class="data-table"><thead><tr><th>Name</th><th>Firma</th><th>Angereichert</th><th>HR-Verifiziert</th><th></th></tr></thead><tbody>${data.contacts.map(c=>`<tr><td><strong>${c.firstName} ${c.lastName}</strong></td><td>${c.company||'-'}</td><td>${c.enriched?'<span class="tag success">‚úì</span>':'<span class="tag warning">‚è≥</span>'}</td><td>${c.hrVerified?'<span class="hr-badge">‚úì HR</span>':'<span class="tag">-</span>'}</td><td>${!c.enriched||!c.hrVerified?`<button class="btn btn-sm btn-secondary" onclick="enrichContact(${c.id})">‚ú®</button>`:''}</td></tr>`).join('')}</tbody></table></div></div></div>
    </div>`;
}

function enrichContact(id) { const c=data.contacts.find(x=>x.id===id); if(c){c.enriched=true;c.score=Math.floor(Math.random()*30)+70;data.explorium.enrichments++;saveData();showPage('enrichment');showToast('explorium','Angereichert',c.firstName);} }
function enrichAll() { data.contacts.filter(c=>!c.enriched).forEach(c=>{c.enriched=true;c.score=Math.floor(Math.random()*30)+70;}); data.explorium.enrichments+=data.contacts.length; saveData(); showPage('enrichment'); showToast('success','Fertig','Alle angereichert'); }
function verifyAllHR() { data.contacts.forEach(c=>{c.hrVerified=true;}); data.handelsregister.verified+=data.contacts.length; saveData(); showPage('enrichment'); showToast('hr','HR-Pr√ºfung','Alle Kontakte verifiziert'); }

// CONTACTS
function renderContacts() {
    return `<div class="page active">
        <div class="page-header"><div><h1>üë• Kontakte</h1><p>${data.contacts.length} Kontakte ¬∑ ${data.contacts.filter(c=>c.hrVerified).length} HR-verifiziert</p></div><div class="page-actions"><button class="btn btn-primary" onclick="openModal('contact')">+ Neuer Kontakt</button></div></div>
        <div class="card"><div class="card-body no-padding"><div class="table-wrapper"><table class="data-table"><thead><tr><th>Name</th><th>E-Mail</th><th>Firma</th><th>Status</th><th>HR</th><th></th></tr></thead><tbody>${data.contacts.map(c=>`<tr><td><strong>${c.firstName} ${c.lastName}</strong></td><td>${c.email}</td><td>${c.company||'-'}</td><td><span class="status ${c.status}">${statusLabel(c.status)}</span></td><td>${c.hrVerified?'<span class="hr-badge">‚úì</span>':'-'}</td><td><button class="btn btn-sm btn-secondary" onclick="deleteContact(${c.id})">üóëÔ∏è</button></td></tr>`).join('')}</tbody></table></div></div></div>
    </div>`;
}

function deleteContact(id) { if(!confirm('L√∂schen?'))return; data.contacts=data.contacts.filter(c=>c.id!==id); saveData(); showPage('contacts'); updateAllCounts(); }

// LEADS
function renderLeads() {
    return `<div class="page active">
        <div class="page-header"><div><h1>üéØ Leads</h1><p>${data.leads.length} Leads ¬∑ ${formatCurrency(data.leads.reduce((s,l)=>s+l.value,0))} Pipeline</p></div><div class="page-actions"><button class="btn btn-hr" onclick="showPage('handelsregister')">üèõÔ∏è HR-Import</button><button class="btn btn-primary" onclick="openModal('lead')">+ Neuer Lead</button></div></div>
        <div class="stats-grid"><div class="stat-card"><div class="stat-value">${data.leads.filter(l=>l.status==='new').length}</div><div class="stat-label">Neu</div></div><div class="stat-card"><div class="stat-value">${data.leads.filter(l=>l.status==='qualified').length}</div><div class="stat-label">Qualifiziert</div></div><div class="stat-card hr"><div class="stat-value">${data.leads.filter(l=>l.source==='Handelsregister').length}</div><div class="stat-label">HR-Leads</div></div><div class="stat-card success"><div class="stat-value">${data.leads.filter(l=>l.status==='won').length}</div><div class="stat-label">Gewonnen</div></div></div>
        <div class="card"><div class="card-body no-padding"><div class="table-wrapper"><table class="data-table"><thead><tr><th>Lead</th><th>Firma</th><th>Wert</th><th>Status</th><th>Quelle</th><th></th></tr></thead><tbody>${data.leads.map(l=>`<tr><td><strong>${l.name}</strong></td><td>${l.company}</td><td><strong style="color:var(--emerald)">${formatCurrency(l.value)}</strong></td><td><span class="status ${l.status}">${statusLabel(l.status)}</span></td><td><span class="tag ${l.source==='Handelsregister'?'hr':l.source==='Explorium'?'explorium':''}">${l.source}</span></td><td><button class="btn btn-sm btn-secondary" onclick="deleteLead('${l.id}')">üóëÔ∏è</button></td></tr>`).join('')}</tbody></table></div></div></div>
    </div>`;
}

function deleteLead(id) { if(!confirm('L√∂schen?'))return; data.leads=data.leads.filter(l=>l.id!=id); saveData(); showPage('leads'); updateAllCounts(); }

// PIPELINE
function renderPipeline() {
    const stages = [{id:'new',name:'üÜï Neu',color:'amber'},{id:'qualified',name:'‚úì Qualifiziert',color:'cyan'},{id:'proposal',name:'üìã Angebot',color:'violet'},{id:'won',name:'üéâ Gewonnen',color:'emerald'}];
    return `<div class="page active">
        <div class="page-header"><div><h1>üìà Pipeline</h1><p>${formatCurrency(data.leads.reduce((s,l)=>s+l.value,0))} Gesamtwert</p></div></div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px">${stages.map(s=>{const items=data.leads.filter(l=>l.status===s.id);return`<div class="card"><div class="card-header"><h3 style="font-size:13px">${s.name}</h3><span style="color:var(--${s.color})">${formatCurrency(items.reduce((a,l)=>a+l.value,0))}</span></div><div class="card-body" style="min-height:200px">${items.map(l=>`<div style="background:var(--bg-3);border-radius:8px;padding:12px;margin-bottom:8px;border-left:3px solid var(--${s.color})"><div style="font-weight:500">${l.company}</div><div style="font-size:12px;color:var(--text-3)">${l.name}</div><div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px"><span style="color:var(--emerald);font-weight:700">${formatCurrency(l.value)}</span>${l.source==='Handelsregister'?'<span class="hr-badge">HR</span>':''}</div></div>`).join('')||'<div style="text-align:center;color:var(--text-3);padding:20px">Keine</div>'}</div></div>`}).join('')}</div>
    </div>`;
}

// CAMPAIGNS
function renderCampaigns() {
    const running = data.campaigns.filter(c => c.status === 'running');
    const totalSent = data.campaigns.reduce((s, c) => s + c.sent, 0);
    return `<div class="page active">
        <div class="page-header"><div><h1>üìß Kampagnen</h1><p>${data.campaigns.length} Kampagnen</p></div><div class="page-actions"><button class="btn btn-gradient" onclick="openCampaignWizard()">+ Neue Kampagne</button></div></div>
        <div class="stats-grid"><div class="stat-card highlight"><div class="stat-value">${running.length}</div><div class="stat-label">Aktive Kampagnen</div></div><div class="stat-card"><div class="stat-value">${totalSent}</div><div class="stat-label">E-Mails gesendet</div></div><div class="stat-card success"><div class="stat-value">${data.campaigns.reduce((s,c)=>s+(c.delivered>0?Math.round(c.opened/c.delivered*100):0),0)/Math.max(data.campaigns.length,1)}%</div><div class="stat-label">√ò √ñffnungsrate</div></div><div class="stat-card stripe"><div class="stat-value">${formatCurrency(data.campaigns.reduce((s,c)=>s+(c.revenue||0),0))}</div><div class="stat-label">Umsatz</div></div></div>
        ${data.campaigns.map(c => `<div class="campaign-card" onclick="viewCampaign(${c.id})"><div style="display:flex;justify-content:space-between;align-items:flex-start"><div style="display:flex;align-items:center;gap:12px"><span style="font-size:24px">${c.type === 'email' ? 'üìß' : 'üí¨'}</span><div><div style="font-size:16px;font-weight:600">${c.name}</div><div style="font-size:12px;color:var(--text-3)">${c.audience} ¬∑ ${c.audienceSize} Empf√§nger</div></div></div><span class="status ${c.status}">${statusLabel(c.status)}</span></div><div class="campaign-metrics"><div class="campaign-metric"><div class="value">${c.sent}</div><div class="label">Gesendet</div></div><div class="campaign-metric"><div class="value">${c.delivered>0?Math.round(c.delivered/c.sent*100):0}%</div><div class="label">Zugestellt</div></div><div class="campaign-metric"><div class="value">${c.delivered>0?Math.round(c.opened/c.delivered*100):0}%</div><div class="label">Ge√∂ffnet</div></div><div class="campaign-metric"><div class="value">${c.opened>0?Math.round(c.clicked/c.opened*100):0}%</div><div class="label">Geklickt</div></div><div class="campaign-metric"><div class="value">${c.replied}</div><div class="label">Antworten</div></div><div class="campaign-metric"><div class="value" style="color:var(--emerald)">${formatCurrency(c.revenue||0)}</div><div class="label">Umsatz</div></div></div></div>`).join('')}
    </div>`;
}

function viewCampaign(id) { const c = data.campaigns.find(x => x.id === id); if (!c) return; openModalWithContent(`<div class="modal active lg"><div class="modal-header"><h2>${c.name}</h2><button class="modal-close" onclick="closeModal()">√ó</button></div><div class="modal-body"><div class="stats-grid" style="grid-template-columns:repeat(3,1fr)"><div class="stat-card"><div class="stat-value">${c.sent}</div><div class="stat-label">Gesendet</div></div><div class="stat-card success"><div class="stat-value">${c.delivered>0?Math.round(c.opened/c.delivered*100):0}%</div><div class="stat-label">√ñffnungsrate</div></div><div class="stat-card stripe"><div class="stat-value">${formatCurrency(c.revenue||0)}</div><div class="stat-label">Umsatz</div></div></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Schlie√üen</button></div></div>`); }
function openCampaignWizard() { showToast('info', 'Kampagne', 'Wizard wird geladen...'); }

// TEMPLATES
function renderTemplates() {
    return `<div class="page active">
        <div class="page-header"><div><h1>üìù Vorlagen</h1><p>${data.templates.length} Vorlagen</p></div><div class="page-actions"><button class="btn btn-primary" onclick="openModal('template')">+ Neue Vorlage</button></div></div>
        <div class="grid-3">${data.templates.map(t=>`<div class="card"><div class="card-header"><h3 style="font-size:14px">${t.type==='email'?'üìß':'üí¨'} ${t.name}</h3><span class="tag">${t.category}</span></div><div class="card-body"><div style="font-size:13px;font-weight:500;margin-bottom:8px">${t.subject||''}</div><div style="font-size:12px;color:var(--text-3)">${t.body.substring(0,80)}...</div>${t.openRate?`<div style="margin-top:12px;font-size:11px"><span style="color:var(--emerald)">${t.openRate}% √ñffnung</span> ¬∑ ${t.usageCount}x verwendet</div>`:''}</div></div>`).join('')}</div>
    </div>`;
}

// SEQUENCES
function renderSequences() {
    return `<div class="page active">
        <div class="page-header"><div><h1>‚ö° Sequenzen</h1><p>${data.sequences.length} Automatisierungen</p></div><div class="page-actions"><button class="btn btn-primary" onclick="openModal('sequence')">+ Neue Sequenz</button></div></div>
        <div class="grid-2">${data.sequences.map(s=>`<div class="card"><div class="card-header"><h3>‚ö° ${s.name}</h3><span class="status ${s.status}">${statusLabel(s.status)}</span></div><div class="card-body"><div style="display:flex;gap:8px;margin-bottom:16px"><span class="tag">${s.triggerLabel}</span><span class="tag">${s.steps.length} Schritte</span></div><div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;text-align:center"><div style="background:var(--bg-3);padding:12px;border-radius:8px"><div style="font-size:20px;font-weight:700">${s.enrolled}</div><div style="font-size:10px;color:var(--text-3)">Enrolled</div></div><div style="background:var(--bg-3);padding:12px;border-radius:8px"><div style="font-size:20px;font-weight:700">${s.inProgress}</div><div style="font-size:10px;color:var(--text-3)">In Progress</div></div><div style="background:var(--bg-3);padding:12px;border-radius:8px"><div style="font-size:20px;font-weight:700;color:var(--emerald)">${s.completed}</div><div style="font-size:10px;color:var(--text-3)">Completed</div></div></div></div><div class="card-footer"><button class="btn btn-sm ${s.status==='active'?'btn-warning':'btn-success'}" onclick="toggleSequence(${s.id})">${s.status==='active'?'‚è∏Ô∏è Pause':'‚ñ∂Ô∏è Start'}</button></div></div>`).join('')}</div>
    </div>`;
}

function toggleSequence(id) { const s=data.sequences.find(x=>x.id===id); if(s){s.status=s.status==='active'?'paused':'active';saveData();showPage('sequences');} }

// INBOX
function renderInbox() {
    return `<div class="page active">
        <div class="page-header"><div><h1>üì• Unified Inbox</h1><p>${data.conversations.length} Konversationen</p></div><div class="page-actions"><button class="btn btn-primary" onclick="openModal('message')">‚úâÔ∏è Neu</button></div></div>
        <div style="display:grid;grid-template-columns:350px 1fr;gap:20px;height:500px">
            <div class="card" style="overflow:hidden"><div class="card-body no-padding" style="height:100%;overflow-y:auto" id="inboxList"></div></div>
            <div class="card" id="inboxMain"><div class="empty-state"><div class="empty-state-icon">üì•</div><h3>Konversation ausw√§hlen</h3></div></div>
        </div>
    </div>`;
}

function initInbox() {
    const list = document.getElementById('inboxList');
    if (!list) return;
    list.innerHTML = data.conversations.map(c => `<div style="padding:14px 16px;border-bottom:1px solid var(--border);cursor:pointer;display:flex;gap:12px;background:${c.unread?'var(--bg-3)':''}" onclick="selectConversation(${c.id})"><div style="width:40px;height:40px;border-radius:50%;background:${c.type==='whatsapp'?'rgba(37,211,102,0.15)':'rgba(234,67,53,0.15)'};display:flex;align-items:center;justify-content:center">${c.type==='whatsapp'?'üí¨':'üìß'}</div><div style="flex:1"><div style="display:flex;justify-content:space-between"><span style="font-weight:${c.unread?'600':'400'}">${c.contact}</span><span style="font-size:11px;color:var(--text-3)">${c.messages[c.messages.length-1].time}</span></div><div style="font-size:12px;color:var(--text-2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${c.messages[c.messages.length-1].text}</div></div>${c.unread?'<div style="width:8px;height:8px;background:var(--primary);border-radius:50%"></div>':''}</div>`).join('');
}

function selectConversation(id) {
    const c = data.conversations.find(x => x.id === id);
    if (!c) return;
    c.unread = false; saveData(); updateAllCounts(); initInbox();
    document.getElementById('inboxMain').innerHTML = `<div style="padding:16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px"><div style="width:44px;height:44px;border-radius:50%;background:${c.type==='whatsapp'?'rgba(37,211,102,0.15)':'rgba(234,67,53,0.15)'};display:flex;align-items:center;justify-content:center">${c.type==='whatsapp'?'üí¨':'üìß'}</div><div><div style="font-weight:600">${c.contact}</div><div style="font-size:12px;color:var(--text-3)">${c.type}</div></div></div><div style="flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:12px">${c.messages.map(m=>`<div style="max-width:70%;padding:12px 16px;border-radius:16px;${m.outgoing?'background:var(--primary);color:white;align-self:flex-end':'background:var(--bg-3);align-self:flex-start'}"><div>${m.text}</div><div style="font-size:10px;${m.outgoing?'color:rgba(255,255,255,0.7)':'color:var(--text-3)'};margin-top:4px;text-align:right">${m.time}</div></div>`).join('')}</div><div style="padding:16px;border-top:1px solid var(--border);display:flex;gap:12px"><textarea id="replyText" class="form-control" style="flex:1;min-height:44px;max-height:100px;resize:none" placeholder="Nachricht..."></textarea><button class="btn btn-primary" onclick="sendReply(${id})">üì§</button></div>`;
}

function sendReply(id) { const text = document.getElementById('replyText').value.trim(); if (!text) return; const c = data.conversations.find(x => x.id === id); if (!c) return; c.messages.push({ text, time: new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }), outgoing: true }); saveData(); selectConversation(id); showToast('success', 'Gesendet', c.contact); }

// INVOICES
function renderInvoices() {
    return `<div class="page active">
        <div class="page-header"><div><h1>üìÑ Rechnungen</h1><p>${data.invoices.length} Rechnungen</p></div><div class="page-actions"><button class="btn btn-primary" onclick="openModal('invoice')">+ Neue Rechnung</button></div></div>
        <div class="stats-grid"><div class="stat-card success"><div class="stat-value">${formatCurrency(data.invoices.filter(i=>i.status==='paid').reduce((s,i)=>s+i.amount,0))}</div><div class="stat-label">Bezahlt</div></div><div class="stat-card warning"><div class="stat-value">${formatCurrency(data.invoices.filter(i=>i.status==='pending').reduce((s,i)=>s+i.amount,0))}</div><div class="stat-label">Offen</div></div><div class="stat-card danger"><div class="stat-value">${formatCurrency(data.invoices.filter(i=>i.status==='overdue').reduce((s,i)=>s+i.amount,0))}</div><div class="stat-label">√úberf√§llig</div></div></div>
        <div class="card"><div class="card-body no-padding"><div class="table-wrapper"><table class="data-table"><thead><tr><th>Nr.</th><th>Kunde</th><th>Betrag</th><th>Status</th><th>Datum</th><th></th></tr></thead><tbody>${data.invoices.map(i=>`<tr><td><strong>${i.id}</strong></td><td>${i.customer}</td><td><strong>${formatCurrency(i.amount)}</strong></td><td><span class="status ${i.status}">${statusLabel(i.status)}</span></td><td>${formatDate(i.date)}</td><td>${i.status!=='paid'?`<button class="btn btn-sm btn-stripe" onclick="payWithStripe('${i.id}')">üí≥</button> <button class="btn btn-sm btn-success" onclick="markPaid('${i.id}')">‚úÖ</button>`:''}</td></tr>`).join('')}</tbody></table></div></div></div>
    </div>`;
}

function markPaid(id) { const inv=data.invoices.find(i=>i.id===id); if(inv){inv.status='paid';saveData();showPage('invoices');showToast('success','Bezahlt',id);} }
function payWithStripe(id) { showToast('stripe','Stripe','Checkout wird ge√∂ffnet...'); }

// PAYMENTS
function renderPayments() {
    return `<div class="page active">
        <div class="page-header"><div><h1>üí≥ Stripe Payments</h1><p>Zahlungen verwalten</p></div><div class="page-actions"><div class="api-status"><span class="dot"></span>Stripe verbunden</div></div></div>
        <div class="stats-grid"><div class="stat-card stripe"><div class="stat-value">${formatCurrency(data.stripe.balance)}</div><div class="stat-label">Balance</div></div><div class="stat-card warning"><div class="stat-value">${formatCurrency(data.stripe.pending)}</div><div class="stat-label">Ausstehend</div></div><div class="stat-card success"><div class="stat-value">${formatCurrency(data.stripe.payouts)}</div><div class="stat-label">Auszahlungen</div></div><div class="stat-card"><div class="stat-value">${formatCurrency(data.stripe.fees)}</div><div class="stat-label">Geb√ºhren</div></div></div>
        <div class="card"><div class="card-header"><h3>üí≥ Letzte Zahlungen</h3></div><div class="card-body no-padding"><div class="table-wrapper"><table class="data-table"><thead><tr><th>Kunde</th><th>Betrag</th><th>Typ</th><th>Status</th><th>Datum</th><th>Methode</th></tr></thead><tbody>${data.payments.map(p=>`<tr><td><strong>${p.customer}</strong></td><td><strong style="color:var(--emerald)">${formatCurrency(p.amount)}</strong></td><td><span class="tag">${p.type}</span></td><td><span class="status ${p.status}">${statusLabel(p.status)}</span></td><td>${formatDate(p.date)}</td><td>${p.method==='card'?`üí≥ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${p.last4}`:'üè¶ SEPA'}</td></tr>`).join('')}</tbody></table></div></div></div>
    </div>`;
}

// SUBSCRIPTIONS
function renderSubscriptions() {
    return `<div class="page active">
        <div class="page-header"><div><h1>üîÑ Abonnements</h1><p>${data.subscriptions.filter(s=>s.status==='active').length} aktive Abos</p></div></div>
        <div class="stats-grid"><div class="stat-card stripe"><div class="stat-value">${formatCurrency(data.subscriptions.filter(s=>s.status==='active').reduce((sum,s)=>sum+s.amount,0))}</div><div class="stat-label">MRR</div></div><div class="stat-card"><div class="stat-value">${data.subscriptions.filter(s=>s.status==='active').length}</div><div class="stat-label">Aktive Abos</div></div></div>
        <div class="card"><div class="card-body no-padding"><div class="table-wrapper"><table class="data-table"><thead><tr><th>Kunde</th><th>Plan</th><th>Betrag</th><th>Status</th><th>N√§chste Zahlung</th></tr></thead><tbody>${data.subscriptions.map(s=>`<tr><td><strong>${s.customer}</strong></td><td><span class="tag ${s.plan==='Enterprise'?'primary':s.plan==='Pro'?'success':''}">${s.plan}</span></td><td><strong>${formatCurrency(s.amount)}</strong>/mo</td><td><span class="status ${s.status}">${statusLabel(s.status)}</span></td><td>${s.status==='active'?formatDate(s.nextBilling):'-'}</td></tr>`).join('')}</tbody></table></div></div></div>
    </div>`;
}

// PROJECTS
function renderProjects() {
    return `<div class="page active">
        <div class="page-header"><div><h1>üìÅ Projekte</h1><p>${data.projects.length} Projekte</p></div></div>
        <div class="grid-2">${data.projects.map(p=>`<div class="card"><div class="card-header"><h3>${p.name}</h3><span class="status ${p.status}">${statusLabel(p.status)}</span></div><div class="card-body"><div style="color:var(--text-3);margin-bottom:16px">${p.customer}</div><div style="margin-bottom:8px"><div style="display:flex;justify-content:space-between;font-size:12px"><span>Fortschritt</span><span>${p.progress}%</span></div><div class="progress-bar lg"><div class="progress-bar-fill gradient" style="width:${p.progress}%"></div></div></div><div style="font-size:13px;margin-top:12px">Budget: <strong>${formatCurrency(p.budget)}</strong></div></div></div>`).join('')}</div>
    </div>`;
}

// TASKS
function renderTasks() {
    return `<div class="page active">
        <div class="page-header"><div><h1>‚úÖ Aufgaben</h1><p>${data.tasks.length} Aufgaben</p></div><div class="page-actions"><button class="btn btn-primary" onclick="openModal('task')">+ Neue Aufgabe</button></div></div>
        <div class="card"><div class="card-body no-padding">${data.tasks.map(t=>`<div style="padding:14px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;${t.status==='completed'?'opacity:0.5':''}"><input type="checkbox" ${t.status==='completed'?'checked':''} onchange="toggleTask(${t.id})" style="width:18px;height:18px"><div style="flex:1"><div style="font-weight:500;${t.status==='completed'?'text-decoration:line-through':''}">${t.title}</div><div style="font-size:12px;color:var(--text-3)">${t.dueDate?formatDate(t.dueDate):''} ${t.priority==='high'?'üî¥':t.priority==='medium'?'üü°':'üü¢'}</div></div><button class="btn btn-sm btn-secondary" onclick="deleteTask(${t.id})">üóëÔ∏è</button></div>`).join('')}</div></div>
    </div>`;
}

function toggleTask(id) { const t=data.tasks.find(x=>x.id===id); if(t){t.status=t.status==='completed'?'pending':'completed';saveData();showPage('tasks');updateAllCounts();} }
function deleteTask(id) { if(!confirm('L√∂schen?'))return; data.tasks=data.tasks.filter(t=>t.id!==id); saveData(); showPage('tasks'); updateAllCounts(); }

// INTEGRATIONS
function renderIntegrations() {
    return `<div class="page active">
        <div class="page-header"><div><h1>üîå Integrationen</h1><p>${data.integrations.filter(i=>i.status==='connected').length}/${data.integrations.length} verbunden</p></div></div>
        <div class="grid-3">${data.integrations.map(i=>`<div class="card" style="${i.status==='connected'?'border-color:var(--emerald)':''}"><div class="card-body"><div style="display:flex;align-items:center;gap:12px;margin-bottom:12px"><div style="width:48px;height:48px;background:var(--bg-3);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px">${i.icon}</div><div><div style="font-weight:600">${i.name}</div><div style="font-size:12px;color:var(--text-3)">${i.category}</div></div><span class="status ${i.status==='connected'?'active':'pending'}">${i.status==='connected'?'‚úì':''}</span></div>${i.credits?`<div style="font-size:12px;color:var(--text-3)">Credits: ${i.credits}</div>`:''}${i.searches?`<div style="font-size:12px;color:var(--text-3)">Suchen: ${i.searches}</div>`:''}</div><div class="card-footer"><button class="btn btn-sm ${i.status==='connected'?'btn-secondary':'btn-primary'}" style="width:100%" onclick="${i.id==='handelsregister'?`showPage('handelsregister')`:''}">${i.status==='connected'?'‚öôÔ∏è Konfigurieren':'üîå Verbinden'}</button></div></div>`).join('')}</div>
    </div>`;
}

// SETTINGS
function renderSettings() {
    return `<div class="page active">
        <div class="page-header"><div><h1>‚öôÔ∏è Einstellungen</h1></div></div>
        <div class="grid-2">
            <div class="card"><div class="card-header"><h3>üè¢ Unternehmen</h3></div><div class="card-body"><div class="form-group"><label>Firma</label><input type="text" class="form-control" value="${data.settings.company.name}"></div><div class="form-group"><label>E-Mail</label><input type="email" class="form-control" value="${data.settings.company.email}"></div><div class="form-group"><label>IBAN</label><input type="text" class="form-control" value="${data.settings.company.iban}"></div><button class="btn btn-primary">üíæ Speichern</button></div></div>
            <div class="card"><div class="card-header"><h3>üé® Darstellung</h3></div><div class="card-body"><div class="form-group"><label>Theme</label><div style="display:flex;gap:12px"><button class="btn ${currentTheme==='dark'?'btn-primary':'btn-secondary'}" onclick="setTheme('dark')">üåô Dark</button><button class="btn ${currentTheme==='light'?'btn-primary':'btn-secondary'}" onclick="setTheme('light')">‚òÄÔ∏è Light</button></div></div></div></div>
        </div>
        <div class="card" style="margin-top:16px"><div class="card-header"><h3>üîë API Keys</h3></div><div class="card-body"><div class="form-group"><label>Explorium API</label><input type="password" class="form-control" value="${EXPLORIUM_API_KEY}" style="font-family:monospace"></div><div class="form-group"><label>Stripe API</label><input type="password" class="form-control" value="${STRIPE_API_KEY.substring(0,30)}..." style="font-family:monospace"></div><div class="form-group"><label>Handelsregister</label><input type="text" class="form-control" value="${HANDELSREGISTER_URL}" readonly style="font-family:monospace"></div></div></div>
        <div class="card" style="margin-top:16px"><div class="card-header"><h3>‚ö†Ô∏è Gefahrenzone</h3></div><div class="card-body"><button class="btn btn-danger" onclick="if(confirm('Alle Daten l√∂schen?')){localStorage.clear();location.reload()}">üóëÔ∏è Alle Daten l√∂schen</button></div></div>
    </div>`;
}

// PROFILE
function renderProfile() {
    return `<div class="page active">
        <div class="page-header"><div><h1>üë§ Profil</h1></div></div>
        <div class="card" style="max-width:500px"><div class="card-body" style="text-align:center;padding:40px"><div style="width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--violet));margin:0 auto 20px;display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:700">${getInitials(currentUser.name)}</div><div style="font-size:24px;font-weight:700">${currentUser.name}</div><div style="color:var(--text-3)">${currentUser.email}</div><div style="margin-top:16px"><span class="tag primary">${currentUser.role==='admin'?'üëë Administrator':'üë§ Benutzer'}</span></div></div></div>
    </div>`;
}

// MODALS
function openModal(type) {
    const modals = {
        contact: `<div class="modal active"><div class="modal-header"><h2>üë§ Neuer Kontakt</h2><button class="modal-close" onclick="closeModal()">√ó</button></div><div class="modal-body"><div class="form-row"><div class="form-group"><label>Vorname</label><input type="text" class="form-control" id="cFirst"></div><div class="form-group"><label>Nachname</label><input type="text" class="form-control" id="cLast"></div></div><div class="form-group"><label>E-Mail</label><input type="email" class="form-control" id="cEmail"></div><div class="form-group"><label>Firma</label><input type="text" class="form-control" id="cCompany"></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Abbrechen</button><button class="btn btn-primary" onclick="saveContact()">Speichern</button></div></div>`,
        lead: `<div class="modal active"><div class="modal-header"><h2>üéØ Neuer Lead</h2><button class="modal-close" onclick="closeModal()">√ó</button></div><div class="modal-body"><div class="form-group"><label>Name</label><input type="text" class="form-control" id="lName"></div><div class="form-group"><label>Firma</label><input type="text" class="form-control" id="lCompany"></div><div class="form-group"><label>Wert (‚Ç¨)</label><input type="number" class="form-control" id="lValue" value="25000"></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Abbrechen</button><button class="btn btn-primary" onclick="saveLead()">Speichern</button></div></div>`,
        task: `<div class="modal active"><div class="modal-header"><h2>‚úÖ Neue Aufgabe</h2><button class="modal-close" onclick="closeModal()">√ó</button></div><div class="modal-body"><div class="form-group"><label>Titel</label><input type="text" class="form-control" id="tTitle"></div><div class="form-group"><label>F√§llig am</label><input type="date" class="form-control" id="tDue"></div><div class="form-group"><label>Priorit√§t</label><select class="form-control" id="tPriority"><option value="high">üî¥ Hoch</option><option value="medium" selected>üü° Mittel</option><option value="low">üü¢ Niedrig</option></select></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Abbrechen</button><button class="btn btn-primary" onclick="saveTask()">Speichern</button></div></div>`,
        invoice: `<div class="modal active"><div class="modal-header"><h2>üìÑ Neue Rechnung</h2><button class="modal-close" onclick="closeModal()">√ó</button></div><div class="modal-body"><div class="form-group"><label>Kunde</label><input type="text" class="form-control" id="iCustomer"></div><div class="form-group"><label>Betrag (‚Ç¨)</label><input type="number" class="form-control" id="iAmount"></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Abbrechen</button><button class="btn btn-primary" onclick="saveInvoice()">Erstellen</button></div></div>`,
        message: `<div class="modal active"><div class="modal-header"><h2>‚úâÔ∏è Nachricht</h2><button class="modal-close" onclick="closeModal()">√ó</button></div><div class="modal-body"><div class="form-group"><label>Kanal</label><select class="form-control" id="msgChannel"><option value="whatsapp">üí¨ WhatsApp</option><option value="email">üìß E-Mail</option></select></div><div class="form-group"><label>Empf√§nger</label><input type="text" class="form-control" id="msgTo"></div><div class="form-group"><label>Nachricht</label><textarea class="form-control" id="msgText" rows="4"></textarea></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Abbrechen</button><button class="btn btn-primary" onclick="sendMsg()">üì§ Senden</button></div></div>`
    };
    openModalWithContent(modals[type] || '<div class="modal active"><div class="modal-body">Coming soon</div></div>');
}

function openModalWithContent(html) { const overlay = document.getElementById('modalOverlay'); overlay.innerHTML = html; overlay.classList.add('active'); }
function closeModal() { document.getElementById('modalOverlay').classList.remove('active'); }

function saveContact() { const first = document.getElementById('cFirst').value.trim(), last = document.getElementById('cLast').value.trim(), email = document.getElementById('cEmail').value.trim(); if (!first || !last || !email) return showToast('error', 'Fehler', 'Pflichtfelder ausf√ºllen'); data.contacts.unshift({ id: generateId(), firstName: first, lastName: last, email, company: document.getElementById('cCompany').value, status: 'active', hrVerified: false }); saveData(); closeModal(); showPage('contacts'); updateAllCounts(); showToast('success', 'Kontakt erstellt', first + ' ' + last); }
function saveLead() { const name = document.getElementById('lName').value.trim(); if (!name) return showToast('error', 'Fehler', 'Name erforderlich'); data.leads.unshift({ id: generateId(), name, company: document.getElementById('lCompany').value, value: parseInt(document.getElementById('lValue').value) || 25000, status: 'new', source: 'Manuell', probability: 40 }); saveData(); closeModal(); showPage('leads'); updateAllCounts(); showToast('success', 'Lead erstellt', name); }
function saveTask() { const title = document.getElementById('tTitle').value.trim(); if (!title) return showToast('error', 'Fehler', 'Titel erforderlich'); data.tasks.unshift({ id: generateId(), title, status: 'pending', priority: document.getElementById('tPriority').value, dueDate: document.getElementById('tDue').value }); saveData(); closeModal(); showPage('tasks'); updateAllCounts(); showToast('success', 'Aufgabe erstellt', title); }
function saveInvoice() { const customer = document.getElementById('iCustomer').value.trim(), amount = parseInt(document.getElementById('iAmount').value); if (!customer || !amount) return showToast('error', 'Fehler', 'Pflichtfelder'); const id = `RE-2025-${String(data.invoices.length + 1).padStart(3, '0')}`; data.invoices.unshift({ id, customer, amount, status: 'pending', date: new Date().toISOString().split('T')[0] }); saveData(); closeModal(); showPage('invoices'); showToast('success', 'Rechnung erstellt', id); }
function sendMsg() { const to = document.getElementById('msgTo').value.trim(), text = document.getElementById('msgText').value.trim(); if (!to || !text) return showToast('error', 'Fehler', 'Felder ausf√ºllen'); data.conversations.unshift({ id: generateId(), contact: to, type: document.getElementById('msgChannel').value, unread: false, messages: [{ text, time: new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }), outgoing: true }] }); saveData(); closeModal(); showToast('success', 'Gesendet', to); }

// KEYBOARD SHORTCUTS
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeModal();
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') { e.preventDefault(); showPage('handelsregister'); document.getElementById('hrKeywords')?.focus(); }
    if ((e.ctrlKey || e.metaKey) && e.key === 'n') { e.preventDefault(); openModal('lead'); }
});

// Show keyboard hints on focus
document.addEventListener('focusin', function(e) {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
        document.getElementById('keyboardHint').classList.add('show');
        setTimeout(() => document.getElementById('keyboardHint').classList.remove('show'), 3000);
    }
});

// INIT
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('loginForm').addEventListener('submit', handleLogin);
    document.getElementById('modalOverlay').addEventListener('click', function(e) { if (e.target === this) closeModal(); });
    if (currentUser) showApp();
});

console.log('‚ö° West Money OS v4.2 Ultimate Edition');
console.log('ü§ñ Explorium API:', EXPLORIUM_API_KEY.substring(0, 10) + '...');
console.log('üí≥ Stripe API:', STRIPE_API_KEY.substring(0, 20) + '...');
console.log('üèõÔ∏è Handelsregister: https://www.handelsregister.de');
</script>
</body>
</html>
