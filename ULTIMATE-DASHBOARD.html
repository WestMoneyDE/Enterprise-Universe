<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Enterprise Universe - Ultimate Dashboard - Complete Business Management System">
    <meta name="theme-color" content="#0a0a0f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="robots" content="noindex, nofollow">
    <title>ULTIMATE DASHBOARD | Enterprise Universe</title>

    <!-- Auth Guard -->
    <script src="/js/auth-guard.js"></script>

    <!-- External Resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Ultimate Dashboard Styles -->
    <link href="/styles/ultimate.css" rel="stylesheet">
</head>
<body>
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         MEGA MENU HEADER
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <header class="header">
        <!-- Brand -->
        <a href="#/" class="header-brand">
            <div class="header-logo">U</div>
            <div>
                <div class="header-title">ULTIMATE</div>
                <div class="header-subtitle">Command Center</div>
            </div>
        </a>

        <!-- Header Actions -->
        <div class="header-actions">
            <div class="header-search" id="search-trigger">
                <span>&#128269;</span>
                <span>Search...</span>
                <kbd>Ctrl+K</kbd>
            </div>
            <div class="header-status">
                <span class="status-dot"></span>
                <span id="haiku-status-text">HAIKU ONLINE</span>
            </div>
            <button class="btn-god-mode" onclick="location.hash='#/ai/haiku'">
                GOD MODE
            </button>
        </div>
    </header>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         LAYOUT CONTAINER WITH SIDEBAR
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="app-layout">
        <!-- Sidebar Navigation -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <span class="sidebar-title">Navigation</span>
                <button class="sidebar-toggle" onclick="document.getElementById('sidebar').classList.toggle('collapsed')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 19l-7-7 7-7M18 19l-7-7 7-7"/>
                    </svg>
                </button>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Main</div>
                    <a href="#/" class="nav-item" data-route="/">
                        <span class="nav-icon">üè†</span>
                        <span class="nav-label">Dashboard</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">CRM</div>
                    <a href="#/crm/contacts" class="nav-item" data-route="/crm/contacts">
                        <span class="nav-icon">üë•</span>
                        <span class="nav-label">Contacts</span>
                    </a>
                    <a href="#/crm/companies" class="nav-item" data-route="/crm/companies">
                        <span class="nav-icon">üè¢</span>
                        <span class="nav-label">Companies</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Sales</div>
                    <a href="#/sales/deals" class="nav-item" data-route="/sales/deals">
                        <span class="nav-icon">üí∞</span>
                        <span class="nav-label">Deals Pipeline</span>
                    </a>
                    <a href="#/sales/leads" class="nav-item" data-route="/sales/leads">
                        <span class="nav-icon">üéØ</span>
                        <span class="nav-label">Lead Discovery</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Communication</div>
                    <a href="#/email" class="nav-item" data-route="/email">
                        <span class="nav-icon">üìß</span>
                        <span class="nav-label">Email Hub</span>
                    </a>
                    <a href="#/whatsapp" class="nav-item" data-route="/whatsapp">
                        <span class="nav-icon">üì±</span>
                        <span class="nav-label">WhatsApp</span>
                    </a>
                    <a href="#/campaigns" class="nav-item" data-route="/campaigns">
                        <span class="nav-icon">üöÄ</span>
                        <span class="nav-label">Campaigns</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">AI</div>
                    <a href="#/ai/bots" class="nav-item" data-route="/ai/bots">
                        <span class="nav-icon">ü§ñ</span>
                        <span class="nav-label">Genius Bots</span>
                    </a>
                    <a href="#/ai/haiku" class="nav-item" data-route="/ai/haiku">
                        <span class="nav-icon">üíé</span>
                        <span class="nav-label">HAIKU God Mode</span>
                    </a>
                    <a href="#/ai/taskforce" class="nav-item" data-route="/ai/taskforce">
                        <span class="nav-icon">‚ö°</span>
                        <span class="nav-label">Broly Taskforce</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Projects</div>
                    <a href="#/projects" class="nav-item" data-route="/projects">
                        <span class="nav-icon">üìÅ</span>
                        <span class="nav-label">All Projects</span>
                    </a>
                    <a href="#/projects/documents" class="nav-item" data-route="/projects/documents">
                        <span class="nav-icon">üìã</span>
                        <span class="nav-label">Documents</span>
                    </a>
                    <a href="#/projects/deliverables" class="nav-item" data-route="/projects/deliverables">
                        <span class="nav-icon">üì¶</span>
                        <span class="nav-label">Deliverables</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Finance</div>
                    <a href="#/finance/money" class="nav-item" data-route="/finance/money">
                        <span class="nav-icon">üíµ</span>
                        <span class="nav-label">Money Management</span>
                    </a>
                    <a href="#/finance/cashflow" class="nav-item" data-route="/finance/cashflow">
                        <span class="nav-icon">üìà</span>
                        <span class="nav-label">Cashflow</span>
                    </a>
                    <a href="#/finance/invoices" class="nav-item" data-route="/finance/invoices">
                        <span class="nav-icon">üìÑ</span>
                        <span class="nav-label">Invoices</span>
                    </a>
                    <a href="#/finance/subscriptions" class="nav-item" data-route="/finance/subscriptions">
                        <span class="nav-icon">üîÑ</span>
                        <span class="nav-label">Subscriptions</span>
                    </a>
                    <a href="#/finance/stripe" class="nav-item" data-route="/finance/stripe">
                        <span class="nav-icon">üí≥</span>
                        <span class="nav-label">Stripe</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">System</div>
                    <a href="#/integrations" class="nav-item" data-route="/integrations">
                        <span class="nav-icon">üîå</span>
                        <span class="nav-label">Integrations</span>
                    </a>
                    <a href="#/settings" class="nav-item" data-route="/settings">
                        <span class="nav-icon">‚öôÔ∏è</span>
                        <span class="nav-label">Settings</span>
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content with-sidebar">
            <div class="content-wrapper" id="app-content">
                <!-- Content loaded dynamically by router -->
                <div class="loading-skeleton" style="height: 200px;"></div>
            </div>
        </main>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         STATUS BAR
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <footer class="status-bar">
        <div class="status-bar-left">
            <span class="status-item connected" id="status-hubspot">
                <span class="status-dot"></span> HubSpot
            </span>
            <span class="status-item connected" id="status-whatsapp">
                <span class="status-dot"></span> WhatsApp
            </span>
            <span class="status-item connected" id="status-stripe">
                <span class="status-dot"></span> Stripe
            </span>
        </div>
        <div class="status-bar-right">
            <span id="last-sync">Last sync: --</span>
            <span id="current-user">User: Admin</span>
        </div>
    </footer>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         MODAL CONTAINER
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal" id="modal-container">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Modal</h3>
                <button class="modal-close" onclick="UltimateApp.closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Modal content loaded dynamically -->
            </div>
            <div class="modal-footer" id="modal-footer">
                <button class="btn btn-secondary" onclick="UltimateApp.closeModal()">Cancel</button>
                <button class="btn btn-primary" id="modal-confirm">Confirm</button>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         JAVASCRIPT - SPA Core
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <script>
    /**
     * ULTIMATE DASHBOARD - Main Application
     * Single Page Application with Mega Menu Navigation
     */

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // UTILITY FUNCTIONS
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    function escapeHtml(text) {
        if (!text) return '';
        var div = document.createElement('div');
        div.textContent = String(text);
        return div.innerHTML;
    }

    function formatCurrency(value, currency) {
        if (value === null || value === undefined) return '-';
        currency = currency || 'EUR';
        return new Intl.NumberFormat('de-DE', {
            style: 'currency',
            currency: currency,
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(value);
    }

    function formatNumber(value) {
        if (value === null || value === undefined) return '-';
        // Already formatted string (contains dots or letters)
        if (typeof value === 'string' && (value.includes('.') || /[a-zA-Z]/.test(value))) {
            return value;
        }
        return new Intl.NumberFormat('de-DE').format(value);
    }

    function formatDate(dateStr) {
        if (!dateStr) return '-';
        return new Date(dateStr).toLocaleDateString('de-DE');
    }

    function formatDateTime(dateStr) {
        if (!dateStr) return '-';
        return new Date(dateStr).toLocaleString('de-DE');
    }

    function formatTimeAgo(date) {
        if (!date) return '';
        var now = new Date();
        var diff = now - date;
        var seconds = Math.floor(diff / 1000);
        var minutes = Math.floor(seconds / 60);
        var hours = Math.floor(minutes / 60);
        var days = Math.floor(hours / 24);

        if (days > 7) return formatDate(date);
        if (days > 0) return days + 'd ago';
        if (hours > 0) return hours + 'h ago';
        if (minutes > 0) return minutes + 'm ago';
        return 'just now';
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // API SERVICE
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    var API = {
        baseUrl: '',

        async get(endpoint) {
            try {
                var response = await fetch(this.baseUrl + endpoint);
                if (!response.ok) throw new Error('API Error: ' + response.status);
                return await response.json();
            } catch (error) {
                console.error('API GET Error:', endpoint, error);
                return null;
            }
        },

        async post(endpoint, data) {
            try {
                var response = await fetch(this.baseUrl + endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!response.ok) throw new Error('API Error: ' + response.status);
                return await response.json();
            } catch (error) {
                console.error('API POST Error:', endpoint, error);
                return null;
            }
        },

        async patch(endpoint, data) {
            try {
                var response = await fetch(this.baseUrl + endpoint, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!response.ok) throw new Error('API Error: ' + response.status);
                return await response.json();
            } catch (error) {
                console.error('API PATCH Error:', endpoint, error);
                return null;
            }
        },

        async delete(endpoint) {
            try {
                var response = await fetch(this.baseUrl + endpoint, {
                    method: 'DELETE'
                });
                if (!response.ok) throw new Error('API Error: ' + response.status);
                return true;
            } catch (error) {
                console.error('API DELETE Error:', endpoint, error);
                return false;
            }
        }
    };

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // DOM HELPER
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    var DOM = {
        el: function(tag, attrs, children) {
            var element = document.createElement(tag);
            if (attrs) {
                Object.keys(attrs).forEach(function(key) {
                    if (key === 'className') {
                        element.className = attrs[key];
                    } else if (key === 'onclick' || key === 'onchange') {
                        element[key] = attrs[key];
                    } else if (key === 'dataset') {
                        Object.keys(attrs[key]).forEach(function(dataKey) {
                            element.dataset[dataKey] = attrs[key][dataKey];
                        });
                    } else {
                        element.setAttribute(key, attrs[key]);
                    }
                });
            }
            if (children !== null && children !== undefined) {
                if (typeof children === 'string' || typeof children === 'number') {
                    element.textContent = String(children);
                } else if (Array.isArray(children)) {
                    children.forEach(function(child) {
                        if (child) element.appendChild(child);
                    });
                } else if (children instanceof Node) {
                    element.appendChild(children);
                }
            }
            return element;
        },

        clear: function(container) {
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }
        }
    };

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // ROUTER
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    var Router = {
        routes: {
            '/': 'renderDashboard',
            '/crm/contacts': 'renderContacts',
            '/crm/companies': 'renderCompanies',
            '/crm/scoring': 'renderLeadScoring',
            '/sales/deals': 'renderDeals',
            '/sales/leads': 'renderLeadDiscovery',
            '/sales/proposals': 'renderProposals',
            '/email': 'renderEmailHub',
            '/whatsapp': 'renderWhatsApp',
            '/campaigns': 'renderCampaigns',
            '/ai/bots': 'renderBots',
            '/ai/haiku': 'renderHaiku',
            '/ai/taskforce': 'renderBrolyTaskforce',
            '/ai/prophecy': 'renderProphecy',
            '/projects': 'renderProjects',
            '/projects/documents': 'renderProjectDocuments',
            '/projects/deliverables': 'renderDeliverables',
            '/finance/money': 'renderMoneyManagement',
            '/finance/cashflow': 'renderCashflow',
            '/finance/invoices': 'renderInvoices',
            '/finance/subscriptions': 'renderSubscriptions',
            '/finance/stripe': 'renderStripe',
            '/integrations': 'renderIntegrations',
            '/settings': 'renderSettings',
            '/docs': 'renderDocs'
        },

        init: function() {
            var self = this;
            window.addEventListener('hashchange', function() {
                self.navigate();
            });
            this.navigate();
        },

        navigate: function() {
            var hash = window.location.hash || '#/';
            var path = hash.replace('#', '') || '/';

            // Update active menu item
            this.updateActiveMenu(path);

            // Find matching route
            var handler = this.routes[path];
            if (handler && typeof Modules[handler] === 'function') {
                Modules[handler]();
            } else {
                Modules.render404();
            }

            // Scroll to top
            window.scrollTo(0, 0);
        },

        updateActiveMenu: function(path) {
            // Remove all active states from mega menu
            document.querySelectorAll('.menu-trigger, .dropdown-item').forEach(function(el) {
                el.classList.remove('active');
            });

            // Remove all active states from sidebar
            document.querySelectorAll('.nav-item').forEach(function(el) {
                el.classList.remove('active');
            });

            // Add active to current
            var selector = '[href="#' + path + '"]';
            var activeEl = document.querySelector(selector);
            if (activeEl) {
                activeEl.classList.add('active');
                // Also highlight parent menu trigger (mega menu)
                var menuItem = activeEl.closest('.menu-item');
                if (menuItem) {
                    var trigger = menuItem.querySelector('.menu-trigger');
                    if (trigger) trigger.classList.add('active');
                }
            }

            // Also activate sidebar nav item
            var sidebarItem = document.querySelector('.sidebar .nav-item[href="#' + path + '"]');
            if (sidebarItem) {
                sidebarItem.classList.add('active');
            }
        }
    };

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // MODULES (Page Renderers)
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    var Modules = {
        container: function() {
            return document.getElementById('app-content');
        },

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // DASHBOARD
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        renderDashboard: async function() {
            var container = this.container();
            DOM.clear(container);

            // Page Header
            var header = DOM.el('div', { className: 'page-header' }, [
                DOM.el('div', {}, [
                    DOM.el('h1', { className: 'page-title' }, 'Dashboard'),
                    DOM.el('p', { className: 'page-subtitle' }, 'Business Overview')
                ]),
                DOM.el('div', { className: 'page-actions' }, [
                    DOM.el('button', { className: 'btn btn-secondary', onclick: function() { location.reload(); } }, 'Refresh'),
                    DOM.el('button', { className: 'btn btn-primary', onclick: function() { location.hash = '#/sales/deals'; } }, '+ New Deal')
                ])
            ]);
            container.appendChild(header);

            // KPI Grid
            var kpiGrid = DOM.el('div', { className: 'grid grid-4 mb-4', id: 'kpi-grid' });
            container.appendChild(kpiGrid);

            // Load KPI data
            this.loadDashboardKPIs(kpiGrid);

            // Two Column Layout
            var twoCol = DOM.el('div', { className: 'grid grid-2', style: 'margin-top: 1.5rem;' });
            container.appendChild(twoCol);

            // Recent Contacts Card
            var contactsCard = DOM.el('div', { className: 'card' }, [
                DOM.el('div', { className: 'card-header' }, [
                    DOM.el('span', { className: 'card-title' }, 'üë• Recent Contacts'),
                    DOM.el('a', { href: '#/crm/contacts', className: 'btn btn-ghost btn-sm' }, 'View All')
                ]),
                DOM.el('div', { className: 'card-body', id: 'recent-contacts' }, [
                    DOM.el('div', { className: 'loading-skeleton', style: 'height: 200px;' })
                ])
            ]);
            twoCol.appendChild(contactsCard);

            // Pipeline Overview Card
            var pipelineCard = DOM.el('div', { className: 'card' }, [
                DOM.el('div', { className: 'card-header' }, [
                    DOM.el('span', { className: 'card-title' }, 'üìä Pipeline Overview'),
                    DOM.el('a', { href: '#/sales/deals', className: 'btn btn-ghost btn-sm' }, 'View Pipeline')
                ]),
                DOM.el('div', { className: 'card-body', id: 'pipeline-overview' }, [
                    DOM.el('div', { className: 'loading-skeleton', style: 'height: 200px;' })
                ])
            ]);
            twoCol.appendChild(pipelineCard);

            // Load data
            this.loadRecentContacts();
            this.loadPipelineOverview();

            // Quick Actions
            var quickActions = DOM.el('div', { className: 'card', style: 'margin-top: 1.5rem;' }, [
                DOM.el('div', { className: 'card-header' }, [
                    DOM.el('span', { className: 'card-title' }, '‚ö° Quick Actions')
                ]),
                DOM.el('div', { className: 'card-body' }, [
                    DOM.el('div', { className: 'grid grid-6' }, [
                        DOM.el('a', { href: '#/crm/contacts', className: 'btn btn-secondary' }, 'üë§ Contacts'),
                        DOM.el('a', { href: '#/sales/deals', className: 'btn btn-secondary' }, 'üí∞ Deals'),
                        DOM.el('a', { href: '#/email', className: 'btn btn-secondary' }, 'üìß Email'),
                        DOM.el('a', { href: '#/ai/bots', className: 'btn btn-secondary' }, 'ü§ñ Bots'),
                        DOM.el('a', { href: '#/finance/invoices', className: 'btn btn-secondary' }, 'üìÑ Invoices'),
                        DOM.el('a', { href: '#/ai/haiku', className: 'btn btn-secondary' }, 'üíé God Mode')
                    ])
                ])
            ]);
            container.appendChild(quickActions);

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // NEUE INTERAKTIVE WIDGETS
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

            // Second Row: Top Deals + Conversion Funnel
            var secondRow = DOM.el('div', { className: 'grid grid-2', style: 'margin-top: 1.5rem; gap: 1.5rem;' });
            container.appendChild(secondRow);

            // Top Deals Widget
            var topDealsCard = DOM.el('div', { className: 'card' }, [
                DOM.el('div', { className: 'card-header' }, [
                    DOM.el('span', { className: 'card-title' }, 'üèÜ Top Deals'),
                    DOM.el('a', { href: '#/sales/deals', className: 'btn btn-ghost btn-sm' }, 'View All')
                ]),
                DOM.el('div', { className: 'card-body', id: 'top-deals-widget' }, [
                    DOM.el('div', { className: 'loading-skeleton', style: 'height: 250px;' })
                ])
            ]);
            secondRow.appendChild(topDealsCard);

            // Conversion Funnel Widget
            var funnelCard = DOM.el('div', { className: 'card' }, [
                DOM.el('div', { className: 'card-header' }, [
                    DOM.el('span', { className: 'card-title' }, 'üìä Conversion Funnel'),
                    DOM.el('span', { className: 'badge badge-info', style: 'font-size: 0.7rem;' }, 'Live')
                ]),
                DOM.el('div', { className: 'card-body', id: 'conversion-funnel-widget' }, [
                    DOM.el('div', { className: 'loading-skeleton', style: 'height: 250px;' })
                ])
            ]);
            secondRow.appendChild(funnelCard);

            // Third Row: Activity Feed + Goals Progress
            var thirdRow = DOM.el('div', { className: 'grid grid-2', style: 'margin-top: 1.5rem; gap: 1.5rem;' });
            container.appendChild(thirdRow);

            // Activity Feed Widget
            var activityCard = DOM.el('div', { className: 'card' }, [
                DOM.el('div', { className: 'card-header' }, [
                    DOM.el('span', { className: 'card-title' }, 'üîî Recent Activity'),
                    DOM.el('button', { className: 'btn btn-ghost btn-sm', onclick: function() { Modules.loadActivityFeed(); } }, 'üîÑ Refresh')
                ]),
                DOM.el('div', { className: 'card-body', id: 'activity-feed-widget', style: 'max-height: 300px; overflow-y: auto;' }, [
                    DOM.el('div', { className: 'loading-skeleton', style: 'height: 250px;' })
                ])
            ]);
            thirdRow.appendChild(activityCard);

            // Goals Progress Widget
            var goalsCard = DOM.el('div', { className: 'card' }, [
                DOM.el('div', { className: 'card-header' }, [
                    DOM.el('span', { className: 'card-title' }, 'üéØ Sales Goals'),
                    DOM.el('span', { className: 'badge badge-success', style: 'font-size: 0.7rem;' }, 'Q1 2026')
                ]),
                DOM.el('div', { className: 'card-body', id: 'goals-progress-widget' }, [
                    DOM.el('div', { className: 'loading-skeleton', style: 'height: 250px;' })
                ])
            ]);
            thirdRow.appendChild(goalsCard);

            // Auto Lead Discovery Widget
            var leadDiscoveryCard = DOM.el('div', { className: 'card', style: 'margin-top: 1.5rem;' }, [
                DOM.el('div', { className: 'card-header' }, [
                    DOM.el('span', { className: 'card-title' }, 'üîç Auto Lead Discovery'),
                    DOM.el('div', { className: 'flex gap-2 items-center' }, [
                        DOM.el('span', { id: 'lead-discovery-status', className: 'badge badge-info', style: 'font-size: 0.7rem;' }, 'Ready'),
                        DOM.el('button', { className: 'btn btn-primary btn-sm', onclick: function() { UltimateApp.startLeadDiscovery(); } }, 'üöÄ Scan Now')
                    ])
                ]),
                DOM.el('div', { className: 'card-body', id: 'lead-discovery-widget' }, [
                    DOM.el('div', { className: 'grid grid-3', style: 'gap: 1rem;' }, [
                        DOM.el('div', { className: 'kpi-card info', style: 'padding: 1rem;' }, [
                            DOM.el('div', { className: 'kpi-label' }, 'New Leads'),
                            DOM.el('div', { id: 'ld-new-leads', className: 'kpi-value', style: 'font-size: 1.5rem;' }, '-')
                        ]),
                        DOM.el('div', { className: 'kpi-card success', style: 'padding: 1rem;' }, [
                            DOM.el('div', { className: 'kpi-label' }, 'Hot Leads'),
                            DOM.el('div', { id: 'ld-hot-leads', className: 'kpi-value', style: 'font-size: 1.5rem;' }, '-')
                        ]),
                        DOM.el('div', { className: 'kpi-card warning', style: 'padding: 1rem;' }, [
                            DOM.el('div', { className: 'kpi-label' }, 'Last Scan'),
                            DOM.el('div', { id: 'ld-last-scan', className: 'kpi-value', style: 'font-size: 0.9rem;' }, 'Never')
                        ])
                    ]),
                    DOM.el('div', { id: 'lead-discovery-results', style: 'margin-top: 1rem; max-height: 200px; overflow-y: auto;' })
                ])
            ]);
            container.appendChild(leadDiscoveryCard);

            // Fourth Row: Revenue Chart (Full Width)
            var revenueChartCard = DOM.el('div', { className: 'card', style: 'margin-top: 1.5rem;' }, [
                DOM.el('div', { className: 'card-header' }, [
                    DOM.el('span', { className: 'card-title' }, 'üìà Monthly Revenue Trend'),
                    DOM.el('div', { className: 'flex gap-2' }, [
                        DOM.el('button', { className: 'btn btn-ghost btn-sm active', id: 'chart-6m', onclick: function() { Modules.loadRevenueChart(6); } }, '6M'),
                        DOM.el('button', { className: 'btn btn-ghost btn-sm', id: 'chart-12m', onclick: function() { Modules.loadRevenueChart(12); } }, '12M'),
                        DOM.el('button', { className: 'btn btn-ghost btn-sm', id: 'chart-ytd', onclick: function() { Modules.loadRevenueChart('ytd'); } }, 'YTD')
                    ])
                ]),
                DOM.el('div', { className: 'card-body', id: 'revenue-chart-widget', style: 'height: 200px;' }, [
                    DOM.el('div', { className: 'loading-skeleton', style: 'height: 180px;' })
                ])
            ]);
            container.appendChild(revenueChartCard);

            // Load all new widgets
            this.loadTopDeals();
            this.loadConversionFunnel();
            this.loadActivityFeed();
            this.loadGoalsProgress();
            this.loadRevenueChart(6);
        },

        loadDashboardKPIs: async function(grid) {
            var data = await API.get('/api/overview');
            DOM.clear(grid);

            var metrics = data && data.metrics ? data.metrics : {};

            var kpis = [
                { label: 'Revenue', value: metrics.revenue ? metrics.revenue.value : '-', change: metrics.revenue ? metrics.revenue.change : '', type: 'primary', icon: 'üí∞' },
                { label: 'Pipeline', value: metrics.pipeline ? metrics.pipeline.value : '-', change: metrics.pipeline ? metrics.pipeline.change : '', type: 'success', icon: 'üìà' },
                { label: 'Contacts', value: metrics.contacts ? formatNumber(metrics.contacts.value) : '-', change: metrics.contacts ? '+' + metrics.contacts.change : '', type: 'info', icon: 'üë•' },
                { label: 'Tasks Today', value: metrics.tasksToday || '0', change: 'active', type: 'warning', icon: '‚úÖ' }
            ];

            kpis.forEach(function(kpi) {
                var card = DOM.el('div', { className: 'kpi-card ' + kpi.type + ' animate-slide-up' }, [
                    DOM.el('div', { className: 'kpi-header' }, [
                        DOM.el('span', { className: 'kpi-label' }, kpi.label),
                        DOM.el('span', { className: 'kpi-icon' }, kpi.icon)
                    ]),
                    DOM.el('div', { className: 'kpi-value' }, kpi.value),
                    DOM.el('div', { className: 'kpi-change positive' }, kpi.change)
                ]);
                grid.appendChild(card);
            });
        },

        loadRecentContacts: async function() {
            var container = document.getElementById('recent-contacts');
            var data = await API.get('/api/hubspot/contacts?limit=5');
            DOM.clear(container);

            var contacts = data && (data.results || data.contacts) || [];
            if (contacts.length === 0) {
                container.appendChild(DOM.el('div', { className: 'empty-state' }, [
                    DOM.el('div', { className: 'empty-state-icon' }, 'üë§'),
                    DOM.el('div', { className: 'empty-state-title' }, 'No contacts yet'),
                    DOM.el('div', { className: 'empty-state-text' }, 'Add your first contact to get started')
                ]));
                return;
            }

            var list = DOM.el('div', { className: 'flex flex-col gap-2' });
            contacts.forEach(function(contact) {
                var props = contact.properties || {};
                var name = [props.firstname, props.lastname].filter(Boolean).join(' ') || 'Unknown';
                var initials = name.split(' ').map(function(n) { return n[0]; }).join('').toUpperCase().slice(0, 2);

                var row = DOM.el('div', { className: 'flex items-center gap-3', style: 'padding: 0.5rem; border-radius: 8px; cursor: pointer;', onclick: function() { UltimateApp.showContactDetail(contact.id); } }, [
                    DOM.el('div', { className: 'contact-avatar', style: 'width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, #8b5cf6, #3b82f6); display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600;' }, initials),
                    DOM.el('div', { className: 'flex-1' }, [
                        DOM.el('div', { style: 'font-weight: 500;' }, escapeHtml(name)),
                        DOM.el('div', { style: 'font-size: 0.8rem; color: var(--text-muted);' }, escapeHtml(props.email || ''))
                    ]),
                    DOM.el('div', { style: 'font-size: 0.8rem; color: var(--text-muted);' }, escapeHtml(props.company || ''))
                ]);
                list.appendChild(row);
            });
            container.appendChild(list);
        },

        loadPipelineOverview: async function() {
            var container = document.getElementById('pipeline-overview');
            var data = await API.get('/api/hubspot/deals?limit=100');
            DOM.clear(container);

            var deals = data && (data.results || data.deals) || [];
            if (deals.length === 0) {
                container.textContent = 'Could not load pipeline data';
                return;
            }

            // Group by stage
            var stages = {};
            var stageNames = {
                'qualifiedtobuy': 'Qualified',
                'presentationscheduled': 'Presentation',
                'decisionmakerboughtin': 'Decision',
                'negotiation': 'Negotiation',
                'closedwon': 'Won',
                'closedlost': 'Lost'
            };

            deals.forEach(function(deal) {
                var stage = deal.properties && deal.properties.dealstage ? deal.properties.dealstage : 'unknown';
                if (!stages[stage]) stages[stage] = { count: 0, value: 0 };
                stages[stage].count++;
                stages[stage].value += parseFloat(deal.properties && deal.properties.amount ? deal.properties.amount : 0);
            });

            var grid = DOM.el('div', { className: 'grid grid-3 gap-3' });
            Object.keys(stages).slice(0, 6).forEach(function(stage) {
                var stageName = stageNames[stage] || stage;
                var stageData = stages[stage];
                var colorClass = stage === 'closedwon' ? 'text-success' : (stage === 'closedlost' ? 'text-error' : 'text-info');

                var stageCard = DOM.el('div', { style: 'background: var(--bg-elevated); border-radius: 12px; padding: 1rem;' }, [
                    DOM.el('div', { className: 'flex justify-between items-center mb-2' }, [
                        DOM.el('span', { className: colorClass, style: 'font-weight: 500; font-size: 0.9rem;' }, stageName),
                        DOM.el('span', { style: 'font-size: 0.8rem; color: var(--text-muted);' }, String(stageData.count))
                    ]),
                    DOM.el('div', { style: 'font-size: 1.25rem; font-weight: 700;' }, formatCurrency(stageData.value))
                ]);
                grid.appendChild(stageCard);
            });
            container.appendChild(grid);
        },

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // INTERACTIVE DASHBOARD WIDGETS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        loadTopDeals: async function() {
            var container = document.getElementById('top-deals-widget');
            if (!container) return;

            var data = await API.get('/api/hubspot/deals?limit=100');
            DOM.clear(container);

            var deals = data && (data.deals || data.results) || [];
            if (deals.length === 0) {
                container.appendChild(DOM.el('div', { className: 'empty-state' }, 'No deals found'));
                return;
            }

            // Sort by amount and take top 5
            deals.sort(function(a, b) {
                var amountA = parseFloat(a.properties && a.properties.amount ? a.properties.amount : 0);
                var amountB = parseFloat(b.properties && b.properties.amount ? b.properties.amount : 0);
                return amountB - amountA;
            });

            var topDeals = deals.slice(0, 5);
            var maxAmount = parseFloat(topDeals[0].properties && topDeals[0].properties.amount ? topDeals[0].properties.amount : 1);

            var list = DOM.el('div', { className: 'flex flex-col gap-3' });
            topDeals.forEach(function(deal, index) {
                var props = deal.properties || {};
                var amount = parseFloat(props.amount || 0);
                var percentage = (amount / maxAmount * 100).toFixed(0);
                var stageColors = {
                    'qualifiedtobuy': 'var(--info)',
                    'presentationscheduled': 'var(--accent-primary)',
                    'decisionmakerboughtin': 'var(--warning)',
                    'negotiation': 'var(--accent-secondary)',
                    'closedwon': 'var(--success)',
                    'closedlost': 'var(--error)'
                };
                var color = stageColors[props.dealstage] || 'var(--info)';

                var row = DOM.el('div', { style: 'background: var(--bg-elevated); border-radius: 10px; padding: 0.75rem; cursor: pointer;', onclick: function() { UltimateApp.showDealDetail(deal.id); } }, [
                    DOM.el('div', { className: 'flex justify-between items-center mb-2' }, [
                        DOM.el('div', { className: 'flex items-center gap-2' }, [
                            DOM.el('span', { style: 'font-size: 1.2rem; font-weight: 700; color: var(--text-muted);' }, '#' + (index + 1)),
                            DOM.el('span', { style: 'font-weight: 500; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;' }, escapeHtml(props.dealname || 'Unnamed'))
                        ]),
                        DOM.el('span', { style: 'font-weight: 700; color: ' + color + ';' }, formatCurrency(amount))
                    ]),
                    DOM.el('div', { style: 'height: 6px; background: var(--bg-base); border-radius: 3px; overflow: hidden;' }, [
                        DOM.el('div', { style: 'height: 100%; width: ' + percentage + '%; background: ' + color + '; border-radius: 3px; transition: width 0.5s ease;' })
                    ])
                ]);
                list.appendChild(row);
            });

            container.appendChild(list);
        },

        loadConversionFunnel: async function() {
            var container = document.getElementById('conversion-funnel-widget');
            if (!container) return;

            var data = await API.get('/api/hubspot/deals/all');
            DOM.clear(container);

            var deals = data && data.deals || [];

            // Count by stage
            var stageCounts = {
                'qualifiedtobuy': 0,
                'presentationscheduled': 0,
                'decisionmakerboughtin': 0,
                'negotiation': 0,
                'closedwon': 0,
                'closedlost': 0
            };

            deals.forEach(function(deal) {
                var stage = deal.properties && deal.properties.dealstage ? deal.properties.dealstage : 'unknown';
                if (stageCounts[stage] !== undefined) {
                    stageCounts[stage]++;
                }
            });

            var stages = [
                { id: 'qualifiedtobuy', name: 'Qualified', color: 'var(--info)' },
                { id: 'presentationscheduled', name: 'Presentation', color: 'var(--accent-primary)' },
                { id: 'decisionmakerboughtin', name: 'Decision Maker', color: 'var(--warning)' },
                { id: 'negotiation', name: 'Negotiation', color: 'var(--accent-secondary)' },
                { id: 'closedwon', name: 'Won', color: 'var(--success)' }
            ];

            var maxCount = Math.max.apply(null, stages.map(function(s) { return stageCounts[s.id]; })) || 1;

            var funnel = DOM.el('div', { className: 'flex flex-col gap-2' });

            stages.forEach(function(stage, index) {
                var count = stageCounts[stage.id];
                var width = Math.max(30, (count / maxCount * 100));
                var nextCount = stages[index + 1] ? stageCounts[stages[index + 1].id] : null;
                var convRate = nextCount !== null && count > 0 ? ((nextCount / count) * 100).toFixed(0) : null;

                var row = DOM.el('div', { style: 'display: flex; align-items: center; gap: 1rem;' }, [
                    DOM.el('div', { style: 'width: 100px; font-size: 0.8rem; text-align: right; color: var(--text-muted);' }, stage.name),
                    DOM.el('div', { style: 'flex: 1; position: relative;' }, [
                        DOM.el('div', { style: 'height: 32px; width: ' + width + '%; background: ' + stage.color + '; border-radius: 6px; display: flex; align-items: center; justify-content: center; transition: width 0.5s ease; cursor: pointer;', onclick: function() { UltimateApp.showStageDetail(stage.id, stage.name); } }, [
                            DOM.el('span', { style: 'color: white; font-weight: 600; font-size: 0.9rem;' }, String(count))
                        ])
                    ]),
                    convRate !== null ? DOM.el('div', { style: 'width: 50px; font-size: 0.75rem; color: var(--text-muted);' }, convRate + '%') : DOM.el('div', { style: 'width: 50px;' })
                ]);
                funnel.appendChild(row);
            });

            // Add Lost count separately
            var lostRow = DOM.el('div', { style: 'display: flex; align-items: center; gap: 1rem; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--border);' }, [
                DOM.el('div', { style: 'width: 100px; font-size: 0.8rem; text-align: right; color: var(--error);' }, 'Lost'),
                DOM.el('div', { style: 'flex: 1;' }, [
                    DOM.el('span', { style: 'color: var(--error); font-weight: 600;' }, String(stageCounts['closedlost']))
                ]),
                DOM.el('div', { style: 'width: 50px;' })
            ]);
            funnel.appendChild(lostRow);

            container.appendChild(funnel);
        },

        loadActivityFeed: async function() {
            var container = document.getElementById('activity-feed-widget');
            if (!container) return;

            // Fetch recent contacts and deals for activity simulation
            var contactsData = await API.get('/api/hubspot/contacts?limit=10');
            var dealsData = await API.get('/api/hubspot/deals?limit=10');
            DOM.clear(container);

            var activities = [];

            // Create activity entries from contacts
            var contacts = contactsData && (contactsData.contacts || contactsData.results) || [];
            contacts.forEach(function(contact) {
                var props = contact.properties || {};
                var created = props.createdate ? new Date(props.createdate) : new Date();
                activities.push({
                    type: 'contact',
                    icon: String.fromCodePoint(0x1F464),
                    title: 'New Contact: ' + [props.firstname, props.lastname].filter(Boolean).join(' '),
                    subtitle: props.email || '',
                    time: created,
                    color: 'var(--info)'
                });
            });

            // Create activity entries from deals
            var deals = dealsData && (dealsData.deals || dealsData.results) || [];
            deals.forEach(function(deal) {
                var props = deal.properties || {};
                var created = props.createdate ? new Date(props.createdate) : new Date();
                var stageNames = {
                    'closedwon': 'Won',
                    'closedlost': 'Lost',
                    'negotiation': 'In Negotiation',
                    'decisionmakerboughtin': 'Decision Maker',
                    'presentationscheduled': 'Presentation',
                    'qualifiedtobuy': 'Qualified'
                };
                var stageName = stageNames[props.dealstage] || props.dealstage;
                var icon = props.dealstage === 'closedwon' ? String.fromCodePoint(0x1F3C6) : String.fromCodePoint(0x1F4B0);
                var color = props.dealstage === 'closedwon' ? 'var(--success)' : (props.dealstage === 'closedlost' ? 'var(--error)' : 'var(--accent-primary)');

                activities.push({
                    type: 'deal',
                    icon: icon,
                    title: 'Deal: ' + (props.dealname || 'Unnamed'),
                    subtitle: formatCurrency(parseFloat(props.amount || 0)) + ' - ' + stageName,
                    time: created,
                    color: color
                });
            });

            // Sort by time (newest first)
            activities.sort(function(a, b) { return b.time - a.time; });

            // Display top 8 activities
            var list = DOM.el('div', { className: 'flex flex-col gap-2' });
            activities.slice(0, 8).forEach(function(activity) {
                var timeAgo = formatTimeAgo(activity.time);

                var row = DOM.el('div', { style: 'display: flex; gap: 0.75rem; padding: 0.5rem; border-radius: 8px; cursor: pointer;', onmouseover: function() { this.style.background = 'var(--bg-elevated)'; }, onmouseout: function() { this.style.background = 'transparent'; } }, [
                    DOM.el('div', { style: 'width: 32px; height: 32px; border-radius: 50%; background: var(--bg-elevated); display: flex; align-items: center; justify-content: center; font-size: 1rem;' }, activity.icon),
                    DOM.el('div', { style: 'flex: 1; min-width: 0;' }, [
                        DOM.el('div', { style: 'font-size: 0.85rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;' }, escapeHtml(activity.title)),
                        DOM.el('div', { style: 'font-size: 0.75rem; color: var(--text-muted);' }, escapeHtml(activity.subtitle))
                    ]),
                    DOM.el('div', { style: 'font-size: 0.7rem; color: var(--text-muted); white-space: nowrap;' }, timeAgo)
                ]);
                list.appendChild(row);
            });

            container.appendChild(list);
        },

        loadGoalsProgress: async function() {
            var container = document.getElementById('goals-progress-widget');
            if (!container) return;

            // Fetch deals data for revenue calculations
            var dealsData = await API.get('/api/hubspot/deals/all');
            DOM.clear(container);

            var deals = dealsData && dealsData.deals || [];

            // Calculate metrics
            var wonDeals = deals.filter(function(d) { return d.properties && d.properties.dealstage === 'closedwon'; });
            var wonRevenue = wonDeals.reduce(function(sum, d) { return sum + parseFloat(d.properties && d.properties.amount ? d.properties.amount : 0); }, 0);

            var pipelineDeals = deals.filter(function(d) {
                var stage = d.properties && d.properties.dealstage;
                return stage && stage !== 'closedwon' && stage !== 'closedlost';
            });
            var pipelineValue = pipelineDeals.reduce(function(sum, d) { return sum + parseFloat(d.properties && d.properties.amount ? d.properties.amount : 0); }, 0);

            // Define goals (these could be dynamic in future)
            var goals = [
                { label: 'Revenue Goal', current: wonRevenue, target: 5000000, icon: String.fromCodePoint(0x1F4B0), color: 'var(--success)' },
                { label: 'Pipeline Goal', current: pipelineValue, target: 100000000, icon: String.fromCodePoint(0x1F4C8), color: 'var(--accent-primary)' },
                { label: 'Deals Closed', current: wonDeals.length, target: 50, icon: String.fromCodePoint(0x1F3C6), color: 'var(--warning)', isCount: true },
                { label: 'Active Deals', current: pipelineDeals.length, target: 500, icon: String.fromCodePoint(0x1F4BC), color: 'var(--info)', isCount: true }
            ];

            var list = DOM.el('div', { className: 'flex flex-col gap-4' });

            goals.forEach(function(goal) {
                var percentage = Math.min(100, (goal.current / goal.target * 100));
                var displayCurrent = goal.isCount ? String(goal.current) : formatCurrency(goal.current);
                var displayTarget = goal.isCount ? String(goal.target) : formatCurrency(goal.target);

                var row = DOM.el('div', {}, [
                    DOM.el('div', { className: 'flex justify-between items-center mb-1' }, [
                        DOM.el('div', { className: 'flex items-center gap-2' }, [
                            DOM.el('span', {}, goal.icon),
                            DOM.el('span', { style: 'font-size: 0.85rem; font-weight: 500;' }, goal.label)
                        ]),
                        DOM.el('span', { style: 'font-size: 0.8rem; color: var(--text-muted);' }, displayCurrent + ' / ' + displayTarget)
                    ]),
                    DOM.el('div', { style: 'height: 8px; background: var(--bg-elevated); border-radius: 4px; overflow: hidden;' }, [
                        DOM.el('div', { style: 'height: 100%; width: ' + percentage + '%; background: ' + goal.color + '; border-radius: 4px; transition: width 0.5s ease;' })
                    ]),
                    DOM.el('div', { style: 'font-size: 0.75rem; color: ' + goal.color + '; margin-top: 2px; text-align: right;' }, percentage.toFixed(1) + '%')
                ]);
                list.appendChild(row);
            });

            container.appendChild(list);
        },

        loadRevenueChart: async function(period) {
            var container = document.getElementById('revenue-chart-widget');
            if (!container) return;

            // Update button states
            ['6m', '12m', 'ytd'].forEach(function(p) {
                var btn = document.getElementById('chart-' + p);
                if (btn) btn.classList.toggle('active', p === String(period) || p === period);
            });

            var dealsData = await API.get('/api/hubspot/deals/all');
            DOM.clear(container);

            var deals = dealsData && dealsData.deals || [];

            // Get won deals with close dates
            var wonDeals = deals.filter(function(d) {
                return d.properties && d.properties.dealstage === 'closedwon' && d.properties.closedate;
            });

            // Group by month
            var monthlyRevenue = {};
            var now = new Date();
            var monthsToShow = period === 'ytd' ? now.getMonth() + 1 : parseInt(period) || 6;

            // Initialize months
            for (var i = monthsToShow - 1; i >= 0; i--) {
                var d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                var key = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
                monthlyRevenue[key] = 0;
            }

            // Sum revenue by month
            wonDeals.forEach(function(deal) {
                var closeDate = new Date(deal.properties.closedate);
                var key = closeDate.getFullYear() + '-' + String(closeDate.getMonth() + 1).padStart(2, '0');
                if (monthlyRevenue[key] !== undefined) {
                    monthlyRevenue[key] += parseFloat(deal.properties.amount || 0);
                }
            });

            var months = Object.keys(monthlyRevenue).sort();
            var values = months.map(function(m) { return monthlyRevenue[m]; });
            var maxValue = Math.max.apply(null, values) || 1;

            // Create bar chart
            var chart = DOM.el('div', { style: 'display: flex; align-items: flex-end; justify-content: space-around; height: 150px; padding: 1rem 0;' });

            months.forEach(function(month, index) {
                var value = values[index];
                var height = Math.max(5, (value / maxValue * 120));
                var monthName = new Date(month + '-01').toLocaleDateString('de-DE', { month: 'short' });

                var bar = DOM.el('div', { style: 'display: flex; flex-direction: column; align-items: center; gap: 0.25rem;' }, [
                    DOM.el('div', { style: 'font-size: 0.65rem; color: var(--text-muted); transform: rotate(-45deg); white-space: nowrap;' }, formatCurrency(value, true)),
                    DOM.el('div', { style: 'width: 30px; height: ' + height + 'px; background: linear-gradient(180deg, var(--accent-primary), var(--accent-secondary)); border-radius: 4px 4px 0 0; transition: height 0.5s ease; cursor: pointer;', title: month + ': ' + formatCurrency(value) }),
                    DOM.el('div', { style: 'font-size: 0.7rem; color: var(--text-muted);' }, monthName)
                ]);
                chart.appendChild(bar);
            });

            container.appendChild(chart);
        },

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CRM - CONTACTS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        contactsPage: 0,
        contactsPerPage: 50,
        invoicesPage: 0,
        invoicesPerPage: 30,
        invoicesSort: 'score',
        invoicesOrder: 'desc',
        stripePage: 0,
        stripePerPage: 25,
        stripeLastId: null,
        stripeFirstId: null,
        stripeHasMore: false,
        stripeHistory: [],

        renderContacts: async function() {
            var container = this.container();
            DOM.clear(container);
            this.contactsPage = 0;

            var header = DOM.el('div', { className: 'page-header' }, [
                DOM.el('div', {}, [
                    DOM.el('h1', { className: 'page-title' }, 'Contacts'),
                    DOM.el('p', { className: 'page-subtitle' }, 'Manage your CRM contacts')
                ]),
                DOM.el('div', { className: 'page-actions' }, [
                    DOM.el('button', { className: 'btn btn-primary', onclick: function() { UltimateApp.showNewContactModal(); } }, '+ New Contact')
                ])
            ]);
            container.appendChild(header);

            // Table Card
            var card = DOM.el('div', { className: 'card' }, [
                DOM.el('div', { className: 'card-body' }, [
                    DOM.el('div', { className: 'table-container', id: 'contacts-table' }, [
                        DOM.el('div', { className: 'loading-skeleton', style: 'height: 300px;' })
                    ]),
                    DOM.el('div', { className: 'pagination', id: 'contacts-pagination', style: 'display: flex; justify-content: center; gap: 1rem; margin-top: 1rem;' })
                ])
            ]);
            container.appendChild(card);

            this.loadContactsTable(0);
        },

        loadContactsTable: async function(page) {
            var self = this;
            if (page === undefined) page = this.contactsPage;
            this.contactsPage = page;
            var tableContainer = document.getElementById('contacts-table');
            var paginationContainer = document.getElementById('contacts-pagination');
            var offset = page * this.contactsPerPage;
            var data = await API.get('/api/hubspot/contacts?limit=' + this.contactsPerPage + '&offset=' + offset);
            DOM.clear(tableContainer);

            var contacts = data && (data.results || data.contacts) || [];
            var total = data && data.total || 0;
            var totalPages = Math.ceil(total / this.contactsPerPage);

            if (contacts.length === 0 && page === 0) {
                tableContainer.appendChild(DOM.el('div', { className: 'empty-state' }, [
                    DOM.el('div', { className: 'empty-state-icon' }, 'üë§'),
                    DOM.el('div', { className: 'empty-state-title' }, 'No contacts yet'),
                    DOM.el('button', { className: 'btn btn-primary', onclick: function() { UltimateApp.showNewContactModal(); } }, '+ Add First Contact')
                ]));
                return;
            }

            var table = DOM.el('table', { className: 'table' });

            // Header
            var thead = DOM.el('thead', {}, [
                DOM.el('tr', {}, [
                    DOM.el('th', {}, 'Name'),
                    DOM.el('th', {}, 'Email'),
                    DOM.el('th', {}, 'Company'),
                    DOM.el('th', {}, 'Phone'),
                    DOM.el('th', {}, 'Created'),
                    DOM.el('th', {}, 'Actions')
                ])
            ]);
            table.appendChild(thead);

            // Body
            var tbody = DOM.el('tbody');
            contacts.forEach(function(contact) {
                var props = contact.properties || {};
                var name = [props.firstname, props.lastname].filter(Boolean).join(' ') || 'Unknown';

                var row = DOM.el('tr', {}, [
                    DOM.el('td', { style: 'font-weight: 500;' }, escapeHtml(name)),
                    DOM.el('td', {}, escapeHtml(props.email || '-')),
                    DOM.el('td', {}, escapeHtml(props.company || '-')),
                    DOM.el('td', {}, escapeHtml(props.phone || '-')),
                    DOM.el('td', {}, formatDate(props.createdate)),
                    DOM.el('td', {}, [
                        DOM.el('button', { className: 'btn btn-ghost btn-sm', onclick: function() { UltimateApp.showContactDetail(contact.id); } }, 'View'),
                        DOM.el('button', { className: 'btn btn-ghost btn-sm', onclick: function() { UltimateApp.editContact(contact.id); } }, 'Edit')
                    ])
                ]);
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            tableContainer.appendChild(table);

            // Pagination Controls
            if (paginationContainer && totalPages > 1) {
                DOM.clear(paginationContainer);
                var prevBtn = DOM.el('button', {
                    className: 'btn btn-secondary',
                    onclick: function() { if (page > 0) self.loadContactsTable(page - 1); },
                    disabled: page === 0
                }, '‚Üê Zur√ºck');
                var pageInfo = DOM.el('span', { style: 'display: flex; align-items: center; color: var(--text-muted);' },
                    'Seite ' + (page + 1) + ' von ' + totalPages + ' (' + formatNumber(total) + ' Kontakte)');
                var nextBtn = DOM.el('button', {
                    className: 'btn btn-secondary',
                    onclick: function() { if (page < totalPages - 1) self.loadContactsTable(page + 1); },
                    disabled: page >= totalPages - 1
                }, 'Weiter ‚Üí');
                paginationContainer.appendChild(prevBtn);
                paginationContainer.appendChild(pageInfo);
                paginationContainer.appendChild(nextBtn);
            }
        },

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SALES - DEALS PIPELINE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        renderDeals: async function() {
            var container = this.container();
            DOM.clear(container);

            var header = DOM.el('div', { className: 'page-header' }, [
                DOM.el('div', {}, [
                    DOM.el('h1', { className: 'page-title' }, 'Deals Pipeline'),
                    DOM.el('p', { className: 'page-subtitle' }, 'Interaktive Sales Pipeline mit Statistiken')
                ]),
                DOM.el('div', { className: 'page-actions' }, [
                    DOM.el('button', { className: 'btn btn-ghost', onclick: function() { Modules.loadDealsKanban(); } }, 'üîÑ Refresh'),
                    DOM.el('button', { className: 'btn btn-primary', onclick: function() { UltimateApp.showNewDealModal(); } }, '+ New Deal')
                ])
            ]);
            container.appendChild(header);

            // Pipeline Stats Grid
            var statsGrid = DOM.el('div', { className: 'grid grid-4', id: 'pipeline-stats', style: 'margin-bottom: 1.5rem;' }, [
                DOM.el('div', { className: 'loading-skeleton', style: 'height: 100px;' }),
                DOM.el('div', { className: 'loading-skeleton', style: 'height: 100px;' }),
                DOM.el('div', { className: 'loading-skeleton', style: 'height: 100px;' }),
                DOM.el('div', { className: 'loading-skeleton', style: 'height: 100px;' })
            ]);
            container.appendChild(statsGrid);

            // Win Rate Progress Bar
            var winRateCard = DOM.el('div', { className: 'card mb-4', id: 'win-rate-card' }, [
                DOM.el('div', { className: 'card-body', style: 'padding: 1rem 1.5rem;' }, [
                    DOM.el('div', { className: 'flex justify-between items-center mb-2' }, [
                        DOM.el('span', { style: 'font-weight: 600; color: var(--text-primary);' }, 'üèÜ Win Rate'),
                        DOM.el('span', { id: 'win-rate-value', style: 'font-size: 1.5rem; font-weight: 700; color: var(--success);' }, '-%')
                    ]),
                    DOM.el('div', { style: 'background: var(--bg-secondary); border-radius: 8px; height: 12px; overflow: hidden;' }, [
                        DOM.el('div', { id: 'win-rate-bar', style: 'height: 100%; background: linear-gradient(90deg, var(--success), var(--accent-primary)); width: 0%; transition: width 1s ease;' })
                    ]),
                    DOM.el('div', { className: 'flex justify-between mt-2', style: 'font-size: 0.75rem; color: var(--text-muted);' }, [
                        DOM.el('span', { id: 'won-count' }, '- Won'),
                        DOM.el('span', { id: 'lost-count' }, '- Lost'),
                        DOM.el('span', { id: 'open-count' }, '- Open')
                    ])
                ])
            ]);
            container.appendChild(winRateCard);

            // Kanban Board with scroll wrapper
            var kanbanWrapper = DOM.el('div', { className: 'kanban-wrapper', style: 'overflow-x: auto; margin: 0 -1.5rem; padding: 0 1.5rem;' });
            var kanban = DOM.el('div', { className: 'kanban-board', id: 'deals-kanban' }, [
                DOM.el('div', { className: 'loading-skeleton', style: 'height: 400px; width: 100%;' })
            ]);
            kanbanWrapper.appendChild(kanban);
            container.appendChild(kanbanWrapper);

            this.loadDealsKanban();
        },

        // Stage pagination state
        stagePaging: {},
        stageConfigs: [
            { id: 'qualifiedtobuy', name: 'Qualified', color: 'var(--info)', weight: 0.1 },
            { id: 'presentationscheduled', name: 'Presentation', color: 'var(--accent-primary)', weight: 0.3 },
            { id: 'decisionmakerboughtin', name: 'Decision Maker', color: 'var(--warning)', weight: 0.6 },
            { id: 'appointmentscheduled', name: 'Appointment', color: '#8b5cf6', weight: 0.2 },
            { id: 'negotiation', name: 'Negotiation', color: 'var(--accent-secondary)', weight: 0.8 },
            { id: 'closedwon', name: 'Won', color: 'var(--success)', weight: 1.0 },
            { id: 'closedlost', name: 'Lost', color: 'var(--error)', weight: 0 }
        ],

        loadDealsKanban: async function() {
            var kanban = document.getElementById('deals-kanban');
            var statsGrid = document.getElementById('pipeline-stats');
            var self = this;
            var stages = this.stageConfigs;

            // Show loading state
            if (kanban) {
                DOM.clear(kanban);
                kanban.appendChild(DOM.el('div', { style: 'text-align: center; padding: 2rem; color: var(--text-muted);' }, [
                    DOM.el('div', { className: 'loading-spinner', style: 'width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--accent-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;' }),
                    DOM.el('span', {}, 'Lade Pipeline Stats...')
                ]));
            }

            // FAST: Load pipeline stats first (aggregated counts only)
            var statsData = await API.get('/api/hubspot/deals/pipeline-stats');
            var stageStats = statsData && statsData.stageStats ? statsData.stageStats : {};
            var totalDeals = statsData ? statsData.totalDeals : 0;
            var pipelineValue = statsData ? statsData.pipelineValue : 0;
            var wonValue = statsData ? statsData.wonValue : 0;

            // Update Stats Grid immediately
            var wonCount = stageStats.closedwon ? stageStats.closedwon.count : 0;
            var lostCount = stageStats.closedlost ? stageStats.closedlost.count : 0;
            var closedTotal = wonCount + lostCount;
            var winRate = closedTotal > 0 ? (wonCount / closedTotal * 100) : 0;
            var openDeals = totalDeals - wonCount - lostCount;

            if (statsGrid) {
                DOM.clear(statsGrid);
                var stats = [
                    { label: 'Total Pipeline', value: formatCurrency(pipelineValue), change: totalDeals + ' Deals', icon: 'üìä', type: 'info' },
                    { label: 'Win Rate', value: winRate.toFixed(1) + '%', change: wonCount + ' Won / ' + lostCount + ' Lost', icon: 'üèÜ', type: 'success' },
                    { label: 'Won Value', value: formatCurrency(wonValue), change: wonCount + ' Deals', icon: 'üí∞', type: 'primary' },
                    { label: 'Open Deals', value: String(openDeals), change: 'in Pipeline', icon: 'üìà', type: 'warning' }
                ];
                stats.forEach(function(stat) {
                    statsGrid.appendChild(DOM.el('div', { className: 'kpi-card ' + stat.type + ' animate-slide-up' }, [
                        DOM.el('div', { className: 'kpi-header' }, [
                            DOM.el('span', { className: 'kpi-label' }, stat.label),
                            DOM.el('span', { className: 'kpi-icon' }, stat.icon)
                        ]),
                        DOM.el('div', { className: 'kpi-value' }, stat.value),
                        DOM.el('div', { className: 'kpi-change positive' }, stat.change)
                    ]));
                });
            }

            // Update Win Rate Display
            var winRateEl = document.getElementById('win-rate-value');
            var winRateBar = document.getElementById('win-rate-bar');
            if (winRateEl) winRateEl.textContent = winRate.toFixed(1) + '%';
            if (winRateBar) setTimeout(function() { winRateBar.style.width = winRate + '%'; }, 100);
            var wonEl = document.getElementById('won-count');
            var lostEl = document.getElementById('lost-count');
            var openEl = document.getElementById('open-count');
            if (wonEl) wonEl.textContent = wonCount + ' Won';
            if (lostEl) lostEl.textContent = lostCount + ' Lost';
            if (openEl) openEl.textContent = openDeals + ' Open';

            // Render Kanban columns with counts (deals loaded in parallel)
            if (kanban) {
                DOM.clear(kanban);
                stages.forEach(function(stage) {
                    var count = stageStats[stage.id] ? stageStats[stage.id].count : 0;
                    var column = DOM.el('div', { className: 'kanban-column', dataset: { stage: stage.id } }, [
                        DOM.el('div', { className: 'kanban-header' }, [
                            DOM.el('div', {}, [
                                DOM.el('span', { className: 'kanban-title', style: 'color: ' + stage.color + ';' }, stage.name),
                                DOM.el('div', { style: 'font-size: 0.7rem; color: var(--text-muted);' }, 'Weight: ' + (stage.weight * 100) + '%')
                            ]),
                            DOM.el('span', { className: 'kanban-count' }, String(count))
                        ]),
                        DOM.el('div', { className: 'kanban-cards', id: 'stage-' + stage.id }, [
                            DOM.el('div', { style: 'text-align: center; padding: 1rem; color: var(--text-muted); font-size: 0.8rem;' }, count > 0 ? 'Loading...' : 'No deals')
                        ])
                    ]);
                    kanban.appendChild(column);
                });

                // Load deals for each stage in parallel (top 30 each)
                var stagePromises = stages.map(function(stage) {
                    return self.loadStageDeals(stage.id, stage);
                });
                await Promise.all(stagePromises);
            }
        },

        loadStageDeals: async function(stageId, stageConfig, after) {
            var self = this;
            var container = document.getElementById('stage-' + stageId);
            if (!container) return;
            if (!after) DOM.clear(container);

            var url = '/api/hubspot/deals/by-stage/' + stageId + '?limit=100' + (after ? '&after=' + after : '');
            var data = await API.get(url);
            var deals = data && data.deals ? data.deals : [];
            var total = data ? data.total : 0;
            var paging = data ? data.paging : null;
            this.stagePaging[stageId] = paging;

            if (deals.length === 0 && !after) {
                container.appendChild(DOM.el('div', { style: 'text-align: center; padding: 1rem; color: var(--text-muted); font-size: 0.8rem;' }, 'No deals'));
                return;
            }

            var weight = stageConfig ? stageConfig.weight : 0.5;
            deals.forEach(function(deal) {
                var props = deal.properties || {};
                var dealAmount = parseFloat(props.amount || 0);
                var card = DOM.el('div', { className: 'kanban-card', draggable: 'true', dataset: { dealId: deal.id }, style: 'cursor: pointer;', onclick: function() { UltimateApp.showDealDetail(deal.id); } }, [
                    DOM.el('div', { className: 'kanban-card-title' }, escapeHtml(props.dealname || 'Unnamed Deal')),
                    DOM.el('div', { className: 'kanban-card-meta' }, [
                        DOM.el('span', { className: 'kanban-card-value' }, formatCurrency(dealAmount)),
                        DOM.el('span', { style: 'color: var(--accent-primary); font-size: 0.7rem;' }, '‚öñÔ∏è ' + formatCurrency(dealAmount * weight))
                    ]),
                    props.closedate ? DOM.el('div', { style: 'font-size: 0.7rem; color: var(--text-muted); margin-top: 4px;' }, 'üìÖ ' + formatDate(props.closedate)) : null
                ]);
                container.appendChild(card);
            });

            // Add "Load More" button if there are more deals
            if (paging && paging.next && paging.next.after) {
                var loadedCount = container.querySelectorAll('.kanban-card').length;
                var loadMoreBtn = DOM.el('button', {
                    className: 'btn btn-ghost btn-sm',
                    style: 'width: 100%; margin-top: 0.5rem; font-size: 0.75rem;',
                    onclick: function() {
                        this.disabled = true;
                        this.textContent = 'Loading...';
                        self.loadStageDeals(stageId, stageConfig, paging.next.after);
                    }
                }, '+ Load More (' + loadedCount + '/' + total + ')');
                container.appendChild(loadMoreBtn);
            }
        },

        showPipelineDetail: function(label) {
            console.log('Pipeline Detail:', label);
        },

        showStageDetail: function(stageId, stageName) {
            console.log('Stage Detail:', stageId, stageName);
        },

        showDealDetail: function(dealId) {
            console.log('Deal Detail:', dealId);
            window.open('https://app-eu1.hubspot.com/contacts/147479000/record/0-3/' + dealId, '_blank');
        },

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // AUTO LEAD DISCOVERY
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        startLeadDiscovery: async function() {
            var statusEl = document.getElementById('lead-discovery-status');
            var resultsEl = document.getElementById('lead-discovery-results');
            var newLeadsEl = document.getElementById('ld-new-leads');
            var hotLeadsEl = document.getElementById('ld-hot-leads');
            var lastScanEl = document.getElementById('ld-last-scan');

            if (statusEl) {
                statusEl.textContent = 'Scanning...';
                statusEl.className = 'badge badge-warning';
            }

            try {
                // Start the lead discovery scan
                var result = await API.post('/api/lead-discovery/start');

                // Poll for status
                var checkStatus = async function() {
                    var status = await API.get('/api/lead-discovery/status');
                    if (status.running) {
                        setTimeout(checkStatus, 1000);
                    } else {
                        // Scan complete
                        if (statusEl) {
                            statusEl.textContent = 'Complete';
                            statusEl.className = 'badge badge-success';
                        }
                        if (newLeadsEl) newLeadsEl.textContent = status.leadsFound || '0';
                        if (lastScanEl) lastScanEl.textContent = 'Just now';

                        // Load discovered leads
                        UltimateApp.loadDiscoveredLeads();
                    }
                };
                checkStatus();

            } catch (error) {
                console.error('Lead Discovery error:', error);
                if (statusEl) {
                    statusEl.textContent = 'Error';
                    statusEl.className = 'badge badge-error';
                }
            }
        },

        loadDiscoveredLeads: async function() {
            var resultsEl = document.getElementById('lead-discovery-results');
            var hotLeadsEl = document.getElementById('ld-hot-leads');
            if (!resultsEl) return;

            var data = await API.get('/api/lead-discovery/scan');
            var leads = data && data.leads ? data.leads : [];

            DOM.clear(resultsEl);

            if (leads.length === 0) {
                resultsEl.appendChild(DOM.el('div', { style: 'text-align: center; color: var(--text-muted); padding: 1rem;' }, 'No new leads found'));
                return;
            }

            // Count hot leads (recently created)
            var hotCount = leads.filter(function(l) {
                var created = new Date(l.properties.createdate);
                var dayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
                return created > dayAgo;
            }).length;
            if (hotLeadsEl) hotLeadsEl.textContent = String(hotCount);

            leads.slice(0, 10).forEach(function(lead) {
                var props = lead.properties || {};
                var name = (props.firstname || '') + ' ' + (props.lastname || '');
                if (!name.trim()) name = props.email || 'Unknown';

                var item = DOM.el('div', { className: 'activity-item', style: 'display: flex; align-items: center; padding: 0.5rem; border-bottom: 1px solid var(--border);' }, [
                    DOM.el('div', { style: 'width: 32px; height: 32px; border-radius: 50%; background: var(--accent-primary); display: flex; align-items: center; justify-content: center; margin-right: 0.75rem; font-size: 0.8rem;' }, 'üë§'),
                    DOM.el('div', { style: 'flex: 1;' }, [
                        DOM.el('div', { style: 'font-weight: 500; font-size: 0.85rem;' }, escapeHtml(name)),
                        DOM.el('div', { style: 'font-size: 0.75rem; color: var(--text-muted);' }, escapeHtml(props.company || props.email || '-'))
                    ]),
                    DOM.el('span', { className: 'badge badge-info', style: 'font-size: 0.65rem;' }, props.hs_lead_status || 'NEW')
                ]);
                resultsEl.appendChild(item);
            });
        },

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // AI - GENIUS BOTS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        botCategories: {
            analysts: { name: 'üß† Analysts', color: '#9b59b6' },
            strategists: { name: '‚öîÔ∏è Strategists', color: '#e74c3c' },
            creatives: { name: 'üé® Creatives', color: '#f39c12' },
            innovators: { name: 'üöÄ Innovators', color: '#3498db' },
            explorers: { name: 'üî≠ Explorers', color: '#1abc9c' },
            philosophers: { name: 'üìú Philosophers', color: '#8e44ad' },
            investigators: { name: 'üîç Investigators', color: '#2c3e50' },
            prophets: { name: 'üîÆ Prophets', color: '#9b59b6' },
            diplomats: { name: 'üë∏ Diplomats', color: '#f1c40f' },
            smart_home: { name: 'üè† Smart Home', color: '#27ae60' },
            sales: { name: 'üíº Sales', color: '#e67e22' }
        },

        selectedBotCategory: 'all',

        orchestratorRunning: false,

        renderBots: async function() {
            var container = this.container();
            DOM.clear(container);
            var self = this;

            var header = DOM.el('div', { className: 'page-header' }, [
                DOM.el('div', {}, [
                    DOM.el('h1', { className: 'page-title' }, 'Á•û Genius Bots'),
                    DOM.el('p', { className: 'page-subtitle' }, 'AI Agent Control Center - 44 Legend√§re Genies')
                ]),
                DOM.el('div', { className: 'page-actions' }, [
                    DOM.el('button', {
                        className: 'btn ' + (this.orchestratorRunning ? 'btn-danger' : 'btn-success'),
                        id: 'orchestrator-toggle',
                        onclick: function() { UltimateApp.toggleBotOrchestrator(); }
                    }, this.orchestratorRunning ? '‚èπ Stop 24/7' : '‚ñ∂Ô∏è Start 24/7')
                ])
            ]);
            container.appendChild(header);

            // 24/7 Bot Activity Monitor
            var activityCard = DOM.el('div', { className: 'card mb-4', style: 'border: 2px solid var(--primary);' }, [
                DOM.el('div', { className: 'card-header', style: 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);' }, [
                    DOM.el('span', { className: 'card-title', style: 'color: white;' }, '‚ö° 24/7 Bot Orchestrator'),
                    DOM.el('span', { className: 'badge', id: 'orchestrator-status', style: 'background: rgba(255,255,255,0.2); color: white;' }, 'Loading...')
                ]),
                DOM.el('div', { className: 'card-body' }, [
                    DOM.el('div', { className: 'grid grid-cols-4 gap-4 mb-4' }, [
                        DOM.el('div', { className: 'stat-card' }, [
                            DOM.el('div', { className: 'stat-value', id: 'orch-active-bots' }, '-'),
                            DOM.el('div', { className: 'stat-label' }, 'Aktive Bots')
                        ]),
                        DOM.el('div', { className: 'stat-card' }, [
                            DOM.el('div', { className: 'stat-value', id: 'orch-tasks-today' }, '-'),
                            DOM.el('div', { className: 'stat-label' }, 'Tasks Heute')
                        ]),
                        DOM.el('div', { className: 'stat-card' }, [
                            DOM.el('div', { className: 'stat-value', id: 'orch-success-rate' }, '-'),
                            DOM.el('div', { className: 'stat-label' }, 'Erfolgsrate')
                        ]),
                        DOM.el('div', { className: 'stat-card' }, [
                            DOM.el('div', { className: 'stat-value', id: 'orch-uptime' }, '-'),
                            DOM.el('div', { className: 'stat-label' }, 'Uptime')
                        ])
                    ]),
                    DOM.el('div', { id: 'bot-activity-feed', style: 'max-height: 200px; overflow-y: auto; background: var(--bg-secondary); border-radius: 8px; padding: 0.75rem;' }, [
                        DOM.el('div', { className: 'text-center', style: 'color: var(--text-secondary); padding: 1rem;' }, 'Lade Bot-Aktivit√§ten...')
                    ])
                ])
            ]);
            container.appendChild(activityCard);

            // Command Input
            var commandCard = DOM.el('div', { className: 'card mb-4' }, [
                DOM.el('div', { className: 'card-body' }, [
                    DOM.el('div', { className: 'flex gap-3' }, [
                        DOM.el('input', { type: 'text', className: 'form-input', id: 'bot-command', placeholder: '@einstein analyse die Verkaufsdaten...', style: 'flex: 1;' }),
                        DOM.el('button', { className: 'btn btn-primary', onclick: function() { UltimateApp.executeBotCommand(); } }, '‚ö° Execute')
                    ])
                ])
            ]);
            container.appendChild(commandCard);

            // Category Filter
            var categoryFilter = DOM.el('div', { className: 'flex gap-2 mb-4', style: 'flex-wrap: wrap;' });
            categoryFilter.appendChild(DOM.el('button', {
                className: 'btn ' + (this.selectedBotCategory === 'all' ? 'btn-primary' : 'btn-secondary'),
                onclick: function() { self.filterBotsByCategory('all'); }
            }, 'üåü Alle'));

            Object.keys(this.botCategories).forEach(function(cat) {
                categoryFilter.appendChild(DOM.el('button', {
                    className: 'btn ' + (self.selectedBotCategory === cat ? 'btn-primary' : 'btn-secondary'),
                    style: 'border-left: 3px solid ' + self.botCategories[cat].color,
                    onclick: function() { self.filterBotsByCategory(cat); }
                }, self.botCategories[cat].name));
            });
            container.appendChild(categoryFilter);

            // Bots Grid
            var botsCard = DOM.el('div', { className: 'card' }, [
                DOM.el('div', { className: 'card-header' }, [
                    DOM.el('span', { className: 'card-title' }, 'ü§ñ Available Bots'),
                    DOM.el('span', { className: 'badge badge-success', id: 'bots-online-count' }, '- Online')
                ]),
                DOM.el('div', { className: 'card-body' }, [
                    DOM.el('div', { id: 'bots-container' }, [
                        DOM.el('div', { className: 'loading-skeleton', style: 'height: 200px;' })
                    ])
                ])
            ]);
            container.appendChild(botsCard);

            this.loadBotsGrid();
            this.loadOrchestratorStatus();
        },

        filterBotsByCategory: function(category) {
            this.selectedBotCategory = category;
            this.renderBots();
        },

        loadBotsGrid: async function() {
            var containerEl = document.getElementById('bots-container');
            var countEl = document.getElementById('bots-online-count');
            var data = await API.get('/api/genius-agency/bots');
            DOM.clear(containerEl);

            var bots = data && data.bots ? data.bots : (Array.isArray(data) ? data : []);

            if (bots.length === 0) {
                containerEl.appendChild(DOM.el('div', { className: 'empty-state' }, 'No bots available'));
                return;
            }

            var onlineCount = bots.length;
            countEl.textContent = onlineCount + ' Online';

            var self = this;
            var categories = data.categories || {};

            // Group bots by category
            var botsByCategory = {};
            Object.keys(categories).forEach(function(cat) {
                botsByCategory[cat] = [];
            });
            botsByCategory.other = [];

            bots.forEach(function(bot) {
                var foundCategory = null;
                Object.keys(categories).forEach(function(cat) {
                    if (categories[cat] && categories[cat].indexOf(bot.id) >= 0) {
                        foundCategory = cat;
                    }
                });
                if (foundCategory) {
                    botsByCategory[foundCategory].push(bot);
                } else {
                    botsByCategory.other.push(bot);
                }
            });

            // Render by category
            var categoriesToShow = self.selectedBotCategory === 'all'
                ? Object.keys(self.botCategories)
                : [self.selectedBotCategory];

            categoriesToShow.forEach(function(cat) {
                var catBots = botsByCategory[cat] || [];
                if (catBots.length === 0) return;

                var catInfo = self.botCategories[cat] || { name: cat, color: '#666' };

                var categorySection = DOM.el('div', { className: 'mb-4' });
                categorySection.appendChild(DOM.el('h3', {
                    style: 'color: ' + catInfo.color + '; margin-bottom: 0.75rem; font-size: 1rem;'
                }, catInfo.name + ' (' + catBots.length + ')'));

                var grid = DOM.el('div', { className: 'bot-grid' });

                catBots.forEach(function(bot) {
                    var card = DOM.el('div', {
                        className: 'bot-card online',
                        style: 'border-left: 3px solid ' + catInfo.color,
                        onclick: function() { UltimateApp.selectBot(bot); }
                    }, [
                        DOM.el('div', { className: 'bot-header' }, [
                            DOM.el('span', { style: 'font-size: 1.25rem;' }, bot.icon || 'ü§ñ'),
                            DOM.el('span', { className: 'bot-name' }, escapeHtml(bot.name || bot.id))
                        ]),
                        DOM.el('div', { className: 'bot-role' }, escapeHtml(bot.role || bot.specialty || 'Agent')),
                        bot.quote ? DOM.el('div', {
                            style: 'font-size: 0.7rem; color: var(--text-secondary); margin-top: 0.25rem; font-style: italic; opacity: 0.7;'
                        }, '"' + bot.quote.substring(0, 50) + (bot.quote.length > 50 ? '...' : '') + '"') : null
                    ].filter(Boolean));
                    grid.appendChild(card);
                });

                categorySection.appendChild(grid);
                containerEl.appendChild(categorySection);
            });

            // Show uncategorized if showing all
            if (self.selectedBotCategory === 'all' && botsByCategory.other.length > 0) {
                var otherSection = DOM.el('div', { className: 'mb-4' });
                otherSection.appendChild(DOM.el('h3', { style: 'color: #666; margin-bottom: 0.75rem; font-size: 1rem;' }, 'üì¶ Andere (' + botsByCategory.other.length + ')'));
                var grid = DOM.el('div', { className: 'bot-grid' });
                botsByCategory.other.forEach(function(bot) {
                    var card = DOM.el('div', { className: 'bot-card online', onclick: function() { UltimateApp.selectBot(bot); } }, [
                        DOM.el('div', { className: 'bot-header' }, [
                            DOM.el('span', { style: 'font-size: 1.25rem;' }, bot.icon || 'ü§ñ'),
                            DOM.el('span', { className: 'bot-name' }, escapeHtml(bot.name || bot.id))
                        ]),
                        DOM.el('div', { className: 'bot-role' }, escapeHtml(bot.role || bot.specialty || 'Agent'))
                    ]);
                    grid.appendChild(card);
                });
                otherSection.appendChild(grid);
                containerEl.appendChild(otherSection);
            }
        },

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // BOT ORCHESTRATOR FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        orchestratorInterval: null,

        toggleBotOrchestrator: async function() {
            var btn = document.getElementById('orchestrator-toggle');
            var statusEl = document.getElementById('orchestrator-status');

            if (this.orchestratorRunning) {
                // Stop orchestrator
                btn.disabled = true;
                btn.textContent = 'Stopping...';
                var result = await API.post('/api/bot-orchestrator/stop');
                if (result && result.success) {
                    this.orchestratorRunning = false;
                    btn.className = 'btn btn-success';
                    btn.textContent = '‚ñ∂Ô∏è Start 24/7';
                    statusEl.textContent = 'Stopped';
                    statusEl.style.background = 'rgba(255,0,0,0.3)';
                    if (this.orchestratorInterval) {
                        clearInterval(this.orchestratorInterval);
                        this.orchestratorInterval = null;
                    }
                }
                btn.disabled = false;
            } else {
                // Start orchestrator
                btn.disabled = true;
                btn.textContent = 'Starting...';
                var result = await API.post('/api/bot-orchestrator/start');
                if (result && result.success) {
                    this.orchestratorRunning = true;
                    btn.className = 'btn btn-danger';
                    btn.textContent = '‚èπ Stop 24/7';
                    statusEl.textContent = 'Running';
                    statusEl.style.background = 'rgba(0,255,0,0.3)';
                    this.loadBotActivityFeed();
                    // Auto-refresh every 30 seconds
                    var self = this;
                    this.orchestratorInterval = setInterval(function() {
                        self.loadBotActivityFeed();
                    }, 30000);
                }
                btn.disabled = false;
            }
        },

        loadOrchestratorStatus: async function() {
            var statusEl = document.getElementById('orchestrator-status');
            var btn = document.getElementById('orchestrator-toggle');

            try {
                var data = await API.get('/api/bot-orchestrator/status');
                if (data) {
                    this.orchestratorRunning = data.running || false;
                    if (statusEl) {
                        statusEl.textContent = data.running ? 'Running' : 'Stopped';
                        statusEl.style.background = data.running ? 'rgba(0,255,0,0.3)' : 'rgba(255,0,0,0.3)';
                    }
                    if (btn) {
                        btn.className = 'btn ' + (this.orchestratorRunning ? 'btn-danger' : 'btn-success');
                        btn.textContent = this.orchestratorRunning ? '‚èπ Stop 24/7' : '‚ñ∂Ô∏è Start 24/7';
                    }

                    // Update stats
                    var activeBotsEl = document.getElementById('orch-active-bots');
                    var uptimeEl = document.getElementById('orch-uptime');
                    if (activeBotsEl) activeBotsEl.textContent = data.activeBots || 0;
                    if (uptimeEl) uptimeEl.textContent = data.uptime || '-';

                    // Start auto-refresh if running
                    if (data.running && !this.orchestratorInterval) {
                        var self = this;
                        this.loadBotActivityFeed();
                        this.orchestratorInterval = setInterval(function() {
                            self.loadBotActivityFeed();
                        }, 30000);
                    }
                }
            } catch (e) {
                console.warn('Orchestrator status not available:', e);
                if (statusEl) {
                    statusEl.textContent = 'Offline';
                    statusEl.style.background = 'rgba(128,128,128,0.3)';
                }
            }
        },

        loadBotActivityFeed: async function() {
            var feedContainer = document.getElementById('bot-activity-feed');
            if (!feedContainer) return;

            try {
                var logsResponse = await API.get('/api/bot-orchestrator/logs?limit=10');
                var statsResponse = await API.get('/api/bot-orchestrator/stats');

                // Extract data from API responses
                var logs = logsResponse && logsResponse.logs ? logsResponse.logs : (Array.isArray(logsResponse) ? logsResponse : []);
                var stats = statsResponse && statsResponse.stats ? statsResponse.stats : [];

                // Calculate stats from data
                var tasksToday = logs.length;
                var successCount = logs.filter(function(l) { return l.status === 'success'; }).length;
                var successRate = tasksToday > 0 ? Math.round((successCount / tasksToday) * 100) : 0;

                // Update stats display
                var tasksEl = document.getElementById('orch-tasks-today');
                var successEl = document.getElementById('orch-success-rate');
                var activeEl = document.getElementById('orch-active-bots');
                if (tasksEl) tasksEl.textContent = tasksToday;
                if (successEl) successEl.textContent = successRate + '%';
                if (activeEl) activeEl.textContent = stats.length || 44;

                // Update activity feed
                DOM.clear(feedContainer);

                if (!logs || logs.length === 0) {
                    feedContainer.appendChild(DOM.el('div', {
                        className: 'empty-state',
                        style: 'padding: 1rem; text-align: center; color: var(--text-muted);'
                    }, 'No activity yet. Start the orchestrator to begin.'));
                    return;
                }

                logs.forEach(function(log) {
                    var timeAgo = formatTimeAgo(log.executed_at || log.createdAt);
                    var isSuccess = log.status === 'success' || log.success === true;
                    var statusIcon = isSuccess ? '‚úÖ' : '‚ùå';
                    var statusColor = isSuccess ? 'var(--color-success)' : 'var(--color-danger)';

                    var item = DOM.el('div', {
                        className: 'activity-item',
                        style: 'padding: 0.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;'
                    }, [
                        DOM.el('div', {}, [
                            DOM.el('span', { style: 'margin-right: 0.5rem;' }, statusIcon),
                            DOM.el('strong', { style: 'color: var(--text-primary);' }, log.bot_name || log.bot_id),
                            DOM.el('span', { style: 'color: var(--text-muted); margin-left: 0.5rem; font-size: 0.85rem;' }, log.task_name)
                        ]),
                        DOM.el('span', { style: 'font-size: 0.75rem; color: var(--text-muted);' }, timeAgo)
                    ]);
                    feedContainer.appendChild(item);
                });
            } catch (e) {
                console.warn('Failed to load bot activity:', e);
                feedContainer.innerHTML = '<div style="padding: 1rem; color: var(--text-muted);">Activity feed unavailable</div>';
            }
        },

        executeSingleBot: async function(botId) {
            var result = await API.post('/api/bot-orchestrator/execute/' + botId);
            if (result && result.success) {
                this.loadBotActivityFeed();
                return true;
            }
            return false;
        },

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CRM - COMPANIES
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        companiesPage: 0,
        companiesPerPage: 50,

        renderCompanies: async function() {
            var container = this.container();
            DOM.clear(container);
            this.companiesPage = 0;

            var header = DOM.el('div', { className: 'page-header' }, [
                DOM.el('div', {}, [
                    DOM.el('h1', { className: 'page-title' }, 'Companies'),
                    DOM.el('p', { className: 'page-subtitle' }, 'Manage your business accounts')
                ]),
                DOM.el('div', { className: 'page-actions' }, [
                    DOM.el('button', { className: 'btn btn-primary', onclick: function() { UltimateApp.showNewCompanyModal(); } }, '+ New Company')
                ])
            ]);
            container.appendChild(header);

            var card = DOM.el('div', { className: 'card' }, [
                DOM.el('div', { className: 'card-body' }, [
                    DOM.el('div', { className: 'table-container', id: 'companies-table' }, [
                        DOM.el('div', { className: 'loading-skeleton', style: 'height: 300px;' })
                    ]),
                    DOM.el('div', { className: 'pagination', id: 'companies-pagination', style: 'display: flex; justify-content: center; gap: 1rem; margin-top: 1rem;' })
                ])
            ]);
            container.appendChild(card);

            this.loadCompaniesTable(0);
        },

        loadCompaniesTable: async function(page) {
            var self = this;
            if (page === undefined) page = this.companiesPage;
            this.companiesPage = page;
            var tableContainer = document.getElementById('companies-table');
            var paginationContainer = document.getElementById('companies-pagination');
            var offset = page * this.companiesPerPage;
            var data = await API.get('/api/hubspot/companies?limit=' + this.companiesPerPage + '&offset=' + offset);
            DOM.clear(tableContainer);

            var companies = data && (data.results || data.companies) || [];
            var total = data && data.total || 0;
            var totalPages = Math.ceil(total / this.companiesPerPage);

            if (companies.length === 0 && page === 0) {
                tableContainer.appendChild(DOM.el('div', { className: 'empty-state' }, [
                    DOM.el('div', { className: 'empty-state-icon' }, 'üè¢'),
                    DOM.el('div', { className: 'empty-state-title' }, 'No companies yet'),
                    DOM.el('button', { className: 'btn btn-primary', onclick: function() { UltimateApp.showNewCompanyModal(); } }, '+ Add First Company')
                ]));
                return;
            }

            var table = DOM.el('table', { className: 'table' });
            var thead = DOM.el('thead', {}, [
                DOM.el('tr', {}, [
                    DOM.el('th', {}, 'Company'),
                    DOM.el('th', {}, 'Domain'),
                    DOM.el('th', {}, 'Industry'),
                    DOM.el('th', {}, 'Employees'),
                    DOM.el('th', {}, 'Revenue'),
                    DOM.el('th', {}, 'Actions')
                ])
            ]);
            table.appendChild(thead);

            var tbody = DOM.el('tbody');
            companies.forEach(function(company) {
                var props = company.properties || {};
                var row = DOM.el('tr', {}, [
                    DOM.el('td', { style: 'font-weight: 500;' }, escapeHtml(props.name || 'Unnamed')),
                    DOM.el('td', {}, escapeHtml(props.domain || '-')),
                    DOM.el('td', {}, escapeHtml(props.industry || '-')),
                    DOM.el('td', {}, escapeHtml(props.numberofemployees || '-')),
                    DOM.el('td', {}, props.annualrevenue ? formatCurrency(props.annualrevenue) : '-'),
                    DOM.el('td', {}, [
                        DOM.el('button', { className: 'btn btn-ghost btn-sm', onclick: function() { UltimateApp.editCompany(company.id); } }, 'Edit')
                    ])
                ]);
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            tableContainer.appendChild(table);

            // Pagination Controls
            if (paginationContainer && totalPages > 1) {
                DOM.clear(paginationContainer);
                var prevBtn = DOM.el('button', {
                    className: 'btn btn-secondary',
                    onclick: function() { if (page > 0) self.loadCompaniesTable(page - 1); },
                    disabled: page === 0
                }, '‚Üê Zur√ºck');
                var pageInfo = DOM.el('span', { style: 'display: flex; align-items: center; color: var(--text-muted);' },
                    'Seite ' + (page + 1) + ' von ' + totalPages + ' (' + formatNumber(total) + ' Firmen)');
                var nextBtn = DOM.el('button', {
                    className: 'btn btn-secondary',
                    onclick: function() { if (page < totalPages - 1) self.loadCompaniesTable(page + 1); },
                    disabled: page >= totalPages - 1
                }, 'Weiter ‚Üí');
                paginationContainer.appendChild(prevBtn);
                paginationContainer.appendChild(pageInfo);
                paginationContainer.appendChild(nextBtn);
            }
        },

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CRM - LEAD SCORING
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        renderLeadScoring: async function() {
            var container = this.container();
            DOM.clear(container);

            var header = DOM.el('div', { className: 'page-header' }, [
                DOM.el('h1', { className: 'page-title' }, 'Lead Scoring'),
                DOM.el('p', { className: 'page-subtitle' }, 'Analyze and prioritize your leads')
            ]);
            container.appendChild(header);

            var grid = DOM.el('div', { className: 'grid grid-3 gap-4', id: 'scoring-grid' });
            container.appendChild(grid);

            this.loadLeadScoring(grid);
        },

        loadLeadScoring: async function(grid) {
            var data = await API.get('/api/hubspot/contacts?limit=100');
            DOM.clear(grid);

            var hotLeads = DOM.el('div', { className: 'card' }, [
                DOM.el('div', { className: 'card-header' }, [
                    DOM.el('span', { className: 'card-title text-success' }, '&#128293; Hot Leads'),
                    DOM.el('span', { className: 'badge badge-success' }, '0')
                ]),
                DOM.el('div', { className: 'card-body', id: 'hot-leads-list' })
            ]);

            var warmLeads = DOM.el('div', { className: 'card' }, [
                DOM.el('div', { className: 'card-header' }, [
                    DOM.el('span', { className: 'card-title text-warning' }, '&#127777; Warm Leads'),
                    DOM.el('span', { className: 'badge badge-warning' }, '0')
                ]),
                DOM.el('div', { className: 'card-body', id: 'warm-leads-list' })
            ]);

            var coldLeads = DOM.el('div', { className: 'card' }, [
                DOM.el('div', { className: 'card-header' }, [
                    DOM.el('span', { className: 'card-title text-info' }, '&#10052; Cold Leads'),
                    DOM.el('span', { className: 'badge badge-info' }, '0')
                ]),
                DOM.el('div', { className: 'card-body', id: 'cold-leads-list' })
            ]);

            grid.appendChild(hotLeads);
            grid.appendChild(warmLeads);
            grid.appendChild(coldLeads);

            // Simple scoring based on data completeness
            if (data && data.results) {
                var hot = [], warm = [], cold = [];
                data.results.forEach(function(contact) {
                    var props = contact.properties || {};
                    var score = 0;
                    if (props.email) score += 20;
                    if (props.phone) score += 20;
                    if (props.company) score += 20;
                    if (props.jobtitle) score += 20;
                    if (props.lifecycle_stage === 'opportunity') score += 20;

                    contact.score = score;
                    if (score >= 60) hot.push(contact);
                    else if (score >= 40) warm.push(contact);
                    else cold.push(contact);
                });

                hotLeads.querySelector('.badge').textContent = String(hot.length);
                warmLeads.querySelector('.badge').textContent = String(warm.length);
                coldLeads.querySelector('.badge').textContent = String(cold.length);

                this.renderLeadList(document.getElementById('hot-leads-list'), hot.slice(0, 5));
                this.renderLeadList(document.getElementById('warm-leads-list'), warm.slice(0, 5));
                this.renderLeadList(document.getElementById('cold-leads-list'), cold.slice(0, 5));
            }
        },

        renderLeadList: function(container, leads) {
            if (leads.length === 0) {
                container.appendChild(DOM.el('div', { className: 'text-muted' }, 'No leads'));
                return;
            }
            leads.forEach(function(lead) {
                var props = lead.properties || {};
                var name = [props.firstname, props.lastname].filter(Boolean).join(' ') || props.email || 'Unknown';
                container.appendChild(DOM.el('div', { className: 'flex justify-between items-center py-2', style: 'border-bottom: 1px solid var(--border-color);' }, [
                    DOM.el('span', {}, escapeHtml(name)),
                    DOM.el('span', { className: 'badge' }, lead.score + ' pts')
                ]));
            });
        },

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SALES - LEAD DISCOVERY
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        renderLeadDiscovery: async function() {
            var container = this.container();
            DOM.clear(container);

            var header = DOM.el('div', { className: 'page-header' }, [
                DOM.el('h1', { className: 'page-title' }, 'Lead Discovery'),
                DOM.el('p', { className: 'page-subtitle' }, 'Find and qualify new leads')
            ]);
            container.appendChild(header);

            var searchCard = DOM.el('div', { className: 'card mb-4' }, [
                DOM.el('div', { className: 'card-body' }, [
                    DOM.el('div', { className: 'grid grid-4 gap-3' }, [
                        DOM.el('input', { type: 'text', className: 'form-input', id: 'lead-search-company', placeholder: 'Company name...' }),
                        DOM.el('input', { type: 'text', className: 'form-input', id: 'lead-search-industry', placeholder: 'Industry...' }),
                        DOM.el('input', { type: 'text', className: 'form-input', id: 'lead-search-location', placeholder: 'Location...' }),
                        DOM.el('button', { className: 'btn btn-primary', onclick: function() { UltimateApp.searchLeads(); } }, 'üîç Search')
                    ])
                ])
            ]);
            container.appendChild(searchCard);

            var resultsCard = DOM.el('div', { className: 'card' }, [
                DOM.el('div', { className: 'card-header' }, [
                    DOM.el('span', { className: 'card-title' }, 'Search Results'),
                    DOM.el('span', { className: 'badge', id: 'lead-results-count' }, '0 found')
                ]),
                DOM.el('div', { className: 'card-body', id: 'lead-results' }, [
                    DOM.el('div', { className: 'empty-state' }, [
                        DOM.el('div', { className: 'empty-state-icon' }, 'üéØ'),
                        DOM.el('div', { className: 'empty-state-text' }, 'Enter search criteria to find leads')
                    ])
                ])
            ]);
            container.appendChild(resultsCard);
        },

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SALES - PROPOSALS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        renderProposals: async function() {
            var container = this.container();
            DOM.clear(container);

            var header = DOM.el('div', { className: 'page-header' }, [
                DOM.el('div', {}, [
                    DOM.el('h1', { className: 'page-title' }, 'Proposals'),
                    DOM.el('p', { className: 'page-subtitle' }, 'Manage sales proposals and quotes')
                ]),
                DOM.el('div', { className: 'page-actions' }, [
                    DOM.el('button', { className: 'btn btn-primary', onclick: function() { UltimateApp.showNewProposalModal(); } }, '+ New Proposal')
                ])
            ]);
            container.appendChild(header);

            var stats = DOM.el('div', { className: 'grid grid-4 gap-4 mb-4' }, [
                DOM.el('div', { className: 'kpi-card' }, [
                    DOM.el('div', { className: 'kpi-label' }, 'Total Proposals'),
                    DOM.el('div', { className: 'kpi-value' }, '0')
                ]),
                DOM.el('div', { className: 'kpi-card success' }, [
                    DOM.el('div', { className: 'kpi-label' }, 'Accepted'),
                    DOM.el('div', { className: 'kpi-value' }, '0')
                ]),
                DOM.el('div', { className: 'kpi-card warning' }, [
                    DOM.el('div', { className: 'kpi-label' }, 'Pending'),
                    DOM.el('div', { className: 'kpi-value' }, '0')
                ]),
                DOM.el('div', { className: 'kpi-card error' }, [
                    DOM.el('div', { className: 'kpi-label' }, 'Rejected'),
                    DOM.el('div', { className: 'kpi-value' }, '0')
                ])
            ]);
            container.appendChild(stats);

            var card = DOM.el('div', { className: 'card' }, [
                DOM.el('div', { className: 'card-body' }, [
                    DOM.el('div', { className: 'empty-state' }, [
                        DOM.el('div', { className: 'empty-state-icon' }, '&#128196;'),
                        DOM.el('div', { className: 'empty-state-title' }, 'No proposals yet'),
                        DOM.el('button', { className: 'btn btn-primary', onclick: function() { UltimateApp.showNewProposalModal(); } }, '+ Create First Proposal')
                    ])
                ])
            ]);
            container.appendChild(card);
        },

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // COMMUNICATION - EMAIL HUB
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // Email Hub State
        emailHubTab: 'accounts',
        emailAccounts: [],
        emailTemplates: [],
        emailStats: null,
        recentEmails: [],
        syncedEmails: [],
        queueStatus: null,
        editingTemplate: null,

        renderEmailHub: async function() {
            var self = this;
            var container = this.container();
            DOM.clear(container);

            var header = DOM.el('div', { className: 'page-header' }, [
                DOM.el('div', {}, [
                    DOM.el('h1', { className: 'page-title' }, 'üìß Email Hub'),
                    DOM.el('p', { className: 'page-subtitle' }, 'Templates, Kampagnen & Tracking')
                ]),
                DOM.el('div', { className: 'page-actions' }, [
                    DOM.el('button', { className: 'btn btn-ghost', onclick: function() { self.loadEmailHubData(); } }, 'üîÑ Refresh'),
                    DOM.el('button', { className: 'btn btn-primary', onclick: function() { self.showTemplateBuilder(); } }, '+ Neues Template')
                ])
            ]);
            container.appendChild(header);

            // Stats Row
            var stats = DOM.el('div', { className: 'grid grid-5 gap-4 mb-4', id: 'email-stats-row' }, [
                DOM.el('div', { className: 'kpi-card info' }, [
                    DOM.el('div', { className: 'kpi-label' }, 'Templates'),
                    DOM.el('div', { className: 'kpi-value', id: 'email-template-count' }, '-')
                ]),
                DOM.el('div', { className: 'kpi-card primary' }, [
                    DOM.el('div', { className: 'kpi-label' }, 'Gesendet (30 Tage)'),
                    DOM.el('div', { className: 'kpi-value', id: 'email-sent-count' }, '-')
                ]),
                DOM.el('div', { className: 'kpi-card success' }, [
                    DOM.el('div', { className: 'kpi-label' }, 'Open Rate'),
                    DOM.el('div', { className: 'kpi-value', id: 'email-open-rate' }, '--%')
                ]),
                DOM.el('div', { className: 'kpi-card warning' }, [
                    DOM.el('div', { className: 'kpi-label' }, 'Click Rate'),
                    DOM.el('div', { className: 'kpi-value', id: 'email-click-rate' }, '--%')
                ]),
                DOM.el('div', { className: 'kpi-card', id: 'queue-status-card' }, [
                    DOM.el('div', { className: 'kpi-label' }, 'Queue'),
                    DOM.el('div', { className: 'kpi-value', id: 'email-queue-size' }, '-')
                ])
            ]);
            container.appendChild(stats);

            // Tabs
            var tabs = DOM.el('div', { className: 'flex gap-2 mb-4 flex-wrap' }, [
                DOM.el('button', { className: 'btn btn-sm ' + (this.emailHubTab === 'accounts' ? 'btn-primary' : 'btn-ghost'), onclick: function() { self.emailHubTab = 'accounts'; self.renderEmailHubContent(); } }, 'üìß Accounts'),
                DOM.el('button', { className: 'btn btn-sm ' + (this.emailHubTab === 'templates' ? 'btn-primary' : 'btn-ghost'), onclick: function() { self.emailHubTab = 'templates'; self.renderEmailHubContent(); } }, 'üìÑ Templates'),
                DOM.el('button', { className: 'btn btn-sm ' + (this.emailHubTab === 'sent' ? 'btn-primary' : 'btn-ghost'), onclick: function() { self.emailHubTab = 'sent'; self.renderEmailHubContent(); } }, 'üì§ Gesendete Emails'),
                DOM.el('button', { className: 'btn btn-sm ' + (this.emailHubTab === 'queue' ? 'btn-primary' : 'btn-ghost'), onclick: function() { self.emailHubTab = 'queue'; self.renderEmailHubContent(); } }, '‚öôÔ∏è Queue & Daemons'),
                DOM.el('button', { className: 'btn btn-sm ' + (this.emailHubTab === 'sequences' ? 'btn-primary' : 'btn-ghost'), onclick: function() { self.emailHubTab = 'sequences'; self.renderEmailHubContent(); } }, 'üîÑ Sequences')
            ]);
            container.appendChild(tabs);

            // Content Container
            var contentContainer = DOM.el('div', { id: 'email-hub-content' });
            container.appendChild(contentContainer);

            // Load all data
            this.loadEmailHubData();
        },

        loadEmailHubData: async function() {
            var self = this;
            try {
                // Load all data in parallel
                var [templates, stats, recent, queue, accounts, sent] = await Promise.all([
                    API.get('/api/v1/email/templates').catch(function() { return []; }),
                    API.get('/api/v1/email/stats').catch(function() { return null; }),
                    API.get('/api/v1/email/recent?limit=50').catch(function() { return []; }),
                    API.get('/api/email-queue/status').catch(function() { return { queueSize: 0 }; }),
                    API.get('/api/v1/email/accounts').catch(function() { return { accounts: [] }; }),
                    API.get('/api/v1/email/sent?limit=50').catch(function() { return { emails: [] }; })
                ]);

                self.emailTemplates = Array.isArray(templates) ? templates : (templates.templates || []);
                self.emailStats = stats;
                self.recentEmails = Array.isArray(recent) ? recent : (recent.emails || []);
                self.queueStatus = queue;
                self.emailAccounts = accounts.accounts || [];
                self.syncedEmails = sent.emails || [];

                self.renderEmailStats();
                self.renderEmailHubContent();
            } catch (err) {
                console.error('Email Hub data load error:', err);
            }
        },

        renderEmailStats: function() {
            var countEl = document.getElementById('email-template-count');
            var sentEl = document.getElementById('email-sent-count');
            var openEl = document.getElementById('email-open-rate');
            var clickEl = document.getElementById('email-click-rate');
            var queueEl = document.getElementById('email-queue-size');
            var queueCard = document.getElementById('queue-status-card');

            if (countEl) countEl.textContent = String(this.emailTemplates.length);
            if (this.emailStats) {
                if (sentEl) sentEl.textContent = String(this.emailStats.totalSent || 0);
                if (openEl) openEl.textContent = (this.emailStats.openRate || 0) + '%';
                if (clickEl) clickEl.textContent = (this.emailStats.clickRate || 0) + '%';
            }
            if (this.queueStatus) {
                if (queueEl) queueEl.textContent = String(this.queueStatus.queueSize || 0);
                if (queueCard) {
                    queueCard.className = 'kpi-card ' + (this.queueStatus.isProcessing ? 'warning' : 'success');
                }
            }
        },

        renderEmailHubContent: function() {
            var container = document.getElementById('email-hub-content');
            if (!container) return;
            DOM.clear(container);

            switch (this.emailHubTab) {
                case 'accounts':
                    this.renderAccountsTab(container);
                    break;
                case 'templates':
                    this.renderTemplatesTab(container);
                    break;
                case 'sent':
                    this.renderSentEmailsTab(container);
                    break;
                case 'queue':
                    this.renderQueueTab(container);
                    break;
                case 'sequences':
                    this.renderSequencesTab(container);
                    break;
            }
        },

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ACCOUNTS TAB
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        renderAccountsTab: function(container) {
            var self = this;
            var accounts = this.emailAccounts;

            // Accounts Grid
            var accountsCard = DOM.el('div', { className: 'card mb-4' }, [
                DOM.el('div', { className: 'card-header' }, [
                    DOM.el('span', { className: 'card-title' }, 'üìß Email Accounts'),
                    DOM.el('button', { className: 'btn btn-ghost btn-sm', onclick: function() { self.syncAllEmailAccounts(); } }, 'üîÑ Sync All')
                ])
            ]);

            if (accounts.length === 0) {
                accountsCard.appendChild(DOM.el('div', { className: 'card-body text-center', style: 'padding: 2rem;' }, [
                    DOM.el('p', { style: 'color: var(--text-muted);' }, 'Keine Email-Accounts konfiguriert'),
                    DOM.el('p', { style: 'color: var(--text-muted); font-size: 0.85rem;' }, 'Konfiguriere EMAIL_INFO_* und EMAIL_INVOICE_* in .env')
                ]));
            } else {
                var grid = DOM.el('div', { className: 'card-body' }, [
                    DOM.el('div', { className: 'grid grid-2 gap-4' })
                ]);
                var gridInner = grid.querySelector('.grid');

                accounts.forEach(function(account) {
                    var hasCredentials = account.config && account.config.hasCredentials;
                    var card = DOM.el('div', { className: 'p-4 rounded-lg border', style: 'border-color: var(--border-color); background: var(--bg-secondary);' }, [
                        DOM.el('div', { className: 'flex items-center justify-between mb-3' }, [
                            DOM.el('div', { className: 'flex items-center gap-3' }, [
                                DOM.el('div', { style: 'width: 3rem; height: 3rem; border-radius: 0.75rem; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; background: var(--primary)20;' },
                                    account.id === 'info' ? 'üìß' : 'üßæ'),
                                DOM.el('div', {}, [
                                    DOM.el('div', { style: 'font-weight: 600; font-size: 1.1rem;' }, escapeHtml(account.name || account.id)),
                                    DOM.el('div', { style: 'font-size: 0.85rem; color: var(--text-muted);' }, escapeHtml(account.email || '-'))
                                ])
                            ]),
                            DOM.el('span', { className: 'badge ' + (hasCredentials ? 'badge-success' : 'badge-warning') },
                                hasCredentials ? '‚óè Connected' : '‚óè Not configured')
                        ]),
                        DOM.el('div', { className: 'grid grid-3 gap-3 mt-3' }, [
                            DOM.el('div', { className: 'text-center' }, [
                                DOM.el('div', { style: 'font-size: 1.5rem; font-weight: 600; color: var(--primary);' }, String(account.totalSynced || 0)),
                                DOM.el('div', { style: 'font-size: 0.75rem; color: var(--text-muted);' }, 'Total Synced')
                            ]),
                            DOM.el('div', { className: 'text-center' }, [
                                DOM.el('div', { style: 'font-size: 1.5rem; font-weight: 600; color: var(--success);' },
                                    account.lastEmailAt ? new Date(account.lastEmailAt).toLocaleDateString('de-DE') : '-'),
                                DOM.el('div', { style: 'font-size: 0.75rem; color: var(--text-muted);' }, 'Last Email')
                            ]),
                            DOM.el('div', { className: 'text-center' }, [
                                DOM.el('div', { style: 'font-size: 1.5rem; font-weight: 600;' },
                                    account.lastSyncAt ? new Date(account.lastSyncAt).toLocaleDateString('de-DE') : '-'),
                                DOM.el('div', { style: 'font-size: 0.75rem; color: var(--text-muted);' }, 'Last Sync')
                            ])
                        ]),
                        DOM.el('div', { className: 'flex gap-2 mt-4' }, [
                            DOM.el('button', { className: 'btn btn-ghost btn-sm flex-1', onclick: function() { self.syncEmailAccount(account.id); } }, 'üîÑ Sync'),
                            DOM.el('button', { className: 'btn btn-primary btn-sm flex-1', onclick: function() { self.composeEmail(account.id); } }, '‚úâÔ∏è Compose')
                        ])
                    ]);
                    gridInner.appendChild(card);
                });

                accountsCard.appendChild(grid);
            }
            container.appendChild(accountsCard);

            // Synced Emails from IMAP
            var syncedCard = DOM.el('div', { className: 'card' }, [
                DOM.el('div', { className: 'card-header' }, [
                    DOM.el('span', { className: 'card-title' }, 'üì§ Synced Sent Emails'),
                    DOM.el('span', { className: 'badge' }, String(this.syncedEmails.length) + ' emails')
                ])
            ]);

            if (this.syncedEmails.length === 0) {
                syncedCard.appendChild(DOM.el('div', { className: 'card-body text-center', style: 'padding: 2rem;' }, [
                    DOM.el('p', { style: 'color: var(--text-muted);' }, 'Keine synchronisierten Emails'),
                    DOM.el('button', { className: 'btn btn-primary mt-2', onclick: function() { self.syncAllEmailAccounts(); } }, 'üîÑ Jetzt synchronisieren')
                ]));
            } else {
                var table = DOM.el('table', { className: 'data-table' }, [
                    DOM.el('thead', {}, [
                        DOM.el('tr', {}, [
                            DOM.el('th', {}, 'Account'),
                            DOM.el('th', {}, 'Empf√§nger'),
                            DOM.el('th', {}, 'Betreff'),
                            DOM.el('th', {}, 'Gesendet')
                        ])
                    ])
                ]);

                var tbody = DOM.el('tbody');
                this.syncedEmails.slice(0, 20).forEach(function(email) {
                    var row = DOM.el('tr', {}, [
                        DOM.el('td', {}, [
                            DOM.el('span', { className: 'badge badge-info', style: 'font-size: 0.7rem;' }, email.accountName || email.accountId || '-')
                        ]),
                        DOM.el('td', { style: 'max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;' },
                            escapeHtml(Array.isArray(email.to) ? email.to.join(', ') : (email.to || '-'))),
                        DOM.el('td', { style: 'max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;' },
                            escapeHtml(email.subject || '-')),
                        DOM.el('td', {}, email.sentAt ? new Date(email.sentAt).toLocaleString('de-DE') : '-')
                    ]);
                    tbody.appendChild(row);
                });
                table.appendChild(tbody);
                syncedCard.appendChild(table);
            }
            container.appendChild(syncedCard);
        },

        syncEmailAccount: async function(accountId) {
            try {
                var result = await API.post('/api/v1/email/sync', { account: accountId });
                alert('Sync abgeschlossen: ' + JSON.stringify(result[accountId] || result));
                this.loadEmailHubData();
            } catch (err) {
                alert('Sync Fehler: ' + err.message);
            }
        },

        syncAllEmailAccounts: async function() {
            try {
                var result = await API.post('/api/v1/email/sync', {});
                alert('Alle Accounts synchronisiert!\n' + JSON.stringify(result, null, 2));
                this.loadEmailHubData();
            } catch (err) {
                alert('Sync Fehler: ' + err.message);
            }
        },

        composeEmail: function(accountId) {
            var self = this;
            var form = DOM.el('div', {}, [
                DOM.el('div', { className: 'form-group' }, [
                    DOM.el('label', { className: 'form-label' }, 'Von'),
                    DOM.el('input', { type: 'text', className: 'form-input', id: 'compose-from', value: accountId, disabled: true })
                ]),
                DOM.el('div', { className: 'form-group' }, [
                    DOM.el('label', { className: 'form-label' }, 'An'),
                    DOM.el('input', { type: 'email', className: 'form-input', id: 'compose-to', placeholder: 'empfaenger@example.com' })
                ]),
                DOM.el('div', { className: 'form-group' }, [
                    DOM.el('label', { className: 'form-label' }, 'Betreff'),
                    DOM.el('input', { type: 'text', className: 'form-input', id: 'compose-subject', placeholder: 'Betreff...' })
                ]),
                DOM.el('div', { className: 'form-group' }, [
                    DOM.el('label', { className: 'form-label' }, 'Nachricht'),
                    DOM.el('textarea', { className: 'form-input', id: 'compose-body', rows: '8', placeholder: 'Ihre Nachricht...' })
                ])
            ]);

            this.showModal('‚úâÔ∏è Email senden von ' + accountId, form, async function() {
                var to = document.getElementById('compose-to').value;
                var subject = document.getElementById('compose-subject').value;
                var body = document.getElementById('compose-body').value;

                if (!to || !subject) {
                    alert('Bitte Empf√§nger und Betreff eingeben');
                    return;
                }

                try {
                    await API.post('/api/v1/email/send', {
                        account: accountId,
                        to: to,
                        subject: subject,
                        text: body,
                        html: '<p>' + body.replace(/\n/g, '</p><p>') + '</p>'
                    });
                    alert('‚úÖ Email gesendet!');
                    self.loadEmailHubData();
                } catch (err) {
                    alert('Fehler: ' + err.message);
                }
            });
        },

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // TEMPLATES TAB
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        renderTemplatesTab: function(container) {
            var self = this;
            var templates = this.emailTemplates;

            if (templates.length === 0) {
                container.appendChild(DOM.el('div', { className: 'card' }, [
                    DOM.el('div', { className: 'card-body text-center', style: 'padding: 3rem;' }, [
                        DOM.el('div', { style: 'font-size: 3rem; margin-bottom: 1rem;' }, 'üìß'),
                        DOM.el('p', { style: 'color: var(--text-muted);' }, 'Keine Templates vorhanden'),
                        DOM.el('button', { className: 'btn btn-primary mt-2', onclick: function() { self.showTemplateBuilder(); } }, '+ Erstes Template erstellen')
                    ])
                ]));
                return;
            }

            var grid = DOM.el('div', { className: 'grid grid-3 gap-4' });
            templates.forEach(function(template) {
                var card = DOM.el('div', { className: 'card', style: 'position: relative;' }, [
                    DOM.el('div', { className: 'card-body' }, [
                        DOM.el('div', { className: 'flex justify-between items-start mb-2' }, [
                            DOM.el('div', { style: 'font-weight: 600; font-size: 1rem;' }, escapeHtml(template.name || 'Unbenannt')),
                            DOM.el('span', { className: 'badge ' + (template.isActive !== false ? 'badge-success' : 'badge-warning'), style: 'font-size: 0.7rem;' }, template.isActive !== false ? 'Aktiv' : 'Inaktiv')
                        ]),
                        DOM.el('div', { style: 'font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;' }, 'üìß ' + escapeHtml(template.subject || 'Kein Betreff')),
                        DOM.el('div', { style: 'font-size: 0.75rem; color: var(--text-muted); margin-bottom: 1rem;' },
                            'Erstellt: ' + (template.createdAt ? new Date(template.createdAt).toLocaleDateString('de-DE') : '-')
                        ),
                        DOM.el('div', { className: 'flex gap-2' }, [
                            DOM.el('button', { className: 'btn btn-ghost btn-sm', onclick: function(e) { e.stopPropagation(); self.showTemplateBuilder(template); } }, '‚úèÔ∏è Bearbeiten'),
                            DOM.el('button', { className: 'btn btn-ghost btn-sm', onclick: function(e) { e.stopPropagation(); self.previewTemplate(template); } }, 'üëÅ Vorschau'),
                            DOM.el('button', { className: 'btn btn-ghost btn-sm', style: 'color: var(--danger);', onclick: function(e) { e.stopPropagation(); self.deleteTemplate(template.id); } }, 'üóë')
                        ])
                    ])
                ]);
                grid.appendChild(card);
            });
            container.appendChild(grid);
        },

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SENT EMAILS TAB
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        renderSentEmailsTab: function(container) {
            var self = this;
            var emails = this.recentEmails;

            var card = DOM.el('div', { className: 'card' }, [
                DOM.el('div', { className: 'card-header' }, [
                    DOM.el('span', { className: 'card-title' }, 'üì§ Gesendete Emails (letzte 50)')
                ])
            ]);

            if (emails.length === 0) {
                card.appendChild(DOM.el('div', { className: 'card-body text-center', style: 'padding: 2rem;' }, [
                    DOM.el('p', { style: 'color: var(--text-muted);' }, 'Keine gesendeten Emails gefunden')
                ]));
            } else {
                var table = DOM.el('table', { className: 'data-table' }, [
                    DOM.el('thead', {}, [
                        DOM.el('tr', {}, [
                            DOM.el('th', {}, 'Empfaenger'),
                            DOM.el('th', {}, 'Betreff'),
                            DOM.el('th', {}, 'Template'),
                            DOM.el('th', {}, 'Status'),
                            DOM.el('th', {}, 'Geoeffnet'),
                            DOM.el('th', {}, 'Gesendet')
                        ])
                    ])
                ]);

                var tbody = DOM.el('tbody');
                emails.forEach(function(email) {
                    var statusClass = email.status === 'sent' ? 'badge-success' :
                                     (email.status === 'failed' ? 'badge-danger' : 'badge-warning');
                    var row = DOM.el('tr', {}, [
                        DOM.el('td', {}, escapeHtml(email.recipient || email.recipientEmail || '-')),
                        DOM.el('td', { style: 'max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;' },
                            escapeHtml(email.subject || '-')),
                        DOM.el('td', {}, escapeHtml(email.templateName || '-')),
                        DOM.el('td', {}, [
                            DOM.el('span', { className: 'badge ' + statusClass }, email.status || 'pending')
                        ]),
                        DOM.el('td', {}, email.openedAt ? '‚úÖ ' + new Date(email.openedAt).toLocaleDateString('de-DE') : '‚ùå'),
                        DOM.el('td', {}, email.sentAt ? new Date(email.sentAt).toLocaleString('de-DE') : '-')
                    ]);
                    tbody.appendChild(row);
                });
                table.appendChild(tbody);
                card.appendChild(table);
            }

            container.appendChild(card);
        },

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // QUEUE & DAEMONS TAB
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        renderQueueTab: function(container) {
            var self = this;
            var queue = this.queueStatus || {};

            // Queue Status Card
            var statusCard = DOM.el('div', { className: 'card mb-4' }, [
                DOM.el('div', { className: 'card-header' }, [
                    DOM.el('span', { className: 'card-title' }, '‚öôÔ∏è Email Queue Status'),
                    DOM.el('button', { className: 'btn btn-ghost btn-sm', onclick: function() { self.loadEmailHubData(); } }, 'üîÑ')
                ]),
                DOM.el('div', { className: 'card-body' }, [
                    DOM.el('div', { className: 'grid grid-4 gap-4' }, [
                        DOM.el('div', { className: 'text-center' }, [
                            DOM.el('div', { style: 'font-size: 2rem; font-weight: bold; color: var(--primary);' }, String(queue.queueSize || 0)),
                            DOM.el('div', { style: 'color: var(--text-muted); font-size: 0.85rem;' }, 'In Warteschlange')
                        ]),
                        DOM.el('div', { className: 'text-center' }, [
                            DOM.el('div', { style: 'font-size: 2rem; font-weight: bold; color: var(--success);' }, String(queue.processedCount || 0)),
                            DOM.el('div', { style: 'color: var(--text-muted); font-size: 0.85rem;' }, 'Verarbeitet')
                        ]),
                        DOM.el('div', { className: 'text-center' }, [
                            DOM.el('div', { style: 'font-size: 2rem; font-weight: bold; color: var(--danger);' }, String(queue.failedCount || 0)),
                            DOM.el('div', { style: 'color: var(--text-muted); font-size: 0.85rem;' }, 'Fehlgeschlagen')
                        ]),
                        DOM.el('div', { className: 'text-center' }, [
                            DOM.el('div', { style: 'font-size: 2rem;' }, queue.isProcessing ? 'üü¢' : '‚ö™'),
                            DOM.el('div', { style: 'color: var(--text-muted); font-size: 0.85rem;' }, queue.isProcessing ? 'Verarbeitet...' : 'Idle')
                        ])
                    ])
                ])
            ]);
            container.appendChild(statusCard);

            // Queue Configuration
            var configCard = DOM.el('div', { className: 'card mb-4' }, [
                DOM.el('div', { className: 'card-header' }, [
                    DOM.el('span', { className: 'card-title' }, 'üîß Konfiguration')
                ]),
                DOM.el('div', { className: 'card-body' }, [
                    DOM.el('div', { className: 'grid grid-3 gap-4' }, [
                        DOM.el('div', {}, [
                            DOM.el('div', { style: 'color: var(--text-muted); font-size: 0.85rem; margin-bottom: 0.25rem;' }, 'Max Emails/Minute'),
                            DOM.el('div', { style: 'font-weight: 600;' }, String((queue.config && queue.config.MAX_EMAILS_PER_MINUTE) || 10))
                        ]),
                        DOM.el('div', {}, [
                            DOM.el('div', { style: 'color: var(--text-muted); font-size: 0.85rem; margin-bottom: 0.25rem;' }, 'Intervall (ms)'),
                            DOM.el('div', { style: 'font-weight: 600;' }, String((queue.config && queue.config.SEND_INTERVAL_MS) || 6000))
                        ]),
                        DOM.el('div', {}, [
                            DOM.el('div', { style: 'color: var(--text-muted); font-size: 0.85rem; margin-bottom: 0.25rem;' }, 'Max Retries'),
                            DOM.el('div', { style: 'font-weight: 600;' }, String((queue.config && queue.config.MAX_RETRIES) || 3))
                        ])
                    ])
                ])
            ]);
            container.appendChild(configCard);

            // Queue Items
            if (queue.queue && queue.queue.length > 0) {
                var queueCard = DOM.el('div', { className: 'card' }, [
                    DOM.el('div', { className: 'card-header' }, [
                        DOM.el('span', { className: 'card-title' }, 'üì• Warteschlange (' + queue.queue.length + ')')
                    ])
                ]);

                var table = DOM.el('table', { className: 'data-table' }, [
                    DOM.el('thead', {}, [
                        DOM.el('tr', {}, [
                            DOM.el('th', {}, 'ID'),
                            DOM.el('th', {}, 'Empfaenger'),
                            DOM.el('th', {}, 'Betreff'),
                            DOM.el('th', {}, 'Status'),
                            DOM.el('th', {}, 'Versuche'),
                            DOM.el('th', {}, 'Geplant fuer')
                        ])
                    ])
                ]);

                var tbody = DOM.el('tbody');
                queue.queue.forEach(function(item) {
                    var statusClass = item.status === 'queued' ? 'badge-info' :
                                     (item.status === 'processing' ? 'badge-warning' :
                                     (item.status === 'retry' ? 'badge-warning' : 'badge-secondary'));
                    var row = DOM.el('tr', {}, [
                        DOM.el('td', { style: 'font-family: monospace; font-size: 0.8rem;' }, (item.id || '').slice(-8)),
                        DOM.el('td', {}, escapeHtml(item.to || '-')),
                        DOM.el('td', { style: 'max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;' },
                            escapeHtml(item.subject || '-')),
                        DOM.el('td', {}, [DOM.el('span', { className: 'badge ' + statusClass }, item.status || 'unknown')]),
                        DOM.el('td', {}, String(item.attempts || 0)),
                        DOM.el('td', {}, item.scheduledFor ? new Date(item.scheduledFor).toLocaleString('de-DE') : '-')
                    ]);
                    tbody.appendChild(row);
                });
                table.appendChild(tbody);
                queueCard.appendChild(table);
                container.appendChild(queueCard);
            }
        },

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SEQUENCES TAB
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        renderSequencesTab: function(container) {
            var self = this;
            container.appendChild(DOM.el('div', { className: 'card' }, [
                DOM.el('div', { className: 'card-header' }, [
                    DOM.el('span', { className: 'card-title' }, 'üîÑ Email Sequences'),
                    DOM.el('button', { className: 'btn btn-ghost btn-sm' }, '+ Neue Sequence')
                ]),
                DOM.el('div', { className: 'card-body text-center', style: 'padding: 3rem;' }, [
                    DOM.el('div', { style: 'font-size: 3rem; margin-bottom: 1rem;' }, 'üîÑ'),
                    DOM.el('p', { style: 'color: var(--text-muted);' }, 'Automatisierte Email-Sequences konfigurieren'),
                    DOM.el('p', { style: 'color: var(--text-muted); font-size: 0.85rem;' }, 'Z.B. Willkommens-Serie, Follow-Up nach 3 Tagen, etc.')
                ])
            ]));
        },

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // TEMPLATE BUILDER MODAL
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        showTemplateBuilder: function(template) {
            var self = this;
            this.editingTemplate = template || null;
            var isEdit = !!template;

            var modal = DOM.el('div', { className: 'modal-overlay', id: 'template-builder-modal', onclick: function(e) { if (e.target.id === 'template-builder-modal') self.closeTemplateBuilder(); } }, [
                DOM.el('div', { className: 'modal', style: 'max-width: 900px; max-height: 90vh; overflow-y: auto;' }, [
                    DOM.el('div', { className: 'modal-header' }, [
                        DOM.el('h2', { className: 'modal-title' }, isEdit ? 'Template bearbeiten' : 'Neues Template erstellen'),
                        DOM.el('button', { className: 'btn btn-ghost', onclick: function() { self.closeTemplateBuilder(); } }, '&times;')
                    ]),
                    DOM.el('div', { className: 'modal-body' }, [
                        // Template Name
                        DOM.el('div', { className: 'form-group mb-4' }, [
                            DOM.el('label', { className: 'form-label' }, 'Template Name *'),
                            DOM.el('input', { type: 'text', className: 'form-input', id: 'template-name', placeholder: 'z.B. Willkommens-Email', value: (template && template.name) || '' })
                        ]),
                        // Subject
                        DOM.el('div', { className: 'form-group mb-4' }, [
                            DOM.el('label', { className: 'form-label' }, 'Betreff *'),
                            DOM.el('input', { type: 'text', className: 'form-input', id: 'template-subject', placeholder: 'Willkommen bei Enterprise Universe, {{firstName}}!', value: (template && template.subject) || '' }),
                            DOM.el('small', { style: 'color: var(--text-muted);' }, 'Merge-Tags: {{firstName}}, {{lastName}}, {{company}}, {{currentDate}}')
                        ]),
                        // HTML Body
                        DOM.el('div', { className: 'form-group mb-4' }, [
                            DOM.el('label', { className: 'form-label' }, 'HTML Inhalt *'),
                            DOM.el('textarea', { className: 'form-input', id: 'template-body', style: 'min-height: 300px; font-family: monospace;', placeholder: '<html>...</html>' }, (template && template.bodyHtml) || '')
                        ]),
                        // Merge Tags Reference
                        DOM.el('div', { className: 'form-group mb-4', style: 'background: var(--card-bg); padding: 1rem; border-radius: 8px;' }, [
                            DOM.el('label', { className: 'form-label', style: 'margin-bottom: 0.5rem;' }, 'Verfuegbare Merge-Tags:'),
                            DOM.el('div', { style: 'display: flex; flex-wrap: wrap; gap: 0.5rem;' }, [
                                '{{firstName}}', '{{lastName}}', '{{fullName}}', '{{email}}', '{{company}}', '{{phone}}',
                                '{{dealName}}', '{{dealValue}}', '{{currentDate}}', '{{currentYear}}'
                            ].map(function(tag) {
                                return DOM.el('code', { style: 'background: var(--bg-darker); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; cursor: pointer;', onclick: function() {
                                    var textarea = document.getElementById('template-body');
                                    if (textarea) {
                                        var start = textarea.selectionStart;
                                        var end = textarea.selectionEnd;
                                        textarea.value = textarea.value.substring(0, start) + tag + textarea.value.substring(end);
                                        textarea.focus();
                                        textarea.selectionStart = textarea.selectionEnd = start + tag.length;
                                    }
                                } }, tag);
                            }))
                        ])
                    ]),
                    DOM.el('div', { className: 'modal-footer' }, [
                        DOM.el('button', { className: 'btn btn-ghost', onclick: function() { self.closeTemplateBuilder(); } }, 'Abbrechen'),
                        DOM.el('button', { className: 'btn btn-primary', onclick: function() { self.saveTemplate(); } }, isEdit ? 'Speichern' : 'Erstellen')
                    ])
                ])
            ]);
            document.body.appendChild(modal);
        },

        closeTemplateBuilder: function() {
            var modal = document.getElementById('template-builder-modal');
            if (modal) modal.remove();
            this.editingTemplate = null;
        },

        saveTemplate: async function() {
            var self = this;
            var name = document.getElementById('template-name').value.trim();
            var subject = document.getElementById('template-subject').value.trim();
            var bodyHtml = document.getElementById('template-body').value.trim();

            if (!name || !subject || !bodyHtml) {
                alert('Bitte alle Pflichtfelder ausfuellen!');
                return;
            }

            var templateData = {
                name: name,
                subject: subject,
                bodyHtml: bodyHtml,
                bodyText: bodyHtml.replace(/<[^>]*>/g, '') // Simple HTML to text
            };

            try {
                if (this.editingTemplate) {
                    await API.request('/api/v1/email/templates/' + this.editingTemplate.id, { method: 'PATCH', body: templateData });
                } else {
                    await API.request('/api/v1/email/templates', { method: 'POST', body: templateData });
                }
                this.closeTemplateBuilder();
                this.loadEmailHubData();
            } catch (err) {
                alert('Fehler beim Speichern: ' + (err.message || 'Unbekannter Fehler'));
            }
        },

        deleteTemplate: async function(id) {
            if (!confirm('Template wirklich loeschen?')) return;
            try {
                await API.request('/api/v1/email/templates/' + id, { method: 'DELETE' });
                this.loadEmailHubData();
            } catch (err) {
                alert('Fehler beim Loeschen: ' + (err.message || 'Unbekannter Fehler'));
            }
        },

        previewTemplate: function(template) {
            var self = this;
            // Use sandboxed iframe for safe HTML preview
            var modal = DOM.el('div', { className: 'modal-overlay', id: 'template-preview-modal', onclick: function(e) { if (e.target.id === 'template-preview-modal') e.target.remove(); } }, [
                DOM.el('div', { className: 'modal', style: 'max-width: 700px; max-height: 90vh; overflow-y: auto;' }, [
                    DOM.el('div', { className: 'modal-header' }, [
                        DOM.el('h2', { className: 'modal-title' }, 'Vorschau: ' + escapeHtml(template.name)),
                        DOM.el('button', { className: 'btn btn-ghost', onclick: function() { document.getElementById('template-preview-modal').remove(); } }, '&times;')
                    ]),
                    DOM.el('div', { className: 'modal-body' }, [
                        DOM.el('div', { style: 'border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; margin-bottom: 1rem;' }, [
                            DOM.el('strong', {}, 'Betreff: '),
                            DOM.el('span', {}, escapeHtml(template.subject))
                        ]),
                        DOM.el('iframe', {
                            id: 'template-preview-frame',
                            style: 'width: 100%; height: 400px; border: 1px solid var(--border); border-radius: 8px; background: #fff;',
                            sandbox: 'allow-same-origin'
                        })
                    ])
                ])
            ]);
            document.body.appendChild(modal);
            // Write HTML to sandboxed iframe safely
            setTimeout(function() {
                var iframe = document.getElementById('template-preview-frame');
                if (iframe && iframe.contentDocument) {
                    iframe.contentDocument.open();
                    iframe.contentDocument.write(template.bodyHtml || '');
                    iframe.contentDocument.close();
                }
            }, 100);
        },

        loadEmailTemplates: async function() {
            // Legacy function - redirect to new implementation
            this.loadEmailHubData();
        },

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // COMMUNICATION - WHATSAPP
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        renderWhatsApp: async function() {
            var container = this.container();
            DOM.clear(container);

            var header = DOM.el('div', { className: 'page-header' }, [
                DOM.el('h1', { className: 'page-title' }, 'WhatsApp'),
                DOM.el('p', { className: 'page-subtitle' }, 'WhatsApp Business Integration')
            ]);
            container.appendChild(header);

            var stats = DOM.el('div', { className: 'grid grid-3 gap-4 mb-4' }, [
                DOM.el('div', { className: 'kpi-card success' }, [
                    DOM.el('div', { className: 'kpi-label' }, 'Connected'),
                    DOM.el('div', { className: 'kpi-value' }, '&#9989;')
                ]),
                DOM.el('div', { className: 'kpi-card info' }, [
                    DOM.el('div', { className: 'kpi-label' }, 'Messages Today'),
                    DOM.el('div', { className: 'kpi-value', id: 'wa-messages-today' }, '-')
                ]),
                DOM.el('div', { className: 'kpi-card primary' }, [
                    DOM.el('div', { className: 'kpi-label' }, 'Contacts'),
                    DOM.el('div', { className: 'kpi-value', id: 'wa-contacts' }, '-')
                ])
            ]);
            container.appendChild(stats);

            var actionsCard = DOM.el('div', { className: 'card' }, [
                DOM.el('div', { className: 'card-header' }, [
                    DOM.el('span', { className: 'card-title' }, '&#128241; Quick Actions')
                ]),
                DOM.el('div', { className: 'card-body' }, [
                    DOM.el('div', { className: 'grid grid-2 gap-4' }, [
                        DOM.el('button', { className: 'btn btn-secondary', style: 'padding: 1rem;', onclick: function() { UltimateApp.showWABroadcast(); } }, '&#128227; Broadcast Message'),
                        DOM.el('button', { className: 'btn btn-secondary', style: 'padding: 1rem;' }, '&#128196; Message Templates')
                    ])
                ])
            ]);
            container.appendChild(actionsCard);

            this.loadWhatsAppStats();
        },

        loadWhatsAppStats: async function() {
            var data = await API.get('/api/whatsapp/stats');
            if (data) {
                var msgEl = document.getElementById('wa-messages-today');
                var contactsEl = document.getElementById('wa-contacts');
                if (msgEl) msgEl.textContent = String(data.messagesToday || 0);
                if (contactsEl) contactsEl.textContent = String(data.contacts || 0);
            }
        },

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // COMMUNICATION - CAMPAIGNS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        renderCampaigns: async function() {
            var container = this.container();
            DOM.clear(container);

            var header = DOM.el('div', { className: 'page-header' }, [
                DOM.el('div', {}, [
                    DOM.el('h1', { className: 'page-title' }, 'Campaigns'),
                    DOM.el('p', { className: 'page-subtitle' }, 'Marketing campaign management')
                ]),
                DOM.el('div', { className: 'page-actions' }, [
                    DOM.el('button', { className: 'btn btn-primary' }, '+ New Campaign')
                ])
            ]);
            container.appendChild(header);

            var stats = DOM.el('div', { className: 'grid grid-4 gap-4 mb-4' }, [
                DOM.el('div', { className: 'kpi-card' }, [
                    DOM.el('div', { className: 'kpi-label' }, 'Active'),
                    DOM.el('div', { className: 'kpi-value' }, '0')
                ]),
                DOM.el('div', { className: 'kpi-card success' }, [
                    DOM.el('div', { className: 'kpi-label' }, 'Completed'),
                    DOM.el('div', { className: 'kpi-value' }, '0')
                ]),
                DOM.el('div', { className: 'kpi-card info' }, [
                    DOM.el('div', { className: 'kpi-label' }, 'Total Reach'),
                    DOM.el('div', { className: 'kpi-value' }, '0')
                ]),
                DOM.el('div', { className: 'kpi-card warning' }, [
                    DOM.el('div', { className: 'kpi-label' }, 'Conversion'),
                    DOM.el('div', { className: 'kpi-value' }, '--%')
                ])
            ]);
            container.appendChild(stats);

            var card = DOM.el('div', { className: 'card' }, [
                DOM.el('div', { className: 'card-body' }, [
                    DOM.el('div', { className: 'empty-state' }, [
                        DOM.el('div', { className: 'empty-state-icon' }, '&#128640;'),
                        DOM.el('div', { className: 'empty-state-title' }, 'No campaigns yet'),
                        DOM.el('button', { className: 'btn btn-primary' }, '+ Create First Campaign')
                    ])
                ])
            ]);
            container.appendChild(card);
        },

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // AI - HAIKU GOD MODE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        renderHaiku: async function() {
            var self = this;
            var container = this.container();
            DOM.clear(container);

            // Header with Orchestrator Toggle
            var header = DOM.el('div', { className: 'page-header', style: 'display: flex; justify-content: space-between; align-items: center;' }, [
                DOM.el('div', {}, [
                    DOM.el('h1', { className: 'page-title' }, 'Á•û HAIKU God Mode'),
                    DOM.el('p', { className: 'page-subtitle' }, 'Supreme AI Orchestration System')
                ]),
                DOM.el('div', { className: 'flex gap-2' }, [
                    DOM.el('button', {
                        className: 'btn btn-success',
                        id: 'haiku-orchestrator-toggle',
                        onclick: function() { self.toggleHaikuOrchestrator(); }
                    }, '‚ñ∂Ô∏è Start Orchestrator'),
                    DOM.el('button', {
                        className: 'btn btn-secondary',
                        onclick: function() { self.loadHaikuData(); }
                    }, 'üîÑ Refresh')
                ])
            ]);
            container.appendChild(header);

            // Orchestrator Status Card
            var orchestratorCard = DOM.el('div', { className: 'card mb-4', style: 'background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(59, 130, 246, 0.3)); border: 2px solid rgba(139, 92, 246, 0.6);' }, [
                DOM.el('div', { className: 'card-body' }, [
                    DOM.el('div', { className: 'flex items-center justify-between' }, [
                        DOM.el('div', {}, [
                            DOM.el('div', { style: 'font-size: 1.8rem; font-weight: 700; color: #a78bfa;', id: 'haiku-status-display' }, 'Á•û HAIKU ORCHESTRATOR'),
                            DOM.el('div', { style: 'color: var(--text-muted); display: flex; align-items: center; gap: 0.5rem;' }, [
                                DOM.el('span', { className: 'status-dot', id: 'haiku-status-dot', style: 'width: 10px; height: 10px; border-radius: 50%; background: #ef4444;' }),
                                DOM.el('span', { id: 'haiku-status-text' }, 'Checking status...')
                            ])
                        ]),
                        DOM.el('div', { className: 'grid grid-4 gap-3' }, [
                            DOM.el('div', { className: 'kpi-card', style: 'min-width: 100px; background: rgba(139, 92, 246, 0.2);' }, [
                                DOM.el('div', { className: 'kpi-label' }, 'ü§ñ Active Bots'),
                                DOM.el('div', { className: 'kpi-value', id: 'haiku-active-bots' }, '0')
                            ]),
                            DOM.el('div', { className: 'kpi-card', style: 'min-width: 100px; background: rgba(34, 197, 94, 0.2);' }, [
                                DOM.el('div', { className: 'kpi-label' }, '‚úÖ Tasks Today'),
                                DOM.el('div', { className: 'kpi-value', id: 'haiku-tasks-today' }, '0')
                            ]),
                            DOM.el('div', { className: 'kpi-card', style: 'min-width: 100px; background: rgba(59, 130, 246, 0.2);' }, [
                                DOM.el('div', { className: 'kpi-label' }, 'üìä Success Rate'),
                                DOM.el('div', { className: 'kpi-value', id: 'haiku-success-rate' }, '--%')
                            ]),
                            DOM.el('div', { className: 'kpi-card', style: 'min-width: 100px; background: rgba(234, 179, 8, 0.2);' }, [
                                DOM.el('div', { className: 'kpi-label' }, '‚ö° Power Level'),
                                DOM.el('div', { className: 'kpi-value', id: 'haiku-power' }, '‚àû')
                            ])
                        ])
                    ])
                ])
            ]);
            container.appendChild(orchestratorCard);

            // Two Column Layout: Command + Activity
            var mainGrid = DOM.el('div', { className: 'grid grid-2 gap-4 mb-4' }, [
                // Divine Command Card
                DOM.el('div', { className: 'card' }, [
                    DOM.el('div', { className: 'card-header', style: 'background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(234, 179, 8, 0.2));' }, [
                        DOM.el('span', { className: 'card-title' }, '‚ö° Divine Command Center')
                    ]),
                    DOM.el('div', { className: 'card-body' }, [
                        DOM.el('textarea', {
                            className: 'form-input',
                            id: 'haiku-command',
                            rows: '4',
                            placeholder: '@einstein analyse Q4 Verkaufsdaten\n@tesla optimiere Lead Scoring\n@nostradamus prognostiziere Q1 Revenue...',
                            style: 'resize: vertical; font-family: monospace; background: rgba(0,0,0,0.3);'
                        }),
                        DOM.el('div', { className: 'flex justify-between mt-3' }, [
                            DOM.el('div', { className: 'flex gap-2' }, [
                                DOM.el('button', { className: 'btn btn-ghost btn-sm', onclick: function() { document.getElementById('haiku-command').value = '@einstein '; document.getElementById('haiku-command').focus(); } }, 'üß† Einstein'),
                                DOM.el('button', { className: 'btn btn-ghost btn-sm', onclick: function() { document.getElementById('haiku-command').value = '@tesla '; document.getElementById('haiku-command').focus(); } }, '‚ö° Tesla'),
                                DOM.el('button', { className: 'btn btn-ghost btn-sm', onclick: function() { document.getElementById('haiku-command').value = '@nostradamus '; document.getElementById('haiku-command').focus(); } }, 'üîÆ Nostradamus')
                            ]),
                            DOM.el('button', { className: 'btn btn-primary', onclick: function() { self.executeHaikuCommand(); } }, 'Á•û Execute')
                        ])
                    ])
                ]),
                // Live Activity Feed
                DOM.el('div', { className: 'card' }, [
                    DOM.el('div', { className: 'card-header', style: 'background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(59, 130, 246, 0.2));' }, [
                        DOM.el('span', { className: 'card-title' }, 'üì° Live Bot Activity'),
                        DOM.el('span', { className: 'badge', style: 'background: rgba(34, 197, 94, 0.3);', id: 'haiku-activity-count' }, '0 events')
                    ]),
                    DOM.el('div', { className: 'card-body', id: 'haiku-activity-feed', style: 'max-height: 250px; overflow-y: auto;' }, [
                        DOM.el('div', { className: 'empty-state', style: 'padding: 2rem; text-align: center; color: var(--text-muted);' }, 'Start orchestrator to see activity...')
                    ])
                ])
            ]);
            container.appendChild(mainGrid);

            // Bot Grid - Quick Actions
            var botsCard = DOM.el('div', { className: 'card mb-4' }, [
                DOM.el('div', { className: 'card-header' }, [
                    DOM.el('span', { className: 'card-title' }, 'ü§ñ Bot Fleet Control'),
                    DOM.el('span', { className: 'badge', id: 'haiku-bot-count' }, '44 Bots')
                ]),
                DOM.el('div', { className: 'card-body', id: 'haiku-bot-grid' }, [
                    DOM.el('div', { className: 'grid grid-6 gap-2', id: 'haiku-quick-bots' })
                ])
            ]);
            container.appendChild(botsCard);

            // Quick Action Cards
            var actionsGrid = DOM.el('div', { className: 'grid grid-4 gap-4' }, [
                DOM.el('div', { className: 'card', style: 'cursor: pointer; transition: transform 0.2s;', onclick: function() { self.executeQuickAction('prophecy'); } }, [
                    DOM.el('div', { className: 'card-body text-center' }, [
                        DOM.el('div', { style: 'font-size: 2.5rem;' }, 'üîÆ'),
                        DOM.el('div', { style: 'font-weight: 600; margin-top: 0.5rem; color: #a78bfa;' }, 'Prophecy Mode'),
                        DOM.el('div', { style: 'font-size: 0.85rem; color: var(--text-muted);' }, 'AI Predictions & Forecasts')
                    ])
                ]),
                DOM.el('div', { className: 'card', style: 'cursor: pointer; transition: transform 0.2s;', onclick: function() { self.executeQuickAction('analyze'); } }, [
                    DOM.el('div', { className: 'card-body text-center' }, [
                        DOM.el('div', { style: 'font-size: 2.5rem;' }, 'üìä'),
                        DOM.el('div', { style: 'font-weight: 600; margin-top: 0.5rem; color: #3b82f6;' }, 'Deep Analysis'),
                        DOM.el('div', { style: 'font-size: 0.85rem; color: var(--text-muted);' }, 'Data Intelligence')
                    ])
                ]),
                DOM.el('div', { className: 'card', style: 'cursor: pointer; transition: transform 0.2s;', onclick: function() { self.executeQuickAction('automate'); } }, [
                    DOM.el('div', { className: 'card-body text-center' }, [
                        DOM.el('div', { style: 'font-size: 2.5rem;' }, '‚ö°'),
                        DOM.el('div', { style: 'font-weight: 600; margin-top: 0.5rem; color: #eab308;' }, 'Auto Execute'),
                        DOM.el('div', { style: 'font-size: 0.85rem; color: var(--text-muted);' }, 'Workflow Automation')
                    ])
                ]),
                DOM.el('div', { className: 'card', style: 'cursor: pointer; transition: transform 0.2s;', onclick: function() { self.executeQuickAction('optimize'); } }, [
                    DOM.el('div', { className: 'card-body text-center' }, [
                        DOM.el('div', { style: 'font-size: 2.5rem;' }, 'üöÄ'),
                        DOM.el('div', { style: 'font-weight: 600; margin-top: 0.5rem; color: #22c55e;' }, 'Optimize All'),
                        DOM.el('div', { style: 'font-size: 0.85rem; color: var(--text-muted);' }, 'Full System Optimization')
                    ])
                ])
            ]);
            container.appendChild(actionsGrid);

            // Load initial data
            this.loadHaikuData();
            this.renderHaikuBotGrid();
        },

        haikuOrchestratorRunning: false,
        haikuOrchestratorInterval: null,

        toggleHaikuOrchestrator: async function() {
            var btn = document.getElementById('haiku-orchestrator-toggle');
            var statusDot = document.getElementById('haiku-status-dot');
            var statusText = document.getElementById('haiku-status-text');

            if (this.haikuOrchestratorRunning) {
                btn.disabled = true;
                btn.textContent = '‚è≥ Stopping...';
                var result = await API.post('/api/bot-orchestrator/stop');
                if (result && result.success) {
                    this.haikuOrchestratorRunning = false;
                    btn.className = 'btn btn-success';
                    btn.textContent = '‚ñ∂Ô∏è Start Orchestrator';
                    statusDot.style.background = '#ef4444';
                    statusText.textContent = 'Orchestrator Stopped';
                    if (this.haikuOrchestratorInterval) {
                        clearInterval(this.haikuOrchestratorInterval);
                        this.haikuOrchestratorInterval = null;
                    }
                }
                btn.disabled = false;
            } else {
                btn.disabled = true;
                btn.textContent = '‚è≥ Starting...';
                var result = await API.post('/api/bot-orchestrator/start');
                if (result && result.success) {
                    this.haikuOrchestratorRunning = true;
                    btn.className = 'btn btn-danger';
                    btn.textContent = '‚èπ Stop Orchestrator';
                    statusDot.style.background = '#22c55e';
                    statusText.textContent = 'Orchestrator Running - 44 Bots Active';
                    this.loadHaikuActivityFeed();
                    var self = this;
                    this.haikuOrchestratorInterval = setInterval(function() {
                        self.loadHaikuActivityFeed();
                    }, 15000);
                }
                btn.disabled = false;
            }
        },

        loadHaikuData: async function() {
            var statusDot = document.getElementById('haiku-status-dot');
            var statusText = document.getElementById('haiku-status-text');
            var btn = document.getElementById('haiku-orchestrator-toggle');

            try {
                var data = await API.get('/api/bot-orchestrator/status');
                if (data) {
                    this.haikuOrchestratorRunning = data.running || false;
                    if (statusDot) statusDot.style.background = data.running ? '#22c55e' : '#ef4444';
                    if (statusText) statusText.textContent = data.running ? 'Orchestrator Running - 44 Bots Active' : 'Orchestrator Stopped';
                    if (btn) {
                        btn.className = 'btn ' + (data.running ? 'btn-danger' : 'btn-success');
                        btn.textContent = data.running ? '‚èπ Stop Orchestrator' : '‚ñ∂Ô∏è Start Orchestrator';
                    }
                    var activeEl = document.getElementById('haiku-active-bots');
                    if (activeEl) activeEl.textContent = data.activeBots || 44;

                    if (data.running && !this.haikuOrchestratorInterval) {
                        var self = this;
                        this.loadHaikuActivityFeed();
                        this.haikuOrchestratorInterval = setInterval(function() {
                            self.loadHaikuActivityFeed();
                        }, 15000);
                    }
                }
            } catch (e) {
                if (statusDot) statusDot.style.background = '#6b7280';
                if (statusText) statusText.textContent = 'Checking orchestrator...';
            }

            // Load stats
            try {
                var stats = await API.get('/api/bot-orchestrator/stats');
                var tasksEl = document.getElementById('haiku-tasks-today');
                var successEl = document.getElementById('haiku-success-rate');
                if (stats) {
                    if (tasksEl) tasksEl.textContent = stats.tasksToday || 0;
                    if (successEl) successEl.textContent = (stats.successRate || 0) + '%';
                }
            } catch (e) {}
        },

        loadHaikuActivityFeed: async function() {
            var feedContainer = document.getElementById('haiku-activity-feed');
            var countBadge = document.getElementById('haiku-activity-count');
            if (!feedContainer) return;

            try {
                var logsResponse = await API.get('/api/bot-orchestrator/logs?limit=15');
                var logs = logsResponse && logsResponse.logs ? logsResponse.logs : (Array.isArray(logsResponse) ? logsResponse : []);

                if (countBadge) countBadge.textContent = logs.length + ' events';

                DOM.clear(feedContainer);

                if (!logs || logs.length === 0) {
                    feedContainer.appendChild(DOM.el('div', { className: 'empty-state', style: 'padding: 2rem; text-align: center; color: var(--text-muted);' },
                        this.haikuOrchestratorRunning ? 'Waiting for bot activity...' : 'Start orchestrator to see activity...'));
                    return;
                }

                logs.forEach(function(log) {
                    var statusColor = log.status === 'success' ? '#22c55e' : (log.status === 'error' ? '#ef4444' : '#eab308');
                    var item = DOM.el('div', { style: 'display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem; border-radius: 0.5rem; background: rgba(255,255,255,0.05); margin-bottom: 0.5rem;' }, [
                        DOM.el('div', { style: 'width: 8px; height: 8px; border-radius: 50%; background: ' + statusColor + ';' }),
                        DOM.el('div', { style: 'flex: 1;' }, [
                            DOM.el('div', { style: 'font-weight: 500; font-size: 0.9rem;' }, log.bot || 'System'),
                            DOM.el('div', { style: 'font-size: 0.8rem; color: var(--text-muted);' }, log.action || log.message || 'Task executed')
                        ]),
                        DOM.el('div', { style: 'font-size: 0.75rem; color: var(--text-muted);' }, log.time || 'just now')
                    ]);
                    feedContainer.appendChild(item);
                });

                // Update stats
                var successCount = logs.filter(function(l) { return l.status === 'success'; }).length;
                var successRate = logs.length > 0 ? Math.round((successCount / logs.length) * 100) : 0;
                var tasksEl = document.getElementById('haiku-tasks-today');
                var successEl = document.getElementById('haiku-success-rate');
                if (tasksEl) tasksEl.textContent = logs.length;
                if (successEl) successEl.textContent = successRate + '%';
            } catch (e) {
                console.warn('Failed to load activity feed:', e);
            }
        },

        renderHaikuBotGrid: function() {
            var gridContainer = document.getElementById('haiku-quick-bots');
            if (!gridContainer) return;

            var self = this;
            var quickBots = [
                { id: 'einstein', name: 'Einstein', icon: 'üß†', color: '#3b82f6' },
                { id: 'tesla', name: 'Tesla', icon: '‚ö°', color: '#eab308' },
                { id: 'nostradamus', name: 'Nostradamus', icon: 'üîÆ', color: '#a78bfa' },
                { id: 'davinci', name: 'Da Vinci', icon: 'üé®', color: '#ec4899' },
                { id: 'jobs', name: 'Jobs', icon: 'üçé', color: '#6b7280' },
                { id: 'musk', name: 'Musk', icon: 'üöÄ', color: '#ef4444' },
                { id: 'buffett', name: 'Buffett', icon: 'üí∞', color: '#22c55e' },
                { id: 'caesar', name: 'Caesar', icon: 'üèõÔ∏è', color: '#f59e0b' },
                { id: 'aristotle', name: 'Aristotle', icon: 'üìú', color: '#8b5cf6' },
                { id: 'sherlock', name: 'Sherlock', icon: 'üîç', color: '#06b6d4' },
                { id: 'loxone', name: 'Loxone', icon: 'üè†', color: '#84cc16' },
                { id: 'qualifier', name: 'Qualifier', icon: 'üéØ', color: '#f97316' }
            ];

            quickBots.forEach(function(bot) {
                var botBtn = DOM.el('button', {
                    className: 'btn btn-ghost',
                    style: 'display: flex; flex-direction: column; align-items: center; padding: 0.75rem; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05);',
                    onclick: function() { self.triggerHaikuBot(bot.id); }
                }, [
                    DOM.el('span', { style: 'font-size: 1.5rem;' }, bot.icon),
                    DOM.el('span', { style: 'font-size: 0.75rem; margin-top: 0.25rem; color: ' + bot.color + ';' }, bot.name)
                ]);
                gridContainer.appendChild(botBtn);
            });
        },

        triggerHaikuBot: async function(botId) {
            var result = await API.post('/api/bot-orchestrator/execute/' + botId);
            if (result && result.success) {
                alert('ü§ñ ' + botId.toUpperCase() + ' Bot triggered successfully!');
                this.loadHaikuActivityFeed();
            } else {
                alert('Failed to trigger bot: ' + (result ? result.error : 'Unknown error'));
            }
        },

        executeQuickAction: async function(action) {
            var commands = {
                'prophecy': '@nostradamus analyse market trends and predict Q1 2026 revenue',
                'analyze': '@einstein deep analysis of all sales data and customer behavior',
                'automate': '@tesla optimize all automation workflows and lead scoring',
                'optimize': '@all full system optimization - sales, marketing, operations'
            };
            document.getElementById('haiku-command').value = commands[action] || '';
            this.executeHaikuCommand();
        },

        loadHaikuStats: async function() {
            var data = await API.get('/api/haiku/stats');
            if (data) {
                var tasksEl = document.getElementById('haiku-tasks');
                if (tasksEl) tasksEl.textContent = String(data.tasksToday || 0);
            }
        },

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // AI - BROLY TASKFORCE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        brolyTaskforceState: {
            agents: [],
            tasks: [],
            mode: 'standard',
            powerLevel: 9001
        },

        renderBrolyTaskforce: async function() {
            var self = this;
            var container = this.container();
            DOM.clear(container);

            // Header with Broly styling
            var header = DOM.el('div', { className: 'page-header', style: 'background: linear-gradient(135deg, #22c55e, #eab308); padding: 2rem; border-radius: 1rem; margin-bottom: 1.5rem;' }, [
                DOM.el('div', { style: 'display: flex; justify-content: space-between; align-items: center;' }, [
                    DOM.el('div', {}, [
                        DOM.el('h1', { className: 'page-title', style: 'color: #000; font-size: 2rem;' }, '‚ö° BROLY TASKFORCE'),
                        DOM.el('p', { style: 'color: rgba(0,0,0,0.7);' }, 'Legendary AI Agent Orchestration System')
                    ]),
                    DOM.el('div', { className: 'flex gap-2' }, [
                        DOM.el('button', { className: 'btn', style: 'background: rgba(0,0,0,0.2); color: #000;', id: 'broly-mode-btn', onclick: function() { self.toggleBrolyMode(); } }, 'üî• LEGENDARY MODE'),
                        DOM.el('button', { className: 'btn btn-primary', style: 'background: #000; color: #22c55e;', onclick: function() { self.createBrolyTask(); } }, '+ New Task')
                    ])
                ])
            ]);
            container.appendChild(header);

            // Power Level Display
            var powerDisplay = DOM.el('div', { className: 'grid grid-4 gap-4 mb-4' }, [
                DOM.el('div', { className: 'kpi-card', style: 'background: linear-gradient(135deg, #22c55e20, #eab30820); border: 2px solid #22c55e50;' }, [
                    DOM.el('div', { className: 'kpi-label' }, '‚ö° Power Level'),
                    DOM.el('div', { className: 'kpi-value', style: 'color: #22c55e; font-family: monospace;', id: 'broly-power' }, 'OVER 9000!')
                ]),
                DOM.el('div', { className: 'kpi-card' }, [
                    DOM.el('div', { className: 'kpi-label' }, 'ü§ñ Active Agents'),
                    DOM.el('div', { className: 'kpi-value', id: 'broly-agents' }, '0')
                ]),
                DOM.el('div', { className: 'kpi-card success' }, [
                    DOM.el('div', { className: 'kpi-label' }, '‚úÖ Tasks Completed'),
                    DOM.el('div', { className: 'kpi-value', id: 'broly-completed' }, '0')
                ]),
                DOM.el('div', { className: 'kpi-card warning' }, [
                    DOM.el('div', { className: 'kpi-label' }, '‚è≥ In Progress'),
                    DOM.el('div', { className: 'kpi-value', id: 'broly-progress' }, '0')
                ])
            ]);
            container.appendChild(powerDisplay);

            // Agent Control Grid
            var agentsCard = DOM.el('div', { className: 'card mb-4' }, [
                DOM.el('div', { className: 'card-header' }, [
                    DOM.el('span', { className: 'card-title' }, 'ü§ñ Agent Fleet'),
                    DOM.el('button', { className: 'btn btn-ghost btn-sm', onclick: function() { self.loadBrolyAgents(); } }, 'üîÑ Refresh')
                ]),
                DOM.el('div', { className: 'card-body', id: 'broly-agent-grid' }, [
                    DOM.el('div', { className: 'loading-skeleton', style: 'height: 200px;' })
                ])
            ]);
            container.appendChild(agentsCard);

            // Task Queue
            var tasksCard = DOM.el('div', { className: 'card' }, [
                DOM.el('div', { className: 'card-header' }, [
                    DOM.el('span', { className: 'card-title' }, 'üìã Task Queue'),
                    DOM.el('div', { className: 'flex gap-2' }, [
                        DOM.el('button', { className: 'btn btn-ghost btn-sm active', id: 'broly-filter-all', onclick: function() { self.filterBrolyTasks('all'); } }, 'All'),
                        DOM.el('button', { className: 'btn btn-ghost btn-sm', id: 'broly-filter-active', onclick: function() { self.filterBrolyTasks('active'); } }, 'Active'),
                        DOM.el('button', { className: 'btn btn-ghost btn-sm', id: 'broly-filter-done', onclick: function() { self.filterBrolyTasks('done'); } }, 'Completed')
                    ])
                ]),
                DOM.el('div', { className: 'card-body', id: 'broly-task-list' }, [
                    DOM.el('div', { className: 'loading-skeleton', style: 'height: 300px;' })
                ])
            ]);
            container.appendChild(tasksCard);

            // Load data
            this.loadBrolyData();
        },

        loadBrolyData: async function() {
            var self = this;

            // Load agents from HAIKU config
            try {
                var config = await API.get('/api/haiku/config');
                var agents = config && config.agents ? Object.entries(config.agents).map(function(entry) {
                    return { id: entry[0], ...entry[1] };
                }) : [];

                self.brolyTaskforceState.agents = agents;

                var agentGrid = document.getElementById('broly-agent-grid');
                if (agentGrid) {
                    DOM.clear(agentGrid);

                    if (agents.length === 0) {
                        agentGrid.appendChild(DOM.el('div', { className: 'text-center py-8', style: 'color: var(--text-muted);' }, 'No agents configured'));
                    } else {
                        var grid = DOM.el('div', { className: 'grid grid-4 gap-3' });

                        agents.slice(0, 12).forEach(function(agent) {
                            var agentCard = DOM.el('div', {
                                className: 'p-3 rounded-lg border cursor-pointer transition',
                                style: 'border-color: var(--border-color); background: var(--bg-secondary);',
                                onclick: function() { self.selectBrolyAgent(agent.id); }
                            }, [
                                DOM.el('div', { className: 'flex items-center gap-2 mb-2' }, [
                                    DOM.el('div', { style: 'width: 2rem; height: 2rem; border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; font-size: 1rem; background: ' + (agent.color || '#3b82f6') + '20;' }, agent.icon || 'ü§ñ'),
                                    DOM.el('span', { style: 'font-weight: 600; font-size: 0.85rem;' }, escapeHtml(agent.name || agent.id))
                                ]),
                                DOM.el('div', { style: 'font-size: 0.75rem; color: var(--text-muted);' }, escapeHtml(agent.specialty || 'General Purpose')),
                                DOM.el('div', { className: 'flex justify-between mt-2', style: 'font-size: 0.7rem;' }, [
                                    DOM.el('span', { style: 'color: var(--success);' }, '‚óè Online'),
                                    DOM.el('span', { style: 'color: var(--text-muted);' }, 'Tasks: ' + (agent.tasksCompleted || 0))
                                ])
                            ]);
                            grid.appendChild(agentCard);
                        });

                        agentGrid.appendChild(grid);

                        // Update counts
                        var agentCount = document.getElementById('broly-agents');
                        if (agentCount) agentCount.textContent = String(agents.length);
                    }
                }
            } catch (err) {
                console.error('Broly agents error:', err);
            }

            // Load tasks
            try {
                var tasks = await API.get('/api/haiku/tasks');
                var taskList = Array.isArray(tasks) ? tasks : (tasks && tasks.tasks ? tasks.tasks : []);

                self.brolyTaskforceState.tasks = taskList;
                self.renderBrolyTasks(taskList);

                // Update stats
                var completed = taskList.filter(function(t) { return t.status === 'completed'; }).length;
                var inProgress = taskList.filter(function(t) { return t.status === 'in_progress' || t.status === 'running'; }).length;

                var completedEl = document.getElementById('broly-completed');
                var progressEl = document.getElementById('broly-progress');
                if (completedEl) completedEl.textContent = String(completed);
                if (progressEl) progressEl.textContent = String(inProgress);
            } catch (err) {
                console.error('Broly tasks error:', err);
            }
        },

        renderBrolyTasks: function(tasks) {
            var self = this;
            var container = document.getElementById('broly-task-list');
            if (!container) return;

            DOM.clear(container);

            if (!tasks || tasks.length === 0) {
                container.appendChild(DOM.el('div', { className: 'text-center py-8' }, [
                    DOM.el('div', { style: 'font-size: 3rem; margin-bottom: 1rem;' }, '‚ö°'),
                    DOM.el('p', { style: 'color: var(--text-muted);' }, 'No tasks in queue'),
                    DOM.el('button', { className: 'btn btn-primary mt-3', onclick: function() { self.createBrolyTask(); } }, '+ Create First Task')
                ]));
                return;
            }

            tasks.forEach(function(task) {
                var statusColor = task.status === 'completed' ? 'var(--success)' :
                                 (task.status === 'failed' ? 'var(--danger)' :
                                 (task.status === 'running' || task.status === 'in_progress' ? 'var(--warning)' : 'var(--text-muted)'));

                var taskEl = DOM.el('div', { className: 'flex justify-between items-center py-3', style: 'border-bottom: 1px solid var(--border-color);' }, [
                    DOM.el('div', { className: 'flex items-center gap-3' }, [
                        DOM.el('div', { style: 'width: 0.5rem; height: 0.5rem; border-radius: 50%; background: ' + statusColor + ';' }),
                        DOM.el('div', {}, [
                            DOM.el('div', { style: 'font-weight: 500;' }, escapeHtml(task.name || task.command || 'Unnamed Task')),
                            DOM.el('div', { style: 'font-size: 0.8rem; color: var(--text-muted);' },
                                (task.agent || 'broly') + ' ‚Ä¢ ' + (task.createdAt ? new Date(task.createdAt).toLocaleString('de-DE') : 'Just now'))
                        ])
                    ]),
                    DOM.el('div', { className: 'flex items-center gap-2' }, [
                        DOM.el('span', { className: 'badge badge-' + (task.status === 'completed' ? 'success' : (task.status === 'failed' ? 'danger' : 'warning')) }, task.status || 'pending'),
                        DOM.el('button', { className: 'btn btn-ghost btn-sm', onclick: function() { self.viewBrolyTask(task); } }, 'üëÅ')
                    ])
                ]);
                container.appendChild(taskEl);
            });
        },

        toggleBrolyMode: function() {
            var btn = document.getElementById('broly-mode-btn');
            var powerEl = document.getElementById('broly-power');

            if (this.brolyTaskforceState.mode === 'standard') {
                this.brolyTaskforceState.mode = 'legendary';
                this.brolyTaskforceState.powerLevel = Infinity;
                if (btn) btn.textContent = 'üî• LEGENDARY MODE ACTIVE';
                if (powerEl) powerEl.textContent = '‚àû INFINITE';
                alert('üî• LEGENDARY BROLY MODE ACTIVATED!\n\nAll agents operating at maximum power!');
            } else {
                this.brolyTaskforceState.mode = 'standard';
                this.brolyTaskforceState.powerLevel = 9001;
                if (btn) btn.textContent = 'üî• LEGENDARY MODE';
                if (powerEl) powerEl.textContent = 'OVER 9000!';
            }
        },

        createBrolyTask: function() {
            var self = this;
            var form = DOM.el('div', {}, [
                DOM.el('div', { className: 'form-group' }, [
                    DOM.el('label', { className: 'form-label' }, 'Task Name'),
                    DOM.el('input', { type: 'text', className: 'form-input', id: 'broly-task-name', placeholder: 'Enter task name...' })
                ]),
                DOM.el('div', { className: 'form-group' }, [
                    DOM.el('label', { className: 'form-label' }, 'Command'),
                    DOM.el('textarea', { className: 'form-input', id: 'broly-task-command', rows: '3', placeholder: 'Enter command or instruction...' })
                ]),
                DOM.el('div', { className: 'form-group' }, [
                    DOM.el('label', { className: 'form-label' }, 'Assign to Agent'),
                    DOM.el('select', { className: 'form-input', id: 'broly-task-agent' },
                        [DOM.el('option', { value: 'broly' }, 'BROLY (Auto-assign)')].concat(
                            self.brolyTaskforceState.agents.map(function(a) {
                                return DOM.el('option', { value: a.id }, a.name || a.id);
                            })
                        )
                    )
                ]),
                DOM.el('div', { className: 'form-group' }, [
                    DOM.el('label', { className: 'form-label' }, 'Priority'),
                    DOM.el('select', { className: 'form-input', id: 'broly-task-priority' }, [
                        DOM.el('option', { value: 'normal' }, 'Normal'),
                        DOM.el('option', { value: 'high' }, 'High'),
                        DOM.el('option', { value: 'urgent' }, 'Urgent - LEGENDARY')
                    ])
                ])
            ]);

            this.showModal('‚ö° Create Broly Task', form, async function() {
                var name = document.getElementById('broly-task-name').value;
                var command = document.getElementById('broly-task-command').value;
                var agent = document.getElementById('broly-task-agent').value;
                var priority = document.getElementById('broly-task-priority').value;

                if (!command) {
                    alert('Please enter a command');
                    return;
                }

                try {
                    await API.post('/api/haiku/command', {
                        name: name || 'Broly Task',
                        command: command,
                        agent: agent,
                        priority: priority
                    });
                    self.loadBrolyData();
                    alert('‚ö° Task dispatched to ' + (agent || 'BROLY') + '!');
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            });
        },

        filterBrolyTasks: function(filter) {
            document.querySelectorAll('[id^="broly-filter-"]').forEach(function(btn) {
                btn.classList.remove('active');
            });
            document.getElementById('broly-filter-' + filter).classList.add('active');

            var tasks = this.brolyTaskforceState.tasks;
            if (filter === 'active') {
                tasks = tasks.filter(function(t) { return t.status !== 'completed'; });
            } else if (filter === 'done') {
                tasks = tasks.filter(function(t) { return t.status === 'completed'; });
            }
            this.renderBrolyTasks(tasks);
        },

        selectBrolyAgent: function(agentId) {
            alert('Agent selected: ' + agentId + '\n\nReady to dispatch tasks!');
        },

        viewBrolyTask: function(task) {
            var content = DOM.el('div', {}, [
                DOM.el('div', { className: 'mb-3' }, [
                    DOM.el('strong', {}, 'Task: '),
                    DOM.el('span', {}, escapeHtml(task.name || 'Unnamed'))
                ]),
                DOM.el('div', { className: 'mb-3' }, [
                    DOM.el('strong', {}, 'Command: '),
                    DOM.el('pre', { style: 'background: var(--bg-secondary); padding: 0.5rem; border-radius: 0.25rem; margin-top: 0.5rem; white-space: pre-wrap;' },
                        escapeHtml(task.command || '-'))
                ]),
                DOM.el('div', { className: 'mb-3' }, [
                    DOM.el('strong', {}, 'Status: '),
                    DOM.el('span', { className: 'badge badge-' + (task.status === 'completed' ? 'success' : 'warning') }, task.status || 'pending')
                ]),
                DOM.el('div', { className: 'mb-3' }, [
                    DOM.el('strong', {}, 'Agent: '),
                    DOM.el('span', {}, task.agent || 'BROLY')
                ]),
                task.result ? DOM.el('div', { className: 'mb-3' }, [
                    DOM.el('strong', {}, 'Result: '),
                    DOM.el('pre', { style: 'background: var(--bg-secondary); padding: 0.5rem; border-radius: 0.25rem; margin-top: 0.5rem; white-space: pre-wrap; max-height: 200px; overflow-y: auto;' },
                        escapeHtml(typeof task.result === 'string' ? task.result : JSON.stringify(task.result, null, 2)))
                ]) : null
            ].filter(Boolean));

            this.showModal('‚ö° Task Details', content);
        },

        loadBrolyAgents: function() {
            this.loadBrolyData();
        },

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // AI - PROPHECY
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        renderProphecy: async function() {
            var container = this.container();
            DOM.clear(container);

            var header = DOM.el('div', { className: 'page-header' }, [
                DOM.el('h1', { className: 'page-title' }, '&#128302; Prophecy'),
                DOM.el('p', { className: 'page-subtitle' }, 'AI-Powered Predictive Analytics')
            ]);
            container.appendChild(header);

            var grid = DOM.el('div', { className: 'grid grid-2 gap-4' }, [
                DOM.el('div', { className: 'card' }, [
                    DOM.el('div', { className: 'card-header' }, [
                        DOM.el('span', { className: 'card-title' }, '&#128200; Revenue Forecast')
                    ]),
                    DOM.el('div', { className: 'card-body', style: 'height: 250px;' }, [
                        DOM.el('div', { id: 'forecast-chart', style: 'height: 100%;' }, [
                            DOM.el('div', { className: 'empty-state' }, 'Loading forecast...')
                        ])
                    ])
                ]),
                DOM.el('div', { className: 'card' }, [
                    DOM.el('div', { className: 'card-header' }, [
                        DOM.el('span', { className: 'card-title' }, '&#127919; Deal Predictions')
                    ]),
                    DOM.el('div', { className: 'card-body' }, [
                        DOM.el('div', { id: 'deal-predictions' }, [
                            DOM.el('div', { className: 'empty-state' }, 'Analyzing deals...')
                        ])
                    ])
                ])
            ]);
            container.appendChild(grid);

            var insightsCard = DOM.el('div', { className: 'card mt-4' }, [
                DOM.el('div', { className: 'card-header' }, [
                    DOM.el('span', { className: 'card-title' }, '&#128161; AI Insights')
                ]),
                DOM.el('div', { className: 'card-body', id: 'ai-insights' }, [
                    DOM.el('div', { className: 'loading-skeleton', style: 'height: 100px;' })
                ])
            ]);
            container.appendChild(insightsCard);
        },

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // FINANCE - CASHFLOW
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        renderCashflow: async function() {
            var container = this.container();
            DOM.clear(container);

            var header = DOM.el('div', { className: 'page-header' }, [
                DOM.el('h1', { className: 'page-title' }, 'Cashflow'),
                DOM.el('p', { className: 'page-subtitle' }, 'Financial overview and projections')
            ]);
            container.appendChild(header);

            var stats = DOM.el('div', { className: 'grid grid-4 gap-4 mb-4' }, [
                DOM.el('div', { className: 'kpi-card success' }, [
                    DOM.el('div', { className: 'kpi-label' }, 'Revenue (MTD)'),
                    DOM.el('div', { className: 'kpi-value', id: 'cashflow-revenue' }, '-')
                ]),
                DOM.el('div', { className: 'kpi-card error' }, [
                    DOM.el('div', { className: 'kpi-label' }, 'Expenses (MTD)'),
                    DOM.el('div', { className: 'kpi-value', id: 'cashflow-expenses' }, '-')
                ]),
                DOM.el('div', { className: 'kpi-card primary' }, [
                    DOM.el('div', { className: 'kpi-label' }, 'Net Cash'),
                    DOM.el('div', { className: 'kpi-value', id: 'cashflow-net' }, '-')
                ]),
                DOM.el('div', { className: 'kpi-card info' }, [
                    DOM.el('div', { className: 'kpi-label' }, 'Runway'),
                    DOM.el('div', { className: 'kpi-value' }, '12 mo')
                ])
            ]);
            container.appendChild(stats);

            var chartCard = DOM.el('div', { className: 'card' }, [
                DOM.el('div', { className: 'card-header' }, [
                    DOM.el('span', { className: 'card-title' }, '&#128200; Cashflow Chart')
                ]),
                DOM.el('div', { className: 'card-body' }, [
                    DOM.el('canvas', { id: 'cashflow-chart', style: 'height: 300px;' })
                ])
            ]);
            container.appendChild(chartCard);

            this.loadCashflowData();
        },

        loadCashflowData: async function() {
            var stripeData = await API.get('/api/stripe/stats');
            if (stripeData) {
                var revenueEl = document.getElementById('cashflow-revenue');
                var netEl = document.getElementById('cashflow-net');
                if (revenueEl) revenueEl.textContent = formatCurrency(stripeData.revenue || stripeData.totalRevenue || 0);
                if (netEl) netEl.textContent = formatCurrency(stripeData.net || stripeData.revenue || 0);
            }
        },

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // FINANCE - INVOICES
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        renderInvoices: async function() {
            var self = this;
            var container = this.container();
            DOM.clear(container);
            this.invoicesPage = 0;

            var header = DOM.el('div', { className: 'page-header' }, [
                DOM.el('div', {}, [
                    DOM.el('h1', { className: 'page-title' }, 'Invoices'),
                    DOM.el('p', { className: 'page-subtitle' }, 'Invoice management with priority scoring')
                ]),
                DOM.el('div', { className: 'page-actions' }, [
                    DOM.el('button', { className: 'btn btn-ghost', onclick: function() { self.loadInvoicesTable(0); } }, 'üîÑ Refresh'),
                    DOM.el('button', { className: 'btn btn-primary', onclick: function() { UltimateApp.showNewInvoiceModal(); } }, '+ New Invoice')
                ])
            ]);
            container.appendChild(header);

            var stats = DOM.el('div', { className: 'grid grid-4 gap-4 mb-4', id: 'invoices-stats' }, [
                DOM.el('div', { className: 'loading-skeleton', style: 'height: 100px;' }),
                DOM.el('div', { className: 'loading-skeleton', style: 'height: 100px;' }),
                DOM.el('div', { className: 'loading-skeleton', style: 'height: 100px;' }),
                DOM.el('div', { className: 'loading-skeleton', style: 'height: 100px;' })
            ]);
            container.appendChild(stats);

            // Sorting controls
            var sortControls = DOM.el('div', { className: 'flex gap-2 mb-4 flex-wrap', id: 'invoices-sort' }, [
                DOM.el('span', { style: 'color: var(--text-muted); display: flex; align-items: center; margin-right: 0.5rem;' }, 'Sortieren:'),
                DOM.el('button', { className: 'btn btn-sm ' + (this.invoicesSort === 'score' ? 'btn-primary' : 'btn-ghost'), onclick: function() { self.sortInvoices('score'); } }, '‚≠ê Score'),
                DOM.el('button', { className: 'btn btn-sm ' + (this.invoicesSort === 'email' ? 'btn-primary' : 'btn-ghost'), onclick: function() { self.sortInvoices('email'); } }, 'üìß Email'),
                DOM.el('button', { className: 'btn btn-sm ' + (this.invoicesSort === 'status' ? 'btn-primary' : 'btn-ghost'), onclick: function() { self.sortInvoices('status'); } }, 'üìä Status'),
                DOM.el('button', { className: 'btn btn-sm ' + (this.invoicesSort === 'sent' ? 'btn-primary' : 'btn-ghost'), onclick: function() { self.sortInvoices('sent'); } }, 'üì§ Gesendet'),
                DOM.el('button', { className: 'btn btn-sm ' + (this.invoicesSort === 'amount' ? 'btn-primary' : 'btn-ghost'), onclick: function() { self.sortInvoices('amount'); } }, 'üí∞ Betrag'),
                DOM.el('button', { className: 'btn btn-sm ' + (this.invoicesSort === 'date' ? 'btn-primary' : 'btn-ghost'), onclick: function() { self.sortInvoices('date'); } }, 'üìÖ Datum')
            ]);
            container.appendChild(sortControls);

            var card = DOM.el('div', { className: 'card' }, [
                DOM.el('div', { className: 'card-body' }, [
                    DOM.el('div', { className: 'table-container', id: 'invoices-table' }, [
                        DOM.el('div', { className: 'loading-skeleton', style: 'height: 300px;' })
                    ]),
                    DOM.el('div', { className: 'flex justify-between items-center mt-4', id: 'invoices-pagination' })
                ])
            ]);
            container.appendChild(card);

            // Load stats first (fast), then table
            this.loadInvoicesStats();
            this.loadInvoicesTable(0);
        },

        sortInvoices: function(field) {
            // Toggle order if same field, otherwise set to desc
            if (this.invoicesSort === field) {
                this.invoicesOrder = this.invoicesOrder === 'desc' ? 'asc' : 'desc';
            } else {
                this.invoicesSort = field;
                this.invoicesOrder = 'desc';
            }
            this.invoicesPage = 0;
            this.renderInvoices();
        },

        loadInvoicesStats: async function() {
            var statsContainer = document.getElementById('invoices-stats');
            var data = await API.get('/api/v1/invoices/stats');
            if (!statsContainer) return;
            DOM.clear(statsContainer);

            // Handle both nested (counts/amounts) and flat API formats
            var counts = data && data.counts ? data.counts : data;
            var amounts = data && data.amounts ? data.amounts : data;

            var stats = [
                { label: 'Total', value: formatCurrency(amounts.total || amounts.totalAmount || 0), sub: formatNumber(counts.total || 0) + ' Invoices', icon: 'üìÑ', type: 'info' },
                { label: 'Paid', value: formatCurrency(amounts.paid || amounts.paidAmount || 0), sub: formatNumber(counts.paid || 0) + ' Paid', icon: '‚úÖ', type: 'success' },
                { label: 'Pending', value: formatCurrency(amounts.pending || amounts.pendingAmount || 0), sub: formatNumber(counts.pending || 0) + ' Pending', icon: '‚è≥', type: 'warning' },
                { label: 'Overdue', value: formatCurrency(amounts.overdue || amounts.overdueAmount || 0), sub: formatNumber(counts.overdue || 0) + ' Overdue', icon: 'üö®', type: 'error' }
            ];
            stats.forEach(function(stat) {
                statsContainer.appendChild(DOM.el('div', { className: 'kpi-card ' + stat.type + ' animate-slide-up' }, [
                    DOM.el('div', { className: 'kpi-header' }, [
                        DOM.el('span', { className: 'kpi-label' }, stat.label),
                        DOM.el('span', { className: 'kpi-icon' }, stat.icon)
                    ]),
                    DOM.el('div', { className: 'kpi-value' }, stat.value),
                    DOM.el('div', { className: 'kpi-change positive' }, stat.sub)
                ]));
            });
        },

        loadInvoicesTable: async function(page) {
            var self = this;
            if (page === undefined) page = this.invoicesPage;
            this.invoicesPage = page;
            var tableContainer = document.getElementById('invoices-table');
            var paginationContainer = document.getElementById('invoices-pagination');
            var offset = page * this.invoicesPerPage;

            var data = await API.get('/api/v1/invoices?limit=' + this.invoicesPerPage + '&offset=' + offset + '&enrich=false');
            DOM.clear(tableContainer);

            var invoices = data && data.invoices ? data.invoices : (Array.isArray(data) ? data : []);
            var total = data && data.total_count ? data.total_count : invoices.length;
            var totalPages = Math.ceil(total / this.invoicesPerPage);

            if (invoices.length === 0 && page === 0) {
                tableContainer.appendChild(DOM.el('div', { className: 'empty-state' }, [
                    DOM.el('div', { className: 'empty-state-icon' }, 'üìÑ'),
                    DOM.el('div', { className: 'empty-state-title' }, 'No invoices yet'),
                    DOM.el('button', { className: 'btn btn-primary', onclick: function() { UltimateApp.showNewInvoiceModal(); } }, '+ Create First Invoice')
                ]));
                return;
            }

            var table = DOM.el('table', { className: 'table' });
            var thead = DOM.el('thead', {}, [
                DOM.el('tr', {}, [
                    DOM.el('th', {}, 'Invoice #'),
                    DOM.el('th', {}, 'Client'),
                    DOM.el('th', {}, 'Amount'),
                    DOM.el('th', {}, 'Status'),
                    DOM.el('th', {}, 'Due Date'),
                    DOM.el('th', {}, 'Actions')
                ])
            ]);
            table.appendChild(thead);

            var tbody = DOM.el('tbody');
            invoices.forEach(function(invoice) {
                var statusClass = invoice.status === 'paid' ? 'badge-success' : (invoice.status === 'overdue' ? 'badge-error' : 'badge-warning');
                var row = DOM.el('tr', {}, [
                    DOM.el('td', { style: 'font-weight: 500;' }, escapeHtml(invoice.invoice_number || invoice.number || invoice.id)),
                    DOM.el('td', {}, escapeHtml(invoice.customer_name || invoice.client || '-')),
                    DOM.el('td', {}, formatCurrency(invoice.amount || invoice.total || 0)),
                    DOM.el('td', {}, [
                        DOM.el('span', { className: 'badge ' + statusClass }, invoice.status || 'pending')
                    ]),
                    DOM.el('td', {}, formatDate(invoice.due_date || invoice.dueDate)),
                    DOM.el('td', {}, [
                        DOM.el('button', { className: 'btn btn-ghost btn-sm', onclick: function() { UltimateApp.viewInvoice(invoice.id); } }, 'View'),
                        DOM.el('button', { className: 'btn btn-ghost btn-sm', onclick: function() { UltimateApp.sendInvoice(invoice.id); } }, 'Send')
                    ])
                ]);
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            tableContainer.appendChild(table);

            // Pagination Controls
            if (paginationContainer && totalPages > 1) {
                DOM.clear(paginationContainer);
                var prevBtn = DOM.el('button', {
                    className: 'btn btn-secondary',
                    onclick: function() { if (page > 0) self.loadInvoicesTable(page - 1); },
                    disabled: page === 0
                }, '‚Üê Zur√ºck');
                var pageInfo = DOM.el('span', { style: 'display: flex; align-items: center; color: var(--text-muted);' },
                    'Seite ' + (page + 1) + ' von ' + totalPages + ' (' + formatNumber(total) + ' Rechnungen)');
                var nextBtn = DOM.el('button', {
                    className: 'btn btn-secondary',
                    onclick: function() { if (page < totalPages - 1) self.loadInvoicesTable(page + 1); },
                    disabled: page >= totalPages - 1
                }, 'Weiter ‚Üí');
                paginationContainer.appendChild(prevBtn);
                paginationContainer.appendChild(pageInfo);
                paginationContainer.appendChild(nextBtn);
            }
        },

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // FINANCE - STRIPE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        renderStripe: async function() {
            var self = this;
            var container = this.container();
            DOM.clear(container);
            this.stripePage = 0;

            var header = DOM.el('div', { className: 'page-header' }, [
                DOM.el('div', {}, [
                    DOM.el('h1', { className: 'page-title' }, 'üí≥ Stripe'),
                    DOM.el('p', { className: 'page-subtitle' }, 'Payment processing dashboard')
                ]),
                DOM.el('div', { className: 'page-actions' }, [
                    DOM.el('button', { className: 'btn btn-ghost', onclick: function() { self.loadStripePayments(0); } }, 'üîÑ Refresh')
                ])
            ]);
            container.appendChild(header);

            var stats = DOM.el('div', { className: 'grid grid-4 gap-4 mb-4', id: 'stripe-stats' }, [
                DOM.el('div', { className: 'loading-skeleton', style: 'height: 100px;' }),
                DOM.el('div', { className: 'loading-skeleton', style: 'height: 100px;' }),
                DOM.el('div', { className: 'loading-skeleton', style: 'height: 100px;' }),
                DOM.el('div', { className: 'loading-skeleton', style: 'height: 100px;' })
            ]);
            container.appendChild(stats);

            var paymentsCard = DOM.el('div', { className: 'card' }, [
                DOM.el('div', { className: 'card-header' }, [
                    DOM.el('span', { className: 'card-title' }, 'Payments')
                ]),
                DOM.el('div', { className: 'card-body' }, [
                    DOM.el('div', { className: 'table-container', id: 'stripe-payments' }, [
                        DOM.el('div', { className: 'loading-skeleton', style: 'height: 300px;' })
                    ]),
                    DOM.el('div', { className: 'flex justify-between items-center mt-4', id: 'stripe-pagination' })
                ])
            ]);
            container.appendChild(paymentsCard);

            // Load stats first, then payments
            this.loadStripeStats();
            this.loadStripePayments(0);
        },

        loadStripeStats: async function() {
            var statsContainer = document.getElementById('stripe-stats');
            var data = await API.get('/api/stripe/stats');
            if (!statsContainer) return;
            DOM.clear(statsContainer);

            var stats = [
                { label: 'Total Revenue', value: formatCurrency(data && data.revenue ? data.revenue : 0), icon: 'üí∞', type: 'success' },
                { label: 'Subscriptions', value: String(data && data.subscriptions ? data.subscriptions : 0), icon: 'üîÑ', type: 'info' },
                { label: 'Payments Today', value: String(data && data.paymentsToday ? data.paymentsToday : 0), icon: 'üìä', type: 'primary' },
                { label: 'Refunds', value: formatCurrency(data && data.refunds ? data.refunds : 0), icon: '‚Ü©Ô∏è', type: 'error' }
            ];

            stats.forEach(function(stat) {
                statsContainer.appendChild(DOM.el('div', { className: 'kpi-card ' + stat.type + ' animate-slide-up' }, [
                    DOM.el('div', { className: 'kpi-header' }, [
                        DOM.el('span', { className: 'kpi-label' }, stat.label),
                        DOM.el('span', { className: 'kpi-icon' }, stat.icon)
                    ]),
                    DOM.el('div', { className: 'kpi-value' }, stat.value)
                ]));
            });
        },

        loadStripePayments: async function(direction) {
            var self = this;
            var paymentsContainer = document.getElementById('stripe-payments');
            var paginationContainer = document.getElementById('stripe-pagination');

            // Build URL with cursor pagination
            var url = '/api/stripe/payments?limit=' + this.stripePerPage;
            if (direction === 'next' && this.stripeLastId) {
                url += '&starting_after=' + this.stripeLastId;
                this.stripeHistory.push(this.stripeFirstId);
                this.stripePage++;
            } else if (direction === 'prev' && this.stripeHistory.length > 0) {
                var prevFirst = this.stripeHistory.pop();
                url += '&ending_before=' + prevFirst;
                this.stripePage--;
            } else {
                // First page - reset
                this.stripePage = 0;
                this.stripeHistory = [];
            }

            var data = await API.get(url);
            if (!paymentsContainer) return;
            DOM.clear(paymentsContainer);

            var payments = data && data.payments ? data.payments : [];
            this.stripeHasMore = data && data.has_more;
            this.stripeLastId = data && data.last_id;
            this.stripeFirstId = data && data.first_id;

            if (payments.length === 0 && this.stripePage === 0) {
                paymentsContainer.appendChild(DOM.el('div', { className: 'empty-state' }, [
                    DOM.el('div', { className: 'empty-state-icon' }, 'üí≥'),
                    DOM.el('div', { className: 'empty-state-title' }, 'No payments yet')
                ]));
                return;
            }

            var table = DOM.el('table', { className: 'table' });
            var thead = DOM.el('thead', {}, [
                DOM.el('tr', {}, [
                    DOM.el('th', {}, 'ID'),
                    DOM.el('th', {}, 'Customer'),
                    DOM.el('th', {}, 'Amount'),
                    DOM.el('th', {}, 'Status'),
                    DOM.el('th', {}, 'Date')
                ])
            ]);
            table.appendChild(thead);

            var tbody = DOM.el('tbody');
            payments.forEach(function(payment) {
                var statusClass = payment.status === 'succeeded' ? 'badge-success' : (payment.status === 'failed' ? 'badge-error' : 'badge-warning');
                var row = DOM.el('tr', {}, [
                    DOM.el('td', { style: 'font-family: monospace; font-size: 0.8rem;' }, escapeHtml((payment.id || '').slice(-8))),
                    DOM.el('td', {}, escapeHtml(payment.customer || payment.email || payment.customer_email || 'Anonymous')),
                    DOM.el('td', { className: 'text-success font-medium' }, formatCurrency((payment.amount || 0) / 100)),
                    DOM.el('td', {}, [
                        DOM.el('span', { className: 'badge ' + statusClass }, payment.status || 'pending')
                    ]),
                    DOM.el('td', {}, formatDate(payment.created ? new Date(payment.created * 1000) : null))
                ]);
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            paymentsContainer.appendChild(table);

            // Pagination Controls (cursor-based)
            if (paginationContainer) {
                DOM.clear(paginationContainer);
                var canPrev = this.stripePage > 0;
                var canNext = this.stripeHasMore;

                var prevBtn = DOM.el('button', {
                    className: 'btn btn-secondary',
                    onclick: function() { self.loadStripePayments('prev'); },
                    disabled: !canPrev
                }, '‚Üê Zur√ºck');
                var pageInfo = DOM.el('span', { style: 'display: flex; align-items: center; color: var(--text-muted);' },
                    'Seite ' + (this.stripePage + 1) + ' (' + payments.length + ' Payments)');
                var nextBtn = DOM.el('button', {
                    className: 'btn btn-secondary',
                    onclick: function() { self.loadStripePayments('next'); },
                    disabled: !canNext
                }, 'Weiter ‚Üí');
                paginationContainer.appendChild(prevBtn);
                paginationContainer.appendChild(pageInfo);
                paginationContainer.appendChild(nextBtn);
            }
        },

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SYSTEM - INTEGRATIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        renderIntegrations: async function() {
            var container = this.container();
            DOM.clear(container);

            var header = DOM.el('div', { className: 'page-header' }, [
                DOM.el('h1', { className: 'page-title' }, 'Integrations'),
                DOM.el('p', { className: 'page-subtitle' }, 'Manage connected services')
            ]);
            container.appendChild(header);

            var integrations = [
                { name: 'HubSpot CRM', icon: '&#128100;', status: 'connected', description: 'Contact and deal management' },
                { name: 'WhatsApp Business', icon: '&#128241;', status: 'connected', description: 'Messaging integration' },
                { name: 'Stripe', icon: '&#128179;', status: 'connected', description: 'Payment processing' },
                { name: 'Google Workspace', icon: '&#128231;', status: 'connected', description: 'Email and calendar' },
                { name: 'Slack', icon: '&#128172;', status: 'disconnected', description: 'Team communication' },
                { name: 'Zapier', icon: '&#9889;', status: 'disconnected', description: 'Workflow automation' }
            ];

            var grid = DOM.el('div', { className: 'grid grid-2 gap-4' });
            integrations.forEach(function(int) {
                var isConnected = int.status === 'connected';
                var card = DOM.el('div', { className: 'card' }, [
                    DOM.el('div', { className: 'card-body' }, [
                        DOM.el('div', { className: 'flex items-center justify-between' }, [
                            DOM.el('div', { className: 'flex items-center gap-3' }, [
                                DOM.el('span', { style: 'font-size: 2rem;' }, int.icon),
                                DOM.el('div', {}, [
                                    DOM.el('div', { style: 'font-weight: 600;' }, int.name),
                                    DOM.el('div', { style: 'font-size: 0.85rem; color: var(--text-muted);' }, int.description)
                                ])
                            ]),
                            DOM.el('div', { className: 'flex items-center gap-3' }, [
                                DOM.el('span', { className: 'badge ' + (isConnected ? 'badge-success' : 'badge-secondary') }, int.status),
                                DOM.el('button', { className: 'btn btn-ghost btn-sm' }, isConnected ? 'Configure' : 'Connect')
                            ])
                        ])
                    ])
                ]);
                grid.appendChild(card);
            });
            container.appendChild(grid);
        },

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SYSTEM - SETTINGS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        renderSettings: function() {
            var container = this.container();
            DOM.clear(container);

            var header = DOM.el('div', { className: 'page-header' }, [
                DOM.el('h1', { className: 'page-title' }, 'Settings'),
                DOM.el('p', { className: 'page-subtitle' }, 'Application preferences')
            ]);
            container.appendChild(header);

            var sections = [
                {
                    title: 'General',
                    settings: [
                        { label: 'Language', type: 'select', options: ['English', 'Deutsch'], value: 'Deutsch' },
                        { label: 'Timezone', type: 'select', options: ['Europe/Berlin', 'UTC', 'America/New_York'], value: 'Europe/Berlin' },
                        { label: 'Date Format', type: 'select', options: ['DD.MM.YYYY', 'MM/DD/YYYY', 'YYYY-MM-DD'], value: 'DD.MM.YYYY' }
                    ]
                },
                {
                    title: 'Notifications',
                    settings: [
                        { label: 'Email Notifications', type: 'toggle', value: true },
                        { label: 'Push Notifications', type: 'toggle', value: true },
                        { label: 'Deal Alerts', type: 'toggle', value: true }
                    ]
                },
                {
                    title: 'Appearance',
                    settings: [
                        { label: 'Theme', type: 'select', options: ['Dark', 'Light', 'System'], value: 'Dark' },
                        { label: 'Compact Mode', type: 'toggle', value: false }
                    ]
                }
            ];

            sections.forEach(function(section) {
                var card = DOM.el('div', { className: 'card mb-4' }, [
                    DOM.el('div', { className: 'card-header' }, [
                        DOM.el('span', { className: 'card-title' }, section.title)
                    ]),
                    DOM.el('div', { className: 'card-body' })
                ]);

                var body = card.querySelector('.card-body');
                section.settings.forEach(function(setting) {
                    var row = DOM.el('div', { className: 'flex justify-between items-center py-3', style: 'border-bottom: 1px solid var(--border-color);' }, [
                        DOM.el('span', {}, setting.label)
                    ]);

                    if (setting.type === 'select') {
                        var select = DOM.el('select', { className: 'form-input form-select', style: 'width: auto;' });
                        setting.options.forEach(function(opt) {
                            var option = DOM.el('option', { value: opt }, opt);
                            if (opt === setting.value) option.selected = true;
                            select.appendChild(option);
                        });
                        row.appendChild(select);
                    } else if (setting.type === 'toggle') {
                        var toggle = DOM.el('label', { className: 'toggle' }, [
                            DOM.el('input', { type: 'checkbox', checked: setting.value ? 'checked' : null }),
                            DOM.el('span', { className: 'toggle-slider' })
                        ]);
                        row.appendChild(toggle);
                    }

                    body.appendChild(row);
                });

                container.appendChild(card);
            });

            var saveBtn = DOM.el('div', { className: 'flex justify-end' }, [
                DOM.el('button', { className: 'btn btn-primary' }, 'Save Settings')
            ]);
            container.appendChild(saveBtn);
        },

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SYSTEM - DOCUMENTATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        renderDocs: function() {
            var container = this.container();
            DOM.clear(container);

            var header = DOM.el('div', { className: 'page-header' }, [
                DOM.el('h1', { className: 'page-title' }, 'Documentation'),
                DOM.el('p', { className: 'page-subtitle' }, 'System documentation and guides')
            ]);
            container.appendChild(header);

            var sections = [
                { title: 'Getting Started', icon: '&#128640;', items: ['Quick Start Guide', 'Dashboard Overview', 'Navigation'] },
                { title: 'CRM', icon: '&#128100;', items: ['Managing Contacts', 'Company Profiles', 'Lead Scoring'] },
                { title: 'Sales', icon: '&#128176;', items: ['Deal Pipeline', 'Creating Deals', 'Proposals'] },
                { title: 'Communication', icon: '&#128231;', items: ['Email Templates', 'Campaigns', 'WhatsApp'] },
                { title: 'AI & Automation', icon: '&#129302;', items: ['Genius Bots', 'HAIKU Commands', 'Automation Rules'] },
                { title: 'Finance', icon: '&#128179;', items: ['Invoicing', 'Stripe Integration', 'Reports'] },
                { title: 'API Reference', icon: '&#128279;', items: ['Authentication', 'Endpoints', 'Webhooks'] }
            ];

            var grid = DOM.el('div', { className: 'grid grid-3 gap-4' });
            sections.forEach(function(section) {
                var card = DOM.el('div', { className: 'card', style: 'cursor: pointer;' }, [
                    DOM.el('div', { className: 'card-body' }, [
                        DOM.el('div', { className: 'flex items-center gap-3 mb-3' }, [
                            DOM.el('span', { style: 'font-size: 1.5rem;' }, section.icon),
                            DOM.el('span', { style: 'font-weight: 600;' }, section.title)
                        ]),
                        DOM.el('ul', { style: 'list-style: none; padding: 0; margin: 0;' }, section.items.map(function(item) {
                            return DOM.el('li', { style: 'padding: 0.25rem 0; color: var(--text-muted); font-size: 0.9rem;' }, '&#8250; ' + item);
                        }))
                    ])
                ]);
                grid.appendChild(card);
            });
            container.appendChild(grid);
        },

        renderPlaceholder: function(title, message) {
            var container = this.container();
            DOM.clear(container);

            container.appendChild(DOM.el('div', { className: 'page-header' }, [
                DOM.el('h1', { className: 'page-title' }, title)
            ]));

            container.appendChild(DOM.el('div', { className: 'card' }, [
                DOM.el('div', { className: 'card-body' }, [
                    DOM.el('div', { className: 'empty-state' }, [
                        DOM.el('div', { className: 'empty-state-icon' }, '&#128679;'),
                        DOM.el('div', { className: 'empty-state-title' }, 'Coming Soon'),
                        DOM.el('div', { className: 'empty-state-text' }, message)
                    ])
                ])
            ]));
        },

        render404: function() {
            var container = this.container();
            DOM.clear(container);

            container.appendChild(DOM.el('div', { className: 'empty-state', style: 'padding-top: 100px;' }, [
                DOM.el('div', { className: 'empty-state-icon' }, '&#128533;'),
                DOM.el('div', { className: 'empty-state-title' }, '404 - Page Not Found'),
                DOM.el('div', { className: 'empty-state-text' }, 'The page you are looking for does not exist.'),
                DOM.el('a', { href: '#/', className: 'btn btn-primary' }, 'Go to Dashboard')
            ]));
        }
    };

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // MAIN APP
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    var UltimateApp = {
        init: function() {
            Router.init();
            this.updateLastSync();
            setInterval(this.updateLastSync, 30000);
        },

        updateLastSync: function() {
            var el = document.getElementById('last-sync');
            if (el) {
                el.textContent = 'Last sync: ' + new Date().toLocaleTimeString('de-DE');
            }
        },

        // Modal Management
        showModal: function(title, content, onConfirm) {
            document.getElementById('modal-title').textContent = title;
            var body = document.getElementById('modal-body');
            DOM.clear(body);
            if (typeof content === 'string') {
                body.textContent = content;
            } else {
                body.appendChild(content);
            }
            document.getElementById('modal-overlay').classList.add('active');

            if (onConfirm) {
                document.getElementById('modal-confirm').onclick = function() {
                    onConfirm();
                    UltimateApp.closeModal();
                };
            }
        },

        closeModal: function() {
            document.getElementById('modal-overlay').classList.remove('active');
        },

        // Contact Actions
        showNewContactModal: function() {
            var form = DOM.el('div', {}, [
                DOM.el('div', { className: 'grid grid-2 gap-4' }, [
                    DOM.el('div', { className: 'form-group' }, [
                        DOM.el('label', { className: 'form-label' }, 'First Name'),
                        DOM.el('input', { type: 'text', className: 'form-input', id: 'new-contact-firstname', placeholder: 'John' })
                    ]),
                    DOM.el('div', { className: 'form-group' }, [
                        DOM.el('label', { className: 'form-label' }, 'Last Name'),
                        DOM.el('input', { type: 'text', className: 'form-input', id: 'new-contact-lastname', placeholder: 'Doe' })
                    ])
                ]),
                DOM.el('div', { className: 'form-group' }, [
                    DOM.el('label', { className: 'form-label' }, 'Email'),
                    DOM.el('input', { type: 'email', className: 'form-input', id: 'new-contact-email', placeholder: 'john@example.com' })
                ]),
                DOM.el('div', { className: 'form-group' }, [
                    DOM.el('label', { className: 'form-label' }, 'Company'),
                    DOM.el('input', { type: 'text', className: 'form-input', id: 'new-contact-company', placeholder: 'Company Inc.' })
                ]),
                DOM.el('div', { className: 'form-group' }, [
                    DOM.el('label', { className: 'form-label' }, 'Phone'),
                    DOM.el('input', { type: 'tel', className: 'form-input', id: 'new-contact-phone', placeholder: '+49 123 456789' })
                ])
            ]);

            this.showModal('New Contact', form, async function() {
                var data = {
                    properties: {
                        firstname: document.getElementById('new-contact-firstname').value,
                        lastname: document.getElementById('new-contact-lastname').value,
                        email: document.getElementById('new-contact-email').value,
                        company: document.getElementById('new-contact-company').value,
                        phone: document.getElementById('new-contact-phone').value
                    }
                };
                var result = await API.post('/api/hubspot/contacts', data);
                if (result) {
                    Modules.loadContactsTable();
                }
            });
        },

        showContactDetail: function(id) {
            console.log('Show contact:', id);
            // TODO: Implement contact detail view
        },

        editContact: function(id) {
            console.log('Edit contact:', id);
            // TODO: Implement contact edit
        },

        // Deal Actions
        showNewDealModal: function() {
            var form = DOM.el('div', {}, [
                DOM.el('div', { className: 'form-group' }, [
                    DOM.el('label', { className: 'form-label' }, 'Deal Name'),
                    DOM.el('input', { type: 'text', className: 'form-input', id: 'new-deal-name', placeholder: 'New Business Deal' })
                ]),
                DOM.el('div', { className: 'form-group' }, [
                    DOM.el('label', { className: 'form-label' }, 'Amount'),
                    DOM.el('input', { type: 'number', className: 'form-input', id: 'new-deal-amount', placeholder: '10000' })
                ]),
                DOM.el('div', { className: 'form-group' }, [
                    DOM.el('label', { className: 'form-label' }, 'Stage'),
                    DOM.el('select', { className: 'form-input form-select', id: 'new-deal-stage' }, [
                        DOM.el('option', { value: 'qualifiedtobuy' }, 'Qualified'),
                        DOM.el('option', { value: 'presentationscheduled' }, 'Presentation'),
                        DOM.el('option', { value: 'negotiation' }, 'Negotiation')
                    ])
                ])
            ]);

            this.showModal('New Deal', form, async function() {
                var data = {
                    properties: {
                        dealname: document.getElementById('new-deal-name').value,
                        amount: document.getElementById('new-deal-amount').value,
                        dealstage: document.getElementById('new-deal-stage').value
                    }
                };
                var result = await API.post('/api/hubspot/deals', data);
                if (result) {
                    Modules.loadDealsKanban();
                }
            });
        },

        // Bot Actions
        selectBot: function(bot) {
            var input = document.getElementById('bot-command');
            if (input) {
                input.value = '@' + (bot.id || bot.name).toLowerCase() + ' ';
                input.focus();
            }
        },

        executeBotCommand: async function() {
            var input = document.getElementById('bot-command');
            var command = input ? input.value.trim() : '';
            if (!command) return;

            console.log('Executing bot command:', command);
            var result = await API.post('/api/genius-agency/execute', { command: command });
            if (result) {
                input.value = '';
                alert('Command executed: ' + (result.message || 'Success'));
            }
        },

        // Company Actions
        showNewCompanyModal: function() {
            var form = DOM.el('div', {}, [
                DOM.el('div', { className: 'form-group' }, [
                    DOM.el('label', { className: 'form-label' }, 'Company Name'),
                    DOM.el('input', { type: 'text', className: 'form-input', id: 'new-company-name', placeholder: 'Acme Inc.' })
                ]),
                DOM.el('div', { className: 'grid grid-2 gap-4' }, [
                    DOM.el('div', { className: 'form-group' }, [
                        DOM.el('label', { className: 'form-label' }, 'Domain'),
                        DOM.el('input', { type: 'text', className: 'form-input', id: 'new-company-domain', placeholder: 'acme.com' })
                    ]),
                    DOM.el('div', { className: 'form-group' }, [
                        DOM.el('label', { className: 'form-label' }, 'Industry'),
                        DOM.el('input', { type: 'text', className: 'form-input', id: 'new-company-industry', placeholder: 'Technology' })
                    ])
                ]),
                DOM.el('div', { className: 'grid grid-2 gap-4' }, [
                    DOM.el('div', { className: 'form-group' }, [
                        DOM.el('label', { className: 'form-label' }, 'Employees'),
                        DOM.el('input', { type: 'number', className: 'form-input', id: 'new-company-employees', placeholder: '50' })
                    ]),
                    DOM.el('div', { className: 'form-group' }, [
                        DOM.el('label', { className: 'form-label' }, 'Annual Revenue'),
                        DOM.el('input', { type: 'number', className: 'form-input', id: 'new-company-revenue', placeholder: '1000000' })
                    ])
                ])
            ]);

            this.showModal('New Company', form, async function() {
                var data = {
                    properties: {
                        name: document.getElementById('new-company-name').value,
                        domain: document.getElementById('new-company-domain').value,
                        industry: document.getElementById('new-company-industry').value,
                        numberofemployees: document.getElementById('new-company-employees').value,
                        annualrevenue: document.getElementById('new-company-revenue').value
                    }
                };
                var result = await API.post('/api/hubspot/companies', data);
                if (result) {
                    Modules.loadCompaniesTable();
                }
            });
        },

        editCompany: async function(id) {
            var data = await API.get('/api/hubspot/companies/' + id);
            if (!data) {
                alert('Could not load company data');
                return;
            }
            var props = data.properties || {};

            var form = DOM.el('div', {}, [
                DOM.el('div', { className: 'form-group' }, [
                    DOM.el('label', { className: 'form-label' }, 'Company Name'),
                    DOM.el('input', { type: 'text', className: 'form-input', id: 'edit-company-name', value: props.name || '' })
                ]),
                DOM.el('div', { className: 'grid grid-2 gap-4' }, [
                    DOM.el('div', { className: 'form-group' }, [
                        DOM.el('label', { className: 'form-label' }, 'Domain'),
                        DOM.el('input', { type: 'text', className: 'form-input', id: 'edit-company-domain', value: props.domain || '' })
                    ]),
                    DOM.el('div', { className: 'form-group' }, [
                        DOM.el('label', { className: 'form-label' }, 'Industry'),
                        DOM.el('input', { type: 'text', className: 'form-input', id: 'edit-company-industry', value: props.industry || '' })
                    ])
                ])
            ]);

            this.showModal('Edit Company', form, async function() {
                var updateData = {
                    properties: {
                        name: document.getElementById('edit-company-name').value,
                        domain: document.getElementById('edit-company-domain').value,
                        industry: document.getElementById('edit-company-industry').value
                    }
                };
                var result = await API.patch('/api/hubspot/companies/' + id, updateData);
                if (result) {
                    Modules.loadCompaniesTable();
                }
            });
        },

        // Lead Discovery
        searchLeads: async function() {
            var company = document.getElementById('lead-search-company').value;
            var industry = document.getElementById('lead-search-industry').value;
            var location = document.getElementById('lead-search-location').value;

            var resultsContainer = document.getElementById('lead-results');
            var countEl = document.getElementById('lead-results-count');

            DOM.clear(resultsContainer);
            resultsContainer.appendChild(DOM.el('div', { className: 'loading-skeleton', style: 'height: 200px;' }));

            var params = new URLSearchParams();
            if (company) params.append('company', company);
            if (industry) params.append('industry', industry);
            if (location) params.append('location', location);

            var data = await API.get('/api/v1/lead-discovery/search?' + params.toString());
            DOM.clear(resultsContainer);

            var leads = data && data.leads ? data.leads : (Array.isArray(data) ? data : []);
            countEl.textContent = leads.length + ' found';

            if (leads.length === 0) {
                resultsContainer.appendChild(DOM.el('div', { className: 'empty-state' }, 'No leads found matching your criteria'));
                return;
            }

            leads.forEach(function(lead) {
                resultsContainer.appendChild(DOM.el('div', { className: 'flex justify-between items-center py-3', style: 'border-bottom: 1px solid var(--border-color);' }, [
                    DOM.el('div', {}, [
                        DOM.el('div', { style: 'font-weight: 500;' }, escapeHtml(lead.name || lead.company || 'Unknown')),
                        DOM.el('div', { style: 'font-size: 0.85rem; color: var(--text-muted);' }, escapeHtml(lead.industry || '') + ' | ' + escapeHtml(lead.location || ''))
                    ]),
                    DOM.el('button', { className: 'btn btn-primary btn-sm' }, 'Import')
                ]));
            });
        },

        // Proposal Actions
        showNewProposalModal: function() {
            var form = DOM.el('div', {}, [
                DOM.el('div', { className: 'form-group' }, [
                    DOM.el('label', { className: 'form-label' }, 'Proposal Title'),
                    DOM.el('input', { type: 'text', className: 'form-input', id: 'new-proposal-title', placeholder: 'Enterprise Solution Proposal' })
                ]),
                DOM.el('div', { className: 'grid grid-2 gap-4' }, [
                    DOM.el('div', { className: 'form-group' }, [
                        DOM.el('label', { className: 'form-label' }, 'Client'),
                        DOM.el('input', { type: 'text', className: 'form-input', id: 'new-proposal-client', placeholder: 'Acme Inc.' })
                    ]),
                    DOM.el('div', { className: 'form-group' }, [
                        DOM.el('label', { className: 'form-label' }, 'Amount'),
                        DOM.el('input', { type: 'number', className: 'form-input', id: 'new-proposal-amount', placeholder: '50000' })
                    ])
                ]),
                DOM.el('div', { className: 'form-group' }, [
                    DOM.el('label', { className: 'form-label' }, 'Description'),
                    DOM.el('textarea', { className: 'form-input', id: 'new-proposal-desc', rows: '4', placeholder: 'Proposal details...' })
                ])
            ]);

            this.showModal('New Proposal', form, function() {
                alert('Proposal created (API integration pending)');
            });
        },

        // Email Actions
        showEmailComposer: function() {
            var form = DOM.el('div', {}, [
                DOM.el('div', { className: 'form-group' }, [
                    DOM.el('label', { className: 'form-label' }, 'To'),
                    DOM.el('input', { type: 'email', className: 'form-input', id: 'email-to', placeholder: 'recipient@example.com' })
                ]),
                DOM.el('div', { className: 'form-group' }, [
                    DOM.el('label', { className: 'form-label' }, 'Subject'),
                    DOM.el('input', { type: 'text', className: 'form-input', id: 'email-subject', placeholder: 'Email subject...' })
                ]),
                DOM.el('div', { className: 'form-group' }, [
                    DOM.el('label', { className: 'form-label' }, 'Message'),
                    DOM.el('textarea', { className: 'form-input', id: 'email-body', rows: '8', placeholder: 'Your message...' })
                ])
            ]);

            this.showModal('Compose Email', form, async function() {
                var emailData = {
                    to: document.getElementById('email-to').value,
                    subject: document.getElementById('email-subject').value,
                    body: document.getElementById('email-body').value
                };
                var result = await API.post('/api/v1/email/send', emailData);
                if (result) {
                    alert('Email sent successfully!');
                }
            });
        },

        selectEmailTemplate: function(template) {
            this.showEmailComposer();
            setTimeout(function() {
                var subjectEl = document.getElementById('email-subject');
                var bodyEl = document.getElementById('email-body');
                if (subjectEl && template.subject) subjectEl.value = template.subject;
                if (bodyEl && template.body) bodyEl.value = template.body;
            }, 100);
        },

        // WhatsApp Actions
        showWABroadcast: function() {
            var form = DOM.el('div', {}, [
                DOM.el('div', { className: 'form-group' }, [
                    DOM.el('label', { className: 'form-label' }, 'Recipients'),
                    DOM.el('textarea', { className: 'form-input', id: 'wa-recipients', rows: '3', placeholder: '+49123456789, +49987654321' })
                ]),
                DOM.el('div', { className: 'form-group' }, [
                    DOM.el('label', { className: 'form-label' }, 'Message'),
                    DOM.el('textarea', { className: 'form-input', id: 'wa-message', rows: '4', placeholder: 'Your broadcast message...' })
                ])
            ]);

            this.showModal('WhatsApp Broadcast', form, async function() {
                var data = {
                    recipients: document.getElementById('wa-recipients').value.split(',').map(function(r) { return r.trim(); }),
                    message: document.getElementById('wa-message').value
                };
                var result = await API.post('/api/whatsapp/broadcast', data);
                if (result) {
                    alert('Broadcast sent to ' + data.recipients.length + ' recipients');
                }
            });
        },

        // HAIKU Actions
        executeHaikuCommand: async function() {
            var input = document.getElementById('haiku-command');
            var command = input ? input.value.trim() : '';
            if (!command) return;

            var result = await API.post('/api/haiku/command', { command: command });
            if (result) {
                input.value = '';
                alert('HAIKU Response: ' + (result.response || result.message || 'Command executed'));
            }
        },

        // Invoice Actions
        showNewInvoiceModal: function() {
            var form = DOM.el('div', {}, [
                DOM.el('div', { className: 'grid grid-2 gap-4' }, [
                    DOM.el('div', { className: 'form-group' }, [
                        DOM.el('label', { className: 'form-label' }, 'Client'),
                        DOM.el('input', { type: 'text', className: 'form-input', id: 'new-invoice-client', placeholder: 'Client name' })
                    ]),
                    DOM.el('div', { className: 'form-group' }, [
                        DOM.el('label', { className: 'form-label' }, 'Amount'),
                        DOM.el('input', { type: 'number', className: 'form-input', id: 'new-invoice-amount', placeholder: '1000' })
                    ])
                ]),
                DOM.el('div', { className: 'grid grid-2 gap-4' }, [
                    DOM.el('div', { className: 'form-group' }, [
                        DOM.el('label', { className: 'form-label' }, 'Due Date'),
                        DOM.el('input', { type: 'date', className: 'form-input', id: 'new-invoice-due' })
                    ]),
                    DOM.el('div', { className: 'form-group' }, [
                        DOM.el('label', { className: 'form-label' }, 'Currency'),
                        DOM.el('select', { className: 'form-input form-select', id: 'new-invoice-currency' }, [
                            DOM.el('option', { value: 'EUR' }, 'EUR'),
                            DOM.el('option', { value: 'USD' }, 'USD'),
                            DOM.el('option', { value: 'GBP' }, 'GBP')
                        ])
                    ])
                ]),
                DOM.el('div', { className: 'form-group' }, [
                    DOM.el('label', { className: 'form-label' }, 'Description'),
                    DOM.el('textarea', { className: 'form-input', id: 'new-invoice-desc', rows: '3', placeholder: 'Invoice items...' })
                ])
            ]);

            this.showModal('New Invoice', form, async function() {
                var data = {
                    client: document.getElementById('new-invoice-client').value,
                    amount: parseFloat(document.getElementById('new-invoice-amount').value),
                    dueDate: document.getElementById('new-invoice-due').value,
                    currency: document.getElementById('new-invoice-currency').value,
                    description: document.getElementById('new-invoice-desc').value
                };
                var result = await API.post('/api/v1/invoices', data);
                if (result) {
                    Modules.loadInvoicesTable();
                }
            });
        }
    };

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // INIT
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    document.addEventListener('DOMContentLoaded', function() {
        UltimateApp.init();
    });

    // Close modal on overlay click
    document.getElementById('modal-overlay').addEventListener('click', function(e) {
        if (e.target === this) {
            UltimateApp.closeModal();
        }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl+K for search
        if (e.ctrlKey && e.key === 'k') {
            e.preventDefault();
            document.getElementById('search-trigger').click();
        }
        // Escape to close modal
        if (e.key === 'Escape') {
            UltimateApp.closeModal();
        }
    });
    </script>

    <!-- Projects & Money Management Module -->
    <script src="/js/projects-module.js"></script>
</body>
</html>
